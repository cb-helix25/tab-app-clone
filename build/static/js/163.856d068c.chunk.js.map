{"version":3,"file":"static/js/163.856d068c.chunk.js","mappings":"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","sources":["tabs/enquiries/pitch-builder/emailFormattingUtils.ts","tabs/enquiries/pitch-builder/emailUtils.ts","app/customisation/ProductionTemplateBlocks.ts","tabs/enquiries/pitch-builder/DealCapture.tsx","tabs/enquiries/pitch-builder/scenarios.ts","tabs/enquiries/pitch-builder/FormattingToolbar.tsx","tabs/enquiries/pitch-builder/EmailProcessingConfirmDialog.tsx","tabs/enquiries/pitch-builder/EditorAndTemplateBlocks.tsx","tabs/enquiries/EmailSignature.tsx","components/filter/IconAreaFilter.tsx","tabs/enquiries/ClaimedEnquiryCard.tsx","tabs/enquiries/EnquiryLineItem.tsx","tabs/enquiries/GroupedEnquiryCard.tsx","tabs/enquiries/enquiryGrouping.ts","app/customisation/PracticeAreaPitch.ts","app/customisation/SimplifiedTemplateBlocks.ts","app/customisation/TemplateBlockSets.ts","app/customisation/Attachments.ts","tabs/enquiries/pitch-builder/PitchDebugPanel.tsx","tabs/enquiries/pitch-builder/VerificationSummary.tsx","components/PopoverContainer.tsx","tabs/enquiries/pitch-builder/PlaceholderEditorPopover.tsx","tabs/enquiries/pitch-builder/SnippetEditPopover.tsx","constants/deals.ts","tabs/enquiries/pitch-builder/emailFormattingV2.ts","tabs/enquiries/pitch-builder/EmailProcessor.ts","tabs/enquiries/PitchBuilder.tsx","tabs/enquiries/pitch-builder/useLocalFetchLogger.ts","tabs/enquiries/EnquiryCalls.tsx","tabs/enquiries/EnquiryEmails.tsx","tabs/enquiries/Enquiries.tsx"],"sourcesContent":["import { colours } from '../../../app/styles/colours';\r\n\r\n/**\r\n * Enhanced email-safe formatting utilities for pitch builder\r\n * These functions ensure rich text formatting survives email processing\r\n * and displays consistently across email clients (especially Outlook)\r\n */\r\n\r\n/**\r\n * Convert contentEditable HTML to email-safe HTML with inline styles\r\n * This function processes the rich text content and converts CSS styles to inline styles\r\n */\r\nexport function convertToEmailSafeHTML(html: string): string {\r\n  if (!html) return '';\r\n\r\n  const tempDiv = document.createElement('div');\r\n  tempDiv.innerHTML = html;\r\n\r\n  // Process all elements and convert to inline styles\r\n  processElementForEmail(tempDiv);\r\n\r\n  return tempDiv.innerHTML;\r\n}\r\n\r\n/**\r\n * Process a DOM element recursively to make it email-safe\r\n */\r\nfunction processElementForEmail(element: Element): void {\r\n  // Convert formatting elements to email-safe inline styles\r\n  const walker = document.createTreeWalker(\r\n    element,\r\n    NodeFilter.SHOW_ELEMENT,\r\n    null\r\n  );\r\n\r\n  const elementsToProcess: Element[] = [];\r\n  let currentNode = walker.nextNode();\r\n  while (currentNode) {\r\n    elementsToProcess.push(currentNode as Element);\r\n    currentNode = walker.nextNode();\r\n  }\r\n\r\n  elementsToProcess.forEach(el => {\r\n    convertElementToInlineStyles(el as HTMLElement);\r\n  });\r\n}\r\n\r\n/**\r\n * Convert a single element's styles to inline styles for email compatibility\r\n */\r\nfunction convertElementToInlineStyles(element: HTMLElement): void {\r\n  const tagName = element.tagName.toLowerCase();\r\n  let inlineStyles: { [key: string]: string } = {};\r\n\r\n  // Base font styles for all elements\r\n  inlineStyles['font-family'] = 'Raleway, Arial, sans-serif';\r\n  \r\n  // Handle specific formatting tags\r\n  switch (tagName) {\r\n    case 'strong':\r\n    case 'b':\r\n      inlineStyles['font-weight'] = '700';\r\n      break;\r\n      \r\n    case 'em':\r\n    case 'i':\r\n      inlineStyles['font-style'] = 'italic';\r\n      break;\r\n      \r\n    case 'u':\r\n      inlineStyles['text-decoration'] = 'underline';\r\n      break;\r\n      \r\n    case 'strike':\r\n    case 's':\r\n      inlineStyles['text-decoration'] = 'line-through';\r\n      break;\r\n      \r\n    case 'p':\r\n      inlineStyles['margin'] = '0 0 12px 0';\r\n      inlineStyles['line-height'] = '1.6';\r\n      inlineStyles['color'] = '#000000';\r\n      break;\r\n      \r\n    case 'h1':\r\n      inlineStyles['font-size'] = '24px';\r\n      inlineStyles['font-weight'] = '700';\r\n      inlineStyles['margin'] = '16px 0 12px 0';\r\n      inlineStyles['color'] = '#000000';\r\n      break;\r\n      \r\n    case 'h2':\r\n      inlineStyles['font-size'] = '20px';\r\n      inlineStyles['font-weight'] = '700';\r\n      inlineStyles['margin'] = '14px 0 10px 0';\r\n      inlineStyles['color'] = '#000000';\r\n      break;\r\n      \r\n    case 'h3':\r\n      inlineStyles['font-size'] = '18px';\r\n      inlineStyles['font-weight'] = '700';\r\n      inlineStyles['margin'] = '12px 0 8px 0';\r\n      inlineStyles['color'] = '#000000';\r\n      break;\r\n      \r\n    case 'ul':\r\n      inlineStyles['margin'] = '0 0 12px 20px';\r\n      inlineStyles['padding'] = '0';\r\n      inlineStyles['list-style-type'] = 'disc';\r\n      break;\r\n      \r\n    case 'ol':\r\n      inlineStyles['margin'] = '0 0 12px 20px';\r\n      inlineStyles['padding'] = '0';\r\n      inlineStyles['list-style-type'] = 'decimal';\r\n      break;\r\n      \r\n    case 'li':\r\n      inlineStyles['margin'] = '0 0 4px 0';\r\n      inlineStyles['line-height'] = '1.6';\r\n      inlineStyles['color'] = '#000000';\r\n      break;\r\n      \r\n    case 'a':\r\n      inlineStyles['color'] = '#3690CE';\r\n      inlineStyles['text-decoration'] = 'underline';\r\n      break;\r\n      \r\n    case 'blockquote':\r\n      inlineStyles['margin'] = '12px 0 12px 20px';\r\n      inlineStyles['padding'] = '8px 12px';\r\n      inlineStyles['border-left'] = '3px solid #3690CE';\r\n      inlineStyles['background-color'] = '#f8f9fa';\r\n      inlineStyles['font-style'] = 'italic';\r\n      break;\r\n      \r\n    case 'div':\r\n      // Only add line-height for divs that don't have specific styling\r\n      if (!element.style.cssText) {\r\n        inlineStyles['line-height'] = '1.6';\r\n      }\r\n      break;\r\n  }\r\n\r\n  // Preserve existing inline styles and merge with our styles\r\n  const existingStyles = parseStyleString(element.style.cssText);\r\n  const mergedStyles = { ...inlineStyles, ...existingStyles };\r\n\r\n  // Handle text alignment\r\n  if (element.style.textAlign) {\r\n    mergedStyles['text-align'] = element.style.textAlign;\r\n  }\r\n\r\n  // Handle colors\r\n  if (element.style.color) {\r\n    mergedStyles['color'] = element.style.color;\r\n  }\r\n  \r\n  if (element.style.backgroundColor) {\r\n    mergedStyles['background-color'] = element.style.backgroundColor;\r\n  }\r\n\r\n  // Handle font properties\r\n  if (element.style.fontSize) {\r\n    mergedStyles['font-size'] = element.style.fontSize;\r\n  }\r\n\r\n  // Apply the merged styles\r\n  element.style.cssText = formatStyleObject(mergedStyles);\r\n}\r\n\r\n/**\r\n * Parse CSS style string into an object\r\n */\r\nfunction parseStyleString(styleStr: string): { [key: string]: string } {\r\n  const styles: { [key: string]: string } = {};\r\n  if (!styleStr) return styles;\r\n\r\n  styleStr.split(';').forEach(rule => {\r\n    const [property, value] = rule.split(':').map(s => s.trim());\r\n    if (property && value) {\r\n      styles[property] = value;\r\n    }\r\n  });\r\n\r\n  return styles;\r\n}\r\n\r\n/**\r\n * Convert style object to CSS string\r\n */\r\nfunction formatStyleObject(styles: { [key: string]: string }): string {\r\n  return Object.entries(styles)\r\n    .filter(([, value]) => value)\r\n    .map(([property, value]) => `${property}:${value}`)\r\n    .join(';');\r\n}\r\n\r\n/**\r\n * Convert document.execCommand formatting to email-safe HTML\r\n * This processes the current selection and ensures proper email formatting\r\n */\r\nexport function normalizeFormattingForEmail(html: string): string {\r\n  const tempDiv = document.createElement('div');\r\n  tempDiv.innerHTML = html;\r\n\r\n  // Replace browser-specific formatting with standard tags\r\n  replaceBrowserFormatting(tempDiv);\r\n  \r\n  // Convert to email-safe inline styles\r\n  processElementForEmail(tempDiv);\r\n\r\n  return tempDiv.innerHTML;\r\n}\r\n\r\n/**\r\n * Replace browser-specific formatting elements with standard ones\r\n */\r\nfunction replaceBrowserFormatting(container: Element): void {\r\n  // Replace <font> tags with spans\r\n  const fontTags = container.querySelectorAll('font');\r\n  fontTags.forEach(font => {\r\n    const fontElement = font as HTMLFontElement;\r\n    const span = document.createElement('span');\r\n    \r\n    // Convert font attributes to styles\r\n    if (fontElement.size) {\r\n      const sizeMap: { [key: string]: string } = {\r\n        '1': '8px', '2': '10px', '3': '12px', '4': '14px',\r\n        '5': '18px', '6': '24px', '7': '36px'\r\n      };\r\n      span.style.fontSize = sizeMap[fontElement.size] || '14px';\r\n    }\r\n    \r\n    if (fontElement.color) {\r\n      span.style.color = fontElement.color;\r\n    }\r\n    \r\n    if (fontElement.face) {\r\n      span.style.fontFamily = fontElement.face;\r\n    }\r\n\r\n    // Move children\r\n    while (font.firstChild) {\r\n      span.appendChild(font.firstChild);\r\n    }\r\n    \r\n    font.parentNode?.replaceChild(span, font);\r\n  });\r\n\r\n  // Replace <big> and <small> tags\r\n  container.querySelectorAll('big').forEach(big => {\r\n    const span = document.createElement('span');\r\n    span.style.fontSize = '18px';\r\n    while (big.firstChild) {\r\n      span.appendChild(big.firstChild);\r\n    }\r\n    big.parentNode?.replaceChild(span, big);\r\n  });\r\n\r\n  container.querySelectorAll('small').forEach(small => {\r\n    const span = document.createElement('span');\r\n    span.style.fontSize = '10px';\r\n    while (small.firstChild) {\r\n      span.appendChild(small.firstChild);\r\n    }\r\n    small.parentNode?.replaceChild(span, small);\r\n  });\r\n\r\n  // Normalize nested formatting\r\n  normalizeNestedFormatting(container);\r\n}\r\n\r\n/**\r\n * Normalize nested formatting elements (e.g., multiple nested <b> tags)\r\n */\r\nfunction normalizeNestedFormatting(container: Element): void {\r\n  // Remove redundant nested bold tags\r\n  container.querySelectorAll('b b, strong strong, strong b, b strong').forEach(nested => {\r\n    while (nested.firstChild) {\r\n      nested.parentNode?.insertBefore(nested.firstChild, nested);\r\n    }\r\n    nested.remove();\r\n  });\r\n\r\n  // Remove redundant nested italic tags\r\n  container.querySelectorAll('i i, em em, em i, i em').forEach(nested => {\r\n    while (nested.firstChild) {\r\n      nested.parentNode?.insertBefore(nested.firstChild, nested);\r\n    }\r\n    nested.remove();\r\n  });\r\n\r\n  // Remove redundant nested underline tags\r\n  container.querySelectorAll('u u').forEach(nested => {\r\n    while (nested.firstChild) {\r\n      nested.parentNode?.insertBefore(nested.firstChild, nested);\r\n    }\r\n    nested.remove();\r\n  });\r\n}\r\n\r\n/**\r\n * Enhanced list formatting for email compatibility\r\n * Converts browser-generated lists to email-safe versions\r\n */\r\nexport function enhanceListFormatting(html: string): string {\r\n  const tempDiv = document.createElement('div');\r\n  tempDiv.innerHTML = html;\r\n\r\n  // Process unordered lists\r\n  tempDiv.querySelectorAll('ul').forEach(ul => {\r\n    ul.style.cssText = 'margin:0 0 12px 20px;padding:0;list-style-type:disc;';\r\n    \r\n    ul.querySelectorAll('li').forEach(li => {\r\n      li.style.cssText = 'margin:0 0 4px 0;line-height:1.6;color:#000000;';\r\n    });\r\n  });\r\n\r\n  // Process ordered lists with custom styling for better email compatibility\r\n  tempDiv.querySelectorAll('ol').forEach(ol => {\r\n    ol.style.cssText = 'margin:0 0 12px 20px;padding:0;list-style-type:decimal;';\r\n    \r\n    ol.querySelectorAll('li').forEach(li => {\r\n      li.style.cssText = 'margin:0 0 4px 0;line-height:1.6;color:#000000;';\r\n    });\r\n  });\r\n\r\n  return tempDiv.innerHTML;\r\n}\r\n\r\n/**\r\n * Clean up and optimize HTML for email sending\r\n * This is the final step before sending to ensure maximum compatibility\r\n */\r\nexport function finalizeHTMLForEmail(html: string): string {\r\n  let processed = html;\r\n\r\n  // Convert to email-safe format\r\n  processed = convertToEmailSafeHTML(processed);\r\n  \r\n  // Enhance list formatting\r\n  processed = enhanceListFormatting(processed);\r\n  \r\n  // Ensure proper paragraph formatting\r\n  processed = ensureParagraphFormatting(processed);\r\n  \r\n  // Clean up empty tags and normalize whitespace\r\n  processed = cleanupEmptyTags(processed);\r\n  \r\n  return processed;\r\n}\r\n\r\n/**\r\n * Ensure proper paragraph formatting for email clients\r\n */\r\nfunction ensureParagraphFormatting(html: string): string {\r\n  const tempDiv = document.createElement('div');\r\n  tempDiv.innerHTML = html;\r\n\r\n  // Convert standalone text nodes to paragraphs\r\n  const walker = document.createTreeWalker(\r\n    tempDiv,\r\n    NodeFilter.SHOW_TEXT,\r\n    null\r\n  );\r\n\r\n  const textNodesToWrap: Text[] = [];\r\n  let currentNode = walker.nextNode();\r\n  \r\n  while (currentNode) {\r\n    const textNode = currentNode as Text;\r\n    const content = textNode.textContent?.trim();\r\n    \r\n    if (content && \r\n        textNode.parentElement === tempDiv && \r\n        !isInlineElement(textNode.previousSibling as Element) &&\r\n        !isInlineElement(textNode.nextSibling as Element)) {\r\n      textNodesToWrap.push(textNode);\r\n    }\r\n    currentNode = walker.nextNode();\r\n  }\r\n\r\n  textNodesToWrap.forEach(textNode => {\r\n    const p = document.createElement('p');\r\n    p.style.cssText = 'margin:0 0 12px 0;line-height:1.6;color:#000000;';\r\n    textNode.parentNode?.replaceChild(p, textNode);\r\n    p.appendChild(textNode);\r\n  });\r\n\r\n  return tempDiv.innerHTML;\r\n}\r\n\r\n/**\r\n * Check if an element is an inline element\r\n */\r\nfunction isInlineElement(element: Element | null): boolean {\r\n  if (!element || element.nodeType !== Node.ELEMENT_NODE) return false;\r\n  \r\n  const inlineTags = ['a', 'span', 'strong', 'b', 'em', 'i', 'u', 'strike', 's', 'small', 'big'];\r\n  return inlineTags.includes(element.tagName.toLowerCase());\r\n}\r\n\r\n/**\r\n * Remove empty tags and normalize whitespace\r\n */\r\nfunction cleanupEmptyTags(html: string): string {\r\n  const tempDiv = document.createElement('div');\r\n  tempDiv.innerHTML = html;\r\n\r\n  // Remove empty elements (except br, img, hr)\r\n  const emptyElements = tempDiv.querySelectorAll('*:empty:not(br):not(img):not(hr)');\r\n  emptyElements.forEach(el => {\r\n    const htmlEl = el as HTMLElement;\r\n    if (el.tagName.toLowerCase() !== 'p' || !htmlEl.style.cssText) {\r\n      el.remove();\r\n    }\r\n  });\r\n\r\n  // Normalize whitespace conservatively: do not collapse text-node spaces or line breaks\r\n  let normalized = tempDiv.innerHTML;\r\n  // Trim only the spaces between tags to avoid introducing accidental whitespace\r\n  normalized = normalized.replace(/>\\s+</g, '><');\r\n  \r\n  return normalized;\r\n}\r\n\r\n/**\r\n * Extract and preserve formatting from contentEditable content\r\n * This function is called before sending to ensure all formatting is captured\r\n */\r\nexport function extractFormattingForEmail(editorElement: HTMLElement): string {\r\n  if (!editorElement) return '';\r\n\r\n  // Clone the element to avoid modifying the original\r\n  const clone = editorElement.cloneNode(true) as HTMLElement;\r\n  \r\n  // Process the clone for email compatibility\r\n  return finalizeHTMLForEmail(clone.innerHTML);\r\n}\r\n\r\n/**\r\n * Process editor content for email - alias for extractFormattingForEmail\r\n */\r\nexport function processEditorContentForEmail(editorElement: HTMLElement | null, fallbackContent?: string): string {\r\n  if (!editorElement) {\r\n    return fallbackContent || '';\r\n  }\r\n  return extractFormattingForEmail(editorElement);\r\n}\r\n\r\n/**\r\n * Keyboard shortcut mappings for formatting\r\n */\r\nexport const KEYBOARD_SHORTCUTS = {\r\n  'ctrl+b': 'bold',\r\n  'ctrl+i': 'italic',\r\n  'ctrl+u': 'underline',\r\n  'ctrl+shift+s': 'strikeThrough',\r\n  'ctrl+shift+8': 'insertUnorderedList',\r\n  'ctrl+shift+7': 'insertOrderedList',\r\n  'ctrl+k': 'createLink',\r\n  'ctrl+l': 'justifyLeft',\r\n  'ctrl+e': 'justifyCenter',\r\n  'ctrl+r': 'justifyRight',\r\n  'ctrl+z': 'undo',\r\n  'ctrl+y': 'redo',\r\n  'ctrl+shift+z': 'redo'\r\n} as const;\r\n\r\nexport type FormattingCommand = typeof KEYBOARD_SHORTCUTS[keyof typeof KEYBOARD_SHORTCUTS];","import { Enquiry } from '../../../app/functionality/types';\r\nimport { colours } from '../../../app/styles/colours';\r\nimport { templateBlocks, TemplateBlock } from '../../../app/customisation/ProductionTemplateBlocks';\r\nimport { finalizeHTMLForEmail, extractFormattingForEmail } from './emailFormattingUtils';\r\n\r\nfunction escapeRegExp(str: string): string {\r\n  return str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n}\r\nexport function getLeftoverPlaceholders(blocks: TemplateBlock[] = templateBlocks): string[] {\r\n  return [...blocks.map((b) => b.placeholder), '[Amount]'];\r\n}\r\n\r\nexport const leftoverPlaceholders = getLeftoverPlaceholders();\r\n\r\n/**\r\n * Utility: turn consecutive <br><br> lines into real paragraphs (<p>...).\r\n * Some email clients (especially Outlook) collapse repeated <br> tags.\r\n * Converting them into <p> ensures consistent spacing.\r\n */\r\nexport function convertDoubleBreaksToParagraphs(html: string): string {\r\n  let normalized = html\r\n// invisible change\r\n    .replace(/\\r\\n/g, '\\n')\r\n    .replace(/(<br \\/>){2,}/g, '\\n\\n')\r\n    // Preserve explicit breaks after block elements; do not strip <br /> following </div>\r\n    ;\r\n    \r\n  // Convert numbered lists to proper HTML ordered lists\r\n  normalized = convertNumberedListsToHTML(normalized);\r\n  \r\n  const paragraphs = normalized.split(/\\n\\s*\\n/).filter(p => p.trim().length > 0);\r\n  const wrapped = paragraphs.map((paragraph) => {\r\n    const t = paragraph.trim();\r\n    // Keep block-level lists as-is to avoid invalid <p><ol> nesting in Outlook\r\n    if (/^<ol\\b/i.test(t) && /<\\/ol>\\s*$/i.test(t)) return t;\r\n    return `<p>${t}</p>`;\r\n  });\r\n  return wrapped.join('');\r\n}\r\n\r\n/**\r\n * Convert plain text numbered lists to HTML ordered lists.\r\n * Looks for patterns like \"1. \" and \"2. \" and converts them to proper <ol><li> structure.\r\n */\r\nexport function convertNumberedListsToHTML(text: string): string {\r\n  const lines = text.split('\\n');\r\n  const result: string[] = [];\r\n  let inList = false;\r\n  let listItems: { n: number; content: string }[] = [];\r\n\r\n  for (let i = 0; i < lines.length; i++) {\r\n    const line = lines[i];\r\n    const trimmedLine = line.trim();\r\n    const listItemMatch = trimmedLine.match(/^(\\d+)\\.\\s+(.+)$/);\r\n\r\n    if (listItemMatch) {\r\n      const n = Number(listItemMatch[1]);\r\n      const itemContent = listItemMatch[2];\r\n      if (!inList) {\r\n        inList = true;\r\n        listItems = [];\r\n      }\r\n      listItems.push({ n, content: itemContent });\r\n    } else {\r\n      if (inList) {\r\n        const html =\r\n          `<ol class=\"hlx-numlist\" style=\"list-style:none;padding-left:0;margin:16px 0;\">` +\r\n          listItems\r\n            .map(({ n, content }) =>\r\n              `<li style=\"margin:0 0 12px 0;line-height:1.6;\">` +\r\n              `<span style=\"display:inline-block;min-width:1.6em;color:#D65541;font-weight:700;\">${n}.` +\r\n              `</span><span>${content}</span></li>`\r\n            )\r\n            .join('') +\r\n          `</ol>`;\r\n        result.push(html);\r\n        inList = false;\r\n        listItems = [];\r\n      }\r\n      result.push(trimmedLine ? line : '');\r\n    }\r\n  }\r\n\r\n  if (inList && listItems.length > 0) {\r\n    const html =\r\n      `<ol class=\"hlx-numlist\" style=\"list-style:none;padding-left:0;margin:16px 0;\">` +\r\n      listItems\r\n        .map(({ n, content }) =>\r\n          `<li style=\"margin:0 0 12px 0;line-height:1.6;\">` +\r\n          `<span style=\"display:inline-block;min-width:1.6em;color:#D65541;font-weight:700;\">${n}.` +\r\n          `</span><span>${content}</span></li>`\r\n        )\r\n        .join('') +\r\n      `</ol>`;\r\n    result.push(html);\r\n  }\r\n\r\n  return result.join('\\n');\r\n}\r\n\r\n/**\r\n * Removes lines that contain leftover placeholders.\r\n * Also condenses multiple blank lines down to one.\r\n */\r\nexport function removeUnfilledPlaceholders(\r\n  text: string,\r\n  blocks: TemplateBlock[] = templateBlocks\r\n): string {\r\n  const placeholders = getLeftoverPlaceholders(blocks);\r\n\r\n  // Remove placeholder tokens but keep surrounding copy\r\n  let cleaned = text;\r\n  placeholders.forEach((placeholder) => {\r\n    const regex = new RegExp(escapeRegExp(placeholder), 'g');\r\n    cleaned = cleaned.replace(regex, '');\r\n  });\r\n\r\n  const lines = cleaned.split('\\n');\r\n\r\n  const consolidated: string[] = [];\r\n  for (const line of lines) {\r\n    const trimmed = line.trim();\r\n    if (\r\n      trimmed === '' &&\r\n      consolidated.length > 0 &&\r\n      consolidated[consolidated.length - 1].trim() === ''\r\n    ) {\r\n      continue;\r\n    }\r\n    consolidated.push(trimmed);\r\n  }\r\n\r\n  return consolidated.join('\\n').trim();\r\n}\r\n\r\n/**\r\n * Highlight leftover placeholders in CTA red so they stand out in previews\r\n */\r\nexport function markUnfilledPlaceholders(\r\n  text: string,\r\n  blocks: TemplateBlock[] = templateBlocks\r\n): string {\r\n  const placeholders = getLeftoverPlaceholders(blocks);\r\n  let marked = text;\r\n  placeholders.forEach((placeholder) => {\r\n    const regex = new RegExp(escapeRegExp(placeholder), 'g');\r\n    marked = marked.replace(\r\n      regex,\r\n      `<span style=\"color: ${colours.cta}; font-weight: bold;\">${placeholder}</span>`\r\n    );\r\n  });\r\n  // Also highlight generic [INSERT ...] placeholders that haven't been filled\r\n  marked = marked.replace(/\\[INSERT[^\\]]*\\]/gi, (m) => {\r\n    return `<span style=\"color: ${colours.cta}; font-weight: bold;\">${m}</span>`;\r\n  });\r\n  return marked;\r\n}\r\n\r\n/**\r\n * Strips all the highlight <span> attributes (data-placeholder, data-inserted, etc.)\r\n * so final email doesn't have bright highlighting.\r\n * Enhanced version that preserves rich text formatting while removing editor UI elements.\r\n */\r\nexport function removeHighlightSpans(html: string): string {\r\n  const tempDiv = document.createElement('div');\r\n  tempDiv.innerHTML = html;\r\n\r\n  // Elements that should be fully removed\r\n  const removeSelectors =\r\n    '.lock-toggle, .block-sidebar, .sentence-delete, .sentence-handle';\r\n  tempDiv.querySelectorAll(removeSelectors).forEach((el) => el.remove());\r\n\r\n  // Unwrap placeholder containers. If no option is selected, keep the first\r\n  // option's content so that default previews still render.\r\n  tempDiv.querySelectorAll('.block-option-list').forEach((el) => {\r\n    const parent = el.parentNode;\r\n    if (!parent) return;\r\n\r\n    const bubbles = Array.from(el.querySelectorAll('.option-bubble')) as HTMLElement[];\r\n    let keep = bubbles.find(\r\n      (b) => b.classList.contains('active') || b.classList.contains('selected')\r\n    );\r\n    if (!keep && bubbles.length > 0) {\r\n      keep = bubbles[0];\r\n    }\r\n\r\n    bubbles.forEach((bubble) => {\r\n      const bubbleEl = bubble as HTMLElement;\r\n      if (bubbleEl === keep) {\r\n        const bubbleParent = bubbleEl.parentNode;\r\n        if (!bubbleParent) return;\r\n\r\n        // Remove option headers so only the main content remains\r\n        bubbleEl.querySelectorAll('strong').forEach((el) => el.remove());\r\n\r\n        // Unwrap option-preview containers to avoid indentation styles\r\n        bubbleEl.querySelectorAll('.option-preview').forEach((preview) => {\r\n          const previewParent = preview.parentNode;\r\n          if (!previewParent) return;\r\n          while (preview.firstChild)\r\n            previewParent.insertBefore(preview.firstChild, preview);\r\n          previewParent.removeChild(preview);\r\n        });\r\n\r\n        while (bubbleEl.firstChild)\r\n          bubbleParent.insertBefore(bubbleEl.firstChild, bubbleEl);\r\n        bubbleParent.removeChild(bubbleEl);\r\n      } else {\r\n        bubbleEl.remove();\r\n      }\r\n    });\r\n\r\n    while (el.firstChild) parent.insertBefore(el.firstChild, el);\r\n    parent.removeChild(el);\r\n  });\r\n\r\n  // Remove highlight attributes/classes but preserve formatting elements\r\n  const cleanupSelectors =\r\n    '[data-placeholder], [data-inserted], [data-link], [data-sentence], [data-insert], [data-snippet], [data-block-title], .insert-placeholder, .block-main, .block-container';\r\n  tempDiv.querySelectorAll(cleanupSelectors).forEach((el) => {\r\n    el.removeAttribute('data-placeholder');\r\n    el.removeAttribute('data-inserted');\r\n    el.removeAttribute('data-link');\r\n    el.removeAttribute('data-sentence');\r\n    el.removeAttribute('data-insert');\r\n    el.removeAttribute('data-snippet');\r\n    el.removeAttribute('data-block-title');\r\n    el.removeAttribute('contenteditable');\r\n    \r\n    // Remove highlight-specific styling but preserve rich text formatting\r\n    const htmlEl = el as HTMLElement;\r\n    if (htmlEl.style.backgroundColor && \r\n        (htmlEl.style.backgroundColor.includes('rgb(255, 255, 0)') || \r\n         htmlEl.style.backgroundColor.includes('#ffff00') ||\r\n         htmlEl.style.backgroundColor.includes('yellow'))) {\r\n      htmlEl.style.backgroundColor = '';\r\n    }\r\n    \r\n    // Remove editor-specific classes but keep formatting\r\n    if (htmlEl.classList.contains('block-main')) {\r\n      htmlEl.classList.remove('block-main');\r\n    }\r\n    if (htmlEl.classList.contains('block-container')) {\r\n      htmlEl.classList.remove('block-container');\r\n    }\r\n    if (htmlEl.classList.contains('insert-placeholder')) {\r\n      htmlEl.classList.remove('insert-placeholder');\r\n    }\r\n  });\r\n\r\n  // Unwrap containers that are purely structural\r\n  tempDiv.querySelectorAll('[data-block-title]').forEach((el) => {\r\n    const parent = el.parentNode;\r\n    if (!parent) return;\r\n    while (el.firstChild) parent.insertBefore(el.firstChild, el);\r\n    parent.removeChild(el);\r\n  });\r\n\r\n  tempDiv.querySelectorAll('.block-main, .block-container').forEach((el) => {\r\n    const parent = el.parentNode;\r\n    if (!parent) return;\r\n    while (el.firstChild) parent.insertBefore(el.firstChild, el);\r\n    parent.removeChild(el);\r\n  });\r\n\r\n  // Remove label helpers\r\n  tempDiv\r\n    .querySelectorAll('.block-label, .block-label-display')\r\n    .forEach((el) => el.remove());\r\n\r\n  // Apply final email formatting conversion\r\n  return finalizeHTMLForEmail(tempDiv.innerHTML);\r\n}\r\n\r\n/**\r\n * When we insert multiline text from the TemplateBlocks, we turn raw newlines into <br />.\r\n */\r\nexport function cleanTemplateString(template: string): string {\r\n  // Trim the entire string to remove leading/trailing whitespace and newlines\r\n  const trimmedTemplate = template.trim();\r\n  let lines = trimmedTemplate.split('\\n');\r\n\r\n  // If the first line is a header followed by a blank line, drop both\r\n  if (lines.length > 1 && lines[1].trim() === '') {\r\n    lines = lines.slice(2);\r\n  }\r\n\r\n  return lines\r\n    .map((line) => line.trim())\r\n    .join('<br />')\r\n    .replace(/(<br \\/>)+$/, '');\r\n}\r\n\r\n/**\r\n * Wrap all [INSERT ...] placeholders in a span so we can detect them easily.\r\n * Makes them focusable and ready for inline editing.\r\n * Also converts link markers back to proper HTML links.\r\n */\r\nexport function wrapInsertPlaceholders(text: string): string {\r\n  if (!text) {\r\n    return '';\r\n  }\r\n\r\n  const container = document.createElement('div');\r\n  container.innerHTML = text;\r\n\r\n  // Normalise existing wrappers so we can reliably detect duplicates\r\n  container.querySelectorAll('.insert-placeholder').forEach((el) => {\r\n    el.className = 'insert-placeholder';\r\n    (el as HTMLElement).setAttribute('data-insert', '');\r\n  });\r\n\r\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\r\n  const textNodes: Text[] = [];\r\n  let node: Node | null;\r\n  while ((node = walker.nextNode())) {\r\n    textNodes.push(node as Text);\r\n  }\r\n\r\n  const tokenRegex = /\\[INSERT[^\\]]*\\]/gi;\r\n\r\n  for (const textNode of textNodes) {\r\n    const value = textNode.nodeValue || '';\r\n    if (!tokenRegex.test(value)) {\r\n      tokenRegex.lastIndex = 0;\r\n      continue;\r\n    }\r\n    tokenRegex.lastIndex = 0;\r\n\r\n    const parentElement = textNode.parentElement;\r\n    if (parentElement?.closest('.insert-placeholder, .placeholder-editing, .placeholder-edited')) {\r\n      continue; // Already wrapped or actively being edited\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment();\r\n    let lastIndex = 0;\r\n\r\n    value.replace(/\\[INSERT[^\\]]*\\]/gi, (match, offset: number) => {\r\n      if (offset > lastIndex) {\r\n        fragment.appendChild(document.createTextNode(value.slice(lastIndex, offset)));\r\n      }\r\n\r\n      const span = document.createElement('span');\r\n      span.className = 'insert-placeholder';\r\n      span.setAttribute('data-insert', '');\r\n      span.textContent = match;\r\n      fragment.appendChild(span);\r\n\r\n      lastIndex = offset + match.length;\r\n      return match;\r\n    });\r\n\r\n    if (lastIndex < value.length) {\r\n      fragment.appendChild(document.createTextNode(value.slice(lastIndex)));\r\n    }\r\n\r\n    textNode.parentNode?.replaceChild(fragment, textNode);\r\n  }\r\n\r\n  let result = container.innerHTML;\r\n\r\n  // Then handle Instruct Helix Law link markers on the serialized HTML\r\n  result = result.replace(/\\[\\[INSTRUCT_LINK::([^\\]]+)\\]\\]/gi, (_match, href) => {\r\n    return `<a href=\"${href}\" class=\"instruct-link\" style=\"color: #3690CE; text-decoration: underline;\" target=\"_blank\" rel=\"noopener noreferrer\">Instruct Helix Law</a>`;\r\n  });\r\n\r\n  // Handle any remaining [InstructLink] placeholders that don't have a passcode yet\r\n  result = result.replace(/\\[InstructLink\\]/gi, () => {\r\n    return `<span class=\"instruct-link-pending\" style=\"color: #D65541; font-weight: 700; text-decoration: underline; opacity: 0.7; cursor: help;\" title=\"Link will be generated after deal is saved\">Instruct Helix Law</span>`;\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * A quick helper: do we have an array of strings or a single string?\r\n */\r\nexport function isStringArray(value: string | string[]): value is string[] {\r\n  return Array.isArray(value);\r\n}\r\n\r\n/**\r\n * Process editor content for email sending with full formatting preservation\r\n * This is the main function to call when preparing rich text content for email\r\n */\r\nexport function processEditorContentForEmail(editorElement: HTMLElement | null, fallbackHtml?: string): string {\r\n  let html = '';\r\n  \r\n  if (editorElement) {\r\n    // Extract formatting-preserved content from the editor\r\n    html = extractFormattingForEmail(editorElement);\r\n  } else if (fallbackHtml) {\r\n    // Use fallback HTML and apply email formatting\r\n    html = finalizeHTMLForEmail(fallbackHtml);\r\n  }\r\n  \r\n  if (!html) return '';\r\n  \r\n  // Remove editor UI elements while preserving formatting\r\n  html = removeHighlightSpans(html);\r\n  \r\n  // Apply final email optimizations\r\n  return finalizeHTMLForEmail(html);\r\n}\r\n\r\nexport function replacePlaceholders(\r\n  template: string,\r\n  intro: string,\r\n  enquiry: Enquiry,\r\n  userData: any,\r\n  blocks: TemplateBlock[] = templateBlocks\r\n): string {\r\n  const userFirstName = userData?.[0]?.['First'] || 'Your';\r\n  const userFullName = userData?.[0]?.['Full Name'] || 'Your Name';\r\n  const userRole = userData?.[0]?.['Role'] || 'Your Position';\r\n  // Get the raw rate value\r\n  const userRate = userData?.[0]?.['Rate'];\r\n  // Format the rate to include the £ symbol and VAT text\r\n  const formattedRate =\r\n    userRate && userRate !== '[Rate]' ? `£${userRate} + VAT` : '[Rate]';\r\n\r\n  let result = template\r\n    .replace(\r\n      /\\[Enquiry.First_Name\\]/g,\r\n      `<span style=\"background-color: ${colours.highlightYellow}; padding: 1px 3px;\" data-placeholder=\"[Enquiry.First_Name]\">${\r\n        enquiry.First_Name || 'there'\r\n      }</span>`\r\n    )\r\n    .replace(\r\n      /\\[Enquiry.Point_of_Contact\\]/g,\r\n      `<span style=\"background-color: ${colours.highlightYellow}; padding: 1px 3px;\" data-placeholder=\"[Enquiry.Point_of_Contact]\">${\r\n        enquiry.Point_of_Contact || 'Our Team'\r\n      }</span>`\r\n    );\r\n\r\n  // Insert placeholders for each template block\r\n  blocks.forEach((block) => {\r\n    const regex = new RegExp(escapeRegExp(block.placeholder), 'g');\r\n    const optionBubbles = block.options\r\n      .map((o) => {\r\n        const preview = cleanTemplateString(o.previewText).replace(/<p>/g, `<p style=\"margin: 0;\">`);\r\n        return `<div class=\"option-bubble\" data-block-title=\"${block.title}\" data-option-label=\"${o.label}\"><strong>${o.label}</strong><div class=\"option-preview\">${preview}</div></div>`;\r\n      })\r\n      .join('');\r\n    result = result.replace(\r\n      regex,\r\n      `<span data-placeholder=\"${block.placeholder}\" class=\"block-option-list\"><span class=\"block-label\" data-label-title=\"${block.title}\">${block.title}</span>${optionBubbles}</span>`\r\n    );\r\n  });\r\n\r\n  result = result\r\n    .replace(\r\n      /\\[First Name\\]/g,\r\n      `<span data-placeholder=\"[First Name]\" style=\"background-color: ${colours.grey}; padding: 1px 3px;\">${userFirstName}</span>`\r\n    )\r\n    .replace(\r\n      /\\[Full Name\\]/g,\r\n      `<span data-placeholder=\"[Full Name]\" style=\"background-color: ${colours.grey}; padding: 1px 3px;\">${userFullName}</span>`\r\n    )\r\n    .replace(\r\n      /\\[Position\\]/g,\r\n      `<span data-placeholder=\"[Position]\" style=\"background-color: ${colours.grey}; padding: 1px 3px;\">${userRole}</span>`\r\n    )\r\n    .replace(\r\n      /\\[Rate\\]/g,\r\n      `<span data-placeholder=\"[Rate]\" style=\"background-color: ${colours.grey}; padding: 1px 3px;\">${formattedRate}</span>`\r\n    );\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Helper function to replace [FE] and [ACID] with dynamic values.\r\n */\r\nexport function applyDynamicSubstitutions(\r\n  text: string,\r\n  userData: any,\r\n  enquiry: Enquiry,\r\n  amount?: number | string,\r\n  passcode?: string,\r\n  instructionsLink?: string\r\n): string {\r\n  const userInitials = userData?.[0]?.['Initials'] || 'XX';\r\n  const enquiryID = enquiry?.ID || '0000';\r\n  const userRole = userData?.[0]?.['Role'] || '[Position]';\r\n  const userRate = userData?.[0]?.['Rate']; // This is the raw rate value from SQL\r\n  // Format the rate to include the pound symbol and \" + VAT\"\r\n  const formattedRate =\r\n    userRate && userRate !== '[Rate]' ? `£${userRate} + VAT` : '[Rate]';\r\n\r\n  const formattedAmount =\r\n    amount !== undefined && amount !== null && amount !== ''\r\n      ? (() => {\r\n          const num = Number(amount);\r\n          if (isNaN(num)) return '[Amount]';\r\n          const withDecimals = num.toLocaleString('en-GB', {\r\n            minimumFractionDigits: 2,\r\n            maximumFractionDigits: 2,\r\n          });\r\n          return `£${withDecimals.replace(/\\.00$/, '')}`;\r\n        })()\r\n      : '[Amount]';\r\n\r\n  // Prefer provided instructionsLink. Otherwise build using passcode ONLY (drop legacy prospectId-passcode format).\r\n  // Required format now: https://instruct.helix-law.com/pitch/<passcode>\r\n  const baseUrl = process.env.REACT_APP_INSTRUCTIONS_URL || 'https://instruct.helix-law.com';\r\n  const finalInstructionsLink = instructionsLink\r\n    || (passcode\r\n      ? `${baseUrl}/pitch/${passcode}`\r\n      : `${baseUrl}/pitch`);\r\n\r\n  // Prebuild the anchor used in HTML previews/emails\r\n  const instructAnchor = `<a href=\"${finalInstructionsLink}\" target=\"_blank\" rel=\"noopener noreferrer\">Instruct Helix Law</a>`;\r\n\r\n  return text\r\n  // Support explicit marker syntax used in editor content - extract URL from within marker\r\n  .replace(/\\[\\[INSTRUCT_LINK::([^\\]]*)\\]\\]/gi, (match, url) => {\r\n    // Normalize URL and append passcode if pointing to /pitch or /pitch/\r\n    const cleanUrlRaw = (url || '').trim();\r\n    const cleanUrl = cleanUrlRaw.replace(/\\/$/, ''); // drop trailing slash for comparison\r\n    if ((cleanUrl === `${baseUrl}/pitch`) && passcode) {\r\n      return `<a href=\"${baseUrl}/pitch/${passcode}\" target=\"_blank\" rel=\"noopener noreferrer\">Instruct Helix Law</a>`;\r\n    }\r\n    // If no passcode, keep provided URL as-is\r\n    return `<a href=\"${cleanUrlRaw}\" target=\"_blank\" rel=\"noopener noreferrer\">Instruct Helix Law</a>`;\r\n  })\r\n  // Normalize any existing instruct-link anchors from editor to the final URL and remove red styling\r\n  .replace(/<a([^>]*?)class=(\"|')[^\"']*instruct-link[^\"']*(\\2)([^>]*)>(.*?)<\\/a>/gi, (_m, pre, q, _q2, post, text) => {\r\n    return `<a href=\"${finalInstructionsLink}\" target=\"_blank\" rel=\"noopener noreferrer\">${text || 'Instruct Helix Law'}</a>`;\r\n  })\r\n    .replace(/\\[FE\\]/g, userInitials)\r\n    .replace(/\\[ACID\\]/g, enquiryID)\r\n    .replace(/\\[Position\\]/g, userRole)\r\n    .replace(/\\[Rate\\]/g, formattedRate)\r\n    .replace(/\\[Amount\\]/g, formattedAmount)\r\n    .replace(/\\[Passcode\\]/g, passcode || '[Passcode]')\r\n  // Render a human-friendly hyperlink instead of a raw URL\r\n  .replace(/\\[InstructLink\\]/g, instructAnchor);\r\n}","// src/tabs/enquiries/TemplateBlocks.ts\r\n// invisible change 2\r\n\r\nimport { IStyleFunctionOrObject, IDropdownStyles, IDropdownStyleProps } from '@fluentui/react';\r\n\r\nexport interface TemplateBlock {\r\n  title: string;\r\n  description: string;\r\n  placeholder: string;\r\n  isMultiSelect?: boolean;\r\n  /** Database BlockId when loaded from the snippet service */\r\n  blockId?: number;\r\n  options: TemplateOption[];\r\n  dropdownStyles?: IStyleFunctionOrObject<IDropdownStyleProps, IDropdownStyles>;\r\n  /** Editable content for this block (used in pitch builder editing) */\r\n  editableContent?: string;\r\n}\r\n\r\nexport interface TemplateOption {\r\n  label: string;\r\n  previewText: string;\r\n  /** Database SnippetId when loaded from the snippet service */\r\n  snippetId?: number;\r\n}\r\n\r\nexport const templateBlocks: TemplateBlock[] = [\r\n  {\r\n    title: 'Introduction',\r\n    description: 'Set the tone and acknowledge the enquiry.',\r\n    placeholder: '[FE Introduction Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Standard Acknowledgment',\r\n        previewText: `Thank you for your enquiry to Helix Law. We’re a specialist firm of solicitors only dealing with litigation of disputes and we act nationally. We often deal with disputes such as yours and I am confident we are well-placed to assist in relation to your matter.`,\r\n      },\r\n      {\r\n        label: 'Follow-Up After Call',\r\n        previewText: `Thank you for your enquiry and for your time on the phone earlier. It was good speaking with you.\\n\\nThe purpose of this email is to briefly follow up on our conversation.`,\r\n      },\r\n      {\r\n        label: 'Missed Call Acknowledgment',\r\n        previewText: `Thank you for your enquiry to Helix Law. I have tried to call you to discuss your matter but was unable to reach you.\\n\\nAs a starting point, if you prefer, please email me a brief summary of the background and current position. I will briefly review the content and will come back to you and we can take it from there.`,\r\n      },\r\n      {\r\n        label: 'Apology for Delay',\r\n        previewText: `Thank you for your enquiry to Helix Law. Please accept my apology for the slight delay in my contacting you.\\n\\nI have only limited information regarding your dispute. As a starting point please can you email me a brief summary of the background and current position. I will briefly review the content and will come back to you and we can take it from there.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Current Situation and Problem',\r\n    description: 'Overview of the current situation and identified problems.',\r\n    placeholder: '[Current Situation and Problem Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'The Dispute',\r\n        previewText: `The Dispute\r\n  \r\n  You have provided an initial outline of the position that [INSERT]`,\r\n      },\r\n      {\r\n        label: 'Current Position and Problems',\r\n        previewText: `We have discussed that you are [INSERT]. You have a dispute with [INSERT] because [INSERT] and have confirmed that [INSERT].\r\n\r\n  The dispute with [INSERT] situation creates difficulty for you for obvious reasons, including because [INSERT].\r\n\r\n  In addition to the above, additional problems arise and need to be addressed, such as [INSERT].`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Potential Causes of Action and Remedies',\r\n    description: 'Outline potential causes of action and available remedies.',\r\n    placeholder: '[Potential Causes of Action and Remedies Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Potential Causes of Action and Remedies',\r\n        previewText: `Potential Causes of Action and Remedies\r\n  \r\n  Assuming that you can evidence the position above, then there are likely to be the following causes of action.\r\n   \r\n  It is vital that we work together to strategically position you around the following key areas:\r\n  \r\n  X\r\n  Y\r\n  Z\r\n   \r\n  I am experienced in dealing with this type of issue and am happy to assist you and the key is from this point on to carefully position you so that you are in a sufficiently strong position that you can force the Defendants to reach a sensible commercial settlement or if they will not do so proceed to court and obtain the same or a better result, while of course putting you in the best possible position to recover the costs you incur in the litigation from them.\r\n  \r\n  In the context of a dispute worth in the high hundreds of thousands or millions, from a cost v benefit analysis, my initial view is it stacks up for you to incur the costs for the initial review below.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Scope of Work',\r\n    description: 'Define what assistance will be provided.',\r\n    placeholder: '[Scope of Work Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Initial Review and Costs',\r\n        previewText: `Initial Review and Costs\r\n  \r\n  This will require an initial review of core documents such as the contract and taking your instructions around the actions taken to devalue the company, as well as where appropriate, pinning down the stated position on Y. I then anticipate being able to provide initial advice on your current position and best next steps.\r\n  \r\n  We charge on a time recorded basis and record all time in 6 minute units. This includes for emails in and out and telephone attendances, and all steps on your behalf. I am a [INSERT] and my hourly rate is £[INSERT] + VAT. We work as a team and a number of colleagues may assist in relation to various steps in relation to your matter, at different times. Their time will be recorded and charged on the basis of their hourly rates as applicable from time to time – these are all lower than £395+VAT.\r\n  \r\n  For the initial work and review above you will need to budget in the region of approximately [Amount] + VAT. This is an estimate and not a fixed fee; the cost will ultimately depend on the time spent including the scale of documents and enquiries received from you, but based on my experience this is likely to be an accurate estimate at this stage. If it takes less time we will of course bill you less.\r\n  \r\n  Further work will incur additional costs on a time basis and in a fully litigated dispute it is not unusual for each party to incur costs of tens of thousands of pounds in this type of dispute, if not higher. Costs will of course be a concern, naturally.\r\n  \r\n  Equally, if you are positioned to win a dispute you can usually expect to recover in the region of approximately 65-70% of your costs (if not higher). In this context the fear of being ordered to pay your costs can provide powerful leverage to force resolution of a dispute in your favour. We will of course consider this within our initial review and work as above.`,\r\n      },\r\n      {\r\n        label: 'Initial Steps- Review and Advice',\r\n        previewText: `Initial Steps- Review and Advice\r\n  \r\n  I am experienced in dealing with this type of issue and am happy to assist you. At this initial stage it is necessary and incredibly important to review the background and current position so that we can then advise on your best next steps.\r\n  \r\n  This will require an initial review of core documents such as [INSERT the contracts, notices, demands, accounts, relevant correspondence set out below] so that we can be as clear as possible on the factual position with companies house and land registry. I then anticipate being able to provide initial advice on your current position and best next steps.`,\r\n      },\r\n      {\r\n        label: 'Shareholder Dispute',\r\n        previewText: `Obviously you will want and need to protect your position in the company as robustly as possible. In the above context I need to review your situation and the background and current position in more detail, including documents that are relevant to your situation and filings with companies house. This will enable me to provide you with initial advice on your current position and your best next steps.\r\n  \r\n  To assist me in completing the review if you can please provide a copy of the shareholders agreement (if any), Directors service agreement (if any), copies of the recent correspondence you have received and sent, and a brief summary over no more than 2 pages of the current position. It is fine to use bullet points within an email for this if you prefer.\r\n  \r\n  On receipt of the above I will confirm our time and cost estimate for our review of the documents and initial advice on your current position and best next steps.`,\r\n      },\r\n      {\r\n        label: 'Statutory Demand',\r\n        previewText: `In the above context I need to review your situation and the background and current position in more detail, including documents that are relevant to your situation. This will enable me to provide you with initial advice on your current position and your best next steps.\r\n  \r\n  It is usually important to act quickly in this type of situation to force or avoid a winding up petition being issued. When a petition is issued all company bank accounts are immediately frozen which can have a catastrophic impact on a business for obvious reasons. A quick and robust approach is therefore needed to force resolution.\r\n  \r\n  It will assist me in completing the review if you can please provide a copy of the contract or agreement (if any), any terms and conditions, the unpaid invoice and copies of the recent correspondence you have received and have sent, as well as a brief summary over no more than 2 pages setting out the relevant background and current position. It is fine to use bullet points for this in an email if you prefer.\r\n  \r\n  On receipt of the above I will confirm our time and cost estimate for our review of the documents and initial advice on your current position and best next steps.`,\r\n      },\r\n      {\r\n        label: 'Property-Specific Review and Advice',\r\n        previewText: `In the above context I need to review your situation and the background and current position in more detail, including documents that are relevant to your situation.\r\n  \r\n  At this initial early stage please provide me with the tenancy agreement, any relevant correspondence, and a brief summary of no more than 2 pages or bullet points in an email, summarising your current position and the dispute. This will enable me to provide you with initial advice on your current position and your best next steps.\r\n  \r\n  Further documents might be needed from you which I will confirm separately when you have taken the next steps below.`,\r\n      },\r\n      {\r\n        label: 'Construction-Specific Scope',\r\n        previewText: `In the above context I need to review your situation and the background and current position in more detail, including documents that are relevant to your dispute.\r\n  \r\n  Please provide me with a copy of the contract, any relevant correspondence, and a brief summary of no more than 2 pages summarising the nature of the dispute. This will enable me to provide you with initial advice on your current position and your best next steps.\r\n  \r\n  It is likely that further documents and information might be needed which I will confirm in due course, but this will be a useful starting point.\r\n  \r\n  I will then review your position and advise on strategy, including settlement and appropriate next steps and we can then discuss this further.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Risk Assessment',\r\n    description: 'Outline potential risks and considerations.',\r\n    placeholder: '[Risk Assessment Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Cost/Benefit Analysis',\r\n        previewText: `My current initial view is that this is a situation, and is sufficiently serious, where it stacks up from a cost; benefit perspective for you to obtain advice on your current position and best next steps.\\n\\nObviously it is fundamentally important that we (you and I) continue to keep this under review including within our initial work on your behalf.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Costs and Budget',\r\n    description: 'Provide transparent cost estimates and fee structure.',\r\n    placeholder: '[Costs and Budget Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Initial Cost',\r\n        previewText: `We charge on a time recorded basis and record all time in 6 minute units. This includes for emails in and out and telephone attendances, and all steps on your behalf. I am a [Position] and my hourly rate is [Rate].\\n\\nWe work as a team and a number of colleagues may assist in relation to various steps in relation to your matter, at different times. Their time will be recorded and charged on the basis of their hourly rates as applicable from time to time – these are all lower than £395+VAT.\\n\\nFor the initial work and review above you will need to budget in the region of approximately [Amount] + VAT. This is an estimate and not a fixed fee; the cost will ultimately depend on the time spent including the scale of documents and enquiries received from you, but based on my experience this is likely to be an accurate estimate at this stage.\\n\\nFurther work will incur additional costs on a time basis and in a fully litigated dispute it is not unusual for each party to incur costs of tens of thousands of pounds in this type of dispute, if not higher. Costs will of course be a concern, naturally.\\n\\nEqually, if you are positioned to win a dispute you can usually expect to recover in the region of approximately 65-70% of your costs (if not higher). In this context the fear of being ordered to pay your costs can provide powerful leverage to force resolution of a dispute in your favour. We will of course consider this within our initial review and work as above.`,\r\n      },      \r\n      {\r\n        label: 'CFA',\r\n        previewText: `I am aware that you are seeking alternative funding regarding your matter commonly known as a Conditional Fee Agreement, or 'no win, no fee' agreement. We are not obliged to offer this form of funding but I am happy to consider doing so. This is subject to us entering into a separate funding agreement between us (a contract). Transparently we only offer no win, no fee funding where it stacks up for you and for us and we need to be sufficiently confident in your prospects of success. At this initial stage please therefore provide the initial documents and information I have requested to enable me to initially briefly review whether this will be appropriate.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Required Documents',\r\n    description: 'List the documents needed to proceed.',\r\n    placeholder: '[Required Documents Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      { label: 'The contract', previewText: 'The contract' },\r\n      { label: 'Any relevant correspondence', previewText: 'Any relevant correspondence' },\r\n      { label: 'Settlement Agreement', previewText: 'Settlement Agreement' },\r\n      { label: 'Shareholders\\' Agreement', previewText: 'Shareholders\\' Agreement' },\r\n      { label: 'Financial Statements', previewText: 'Financial Statements' },\r\n      { label: 'Invoices or Asset Information', previewText: 'Invoices or Asset Information' },\r\n    ],\r\n    dropdownStyles: {\r\n      callout: {\r\n        maxHeight: '150px',\r\n        overflowY: 'auto',\r\n      },\r\n      title: {\r\n        whiteSpace: 'nowrap',\r\n        overflow: 'hidden',\r\n        textOverflow: 'ellipsis',\r\n      },\r\n    },\r\n  },\r\n  {\r\n    \"title\": \"Next Steps to Instruct Helix Law\",\r\n    \"description\": \"Define clear next steps for the client.\",\r\n    \"placeholder\": \"[Follow-Up Instructions Placeholder]\",\r\n    \"isMultiSelect\": true,\r\n    \"options\": [\r\n      {\r\n        \"label\": \"Instruct Helix Law - Pitch\",\r\n        \"previewText\": `Please confirm your instructions by clicking <a href=\"[InstructLink]\" target=\"_blank\" class=\"insert-placeholder\" data-insert>INSTRUCT HELIX LAW</a>. Your passcode is [Passcode]. Our packaged checkout link, [CheckoutLink], makes it quick and transparent to verify your identity, supply the key documents and pay funds on account in one step so we can open a file without delay. I will then send you my Client Care Letter setting out the terms of our retainer. If you have any queries I'm very happy to discuss them without charge.`\r\n      }\r\n    ]\r\n  },\r\n  // Separate Block for Meeting Link\r\n  {\r\n    title: 'Meeting Link',\r\n    description: 'Provide the client with an option to schedule a meeting.',\r\n    placeholder: '[Meeting Link Placeholder]',\r\n    isMultiSelect: false,\r\n    options: [\r\n      {\r\n        label: 'Meeting Link',\r\n        previewText: \r\n          `You are welcome to schedule a meeting using the link below:\\n\\n` +\r\n          `https://calendly.com/helixlaw-fe`,\r\n      },\r\n    ],\r\n  },  \r\n  {\r\n    title: 'Closing Notes',\r\n    description: 'Summarise and add a personal touch to the email.',\r\n    placeholder: '[Closing Notes Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        \"label\": \"Closing\",\r\n        \"previewText\": \"I hope the above helps and look forward to helping resolve your matter.\\n\\nThere is obviously some degree of complexity factually and legally in relation to your matter. We’re a specialist team and I hope to assist you navigate the process effectively to achieve a positive outcome.\\n\\nTo be clear, when you have completed the above steps we will review the position and at our discretion will open a file. We will then set out the terms of our retainer and file with you and will ask you to confirm that those terms are accepted. Only at that stage will a retainer be confirmed between us. Although unusual, we may decline to act for you for any reason in which case any monies paid by you will be returned without charge. I hope the above makes sense and is clear but don't hesitate to contact me if you have any queries and I will be happy to help.\"\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Google Review',\r\n    description: 'Encourage prospects to leave a Google review.',\r\n    placeholder: '[Google Review Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Request for Review',\r\n        previewText: `I hope the above [and our call] is useful and of course come back to me if I can help you further.\\n\\nIn the meantime, I’m wondering if you can help me by providing a brief positive Google review of me and Helix Law. We’re a small but specialist team, and this would make a huge difference to us.\\n\\nIf you don’t mind, please can you give us a brief 5* positive review at the following link:\\n\\nhttp://bit.ly/2gGwyNJ\\n\\nYou will need to be signed into Google.\\n\\nMany thanks in advance.`,\r\n      },\r\n    ],\r\n  }\r\n];\r\n\r\nexport default templateBlocks;","import React, { useCallback, useMemo } from 'react';\r\nimport { TextField } from '@fluentui/react';\r\n// Removed calculator icon for cleaner alignment of fee field\r\nimport { colours } from '../../../app/styles/colours';\r\n\r\n/** Props for DealCapture component */\r\nexport interface DealCaptureProps {\r\n  isDarkMode: boolean;\r\n  scopeDescription: string;\r\n  onScopeChange: (value: string) => void;\r\n  amount: string; // raw numeric string\r\n  onAmountChange: (value: string) => void;\r\n  amountError?: string | null;\r\n}\r\n\r\n/** Compact, theme‑aware deal capture (scope + fee + VAT breakdown). */\r\nexport const DealCapture: React.FC<DealCaptureProps> = ({\r\n  isDarkMode,\r\n  scopeDescription,\r\n  onScopeChange,\r\n  amount,\r\n  onAmountChange,\r\n  amountError,\r\n}) => {\r\n  const bg = isDarkMode ? colours.dark.sectionBackground : colours.light.sectionBackground;\r\n  const border = isDarkMode ? colours.dark.border : '#E2E8F0';\r\n  const text = isDarkMode ? colours.dark.text : colours.light.text;\r\n  const subtle = isDarkMode ? '#94a3b8' : '#64748B';\r\n  const accent = isDarkMode ? '#60A5FA' : '#3690CE';\r\n\r\n  const handleScope = useCallback((ev: React.FormEvent<HTMLInputElement | HTMLTextAreaElement>, v?: string) => {\r\n    onScopeChange(v || '');\r\n  }, [onScopeChange]);\r\n\r\n  const handleAmount = useCallback((ev: React.FormEvent<HTMLInputElement | HTMLTextAreaElement>, v?: string) => {\r\n    const raw = (v || '').replace(/[^0-9.]/g, '');\r\n    onAmountChange(raw);\r\n  }, [onAmountChange]);\r\n\r\n  const vatInfo = useMemo(() => {\r\n    const n = parseFloat(amount);\r\n    if (!amount || isNaN(n)) return null;\r\n    const vat = +(n * 0.2).toFixed(2);\r\n    const total = +(n + vat).toFixed(2);\r\n    const fmt = (x: number) => `£${x.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n    return { ex: fmt(n), vat: fmt(vat), total: fmt(total) };\r\n  }, [amount]);\r\n\r\n  const adjust = (delta: number) => {\r\n    const n = parseFloat(amount) || 0;\r\n    const next = Math.max(0, n + delta);\r\n    onAmountChange(next.toString());\r\n  };\r\n\r\n  return (\r\n    <div style={{\r\n      background: isDarkMode\r\n        ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n        : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.94) 100%)',\r\n      border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n      borderRadius: 16,\r\n      padding: 28,\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n      gap: 28,\r\n      boxShadow: isDarkMode \r\n        ? '0 18px 32px rgba(2, 6, 17, 0.58)' \r\n        : '0 12px 28px rgba(13, 47, 96, 0.12)',\r\n      position: 'relative',\r\n      backdropFilter: 'blur(12px)',\r\n      animation: 'cascadeIn 0.4s ease-out'\r\n    }}>\r\n      <div style={{ display:'flex', flexDirection:'column', gap:16 }}>\r\n        <label style={{\r\n          fontSize: 16,\r\n          fontWeight: 600,\r\n          color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          gap: 8\r\n        }}>\r\n          Scope & Quote Description <span style={{ color: colours.red, fontSize: 12 }}>*</span>\r\n        </label>\r\n        <TextField\r\n          multiline\r\n          autoAdjustHeight\r\n          rows={4}\r\n          value={scopeDescription}\r\n          onChange={handleScope}\r\n          placeholder=\"Describe the scope of work...\"\r\n          styles={{\r\n            field:{\r\n              fontSize:15,\r\n              lineHeight:1.55,\r\n              background: 'transparent',\r\n              color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n              fontFamily:'inherit',\r\n              padding:'18px 20px',\r\n              border: 'none',\r\n              borderRadius: 10,\r\n              selectors:{\r\n                '::placeholder':{ color: isDarkMode ? '#94A3B8' : '#64748B' }\r\n              }\r\n            },\r\n            fieldGroup:{\r\n              border:`1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)'}`,\r\n              borderRadius:10,\r\n              background: isDarkMode\r\n                ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.88) 100%)'\r\n                : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n              overflow: 'hidden',\r\n              selectors:{\r\n                ':hover':{ \r\n                  borderColor: isDarkMode ? '#60A5FA' : '#3690CE',\r\n                  transition: 'border-color 0.2s ease'\r\n                },\r\n                '.is-focused':{ \r\n                  borderColor: isDarkMode ? '#60A5FA' : '#3690CE', \r\n                  boxShadow: isDarkMode\r\n                    ? '0 0 0 4px rgba(96, 165, 250, 0.2)'\r\n                    : '0 0 0 4px rgba(54, 144, 206, 0.15)',\r\n                  outline: 'none'\r\n                }\r\n              }\r\n            },\r\n            wrapper:{\r\n              borderRadius:10\r\n            }\r\n          }}\r\n        />\r\n      </div>\r\n\r\n      <div style={{ display:'flex', flexDirection:'column', gap:18 }}>\r\n        <div style={{ width:'100%' }}>\r\n          <label style={{\r\n            fontSize:15,\r\n            fontWeight:600,\r\n            color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n            marginBottom:8,\r\n            display:'flex',\r\n            alignItems:'center',\r\n            gap:6\r\n          }}>\r\n            Confirm Amount <span style={{ color: colours.red, fontSize: 11 }}>*</span>\r\n          </label>\r\n          <div \r\n            style={{\r\n              border:`1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)'}`,\r\n              borderRadius:12,\r\n              background: isDarkMode\r\n                ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.88) 100%)'\r\n                : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n              display:'flex',\r\n              alignItems:'stretch',\r\n              minHeight: 62,\r\n              transition:'all .2s ease',\r\n              boxShadow: isDarkMode\r\n                ? '0 8px 16px rgba(4, 9, 20, 0.5)'\r\n                : '0 4px 12px rgba(13, 47, 96, 0.1)',\r\n              backdropFilter: 'blur(6px)'\r\n            }}\r\n            onMouseEnter={(e) => {\r\n              e.currentTarget.style.borderColor = isDarkMode ? '#60A5FA' : '#3690CE';\r\n              e.currentTarget.style.boxShadow = isDarkMode\r\n                ? '0 12px 24px rgba(96, 165, 250, 0.25)'\r\n                : '0 8px 20px rgba(54, 144, 206, 0.18)';\r\n            }}\r\n            onMouseLeave={(e) => {\r\n              e.currentTarget.style.borderColor = isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)';\r\n              e.currentTarget.style.boxShadow = isDarkMode\r\n                ? '0 8px 16px rgba(4, 9, 20, 0.5)'\r\n                : '0 4px 12px rgba(13, 47, 96, 0.1)';\r\n            }}\r\n            onFocus={(e) => {\r\n              e.currentTarget.style.borderColor = isDarkMode ? '#60A5FA' : '#3690CE';\r\n              e.currentTarget.style.boxShadow = isDarkMode\r\n                ? '0 0 0 4px rgba(96, 165, 250, 0.2), 0 12px 24px rgba(96, 165, 250, 0.25)'\r\n                : '0 0 0 4px rgba(54, 144, 206, 0.15), 0 8px 20px rgba(54, 144, 206, 0.18)';\r\n            }}\r\n            onBlur={(e) => {\r\n              e.currentTarget.style.borderColor = isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)';\r\n              e.currentTarget.style.boxShadow = isDarkMode\r\n                ? '0 8px 16px rgba(4, 9, 20, 0.5)'\r\n                : '0 4px 12px rgba(13, 47, 96, 0.1)';\r\n            }}\r\n          >\r\n            <div style={{\r\n              display:'flex',\r\n              alignItems:'center',\r\n              paddingLeft:16,\r\n              paddingRight:12,\r\n              paddingTop: 4,\r\n              paddingBottom: 4,\r\n              fontSize:18,\r\n              fontWeight:600,\r\n              color: isDarkMode ? '#60A5FA' : '#3690CE',\r\n              borderRight:`1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)'}`\r\n            }}>\r\n              £\r\n            </div>\r\n            <TextField\r\n              value={amount}\r\n              onChange={handleAmount}\r\n              placeholder=\"1500\"\r\n              errorMessage={amountError || undefined}\r\n              styles={{\r\n                root:{ flex:1 },\r\n                field:{\r\n                  fontSize:20,\r\n                  fontWeight:600,\r\n                  background:'transparent',\r\n                  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                  fontFamily:'inherit',\r\n                  padding:'20px 16px',\r\n                  border:'none',\r\n                  minHeight: 60\r\n                },\r\n                fieldGroup:{\r\n                  border:'none',\r\n                  borderRadius:0,\r\n                  background:'transparent',\r\n                  minHeight: 60\r\n                }\r\n              }}\r\n            />\r\n            <div style={{\r\n              display:'flex',\r\n              alignItems:'center',\r\n              gap:2,\r\n              paddingRight:8,\r\n              paddingTop: 4,\r\n              paddingBottom: 4,\r\n              borderLeft:`1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)'}`\r\n            }}>\r\n              <button type=\"button\" onClick={() => adjust(50)} style={integratedButton(isDarkMode, true)}>+50</button>\r\n              <button type=\"button\" onClick={() => adjust(-50)} style={integratedButton(isDarkMode, false)}>-50</button>\r\n            </div>\r\n          </div>\r\n          <div style={{ marginTop:8, fontSize:12, lineHeight:1.4, color: isDarkMode ? '#94A3B8' : '#64748B' }}>\r\n            Fee excluding VAT. Use +50/-50 to adjust.\r\n          </div>\r\n        </div>\r\n\r\n        {vatInfo && (\r\n          <div style={{\r\n            background: isDarkMode\r\n              ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.92) 0%, rgba(11, 30, 55, 0.86) 100%)'\r\n              : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n            border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n            borderRadius: 14,\r\n            padding: '20px 24px',\r\n            display:'grid',\r\n            gap:12,\r\n            gridTemplateColumns:'auto 1fr',\r\n            alignItems:'center',\r\n            boxShadow: isDarkMode \r\n              ? '0 10px 22px rgba(4, 9, 20, 0.55)' \r\n              : '0 6px 16px rgba(13, 47, 96, 0.12)',\r\n            backdropFilter: 'blur(8px)'\r\n          }}>\r\n            <span style={labelStyle(isDarkMode ? '#94A3B8' : '#64748B')}>Ex VAT:</span><span style={valueStyle(isDarkMode ? '#E0F2FE' : '#0F172A')}>{vatInfo.ex}</span>\r\n            <span style={labelStyle(isDarkMode ? '#94A3B8' : '#64748B')}>VAT (20%):</span><span style={valueStyle(isDarkMode ? '#E0F2FE' : '#0F172A')}>{vatInfo.vat}</span>\r\n            <div style={{ gridColumn:'1 / -1', height:1, background:isDarkMode?'rgba(125, 211, 252, 0.24)':'rgba(148, 163, 184, 0.3)', margin:'6px 0 4px' }} />\r\n            <span style={{ fontSize:15, fontWeight:700, color: isDarkMode ? '#E0F2FE' : '#0F172A' }}>Total inc VAT:</span>\r\n            <span style={{ fontSize:18, fontWeight:700, color: isDarkMode ? '#60A5FA' : '#3690CE', textAlign:'right' }}>{vatInfo.total}</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst buttonStyle = (isDarkMode: boolean): React.CSSProperties => ({\r\n  padding:'4px 10px',\r\n  border:'1px solid #94A3B8',\r\n  background: isDarkMode ? colours.dark.inputBackground : '#FFFFFF',\r\n  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n  borderRadius:6,\r\n  cursor:'pointer',\r\n  fontSize:12,\r\n  fontWeight:600,\r\n  lineHeight:1,\r\n  transition:'all .15s ease',\r\n  boxShadow: isDarkMode ? '0 1px 2px rgba(0,0,0,0.4)' : '0 1px 2px rgba(0,0,0,0.08)',\r\n});\r\n\r\nconst inlineButton = (isDarkMode: boolean, positive: boolean): React.CSSProperties => ({\r\n  padding:'4px 8px',\r\n  border:'1px solid ' + (isDarkMode ? colours.dark.border : '#94A3B8'),\r\n  background: isDarkMode ? colours.dark.inputBackground : '#FFFFFF',\r\n  color: positive ? (isDarkMode ? '#60A5FA' : '#3690CE') : (isDarkMode ? '#E0F2FE' : '#0F172A'),\r\n  borderRadius:4,\r\n  cursor:'pointer',\r\n  fontSize:11,\r\n  fontWeight:600,\r\n  lineHeight:1,\r\n  display:'inline-flex',\r\n  alignItems:'center',\r\n  transition:'all .15s ease',\r\n});\r\n\r\nconst integratedButton = (isDarkMode: boolean, positive: boolean): React.CSSProperties => ({\r\n  padding:'8px 10px',\r\n  margin:'2px',\r\n  border:'none',\r\n  background: positive \r\n    ? (isDarkMode \r\n      ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n      : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)')\r\n    : (isDarkMode \r\n      ? 'linear-gradient(135deg, rgba(148, 163, 184, 0.12) 0%, rgba(203, 213, 225, 0.08) 100%)'\r\n      : 'linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(226, 232, 240, 0.6) 100%)'),\r\n  color: positive \r\n    ? (isDarkMode ? '#60A5FA' : '#3690CE') \r\n    : (isDarkMode ? '#E0F2FE' : '#0F172A'),\r\n  borderRadius:8,\r\n  cursor:'pointer',\r\n  fontSize:12,\r\n  fontWeight:600,\r\n  lineHeight:1,\r\n  display:'inline-flex',\r\n  alignItems:'center',\r\n  transition:'all .2s ease',\r\n  boxShadow: isDarkMode \r\n    ? '0 2px 4px rgba(4, 9, 20, 0.3)' \r\n    : '0 1px 3px rgba(13, 47, 96, 0.08)'\r\n});\r\n\r\nconst labelStyle = (col:string): React.CSSProperties => ({ fontSize:13, fontWeight:600, color:col });\r\nconst valueStyle = (col:string): React.CSSProperties => ({ fontSize:15, fontWeight:600, color:col, textAlign:'right' });\r\n\r\nexport default DealCapture;\r\n","// Minimal, code-defined scenarios for quick compose\r\n// Keep content plain text for best Outlook compatibility; placeholders rIn terms of costs I am a [ROLE] and my hourly rate is [RATE]. We charge on a time recorded basis in 6minute units for all steps and work including emails in and out and telephone attendances. Here I have advised that you will need to budget [INSERT] for an initial review and advice. This is an estimate and not a fixed fee, but my hope and expectation is that at this stage you will be clear on where you stand. We can then discuss next steps at that stage. Further work will incur additional cost.main [TOKEN]\r\n\r\n/**\r\n * Version token that changes whenever this module content is actually modified.\r\n * Import this in consumers and use it in a useEffect dependency to refresh\r\n * any local state derived from these scenarios without requiring a manual remount.\r\n * Only increment this manually when you change the scenarios content.\r\n */\r\nexport const SCENARIOS_VERSION: number = 3;\r\n\r\nexport type Scenario = {\r\n  /** Stable id for persistence */\r\n  id: string;\r\n  /** Short display name for the button */\r\n  name: string;\r\n  /** Email subject line */\r\n  subject: string;\r\n  /** Email body (plain text, may include [TOKENS]) */\r\n  body: string;\r\n};\r\n\r\n/**\r\n * Scenario presets used by the Pitch Builder.\r\n * Subheadings have been removed; subtle separators (— — —) are used for readability.\r\n */\r\nexport const SCENARIOS: Scenario[] = [\r\n  {\r\n    id: 'before-call-call',\r\n    name: 'Before call — Call',\r\n    subject: 'Pitch before call — Call',\r\n  body: `Thank you for your enquiry to Helix Law. I have set out below some details that I hope help in relation to your enquiry. We’re a specialist firm of solicitors and we only deal with litigation and disputes. We act nationally.\r\n\r\nWe often deal with disputes such as yours and I am confident we are well-placed to assist in relation to your matter.\r\n\r\nPlease let me know if you’re available for a call. The easiest way to schedule this is via the following link [Calendly]\r\n\r\nIn advance of the call it would be helpful if you can share with me [INSERT]\r\n\r\nTransparently we charge for our time on an hourly rate basis. My hourly rate is [RATE] as a [ROLE]. There is no cost or obligation at this stage including for the call above. During the call I will try to give you an initial informal steer on your current position, next steps and costs and we can take it from there.\r\n\r\nI look forward to speaking with you.`\r\n  },\r\n  {\r\n    id: 'before-call-no-call',\r\n    name: 'Before call — No call',\r\n    subject: 'Pitch before call — No call',\r\n  body: `Thank you for your enquiry to Helix Law. We’re a specialist firm of solicitors and we only deal with litigation and disputes. We act nationally. Before taking things further it is obviously incredibly important that you consider cost; benefit, and that it stacks up for you and for us for you to incur legal costs. With this in mind I have set out below some details that I hope help in relation to your enquiry so that you make a decision before we go ahead with a call or a paid review and advice.\r\n\r\nWe haven’t yet spoken but I have reviewed the details and information you have helpfully provided, thank you. You appear to be in a dispute with [INSERT] relating to [INSERT] and you have confirmed that [INSERT].\r\n\r\nThe dispute with [INSERT] creates difficulty for obvious reasons and you have asked [INSERT].\r\n\r\nIn addition to the above you should also consider [INSERT] as an additional aspect to keep in mind.\r\n\r\nMy immediate informal view is that your best next steps are likely to be [INSERT] but transparently I need to spend time reviewing your position and advising you on your current position and best next steps.\r\n\r\nTransparently we charge for our time on an hourly rate basis. My hourly rate is [RATE] as a [ROLE]. Here you will need to budget [INSERT] for an initial review and advice, including a telephone conference to discuss your matter. This is an estimate and not a fixed fee, and I will confirm this when I have received all your documents and information. During the call I will try to give you an initial informal steer on your current position, next steps and costs and we can take it from there.\r\n\r\nIf you wish to go ahead please send me core documents such as [INSERT the contracts, notices, demands, accounts, relevant correspondence set out below] so that we can be as clear as possible on the factual position. I then anticipate confirming my advice on your best next steps.\r\n\r\nTo confirm our instructions please click [InstructLink]. This single link will verify your identity, request core documents and allow you to pay our funds on account.\r\n\r\nAs soon as you have completed this step we will be able to open a file and move this forward immediately. A retainer will be created with us when we send you our Client Care Letter in due course and it is only at that point that your instructions will be confirmed.\r\n\r\nI hope the above is helpful and look forward to assisting you with this.`\r\n  },\r\n  {\r\n    id: 'after-call-probably-cant-assist',\r\n    name: 'After call — Probably can’t assist',\r\n    subject: 'Pitch after call — Probably can’t assist',\r\n    body: `Thank you for your enquiry and for your time on the phone earlier. It was good speaking with you.\r\n\r\nThe purpose of this email is to briefly follow up on our conversation which I hope you found useful.\r\n\r\nWe discussed that you are [INSERT]. You have a dispute with [INSERT] because [INSERT] and have confirmed that [INSERT].\r\n\r\nThe dispute with [INSERT] creates difficulty for you for obvious reasons, including because [INSERT].\r\n\r\nOne approach you might now consider taking is [INSERT]. This might be a cost effective way for you to now proceed.\r\n\r\nFor reasons we discussed in our call now may not be an appropriate time for you to instruct us but I have set out further details below in case you want to proceed. You should always keep in mind the cost; benefit, proportionality and timing of instructing us and incurring costs. For our part we are happy to assist you but transparently we charge for our work and time. I am a [ROLE] and my hourly rate is [RATE]. In terms of an initial review and advice you will need to budget [INSERT] which is a cost estimate and not a fixed fee. Further steps and time will incur additional cost.\r\n\r\nIf you wish to confirm our instructions notwithstanding the above please confirm your instructions by clicking [InstructLink]. This link will verify your identity, enable you to provide key documents and provide funds on account of costs in a quick and straightforward process.\r\n\r\nOn receipt of the above from you I will review the position and will confirm our cost estimate and we will then open a file and take it from there.\r\n\r\nI hope the above [and our call] is useful and of course come back to me if I can help you further.\r\n\r\nIn the meantime, I’m wondering if you can help me by providing a brief positive Google review of me and Helix Law. We’re a small but specialist team, and this would make a huge difference to us.\r\n\r\nIf you don’t mind, please can you give us a brief 5* positive review at the following link:\r\n\r\nhttp://bit.ly/2gGwyNJ\r\n\r\nYou will need to be signed into Google.\r\n\r\nMany thanks in advance.`\r\n  },\r\n  {\r\n    id: 'after-call-want-instruction',\r\n    name: 'After call — Want the instruction',\r\n    subject: 'Pitch after call — Want the instruction',\r\n    body: `Thank you for your enquiry and for your time on the phone earlier. It was good speaking with you.\r\n\r\nThe purpose of this email is to briefly follow up on our conversation which I hope you found useful. I’d love to assist you with this and consider we’re well placed to do so. Don’t hesitate to contact me if you have any queries, otherwise I have set out next steps below to assist you.\r\n\r\nWe have discussed that you are [INSERT]. You have a dispute with [INSERT] because [INSERT] and have confirmed that [INSERT].\r\n\r\nThe dispute with [INSERT] situation creates difficulty for you for obvious reasons, including because [INSERT].\r\n\r\nThere are further potential problems and issues arising from the above that may need to be considered and addressed, such as [INSERT]. I will consider that further with you, within my review and advice.\r\n\r\nIn terms of most appropriate next steps clearly there is some complexity here and we have discussed that I need to formally review and advise on the background, your current position and your best next steps.\r\n\r\nIdeally it would be helpful if you can please provide core documents including [INSERT the contracts, notices, demands, accounts, relevant correspondence set out below] so that I can understand what has happened to date as quickly as possible.\r\n\r\nIn terms of costs, we record and bill for our time in 6-minute units, so one hour is 10 units. We charge for all steps and work, including emails in and out, and telephone calls. Partners record and bill at £395+VAT per hour, Associate Solicitors at £325 per hour, Solicitors at £285+VAT per hour, and Trainee Solicitors and Paralegals at £195+VAT per hour. Here, for the initial review and advice, you will need to budget in the region of approximately [INSERT]+VAT. This is an estimate and not a fixed fee, but my hope and expectation is that at this stage, you will be clear on where you stand. We can then discuss the next steps at that stage. Further work will incur additional cost.\r\n\r\nPlease confirm your instructions by clicking [InstructLink]. This single link will allow you to verify your identity, provide the key documents needed and provide funds on account of costs in a quick and transparent checkout process.\r\n\r\nOnce provided I will briefly review this to confirm our time and cost estimate is accurate and we will then open a file. At that stage you will receive our Client Care Letter formally confirming the terms of our retainer.\r\n\r\nI hope the above and our call have been useful and of course come back to me if I can help you further. I look forward to assisting you with this.`\r\n  }\r\n];\r\n","import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { \r\n  FaBold, \r\n  FaItalic, \r\n  FaUnderline, \r\n  FaStrikethrough,\r\n  FaListUl, \r\n  FaListOl, \r\n  FaIndent, \r\n  FaOutdent,\r\n  FaAlignLeft,\r\n  FaAlignCenter,\r\n  FaAlignRight,\r\n  FaLink,\r\n  FaUnlink,\r\n  FaTextHeight,\r\n  FaPalette,\r\n  FaHighlighter,\r\n  FaEraser,\r\n  FaUndo,\r\n  FaRedo,\r\n  FaFont\r\n} from 'react-icons/fa';\r\nimport { colours } from '../../../app/styles/colours';\r\n\r\ninterface FormattingToolbarProps {\r\n  isDarkMode: boolean;\r\n  onFormatChange?: (command: string, value?: string) => void;\r\n  editorRef?: React.RefObject<HTMLElement>;\r\n  className?: string;\r\n  style?: React.CSSProperties;\r\n}\r\n\r\ninterface FormatState {\r\n  bold: boolean;\r\n  italic: boolean;\r\n  underline: boolean;\r\n  strikethrough: boolean;\r\n  insertUnorderedList: boolean;\r\n  insertOrderedList: boolean;\r\n  justifyLeft: boolean;\r\n  justifyCenter: boolean;\r\n  justifyRight: boolean;\r\n}\r\n\r\nconst FormattingToolbar: React.FC<FormattingToolbarProps> = ({\r\n  isDarkMode,\r\n  onFormatChange,\r\n  editorRef,\r\n  className,\r\n  style\r\n}) => {\r\n  const [formatState, setFormatState] = useState<FormatState>({\r\n    bold: false,\r\n    italic: false,\r\n    underline: false,\r\n    strikethrough: false,\r\n    insertUnorderedList: false,\r\n    insertOrderedList: false,\r\n    justifyLeft: true,\r\n    justifyCenter: false,\r\n    justifyRight: false\r\n  });\r\n\r\n  const [showColorPicker, setShowColorPicker] = useState(false);\r\n  const [showHighlightPicker, setShowHighlightPicker] = useState(false);\r\n  const [fontSize, setFontSize] = useState('14');\r\n  const colorPickerRef = useRef<HTMLDivElement>(null);\r\n  const highlightPickerRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Common colors for text and highlighting\r\n  const textColors = [\r\n    '#000000', '#333333', '#666666', '#999999',\r\n    '#D65541', '#3690CE', '#4CAF50', '#FF9800',\r\n    '#9C27B0', '#E91E63', '#2196F3', '#00BCD4'\r\n  ];\r\n\r\n  const highlightColors = [\r\n    'transparent', '#FFEB3B', '#FFC107', '#FF9800',\r\n    '#F44336', '#E91E63', '#9C27B0', '#673AB7',\r\n    '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4',\r\n    '#009688', '#4CAF50', '#8BC34A', '#CDDC39'\r\n  ];\r\n\r\n  // Update format state based on current selection\r\n  const updateFormatState = useCallback(() => {\r\n    try {\r\n      setFormatState({\r\n        bold: document.queryCommandState('bold'),\r\n        italic: document.queryCommandState('italic'),\r\n        underline: document.queryCommandState('underline'),\r\n        strikethrough: document.queryCommandState('strikeThrough'),\r\n        insertUnorderedList: document.queryCommandState('insertUnorderedList'),\r\n        insertOrderedList: document.queryCommandState('insertOrderedList'),\r\n        justifyLeft: document.queryCommandState('justifyLeft'),\r\n        justifyCenter: document.queryCommandState('justifyCenter'),\r\n        justifyRight: document.queryCommandState('justifyRight')\r\n      });\r\n    } catch (error) {\r\n      console.warn('Failed to update format state:', error);\r\n    }\r\n  }, []);\r\n\r\n  // Execute formatting command with email-safe implementation\r\n  const executeCommand = useCallback((command: string, value?: string) => {\r\n    try {\r\n      // Focus the editor first\r\n      if (editorRef?.current) {\r\n        editorRef.current.focus();\r\n      }\r\n\r\n      // Use the callback provided by parent component\r\n      if (onFormatChange) {\r\n        onFormatChange(command, value);\r\n        updateFormatState();\r\n        return true;\r\n      }\r\n\r\n      // Fallback to direct execution if no callback provided\r\n      let success = false;\r\n      \r\n      // Special handling for certain commands to ensure email compatibility\r\n      switch (command) {\r\n        case 'bold':\r\n        case 'italic':\r\n        case 'underline':\r\n        case 'strikeThrough':\r\n          success = document.execCommand(command, false, undefined);\r\n          break;\r\n          \r\n        case 'insertUnorderedList':\r\n        case 'insertOrderedList':\r\n          success = document.execCommand(command, false, undefined);\r\n          break;\r\n          \r\n        case 'justifyLeft':\r\n        case 'justifyCenter':\r\n        case 'justifyRight':\r\n          success = document.execCommand(command, false, undefined);\r\n          break;\r\n          \r\n        case 'foreColor':\r\n        case 'backColor':\r\n          success = document.execCommand(command, false, value);\r\n          break;\r\n          \r\n        case 'fontSize':\r\n          success = document.execCommand(command, false, value);\r\n          break;\r\n          \r\n        case 'createLink':\r\n          const url = value || prompt('Enter URL:');\r\n          if (url) {\r\n            success = document.execCommand('createLink', false, url);\r\n          }\r\n          break;\r\n          \r\n        case 'unlink':\r\n          success = document.execCommand('unlink', false, undefined);\r\n          break;\r\n          \r\n        case 'undo':\r\n        case 'redo':\r\n          success = document.execCommand(command, false, undefined);\r\n          break;\r\n          \r\n        case 'removeFormat':\r\n          success = document.execCommand('removeFormat', false, undefined);\r\n          break;\r\n          \r\n        default:\r\n          success = document.execCommand(command, false, value);\r\n      }\r\n\r\n      if (success) {\r\n        updateFormatState();\r\n      }\r\n\r\n      return success;\r\n    } catch (error) {\r\n      console.warn(`Failed to execute command ${command}:`, error);\r\n      return false;\r\n    }\r\n  }, [editorRef, onFormatChange, updateFormatState]);\r\n\r\n  // Handle keyboard shortcuts\r\n  useEffect(() => {\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (!editorRef?.current?.contains(e.target as Node)) return;\r\n\r\n      const { ctrlKey, metaKey, shiftKey, key } = e;\r\n      const cmdKey = ctrlKey || metaKey;\r\n\r\n      if (cmdKey) {\r\n        switch (key.toLowerCase()) {\r\n          case 'b':\r\n            e.preventDefault();\r\n            executeCommand('bold');\r\n            break;\r\n          case 'i':\r\n            e.preventDefault();\r\n            executeCommand('italic');\r\n            break;\r\n          case 'u':\r\n            e.preventDefault();\r\n            executeCommand('underline');\r\n            break;\r\n          case 'k':\r\n            e.preventDefault();\r\n            executeCommand('createLink');\r\n            break;\r\n          case 'z':\r\n            if (shiftKey) {\r\n              e.preventDefault();\r\n              executeCommand('redo');\r\n            } else {\r\n              e.preventDefault();\r\n              executeCommand('undo');\r\n            }\r\n            break;\r\n          case 'y':\r\n            e.preventDefault();\r\n            executeCommand('redo');\r\n            break;\r\n        }\r\n      }\r\n    };\r\n\r\n    document.addEventListener('keydown', handleKeyDown);\r\n    return () => document.removeEventListener('keydown', handleKeyDown);\r\n  }, [executeCommand, editorRef]);\r\n\r\n  // Update format state when selection changes\r\n  useEffect(() => {\r\n    const handleSelectionChange = () => {\r\n      if (document.activeElement === editorRef?.current) {\r\n        updateFormatState();\r\n      }\r\n    };\r\n\r\n    document.addEventListener('selectionchange', handleSelectionChange);\r\n    return () => document.removeEventListener('selectionchange', handleSelectionChange);\r\n  }, [updateFormatState, editorRef]);\r\n\r\n  // Close color pickers when clicking outside\r\n  useEffect(() => {\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (colorPickerRef.current && !colorPickerRef.current.contains(event.target as Node)) {\r\n        setShowColorPicker(false);\r\n      }\r\n      if (highlightPickerRef.current && !highlightPickerRef.current.contains(event.target as Node)) {\r\n        setShowHighlightPicker(false);\r\n      }\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    return () => document.removeEventListener('mousedown', handleClickOutside);\r\n  }, []);\r\n\r\n  const buttonStyle = (isActive: boolean = false) => ({\r\n    padding: '6px 8px',\r\n    border: 'none',\r\n    borderRadius: '4px',\r\n    backgroundColor: isActive \r\n      ? (isDarkMode ? colours.highlight : '#e3f2fd')\r\n      : 'transparent',\r\n    color: isDarkMode ? colours.dark.text : '#333',\r\n    cursor: 'pointer',\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    fontSize: '14px',\r\n    transition: 'all 0.2s ease',\r\n    position: 'relative' as const\r\n  });\r\n\r\n  const separatorStyle = {\r\n    width: '1px',\r\n    height: '24px',\r\n    backgroundColor: isDarkMode ? colours.dark.border : '#e1e5e9',\r\n    margin: '0 4px'\r\n  };\r\n\r\n  const dropdownStyle = {\r\n    position: 'absolute' as const,\r\n    top: '100%',\r\n    left: '0',\r\n    backgroundColor: isDarkMode ? colours.dark.cardBackground : '#fff',\r\n    border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e5e9'}`,\r\n    borderRadius: '4px',\r\n    padding: '8px',\r\n    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',\r\n    zIndex: 1000,\r\n    display: 'grid',\r\n    gridTemplateColumns: 'repeat(4, 1fr)',\r\n    gap: '4px',\r\n    minWidth: '120px'\r\n  };\r\n\r\n  return (\r\n    <div \r\n      className={className}\r\n      style={{\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        gap: '2px',\r\n        padding: '8px 12px',\r\n        backgroundColor: isDarkMode ? colours.dark.cardBackground : '#f8f9fa',\r\n        border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e5e9'}`,\r\n        borderRadius: '6px',\r\n        flexWrap: 'wrap',\r\n        ...style\r\n      }}\r\n    >\r\n      {/* Text Formatting */}\r\n      <button\r\n        style={buttonStyle(formatState.bold)}\r\n        onClick={() => executeCommand('bold')}\r\n        title=\"Bold (Ctrl+B)\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.bold ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaBold />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle(formatState.italic)}\r\n        onClick={() => executeCommand('italic')}\r\n        title=\"Italic (Ctrl+I)\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.italic ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaItalic />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle(formatState.underline)}\r\n        onClick={() => executeCommand('underline')}\r\n        title=\"Underline (Ctrl+U)\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.underline ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaUnderline />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle(formatState.strikethrough)}\r\n        onClick={() => executeCommand('strikeThrough')}\r\n        title=\"Strikethrough\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.strikethrough ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaStrikethrough />\r\n      </button>\r\n\r\n      <div style={separatorStyle} />\r\n\r\n      {/* Lists */}\r\n      <button\r\n        style={buttonStyle(formatState.insertUnorderedList)}\r\n        onClick={() => executeCommand('insertUnorderedList')}\r\n        title=\"Bullet List\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.insertUnorderedList ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaListUl />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle(formatState.insertOrderedList)}\r\n        onClick={() => executeCommand('insertOrderedList')}\r\n        title=\"Numbered List\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.insertOrderedList ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaListOl />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('outdent')}\r\n        title=\"Decrease Indent\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaOutdent />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('indent')}\r\n        title=\"Increase Indent\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaIndent />\r\n      </button>\r\n\r\n      <div style={separatorStyle} />\r\n\r\n      {/* Alignment */}\r\n      <button\r\n        style={buttonStyle(formatState.justifyLeft)}\r\n        onClick={() => executeCommand('justifyLeft')}\r\n        title=\"Align Left\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.justifyLeft ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaAlignLeft />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle(formatState.justifyCenter)}\r\n        onClick={() => executeCommand('justifyCenter')}\r\n        title=\"Align Center\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.justifyCenter ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaAlignCenter />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle(formatState.justifyRight)}\r\n        onClick={() => executeCommand('justifyRight')}\r\n        title=\"Align Right\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = formatState.justifyRight ? (isDarkMode ? colours.highlight : '#e3f2fd') : 'transparent'}\r\n      >\r\n        <FaAlignRight />\r\n      </button>\r\n\r\n      <div style={separatorStyle} />\r\n\r\n      {/* Font Size */}\r\n      <select\r\n        value={fontSize}\r\n        onChange={(e) => {\r\n          setFontSize(e.target.value);\r\n          executeCommand('fontSize', e.target.value);\r\n        }}\r\n        style={{\r\n          padding: '4px 6px',\r\n          border: 'none',\r\n          borderRadius: '4px',\r\n          backgroundColor: isDarkMode ? colours.dark.inputBackground : '#fff',\r\n          color: isDarkMode ? colours.dark.text : '#333',\r\n          fontSize: '12px',\r\n          cursor: 'pointer'\r\n        }}\r\n        title=\"Font Size\"\r\n      >\r\n        <option value=\"1\">8pt</option>\r\n        <option value=\"2\">10pt</option>\r\n        <option value=\"3\">12pt</option>\r\n        <option value=\"4\">14pt</option>\r\n        <option value=\"5\">18pt</option>\r\n        <option value=\"6\">24pt</option>\r\n        <option value=\"7\">36pt</option>\r\n      </select>\r\n\r\n      {/* Text Color */}\r\n      <div style={{ position: 'relative' }} ref={colorPickerRef}>\r\n        <button\r\n          style={buttonStyle()}\r\n          onClick={() => {\r\n            setShowColorPicker(!showColorPicker);\r\n            setShowHighlightPicker(false);\r\n          }}\r\n          title=\"Text Color\"\r\n          onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n          onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n        >\r\n          <FaPalette />\r\n        </button>\r\n        {showColorPicker && (\r\n          <div style={dropdownStyle}>\r\n            {textColors.map((color) => (\r\n              <button\r\n                key={color}\r\n                style={{\r\n                  width: '20px',\r\n                  height: '20px',\r\n                  backgroundColor: color,\r\n                  border: '1px solid #ccc',\r\n                  borderRadius: '2px',\r\n                  cursor: 'pointer'\r\n                }}\r\n                onClick={() => {\r\n                  executeCommand('foreColor', color);\r\n                  setShowColorPicker(false);\r\n                }}\r\n                title={`Set text color to ${color}`}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Highlight Color */}\r\n      <div style={{ position: 'relative' }} ref={highlightPickerRef}>\r\n        <button\r\n          style={buttonStyle()}\r\n          onClick={() => {\r\n            setShowHighlightPicker(!showHighlightPicker);\r\n            setShowColorPicker(false);\r\n          }}\r\n          title=\"Highlight Color\"\r\n          onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n          onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n        >\r\n          <FaHighlighter />\r\n        </button>\r\n        {showHighlightPicker && (\r\n          <div style={dropdownStyle}>\r\n            {highlightColors.map((color) => (\r\n              <button\r\n                key={color}\r\n                style={{\r\n                  width: '20px',\r\n                  height: '20px',\r\n                  backgroundColor: color === 'transparent' ? '#fff' : color,\r\n                  border: '1px solid #ccc',\r\n                  borderRadius: '2px',\r\n                  cursor: 'pointer',\r\n                  position: 'relative'\r\n                }}\r\n                onClick={() => {\r\n                  executeCommand('backColor', color);\r\n                  setShowHighlightPicker(false);\r\n                }}\r\n                title={color === 'transparent' ? 'Remove highlight' : `Highlight with ${color}`}\r\n              >\r\n                {color === 'transparent' && (\r\n                  <div style={{\r\n                    position: 'absolute',\r\n                    top: '50%',\r\n                    left: '50%',\r\n                    transform: 'translate(-50%, -50%) rotate(45deg)',\r\n                    width: '2px',\r\n                    height: '16px',\r\n                    backgroundColor: '#f44336'\r\n                  }} />\r\n                )}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div style={separatorStyle} />\r\n\r\n      {/* Links */}\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('createLink')}\r\n        title=\"Insert Link (Ctrl+K)\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaLink />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('unlink')}\r\n        title=\"Remove Link\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaUnlink />\r\n      </button>\r\n\r\n      <div style={separatorStyle} />\r\n\r\n      {/* Clear Formatting */}\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('removeFormat')}\r\n        title=\"Clear Formatting\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaEraser />\r\n      </button>\r\n\r\n      <div style={separatorStyle} />\r\n\r\n      {/* Undo/Redo */}\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('undo')}\r\n        title=\"Undo (Ctrl+Z)\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaUndo />\r\n      </button>\r\n\r\n      <button\r\n        style={buttonStyle()}\r\n        onClick={() => executeCommand('redo')}\r\n        title=\"Redo (Ctrl+Y)\"\r\n        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = isDarkMode ? 'rgba(54, 144, 206, 0.2)' : '#f0f0f0'}\r\n        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\r\n      >\r\n        <FaRedo />\r\n      </button>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default FormattingToolbar;","/**\r\n * Development Email Processing Confirmation Dialog (minimal)\r\n *\r\n * Dev-only selector between V1 (production) and V2 (experimental).\r\n * In production, auto-confirms V1 and renders nothing.\r\n */\r\n\r\nimport React, { useEffect, useRef, useState } from 'react';\r\nimport { colours } from '../../../app/styles/colours';\r\n\r\ninterface EmailProcessingConfirmDialogProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onConfirm: (useV2: boolean) => void;\r\n  action: 'send' | 'draft';\r\n  isDarkMode?: boolean;\r\n}\r\n\r\nconst EmailProcessingConfirmDialog: React.FC<EmailProcessingConfirmDialogProps> = ({\r\n  isOpen,\r\n  onClose,\r\n  onConfirm,\r\n  action,\r\n  isDarkMode = false\r\n}) => {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n  const [selected, setSelected] = useState<'v1' | 'v2'>('v1');\r\n  const autoConfirmedRef = useRef(false);\r\n\r\n  // Auto-confirm in production (once per open)\r\n  useEffect(() => {\r\n    if (isOpen && !isDevelopment && !autoConfirmedRef.current) {\r\n      autoConfirmedRef.current = true;\r\n      onConfirm(false);\r\n    }\r\n    if (!isOpen) {\r\n      autoConfirmedRef.current = false;\r\n    }\r\n  }, [isOpen, isDevelopment, onConfirm]);\r\n\r\n  // Keyboard handling when open in development\r\n  useEffect(() => {\r\n    if (!isOpen || !isDevelopment) return;\r\n    const onKey = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') onClose();\r\n      if (e.key === 'Enter') onConfirm(selected === 'v2');\r\n    };\r\n    document.addEventListener('keydown', onKey);\r\n    return () => document.removeEventListener('keydown', onKey);\r\n  }, [isOpen, isDevelopment, onClose, onConfirm, selected]);\r\n\r\n  if (!isOpen) return null;\r\n  // In production, UI is suppressed; effect above handles confirmation\r\n  if (!isDevelopment) return null;\r\n\r\n  const actionText = action === 'send' ? 'Send Email' : 'Draft Email';\r\n\r\n  return (\r\n    <div style={{\r\n      position: 'fixed',\r\n      top: 0,\r\n      left: 0,\r\n      right: 0,\r\n      bottom: 0,\r\n      backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      zIndex: 10000,\r\n      backdropFilter: 'blur(4px)'\r\n    }}>\r\n      <div style={{\r\n        backgroundColor: isDarkMode ? '#1F2937' : '#FFFFFF',\r\n        borderRadius: 12,\r\n        padding: 20,\r\n        maxWidth: 520,\r\n        width: '92%',\r\n        boxShadow: '0 12px 24px rgba(0,0,0,0.25)',\r\n        border: `1px solid ${isDarkMode ? '#374151' : '#E5E7EB'}`\r\n      }}>\r\n        {/* Header */}\r\n        <div style={{ marginBottom: 12 }}>\r\n          <h3 style={{\r\n            margin: 0,\r\n            fontSize: 18,\r\n            fontWeight: 700,\r\n            color: isDarkMode ? '#F9FAFB' : '#111827'\r\n          }}>\r\n            {actionText}: Processing Method\r\n          </h3>\r\n          <p style={{\r\n            margin: '6px 0 0 0',\r\n            color: isDarkMode ? '#94A3B8' : '#6B7280',\r\n            fontSize: 13\r\n          }}>\r\n            Dev-only selection. Production uses V1 automatically.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Options (radio) */}\r\n        <div role=\"radiogroup\" aria-label=\"Email processing method\" style={{\r\n          display: 'grid',\r\n          gap: 10,\r\n          marginTop: 12,\r\n          marginBottom: 16\r\n        }}>\r\n          <label style={{\r\n            display: 'flex',\r\n            alignItems: 'flex-start',\r\n            gap: 10,\r\n            padding: 10,\r\n            border: `1px solid ${selected === 'v1' \r\n              ? (isDarkMode ? colours.dark.highlight : colours.highlight)\r\n              : (isDarkMode ? colours.dark.border : colours.light.border)}`,\r\n            borderRadius: 8,\r\n            background: isDarkMode ? '#111827' : '#FFFFFF',\r\n            cursor: 'pointer'\r\n          }}>\r\n            <input\r\n              type=\"radio\"\r\n              name=\"email-processing\"\r\n              checked={selected === 'v1'}\r\n              onChange={() => setSelected('v1')}\r\n              style={{ marginTop: 2 }}\r\n            />\r\n            <div>\r\n              <div style={{ fontWeight: 600, color: isDarkMode ? '#E5E7EB' : '#111827' }}>Use V1 (Production)</div>\r\n              <div style={{ fontSize: 12, color: isDarkMode ? '#94A3B8' : '#6B7280' }}>Stable, current production method</div>\r\n            </div>\r\n          </label>\r\n          <label style={{\r\n            display: 'flex',\r\n            alignItems: 'flex-start',\r\n            gap: 10,\r\n            padding: 10,\r\n            border: `1px solid ${selected === 'v2' \r\n              ? (isDarkMode ? colours.dark.highlight : colours.highlight)\r\n              : (isDarkMode ? colours.dark.border : colours.light.border)}`,\r\n            borderRadius: 8,\r\n            background: isDarkMode ? '#111827' : '#FFFFFF',\r\n            cursor: 'pointer'\r\n          }}>\r\n            <input\r\n              type=\"radio\"\r\n              name=\"email-processing\"\r\n              checked={selected === 'v2'}\r\n              onChange={() => setSelected('v2')}\r\n              style={{ marginTop: 2 }}\r\n            />\r\n            <div>\r\n              <div style={{ fontWeight: 600, color: isDarkMode ? '#E5E7EB' : '#111827' }}>Use V2 (Experimental)</div>\r\n              <div style={{ fontSize: 12, color: isDarkMode ? '#94A3B8' : '#6B7280' }}>Improved formatting under active test</div>\r\n            </div>\r\n          </label>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <div style={{ display: 'flex', justifyContent: 'flex-end', gap: 8, marginTop: 8 }}>\r\n          <button\r\n            onClick={onClose}\r\n            style={{\r\n              padding: '8px 14px',\r\n              borderRadius: 6,\r\n              border: `1px solid ${isDarkMode ? colours.dark.border : colours.light.border}`,\r\n              background: 'transparent',\r\n              color: isDarkMode ? colours.dark.text : colours.light.text,\r\n              cursor: 'pointer',\r\n              fontSize: 14\r\n            }}\r\n          >\r\n            Cancel\r\n          </button>\r\n          <button\r\n            onClick={() => onConfirm(selected === 'v2')}\r\n            style={{\r\n              padding: '8px 14px',\r\n              borderRadius: 6,\r\n              border: 'none',\r\n              background: isDarkMode ? colours.dark.buttonBackground : colours.light.buttonBackground,\r\n              color: '#FFFFFF',\r\n              cursor: 'pointer',\r\n              fontSize: 14,\r\n              fontWeight: 600\r\n            }}\r\n          >\r\n            Continue\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EmailProcessingConfirmDialog;","import React, { useState, useRef, useEffect, useCallback, useLayoutEffect } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { Stack, Text, Icon, Pivot, PivotItem, TextField } from '@fluentui/react';\r\nimport { FaBolt, FaEdit, FaFileAlt, FaEraser, FaInfoCircle, FaThumbtack, FaCalculator, FaExclamationTriangle, FaEnvelope, FaPaperPlane, FaChevronDown, FaChevronUp, FaCopy, FaEye, FaCheck, FaTimes, FaUsers } from 'react-icons/fa';\r\nimport DealCapture from './DealCapture';\r\nimport { colours } from '../../../app/styles/colours';\r\nimport { TemplateBlock } from '../../../app/customisation/ProductionTemplateBlocks';\r\nimport SnippetEditPopover from './SnippetEditPopover';\r\nimport { placeholderSuggestions } from '../../../app/customisation/InsertSuggestions';\r\nimport { wrapInsertPlaceholders } from './emailUtils';\r\nimport { SCENARIOS, SCENARIOS_VERSION } from './scenarios';\r\nimport EmailSignature from '../EmailSignature';\r\nimport { applyDynamicSubstitutions, convertDoubleBreaksToParagraphs } from './emailUtils';\r\nimport FormattingToolbar from './FormattingToolbar';\r\nimport { processEditorContentForEmail, KEYBOARD_SHORTCUTS, type FormattingCommand } from './emailFormattingUtils';\r\nimport EmailProcessingConfirmDialog from './EmailProcessingConfirmDialog';\r\nimport markUrl from '../../../assets/dark blue mark.svg';\r\n// Import tab bg image directly for debugging\r\nconst tabBgUrl = require('../../../assets/tab bg.jpg');\r\n\r\n// Enterprise-grade subtle animations for professional appearance\r\nconst animationStyles = `\r\n@keyframes spin {\r\n  from { transform: rotate(0deg); }\r\n  to { transform: rotate(360deg); }\r\n}\r\n\r\n@keyframes subtlePulse {\r\n  0%, 100% { \r\n    opacity: 1;\r\n    transform: scale(1); \r\n  }\r\n  50% { \r\n    opacity: 0.85;\r\n    transform: scale(1.01); \r\n  }\r\n}\r\n\r\n@keyframes smoothCheck {\r\n  0% { \r\n    opacity: 0;\r\n    transform: scale(0.9);\r\n  }\r\n  60% { \r\n    opacity: 0.8;\r\n    transform: scale(1.05);\r\n  }\r\n  100% { \r\n    opacity: 1;\r\n    transform: scale(1);\r\n  }\r\n}\r\n\r\n@keyframes gentleFloat {\r\n  0%, 100% { \r\n    transform: translateY(0px);\r\n  }\r\n  50% { \r\n    transform: translateY(-1px);\r\n  }\r\n}\r\n\r\n@keyframes fadeIn {\r\n  from { \r\n    opacity: 0; \r\n    transform: translateY(4px); \r\n  }\r\n  to { \r\n    opacity: 1; \r\n    transform: translateY(0); \r\n  }\r\n}\r\n\r\n@keyframes subtleShake {\r\n  0%, 100% { transform: translateX(0); }\r\n  25% { transform: translateX(-1px); }\r\n  75% { transform: translateX(1px); }\r\n}\r\n\r\n@keyframes slideUp {\r\n  from { \r\n    opacity: 0; \r\n    transform: translateY(8px); \r\n  }\r\n  to { \r\n    opacity: 1; \r\n    transform: translateY(0); \r\n  }\r\n}\r\n\r\n@keyframes softGlow {\r\n  0%, 100% { \r\n    opacity: 1;\r\n  }\r\n  50% { \r\n    opacity: 0.9;\r\n  }\r\n}\r\n\r\n@keyframes radio-check {\r\n  from { \r\n    opacity: 0; \r\n    transform: scale(0.8); \r\n  }\r\n  to { \r\n    opacity: 1; \r\n    transform: scale(1); \r\n  }\r\n}\r\n`;\r\n\r\n// Inject animations into head\r\nif (typeof document !== 'undefined' && !document.getElementById('processing-animations')) {\r\n  const style = document.createElement('style');\r\n  style.id = 'processing-animations';\r\n  style.textContent = animationStyles;\r\n  document.head.appendChild(style);\r\n}\r\n\r\n// NOTE: renderWithPlaceholders was removed; we use a simple highlighter overlay instead.\r\n// Escape HTML for safe injection in the overlay layer\r\nfunction escapeHtml(str: string) {\r\n  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\r\n}\r\n\r\n// Remove visual divider lines made of dashes from text (used to hide auto-block separators in previews)\r\nfunction stripDashDividers(text: string): string {\r\n  return text\r\n    .split('\\n')\r\n    .filter((line) => !/^\\s*[-–—]{3,}\\s*$/.test(line))\r\n    .join('\\n');\r\n}\r\n\r\n// Convert very basic HTML to plain text for textarea defaults and copy actions\r\nfunction htmlToPlainText(html: string): string {\r\n  const withBreaks = html\r\n    .replace(/\\r\\n/g, '\\n')\r\n    .replace(/<br\\s*\\/?>(\\s*)/gi, '\\n')\r\n    .replace(/<\\/(p|div)>/gi, '\\n')\r\n    .replace(/<li[^>]*>/gi, '- ')\r\n    .replace(/<\\/(ul|ol)>/gi, '\\n');\r\n  const withoutTags = withBreaks.replace(/<[^>]+>/g, '');\r\n  return withoutTags\r\n    .replace(/&nbsp;/g, ' ')\r\n    .replace(/&amp;/g, '&')\r\n    .replace(/&lt;/g, '<')\r\n    .replace(/&gt;/g, '>')\r\n    .replace(/\\n{3,}/g, '\\n\\n')\r\n    .trim();\r\n}\r\n\r\n// Removed local fallback passcode generation: must use ONLY server-issued passcode.\r\n\r\n// Find placeholder tokens like [TOKEN] but only in TEXT NODES (avoid attributes)\r\nfunction findPlaceholders(text: string): string[] {\r\n  const container = document.createElement('div');\r\n  container.innerHTML = text;\r\n  const results: string[] = [];\r\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\r\n  let node: Node | null;\r\n  while ((node = walker.nextNode())) {\r\n    const value = (node.nodeValue || '');\r\n    const matches = value.match(/\\[[^\\]]+\\]/g);\r\n    if (matches) results.push(...matches);\r\n  }\r\n  return results;\r\n}\r\n\r\n// Safely wrap placeholders in preview by operating on TEXT NODES only and\r\n// stripping editor-only attributes/styles so nothing leaks into the preview.\r\nfunction highlightPlaceholdersHtml(html: string): string {\r\n  const container = document.createElement('div');\r\n  container.innerHTML = html;\r\n\r\n  // 1) Strip editor-only attributes/styles and normalize existing placeholder wrappers\r\n  container.querySelectorAll('[contenteditable], [tabindex], [role=\"button\"]').forEach((el) => {\r\n    el.removeAttribute('contenteditable');\r\n    el.removeAttribute('tabindex');\r\n    if (el.getAttribute('role') === 'button') el.removeAttribute('role');\r\n  });\r\n\r\n  container.querySelectorAll('.insert-placeholder, .placeholder-edited, [data-insert], [data-placeholder]').forEach((el) => {\r\n    // Remove inline styles so preview styling comes from CSS\r\n    (el as HTMLElement).removeAttribute('style');\r\n    el.removeAttribute('data-original');\r\n    el.removeAttribute('data-insert');\r\n    el.removeAttribute('data-placeholder');\r\n    const txt = el.textContent || '';\r\n    if (/^\\[[^\\]]+\\]$/.test(txt.trim())) {\r\n      // Unresolved placeholder → mark as CTA red\r\n      (el as HTMLElement).className = 'placeholder-unresolved';\r\n    } else {\r\n      // Satisfied placeholder → unwrap to plain text\r\n      const textNode = document.createTextNode(txt);\r\n      el.parentNode?.replaceChild(textNode, el);\r\n    }\r\n  });\r\n\r\n  // 2) Walk text nodes and wrap [TOKEN] occurrences with <span class=\"insert-placeholder\">\r\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\r\n  const textNodes: Text[] = [];\r\n  let t: Node | null;\r\n  while ((t = walker.nextNode())) {\r\n    // Collect first; we'll mutate after to avoid breaking traversal\r\n    textNodes.push(t as Text);\r\n  }\r\n\r\n  const tokenRe = /\\[[^\\]]+\\]/g;\r\n  for (const node of textNodes) {\r\n    const value = node.nodeValue || '';\r\n    if (!tokenRe.test(value)) continue;\r\n\r\n    const parts = value.split(/(\\[[^\\]]+\\])/g);\r\n    const frag = document.createDocumentFragment();\r\n    for (const part of parts) {\r\n      if (!part) continue;\r\n      if (part.startsWith('[') && part.endsWith(']')) {\r\n        const span = document.createElement('span');\r\n        span.className = 'placeholder-unresolved';\r\n        span.textContent = part; // keep literal token text\r\n        frag.appendChild(span);\r\n      } else {\r\n        frag.appendChild(document.createTextNode(part));\r\n      }\r\n    }\r\n    node.parentNode?.replaceChild(frag, node);\r\n  }\r\n\r\n  return container.innerHTML;\r\n}\r\n\r\n// Custom hook: auto-insert [RATE] and [ROLE] values and report inserted ranges\r\nfunction useAutoInsertRateRole(\r\n  body: string,\r\n  setBody: (v: string) => void,\r\n  userData?: any,\r\n  setExternalHighlights?: (ranges: { start: number; end: number }[]) => void\r\n) {\r\n  const lastAppliedKeyRef = useRef<string>('');\r\n  const lastProcessedBodyRef = useRef<string>('');\r\n\r\n  useEffect(() => {\r\n    const roleRaw = userData?.[0]?.['Role'];\r\n    const rateRaw = userData?.[0]?.['Rate'];\r\n\r\n    const roleStr = roleRaw == null ? '' : String(roleRaw).trim();\r\n    const parseRate = (val: unknown): number | null => {\r\n      if (val == null) return null;\r\n      if (typeof val === 'number') return isFinite(val) ? val : null;\r\n      const cleaned = String(val).replace(/[^0-9.\\-]/g, '').trim();\r\n      if (!cleaned) return null;\r\n      const n = Number(cleaned);\r\n      return isFinite(n) ? n : null;\r\n    };\r\n    const rateNumber = parseRate(rateRaw);\r\n    const formatRateGBP = (n: number) =>\r\n      `£${n.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} + VAT`;\r\n\r\n    if (!body || (!roleStr && rateNumber == null)) {\r\n      // No changes; clear any prior transient highlights\r\n      setExternalHighlights?.([]);\r\n      return;\r\n    }\r\n\r\n    const key = `${roleStr}|${rateNumber ?? ''}|${body}`;\r\n    if (lastAppliedKeyRef.current === key && lastProcessedBodyRef.current) return;\r\n\r\n    const TOKEN_LEN = (t: 'RATE' | 'ROLE') => `[${t}]`.length;\r\n    let newBody = body;\r\n    const ranges: { start: number; end: number }[] = [];\r\n    const regex = /\\[(RATE|ROLE)\\]/gi;\r\n    let m: RegExpExecArray | null;\r\n    let shift = 0;\r\n\r\n    while ((m = regex.exec(body)) !== null) {\r\n      const token = (m[1] as string).toUpperCase() as 'RATE' | 'ROLE';\r\n      const originalStart = m.index;\r\n      const start = originalStart + shift;\r\n      const end = start + TOKEN_LEN(token);\r\n      let replacement: string | null = null;\r\n      if (token === 'RATE' && rateNumber != null) replacement = formatRateGBP(rateNumber);\r\n      else if (token === 'ROLE' && roleStr) replacement = roleStr;\r\n      if (replacement != null) {\r\n        newBody = newBody.slice(0, start) + replacement + newBody.slice(end);\r\n        ranges.push({ start, end: start + replacement.length });\r\n        shift += replacement.length - TOKEN_LEN(token);\r\n      }\r\n    }\r\n\r\n    if (newBody !== body) {\r\n      lastAppliedKeyRef.current = key;\r\n      lastProcessedBodyRef.current = newBody;\r\n      setBody(newBody);\r\n      if (ranges.length) setExternalHighlights?.(ranges);\r\n    } else {\r\n      lastAppliedKeyRef.current = key;\r\n      lastProcessedBodyRef.current = body;\r\n      if (ranges.length === 0) setExternalHighlights?.([]);\r\n    }\r\n  }, [body, userData, setBody, setExternalHighlights]);\r\n}\r\n\r\ninterface InlineEditableAreaProps {\r\n  value: string;\r\n  onChange: (v: string) => void;\r\n  edited: boolean;\r\n  minHeight?: number;\r\n  externalHighlights?: { start: number; end: number }[];\r\n  allReplacedRanges?: { start: number; end: number }[];\r\n  passcode?: string;\r\n  enquiry?: any;\r\n  isDarkMode?: boolean;\r\n  richTextMode?: boolean;\r\n  bodyEditorRef?: React.RefObject<HTMLDivElement>;\r\n  handleFormatCommand?: (command: string, value?: string) => void;\r\n}\r\n\r\ninterface UndoRedoState {\r\n  history: string[];\r\n  currentIndex: number;\r\n}\r\n\r\nconst InlineEditableArea: React.FC<InlineEditableAreaProps> = ({ \r\n  value, \r\n  onChange, \r\n  edited, \r\n  minHeight = 48, \r\n  externalHighlights, \r\n  allReplacedRanges, \r\n  passcode, \r\n  enquiry, \r\n  isDarkMode,\r\n  richTextMode,\r\n  bodyEditorRef,\r\n  handleFormatCommand\r\n}) => {\r\n  const taRef = useRef<HTMLTextAreaElement | null>(null);\r\n  const preRef = useRef<HTMLPreElement | null>(null);\r\n  const wrapperRef = useRef<HTMLDivElement | null>(null);\r\n  const [showToolbar, setShowToolbar] = useState(false);\r\n  const [undoRedoState, setUndoRedoState] = useState<UndoRedoState>({\r\n    history: [value],\r\n    currentIndex: 0\r\n  });\r\n  // Flag to distinguish internal programmatic updates from external prop changes\r\n  const internalUpdateRef = useRef(false);\r\n  const previousValueRef = useRef(value);\r\n  const [highlightRanges, setHighlightRanges] = useState<{ start: number; end: number }[]>([]); // green edited ranges (currently at most 1 active)\r\n  const replacingPlaceholderRef = useRef<{ start: number; end: number } | null>(null); // original placeholder bounds\r\n  const activeReplacementRangeRef = useRef<{ start: number; end: number } | null>(null); // growing inserted content\r\n  // Local synced copies of external highlights so we can shift them as user types\r\n  const [syncedExternalRanges, setSyncedExternalRanges] = useState<{ start: number; end: number }[]>([]);\r\n  const [syncedPersistentRanges, setSyncedPersistentRanges] = useState<{ start: number; end: number }[]>([]);\r\n\r\n  // Sync contentEditable content with value prop when in rich text mode\r\n  useEffect(() => {\r\n    if (richTextMode && bodyEditorRef?.current) {\r\n      // Only wrap placeholders if content doesn't already contain wrapped placeholders\r\n      const hasWrappedPlaceholders = value.includes('class=\"insert-placeholder\"');\r\n      const wrappedContent = hasWrappedPlaceholders ? value : wrapInsertPlaceholders(value);\r\n      // Only update if the content is different to avoid cursor jumping\r\n      if (bodyEditorRef.current.innerHTML !== wrappedContent) {\r\n        bodyEditorRef.current.innerHTML = wrappedContent;\r\n      }\r\n    }\r\n  }, [value, richTextMode]);\r\n\r\n  // Keep local copies in sync with props when they change from outside (e.g., auto-inserts)\r\n  useEffect(() => {\r\n    // Sync by reference change only to keep dependency array stable across renders\r\n    setSyncedExternalRanges((externalHighlights || []).slice());\r\n  }, [externalHighlights]);\r\n  useEffect(() => {\r\n    // Sync by reference change only to keep dependency array stable across renders\r\n    setSyncedPersistentRanges((allReplacedRanges || []).slice());\r\n  }, [allReplacedRanges]);\r\n\r\n  // Sync external value changes (e.g. selecting a different template or auto-inserted placeholders)\r\n  useEffect(() => {\r\n    // Only reset undo/redo state and highlights if this is NOT an internal update (i.e., not from user typing or undo/redo)\r\n    if (!internalUpdateRef.current) {\r\n      setUndoRedoState({ history: [value], currentIndex: 0 });\r\n      setHighlightRanges([]);\r\n      activeReplacementRangeRef.current = null;\r\n      replacingPlaceholderRef.current = null;\r\n      previousValueRef.current = value;\r\n    }\r\n    // Always clear the internal update flag after effect\r\n    internalUpdateRef.current = false;\r\n  }, [value]);\r\n\r\n  // Note: Do not globally reset internalUpdateRef here to avoid race conditions with the [value] sync effect.\r\n\r\n  // Auto resize\r\n  useEffect(() => {\r\n    const ta = taRef.current;\r\n    if (ta) {\r\n      ta.style.height = 'auto';\r\n      ta.style.height = ta.scrollHeight + 'px';\r\n    }\r\n  }, [value]);\r\n\r\n  // Sync computed textarea styles to the overlay <pre> so highlights align exactly\r\n  const syncPreStyles = useCallback(() => {\r\n    const ta = taRef.current;\r\n    const pre = preRef.current;\r\n    if (!ta || !pre) return;\r\n    try {\r\n      const s = window.getComputedStyle(ta);\r\n      const propsMap: { [k: string]: string } = {\r\n        fontFamily: 'font-family',\r\n        fontSize: 'font-size',\r\n        fontWeight: 'font-weight',\r\n        fontStyle: 'font-style',\r\n        lineHeight: 'line-height',\r\n        letterSpacing: 'letter-spacing',\r\n        paddingTop: 'padding-top',\r\n        paddingRight: 'padding-right',\r\n        paddingBottom: 'padding-bottom',\r\n        paddingLeft: 'padding-left',\r\n        boxSizing: 'box-sizing',\r\n        textRendering: 'text-rendering',\r\n        textTransform: 'text-transform'\r\n      };\r\n      Object.keys(propsMap).forEach((p) => {\r\n        const cssName = propsMap[p];\r\n        const val = s.getPropertyValue(cssName);\r\n        if (val) (pre.style as any)[p] = val;\r\n      });\r\n      // Ensure same white-space and wrapping behaviour\r\n      pre.style.whiteSpace = 'pre-wrap';\r\n      pre.style.wordBreak = 'break-word';\r\n    } catch (err) {\r\n      // swallow errors silently\r\n    }\r\n  }, []);\r\n\r\n  useLayoutEffect(() => {\r\n    syncPreStyles();\r\n  }, [value, syncPreStyles]);\r\n\r\n  useEffect(() => {\r\n    let raf = 0 as number | null;\r\n    const onResize = () => {\r\n      if (raf) cancelAnimationFrame(raf);\r\n      raf = requestAnimationFrame(() => syncPreStyles());\r\n    };\r\n    window.addEventListener('resize', onResize);\r\n\r\n    // Re-sync when web fonts finish loading\r\n    const fonts = (document as any).fonts;\r\n    const onFontsReady = () => syncPreStyles();\r\n    if (fonts && typeof fonts.ready !== 'undefined') {\r\n      // fonts.ready is a Promise\r\n      (fonts as any).ready.then(onFontsReady).catch(() => {});\r\n      try {\r\n        fonts.addEventListener && fonts.addEventListener('loadingdone', onFontsReady);\r\n      } catch {}\r\n    }\r\n\r\n    // ResizeObserver on wrapper to catch layout changes\r\n    let ro: ResizeObserver | null = null;\r\n    try {\r\n        if (wrapperRef.current && (window as any).ResizeObserver) {\r\n        ro = new (window as any).ResizeObserver(onResize);\r\n        if (ro && wrapperRef.current) ro.observe(wrapperRef.current);\r\n      }\r\n    } catch {}\r\n\r\n    return () => {\r\n      window.removeEventListener('resize', onResize);\r\n      try { fonts && fonts.removeEventListener && fonts.removeEventListener('loadingdone', onFontsReady); } catch {}\r\n      if (ro && wrapperRef.current) ro.disconnect();\r\n      if (raf) cancelAnimationFrame(raf);\r\n    };\r\n  }, [syncPreStyles]);\r\n\r\n  // Add to undo history (debounced)\r\n  const timeoutRef = useRef<NodeJS.Timeout>();\r\n  const addToHistory = (newValue: string) => {\r\n    if (timeoutRef.current) {\r\n      clearTimeout(timeoutRef.current);\r\n    }\r\n    timeoutRef.current = setTimeout(() => {\r\n      setUndoRedoState(prev => {\r\n        const currentValue = prev.history[prev.currentIndex];\r\n        if (currentValue === newValue) return prev;\r\n\r\n        const newHistory = prev.history.slice(0, prev.currentIndex + 1);\r\n        newHistory.push(newValue);\r\n        \r\n        // Limit history size\r\n        if (newHistory.length > 50) {\r\n          newHistory.shift();\r\n          return {\r\n            history: newHistory,\r\n            currentIndex: newHistory.length - 1\r\n          };\r\n        }\r\n        \r\n        return {\r\n          history: newHistory,\r\n          currentIndex: newHistory.length - 1\r\n        };\r\n      });\r\n    }, 300); // Reduced debounce for more responsive undo\r\n  };\r\n\r\n  // Cleanup pending debounce on unmount to avoid late updates overriding current input\r\n  useEffect(() => {\r\n    return () => {\r\n      if (timeoutRef.current) {\r\n        clearTimeout(timeoutRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // Undo function\r\n  const handleUndo = () => {\r\n    setUndoRedoState(prev => {\r\n      if (prev.currentIndex > 0) {\r\n        const newIndex = prev.currentIndex - 1;\r\n        const newValue = prev.history[newIndex];\r\n  internalUpdateRef.current = true;\r\n        onChange(newValue);\r\n        return {\r\n          ...prev,\r\n          currentIndex: newIndex\r\n        };\r\n      }\r\n      return prev;\r\n    });\r\n  };\r\n\r\n  // Redo function\r\n  const handleRedo = () => {\r\n    setUndoRedoState(prev => {\r\n      if (prev.currentIndex < prev.history.length - 1) {\r\n        const newIndex = prev.currentIndex + 1;\r\n        const newValue = prev.history[newIndex];\r\n  internalUpdateRef.current = true;\r\n        onChange(newValue);\r\n        return {\r\n          ...prev,\r\n          currentIndex: newIndex\r\n        };\r\n      }\r\n      return prev;\r\n    });\r\n  };\r\n\r\n  // Utilities for robust range tracking\r\n  const mergeRanges = (ranges: { start: number; end: number }[]) => {\r\n    const sorted = ranges\r\n      .filter(r => r.end > r.start)\r\n      .sort((a, b) => a.start - b.start);\r\n    const out: { start: number; end: number }[] = [];\r\n    for (const r of sorted) {\r\n      const last = out[out.length - 1];\r\n      if (!last) { out.push({ ...r }); continue; }\r\n      if (r.start <= last.end) {\r\n        last.end = Math.max(last.end, r.end);\r\n      } else {\r\n        out.push({ ...r });\r\n      }\r\n    }\r\n    return out;\r\n  };\r\n\r\n  const handleContentChange = (newValue: string) => {\r\n    internalUpdateRef.current = true;\r\n    const oldValue = previousValueRef.current;\r\n    const oldLen = oldValue.length;\r\n    const newLen = newValue.length;\r\n\r\n    // Compute minimal diff window to locate edit region\r\n    let p = 0;\r\n    while (p < oldLen && p < newLen && oldValue[p] === newValue[p]) p++;\r\n    let s = 0;\r\n    while (\r\n      s < (oldLen - p) &&\r\n      s < (newLen - p) &&\r\n      oldValue[oldLen - 1 - s] === newValue[newLen - 1 - s]\r\n    ) s++;\r\n    const changeStart = p;\r\n    const oldChangeEnd = oldLen - s;\r\n    const newChangeEnd = newLen - s;\r\n    const removedLen = Math.max(0, oldChangeEnd - changeStart);\r\n    const insertedLen = Math.max(0, newChangeEnd - changeStart);\r\n    const delta = insertedLen - removedLen;\r\n    const ta = taRef.current;\r\n    const caretPos = ta ? ta.selectionStart : newChangeEnd; // caret after change\r\n\r\n    // Map a position from old text to new text\r\n    const mapPos = (pos: number) => {\r\n      if (pos <= changeStart) return pos;\r\n      if (pos >= oldChangeEnd) return pos + delta;\r\n      // Inside the changed window: clamp into the inserted segment\r\n      const offset = pos - changeStart;\r\n      return changeStart + Math.min(insertedLen, Math.max(0, offset));\r\n    };\r\n\r\n    // Shift existing highlights to follow their content\r\n    let updatedRanges = highlightRanges.map(r => ({ start: mapPos(r.start), end: mapPos(r.end) }));\r\n    let updatedExternal = syncedExternalRanges.map(r => ({ start: mapPos(r.start), end: mapPos(r.end) }));\r\n    let updatedPersistent = syncedPersistentRanges.map(r => ({ start: mapPos(r.start), end: mapPos(r.end) }));\r\n\r\n    // If we are replacing a placeholder selection, add a new sticky highlight for the inserted content\r\n    if (replacingPlaceholderRef.current) {\r\n      const rep = replacingPlaceholderRef.current;\r\n      // Only create if the edit intersects the placeholder bounds\r\n      if (!(oldChangeEnd <= rep.start || changeStart >= rep.end)) {\r\n        const newRange = { start: rep.start, end: rep.start + insertedLen };\r\n        activeReplacementRangeRef.current = { ...newRange };\r\n        updatedRanges.push(newRange);\r\n      }\r\n      replacingPlaceholderRef.current = null; // consumed\r\n    } else if (activeReplacementRangeRef.current && delta !== 0) {\r\n      // Keep growing active range when typing at or right after its end\r\n      const r = activeReplacementRangeRef.current;\r\n      const mapped = { start: mapPos(r.start), end: mapPos(r.end) };\r\n      let grow = false;\r\n      if (delta > 0 && removedLen === 0) {\r\n        // Pure insertion: extend if insertion starts at end of the active range\r\n        if (changeStart === mapped.end || caretPos === mapped.end + insertedLen) {\r\n          mapped.end += insertedLen;\r\n          grow = true;\r\n        }\r\n      }\r\n      activeReplacementRangeRef.current = { ...mapped };\r\n      updatedRanges = updatedRanges.map(x => (x.start === r.start && x.end === r.end) ? mapped : x);\r\n      if (!grow && delta !== 0) {\r\n        // If edit moved away, stop actively growing it\r\n        if (caretPos < mapped.start || caretPos > mapped.end) {\r\n          activeReplacementRangeRef.current = null;\r\n        }\r\n      }\r\n    } else if (delta > 0 && removedLen === 0) {\r\n      // No active range, but user inserted text: if insertion happens exactly at the end of any existing range, extend that range\r\n      const tryExtend = (arr: { start: number; end: number }[]) => {\r\n        for (let i = 0; i < arr.length; i++) {\r\n          const r = arr[i];\r\n          if (changeStart === r.end) {\r\n            arr[i] = { start: r.start, end: r.end + insertedLen };\r\n            // Make it active so further typing continues to grow this highlight\r\n            activeReplacementRangeRef.current = { ...arr[i] };\r\n            return true;\r\n          }\r\n        }\r\n        return false;\r\n      };\r\n      // Prefer extending internal ranges, then external, then persistent\r\n      if (!tryExtend(updatedRanges)) {\r\n        if (!tryExtend(updatedExternal)) {\r\n          tryExtend(updatedPersistent);\r\n        }\r\n      }\r\n    }\r\n\r\n    updatedRanges = mergeRanges(updatedRanges);\r\n    updatedExternal = mergeRanges(updatedExternal);\r\n    updatedPersistent = mergeRanges(updatedPersistent);\r\n    setHighlightRanges(updatedRanges);\r\n    setSyncedExternalRanges(updatedExternal);\r\n    setSyncedPersistentRanges(updatedPersistent);\r\n\r\n    onChange(newValue);\r\n    addToHistory(newValue);\r\n    previousValueRef.current = newValue;\r\n  };\r\n\r\n  // Select placeholder token at cursor to prep for replacement\r\n  const selectPlaceholderAtCursor = () => {\r\n    const ta = taRef.current;\r\n    if (!ta) return;\r\n    // Only act when there's no selection already\r\n    if (ta.selectionStart !== ta.selectionEnd) return;\r\n\r\n    const pos = ta.selectionStart;\r\n    const text = ta.value;\r\n    const regex = /\\[[^\\]]+\\]/g;\r\n    let m: RegExpExecArray | null;\r\n    while ((m = regex.exec(text)) !== null) {\r\n      const start = m.index;\r\n      const end = start + m[0].length;\r\n      // Select only if strictly inside the token (avoid snapping when clicking exactly at boundaries)\r\n      if (pos > start && pos < end) {\r\n        ta.setSelectionRange(start, end);\r\n        replacingPlaceholderRef.current = { start, end };\r\n        activeReplacementRangeRef.current = null;\r\n        break;\r\n      }\r\n    }\r\n  };\r\n\r\n  // Handle keyboard shortcuts\r\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\r\n    // Ctrl+Z: Undo\r\n    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleUndo();\r\n      return;\r\n    }\r\n\r\n    // Ctrl+Y or Ctrl+Shift+Z: Redo\r\n    if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {\r\n      e.preventDefault();\r\n      handleRedo();\r\n      return;\r\n    }\r\n\r\n    // Ctrl+Backspace: Clear all content\r\n    if ((e.ctrlKey || e.metaKey) && e.key === 'Backspace') {\r\n      e.preventDefault();\r\n      const newValue = '';\r\n  internalUpdateRef.current = true;\r\n  onChange(newValue);\r\n      addToHistory(newValue);\r\n      return;\r\n    }\r\n    \r\n    // Alt+Backspace: Delete word backwards\r\n    if (e.altKey && e.key === 'Backspace') {\r\n      e.preventDefault();\r\n      const textarea = e.currentTarget;\r\n      const start = textarea.selectionStart;\r\n      const end = textarea.selectionEnd;\r\n      \r\n      if (start !== end) {\r\n        // If there's a selection, just delete it\r\n        const newValue = value.slice(0, start) + value.slice(end);\r\n        handleContentChange(newValue);\r\n        setTimeout(() => {\r\n          if (textarea) {\r\n            textarea.setSelectionRange(start, start);\r\n          }\r\n        }, 0);\r\n        return;\r\n      }\r\n      \r\n      // Find word boundary backwards\r\n      let wordStart = start;\r\n      while (wordStart > 0 && /\\w/.test(value[wordStart - 1])) {\r\n        wordStart--;\r\n      }\r\n      \r\n      // If we didn't find a word character, delete whitespace backwards\r\n      if (wordStart === start) {\r\n        while (wordStart > 0 && /\\s/.test(value[wordStart - 1])) {\r\n          wordStart--;\r\n        }\r\n      }\r\n      \r\n      const newValue = value.slice(0, wordStart) + value.slice(start);\r\n      handleContentChange(newValue);\r\n      \r\n      setTimeout(() => {\r\n        if (textarea) {\r\n          textarea.setSelectionRange(wordStart, wordStart);\r\n        }\r\n      }, 0);\r\n      return;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div\r\n      ref={wrapperRef}\r\n      style={{\r\n        position: 'relative',\r\n        fontSize: 13,\r\n        lineHeight: 1,\r\n        border: 'none',\r\n        background: 'transparent',\r\n        borderRadius: 0,\r\n        padding: 0,\r\n        minHeight\r\n      }}\r\n      onMouseEnter={() => setShowToolbar(true)}\r\n      onMouseLeave={() => setShowToolbar(false)}\r\n    >\r\n      {/* Floating toolbar */}\r\n      {showToolbar && (\r\n        <div style={{\r\n          position: 'absolute',\r\n          top: -2,\r\n          right: 4,\r\n          zIndex: 10,\r\n          display: 'flex',\r\n          gap: 2,\r\n          backgroundColor: 'rgba(255, 255, 255, 0.95)',\r\n          border: '1px solid #e1e5e9',\r\n          borderRadius: 4,\r\n          padding: '2px',\r\n          boxShadow: '0 2px 8px rgba(0,0,0,0.1)',\r\n          opacity: 1,\r\n          transition: 'opacity 0.2s ease'\r\n        }}>\r\n          <button\r\n            onClick={handleUndo}\r\n            disabled={undoRedoState.currentIndex <= 0}\r\n            style={{\r\n              padding: '4px 6px',\r\n              fontSize: 11,\r\n              backgroundColor: 'transparent',\r\n              color: undoRedoState.currentIndex <= 0 ? '#ccc' : '#666',\r\n              border: 'none',\r\n              borderRadius: 2,\r\n              cursor: undoRedoState.currentIndex <= 0 ? 'not-allowed' : 'pointer',\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 2\r\n            }}\r\n            title=\"Undo (Ctrl+Z)\"\r\n          >\r\n            <FaEdit style={{ fontSize: 12, transform: 'scaleX(-1)' }} />\r\n          </button>\r\n          <button\r\n            onClick={handleRedo}\r\n            disabled={undoRedoState.currentIndex >= undoRedoState.history.length - 1}\r\n            style={{\r\n              padding: '4px 6px',\r\n              fontSize: 11,\r\n              backgroundColor: 'transparent',\r\n              color: undoRedoState.currentIndex >= undoRedoState.history.length - 1 ? '#ccc' : '#666',\r\n              border: 'none',\r\n              borderRadius: 2,\r\n              cursor: undoRedoState.currentIndex >= undoRedoState.history.length - 1 ? 'not-allowed' : 'pointer',\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 2\r\n            }}\r\n            title=\"Redo (Ctrl+Y)\"\r\n          >\r\n            <FaEdit style={{ fontSize: 12 }} />\r\n          </button>\r\n          <div style={{\r\n            width: 1,\r\n            height: 16,\r\n            backgroundColor: '#e1e5e9',\r\n            margin: '0 2px'\r\n          }} />\r\n          <button\r\n            onClick={() => {\r\n              const newValue = '';\r\n              internalUpdateRef.current = true;\r\n              onChange(newValue);\r\n              addToHistory(newValue);\r\n            }}\r\n            title=\"Clear all (Ctrl+Backspace)\"\r\n          >\r\n            <FaEraser style={{ fontSize: 12 }} />\r\n          </button>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Rich text editor - WYSIWYG experience */}\r\n      <div\r\n        ref={bodyEditorRef}\r\n        contentEditable={true}\r\n        className=\"rich-text-editor\"\r\n        onInput={(e) => {\r\n          const target = e.currentTarget as HTMLDivElement;\r\n          onChange(target.innerHTML);\r\n        }}\r\n        onBlur={(e) => {\r\n          // Finalize any active placeholder editing when leaving the editor\r\n          const editorEl = e.currentTarget as HTMLDivElement;\r\n          const editing = Array.from(editorEl.querySelectorAll('.placeholder-editing')) as HTMLElement[];\r\n          if (editing.length) {\r\n            for (const el of editing) {\r\n              const original = el.getAttribute('data-original') || '';\r\n              const current = (el.textContent || '').trim();\r\n              if (current === original) {\r\n                // No change → restore original placeholder wrapper\r\n                const span = document.createElement('span');\r\n                span.className = 'insert-placeholder';\r\n                span.setAttribute('data-insert', '');\r\n                span.textContent = original;\r\n                el.replaceWith(span);\r\n              } else {\r\n                // Changed → persist edited highlight\r\n                const span = document.createElement('span');\r\n                span.className = 'placeholder-edited';\r\n                span.textContent = current;\r\n                el.replaceWith(span);\r\n              }\r\n            }\r\n            onChange(editorEl.innerHTML);\r\n          }\r\n        }}\r\n        onClick={(e) => {\r\n          // Handle link clicks - allow them to work normally\r\n          const link = (e.target as HTMLElement).closest('a');\r\n          if (link && link.href) {\r\n            // Let links work normally - don't preventDefault\r\n            return;\r\n          }\r\n          \r\n          // Handle placeholder clicks - convert to inline editable text\r\n          const editorEl = e.currentTarget as HTMLDivElement;\r\n          const targetEl = e.target as HTMLElement;\r\n          // If clicking elsewhere, finalize any active editing first (except if clicking inside it)\r\n          const activeEdits = Array.from(editorEl.querySelectorAll('.placeholder-editing')) as HTMLElement[];\r\n          if (activeEdits.length) {\r\n            for (const el of activeEdits) {\r\n              if (el.contains(targetEl)) continue; // keep editing the one being interacted with\r\n              const original = el.getAttribute('data-original') || '';\r\n              const current = (el.textContent || '').trim();\r\n              if (current === original) {\r\n                const span = document.createElement('span');\r\n                span.className = 'insert-placeholder';\r\n                span.setAttribute('data-insert', '');\r\n                span.textContent = original;\r\n                el.replaceWith(span);\r\n              } else {\r\n                const span = document.createElement('span');\r\n                span.className = 'placeholder-edited';\r\n                span.textContent = current;\r\n                el.replaceWith(span);\r\n              }\r\n            }\r\n            onChange(editorEl.innerHTML);\r\n          }\r\n\r\n          const span = targetEl.closest('.insert-placeholder');\r\n          if (span) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            // Turn placeholder into an editing wrapper retaining original text for comparison\r\n            const original = span.textContent || '';\r\n            const wrapper = document.createElement('span');\r\n            wrapper.className = 'placeholder-editing';\r\n            wrapper.setAttribute('data-original', original);\r\n            const inner = document.createElement('span');\r\n            inner.className = 'edit-text';\r\n            inner.textContent = original;\r\n            wrapper.appendChild(inner);\r\n            span.replaceWith(wrapper);\r\n            // Select all text for easy replacement\r\n            const sel = window.getSelection();\r\n            const range = document.createRange();\r\n            range.selectNodeContents(inner);\r\n            sel?.removeAllRanges();\r\n            sel?.addRange(range);\r\n            onChange(editorEl.innerHTML);\r\n          }\r\n        }}\r\n        onDoubleClick={(e) => {\r\n          // Double-click also triggers inline editing\r\n          const placeholder = (e.target as HTMLElement).closest('.insert-placeholder');\r\n          if (placeholder) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            // Trigger the same click behavior\r\n            (placeholder as HTMLElement).click();\r\n          }\r\n        }}\r\n        onKeyDown={(e) => {\r\n          // Handle Enter key for placeholder inline editing\r\n          if (e.key === 'Enter') {\r\n            const placeholder = (e.target as HTMLElement).closest('.insert-placeholder');\r\n            if (placeholder) {\r\n              e.preventDefault();\r\n              e.stopPropagation();\r\n              (placeholder as HTMLElement).click();\r\n              return;\r\n            }\r\n          }\r\n          \r\n          // Handle keyboard shortcuts for rich text formatting\r\n          const key = e.key.toLowerCase();\r\n          const ctrl = e.ctrlKey || e.metaKey;\r\n          const shift = e.shiftKey;\r\n          \r\n          if (ctrl) {\r\n            switch (key) {\r\n              case 'b':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('bold');\r\n                break;\r\n              case 'i':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('italic');\r\n                break;\r\n              case 'u':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('underline');\r\n                break;\r\n              case 'k':\r\n                e.preventDefault();\r\n                const url = prompt('Enter URL:');\r\n                if (url) handleFormatCommand?.('createLink', url);\r\n                break;\r\n              case 'l':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('justifyLeft');\r\n                break;\r\n              case 'e':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('justifyCenter');\r\n                break;\r\n              case 'r':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('justifyRight');\r\n                break;\r\n              case 'z':\r\n                if (shift) {\r\n                  e.preventDefault();\r\n                  handleFormatCommand?.('redo');\r\n                } else {\r\n                  e.preventDefault();\r\n                  handleFormatCommand?.('undo');\r\n                }\r\n                break;\r\n              case 'y':\r\n                e.preventDefault();\r\n                handleFormatCommand?.('redo');\r\n                break;\r\n              case '8':\r\n                if (shift) {\r\n                  e.preventDefault();\r\n                  handleFormatCommand?.('insertUnorderedList');\r\n                }\r\n                break;\r\n              case '7':\r\n                if (shift) {\r\n                  e.preventDefault();\r\n                  handleFormatCommand?.('insertOrderedList');\r\n                }\r\n                break;\r\n            }\r\n          }\r\n          \r\n          if (key === 's' && ctrl && shift) {\r\n            e.preventDefault();\r\n            handleFormatCommand?.('strikeThrough');\r\n          }\r\n        }}\r\n        suppressContentEditableWarning={true}\r\n        style={{\r\n          width: '100%',\r\n          minHeight: minHeight,\r\n          background: 'transparent',\r\n          color: isDarkMode ? colours.dark.text : '#222',\r\n          font: 'inherit',\r\n          lineHeight: 1.6,\r\n          border: 'none',\r\n          padding: '8px 12px',\r\n          outline: 'none',\r\n          whiteSpace: 'pre-wrap',\r\n          wordBreak: 'break-word',\r\n          boxSizing: 'border-box',\r\n          resize: 'none'\r\n        }}\r\n        spellCheck={true}\r\n        title=\"Rich text editor - use toolbar or keyboard shortcuts for formatting\"\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\ninterface EditorAndTemplateBlocksProps {\r\n  isDarkMode: boolean;\r\n  body: string;\r\n  setBody: (body: string) => void;\r\n  templateBlocks: TemplateBlock[];\r\n  selectedTemplateOptions: { [key: string]: string | string[] };\r\n  insertedBlocks: { [key: string]: boolean };\r\n  lockedBlocks: { [key: string]: boolean };\r\n  editedBlocks: { [key: string]: boolean };\r\n  handleMultiSelectChange: (blockTitle: string, selectedOptions: string[]) => void;\r\n  handleSingleSelectChange: (blockTitle: string, optionKey: string) => void;\r\n  insertTemplateBlock: (block: TemplateBlock, optionLabel: string | string[], focus?: boolean) => void;\r\n  renderPreview: (block: TemplateBlock) => React.ReactNode;\r\n  applyFormat: (...args: any[]) => void;\r\n  saveSelection: () => void;\r\n  handleInput: (e: React.FormEvent<HTMLDivElement>) => void;\r\n  handleBlur: (e: React.FocusEvent<HTMLDivElement>) => void;\r\n  handleClearBlock: (block: TemplateBlock) => void;\r\n  bodyEditorRef: React.RefObject<HTMLDivElement>;\r\n  toolbarStyle?: any;\r\n  bubblesContainerStyle?: any;\r\n  saveCustomSnippet?: (blockTitle: string, label?: string, sortOrder?: number, isNew?: boolean) => Promise<void>;\r\n  markBlockAsEdited?: (blockTitle: string, edited: boolean) => void;\r\n  initialNotes?: string;\r\n  subject: string;\r\n  setSubject: (subject: string) => void;\r\n  // Deal capture props\r\n  showDealCapture?: boolean;\r\n  initialScopeDescription?: string;\r\n  onScopeDescriptionChange?: (value: string) => void;\r\n  amount?: string;\r\n  onAmountChange?: (value: string) => void;\r\n  // Inline preview dependencies\r\n  userData?: any;\r\n  enquiry?: any;\r\n  passcode?: string;\r\n  handleDraftEmail?: () => void;\r\n  sendEmail?: () => void;\r\n  isDraftConfirmed?: boolean;\r\n  // Email recipient props for send confirmation\r\n  to?: string;\r\n  cc?: string;\r\n  bcc?: string;\r\n  feeEarnerEmail?: string;\r\n  // Callback to update recipients before sending\r\n  onRecipientsChange?: (to: string, cc?: string, bcc?: string) => void;\r\n  // Inline status feedback\r\n  dealCreationInProgress?: boolean;\r\n  dealStatus?: 'idle' | 'processing' | 'ready' | 'error';\r\n  emailStatus?: 'idle' | 'processing' | 'sent' | 'error';\r\n  emailMessage?: string;\r\n}\r\n\r\nconst EditorAndTemplateBlocks: React.FC<EditorAndTemplateBlocksProps> = ({\r\n  isDarkMode,\r\n  body,\r\n  setBody,\r\n  templateBlocks,\r\n  selectedTemplateOptions,\r\n  insertedBlocks,\r\n  lockedBlocks,\r\n  editedBlocks,\r\n  handleMultiSelectChange,\r\n  handleSingleSelectChange,\r\n  insertTemplateBlock,\r\n  renderPreview,\r\n  applyFormat,\r\n  saveSelection,\r\n  handleInput,\r\n  handleBlur,\r\n  handleClearBlock,\r\n  bodyEditorRef,\r\n  toolbarStyle,\r\n  bubblesContainerStyle,\r\n  saveCustomSnippet,\r\n  markBlockAsEdited,\r\n  initialNotes,\r\n  subject,\r\n  setSubject,\r\n  // Deal capture props\r\n  showDealCapture = true,\r\n  initialScopeDescription,\r\n  onScopeDescriptionChange,\r\n  amount,\r\n  onAmountChange,\r\n  // Inline preview dependencies\r\n  userData,\r\n  enquiry,\r\n  passcode,\r\n  handleDraftEmail,\r\n  sendEmail,\r\n  isDraftConfirmed,\r\n  // Email recipient props for send confirmation\r\n  to,\r\n  cc,\r\n  bcc,\r\n  feeEarnerEmail,\r\n  onRecipientsChange,\r\n  // Inline status feedback\r\n  dealCreationInProgress,\r\n  dealStatus,\r\n  emailStatus,\r\n  emailMessage\r\n}) => {\r\n  // State for removed blocks\r\n  const [removedBlocks, setRemovedBlocks] = useState<{ [key: string]: boolean }>({});\r\n  // Local editable contents per block\r\n  const [blockContents, setBlockContents] = useState<{ [key: string]: string }>({});\r\n\r\n  // Deal capture state\r\n  const [scopeDescription, setScopeDescription] = useState(initialScopeDescription || '');\r\n  // Default amount now 1500 if not supplied\r\n  const [amountValue, setAmountValue] = useState(amount && amount.trim() !== '' ? amount : '1500');\r\n  const [amountError, setAmountError] = useState<string | null>(null);\r\n  // Removed PIC placeholder insertion feature per user request\r\n  const [isNotesPinned, setIsNotesPinned] = useState(false);\r\n  const [showSubjectHint, setShowSubjectHint] = useState(false);\r\n  const [selectedScenarioId, setSelectedScenarioId] = useState<string>('');\r\n  const isBeforeCallCall = selectedScenarioId === 'before-call-call';\r\n  const [isTemplatesCollapsed, setIsTemplatesCollapsed] = useState(false); // Start expanded for immediate selection\r\n  const [showInlinePreview, setShowInlinePreview] = useState(false);\r\n  // Email confirmation modal state\r\n  const [showSendConfirmModal, setShowSendConfirmModal] = useState(false);\r\n  // Email processing method selection state\r\n  const [showEmailProcessingDialog, setShowEmailProcessingDialog] = useState(false);\r\n  const [selectedEmailMethod, setSelectedEmailMethod] = useState<'v1' | 'v2' | null>(null);\r\n  // Track which action is requesting processing selection: 'send' or 'draft'\r\n  const [processingDialogAction, setProcessingDialogAction] = useState<'send' | 'draft' | null>(null);\r\n  const [confirmReady, setConfirmReady] = useState(false);\r\n  const previewRef = useRef<HTMLDivElement | null>(null);\r\n  // Copy feedback flags\r\n  const [copiedToolbar, setCopiedToolbar] = useState(false);\r\n  const [copiedFooter, setCopiedFooter] = useState(false);\r\n  // Modal validation error\r\n  const [modalError, setModalError] = useState<string | null>(null);\r\n  // Track in-modal sending to disable actions and show progress inline\r\n  const [modalSending, setModalSending] = useState<boolean>(false);\r\n  // HMR tick to force re-render when scenarios module hot-reloads\r\n  const [hmrTick, setHmrTick] = useState(0);\r\n  // Prevent Draft visual state from being triggered by Send action\r\n  const [hasSentEmail, setHasSentEmail] = useState(false);\r\n  // Track hover state for validation message\r\n  const [showSendValidation, setShowSendValidation] = useState<boolean>(false);\r\n  // Editable To field in modal\r\n  const [editableTo, setEditableTo] = useState<string>(to || '');\r\n  // Rich text mode is always enabled for WYSIWYG experience\r\n  const richTextMode = true;\r\n\r\n  // Update editable To when prop changes\r\n  React.useEffect(() => {\r\n    setEditableTo(to || '');\r\n  }, [to]);\r\n\r\n  // Helper: reset editor to a fresh state\r\n  const resetEditor = useCallback(() => {\r\n    try {\r\n      setSelectedScenarioId('');\r\n      setBody('');\r\n      setSubject('Your Enquiry - Helix Law');\r\n      setScopeDescription('');\r\n      setAmountValue('1500');\r\n      setAmountError(null);\r\n      setIsTemplatesCollapsed(false);\r\n      setShowInlinePreview(false);\r\n      setConfirmReady(false);\r\n      setHasSentEmail(false);\r\n      setBlockContents({});\r\n      setRemovedBlocks({});\r\n      setAllBodyReplacedRanges([]);\r\n    } catch {}\r\n  }, [setBody, setSubject]);\r\n\r\n  // Keep modal open - let user close when ready (more reassuring UX)\r\n  // Auto-reset editor only after a real SEND completes successfully (not for DRAFT)\r\n  useEffect(() => {\r\n    const saved = dealStatus === 'ready';\r\n    const sent = emailStatus === 'sent';\r\n    // Only auto-reset editor if both operations completed successfully AND modal is closed AND a send occurred\r\n    if (!showSendConfirmModal && saved && sent && hasSentEmail) {\r\n      resetEditor();\r\n    }\r\n  }, [showSendConfirmModal, dealStatus, emailStatus, hasSentEmail, resetEditor]);\r\n\r\n  // Auto-close modal after successful email send\r\n  useEffect(() => {\r\n    if (emailStatus === 'sent' && showSendConfirmModal) {\r\n      const timer = setTimeout(() => {\r\n        setShowSendConfirmModal(false);\r\n      }, 2000); // Close after 2 seconds to allow user to see success\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [emailStatus, showSendConfirmModal]);\r\n\r\n  // Helper: apply simple [RATE]/[ROLE] substitutions and dynamic tokens ([InstructLink])\r\n  const applyRateRolePlaceholders = useCallback((text: string) => {\r\n    const u: any = Array.isArray(userData) ? (userData?.[0] ?? null) : userData;\r\n    if (!u || !text) return text;\r\n    const roleRaw = (u.Role ?? u.role ?? u.RoleName ?? u.roleName);\r\n    const rateRaw = (u.Rate ?? u.rate ?? u.HourlyRate ?? u.hourlyRate);\r\n    const roleStr = roleRaw == null ? '' : String(roleRaw).trim();\r\n    const parseRate = (val: unknown): number | null => {\r\n      if (val == null) return null;\r\n      if (typeof val === 'number') return isFinite(val) ? val : null;\r\n      const cleaned = String(val).replace(/[^0-9.\\-]/g, '').trim();\r\n      if (!cleaned) return null;\r\n      const n = Number(cleaned);\r\n      return isFinite(n) ? n : null;\r\n    };\r\n    const rateNumber = parseRate(rateRaw);\r\n    const formatRateGBP = (n: number) => `£${n.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} + VAT`;\r\n    let out = text;\r\n    if (rateNumber != null) out = out.replace(/\\[RATE\\]/gi, formatRateGBP(rateNumber));\r\n    if (roleStr) out = out.replace(/\\[ROLE\\]/gi, roleStr);\r\n    // Also apply dynamic substitutions so [InstructLink] renders in the editor\r\n    // For editor, compute an effective passcode (use provided passcode or a deterministic local one derived from enquiry ID)\r\n  const effectivePass = passcode || undefined; // no fallback\r\n    let substituted = applyDynamicSubstitutions(\r\n      out,\r\n      userData,\r\n      enquiry,\r\n      amount,\r\n      effectivePass\r\n    );\r\n    // Replace the HTML anchor with a React anchor for in-editor display\r\n    substituted = substituted.replace(\r\n      /<a href=\"([^\"]*)\"[^>]*>Instruct Helix Law<\\/a>/gi,\r\n      (_match, href) => {\r\n        // Use a unique marker for React rendering\r\n        return `[[INSTRUCT_LINK::${href}]]`;\r\n      }\r\n    );\r\n    return substituted;\r\n  }, [userData, enquiry, amount, passcode]);\r\n  // Track the last body we injected from a scenario so we can safely refresh on scenario edits\r\n  const lastScenarioBodyRef = useRef<string>('');\r\n  \r\n  // Track the last passcode so we can re-process the editor content when it becomes available\r\n  const lastPasscodeRef = useRef<string>('');\r\n\r\n  // When passcode becomes available, re-process the editor content to update [InstructLink] tokens\r\n  useEffect(() => {\r\n  const effective = passcode || undefined; // no fallback\r\n    if (effective && effective !== lastPasscodeRef.current && body) {\r\n      const processedBody = applyRateRolePlaceholders(body);\r\n      if (processedBody !== body) {\r\n        setBody(processedBody);\r\n      }\r\n      lastPasscodeRef.current = effective;\r\n    }\r\n  }, [passcode, enquiry, body, applyRateRolePlaceholders, setBody]);\r\n\r\n  // Accept hot updates to the scenarios module (CRA/Webpack HMR) and trigger a lightweight re-render\r\n  useEffect(() => {\r\n    const anyModule: any = module as any;\r\n    if (anyModule && anyModule.hot) {\r\n      const handler = () => setHmrTick((t) => t + 1);\r\n      try {\r\n        anyModule.hot.accept('./scenarios', handler);\r\n      } catch {\r\n        // no-op if HMR not available\r\n      }\r\n    }\r\n  }, []);\r\n  // Refresh selected scenario body when scenario definitions hot-update\r\n  // Removed this effect as it was causing constant resets due to SCENARIOS_VERSION changing on every import\r\n  // Ensure a default subject without tying it to scenario templates\r\n  const didSetDefaultSubject = useRef(false);\r\n  useEffect(() => {\r\n    if (!didSetDefaultSubject.current && (!subject || subject.trim() === '')) {\r\n      didSetDefaultSubject.current = true;\r\n      setSubject('Your Enquiry - Helix Law');\r\n    }\r\n  }, [subject, setSubject]);\r\n\r\n  // --- Create floating pin button with portal to render outside component tree ---\r\n  // Global sticky notes with portal when pinned\r\n  const GlobalStickyNotes = () => {\r\n    if (!initialNotes || !isNotesPinned) return null;\r\n    \r\n    return createPortal(\r\n      <div style={{\r\n        position: 'fixed',\r\n        top: 10,\r\n        left: 20,\r\n        right: 20,\r\n        maxWidth: '600px',\r\n        margin: '0 auto',\r\n        zIndex: 9999,\r\n        backgroundColor: isDarkMode ? colours.dark.cardBackground : '#ffffff',\r\n        padding: '12px',\r\n        borderRadius: '8px',\r\n        border: `2px solid ${colours.blue}`,\r\n        boxShadow: '0 4px 12px rgba(0,120,212,0.15)',\r\n  transition: 'all 0.3s ease-in-out'\r\n      }}>\r\n        <div style={{\r\n          fontSize: 12,\r\n          fontWeight: 600,\r\n          color: isDarkMode ? colours.blue : colours.darkBlue,\r\n          marginBottom: 8,\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          gap: 4,\r\n          justifyContent: 'flex-start'\r\n        }}>\r\n          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\r\n            <FaInfoCircle style={{ fontSize: 12 }} />\r\n            Enquiry Notes\r\n          </div>\r\n        </div>\r\n        {/* Floating unpin icon */}\r\n        <button\r\n          onClick={() => setIsNotesPinned(false)}\r\n          title=\"Unpin notes\"\r\n          style={{\r\n            position: 'absolute',\r\n            top: 8,\r\n            right: 8,\r\n            width: 28,\r\n            height: 28,\r\n            borderRadius: 14,\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            backgroundColor: isDarkMode ? colours.dark.inputBackground : '#ffffff',\r\n            border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e5e9'}`,\r\n            color: isDarkMode ? colours.dark.text : colours.darkBlue,\r\n            boxShadow: '0 1px 2px rgba(0,0,0,0.05)',\r\n            cursor: 'pointer'\r\n          }}\r\n          onMouseEnter={(e) => {\r\n            e.currentTarget.style.borderColor = colours.blue;\r\n          }}\r\n          onMouseLeave={(e) => {\r\n            e.currentTarget.style.borderColor = isDarkMode ? colours.dark.border : '#e1e5e9';\r\n          }}\r\n        >\r\n          <FaThumbtack style={{ fontSize: 14, color: isDarkMode ? colours.dark.text : colours.darkBlue }} />\r\n        </button>\r\n        <div style={{\r\n          fontSize: 13,\r\n          lineHeight: 1.5,\r\n          color: isDarkMode ? colours.dark.text : colours.darkBlue,\r\n          backgroundColor: isDarkMode ? colours.dark.inputBackground : '#f8f9fa',\r\n          border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e5e9'}`,\r\n          borderRadius: 6,\r\n          padding: '12px 16px',\r\n          maxHeight: '200px',\r\n          overflowY: 'auto',\r\n          whiteSpace: 'pre-wrap'\r\n        }}>\r\n          {initialNotes}\r\n        </div>\r\n      </div>,\r\n      document.body\r\n    );\r\n  };\r\n\r\n  // PIC feature removed\r\n\r\n  // Initialize and ensure [AMOUNT] placeholder line present\r\n  useEffect(() => {\r\n    // Only ensure [AMOUNT] is present if not already in description\r\n  }, []);\r\n\r\n  // Replace placeholders with actual values when amount changes\r\n  useEffect(() => {\r\n    if (amountValue && scopeDescription && scopeDescription.includes('[AMOUNT]')) {\r\n      const formattedAmount = `£${parseFloat(amountValue).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n      const updatedScope = scopeDescription.replace(/\\[AMOUNT\\]/g, formattedAmount);\r\n      setScopeDescription(updatedScope);\r\n      onScopeDescriptionChange?.(updatedScope);\r\n    }\r\n  }, [amountValue]);\r\n\r\n  // Handle removing a block\r\n  const handleRemoveBlock = (block: TemplateBlock) => {\r\n    // Mark the block as removed\r\n    setRemovedBlocks(prev => ({\r\n      ...prev,\r\n      [block.title]: true\r\n    }));\r\n    \r\n    // Clear the selection for this block\r\n    if (block.isMultiSelect) {\r\n      handleMultiSelectChange(block.title, []);\r\n    } else {\r\n      handleSingleSelectChange(block.title, '');\r\n    }\r\n  };\r\n\r\n  // Handle re-inserting a removed block\r\n  const handleReinsertBlock = (block: TemplateBlock) => {\r\n    // Remove from removed blocks to show it again\r\n    setRemovedBlocks(prev => {\r\n      const newState = { ...prev };\r\n      delete newState[block.title];\r\n      return newState;\r\n    });\r\n  };\r\n\r\n  // Deal capture event handlers\r\n  const handleScopeDescriptionChange = (event: React.FormEvent<HTMLInputElement | HTMLTextAreaElement>, newValue?: string) => {\r\n    const value = newValue || '';\r\n    setScopeDescription(value);\r\n    \r\n    // Process the value to replace placeholders with actual values\r\n    let processedValue = value;\r\n    \r\n    // Replace [AMOUNT] placeholder with actual amount if available\r\n    if (amountValue && processedValue.includes('[AMOUNT]')) {\r\n      const formattedAmount = `£${parseFloat(amountValue).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n      processedValue = processedValue.replace(/\\[AMOUNT\\]/g, formattedAmount);\r\n    }\r\n    \r\n    onScopeDescriptionChange?.(processedValue);\r\n  };\r\n\r\n  const handleAmountChange = (event: React.FormEvent<HTMLInputElement | HTMLTextAreaElement>, newValue?: string) => {\r\n    const value = newValue || '';\r\n    setAmountValue(value);\r\n    \r\n    // Validate amount\r\n    if (value && isNaN(Number(value))) {\r\n      setAmountError('Please enter a valid number');\r\n    } else {\r\n      setAmountError(null);\r\n    }\r\n    \r\n    // Auto-update scope description by replacing [AMOUNT] placeholders\r\n    if (scopeDescription) {\r\n      let updatedScope = scopeDescription;\r\n      \r\n      if (value && !isNaN(Number(value))) {\r\n        // Format the amount with currency and proper formatting\r\n        const numericValue = parseFloat(value);\r\n        const formattedAmount = `£${numericValue.toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n        \r\n        // Replace existing [AMOUNT] placeholders with the actual formatted amount\r\n        if (updatedScope.includes('[AMOUNT]')) {\r\n          updatedScope = updatedScope.replace(/\\[AMOUNT\\]/g, formattedAmount);\r\n        } else if (!updatedScope.includes('Estimated fee:') && !updatedScope.includes('£')) {\r\n          // Add the amount if it doesn't exist yet\r\n          updatedScope = updatedScope + '\\n\\nEstimated fee: ' + formattedAmount;\r\n        } else if (updatedScope.includes('Estimated fee:')) {\r\n          // Replace existing amount in \"Estimated fee:\" line\r\n          updatedScope = updatedScope.replace(/(Estimated fee:\\s*)£[\\d,]+\\.[\\d]{2}/g, `$1${formattedAmount}`);\r\n        }\r\n      } else if (value === '') {\r\n        // If amount is cleared, revert back to placeholder\r\n        updatedScope = updatedScope.replace(/£[\\d,]+\\.[\\d]{2}/g, '[AMOUNT]');\r\n      }\r\n      \r\n      setScopeDescription(updatedScope);\r\n      onScopeDescriptionChange?.(updatedScope);\r\n    }\r\n    \r\n    onAmountChange?.(value);\r\n  };\r\n\r\n  // Initialise blockContents when selections appear (do not overwrite if user already edited)\r\n  useEffect(() => {\r\n    const updates: { [k: string]: string } = {};\r\n    templateBlocks.forEach(block => {\r\n      const selectedOptions = selectedTemplateOptions[block.title];\r\n      const isMultiSelect = block.isMultiSelect;\r\n      const hasSelections = isMultiSelect\r\n        ? Array.isArray(selectedOptions) && selectedOptions.length > 0\r\n        : !!selectedOptions && selectedOptions !== '';\r\n      if (hasSelections && blockContents[block.title] === undefined) {\r\n        const base = block.editableContent || (isMultiSelect\r\n          ? block.options\r\n              .filter(opt => Array.isArray(selectedOptions) && selectedOptions.includes(opt.label))\r\n              .map(o => htmlToPlainText(o.previewText))\r\n              .join('\\n\\n')\r\n          : htmlToPlainText(block.options.find(opt => opt.label === selectedOptions)?.previewText || ''));\r\n        updates[block.title] = base;\r\n      }\r\n    });\r\n    if (Object.keys(updates).length) {\r\n      setBlockContents(prev => ({ ...prev, ...updates }));\r\n    }\r\n  }, [templateBlocks, selectedTemplateOptions]);\r\n\r\n  const handleBlockContentChange = (block: TemplateBlock, newValue?: string) => {\r\n    const value = newValue ?? '';\r\n    setBlockContents(prev => ({ ...prev, [block.title]: value }));\r\n    if (!editedBlocks[block.title]) {\r\n      markBlockAsEdited?.(block.title, true);\r\n    }\r\n  };\r\n\r\n  // Auto-insert Rate/Role highlight state and effect\r\n  const [allBodyReplacedRanges, setAllBodyReplacedRanges] = useState<{ start: number; end: number }[]>([]);\r\n  \r\n  // Auto-insert handler: replace the persistent green highlights with the new set from auto-insert\r\n  // This prevents accumulation/ghosting across scenario/template switches and ensures first-click visibility.\r\n  const handleAutoInsertHighlights = useCallback((ranges: { start: number; end: number }[]) => {\r\n    setAllBodyReplacedRanges(ranges.slice());\r\n  }, []);\r\n  \r\n  // Handle formatting commands from toolbar\r\n  const handleFormatCommand = useCallback((command: string, value?: string) => {\r\n    if (!richTextMode) return;\r\n    \r\n    try {\r\n      const success = document.execCommand(command, false, value);\r\n      if (success) {\r\n        // Trigger change detection to update body state\r\n        setTimeout(() => {\r\n          if (bodyEditorRef.current) {\r\n            setBody(bodyEditorRef.current.innerHTML);\r\n          }\r\n        }, 10);\r\n      }\r\n    } catch (error) {\r\n      console.warn(`Failed to execute format command ${command}:`, error);\r\n    }\r\n  }, [richTextMode, setBody]);\r\n\r\n  // Keyboard shortcut handler for rich text formatting\r\n  useEffect(() => {\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (!richTextMode || !bodyEditorRef.current?.contains(e.target as Node)) return;\r\n\r\n      const { ctrlKey, metaKey, shiftKey, key } = e;\r\n      const cmdKey = ctrlKey || metaKey;\r\n\r\n      if (cmdKey) {\r\n        const shortcutKey = [\r\n          cmdKey ? 'ctrl' : '',\r\n          shiftKey ? 'shift' : '',\r\n          key.toLowerCase()\r\n        ].filter(Boolean).join('+');\r\n\r\n        const command = KEYBOARD_SHORTCUTS[shortcutKey as keyof typeof KEYBOARD_SHORTCUTS];\r\n        \r\n        if (command) {\r\n          e.preventDefault();\r\n          handleFormatCommand(command);\r\n        }\r\n      }\r\n    };\r\n\r\n    document.addEventListener('keydown', handleKeyDown);\r\n    return () => document.removeEventListener('keydown', handleKeyDown);\r\n  }, [richTextMode, handleFormatCommand]);\r\n  \r\n  useAutoInsertRateRole(body, setBody, userData, handleAutoInsertHighlights);\r\n  // Also apply to subject so switching templates gets replacements too\r\n  useAutoInsertRateRole(subject, setSubject, userData);\r\n\r\n  // Email send wrapper that handles V1/V2 processing based on selected method\r\n  const handleSendEmailWithProcessing = useCallback(async () => {\r\n    if (!sendEmail) return;\r\n    \r\n    // Store the selected method in window for PitchBuilder to access\r\n    if (selectedEmailMethod === 'v2') {\r\n      (window as any).__helixEmailProcessingV2__ = true;\r\n      console.log('V2 email processing enabled for this send operation');\r\n    } else {\r\n      (window as any).__helixEmailProcessingV2__ = false;\r\n      console.log('V1 email processing (production method) selected');\r\n    }\r\n    \r\n    try {\r\n      // Call the original sendEmail function\r\n      await sendEmail();\r\n    } finally {\r\n      // Clean up the flag after sending\r\n      delete (window as any).__helixEmailProcessingV2__;\r\n      // Reset selection after sending\r\n      setSelectedEmailMethod(null);\r\n    }\r\n  }, [sendEmail, selectedEmailMethod]);\r\n\r\n  return (\r\n    <>\r\n      {/* Design System CSS Variables */}\r\n      <style>{`\r\n        :root {\r\n          --helix-navy: #061733;\r\n          --helix-blue: #3690CE;\r\n          --helix-grey: #F4F4F6;\r\n          --helix-border: #E3E8EF;\r\n          --helix-success: #10B981;\r\n          --helix-warning: #F59E0B;\r\n          --helix-error: #EF4444;\r\n          --white: #FFFFFF;\r\n          \r\n          /* Raleway as default font family */\r\n          --helix-font: 'Raleway', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\r\n        }\r\n        \r\n        /* Apply Raleway to most elements in this component */\r\n        .helix-professional-content * {\r\n          font-family: var(--helix-font) !important;\r\n        }\r\n        /* EXCEPTION: Fluent UI font icons must keep their icon font family */\r\n        .helix-professional-content .ms-Icon,\r\n        .helix-professional-content i.ms-Icon,\r\n        .helix-professional-content span.ms-Icon,\r\n        .helix-professional-content [class*=\"ms-Icon\"] {\r\n          font-family: 'FabricMDL2Icons','Segoe MDL2 Assets' !important;\r\n          speak: none;\r\n          font-weight: normal;\r\n          font-style: normal;\r\n        }\r\n        \r\n        /* Custom text selection styling - softer blue for brand consistency */\r\n        .helix-professional-content *::selection {\r\n          background-color: rgba(54, 144, 206, 0.15);\r\n          color: #1E293B;\r\n        }\r\n        \r\n        .helix-professional-content *::-moz-selection {\r\n          background-color: rgba(54, 144, 206, 0.15);\r\n          color: #1E293B;\r\n        }\r\n\r\n        /* Keyframe animation for radio button check */\r\n        @keyframes radio-check {\r\n          from {\r\n            transform: translate(-50%, -50%) scale(0);\r\n          }\r\n          to {\r\n            transform: translate(-50%, -50%) scale(1);\r\n          }\r\n        }\r\n\r\n        @keyframes cascadeIn {\r\n          from {\r\n            opacity: 0;\r\n            transform: translateY(20px);\r\n          }\r\n          to {\r\n            opacity: 1;\r\n            transform: translateY(0);\r\n          }\r\n        }\r\n          --grey-50: #F9FAFB;\r\n          --grey-100: #F3F4F6;\r\n          --grey-200: #E5E7EB;\r\n          --grey-300: #D1D5DB;\r\n          --grey-400: #9CA3AF;\r\n          --grey-500: #6B7280;\r\n          --grey-600: #4B5563;\r\n          --grey-700: #374151;\r\n          --grey-800: #1F2937;\r\n          --grey-900: #111827;\r\n          --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\r\n          --text-xs: 0.75rem;\r\n          --text-sm: 0.875rem;\r\n          --text-base: 1rem;\r\n          --text-lg: 1.125rem;\r\n          --text-xl: 1.25rem;\r\n          --weight-normal: 400;\r\n          --weight-medium: 500;\r\n          --weight-semibold: 600;\r\n          --weight-bold: 700;\r\n          --leading-tight: 1.25;\r\n          --leading-normal: 1.5;\r\n          --leading-relaxed: 1.625;\r\n          --space-1: 0.25rem;\r\n          --space-2: 0.5rem;\r\n          --space-3: 0.75rem;\r\n          --space-4: 1rem;\r\n          --space-5: 1.25rem;\r\n          --space-6: 1.5rem;\r\n          --space-8: 2rem;\r\n          --space-12: 3rem;\r\n          --radius-base: 0.25rem;\r\n          --radius-md: 0.375rem;\r\n          --radius-lg: 0.5rem;\r\n          --radius-xl: 0.75rem;\r\n          --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);\r\n          --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);\r\n          --shadow-base: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);\r\n          --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);\r\n        }\r\n\r\n        .helix-professional-content {\r\n          padding: var(--space-8);\r\n        }\r\n\r\n        .helix-professional-input {\r\n          font-family: var(--font-primary);\r\n          border-radius: var(--radius-lg);\r\n          border: 1px solid var(--grey-300);\r\n          padding: var(--space-3) var(--space-4);\r\n          font-size: var(--text-sm);\r\n          background-color: var(--white);\r\n          transition: var(--transition-base);\r\n        }\r\n\r\n        .helix-professional-input:focus {\r\n          border-color: var(--helix-blue);\r\n          outline: none;\r\n          box-shadow: 0 0 0 3px rgba(54, 144, 206, 0.1);\r\n        }\r\n\r\n        .helix-professional-button {\r\n          padding: var(--space-2) var(--space-4);\r\n          border-radius: var(--radius-lg);\r\n          border: 1px solid var(--grey-300);\r\n          background-color: var(--white);\r\n          color: var(--grey-700);\r\n          cursor: pointer;\r\n          font-size: var(--text-sm);\r\n          font-weight: var(--weight-medium);\r\n          transition: var(--transition-base);\r\n          font-family: var(--font-primary);\r\n        }\r\n\r\n        .helix-professional-button:hover {\r\n          border-color: var(--helix-blue);\r\n          background-color: var(--grey-50);\r\n        }\r\n\r\n        .helix-professional-button-primary {\r\n          background-color: var(--helix-blue);\r\n          color: var(--white);\r\n          border: none;\r\n        }\r\n\r\n        .helix-professional-button-primary:hover {\r\n          background-color: #2980b9;\r\n        }\r\n\r\n        .helix-professional-label {\r\n          font-size: var(--text-sm);\r\n          font-weight: var(--weight-medium);\r\n          color: var(--helix-navy);\r\n          margin-bottom: var(--space-2);\r\n          display: flex;\r\n          align-items: center;\r\n          gap: var(--space-2);\r\n        }\r\n      `}</style>\r\n\r\n      {/* Global sticky notes portal */}\r\n      <GlobalStickyNotes />\r\n      \r\n      {/* Content */}\r\n      <div className=\"helix-professional-content\">\r\n      \r\n      <Stack tokens={{ childrenGap: 8 }} styles={{ root: { marginTop: 0 } }}>\r\n        {/* Direct content without Email Composer container */}\r\n        <div style={{ padding: '0 0 16px 0' }}>\r\n          {/* Scenario Picker - Modern Professional Design */}\r\n          <div style={{\r\n            background: isDarkMode \r\n              ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n              : 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',\r\n            borderRadius: '16px',\r\n            padding: '24px',\r\n            border: `1px solid ${isDarkMode ? 'rgba(54, 144, 206, 0.26)' : 'rgba(148, 163, 184, 0.16)'}`,\r\n            boxShadow: isDarkMode \r\n              ? '0 20px 44px rgba(2, 6, 17, 0.72)'\r\n              : '0 16px 40px rgba(13, 47, 96, 0.18)',\r\n            marginBottom: 20,\r\n            fontFamily: 'Raleway, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif',\r\n            position: 'relative',\r\n            transition: 'all 0.25s ease'\r\n          }}>\r\n            {/* Refined accent border */}\r\n            <div style={{\r\n              position: 'absolute',\r\n              top: 0,\r\n              left: '50%',\r\n              transform: 'translateX(-50%)',\r\n              width: '60px',\r\n              height: '3px',\r\n              background: isDarkMode \r\n                ? `linear-gradient(90deg, ${colours.blue}, ${colours.darkBlue})`\r\n                : `linear-gradient(90deg, ${colours.blue}, ${colours.darkBlue})`,\r\n              borderRadius: '0 0 8px 8px'\r\n            }}></div>\r\n            \r\n            <div \r\n              style={{\r\n                fontSize: '17px',\r\n                fontWeight: 600,\r\n                color: isDarkMode ? colours.dark.text : '#0F172A',\r\n                marginBottom: isTemplatesCollapsed ? 0 : '20px',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'space-between',\r\n                gap: '12px',\r\n                padding: '12px 20px',\r\n                background: isDarkMode \r\n                  ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.86) 100%)'\r\n                  : 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',\r\n                borderRadius: '12px',\r\n                border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                cursor: 'pointer',\r\n                transition: 'all 0.3s ease',\r\n                backdropFilter: 'blur(12px)'\r\n              }}\r\n              onClick={() => setIsTemplatesCollapsed(!isTemplatesCollapsed)}\r\n              onMouseEnter={(e) => {\r\n                if (isDarkMode) {\r\n                  e.currentTarget.style.background = 'linear-gradient(135deg, rgba(10, 20, 40, 0.96) 0%, rgba(15, 35, 65, 0.9) 100%)';\r\n                  e.currentTarget.style.borderColor = 'rgba(54, 144, 206, 0.4)';\r\n                  e.currentTarget.style.transform = 'translateY(-1px)';\r\n                } else {\r\n                  e.currentTarget.style.background = 'linear-gradient(135deg, #FAFBFC 0%, #F1F5F9 100%)';\r\n                  e.currentTarget.style.borderColor = 'rgba(54, 144, 206, 0.3)';\r\n                  e.currentTarget.style.transform = 'translateY(-1px)';\r\n                }\r\n              }}\r\n              onMouseLeave={(e) => {\r\n                if (isDarkMode) {\r\n                  e.currentTarget.style.background = 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.86) 100%)';\r\n                  e.currentTarget.style.borderColor = 'rgba(125, 211, 252, 0.24)';\r\n                  e.currentTarget.style.transform = 'translateY(0)';\r\n                } else {\r\n                  e.currentTarget.style.background = 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)';\r\n                  e.currentTarget.style.borderColor = 'rgba(148, 163, 184, 0.22)';\r\n                  e.currentTarget.style.transform = 'translateY(0)';\r\n                }\r\n              }}\r\n            >\r\n              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>\r\n                <div style={{\r\n                  padding: '8px',\r\n                  borderRadius: '8px',\r\n                  background: (() => {\r\n                    if (selectedScenarioId) {\r\n                      switch(selectedScenarioId) {\r\n                        case 'before-call-call':\r\n                          return isDarkMode \r\n                            ? 'linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(54, 144, 206, 0.15) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(54, 144, 206, 0.1) 0%, rgba(96, 165, 250, 0.08) 100%)';\r\n                        case 'before-call-no-call':\r\n                          return isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(217, 119, 6, 0.15) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(251, 191, 36, 0.08) 100%)';\r\n                        case 'after-call-probably-cant-assist':\r\n                          return isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(248, 113, 113, 0.2) 0%, rgba(220, 38, 38, 0.15) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(248, 113, 113, 0.08) 100%)';\r\n                        case 'after-call-want-instruction':\r\n                          return isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(74, 222, 128, 0.2) 0%, rgba(5, 150, 105, 0.15) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(74, 222, 128, 0.08) 100%)';\r\n                        default:\r\n                          return isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(148, 163, 184, 0.2) 0%, rgba(107, 114, 128, 0.15) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(148, 163, 184, 0.08) 100%)';\r\n                      }\r\n                    } else {\r\n                      // Default blue background when no template selected\r\n                      return isDarkMode \r\n                        ? 'linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(54, 144, 206, 0.15) 100%)'\r\n                        : 'linear-gradient(135deg, rgba(54, 144, 206, 0.1) 0%, rgba(96, 165, 250, 0.08) 100%)';\r\n                    }\r\n                  })(),\r\n                  border: (() => {\r\n                    if (selectedScenarioId) {\r\n                      switch(selectedScenarioId) {\r\n                        case 'before-call-call':\r\n                          return `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(54, 144, 206, 0.2)'}`;\r\n                        case 'before-call-no-call':\r\n                          return `1px solid ${isDarkMode ? 'rgba(251, 191, 36, 0.3)' : 'rgba(217, 119, 6, 0.2)'}`;\r\n                        case 'after-call-probably-cant-assist':\r\n                          return `1px solid ${isDarkMode ? 'rgba(248, 113, 113, 0.3)' : 'rgba(220, 38, 38, 0.2)'}`;\r\n                        case 'after-call-want-instruction':\r\n                          return `1px solid ${isDarkMode ? 'rgba(74, 222, 128, 0.3)' : 'rgba(5, 150, 105, 0.2)'}`;\r\n                        default:\r\n                          return `1px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.3)' : 'rgba(107, 114, 128, 0.2)'}`;\r\n                      }\r\n                    } else {\r\n                      // Default blue border when no template selected\r\n                      return `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(54, 144, 206, 0.2)'}`;\r\n                    }\r\n                  })(),\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center'\r\n                }}>\r\n                  {(() => {\r\n                    const iconSize = 16;\r\n                    \r\n                    if (selectedScenarioId) {\r\n                      // Get the specific color for the selected template\r\n                      const iconColor = (() => {\r\n                        switch(selectedScenarioId) {\r\n                          case 'before-call-call': return isDarkMode ? colours.blue : colours.blue;\r\n                          case 'before-call-no-call': return isDarkMode ? '#FBBF24' : '#D97706';\r\n                          case 'after-call-probably-cant-assist': return isDarkMode ? '#F87171' : '#DC2626';\r\n                          case 'after-call-want-instruction': return isDarkMode ? '#4ADE80' : '#059669';\r\n                          default: return isDarkMode ? '#94A3B8' : '#6B7280';\r\n                        }\r\n                      })();\r\n                      \r\n                      // Show the selected template's icon with its specific color\r\n                      switch(selectedScenarioId) {\r\n                        case 'before-call-call':\r\n                          return (\r\n                            <svg width={iconSize} height={iconSize} viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                              <path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.1 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.66 12.66 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.66 12.66 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\"/>\r\n                            </svg>\r\n                          );\r\n                        case 'before-call-no-call':\r\n                          return (\r\n                            <svg width={iconSize} height={iconSize} viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                              <path d=\"M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z\"/>\r\n                              <polyline points=\"22,6 12,13 2,6\"/>\r\n                            </svg>\r\n                          );\r\n                        case 'after-call-probably-cant-assist':\r\n                          return (\r\n                            <svg width={iconSize} height={iconSize} viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                              <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n                              <path d=\"M15 9l-6 6M9 9l6 6\"/>\r\n                            </svg>\r\n                          );\r\n                        case 'after-call-want-instruction':\r\n                          return (\r\n                            <svg width={iconSize} height={iconSize} viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                              <path d=\"M9 12l2 2 4-4\"/>\r\n                              <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n                            </svg>\r\n                          );\r\n                        default:\r\n                          return (\r\n                            <svg width={iconSize} height={iconSize} viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                              <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\r\n                              <line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/>\r\n                              <line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/>\r\n                            </svg>\r\n                          );\r\n                      }\r\n                    } else {\r\n                      // Default lightning bolt icon when no template is selected\r\n                      const defaultIconColor = colours.blue;\r\n                      return <FaBolt style={{ fontSize: iconSize, color: defaultIconColor }} />;\r\n                    }\r\n                  })()}\r\n                </div>\r\n                <div>\r\n                  <div style={{ fontSize: '17px', fontWeight: 600 }}>\r\n                    {selectedScenarioId ? \r\n                      (SCENARIOS.find(s => s.id === selectedScenarioId)?.name || 'Template Selected') :\r\n                      'Pitch Templates'\r\n                    }\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div style={{\r\n                padding: '6px',\r\n                borderRadius: '6px',\r\n                background: isDarkMode ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.08)',\r\n                transition: 'all 0.2s ease'\r\n              }}>\r\n                {isTemplatesCollapsed ? \r\n                  <FaChevronDown style={{ fontSize: 14, color: isDarkMode ? '#94A3B8' : '#64748B' }} /> : \r\n                  <FaChevronUp style={{ fontSize: 14, color: isDarkMode ? '#94A3B8' : '#64748B' }} />\r\n                }\r\n              </div>\r\n            </div>\r\n            \r\n            {!isTemplatesCollapsed && (\r\n              <div style={{\r\n                display: 'grid',\r\n                gridTemplateColumns: window.innerWidth < 1024 ? '1fr' : 'repeat(2, 1fr)',\r\n                gap: '20px',\r\n                padding: '20px',\r\n                background: isDarkMode\r\n                  ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n                  : 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',\r\n                borderRadius: '16px',\r\n                border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.18)'}`,\r\n                boxShadow: isDarkMode\r\n                  ? '0 18px 32px rgba(2, 6, 17, 0.58)'\r\n                  : '0 12px 28px rgba(13, 47, 96, 0.12)',\r\n                backdropFilter: 'blur(12px)',\r\n                animation: 'cascadeIn 0.4s ease-out',\r\n                opacity: 1,\r\n                transform: 'translateY(0)'\r\n              }}>\r\n                {SCENARIOS.map((s, index) => (\r\n                  <button\r\n                    key={s.id}\r\n                    type=\"button\"\r\n                    className={`scenario-choice-card ${selectedScenarioId === s.id ? 'active' : ''}`}\r\n                    aria-pressed={selectedScenarioId === s.id}\r\n                    aria-label={`Select ${s.name} template: ${(() => {\r\n                      switch (s.id) {\r\n                        case 'before-call-call':\r\n                          return 'Schedule consultation with Calendly link and no upfront cost';\r\n                        case 'before-call-no-call':\r\n                          return 'Detailed written pitch with cost estimate and instruction link';\r\n                        case 'after-call-probably-cant-assist':\r\n                          return 'Polite decline with alternative suggestions and review request';\r\n                        case 'after-call-want-instruction':\r\n                          return 'Formal proposal with comprehensive costs and next steps';\r\n                        default:\r\n                          return 'Standard professional response template';\r\n                      }\r\n                    })()}`}\r\n                    role=\"radio\"\r\n                    tabIndex={0}\r\n                    onClick={() => {\r\n                      setSelectedScenarioId(s.id);\r\n                      setIsTemplatesCollapsed(true);\r\n\r\n                      const raw = stripDashDividers(s.body);\r\n                      const greetingName = (() => {\r\n                        const e = enquiry as any;\r\n                        const first = e?.First_Name ?? e?.first_name ?? e?.FirstName ?? e?.firstName ?? e?.Name?.split?.(' ')?.[0] ?? e?.ContactName?.split?.(' ')?.[0] ?? '';\r\n                        const name = String(first || '').trim();\r\n                        return name.length > 0 ? name : 'there';\r\n                      })();\r\n                      const composed = raw.startsWith('Hi ') || raw.startsWith('Hello ')\r\n                        ? raw\r\n                        : `Hi ${greetingName},\\n\\n${raw}`;\r\n                      const projected = applyRateRolePlaceholders(composed);\r\n                      lastScenarioBodyRef.current = projected;\r\n                      setBody(projected);\r\n                      const firstBlock = templateBlocks?.[0];\r\n                      if (firstBlock?.title) {\r\n                        setBlockContents(prev => ({ ...prev, [firstBlock.title]: projected }));\r\n                      }\r\n\r\n                      const isBeforeCall = s.id.startsWith('before-call');\r\n                      if (isBeforeCall) {\r\n                        const placeholderDesc = 'Initial informal steer; scope to be confirmed after call';\r\n                        const needsDesc = !scopeDescription || scopeDescription.trim() === '';\r\n                        if (needsDesc) {\r\n                          setScopeDescription(placeholderDesc);\r\n                          onScopeDescriptionChange?.(placeholderDesc);\r\n                        }\r\n                      }\r\n                    }}\r\n                    style={{\r\n                      position: 'relative',\r\n                      background: selectedScenarioId === s.id\r\n                        ? (isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.95) 0%, rgba(9, 22, 44, 0.92) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(248, 250, 252, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%)')\r\n                        : (isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(11, 22, 43, 0.88) 0%, rgba(13, 30, 56, 0.8) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(248, 250, 252, 0.92) 0%, rgba(255, 255, 255, 0.88) 100%)'),\r\n                      border: `2px solid ${selectedScenarioId === s.id\r\n                        ? colours.blue\r\n                        : (isDarkMode ? 'rgba(148, 163, 184, 0.2)' : 'rgba(148, 163, 184, 0.16)')}`,\r\n                      borderRadius: '12px',\r\n                      padding: '24px',\r\n                      cursor: 'pointer',\r\n                      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                      display: 'flex',\r\n                      flexDirection: 'column',\r\n                      gap: '16px',\r\n                      textAlign: 'left',\r\n                      minHeight: '140px',\r\n                      boxShadow: selectedScenarioId === s.id\r\n                        ? (isDarkMode ? '0 10px 36px rgba(54, 144, 206, 0.35), 0 0 0 1px rgba(54, 144, 206, 0.22) inset' : '0 6px 24px rgba(54, 144, 206, 0.25), 0 0 0 1px rgba(54, 144, 206, 0.12) inset')\r\n                        : (isDarkMode ? '0 6px 18px rgba(4, 9, 20, 0.55)' : '0 3px 12px rgba(13, 47, 96, 0.08)'),\r\n                      opacity: 0,\r\n                      animationFillMode: 'forwards',\r\n                      overflow: 'hidden',\r\n                      fontFamily: 'inherit',\r\n                      animation: `cascadeIn 0.5s ease-out ${index * 0.15}s both`,\r\n                      backdropFilter: 'blur(8px)'\r\n                    }}\r\n                    onMouseEnter={(e) => {\r\n                      if (selectedScenarioId !== s.id) {\r\n                        e.currentTarget.style.borderColor = colours.blue;\r\n                        e.currentTarget.style.boxShadow = isDarkMode\r\n                          ? '0 12px 28px rgba(96, 165, 250, 0.28)'\r\n                          : '0 8px 24px rgba(54, 144, 206, 0.2)';\r\n                        e.currentTarget.style.transform = 'translateY(-2px) scale(1.01)';\r\n                        e.currentTarget.style.background = isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(13, 28, 56, 0.95) 0%, rgba(17, 36, 64, 0.9) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)';\r\n                      }\r\n                    }}\r\n                    onMouseLeave={(e) => {\r\n                      if (selectedScenarioId !== s.id) {\r\n                        e.currentTarget.style.borderColor = isDarkMode ? 'rgba(148, 163, 184, 0.2)' : 'rgba(148, 163, 184, 0.16)';\r\n                        e.currentTarget.style.boxShadow = isDarkMode ? '0 6px 18px rgba(4, 9, 20, 0.55)' : '0 3px 12px rgba(13, 47, 96, 0.08)';\r\n                        e.currentTarget.style.transform = 'translateY(0) scale(1)';\r\n                        e.currentTarget.style.background = isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(11, 22, 43, 0.88) 0%, rgba(13, 30, 56, 0.8) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(248, 250, 252, 0.92) 0%, rgba(255, 255, 255, 0.88) 100%)';\r\n                      }\r\n                    }}\r\n                  >\r\n                    {/* Modern selection indicator */}\r\n                    {selectedScenarioId === s.id && (\r\n                      <div style={{\r\n                        position: 'absolute',\r\n                        top: '-2px',\r\n                        left: '-2px',\r\n                        right: '-2px',\r\n                        bottom: '-2px',\r\n                        background: `linear-gradient(135deg, ${colours.blue}, ${colours.darkBlue})`,\r\n                        borderRadius: '14px',\r\n                        zIndex: -1,\r\n                        animation: 'pulseGlow 2s infinite'\r\n                      }}></div>\r\n                    )}\r\n                    \r\n                    <div className=\"scenario-card-content\" style={{\r\n                      display: 'flex',\r\n                      flexDirection: 'column',\r\n                      height: '100%',\r\n                      gap: '16px',\r\n                      position: 'relative',\r\n                      zIndex: 1\r\n                    }}>\r\n                      {/* Icon and title section */}\r\n                      <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>\r\n                        <div style={{\r\n                          padding: '12px',\r\n                          borderRadius: '12px',\r\n                          background: (() => {\r\n                            const baseColor = (() => {\r\n                              switch (s.id) {\r\n                                case 'before-call-call': return isDarkMode ? 'rgba(54, 144, 206, 0.2)' : 'rgba(54, 144, 206, 0.1)';\r\n                                case 'before-call-no-call': return isDarkMode ? 'rgba(251, 191, 36, 0.2)' : 'rgba(251, 191, 36, 0.1)';\r\n                                case 'after-call-probably-cant-assist': return isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)';\r\n                                case 'after-call-want-instruction': return isDarkMode ? 'rgba(34, 197, 94, 0.2)' : 'rgba(34, 197, 94, 0.1)';\r\n                                default: return isDarkMode ? 'rgba(148, 163, 184, 0.2)' : 'rgba(148, 163, 184, 0.1)';\r\n                              }\r\n                            })();\r\n\r\n                            if (selectedScenarioId !== s.id) {\r\n                              return baseColor;\r\n                            }\r\n\r\n                            const accentGradient = (() => {\r\n                              switch (s.id) {\r\n                                case 'before-call-call':\r\n                                  return isDarkMode\r\n                                    ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.35) 0%, rgba(96, 165, 250, 0.3) 100%)'\r\n                                    : 'linear-gradient(135deg, rgba(54, 144, 206, 0.22) 0%, rgba(96, 165, 250, 0.18) 100%)';\r\n                                case 'before-call-no-call':\r\n                                  return isDarkMode\r\n                                    ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.35) 0%, rgba(250, 204, 21, 0.28) 100%)'\r\n                                    : 'linear-gradient(135deg, rgba(251, 191, 36, 0.22) 0%, rgba(250, 204, 21, 0.16) 100%)';\r\n                                case 'after-call-probably-cant-assist':\r\n                                  return isDarkMode\r\n                                    ? 'linear-gradient(135deg, rgba(239, 68, 68, 0.35) 0%, rgba(252, 165, 165, 0.28) 100%)'\r\n                                    : 'linear-gradient(135deg, rgba(239, 68, 68, 0.22) 0%, rgba(248, 113, 113, 0.16) 100%)';\r\n                                case 'after-call-want-instruction':\r\n                                  return isDarkMode\r\n                                    ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.35) 0%, rgba(134, 239, 172, 0.28) 100%)'\r\n                                    : 'linear-gradient(135deg, rgba(34, 197, 94, 0.22) 0%, rgba(74, 222, 128, 0.16) 100%)';\r\n                                default:\r\n                                  return isDarkMode\r\n                                    ? 'linear-gradient(135deg, rgba(148, 163, 184, 0.35) 0%, rgba(203, 213, 225, 0.28) 100%)'\r\n                                    : 'linear-gradient(135deg, rgba(148, 163, 184, 0.22) 0%, rgba(226, 232, 240, 0.16) 100%)';\r\n                              }\r\n                            })();\r\n\r\n                            return accentGradient;\r\n                          })(),\r\n                          border: `1px solid ${(() => {\r\n                            switch(s.id) {\r\n                              case 'before-call-call': return isDarkMode ? 'rgba(54, 144, 206, 0.3)' : 'rgba(54, 144, 206, 0.2)';\r\n                              case 'before-call-no-call': return isDarkMode ? 'rgba(251, 191, 36, 0.3)' : 'rgba(251, 191, 36, 0.2)';\r\n                              case 'after-call-probably-cant-assist': return isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.2)';\r\n                              case 'after-call-want-instruction': return isDarkMode ? 'rgba(34, 197, 94, 0.3)' : 'rgba(34, 197, 94, 0.2)';\r\n                              default: return isDarkMode ? 'rgba(148, 163, 184, 0.3)' : 'rgba(148, 163, 184, 0.2)';\r\n                            }\r\n                          })()}`,\r\n                          flexShrink: 0,\r\n                          display: 'flex',\r\n                          alignItems: 'center',\r\n                          justifyContent: 'center',\r\n                          transition: 'all 0.2s ease'\r\n                        }}>\r\n                          {(() => {\r\n                            const iconColor = (() => {\r\n                              // If this template is selected, use brand highlight blue\r\n                              if (selectedScenarioId === s.id) {\r\n                                return colours.blue;\r\n                              }\r\n                              \r\n                              // Otherwise, use theme-appropriate colors per template type\r\n                              switch(s.id) {\r\n                                case 'before-call-call': return colours.blue;\r\n                                case 'before-call-no-call': return isDarkMode ? '#FBBF24' : '#D97706';\r\n                                case 'after-call-probably-cant-assist': return isDarkMode ? '#F87171' : '#DC2626';\r\n                                case 'after-call-want-instruction': return isDarkMode ? '#4ADE80' : '#059669';\r\n                                default: return isDarkMode ? '#94A3B8' : '#6B7280';\r\n                              }\r\n                            })();\r\n                            \r\n                            switch(s.id) {\r\n                              case 'before-call-call': \r\n                                return (\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                                    <path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.1 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.66 12.66 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.66 12.66 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\"/>\r\n                                  </svg>\r\n                                );\r\n                              case 'before-call-no-call':\r\n                                return (\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                                    <path d=\"M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z\"/>\r\n                                    <polyline points=\"22,6 12,13 2,6\"/>\r\n                                  </svg>\r\n                                );\r\n                              case 'after-call-probably-cant-assist':\r\n                                return (\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                                    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n                                    <path d=\"M15 9l-6 6M9 9l6 6\"/>\r\n                                  </svg>\r\n                                );\r\n                              case 'after-call-want-instruction':\r\n                                return (\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                                    <path d=\"M9 12l2 2 4-4\"/>\r\n                                    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n                                  </svg>\r\n                                );\r\n                              default:\r\n                                return (\r\n                                  <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke={iconColor} strokeWidth=\"2\">\r\n                                    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\r\n                                    <line x1=\"9\" y1=\"9\" x2=\"15\" y2=\"15\"/>\r\n                                    <line x1=\"15\" y1=\"9\" x2=\"9\" y2=\"15\"/>\r\n                                  </svg>\r\n                                );\r\n                            }\r\n                          })()}\r\n                        </div>\r\n                        \r\n                        <div style={{ flex: 1, minWidth: 0 }}>\r\n                          <div className=\"scenario-title\" style={{\r\n                            fontSize: '16px',\r\n                            fontWeight: 600,\r\n                            color: isDarkMode ? colours.dark.text : '#1E293B',\r\n                            lineHeight: '1.4',\r\n                            marginBottom: '4px'\r\n                          }}>\r\n                            {s.name}\r\n                          </div>\r\n                          \r\n                          <div className=\"scenario-description\" style={{\r\n                            fontSize: '12px',\r\n                            color: isDarkMode ? '#94A3B8' : '#64748B',\r\n                            lineHeight: '1.4',\r\n                            fontWeight: 400\r\n                          }}>\r\n                            {(() => {\r\n                              switch(s.id) {\r\n                                case 'before-call-call': \r\n                                  return 'Schedule consultation • Calendly link • No upfront cost';\r\n                                case 'before-call-no-call':\r\n                                  return 'Detailed written pitch • Cost estimate • Instruction link';\r\n                                case 'after-call-probably-cant-assist':\r\n                                  return 'Polite decline • Alternative suggestions • Review request';\r\n                                case 'after-call-want-instruction':\r\n                                  return 'Formal proposal • Comprehensive costs • Next steps';\r\n                                default:\r\n                                  return 'Standard professional response template';\r\n                              }\r\n                            })()}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                      \r\n                      {/* Selection indicator */}\r\n                      <div style={{\r\n                        display: 'flex',\r\n                        justifyContent: 'flex-end',\r\n                        alignItems: 'center',\r\n                        marginTop: 'auto'\r\n                      }}>\r\n                        <div style={{\r\n                          width: '24px',\r\n                          height: '24px',\r\n                          border: `2px solid ${selectedScenarioId === s.id \r\n                            ? colours.blue\r\n                            : (isDarkMode ? 'rgba(148, 163, 184, 0.4)' : 'rgba(148, 163, 184, 0.3)')}`,\r\n                          borderRadius: '50%',\r\n                          background: selectedScenarioId === s.id \r\n                            ? colours.blue\r\n                            : 'transparent',\r\n                          position: 'relative',\r\n                          transition: 'all 0.2s ease',\r\n                          display: 'flex',\r\n                          alignItems: 'center',\r\n                          justifyContent: 'center'\r\n                        }}>\r\n                          {selectedScenarioId === s.id && (\r\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#ffffff\" strokeWidth=\"3\">\r\n                              <polyline points=\"20,6 9,17 4,12\"/>\r\n                            </svg>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n            </div>\r\n            {/* Scenario hot-update handled via top-level useEffect */}\r\n            \r\n            {/* Only show the rest of the form after a template is selected */}\r\n            {selectedScenarioId && (\r\n            <div style={{\r\n              animation: 'cascadeIn 0.3s ease-out',\r\n              opacity: 1,\r\n              transform: 'translateY(0)'\r\n            }}>\r\n            \r\n            {/* Subject Line - Primary Focus */}\r\n            <div style={{\r\n              background: isDarkMode\r\n                ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n                : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.94) 100%)',\r\n              borderRadius: '16px',\r\n              padding: '24px',\r\n              border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n              boxShadow: isDarkMode \r\n                ? '0 18px 32px rgba(2, 6, 17, 0.58)' \r\n                : '0 12px 28px rgba(13, 47, 96, 0.12)',\r\n              marginBottom: initialNotes ? 24 : 0,\r\n              fontFamily: 'Raleway, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif',\r\n              backdropFilter: 'blur(12px)',\r\n              animation: 'cascadeIn 0.4s ease-out'\r\n            }}>\r\n              <div style={{\r\n                fontSize: '14px',\r\n                fontWeight: 600,\r\n                color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                marginBottom: '16px',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '8px'\r\n              }}>\r\n                <div style={{\r\n                  padding: '8px',\r\n                  background: isDarkMode \r\n                    ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)',\r\n                  borderRadius: '8px',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(54, 144, 206, 0.3)'}`\r\n                }}>\r\n                  <FaEdit style={{ fontSize: 14, color: colours.blue }} />\r\n                </div>\r\n                Subject Line\r\n              </div>\r\n              <input\r\n                type=\"text\"\r\n                value={subject}\r\n                onChange={(e) => setSubject(e.target.value)}\r\n                placeholder=\"Craft your email subject based on the context below...\"\r\n                style={{\r\n                  width: '100%',\r\n                  padding: '16px 20px',\r\n                  fontSize: '15px',\r\n                  fontWeight: 400,\r\n                  border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)'}`,\r\n                  borderRadius: '10px',\r\n                  background: isDarkMode \r\n                    ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.88) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                  outline: 'none',\r\n                  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                  boxShadow: isDarkMode\r\n                    ? '0 12px 20px rgba(4, 9, 20, 0.6)'\r\n                    : '0 8px 18px rgba(13, 47, 96, 0.14)',\r\n                  fontFamily: 'inherit',\r\n                  boxSizing: 'border-box',\r\n                  backdropFilter: 'blur(8px)'\r\n                }}\r\n                onFocus={(e) => {\r\n                  e.target.style.borderColor = isDarkMode ? '#60A5FA' : '#3690CE';\r\n                  e.target.style.borderWidth = '2px';\r\n                  e.target.style.boxShadow = isDarkMode\r\n                    ? '0 0 0 4px rgba(96, 165, 250, 0.2), 0 16px 28px rgba(4, 9, 20, 0.7)'\r\n                    : '0 0 0 4px rgba(54, 144, 206, 0.15), 0 12px 24px rgba(13, 47, 96, 0.18)';\r\n                }}\r\n                onBlur={(e) => {\r\n                  e.target.style.borderColor = isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.3)';\r\n                  e.target.style.borderWidth = '1px';\r\n                  e.target.style.boxShadow = isDarkMode\r\n                    ? '0 12px 20px rgba(4, 9, 20, 0.6)'\r\n                    : '0 8px 18px rgba(13, 47, 96, 0.14)';\r\n                }}\r\n              />\r\n            </div>\r\n\r\n            {/* Default subject is set via a top-level effect to respect Hooks rules */}\r\n\r\n            {/* Email body / Preview (swap in place) */}\r\n            <div style={{\r\n              background: isDarkMode\r\n                ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n                : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.94) 100%)',\r\n              borderRadius: '16px',\r\n              padding: '24px',\r\n              border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n              boxShadow: isDarkMode \r\n                ? '0 18px 32px rgba(2, 6, 17, 0.58)' \r\n                : '0 12px 28px rgba(13, 47, 96, 0.12)',\r\n              marginBottom: 20,\r\n              fontFamily: 'Raleway, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif',\r\n              backdropFilter: 'blur(12px)',\r\n              animation: 'cascadeIn 0.4s ease-out'\r\n            }}>\r\n              <div style={{\r\n                fontSize: '14px',\r\n                fontWeight: 600,\r\n                color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                marginBottom: '18px',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '12px',\r\n                justifyContent: 'space-between',\r\n                padding: '12px 18px',\r\n                background: isDarkMode\r\n                  ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.92) 0%, rgba(11, 30, 55, 0.86) 100%)'\r\n                  : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                borderRadius: '12px',\r\n                border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                boxShadow: isDarkMode \r\n                  ? '0 10px 22px rgba(4, 9, 20, 0.55)' \r\n                  : '0 6px 16px rgba(13, 47, 96, 0.12)',\r\n                backdropFilter: 'blur(8px)'\r\n              }}>\r\n                <span style={{ display: 'inline-flex', alignItems: 'center', gap: 8 }}>\r\n                  <div style={{\r\n                    padding: '8px',\r\n                    background: isDarkMode \r\n                      ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n                      : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)',\r\n                    borderRadius: '8px',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(54, 144, 206, 0.3)'}`\r\n                  }}>\r\n                    <FaFileAlt style={{ fontSize: 14, color: isDarkMode ? '#60A5FA' : '#3690CE' }} />\r\n                  </div>\r\n                  {showInlinePreview ? 'Preview' : 'Email body'}\r\n                </span>\r\n                <div style={{ display: 'inline-flex', gap: 8 }}>\r\n                  <button\r\n                    onClick={() => {\r\n                      if (showInlinePreview) {\r\n                        if (!previewRef.current) return;\r\n                        const text = previewRef.current.innerText || '';\r\n                        try {\r\n                          void navigator.clipboard.writeText(text);\r\n                        } catch {\r\n                          const ta = document.createElement('textarea');\r\n                          ta.value = text;\r\n                          document.body.appendChild(ta);\r\n                          ta.select();\r\n                          try { document.execCommand('copy'); } catch {}\r\n                          document.body.removeChild(ta);\r\n                        }\r\n                        setCopiedToolbar(true);\r\n                        setTimeout(() => setCopiedToolbar(false), 1200);\r\n                        return;\r\n                      }\r\n                      const plain = htmlToPlainText(body);\r\n                      try {\r\n                        void navigator.clipboard.writeText(plain);\r\n                      } catch {\r\n                        // Fallback\r\n                        const ta = document.createElement('textarea');\r\n                        ta.value = plain;\r\n                        document.body.appendChild(ta);\r\n                        ta.select();\r\n                        try { document.execCommand('copy'); } catch {}\r\n                        document.body.removeChild(ta);\r\n                      }\r\n                      setCopiedToolbar(true);\r\n                      setTimeout(() => setCopiedToolbar(false), 1200);\r\n                    }}\r\n                    style={{\r\n                      padding: '10px 16px',\r\n                      fontSize: '12px',\r\n                      borderRadius: '10px',\r\n                      border: copiedToolbar \r\n                        ? '1px solid #16a34a' \r\n                        : `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(54, 144, 206, 0.3)'}`,\r\n                      color: copiedToolbar ? '#166534' : colours.blue,\r\n                      background: copiedToolbar\r\n                        ? (isDarkMode ? 'linear-gradient(135deg, rgba(22, 101, 52, 0.35) 0%, rgba(21, 128, 61, 0.25) 100%)' : 'linear-gradient(135deg, #e8f5e8 0%, #dcfce7 100%)')\r\n                        : (isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)'),\r\n                      cursor: 'pointer',\r\n                      fontFamily: 'inherit',\r\n                      fontWeight: 600,\r\n                      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      gap: 6,\r\n                      boxShadow: copiedToolbar\r\n                        ? '0 4px 12px rgba(22, 163, 74, 0.28)'\r\n                        : (isDarkMode\r\n                          ? '0 8px 16px rgba(4, 9, 20, 0.5)'\r\n                          : '0 4px 12px rgba(13, 47, 96, 0.12)'),\r\n                      backdropFilter: 'blur(6px)'\r\n                    }}\r\n                    onMouseEnter={(e) => {\r\n                      if (!copiedToolbar) {\r\n                        e.currentTarget.style.background = isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(13, 28, 56, 0.94) 0%, rgba(17, 36, 64, 0.9) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(54, 144, 206, 0.26) 0%, rgba(96, 165, 250, 0.32) 100%)';\r\n                        e.currentTarget.style.transform = 'translateY(-1px)';\r\n                        e.currentTarget.style.boxShadow = isDarkMode\r\n                          ? '0 10px 20px rgba(10, 20, 40, 0.55)'\r\n                          : '0 6px 16px rgba(54, 144, 206, 0.24)';\r\n                      }\r\n                    }}\r\n                    onMouseLeave={(e) => {\r\n                      if (!copiedToolbar) {\r\n                        e.currentTarget.style.background = isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(11, 22, 43, 0.88) 0%, rgba(13, 30, 56, 0.82) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(54, 144, 206, 0.18) 0%, rgba(96, 165, 250, 0.24) 100%)';\r\n                        e.currentTarget.style.transform = 'translateY(0)';\r\n                        e.currentTarget.style.boxShadow = isDarkMode\r\n                          ? '0 6px 14px rgba(4, 9, 20, 0.6)'\r\n                          : '0 4px 10px rgba(13, 47, 96, 0.16)';\r\n                      }\r\n                    }}\r\n                    title={showInlinePreview ? 'Copy preview text' : 'Copy plain text'}\r\n                  >\r\n                    {copiedToolbar ? (\r\n                      <>\r\n                        <FaCheck style={{ fontSize: 12 }} /> Copied\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <FaCopy style={{ fontSize: 12 }} /> Copy\r\n                      </>\r\n                    )}\r\n                  </button>\r\n                  <button\r\n                    onClick={() => setShowInlinePreview(v => !v)}\r\n                    style={{\r\n                      padding: '10px 16px',\r\n                      fontSize: '12px',\r\n                      borderRadius: '10px',\r\n                      border: showInlinePreview\r\n                        ? `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(54, 144, 206, 0.3)'}`\r\n                        : `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.55)' : 'rgba(54, 144, 206, 0.55)'}`,\r\n                      color: showInlinePreview ? colours.blue : '#ffffff',\r\n                      background: showInlinePreview\r\n                        ? (isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)')\r\n                        : 'linear-gradient(135deg, #3690CE 0%, #60A5FA 100%)',\r\n                      cursor: 'pointer',\r\n                      fontFamily: 'inherit',\r\n                      fontWeight: showInlinePreview ? 600 : 700,\r\n                      transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      gap: 6,\r\n                      boxShadow: showInlinePreview\r\n                        ? (isDarkMode ? '0 8px 16px rgba(4, 9, 20, 0.5)' : '0 4px 12px rgba(13, 47, 96, 0.12)')\r\n                        : '0 6px 16px rgba(54, 144, 206, 0.22)',\r\n                      backdropFilter: 'blur(6px)'\r\n                    }}\r\n                    onMouseEnter={(e) => {\r\n                      if (showInlinePreview) {\r\n                        e.currentTarget.style.borderColor = colours.blue;\r\n                        e.currentTarget.style.color = colours.blue;\r\n                        e.currentTarget.style.background = isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.34) 0%, rgba(59, 130, 246, 0.28) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(54, 144, 206, 0.26) 0%, rgba(96, 165, 250, 0.28) 100%)';\r\n                        e.currentTarget.style.boxShadow = isDarkMode\r\n                          ? '0 10px 20px rgba(10, 20, 40, 0.55)'\r\n                          : '0 6px 16px rgba(54, 144, 206, 0.24)';\r\n                      } else {\r\n                        e.currentTarget.style.background = 'linear-gradient(135deg, #2F7DC2 0%, #539EF0 100%)';\r\n                        e.currentTarget.style.boxShadow = '0 8px 18px rgba(54, 144, 206, 0.25)';\r\n                      }\r\n                      e.currentTarget.style.transform = 'translateY(-1px)';\r\n                    }}\r\n                    onMouseLeave={(e) => {\r\n                      if (showInlinePreview) {\r\n                        e.currentTarget.style.borderColor = isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(54, 144, 206, 0.3)';\r\n                        e.currentTarget.style.color = colours.blue;\r\n                        e.currentTarget.style.background = isDarkMode\r\n                          ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n                          : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)';\r\n                        e.currentTarget.style.boxShadow = isDarkMode ? '0 8px 16px rgba(4, 9, 20, 0.5)' : '0 4px 12px rgba(13, 47, 96, 0.12)';\r\n                      } else {\r\n                        e.currentTarget.style.background = 'linear-gradient(135deg, #3690CE 0%, #60A5FA 100%)';\r\n                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(54, 144, 206, 0.22)';\r\n                      }\r\n                      e.currentTarget.style.transform = 'translateY(0)';\r\n                    }}\r\n                    title=\"Toggle inline preview\"\r\n                  >\r\n                    <FaEye style={{ fontSize: 12 }} /> {showInlinePreview ? 'Back to editor' : 'Preview'}\r\n                  </button>\r\n                </div>\r\n              </div>\r\n              {!showInlinePreview && (\r\n                <div className=\"smooth-appear\" style={{\r\n                  border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                  borderRadius: '12px',\r\n                  background: isDarkMode\r\n                    ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.88) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                  padding: '0',\r\n                  position: 'relative',\r\n                  overflow: 'hidden',\r\n                  boxShadow: isDarkMode ? '0 12px 28px rgba(4, 9, 20, 0.6)' : '0 8px 20px rgba(13, 47, 96, 0.14)',\r\n                  backdropFilter: 'blur(10px)'\r\n                }}>\r\n                  {/* Watermark */}\r\n                  <div aria-hidden=\"true\" style={{ position: 'absolute', top: 8, right: 8, width: 150, height: 150, opacity: 0.06, backgroundImage: `url(${markUrl})`, backgroundRepeat: 'no-repeat', backgroundPosition: 'top right', backgroundSize: 'contain', pointerEvents: 'none', zIndex: 1 }} />\r\n                  \r\n                  {/* Rich Text Formatting Toolbar */}\r\n                  <div style={{ \r\n                    borderBottom: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.2)' : 'rgba(148, 163, 184, 0.15)'}`,\r\n                      position: 'relative',\r\n                      zIndex: 2\r\n                    }}>\r\n                      <FormattingToolbar\r\n                        isDarkMode={isDarkMode}\r\n                        onFormatChange={handleFormatCommand}\r\n                        editorRef={bodyEditorRef}\r\n                        style={{\r\n                          border: 'none',\r\n                          borderRadius: '12px 12px 0 0',\r\n                          backgroundColor: 'transparent'\r\n                        }}\r\n                      />\r\n                    </div>\r\n                  \r\n                  <div style={{ padding: '10px' }}>\r\n                    <InlineEditableArea\r\n                      value={body}\r\n                      onChange={(v) => setBody(v)}\r\n                      edited={false}\r\n                      minHeight={140}\r\n                      externalHighlights={undefined}\r\n                      allReplacedRanges={allBodyReplacedRanges}\r\n                      passcode={passcode}\r\n                      enquiry={enquiry}\r\n                      isDarkMode={isDarkMode}\r\n                      richTextMode={richTextMode}\r\n                      bodyEditorRef={bodyEditorRef}\r\n                      handleFormatCommand={handleFormatCommand}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {showInlinePreview && (\r\n                <div className=\"smooth-appear\" style={{\r\n                marginTop: 12,\r\n                border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                borderRadius: '12px',\r\n                background: isDarkMode\r\n                  ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.88) 100%)'\r\n                  : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                overflow: 'hidden',\r\n                position: 'relative',\r\n                boxShadow: isDarkMode ? '0 12px 28px rgba(4, 9, 20, 0.6)' : '0 8px 20px rgba(13, 47, 96, 0.14)',\r\n                backdropFilter: 'blur(10px)'\r\n              }}>\r\n                {/* Watermark */}\r\n                <div aria-hidden=\"true\" style={{ position: 'absolute', top: 10, right: 10, width: 160, height: 160, opacity: isDarkMode ? 0.08 : 0.08, backgroundImage: `url(${markUrl})`, backgroundRepeat: 'no-repeat', backgroundPosition: 'top right', backgroundSize: 'contain', pointerEvents: 'none' }} />\r\n                <div style={{\r\n                  padding: '12px 16px',\r\n                  background: isDarkMode\r\n                    ? 'linear-gradient(135deg, rgba(11, 30, 55, 0.92) 0%, rgba(15, 38, 68, 0.85) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(240, 249, 255, 0.85) 0%, rgba(219, 234, 254, 0.8) 100%)',\r\n                  borderBottom: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.25)' : 'rgba(148, 163, 184, 0.2)'}`,\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: 8,\r\n                  backdropFilter: 'blur(8px)'\r\n                }}>\r\n                  <span style={{ fontSize: 12, fontWeight: 700, color: isDarkMode ? '#E0F2FE' : '#0F172A', letterSpacing: 0.6, textTransform: 'uppercase' }}>Inline Preview</span>\r\n                  <span style={{ marginLeft: 'auto', fontSize: 11, color: isDarkMode ? 'rgba(224, 242, 254, 0.7)' : colours.blue }}>{subject || 'Your Enquiry - Helix Law'}</span>\r\n                </div>\r\n                <div \r\n                  ref={previewRef} \r\n                  className={`email-preview ${isDarkMode ? 'dark-mode' : 'light-mode'}`}\r\n                  style={{ \r\n                    padding: '18px 20px',\r\n                    background: isDarkMode\r\n                      ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.92) 0%, rgba(11, 30, 55, 0.86) 100%)'\r\n                      : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                    color: isDarkMode ? '#E0F2FE' : '#1F2937',\r\n                    lineHeight: 1.6,\r\n                    fontSize: '14px',\r\n                    borderRadius: '0 0 12px 12px',\r\n                    border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                    borderTop: 'none',\r\n                    boxShadow: isDarkMode \r\n                      ? '0 8px 16px rgba(4, 9, 20, 0.5)' \r\n                      : '0 4px 12px rgba(13, 47, 96, 0.1)',\r\n                    backdropFilter: 'blur(8px)',\r\n                    // Ensure proper text selection visibility\r\n                    WebkitUserSelect: 'text',\r\n                    userSelect: 'text'\r\n                  }}>\r\n                  {(() => {\r\n                    // Build preview HTML with substitutions and signature\r\n                    const withoutAutoBlocks = stripDashDividers(body || '');\r\n                    const userDataLocal = (typeof userData !== 'undefined') ? userData : undefined;\r\n                    const enquiryLocal = (typeof enquiry !== 'undefined') ? enquiry : undefined;\r\n                    const sanitized = withoutAutoBlocks.replace(/\\r\\n/g, '\\n').replace(/\\n/g, '<br />');\r\n                    // Use passcode in preview URL if available\r\n                    const substituted = applyDynamicSubstitutions(\r\n                      sanitized,\r\n                      userDataLocal,\r\n                      enquiryLocal,\r\n                      amount,\r\n                      passcode || undefined,\r\n                      undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n                    );\r\n                    const unresolvedBody = findPlaceholders(substituted);\r\n                    const finalBody = convertDoubleBreaksToParagraphs(substituted);\r\n                    const finalHighlighted = highlightPlaceholdersHtml(finalBody);\r\n                    // Normalize any Instruct Helix Law anchors to use the project's highlight colour but preserve original href\r\n                    const styledFinalHighlighted = finalHighlighted.replace(/<a\\s+href=\"([^\"]+)\"[^>]*>\\s*Instruct\\s+Helix\\s+Law\\s*<\\/a>/gi, (m, href) => {\r\n                      const safe = escapeHtml(href);\r\n                      return `<a href=\"${safe}\" style=\"color:${colours.highlight};font-weight:700;text-decoration:underline\">Instruct Helix Law</a>`;\r\n                    });\r\n                    return (\r\n                      <>\r\n                        {unresolvedBody.length > 0 && (\r\n                          <div style={{\r\n                            background: isDarkMode\r\n                              ? 'linear-gradient(135deg, rgba(185, 28, 28, 0.2) 0%, rgba(153, 27, 27, 0.15) 100%)'\r\n                              : 'linear-gradient(135deg, #fff1f0 0%, #fef2f2 100%)',\r\n                            border: `1px solid ${isDarkMode ? 'rgba(248, 113, 113, 0.4)' : '#ffa39e'}`,\r\n                            color: isDarkMode ? '#FCA5A5' : '#a8071a',\r\n                            fontSize: 12,\r\n                            padding: '10px 12px',\r\n                            borderRadius: 8,\r\n                            marginBottom: 10,\r\n                            boxShadow: isDarkMode \r\n                              ? '0 4px 12px rgba(185, 28, 28, 0.25)' \r\n                              : '0 2px 8px rgba(168, 7, 26, 0.15)',\r\n                            backdropFilter: 'blur(6px)',\r\n                            fontWeight: 500\r\n                          }}>\r\n                            <FaExclamationTriangle style={{ fontSize: 12, color: isDarkMode ? '#FCA5A5' : '#a8071a', marginRight: 6 }} />\r\n                            {unresolvedBody.length} placeholder{unresolvedBody.length === 1 ? '' : 's'} to resolve: {unresolvedBody.join(', ')}\r\n                          </div>\r\n                        )}\r\n                        {(() => {\r\n                          // Determine if we should use experimental V2 layout (same logic as EmailPreview)\r\n                          const isV2Env = process.env.REACT_APP_EMAIL_V2_ENABLED === 'true';\r\n                          const useV2Layout = (window as any)?.__helixEmailProcessingV2__ === true || isV2Env;\r\n                          return <EmailSignature bodyHtml={styledFinalHighlighted} userData={userDataLocal} experimentalLayout={useV2Layout} />;\r\n                        })()}\r\n                      </>\r\n                    );\r\n                  })()}\r\n                </div>\r\n                <div style={{\r\n                  padding: '12px 16px',\r\n                  background: isDarkMode\r\n                    ? 'linear-gradient(135deg, rgba(11, 30, 55, 0.92) 0%, rgba(15, 38, 68, 0.85) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(240, 249, 255, 0.85) 0%, rgba(219, 234, 254, 0.8) 100%)',\r\n                  borderTop: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.25)' : 'rgba(148, 163, 184, 0.2)'}`,\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: 12,\r\n                  flexWrap: 'wrap',\r\n                  backdropFilter: 'blur(8px)'\r\n                }}>\r\n                  <div style={{ \r\n                    display: 'inline-flex', \r\n                    alignItems: 'center', \r\n                    gap: 12, \r\n                    padding: '12px 16px',\r\n                    background: confirmReady \r\n                      ? (isDarkMode ? 'rgba(34, 197, 94, 0.15)' : 'rgba(34, 197, 94, 0.1)') \r\n                      : (isDarkMode ? 'rgba(148, 163, 184, 0.1)' : 'rgba(148, 163, 184, 0.05)'),\r\n                    border: confirmReady \r\n                      ? `2px solid ${isDarkMode ? '#22c55e' : '#16a34a'}` \r\n                      : `2px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.3)' : 'rgba(148, 163, 184, 0.2)'}`,\r\n                    borderRadius: '10px',\r\n                    cursor: 'pointer',\r\n                    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                    transform: confirmReady ? 'translateY(-1px)' : 'none',\r\n                    boxShadow: confirmReady \r\n                      ? (isDarkMode ? '0 4px 16px rgba(34, 197, 94, 0.3)' : '0 4px 16px rgba(34, 197, 94, 0.2)') \r\n                      : 'none'\r\n                  }}\r\n                  onClick={() => setConfirmReady(!confirmReady)}\r\n                  >\r\n                    <div style={{\r\n                      width: '20px',\r\n                      height: '20px',\r\n                      borderRadius: '4px',\r\n                      background: confirmReady \r\n                        ? (isDarkMode ? '#22c55e' : '#16a34a') \r\n                        : 'transparent',\r\n                      border: confirmReady \r\n                        ? 'none' \r\n                        : `2px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.4)' : 'rgba(148, 163, 184, 0.3)'}`,\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      justifyContent: 'center',\r\n                      transition: 'all 0.2s ease'\r\n                    }}>\r\n                      {confirmReady && (\r\n                        <svg width=\"12\" height=\"9\" viewBox=\"0 0 12 9\" fill=\"none\">\r\n                          <path \r\n                            d=\"M1 4L5 8L11 1\" \r\n                            stroke=\"white\" \r\n                            strokeWidth=\"2\" \r\n                            strokeLinecap=\"round\" \r\n                            strokeLinejoin=\"round\"\r\n                          />\r\n                        </svg>\r\n                      )}\r\n                    </div>\r\n                    <span style={{ \r\n                      fontSize: '14px', \r\n                      color: isDarkMode ? '#E2E8F0' : '#334155', \r\n                      fontWeight: 600,\r\n                      userSelect: 'none'\r\n                    }}>\r\n                      Everything looks good, ready to proceed\r\n                    </span>\r\n                  </div>\r\n                  <div style={{ marginLeft: 'auto', display: 'flex', gap: 8, position: 'relative' }}>\r\n                    {(() => {\r\n                      // Determine unresolved placeholders across subject and body after substitution\r\n                      const userDataLocal = (typeof userData !== 'undefined') ? userData : undefined;\r\n                      const enquiryLocal = (typeof enquiry !== 'undefined') ? enquiry : undefined;\r\n                      // Subject is independent; treat it directly\r\n                      const unresolvedSubject = findPlaceholders(subject || '');\r\n                      const sanitized = stripDashDividers(body || '').replace(/\\r\\n/g, '\\n').replace(/\\n/g, '<br />');\r\n                      const effective = passcode || undefined; // no fallback\r\n                      const checkoutPreviewUrl = 'https://instruct.helix-law.com/pitch';\r\n                      const substitutedBody = applyDynamicSubstitutions(sanitized, userDataLocal, enquiryLocal, amount, effective, checkoutPreviewUrl);\r\n                      const unresolvedBody = findPlaceholders(substitutedBody);\r\n                      const unresolvedAny = unresolvedSubject.length > 0 || unresolvedBody.length > 0;\r\n                      const disableDraft = !confirmReady || isDraftConfirmed || unresolvedAny;\r\n                      const draftVisualConfirmed = isDraftConfirmed && !hasSentEmail;\r\n                      const missingServiceSummary = !scopeDescription || !String(scopeDescription).trim();\r\n                      const requireServiceSummary = !isBeforeCallCall; // not required for Before call — Call\r\n                      const disableSend = unresolvedAny || (requireServiceSummary && missingServiceSummary);\r\n                      const sendBtnTitle = unresolvedAny\r\n                        ? 'Resolve placeholders before sending'\r\n                        : ((requireServiceSummary && missingServiceSummary) ? 'Service summary is required' : 'Send Email');\r\n                      return (\r\n                        <>\r\n                          <button\r\n                            onClick={() => {\r\n                              // Always route through processing selector to keep behavior consistent\r\n                              setProcessingDialogAction('send');\r\n                              setShowEmailProcessingDialog(true);\r\n                            }}\r\n                            disabled={disableSend}\r\n                            title={sendBtnTitle}\r\n                            style={{\r\n                              padding: '12px 20px', \r\n                              borderRadius: '10px', \r\n                              border: 'none', \r\n                              cursor: disableSend ? 'not-allowed' : 'pointer',\r\n                              background: disableSend \r\n                                ? (isDarkMode ? 'rgba(148, 163, 184, 0.3)' : 'rgba(148, 163, 184, 0.2)') \r\n                                : `linear-gradient(135deg, ${colours.cta}, #e74c3c)`,\r\n                              color: '#ffffff', \r\n                              fontWeight: 700, \r\n                              fontSize: '14px',\r\n                              opacity: disableSend ? 0.6 : 1,\r\n                              transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                              transform: disableSend ? 'none' : 'translateY(0px)',\r\n                              boxShadow: disableSend \r\n                                ? 'none' \r\n                                : `0 4px 20px rgba(214, 85, 65, 0.4)`,\r\n                              letterSpacing: '0.02em',\r\n                              textTransform: 'uppercase',\r\n                              position: 'relative',\r\n                              overflow: 'hidden'\r\n                            }}\r\n                            onMouseEnter={(e) => {\r\n                              if (disableSend) {\r\n                                setShowSendValidation(true);\r\n                              } else {\r\n                                e.currentTarget.style.transform = 'translateY(-2px)';\r\n                                e.currentTarget.style.boxShadow = `0 8px 30px rgba(214, 85, 65, 0.6)`;\r\n                                e.currentTarget.style.background = `linear-gradient(135deg, #c54a3d, #d63031)`;\r\n                              }\r\n                            }}\r\n                            onMouseLeave={(e) => {\r\n                              if (disableSend) {\r\n                                setShowSendValidation(false);\r\n                              } else {\r\n                                e.currentTarget.style.transform = 'translateY(0px)';\r\n                                e.currentTarget.style.boxShadow = `0 4px 20px rgba(214, 85, 65, 0.4)`;\r\n                                e.currentTarget.style.background = `linear-gradient(135deg, ${colours.cta}, #e74c3c)`;\r\n                              }\r\n                            }}\r\n                          >\r\n                            <FaPaperPlane style={{ marginRight: 6 }} /> Send Email...\r\n                          </button>\r\n                          <button\r\n                            onClick={() => {\r\n                              // Open processing selection for draft as well (dev shows choice, prod auto-selects V1)\r\n                              setProcessingDialogAction('draft');\r\n                              setShowEmailProcessingDialog(true);\r\n                            }}\r\n                            disabled={disableDraft}\r\n                            style={{\r\n                              padding: '8px 16px', \r\n                              borderRadius: 6, \r\n                              border: `1px solid ${draftVisualConfirmed ? colours.green : (isDarkMode ? '#475569' : '#D1D5DB')}`,\r\n                              background: draftVisualConfirmed\r\n                                ? 'rgba(34, 197, 94, 0.1)'\r\n                                : (isDarkMode ? '#374151' : '#F9FAFB'), \r\n                              color: draftVisualConfirmed ? colours.green : (isDarkMode ? '#E5E7EB' : '#374151'), \r\n                              fontWeight: 600,\r\n                              cursor: disableDraft ? 'not-allowed' : 'pointer',\r\n                              transition: 'background-color 0.2s ease',\r\n                              opacity: disableDraft ? 0.6 : 1\r\n                            }}\r\n                            onMouseEnter={(e) => {\r\n                              if (!disableDraft && !draftVisualConfirmed) {\r\n                                e.currentTarget.style.background = isDarkMode ? '#4B5563' : '#E5E7EB';\r\n                              }\r\n                            }}\r\n                            onMouseLeave={(e) => {\r\n                              if (!disableDraft && !draftVisualConfirmed) {\r\n                                e.currentTarget.style.background = isDarkMode ? '#374151' : '#F9FAFB';\r\n                              }\r\n                            }}\r\n                            title={draftVisualConfirmed ? 'Drafted' : (unresolvedAny ? 'Resolve placeholders before drafting' : 'Draft Email')}\r\n                          >\r\n                            {draftVisualConfirmed ? <FaCheck style={{ marginRight: 4 }} /> : <FaEnvelope style={{ marginRight: 4 }} />} {draftVisualConfirmed ? 'Drafted' : 'Draft Email'}\r\n                          </button>\r\n                          \r\n                          {/* Validation feedback for disabled send button - shows on hover */}\r\n                          {disableSend && showSendValidation && (\r\n                            <div style={{\r\n                              position: 'absolute',\r\n                              top: '100%',\r\n                              right: 0,\r\n                              marginTop: 8,\r\n                              background: isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(254, 242, 242, 0.9)',\r\n                              border: `1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.2)'}`,\r\n                              borderRadius: 6,\r\n                              padding: '10px 14px',\r\n                              display: 'flex',\r\n                              alignItems: 'center',\r\n                              gap: 8,\r\n                              whiteSpace: 'nowrap',\r\n                              zIndex: 1000,\r\n                              boxShadow: isDarkMode \r\n                                ? '0 4px 12px rgba(0, 0, 0, 0.4)' \r\n                                : '0 4px 12px rgba(0, 0, 0, 0.1)',\r\n                              opacity: 1,\r\n                              animation: 'fadeIn 0.15s ease-out'\r\n                            }}>\r\n                              <div style={{\r\n                                width: 16,\r\n                                height: 16,\r\n                                borderRadius: '50%',\r\n                                background: isDarkMode ? '#EF4444' : '#DC2626',\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                justifyContent: 'center',\r\n                                color: '#ffffff',\r\n                                fontSize: 10,\r\n                                fontWeight: 700,\r\n                                flexShrink: 0\r\n                              }}>!</div>\r\n                              <div style={{\r\n                                fontSize: 13,\r\n                                fontWeight: 500,\r\n                                color: isDarkMode ? '#FEE2E2' : '#991B1B'\r\n                              }}>\r\n                                {unresolvedAny \r\n                                  ? 'Please resolve all highlighted placeholders before sending the email.'\r\n                                  : 'Scope of Work missing.'\r\n                                }\r\n                              </div>\r\n                            </div>\r\n                          )}\r\n                        </>\r\n                      );\r\n                    })()}\r\n                    <button\r\n                      onClick={() => {\r\n                        if (!previewRef.current) return;\r\n                        const text = previewRef.current.innerText || '';\r\n                        navigator.clipboard.writeText(text);\r\n                        setCopiedFooter(true);\r\n                        setTimeout(() => setCopiedFooter(false), 1200);\r\n                      }}\r\n                      style={{ \r\n                        padding: '6px 12px', \r\n                        borderRadius: 8, \r\n                        border: copiedFooter ? '1px solid #16a34a' : `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.45)' : 'rgba(54, 144, 206, 0.45)'}`, \r\n                        background: copiedFooter\r\n                          ? (isDarkMode ? 'linear-gradient(135deg, rgba(22, 101, 52, 0.35) 0%, rgba(21, 128, 61, 0.25) 100%)' : 'linear-gradient(135deg, #e8f5e8 0%, #dcfce7 100%)')\r\n                          : (isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(11, 22, 43, 0.88) 0%, rgba(13, 30, 56, 0.82) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(54, 144, 206, 0.18) 0%, rgba(96, 165, 250, 0.24) 100%)'), \r\n                        color: copiedFooter ? '#166534' : (isDarkMode ? '#E0F2FE' : '#0F172A'), \r\n                        fontWeight: 600,\r\n                        cursor: 'pointer',\r\n                        transition: 'all 0.2s ease',\r\n                        transform: 'translateY(0)'\r\n                      }}\r\n                      onMouseEnter={(e) => {\r\n                        if (!copiedFooter) {\r\n                          e.currentTarget.style.borderColor = isDarkMode ? '#60A5FA' : '#3690CE';\r\n                          e.currentTarget.style.background = isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(13, 28, 56, 0.92) 0%, rgba(17, 36, 64, 0.88) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(54, 144, 206, 0.26) 0%, rgba(96, 165, 250, 0.32) 100%)';\r\n                          e.currentTarget.style.color = isDarkMode ? '#F8FAFC' : '#0F172A';\r\n                          e.currentTarget.style.transform = 'translateY(-1px)';\r\n                          e.currentTarget.style.boxShadow = '0 8px 18px rgba(54, 144, 206, 0.22)';\r\n                        }\r\n                      }}\r\n                      onMouseLeave={(e) => {\r\n                        if (!copiedFooter) {\r\n                          e.currentTarget.style.borderColor = isDarkMode ? 'rgba(96, 165, 250, 0.45)' : 'rgba(54, 144, 206, 0.45)';\r\n                          e.currentTarget.style.background = isDarkMode\r\n                            ? 'linear-gradient(135deg, rgba(11, 22, 43, 0.88) 0%, rgba(13, 30, 56, 0.82) 100%)'\r\n                            : 'linear-gradient(135deg, rgba(54, 144, 206, 0.18) 0%, rgba(96, 165, 250, 0.24) 100%)';\r\n                          e.currentTarget.style.color = isDarkMode ? '#E0F2FE' : '#0F172A';\r\n                          e.currentTarget.style.transform = 'translateY(0)';\r\n                          e.currentTarget.style.boxShadow = 'none';\r\n                        }\r\n                      }}\r\n                      onMouseDown={(e) => {\r\n                        if (!copiedFooter) {\r\n                          e.currentTarget.style.transform = 'translateY(1px)';\r\n                          e.currentTarget.style.boxShadow = '0 1px 2px rgba(54, 144, 206, 0.1)';\r\n                        }\r\n                      }}\r\n                      onMouseUp={(e) => {\r\n                        if (!copiedFooter) {\r\n                          e.currentTarget.style.transform = 'translateY(-1px)';\r\n                          e.currentTarget.style.boxShadow = '0 2px 4px rgba(54, 144, 206, 0.15)';\r\n                        }\r\n                      }}\r\n                    >\r\n                      {copiedFooter ? (\r\n                        <>\r\n                          <FaCheck style={{ marginRight: 4 }} /> Copied\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <FaCopy style={{ marginRight: 4 }} /> Copy\r\n                        </>\r\n                      )}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              )}\r\n\r\n              {/* Close Email body / Preview container */}\r\n            </div>\r\n\r\n            {/* Context Notes - Supporting Information */}\r\n            {initialNotes && !isNotesPinned && (\r\n              <div style={{\r\n                background: isDarkMode\r\n                  ? 'linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%)'\r\n                  : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.94) 100%)',\r\n                borderRadius: '16px',\r\n                padding: '24px',\r\n                border: `1px solid ${isDarkMode ? 'rgba(125, 211, 252, 0.24)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                boxShadow: isDarkMode \r\n                  ? '0 18px 32px rgba(2, 6, 17, 0.58)' \r\n                  : '0 12px 28px rgba(13, 47, 96, 0.12)',\r\n                marginBottom: '20px',\r\n                transition: 'all 0.3s ease-in-out',\r\n                position: 'relative',\r\n                fontFamily: 'Raleway, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif',\r\n                backdropFilter: 'blur(12px)',\r\n                animation: 'cascadeIn 0.4s ease-out'\r\n              }}>\r\n                <div style={{\r\n                  fontSize: '14px',\r\n                  fontWeight: 600,\r\n                  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                  marginBottom: '16px',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: '8px',\r\n                  position: 'relative',\r\n                  padding: '12px 18px',\r\n                  background: isDarkMode\r\n                    ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.92) 0%, rgba(11, 30, 55, 0.86) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                  borderRadius: '12px',\r\n                  border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                  boxShadow: isDarkMode \r\n                    ? '0 10px 22px rgba(4, 9, 20, 0.55)' \r\n                    : '0 6px 16px rgba(13, 47, 96, 0.12)',\r\n                  backdropFilter: 'blur(8px)'\r\n                }}>\r\n                  <span\r\n                    onMouseEnter={() => setShowSubjectHint(true)}\r\n                    onMouseLeave={() => setShowSubjectHint(false)}\r\n                    style={{ display: 'inline-flex', alignItems: 'center', cursor: 'pointer' }}\r\n                  >\r\n                    <div style={{\r\n                      padding: '8px',\r\n                      background: isDarkMode \r\n                        ? 'linear-gradient(135deg, rgba(54, 144, 206, 0.24) 0%, rgba(59, 130, 246, 0.18) 100%)'\r\n                        : 'linear-gradient(135deg, rgba(54, 144, 206, 0.16) 0%, rgba(96, 165, 250, 0.18) 100%)',\r\n                      borderRadius: '8px',\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : 'rgba(54, 144, 206, 0.3)'}`\r\n                    }}>\r\n                      <FaInfoCircle style={{ fontSize: 14, color: isDarkMode ? '#60A5FA' : '#3690CE' }} />\r\n                    </div>\r\n                  </span>\r\n                  Enquiry Notes\r\n                  {showSubjectHint && (\r\n                    <span style={{\r\n                      position: 'absolute',\r\n                      left: 0,\r\n                      top: '100%',\r\n                      marginTop: 8,\r\n                      background: isDarkMode ? colours.dark.cardBackground : 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',\r\n                      color: isDarkMode ? colours.dark.text : '#1E293B',\r\n                      fontSize: '11px',\r\n                      fontWeight: 400,\r\n                      fontStyle: 'italic',\r\n                      border: `1px solid ${isDarkMode ? colours.dark.border : '#CBD5E1'}`,\r\n                      borderRadius: '8px',\r\n                      padding: '8px 12px',\r\n                      zIndex: 10,\r\n                      whiteSpace: 'normal',\r\n                      maxWidth: 420,\r\n                      boxShadow: isDarkMode ? '0 6px 10px rgba(0,0,0,0.6)' : '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'\r\n                    }}>\r\n                      Source confirmation: these notes may be intake rep call notes, a web form message, or an auto‑parsed email.\r\n                    </span>\r\n                  )}\r\n                </div>\r\n                <div style={{\r\n                  fontSize: '14px',\r\n                  lineHeight: 1.6,\r\n                  color: isDarkMode ? '#E0F2FE' : '#1F2937',\r\n                  whiteSpace: 'pre-wrap',\r\n                  background: isDarkMode\r\n                    ? 'linear-gradient(135deg, rgba(7, 16, 32, 0.92) 0%, rgba(11, 30, 55, 0.86) 100%)'\r\n                    : 'linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.92) 100%)',\r\n                  padding: '18px',\r\n                  borderRadius: '12px',\r\n                  border: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.3)' : 'rgba(148, 163, 184, 0.22)'}`,\r\n                  position: 'relative',\r\n                  fontFamily: 'inherit',\r\n                  boxShadow: isDarkMode \r\n                    ? '0 10px 22px rgba(4, 9, 20, 0.55)' \r\n                    : '0 6px 16px rgba(13, 47, 96, 0.12)',\r\n                  backdropFilter: 'blur(8px)'\r\n                }}>\r\n                  {/* Floating pin inside notes box */}\r\n                  <button\r\n                    onClick={() => setIsNotesPinned(true)}\r\n                    title=\"Pin notes\"\r\n                    style={{\r\n                      position: 'absolute',\r\n                      top: 10,\r\n                      right: 10,\r\n                      width: 32,\r\n                      height: 32,\r\n                      borderRadius: '50%',\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      justifyContent: 'center',\r\n                      background: isDarkMode ? colours.dark.cardBackground : 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',\r\n                      border: `1px solid ${isDarkMode ? colours.dark.border : '#CBD5E1'}`,\r\n                      color: isDarkMode ? colours.dark.text : '#1E293B',\r\n                      boxShadow: isDarkMode ? '0 2px 6px rgba(0,0,0,0.5)' : '0 2px 4px rgba(0,0,0,0.1)',\r\n                      cursor: 'pointer',\r\n                      zIndex: 2,\r\n                      transition: 'all 0.2s ease'\r\n                    }}\r\n                    onMouseEnter={(e) => {\r\n                      e.currentTarget.style.borderColor = isDarkMode ? colours.blue : '#3690CE';\r\n                      e.currentTarget.style.background = isDarkMode ? colours.dark.inputBackground : 'linear-gradient(135deg, #EBF8FF 0%, #DBEAFE 100%)';\r\n                      e.currentTarget.style.transform = 'scale(1.05)';\r\n                      e.currentTarget.style.boxShadow = isDarkMode ? '0 4px 8px rgba(0,0,0,0.5)' : '0 4px 8px rgba(54, 144, 206, 0.25)';\r\n                    }}\r\n                    onMouseLeave={(e) => {\r\n                      e.currentTarget.style.borderColor = isDarkMode ? colours.dark.border : '#CBD5E1';\r\n                      e.currentTarget.style.background = isDarkMode ? colours.dark.cardBackground : 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)';\r\n                      e.currentTarget.style.transform = 'scale(1)';\r\n                      e.currentTarget.style.boxShadow = isDarkMode ? '0 2px 6px rgba(0,0,0,0.5)' : '0 2px 4px rgba(0,0,0,0.1)';\r\n                    }}\r\n                  >\r\n                    {/* Use a known glyph and strong contrast to ensure visibility */}\r\n                    <FaThumbtack style={{ fontSize: 16, color: '#3690CE' }} />\r\n                  </button>\r\n                  {initialNotes}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {!isBeforeCallCall && (\r\n              <DealCapture\r\n                isDarkMode={isDarkMode}\r\n                scopeDescription={scopeDescription}\r\n                onScopeChange={(v) => { setScopeDescription(v); onScopeDescriptionChange?.(v); }}\r\n                amount={amountValue}\r\n                onAmountChange={(v) => { setAmountValue(v); onAmountChange?.(v); }}\r\n                amountError={amountError}\r\n              />\r\n            )}\r\n\r\n          {/* Template blocks removed in simplified flow */}\r\n          </div>\r\n        )}\r\n        </div>\r\n      </Stack>\r\n      </div>\r\n\r\n      {/* Additional styling for hover reveals and list styling */}\r\n      <style>{`\r\n        .inline-reveal-btn {display:inline-flex;align-items:center;gap:0;overflow:hidden;position:relative;}\r\n        .inline-reveal-btn .label{max-width:0;opacity:0;transform:translateX(-4px);margin-left:0;white-space:nowrap;transition:max-width .45s ease,opacity .45s ease,transform .45s ease,margin-left .45s ease;}\r\n        .inline-reveal-btn:hover .label,.inline-reveal-btn:focus-visible .label{max-width:90px;opacity:1;transform:translateX(0);margin-left:6px;}\r\n        @keyframes fadeSlideIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}\r\n        @keyframes cascadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}\r\n        .smooth-appear{animation:fadeSlideIn .18s ease}\r\n        \r\n        /* Preview text selection styling for dark mode */\r\n        [data-theme=\"dark\"] ::selection {\r\n          background-color: rgba(96, 165, 250, 0.3);\r\n          color: #E0F2FE;\r\n        }\r\n        [data-theme=\"light\"] ::selection {\r\n          background-color: rgba(54, 144, 206, 0.2);\r\n          color: #0F172A;\r\n        }\r\n        \r\n        /* Force proper text colors in preview mode (excluding signature) */\r\n        .email-preview.dark-mode p,\r\n        .email-preview.dark-mode div:not([class*=\"signature\"]) {\r\n          color: #E0F2FE !important;\r\n        }\r\n        .email-preview.light-mode p,\r\n        .email-preview.light-mode div:not([class*=\"signature\"]) {\r\n          color: #1F2937 !important;\r\n        }\r\n        \r\n        /* Ensure links remain visible and accessible */\r\n        .email-preview.dark-mode a {\r\n          color: #60A5FA !important;\r\n          text-decoration: underline !important;\r\n        }\r\n        .email-preview.light-mode a {\r\n          color: #3690CE !important;\r\n          text-decoration: underline !important;\r\n        }\r\n        \r\n        /* Improve text selection visibility in preview */\r\n        .email-preview.dark-mode ::selection {\r\n          background-color: rgba(96, 165, 250, 0.4) !important;\r\n          color: #FFFFFF !important;\r\n        }\r\n        .email-preview.light-mode ::selection {\r\n          background-color: rgba(54, 144, 206, 0.3) !important;\r\n          color: #000000 !important;\r\n        }\r\n        \r\n        /* Modern placeholder styling for email preview */\r\n        .email-preview .insert-placeholder,\r\n        .email-preview span[data-insert],\r\n        .email-preview span[data-original*=\"INSERT\"] {\r\n          background: linear-gradient(135deg, ${colours.highlight}08, ${colours.highlight}15) !important;\r\n          color: ${colours.highlight} !important;\r\n          padding: 2px 8px !important;\r\n          border-radius: 6px !important;\r\n          border: 1px solid ${colours.highlight}40 !important;\r\n          font-style: normal !important;\r\n          font-weight: 600 !important;\r\n          font-size: 0.9em !important;\r\n          letter-spacing: 0.025em !important;\r\n          cursor: default !important;\r\n          display: inline-block !important;\r\n          max-width: 100% !important;\r\n          word-wrap: break-word !important;\r\n          white-space: normal !important;\r\n          box-shadow: 0 1px 3px ${colours.highlight}15, 0 1px 2px ${colours.highlight}10 !important;\r\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\r\n        }\r\n        \r\n        .email-preview.dark-mode .insert-placeholder,\r\n        .email-preview.dark-mode span[data-insert],\r\n        .email-preview.dark-mode span[data-original*=\"INSERT\"] {\r\n          background: linear-gradient(135deg, ${colours.highlight}12, ${colours.highlight}20) !important;\r\n          border-color: ${colours.highlight}50 !important;\r\n          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2), 0 1px 2px ${colours.highlight}15 !important;\r\n        }\r\n        \r\n        .email-preview.light-mode .insert-placeholder,\r\n        .email-preview.light-mode span[data-insert],\r\n        .email-preview.light-mode span[data-original*=\"INSERT\"] {\r\n          background: linear-gradient(135deg, ${colours.highlight}08, ${colours.highlight}12) !important;\r\n          border-color: ${colours.highlight}35 !important;\r\n          box-shadow: 0 1px 3px ${colours.highlight}12, 0 1px 2px rgba(0, 0, 0, 0.05) !important;\r\n        }\r\n        \r\n        /* Override any inline styles on placeholders in preview */\r\n        .email-preview span[style*=\"background\"]:is([data-insert], [data-original*=\"INSERT\"], .insert-placeholder),\r\n        .email-preview span[style*=\"color\"]:is([data-insert], [data-original*=\"INSERT\"], .insert-placeholder),\r\n        .email-preview span[style*=\"background-color\"][data-placeholder],\r\n        .email-preview span[data-placeholder*=\"INSERT\"],\r\n        .email-preview span[contenteditable=\"true\"],\r\n        .email-preview span[contenteditable=\"false\"],\r\n        .email-preview .placeholder-edited {\r\n          background: linear-gradient(135deg, ${colours.highlight}08, ${colours.highlight}15) !important;\r\n          color: ${colours.highlight} !important;\r\n          padding: 2px 8px !important;\r\n          border-radius: 6px !important;\r\n          border: 1px solid ${colours.highlight}40 !important;\r\n          font-style: normal !important;\r\n          font-weight: 600 !important;\r\n          font-size: 0.9em !important;\r\n          letter-spacing: 0.025em !important;\r\n          cursor: default !important;\r\n          display: inline-block !important;\r\n          max-width: 100% !important;\r\n          word-wrap: break-word !important;\r\n          white-space: normal !important;\r\n          box-shadow: 0 1px 3px ${colours.highlight}15, 0 1px 2px ${colours.highlight}10 !important;\r\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\r\n        }\r\n        \r\n        /* Remove interactive attributes from preview placeholders */\r\n        .email-preview span[contenteditable=\"true\"],\r\n        .email-preview span[contenteditable=\"false\"],\r\n        .email-preview span[tabindex],\r\n        .email-preview span[role=\"button\"] {\r\n          cursor: default !important;\r\n          user-select: none !important;\r\n          pointer-events: none !important;\r\n        }\r\n\r\n        /* Unresolved placeholders: draw attention with CTA red only */\r\n        .email-preview .placeholder-unresolved {\r\n          color: ${colours.cta} !important;\r\n          font-weight: 700 !important;\r\n          background: transparent !important;\r\n          border: none !important;\r\n          padding: 0 !important;\r\n          box-shadow: none !important;\r\n        }\r\n        \r\n        /* Numbered list styling with CTA red numbers */\r\n        ol:not(.hlx-numlist) {\r\n          counter-reset: list-counter;\r\n          list-style: none;\r\n          padding-left: 0;\r\n          margin: 16px 0;\r\n        }\r\n        ol:not(.hlx-numlist) li {\r\n          counter-increment: list-counter;\r\n          position: relative;\r\n          padding-left: 2em;\r\n          margin-bottom: 12px;\r\n          line-height: 1.6;\r\n        }\r\n        ol:not(.hlx-numlist) li::before {\r\n          content: counter(list-counter) \".\";\r\n          position: absolute;\r\n          left: 0;\r\n          top: 0;\r\n          color: #D65541;\r\n          font-weight: 700;\r\n          margin: 0;\r\n        }\r\n        ol.hlx-numlist { list-style: none; padding-left: 0; margin: 16px 0; }\r\n        ol.hlx-numlist li { margin: 0 0 12px 0; line-height: 1.6; position: relative; }\r\n        ol.hlx-numlist li::before { content: none !important; }\r\n        ol.hlx-numlist > li > span:first-child { color: #D65541; font-weight: 700; display: inline-block; min-width: 1.6em; }\r\n        \r\n        /* Placeholder highlighting styles */\r\n        .insert-placeholder {\r\n          background: ${colours.highlightBlue}20;\r\n          color: ${isDarkMode ? '#E5E7EB' : colours.darkBlue};\r\n          padding: 1px 3px;\r\n          border-radius: 3px;\r\n          border: 1px dotted ${isDarkMode ? '#93C5FD' : colours.darkBlue + '60'};\r\n          font-style: italic;\r\n          cursor: pointer;\r\n          transition: all 0.15s ease;\r\n          display: inline-block;\r\n          max-width: 100%;\r\n          word-wrap: break-word;\r\n          white-space: normal;\r\n          font-size: 0.9em;\r\n          opacity: ${isDarkMode ? 0.95 : 0.85};\r\n        }\r\n        .insert-placeholder:hover,\r\n        .insert-placeholder:focus {\r\n          background: ${isDarkMode ? '#1E3A8A' : colours.blue + '40'};\r\n          color: ${isDarkMode ? '#F8FAFC' : colours.darkBlue};\r\n          border-color: ${isDarkMode ? '#60A5FA' : colours.blue};\r\n          box-shadow: 0 0 0 2px ${isDarkMode ? 'rgba(96, 165, 250, 0.35)' : colours.blue + '30'};\r\n          transform: translateY(-1px);\r\n          outline: none;\r\n          opacity: 1;\r\n        }\r\n        \r\n        /* Edited placeholder styles - green highlight for user feedback */\r\n        .placeholder-edited {\r\n          background: ${isDarkMode ? 'rgba(16, 185, 129, 0.18)' : 'rgba(34, 197, 94, 0.1)'} !important;\r\n          color: ${isDarkMode ? '#D1FAE5' : '#059669'} !important;\r\n          border: 1px solid ${isDarkMode ? 'rgba(16, 185, 129, 0.35)' : 'rgba(34, 197, 94, 0.3)'} !important;\r\n          font-style: normal !important;\r\n          cursor: text !important;\r\n          opacity: 1 !important;\r\n          transform: none !important;\r\n        }\r\n        .placeholder-edited:hover,\r\n        .placeholder-edited:focus {\r\n          background: rgba(34, 197, 94, 0.15) !important;\r\n          border-color: rgba(34, 197, 94, 0.5) !important;\r\n          box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2) !important;\r\n        }\r\n\r\n        /* Active editing wrapper */\r\n        .placeholder-editing {\r\n          background: ${isDarkMode ? 'rgba(54, 144, 206, 0.18)' : 'rgba(54, 144, 206, 0.1)'} !important;\r\n          border: 1px dashed ${isDarkMode ? 'rgba(96, 165, 250, 0.6)' : colours.blue} !important;\r\n          border-radius: 4px !important;\r\n          padding: 1px 2px !important;\r\n        }\r\n        \r\n        /* Link styles for rich text editor */\r\n        .rich-text-editor a {\r\n          color: ${colours.blue};\r\n          text-decoration: underline;\r\n          cursor: pointer;\r\n        }\r\n        .rich-text-editor a:hover {\r\n          color: ${colours.darkBlue};\r\n          text-decoration: none;\r\n        }\r\n        \r\n        /* Instruct Helix Law link styling */\r\n        .rich-text-editor .instruct-link {\r\n          color: ${colours.highlight} !important;\r\n          font-weight: 700 !important;\r\n          text-decoration: underline !important;\r\n          cursor: pointer;\r\n          transition: all 0.15s ease;\r\n        }\r\n        .rich-text-editor .instruct-link:hover {\r\n          color: ${colours.darkBlue} !important;\r\n          text-decoration: none !important;\r\n          transform: translateY(-1px);\r\n        }\r\n        \r\n        /* Pending link style (when passcode not available yet) */\r\n        .rich-text-editor .instruct-link-pending {\r\n          color: ${colours.highlight} !important;\r\n          font-weight: 700 !important;\r\n          text-decoration: underline !important;\r\n          opacity: 0.7 !important;\r\n          cursor: help !important;\r\n          font-style: italic;\r\n        }\r\n        .rich-text-editor .instruct-link-pending:hover {\r\n          opacity: 1 !important;\r\n        }\r\n        .rich-text-editor .instruct-link-pending::after {\r\n          content: \" (pending passcode)\";\r\n          font-size: 0.85em;\r\n          opacity: 0.8;\r\n          font-weight: 400;\r\n        }\r\n      `}</style>\r\n\r\n      {/* Email Processing Method Selection Dialog - Development Only */}\r\n      {showEmailProcessingDialog && (\r\n        <EmailProcessingConfirmDialog\r\n          isOpen={showEmailProcessingDialog}\r\n          onConfirm={(useV2: boolean) => {\r\n            // Persist choice and close selector\r\n            setSelectedEmailMethod(useV2 ? 'v2' : 'v1');\r\n            setShowEmailProcessingDialog(false);\r\n            const action = processingDialogAction || 'send';\r\n            if (action === 'send') {\r\n              // Proceed to the normal send confirmation modal\r\n              setShowSendConfirmModal(true);\r\n            } else {\r\n              // Draft flow: set processing flag, run draft, then clean up\r\n              try {\r\n                (window as any).__helixEmailProcessingV2__ = !!useV2;\r\n                void (async () => {\r\n                  try {\r\n                    await handleDraftEmail?.();\r\n                  } finally {\r\n                    delete (window as any).__helixEmailProcessingV2__;\r\n                    setSelectedEmailMethod(null);\r\n                  }\r\n                })();\r\n              } finally {\r\n                // Ensure we clear the action state so future opens default correctly\r\n                setProcessingDialogAction(null);\r\n              }\r\n            }\r\n          }}\r\n          onClose={() => setShowEmailProcessingDialog(false)}\r\n          action={processingDialogAction || 'send'}\r\n          isDarkMode={isDarkMode}\r\n        />\r\n      )}\r\n\r\n      {/* Email Send Confirmation Modal */}\r\n      {showSendConfirmModal && (\r\n        <div style={{\r\n          position: 'fixed',\r\n          top: 0,\r\n          left: 0,\r\n          right: 0,\r\n          bottom: 0,\r\n          backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.75)' : 'rgba(0, 0, 0, 0.5)',\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          zIndex: 10000\r\n        }}>\r\n          <div style={{\r\n            background: isDarkMode \r\n              ? '#1E293B'\r\n              : '#FFFFFF',\r\n            padding: '0',\r\n            borderRadius: '8px',\r\n            maxWidth: '580px',\r\n            width: '92%',\r\n            maxHeight: '85vh',\r\n            overflow: 'hidden',\r\n            boxShadow: isDarkMode \r\n              ? '0 10px 25px rgba(0, 0, 0, 0.5)' \r\n              : '0 10px 25px rgba(0, 0, 0, 0.15)',\r\n            border: isDarkMode \r\n              ? '1px solid rgba(148, 163, 184, 0.2)' \r\n              : '1px solid rgba(226, 232, 240, 0.8)',\r\n            display: 'flex',\r\n            flexDirection: 'column'\r\n          }}>\r\n            {/* Enhanced Header with Icon */}\r\n            <div style={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: '16px',\r\n              marginBottom: '24px',\r\n              paddingBottom: '20px',\r\n              padding: '32px 32px 20px 32px',\r\n              borderBottom: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.25)' : 'rgba(148, 163, 184, 0.2)'}`\r\n            }}>\r\n              <div style={{\r\n                width: '48px',\r\n                height: '48px',\r\n                borderRadius: '8px',\r\n                background: isDarkMode \r\n                  ? 'rgba(71, 85, 105, 0.3)'\r\n                  : 'rgba(241, 245, 249, 0.8)',\r\n                border: `1px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.25)' : 'rgba(203, 213, 225, 0.6)'}`,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                boxShadow: isDarkMode \r\n                  ? '0 4px 8px rgba(0, 0, 0, 0.2)' \r\n                  : '0 2px 6px rgba(0, 0, 0, 0.08)'\r\n              }}>\r\n                <FaPaperPlane style={{ \r\n                  fontSize: '20px', \r\n                  color: colours.blue\r\n                }} />\r\n              </div>\r\n              <div>\r\n                <h3 style={{\r\n                  margin: '0 0 4px 0',\r\n                  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                  fontSize: '24px',\r\n                  fontWeight: '700',\r\n                  letterSpacing: '-0.02em',\r\n                  lineHeight: '1.2'\r\n                }}>\r\n                  Review & Send Email\r\n                </h3>\r\n                <p style={{\r\n                  margin: 0,\r\n                  color: isDarkMode ? 'rgba(224, 242, 254, 0.7)' : '#64748B',\r\n                  fontSize: '14px',\r\n                  fontWeight: '500',\r\n                  letterSpacing: '-0.005em'\r\n                }}>\r\n                  Please review the details before sending\r\n                </p>\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Scrollable Content Area */}\r\n            <div style={{\r\n              flex: 1,\r\n              overflowY: 'auto',\r\n              padding: '0 32px',\r\n              maxHeight: 'calc(85vh - 160px)' // Leave space for header and buttons\r\n            }}>\r\n            \r\n            {/* Recipients Section - Enhanced Design */}\r\n            <div style={{ \r\n              marginBottom: '24px',\r\n              padding: '20px',\r\n              background: isDarkMode \r\n                ? 'rgba(30, 41, 59, 0.4)' \r\n                : 'rgba(248, 250, 252, 0.6)',\r\n              border: isDarkMode \r\n                ? '1px solid rgba(148, 163, 184, 0.2)' \r\n                : '1px solid rgba(226, 232, 240, 0.7)',\r\n              borderRadius: '8px',\r\n              backdropFilter: 'blur(4px)',\r\n              boxShadow: isDarkMode \r\n                ? '0 4px 8px rgba(0, 0, 0, 0.15)' \r\n                : '0 2px 6px rgba(0, 0, 0, 0.05)'\r\n            }}>\r\n              <div style={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '12px',\r\n                marginBottom: '18px'\r\n              }}>\r\n                <div style={{\r\n                  width: '32px',\r\n                  height: '32px',\r\n                  borderRadius: '6px',\r\n                  background: isDarkMode \r\n                    ? 'rgba(71, 85, 105, 0.4)'\r\n                    : 'rgba(241, 245, 249, 0.8)',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  border: `1px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.3)' : 'rgba(203, 213, 225, 0.6)'}`\r\n                }}>\r\n                  <FaUsers style={{ \r\n                    fontSize: '14px', \r\n                    color: colours.blue\r\n                  }} />\r\n                </div>\r\n                <h4 style={{\r\n                  margin: 0,\r\n                  fontSize: '18px',\r\n                  fontWeight: '650',\r\n                  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                  letterSpacing: '-0.01em'\r\n                }}>\r\n                  Email Recipients\r\n                </h4>\r\n              </div>\r\n\r\n              <div style={{ display: 'flex', flexDirection: 'column', gap: '14px' }}>\r\n                {/* Sender (From) field */}\r\n                <div style={{ \r\n                  display: 'flex', \r\n                  alignItems: 'flex-start',\r\n                  gap: '12px',\r\n                  padding: '10px 0',\r\n                  borderBottom: isDarkMode \r\n                    ? '1px solid rgba(71, 85, 105, 0.4)' \r\n                    : '1px solid rgba(226, 232, 240, 0.5)'\r\n                }}>\r\n                  <span style={{ \r\n                    fontWeight: '650', \r\n                    color: isDarkMode ? '#94A3B8' : '#64748B',\r\n                    fontSize: '13px',\r\n                    minWidth: '55px',\r\n                    letterSpacing: '0.025em',\r\n                    textTransform: 'uppercase'\r\n                  }}>From:</span>\r\n                  <span style={{ \r\n                    color: isDarkMode ? '#CBD5E1' : '#334155',\r\n                    fontSize: '14px',\r\n                    fontWeight: '500',\r\n                    flex: 1,\r\n                    lineHeight: '1.4'\r\n                  }}>\r\n                    {userData?.[0]?.['Full Name'] || [userData?.[0]?.First, userData?.[0]?.Last].filter(Boolean).join(' ') || 'Fee Earner'} ({userData?.[0]?.Email || userData?.[0]?.WorkEmail || userData?.[0]?.Mail || userData?.[0]?.UserPrincipalName || userData?.[0]?.['Email Address'] || (userData?.[0]?.Initials ? `${userData[0].Initials.toLowerCase()}@helix-law.com` : 'automations@helix-law.com')})\r\n                  </span>\r\n                </div>\r\n                \r\n                {/* Recipients - Editable To field */}\r\n                <div style={{ \r\n                  display: 'flex', \r\n                  alignItems: 'flex-start',\r\n                  gap: '12px',\r\n                  padding: '10px 0',\r\n                  borderBottom: isDarkMode \r\n                    ? '1px solid rgba(71, 85, 105, 0.4)' \r\n                    : '1px solid rgba(226, 232, 240, 0.5)'\r\n                }}>\r\n                  <span style={{ \r\n                    fontWeight: '650', \r\n                    color: isDarkMode ? '#94A3B8' : '#64748B',\r\n                    fontSize: '13px',\r\n                    minWidth: '55px',\r\n                    letterSpacing: '0.025em',\r\n                    textTransform: 'uppercase',\r\n                    paddingTop: '8px'\r\n                  }}>To:</span>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={editableTo}\r\n                    onChange={(e) => setEditableTo(e.target.value)}\r\n                    placeholder=\"Enter recipient email addresses...\"\r\n                    style={{\r\n                      flex: 1,\r\n                      padding: '8px 12px',\r\n                      border: `1px solid ${isDarkMode ? 'rgba(71, 85, 105, 0.4)' : 'rgba(226, 232, 240, 0.6)'}`,\r\n                      borderRadius: '6px',\r\n                      background: isDarkMode ? '#374151' : '#FFFFFF',\r\n                      color: isDarkMode ? '#F3F4F6' : '#1F2937',\r\n                      fontSize: '14px',\r\n                      fontWeight: '400',\r\n                      lineHeight: '1.4',\r\n                      outline: 'none',\r\n                      transition: 'border-color 0.2s ease, box-shadow 0.2s ease'\r\n                    }}\r\n                    onFocus={(e) => {\r\n                      e.target.style.borderColor = colours.blue;\r\n                      e.target.style.boxShadow = isDarkMode \r\n                        ? `0 0 0 1px rgba(54, 144, 206, 0.3)` \r\n                        : `0 0 0 1px rgba(54, 144, 206, 0.2)`;\r\n                    }}\r\n                    onBlur={(e) => {\r\n                      e.target.style.borderColor = isDarkMode ? 'rgba(71, 85, 105, 0.4)' : 'rgba(226, 232, 240, 0.6)';\r\n                      e.target.style.boxShadow = 'none';\r\n                    }}\r\n                  />\r\n                </div>\r\n                \r\n                {cc && (\r\n                  <div style={{ \r\n                    display: 'flex', \r\n                    alignItems: 'flex-start',\r\n                    gap: '12px',\r\n                    padding: '10px 0',\r\n                    borderBottom: isDarkMode \r\n                      ? '1px solid rgba(71, 85, 105, 0.4)' \r\n                      : '1px solid rgba(226, 232, 240, 0.5)'\r\n                  }}>\r\n                    <span style={{ \r\n                      fontWeight: '650', \r\n                      color: isDarkMode ? '#94A3B8' : '#64748B',\r\n                      fontSize: '13px',\r\n                      minWidth: '55px',\r\n                      letterSpacing: '0.025em',\r\n                      textTransform: 'uppercase'\r\n                    }}>CC:</span>\r\n                    <span style={{ \r\n                      color: isDarkMode ? '#CBD5E1' : '#334155',\r\n                      fontSize: '14px',\r\n                      fontWeight: '500',\r\n                      flex: 1,\r\n                      lineHeight: '1.4'\r\n                    }}>{cc}</span>\r\n                  </div>\r\n                )}\r\n                \r\n                {/* BCC field */}\r\n                <div style={{ \r\n                  display: 'flex', \r\n                  alignItems: 'flex-start',\r\n                  gap: '12px',\r\n                  padding: '10px 0'\r\n                }}>\r\n                  <span style={{ \r\n                    fontWeight: '650', \r\n                    color: isDarkMode ? '#94A3B8' : '#64748B',\r\n                    fontSize: '13px',\r\n                    minWidth: '55px',\r\n                    letterSpacing: '0.025em',\r\n                    textTransform: 'uppercase'\r\n                  }}>BCC:</span>\r\n                  <span style={{ \r\n                    color: isDarkMode ? '#CBD5E1' : '#334155',\r\n                    fontSize: '14px',\r\n                    fontWeight: '500',\r\n                    flex: 1,\r\n                    lineHeight: '1.4'\r\n                  }}>\r\n                    {[bcc, feeEarnerEmail].filter(Boolean).join(', ')}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Sent Items Confirmation - Passive Info */}\r\n            <div style={{\r\n              marginBottom: '20px',\r\n              padding: '16px 18px',\r\n              background: isDarkMode \r\n                ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(22, 163, 74, 0.06) 100%)'\r\n                : 'linear-gradient(135deg, rgba(34, 197, 94, 0.06) 0%, rgba(22, 163, 74, 0.04) 100%)',\r\n              border: isDarkMode \r\n                ? '1px solid rgba(34, 197, 94, 0.25)' \r\n                : '1px solid rgba(34, 197, 94, 0.2)',\r\n              borderRadius: '10px',\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: '12px'\r\n            }}>\r\n              <div style={{\r\n                width: '20px',\r\n                height: '20px',\r\n                borderRadius: '4px',\r\n                background: isDarkMode \r\n                  ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(22, 163, 74, 0.2) 100%)'\r\n                  : 'linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.15) 100%)',\r\n                border: `1px solid ${isDarkMode ? 'rgba(34, 197, 94, 0.4)' : 'rgba(34, 197, 94, 0.3)'}`,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                flexShrink: 0\r\n              }}>\r\n                <FaCheck style={{ \r\n                  fontSize: '10px', \r\n                  color: isDarkMode ? '#4ADE80' : '#16A34A'\r\n                }} />\r\n              </div>\r\n              <div style={{ flex: 1 }}>\r\n                <div style={{\r\n                  fontSize: '14px',\r\n                  fontWeight: '600',\r\n                  color: isDarkMode ? '#4ADE80' : '#15803D',\r\n                  marginBottom: '2px',\r\n                  letterSpacing: '-0.005em'\r\n                }}>\r\n                  Email will be saved to your Sent Items\r\n                </div>\r\n                <div style={{\r\n                  fontSize: '12px',\r\n                  color: isDarkMode ? 'rgba(74, 222, 128, 0.8)' : 'rgba(21, 128, 61, 0.7)',\r\n                  lineHeight: '1.3'\r\n                }}>\r\n                  A copy will automatically appear in your Outlook Sent Items folder\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            {/* Email Summary Section - Secondary (hidden for Before call — Call) */}\r\n            {!isBeforeCallCall && (\r\n              <div style={{\r\n                background: isDarkMode \r\n                  ? colours.dark.inputBackground \r\n                  : 'linear-gradient(135deg, #FEFEFE 0%, #F9FAFB 100%)',\r\n                border: `1px solid ${isDarkMode ? colours.dark.border : '#E5E7EB'}`,\r\n                borderRadius: '8px',\r\n                padding: '14px',\r\n                marginBottom: '16px'\r\n              }}>\r\n                <h4 style={{\r\n                  margin: '0 0 12px 0',\r\n                  fontSize: '16px',\r\n                  fontWeight: '600',\r\n                  color: isDarkMode ? colours.dark.text : colours.darkBlue,\r\n                  letterSpacing: '-0.005em'\r\n                }}>\r\n                  Email Content Summary\r\n                </h4>\r\n                \r\n                {/* Replace Subject with Service Description */}\r\n                {scopeDescription && (\r\n                  <div style={{ fontSize: '13px', marginBottom: '8px' }}>\r\n                    <span style={{ fontWeight: '600', color: isDarkMode ? colours.dark.text : '#6B7280' }}>Service Description:</span>\r\n                    <div style={{ \r\n                      marginTop: '4px',\r\n                      color: isDarkMode ? colours.dark.text : colours.darkBlue,\r\n                      lineHeight: '1.4',\r\n                      maxHeight: '60px',\r\n                      overflow: 'hidden',\r\n                      textOverflow: 'ellipsis'\r\n                    }}>\r\n                      {scopeDescription.length > 150 ? `${scopeDescription.substring(0, 150)}...` : scopeDescription}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                \r\n                {amountValue && (\r\n                  <div style={{ marginBottom: '8px', fontSize: '13px' }}>\r\n                    <span style={{ fontWeight: '600', color: isDarkMode ? colours.dark.text : '#6B7280' }}>Amount:</span>\r\n                    <div style={{ \r\n                      marginTop: '4px',\r\n                      color: isDarkMode ? colours.blue : colours.darkBlue,\r\n                      fontWeight: 600\r\n                    }}>\r\n                      £{parseFloat(amountValue).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} + VAT\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n            \r\n            {/* Debug/Support Info Box */}\r\n            <div style={{\r\n              background: isDarkMode \r\n                ? 'rgba(54, 144, 206, 0.1)' \r\n                : 'linear-gradient(135deg, rgba(54, 144, 206, 0.03) 0%, rgba(96, 165, 250, 0.08) 100%)',\r\n              border: `1px solid ${isDarkMode ? 'rgba(54, 144, 206, 0.3)' : 'rgba(54, 144, 206, 0.15)'}`,\r\n              borderRadius: '8px',\r\n              padding: '12px',\r\n              marginBottom: '24px',\r\n              fontSize: '13px',\r\n              fontFamily: 'Raleway, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif'\r\n            }}>\r\n              <h4 style={{\r\n                margin: '0 0 12px 0',\r\n                fontSize: '16px',\r\n                fontWeight: '600',\r\n                color: isDarkMode ? colours.dark.text : colours.darkBlue,\r\n                letterSpacing: '-0.005em'\r\n              }}>\r\n                Support BCC (auto-added)\r\n              </h4>\r\n              <div style={{ \r\n                color: isDarkMode ? colours.blue : colours.darkBlue,\r\n                fontFamily: 'inherit',\r\n                fontSize: '12px',\r\n                fontWeight: '500'\r\n              }}>\r\n                cb@helix-law.com\r\n              </div>\r\n            </div>\r\n\r\n            {/* Processing Status Section */}\r\n            <div style={{\r\n              background: isDarkMode ? '#374151' : '#F9FAFB',\r\n              border: isDarkMode ? '1px solid #4B5563' : '1px solid #E5E7EB',\r\n              borderRadius: '6px',\r\n              padding: '16px',\r\n              marginBottom: '20px'\r\n            }}>\r\n              <div style={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '12px',\r\n                marginBottom: '20px'\r\n              }}>\r\n                <div style={{\r\n                  width: '24px',\r\n                  height: '24px',\r\n                  borderRadius: '4px',\r\n                  background: isDarkMode ? '#6B7280' : '#9CA3AF',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center'\r\n                }}>\r\n                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ \r\n                    color: 'white'\r\n                  }}>\r\n                    <circle cx=\"12\" cy=\"12\" r=\"3\" fill=\"currentColor\"/>\r\n                    <path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z\" \r\n                          stroke=\"currentColor\" strokeWidth=\"1\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                  </svg>\r\n                </div>\r\n                <h4 style={{\r\n                  margin: 0,\r\n                  fontSize: '18px',\r\n                  fontWeight: '650',\r\n                  color: isDarkMode ? '#E0F2FE' : '#0F172A',\r\n                  letterSpacing: '-0.01em'\r\n                }}>\r\n                  Processing Status\r\n                </h4>\r\n              </div>\r\n              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>\r\n                {/* Deal Creation Status */}\r\n                <div style={{ \r\n                  display: 'flex', \r\n                  alignItems: 'center', \r\n                  gap: '16px', \r\n                  padding: '16px 18px',\r\n                  borderRadius: '8px',\r\n                  background: isDarkMode ? '#374151' : '#F9FAFB',\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'}`,\r\n                  transition: 'all 0.2s ease'\r\n                }}>\r\n                  {/* Status Icon */}\r\n                  <div style={{ \r\n                    width: '24px', \r\n                    height: '24px', \r\n                    display: 'flex', \r\n                    alignItems: 'center', \r\n                    justifyContent: 'center',\r\n                    borderRadius: '4px',\r\n                    background: isDarkMode ? '#6B7280' : '#9CA3AF'\r\n                  }}>\r\n                    {(dealCreationInProgress || dealStatus === 'processing') ? (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ \r\n                        color: 'white',\r\n                        animation: 'spin 1s linear infinite'\r\n                      }}>\r\n                        <path d=\"M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    ) : dealStatus === 'ready' ? (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ color: 'white' }}>\r\n                        <path d=\"M20 6L9 17L4 12\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    ) : dealStatus === 'error' ? (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ color: 'white' }}>\r\n                        <path d=\"M18 6L6 18M6 6L18 18\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    ) : (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ color: isDarkMode ? colours.dark.text : '#9CA3AF' }}>\r\n                        <circle cx=\"12\" cy=\"8\" r=\"2\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n                        <path d=\"M12 14c-4 0-6 2-6 4v2h12v-2c0-2-2-4-6-4z\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n                      </svg>\r\n                    )}\r\n                  </div>\r\n                  <div style={{ flex: 1 }}>\r\n                    <div style={{ \r\n                      fontWeight: '500', \r\n                      color: isDarkMode ? '#F3F4F6' : '#374151',\r\n                      marginBottom: '4px',\r\n                      fontSize: '14px'\r\n                    }}>\r\n                      {(dealCreationInProgress || dealStatus === 'processing')\r\n                        ? 'Saving Pitch Details'\r\n                        : (dealStatus === 'ready')\r\n                          ? 'Pitch Saved Successfully'\r\n                          : (dealStatus === 'error')\r\n                            ? 'Failed to Save Pitch'\r\n                            : 'Ready to Save'}\r\n                    </div>\r\n                    <div style={{ \r\n                      fontSize: '13px', \r\n                      color: isDarkMode ? '#9CA3AF' : '#6B7280',\r\n                      fontWeight: '400',\r\n                      lineHeight: '1.4'\r\n                    }}>\r\n                      {(dealCreationInProgress || dealStatus === 'processing') ? \r\n                        'Creating deal record and saving pitch information...' :\r\n                        dealStatus === 'ready' ? \r\n                          'Pitch details have been securely saved to your system' :\r\n                        dealStatus === 'error' ? \r\n                          'There was an issue saving the pitch. Please try again.' : \r\n                        'Pitch will be saved before sending email'}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Email Sending Status */}\r\n                <div style={{ \r\n                  display: 'flex', \r\n                  alignItems: 'center', \r\n                  gap: '16px', \r\n                  padding: '16px 18px',\r\n                  borderRadius: '8px',\r\n                  background: isDarkMode ? '#374151' : '#F9FAFB',\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'}`,\r\n                  transition: 'all 0.2s ease'\r\n                }}>\r\n                  {/* Email Icon */}\r\n                  <div style={{ \r\n                    width: '24px', \r\n                    height: '24px', \r\n                    display: 'flex', \r\n                    alignItems: 'center', \r\n                    justifyContent: 'center',\r\n                    borderRadius: '4px',\r\n                    background: isDarkMode ? '#6B7280' : '#9CA3AF'\r\n                  }}>\r\n                    {(emailStatus === 'processing' || modalSending) ? (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ \r\n                        color: 'white',\r\n                        animation: 'spin 1s linear infinite'\r\n                      }}>\r\n                        <path d=\"M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    ) : emailStatus === 'sent' ? (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ color: 'white' }}>\r\n                        <path d=\"M20 6L9 17L4 12\" stroke=\"currentColor\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    ) : emailStatus === 'error' ? (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ color: 'white' }}>\r\n                        <path d=\"M18 6L6 18M6 6L18 18\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    ) : (\r\n                      <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" style={{ color: isDarkMode ? colours.dark.text : '#9CA3AF' }}>\r\n                        <path d=\"M3 8L10.89 13.26C11.2187 13.4793 11.6049 13.5963 12 13.5963C12.3951 13.5963 12.7813 13.4793 13.11 13.26L21 8M5 19H19C20.1046 19 21 18.1046 21 17V7C21 5.89543 20.1046 5 19 5H5C3.89543 5 3 5.89543 3 7V17C3 18.1046 3.89543 19 5 19Z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                      </svg>\r\n                    )}\r\n                  </div>\r\n                  <div style={{ flex: 1 }}>\r\n                    <div style={{ \r\n                      fontWeight: '500', \r\n                      color: isDarkMode ? '#F3F4F6' : '#374151',\r\n                      marginBottom: '4px',\r\n                      fontSize: '14px'\r\n                    }}>\r\n                      {(emailStatus === 'processing' || modalSending) ? 'Sending Email' : \r\n                       emailStatus === 'sent' ? 'Email Sent Successfully' : \r\n                       emailStatus === 'error' ? 'Email Delivery Failed' : \r\n                       'Ready to Send Email'}\r\n                    </div>\r\n                    <div style={{ \r\n                      fontSize: '13px', \r\n                      color: isDarkMode ? '#9CA3AF' : '#6B7280',\r\n                      fontWeight: '400',\r\n                      lineHeight: '1.4'\r\n                    }}>\r\n                      {(emailStatus === 'processing' || modalSending) ? \r\n                        'Delivering email via Microsoft Graph API to recipients...' : \r\n                       emailStatus === 'sent' ? \r\n                        'Email has been successfully delivered and saved to Sent Items' : \r\n                       emailStatus === 'error' ? \r\n                        'There was an issue sending the email. Please try again.' : \r\n                       'Email will be sent from your account when ready'}\r\n                    </div>\r\n                    {!!emailMessage && emailMessage !== 'Sent' && emailMessage !== 'Error' && (\r\n                      <div style={{ \r\n                        fontSize: '13px', \r\n                        color: isDarkMode ? 'rgba(203, 213, 225, 0.8)' : 'rgba(107, 114, 128, 0.8)', \r\n                        marginTop: '6px', \r\n                        fontStyle: 'italic',\r\n                        fontWeight: '500'\r\n                      }}>\r\n                        {emailMessage}\r\n                      </div>\r\n                    )}\r\n                    {/* Enhanced Recipient Breakdown - show when processing or sent */}\r\n                    {(emailStatus === 'processing' || emailStatus === 'sent' || modalSending) && (\r\n                      <div style={{ marginTop: 8, padding: '8px 10px', background: isDarkMode ? 'rgba(30, 41, 59, 0.5)' : 'rgba(248, 250, 252, 0.8)', borderRadius: 6, border: `1px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.15)' : 'rgba(203, 213, 225, 0.5)'}` }}>\r\n                        <div style={{ fontSize: 12, fontWeight: 600, color: isDarkMode ? colours.dark.text : '#475569', marginBottom: 6 }}>Delivery Details:</div>\r\n                        {editableTo && (\r\n                          <div style={{ fontSize: 11, color: isDarkMode ? colours.dark.text : '#64748B', marginBottom: 3 }}>\r\n                            <span style={{ fontWeight: 500 }}>Primary:</span> {editableTo.split(',').length > 1 ? `${editableTo.split(',').length} recipients` : editableTo.trim()}\r\n                          </div>\r\n                        )}\r\n                        {cc && (\r\n                          <div style={{ fontSize: 11, color: isDarkMode ? colours.dark.text : '#64748B', marginBottom: 3 }}>\r\n                            <span style={{ fontWeight: 500 }}>CC:</span> {cc.split(',').length > 1 ? `${cc.split(',').length} recipients` : cc.trim()}\r\n                          </div>\r\n                        )}\r\n                        {(bcc || feeEarnerEmail) && (\r\n                          <div style={{ fontSize: 11, color: isDarkMode ? colours.dark.text : '#64748B', marginBottom: 3 }}>\r\n                            <span style={{ fontWeight: 500 }}>BCC:</span> {[bcc, feeEarnerEmail, 'cb@helix-law.com'].filter(Boolean).join(', ').split(',').length} monitoring addresses\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            {/* Inline validation error (modal) */}\r\n            {modalError && (\r\n              <div style={{\r\n                marginBottom: '16px',\r\n                padding: '10px 12px',\r\n                borderRadius: 8,\r\n                border: '1px solid #ffa39e',\r\n                background: '#fff1f0',\r\n                color: '#a8071a',\r\n                fontSize: 12,\r\n              }}>\r\n                <FaExclamationTriangle style={{ fontSize: 12, color: '#a8071a', marginRight: 6 }} />\r\n                {modalError}\r\n              </div>\r\n            )}\r\n            \r\n            </div> {/* End Scrollable Content Area */}\r\n            \r\n            {/* Enhanced Action Buttons */}\r\n            <div style={{\r\n              display: 'flex',\r\n              gap: '16px',\r\n              justifyContent: 'flex-end',\r\n              padding: '24px 32px',\r\n              borderTop: `1px solid ${isDarkMode ? 'rgba(96, 165, 250, 0.2)' : 'rgba(148, 163, 184, 0.25)'}`\r\n            }}>\r\n              <button\r\n                onClick={() => { if (!modalSending) setShowSendConfirmModal(false); }}\r\n                style={{\r\n                  padding: '12px 24px',\r\n                  border: isDarkMode \r\n                    ? '1px solid rgba(148, 163, 184, 0.3)' \r\n                    : '1px solid rgba(203, 213, 225, 0.6)',\r\n                  background: isDarkMode \r\n                    ? 'rgba(51, 65, 85, 0.6)' \r\n                    : 'rgba(248, 250, 252, 0.9)',\r\n                  color: isDarkMode ? '#CBD5E1' : '#475569',\r\n                  borderRadius: '10px',\r\n                  cursor: modalSending ? 'not-allowed' : 'pointer',\r\n                  fontSize: '14px',\r\n                  fontWeight: '600',\r\n                  transition: 'background-color 0.2s ease',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: '8px',\r\n                  minWidth: '100px',\r\n                  justifyContent: 'center'\r\n                }}\r\n                disabled={modalSending}\r\n                onMouseEnter={(e) => {\r\n                  if (!modalSending) {\r\n                    e.currentTarget.style.background = isDarkMode \r\n                      ? 'rgba(71, 85, 105, 0.8)' \r\n                      : 'rgba(226, 232, 240, 0.95)';\r\n                  }\r\n                }}\r\n                onMouseLeave={(e) => {\r\n                  e.currentTarget.style.background = isDarkMode \r\n                    ? 'rgba(51, 65, 85, 0.6)' \r\n                    : 'rgba(248, 250, 252, 0.9)';\r\n                }}\r\n              >\r\n                {(emailStatus === 'sent' || (dealStatus === 'ready' && emailStatus !== 'processing' && !modalSending)) ? \r\n                  <FaCheck style={{ fontSize: '12px', opacity: 0.9 }} /> :\r\n                  <FaTimes style={{ fontSize: '12px', opacity: 0.8 }} />\r\n                }\r\n                {(emailStatus === 'sent') ? 'Close' :\r\n                 (dealStatus === 'ready' && emailStatus !== 'processing' && !modalSending) ? 'Done' :\r\n                 'Cancel'}\r\n              </button>\r\n              \r\n              <button\r\n                onClick={async () => {\r\n                  // Validate essential fields locally before closing modal\r\n                  const numericAmt = parseFloat(String(amountValue || '').replace(/[^0-9.]/g, ''));\r\n                  const err = (() => {\r\n                    if (!editableTo || !editableTo.trim()) return 'Recipient (To) is required.';\r\n                    if (!subject || !subject.trim()) return 'Subject is required.';\r\n                    if (!body || !body.trim()) return 'Email body is required.';\r\n                    if (!isBeforeCallCall) {\r\n                      if (!scopeDescription || !scopeDescription.trim()) return 'Service description is required.';\r\n                      if (!amountValue || !amountValue.trim() || isNaN(numericAmt) || numericAmt <= 0) return 'Estimated fee must be a positive number.';\r\n                    }\r\n                    return null;\r\n                  })();\r\n                  if (err) {\r\n                    setModalError(err);\r\n                    return;\r\n                  }\r\n                  setModalError(null);\r\n                  try {\r\n                    setModalSending(true);\r\n                    setHasSentEmail(true);\r\n                    // Update recipients before sending if callback provided\r\n                    if (onRecipientsChange && editableTo !== to) {\r\n                      onRecipientsChange(editableTo, cc, bcc);\r\n                    }\r\n                    await handleSendEmailWithProcessing();\r\n                  } finally {\r\n                    setModalSending(false);\r\n                  }\r\n                }}\r\n                style={{\r\n                  padding: '14px 36px',\r\n                  border: 'none',\r\n                  background: modalSending \r\n                    ? 'rgba(148, 163, 184, 0.8)' \r\n                    : `linear-gradient(135deg, ${colours.cta}, #e74c3c)`,\r\n                  color: '#FFFFFF',\r\n                  borderRadius: '12px',\r\n                  cursor: modalSending ? 'not-allowed' : 'pointer',\r\n                  fontSize: '15px',\r\n                  fontWeight: '700',\r\n                  letterSpacing: '0.02em',\r\n                  textTransform: 'uppercase',\r\n                  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: '10px',\r\n                  minWidth: '160px',\r\n                  justifyContent: 'center',\r\n                  transform: modalSending ? 'none' : 'translateY(0px)',\r\n                  boxShadow: modalSending \r\n                    ? 'none' \r\n                    : `0 6px 25px rgba(214, 85, 65, 0.4)`\r\n                }}\r\n                disabled={modalSending}\r\n                onMouseEnter={(e) => {\r\n                  if (!modalSending) {\r\n                    e.currentTarget.style.transform = 'translateY(-2px)';\r\n                    e.currentTarget.style.boxShadow = `0 10px 35px rgba(214, 85, 65, 0.6)`;\r\n                    e.currentTarget.style.background = `linear-gradient(135deg, #c54a3d, #d63031)`;\r\n                  }\r\n                }}\r\n                onMouseLeave={(e) => {\r\n                  if (!modalSending) {\r\n                    e.currentTarget.style.transform = 'translateY(0px)';\r\n                    e.currentTarget.style.boxShadow = `0 6px 25px rgba(214, 85, 65, 0.4)`;\r\n                    e.currentTarget.style.background = `linear-gradient(135deg, ${colours.cta}, #e74c3c)`;\r\n                  }\r\n                }}\r\n              >\r\n                {modalSending ? (\r\n                  <>\r\n                    <div style={{ \r\n                      width: '16px', \r\n                      height: '16px', \r\n                      border: '2px solid rgba(255, 255, 255, 0.3)',\r\n                      borderTop: '2px solid white',\r\n                      borderRadius: '50%',\r\n                      animation: 'spin 1s linear infinite'\r\n                    }} />\r\n                    Sending…\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <FaPaperPlane style={{ fontSize: '14px' }} />\r\n                    Send Email\r\n                  </>\r\n                )}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default EditorAndTemplateBlocks;\r\n\r\n// Allow TS to understand Webpack HMR in CRA\r\ndeclare const module: { hot?: { accept: (path?: string, cb?: () => void) => void } };\r\n","import React from 'react';\r\n\r\ninterface EmailSignatureProps {\r\n  bodyHtml: string;\r\n  userData: any;\r\n  experimentalLayout?: boolean; // V2-only: render like a normal email (no outer padding/boxing)\r\n}\r\n\r\nconst EmailSignature: React.FC<EmailSignatureProps> = ({ bodyHtml, userData, experimentalLayout = false }) => {\r\n  const userFullName = userData?.[0]?.FullName || userData?.[0]?.['Full Name'] || '';\r\n  const userFirstName = userData?.[0]?.['First'] || '';\r\n  const userRole = userData?.[0]?.['Role'] || '';\r\n  const userInitials = userFullName\r\n    ? userFullName\r\n        .split(' ')\r\n        .map((name: string) => name[0].toLowerCase())\r\n        .join('')\r\n    : 'fe'; // fallback\r\n  const userEmail = `${userInitials}@helix-law.com`;\r\n\r\n  // Styles that vary by layout mode\r\n  const outerTdPadding = experimentalLayout ? '0' : '10px';\r\n  const baseTextColor = experimentalLayout ? '' : '#000';\r\n  const baseParagraphColorStyle = experimentalLayout ? '' : 'color:#000;';\r\n\r\n  const signatureHtml = `\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"UTF-8\" />\r\n  <title>Helix Email</title>\r\n</head>\r\n<body style=\"margin:0; padding:0; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4; ${baseTextColor ? `color:${baseTextColor};` : ''}\">\r\n  <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse;\">\r\n    <tr>\r\n      <td style=\"padding:${outerTdPadding}; font-family:Raleway, sans-serif; font-size:10pt; ${baseTextColor ? `color:${baseTextColor};` : ''}\">\r\n        ${bodyHtml}\r\n        <p style=\"font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4; ${baseParagraphColorStyle} margin:16px 0 8px;\">${userFirstName}</p>\r\n        <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse; margin:0; padding:0; width:auto; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4; color:#000;\">\r\n          <tr>\r\n            <td style=\"padding-bottom: 8px; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4; ${baseTextColor ? `color:${baseTextColor};` : ''}\">\r\n              ${userFullName}<br />${userRole}\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding-bottom: 8px; font-family: Raleway, sans-serif; ${baseTextColor ? `color:${baseTextColor};` : ''}\">\r\n              <img src=\"https://helix-law.co.uk/wp-content/uploads/2025/01/50px-logo.png\" alt=\"Helix Law Logo\" style=\"height:50px; display:block; margin:15px 0;\" />\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding-top: 8px; padding-bottom: 8px; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4; ${baseTextColor ? `color:${baseTextColor};` : ''}\">\r\n              <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: collapse; font-size:10pt; line-height:1.4;\">\r\n                <tr>\r\n                  <td style=\"padding-right:4px; vertical-align:middle;\">\r\n                    <img src=\"https://helix-law.co.uk/wp-content/uploads/2025/01/email.png\" alt=\"Email Icon\" style=\"height:12px; vertical-align:middle;\" />\r\n                  </td>\r\n                  <td style=\"padding-right:15px; vertical-align:middle; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4;\">\r\n                    <a href=\"mailto:${userEmail}\" style=\"color:#3690CE; text-decoration:none;\">\r\n                      ${userEmail}\r\n                    </a>\r\n                  </td>\r\n                  <td style=\"padding-right:4px; vertical-align:middle;\">\r\n                    <img src=\"https://helix-law.co.uk/wp-content/uploads/2025/01/phone.png\" alt=\"Phone Icon\" style=\"height:12px; vertical-align:middle;\" />\r\n                  </td>\r\n                  <td style=\"padding-right:15px; vertical-align:middle; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4;\">\r\n                    <a href=\"tel:+443453142044\" style=\"color:#0D2F60; text-decoration:none;\">\r\n                      0345 314 2044\r\n                    </a>\r\n                  </td>\r\n                  <td style=\"padding-right:4px; vertical-align:middle;\">\r\n                    <img src=\"https://helix-law.co.uk/wp-content/uploads/2025/01/website.png\" alt=\"Website Icon\" style=\"height:12px; vertical-align:middle;\" />\r\n                  </td>\r\n                  <td style=\"padding-right:0; vertical-align:middle; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4;\">\r\n                    <a href=\"https://www.helix-law.com/\" style=\"color:#3690CE; text-decoration:none;\">\r\n                      www.helix-law.com\r\n                    </a>\r\n                  </td>\r\n                </tr>\r\n              </table>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding-top:8px; padding-bottom: 8px; font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4;\">\r\n              <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse: collapse; font-size:10pt; line-height:1.4;\">\r\n                <tr>\r\n                  <td style=\"padding-right:4px; vertical-align:middle;\">\r\n                    <img src=\"https://helix-law.co.uk/wp-content/uploads/2025/01/location.png\" alt=\"Location Icon\" style=\"height:12px; vertical-align:middle;\" />\r\n                  </td>\r\n                  <td style=\"vertical-align:middle; ${experimentalLayout ? '' : 'color:#0D2F60;'} font-family: Raleway, sans-serif; font-size:10pt; line-height:1.4;\">\r\n                    Helix Law Ltd, Second Floor, Britannia House, 21 Station Street, Brighton, BN1 4DE\r\n                  </td>\r\n                </tr>\r\n              </table>\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding-top:8px; ${experimentalLayout ? '' : 'color:#D65541;'} font-size:7pt; line-height:1.5; font-family: Raleway, sans-serif;\">\r\n              DISCLAIMER: Please be aware of cyber-crime. Our bank account details will NOT change during the course of a transaction.\r\n              Helix Law Limited will not be liable if you transfer money to an incorrect account.\r\n              We accept no responsibility or liability for malicious or fraudulent emails purportedly coming from our firm,\r\n              and it is your responsibility to ensure that any emails coming from us are genuine before relying on anything contained within them.\r\n            </td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"padding-top:8px; font-style:italic; font-size:7pt; line-height:1.5; ${experimentalLayout ? '' : 'color:#444;'} font-family: Raleway, sans-serif;\">\r\n              Helix Law Limited is a limited liability company registered in England and Wales. Registration Number 07845461. A list of Directors is available for inspection at the Registered Office: Second Floor, Britannia House, 21 Station Street, Brighton, BN1 4DE. Authorised and regulated by the Solicitors Regulation Authority. The term partner is a reference to a Director or senior solicitor of Helix Law Limited. Helix Law Limited does not accept service by email. This email is sent by and on behalf of Helix Law Limited. It may be confidential and may also be legally privileged. It is intended only for the stated addressee(s) and access to it by any other person is unauthorised. If you are not an addressee, you must not disclose, copy, circulate or in any other way use or rely on the information contained in this email. If you have received it in error, please inform us immediately and delete all copies. All copyright is reserved entirely on behalf of Helix Law Limited. Helix Law and applicable logo are exclusively owned trademarks of Helix Law Limited, registered with the Intellectual Property Office under numbers UK00003984532 and UK00003984535. The trademarks should not be used, copied or replicated without consent first obtained in writing.\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>\r\n`;\r\n\r\n  return <div dangerouslySetInnerHTML={{ __html: signatureHtml }} />;\r\n};\r\n\r\nexport default EmailSignature;\r\n\r\n","import React from 'react';\r\nimport { Icon } from '@fluentui/react';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport { colours } from '../../app/styles/colours';\r\n\r\ninterface AreaOption {\r\n  key: string;\r\n  label: string;\r\n  icon: string;\r\n  color: string;\r\n}\r\n\r\ninterface IconAreaFilterProps {\r\n  selectedAreas: string[];\r\n  availableAreas: string[];\r\n  onAreaChange: (selectedAreas: string[]) => void;\r\n  ariaLabel?: string;\r\n}\r\n\r\n// Area configuration with colors and icons\r\nconst areaConfig: Record<string, AreaOption> = {\r\n  'Commercial': { key: 'Commercial', label: 'Commercial', icon: 'KnowledgeArticle', color: colours.blue },\r\n  'Property': { key: 'Property', label: 'Property', icon: 'CityNext', color: colours.green },\r\n  'Construction': { key: 'Construction', label: 'Construction', icon: 'ConstructionCone', color: colours.orange },\r\n  'Employment': { key: 'Employment', label: 'Employment', icon: 'People', color: colours.yellow },\r\n  'Other/Unsure': { key: 'Other/Unsure', label: 'Other/Unsure', icon: 'Help', color: colours.greyText },\r\n};\r\n\r\n/**\r\n * Compact icon-based area of work filter with toggle functionality\r\n * Shows all areas as selected by default, allows deselection/reselection\r\n */\r\nconst IconAreaFilter: React.FC<IconAreaFilterProps> = ({\r\n  selectedAreas,\r\n  availableAreas,\r\n  onAreaChange,\r\n  ariaLabel = \"Filter by area of work\"\r\n}) => {\r\n  const { isDarkMode } = useTheme();\r\n\r\n  // Filter available areas to only show ones that exist in our configuration\r\n  const displayAreas = availableAreas.filter(area => areaConfig[area]);\r\n\r\n  // Handle individual area toggle\r\n  const toggleArea = (areaKey: string) => {\r\n    console.log('🎯 IconAreaFilter: Toggle area clicked:', areaKey, 'current selection:', selectedAreas);\r\n    \r\n    if (selectedAreas.includes(areaKey)) {\r\n      // Remove from selection\r\n      const newSelection = selectedAreas.filter(a => a !== areaKey);\r\n      console.log('🎯 IconAreaFilter: Removing area, new selection:', newSelection);\r\n      onAreaChange(newSelection);\r\n    } else {\r\n      // Add to selection\r\n      const newSelection = [...selectedAreas, areaKey];\r\n      console.log('🎯 IconAreaFilter: Adding area, new selection:', newSelection);\r\n      onAreaChange(newSelection);\r\n    }\r\n  };\r\n\r\n  const noneSelected = selectedAreas.length === 0;\r\n\r\n  return (\r\n    <div \r\n      role=\"group\"\r\n      aria-label={ariaLabel}\r\n      onClick={(e) => {\r\n        console.log('🎯 IconAreaFilter: Container clicked');\r\n        // Don't prevent propagation here - let child buttons handle their own clicks\r\n      }}\r\n      style={{\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        gap: 4,\r\n        height: 28,\r\n        padding: '2px 4px',\r\n        background: isDarkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',\r\n        borderRadius: 14,\r\n        fontFamily: 'Raleway, sans-serif',\r\n        pointerEvents: 'auto', // Ensure container allows pointer events\r\n      }}\r\n    >\r\n      {/* Individual area buttons */}\r\n      {displayAreas.map(areaKey => {\r\n        const area = areaConfig[areaKey];\r\n        const isSelected = selectedAreas.includes(areaKey);\r\n        \r\n        return (\r\n          <button\r\n            key={areaKey}\r\n            type=\"button\"\r\n            onClick={(e) => {\r\n              e.preventDefault();\r\n              e.stopPropagation();\r\n              console.log('🎯 IconAreaFilter: Button clicked for area:', areaKey);\r\n              toggleArea(areaKey);\r\n            }}\r\n            title={`${isSelected ? 'Deselect' : 'Select'} ${area.label}`}\r\n            aria-label={`${isSelected ? 'Deselect' : 'Select'} ${area.label}`}\r\n            aria-pressed={isSelected}\r\n            style={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'center',\r\n              width: 22,\r\n              height: 22,\r\n              background: isSelected \r\n                ? '#FFFFFF'\r\n                : 'transparent',\r\n              border: 'none',\r\n              borderRadius: 11,\r\n              cursor: 'pointer',\r\n              transition: 'all 200ms ease',\r\n              opacity: noneSelected || isSelected ? 1 : 0.4,\r\n              boxShadow: isSelected \r\n                ? (isDarkMode\r\n                    ? '0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.24)'\r\n                    : '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08)')\r\n                : 'none',\r\n              pointerEvents: 'auto', // Ensure pointer events are enabled\r\n              zIndex: 10, // Ensure button is clickable\r\n            }}\r\n            onMouseEnter={(e) => {\r\n              console.log('🎯 IconAreaFilter: Mouse entered button for:', areaKey);\r\n              e.currentTarget.style.transform = 'scale(1.1)';\r\n            }}\r\n            onMouseLeave={(e) => {\r\n              e.currentTarget.style.transform = 'scale(1)';\r\n            }}\r\n          >\r\n            <Icon\r\n              iconName={area.icon}\r\n              style={{\r\n                fontSize: 10,\r\n                color: isSelected \r\n                  ? area.color\r\n                  : (isDarkMode ? 'rgba(255,255,255,0.70)' : 'rgba(0,0,0,0.55)'),\r\n              }}\r\n            />\r\n          </button>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default IconAreaFilter;","import React, { useState, useEffect, useRef } from 'react';\r\nimport { Text, Icon, TextField, DefaultButton, PrimaryButton } from '@fluentui/react';\r\nimport { mergeStyles } from '@fluentui/react/lib/Styling';\r\nimport { Enquiry } from '../../app/functionality/types';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport { colours } from '../../app/styles/colours';\r\nimport EnquiryBadge from './EnquiryBadge';\r\nimport PitchBuilder from './PitchBuilder';\r\n\r\ninterface TeamDataRec {\r\n  Email?: string;\r\n  Initials?: string;\r\n  'Full Name'?: string;\r\n}\r\n\r\ninterface Props {\r\n  enquiry: Enquiry & { __sourceType?: 'new' | 'legacy' };\r\n  claimer?: TeamDataRec | undefined;\r\n  onSelect: (enquiry: Enquiry, multi?: boolean) => void;\r\n  onRate: (id: string) => void;\r\n  onPitch?: (enquiry: Enquiry) => void;\r\n  onEdit?: (enquiry: Enquiry) => void;\r\n  // Allow async handlers\r\n  onAreaChange?: (enquiryId: string, newArea: string) => void | Promise<void>;\r\n  isLast?: boolean;\r\n  isPrimarySelected?: boolean;\r\n  selected?: boolean;\r\n  onToggleSelect?: (enquiry: Enquiry) => void;\r\n  userData?: any; // For pitch builder\r\n  promotionStatus?: 'pitch' | 'instruction' | null;\r\n}\r\n\r\n/**\r\n * ClaimedEnquiryCard\r\n * Card version of a claimed enquiry adopting the new clean design language.\r\n */\r\nconst ClaimedEnquiryCard: React.FC<Props> = ({\r\n  enquiry,\r\n  claimer,\r\n  onSelect,\r\n  onRate,\r\n  onPitch,\r\n  onEdit,\r\n  onAreaChange,\r\n  isLast,\r\n  selected = false,\r\n  isPrimarySelected = false,\r\n  onToggleSelect,\r\n  userData,\r\n  promotionStatus,\r\n}) => {\r\n  const { isDarkMode } = useTheme();\r\n  const [showActions, setShowActions] = useState(false);\r\n  const [clickedForActions, setClickedForActions] = useState(false);\r\n  const [hasAnimatedActions, setHasAnimatedActions] = useState(false);\r\n  const [expandedNotes, setExpandedNotes] = useState(false);\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [isEnteringEdit, setIsEnteringEdit] = useState(false);\r\n  const [isExitingEdit, setIsExitingEdit] = useState(false);\r\n  const [editData, setEditData] = useState({\r\n    First_Name: enquiry.First_Name || '',\r\n    Last_Name: enquiry.Last_Name || '',\r\n    Email: enquiry.Email || '',\r\n    Value: enquiry.Value || '',\r\n    Initial_first_call_notes: enquiry.Initial_first_call_notes || ''\r\n  });\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  // Removed inline pitch builder modal usage; pitch now handled by parent detail view\r\n  const clampRef = useRef<HTMLDivElement>(null);\r\n  const [isOverflowing, setIsOverflowing] = useState(false);\r\n\r\n  const hasNotes = !!(enquiry.Initial_first_call_notes && enquiry.Initial_first_call_notes.trim());\r\n\r\n  useEffect(() => {\r\n    if (!expandedNotes && clampRef.current && hasNotes) {\r\n      const el = clampRef.current;\r\n      const overflowing = el.scrollHeight > el.clientHeight + 1;\r\n      setIsOverflowing(overflowing);\r\n    } else if (expandedNotes) {\r\n      setIsOverflowing(false);\r\n    }\r\n  }, [expandedNotes, enquiry.Initial_first_call_notes, hasNotes]);\r\n\r\n  const normalizeNotes = (raw: string): string => {\r\n    let s = raw.replace(/\\\\n/g, '\\n').replace(/\\r\\n/g, '\\n');\r\n    s = s.replace(/\\n{3,}/g, '\\n\\n');\r\n    return s.trim();\r\n  };\r\n\r\n  // Check if current user can edit this enquiry (only owner can edit)\r\n  const userEmail = userData?.[0]?.Email?.toLowerCase() || '';\r\n  const enquiryOwner = (enquiry.Point_of_Contact || '').toLowerCase();\r\n  const canEdit = onEdit && userEmail && enquiryOwner === userEmail;\r\n\r\n  const handleEditClick = () => {\r\n    setIsEnteringEdit(true);\r\n    setIsExitingEdit(false);\r\n    setExpandedNotes(true); // Always expand notes when editing\r\n    \r\n    // Smooth transition into edit mode\r\n    setTimeout(() => {\r\n      setIsEditing(true);\r\n      setIsEnteringEdit(false);\r\n    }, 150);\r\n    \r\n    // Reset edit data to current enquiry values\r\n    setEditData({\r\n      First_Name: enquiry.First_Name || '',\r\n      Last_Name: enquiry.Last_Name || '',\r\n      Email: enquiry.Email || '',\r\n      Value: enquiry.Value || '',\r\n      Initial_first_call_notes: enquiry.Initial_first_call_notes || ''\r\n    });\r\n  };\r\n\r\n  const handleCancelEdit = () => {\r\n    setIsExitingEdit(true);\r\n    \r\n    // Smooth transition out of edit mode\r\n    setTimeout(() => {\r\n      setIsEditing(false);\r\n      setIsEnteringEdit(false);\r\n      setIsExitingEdit(false);\r\n    }, 150);\r\n    \r\n    setEditData({\r\n      First_Name: enquiry.First_Name || '',\r\n      Last_Name: enquiry.Last_Name || '',\r\n      Email: enquiry.Email || '',\r\n      Value: enquiry.Value || '',\r\n      Initial_first_call_notes: enquiry.Initial_first_call_notes || ''\r\n    });\r\n  };\r\n\r\n  const handleSaveEdit = async () => {\r\n    if (!onEdit) return;\r\n    \r\n    try {\r\n      setIsSaving(true);\r\n      \r\n      // Prepare updates - only include changed fields\r\n      const updates: any = {};\r\n      if (editData.First_Name !== enquiry.First_Name) updates.First_Name = editData.First_Name.trim();\r\n      if (editData.Last_Name !== enquiry.Last_Name) updates.Last_Name = editData.Last_Name.trim();\r\n      if (editData.Email !== enquiry.Email) updates.Email = editData.Email.trim();\r\n      if (editData.Value !== enquiry.Value) updates.Value = editData.Value.trim();\r\n      if (editData.Initial_first_call_notes !== enquiry.Initial_first_call_notes) {\r\n        updates.Initial_first_call_notes = editData.Initial_first_call_notes.trim();\r\n      }\r\n\r\n      if (Object.keys(updates).length === 0) {\r\n        setIsEditing(false);\r\n        return;\r\n      }\r\n\r\n      // Call the parent's onEdit handler which will handle the API call\r\n      await onEdit({ ...enquiry, ...updates });\r\n      \r\n      // Smooth transition out of edit mode\r\n      setIsExitingEdit(true);\r\n      setTimeout(() => {\r\n        setIsEditing(false);\r\n        setIsEnteringEdit(false);\r\n        setIsExitingEdit(false);\r\n      }, 150);\r\n      \r\n    } catch (error) {\r\n      console.error('Failed to save changes:', error);\r\n      // Keep editing mode on error\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleFieldChange = (field: keyof typeof editData, value: string) => {\r\n    setEditData(prev => ({ ...prev, [field]: value }));\r\n  };\r\n\r\n  const areaColor = (() => {\r\n    const area = enquiry.Area_of_Work?.toLowerCase() || '';\r\n    if (area.includes('commercial')) return colours.blue;\r\n    if (area.includes('construction')) return colours.orange;\r\n    if (area.includes('property')) return colours.green;\r\n    if (area.includes('employment')) return colours.yellow;\r\n    if (area.includes('claim')) return colours.accent;\r\n    if (area.includes('other') || area.includes('unsure')) return colours.greyText;\r\n    return colours.greyText; // Default to grey for unmatched areas\r\n  })();\r\n\r\n  const isCardClickable = hasNotes && (isOverflowing || !expandedNotes) && !isEditing && !isEnteringEdit && !isExitingEdit;\r\n  \r\n  // Enhanced styling to match instruction cards - code-like dark mode with clean design\r\n  const bgGradientLight = 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)';\r\n  \r\n  const selectedBg = isDarkMode \r\n    ? `#1e293b` // Solid dark blue-grey for code-like feel\r\n    : `linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)`;\r\n  \r\n  const selectedBorder = isDarkMode\r\n    ? `1px solid ${areaColor}`\r\n    : `1px solid ${areaColor}`;\r\n    \r\n  const selectedShadow = isDarkMode\r\n    ? `0 1px 3px rgba(0,0,0,0.8)` // Minimal shadow in dark mode\r\n    : `0 8px 32px ${areaColor}25, 0 4px 16px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8)`;\r\n  \r\n  const card = mergeStyles({\r\n    position: 'relative',\r\n    margin: '6px 0', // Reduced margin to match instruction cards\r\n    borderRadius: 8,\r\n    padding: '12px 18px',\r\n    background: selected \r\n      ? selectedBg\r\n      : (isDarkMode ? '#0f172a' : bgGradientLight), // Solid dark background to match instruction cards\r\n    opacity: promotionStatus ? 0.6 : 1,\r\n    // Responsive padding\r\n    '@media (max-width: 768px)': {\r\n      padding: '10px 14px',\r\n    },\r\n    '@media (max-width: 480px)': {\r\n      padding: '8px 12px',\r\n      borderRadius: 6,\r\n    },\r\n    border: selected || clickedForActions \r\n      ? selectedBorder\r\n      : `1px solid ${isDarkMode ? 'rgba(148,163,184,0.2)' : 'rgba(0,0,0,0.08)'}`,\r\n    borderLeft: `2px solid ${selected ? areaColor : (isDarkMode ? areaColor : `${areaColor}60`)}`, // Override just the left side\r\n    boxShadow: selected\r\n      ? selectedShadow\r\n      : (isDarkMode ? 'none' : '0 4px 6px rgba(0, 0, 0, 0.07)'),\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n    gap: 6,\r\n    fontFamily: 'Raleway, sans-serif',\r\n    cursor: isCardClickable ? 'pointer' : 'default',\r\n    transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n    marginBottom: 4,\r\n    overflow: 'hidden',\r\n    transform: selected ? 'translateY(-2px)' : 'translateY(0)',\r\n    selectors: {\r\n      ':hover': isCardClickable ? {\r\n        transform: selected ? 'translateY(-3px)' : 'translateY(-1px)', \r\n        boxShadow: selected \r\n          ? (isDarkMode ? `0 2px 8px rgba(0,0,0,0.9)` : `0 12px 40px ${areaColor}50, 0 4px 12px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.2)`)\r\n          : (isDarkMode ? '0 1px 3px rgba(0,0,0,0.6)' : '0 8px 24px rgba(0,0,0,0.12)'),\r\n        border: `1px solid ${areaColor}`, // Change the main border to area color on hover\r\n        borderLeft: `2px solid ${areaColor}`, // Keep left border consistent\r\n      } : { \r\n        borderColor: selected || clickedForActions ? areaColor : areaColor\r\n      },\r\n      ':active': isCardClickable ? { transform: selected ? 'translateY(-1px)' : 'translateY(0)' } : {},\r\n      ':focus-within': { \r\n        outline: `2px solid ${areaColor}40`, // Thinner outline\r\n        outlineOffset: '2px',\r\n        borderColor: areaColor \r\n      },\r\n    },\r\n  });\r\n\r\n  const actionButtons = [\r\n    { key: 'pitch', icon: 'Send', label: 'Pitch', onClick: () => { onPitch ? onPitch(enquiry) : onSelect(enquiry); } },\r\n    { key: 'call', icon: 'Phone', label: 'Call', onClick: () => enquiry.Phone_Number && (window.location.href = `tel:${enquiry.Phone_Number}`) },\r\n    { key: 'email', icon: 'Mail', label: 'Email', onClick: () => enquiry.Email && (window.location.href = `mailto:${enquiry.Email}?subject=Your%20Enquiry&bcc=1day@followupthen.com`) },\r\n    { key: 'rate', icon: 'Like', label: 'Rate', onClick: () => onRate(enquiry.ID) },\r\n    ...(canEdit && !isEditing ? [{ key: 'edit', icon: 'Edit', label: 'Edit', onClick: handleEditClick }] : []),\r\n  ];\r\n\r\n  return (\r\n    <div\r\n      className={card}\r\n      role=\"article\"\r\n      tabIndex={0}\r\n      aria-label=\"Claimed enquiry\"\r\n      onMouseEnter={() => {\r\n        if (!hasAnimatedActions) {\r\n          setShowActions(true); setHasAnimatedActions(true);\r\n        } else setShowActions(true);\r\n      }}\r\n      onMouseLeave={() => { if (!selected && !clickedForActions) setShowActions(false); }}\r\n      onClick={(e) => {\r\n        // Toggle clicked state for actions visibility\r\n        setClickedForActions(!clickedForActions);\r\n        setShowActions(!clickedForActions);\r\n        \r\n        if (isCardClickable) {\r\n          // Expand notes if truncated; if already expanded do nothing further\r\n          if (!expandedNotes) {\r\n            setExpandedNotes(true);\r\n          }\r\n        }\r\n      }}\r\n      onKeyDown={(e) => {\r\n        if ((e.key === 'Enter' || e.key === ' ') && isCardClickable) {\r\n          e.preventDefault();\r\n          if (!expandedNotes) setExpandedNotes(true);\r\n        }\r\n      }}\r\n    >\r\n      {/* Selection Toggle (checkbox style) */}\r\n      {onToggleSelect && (\r\n        <button\r\n          aria-label={selected ? 'Deselect enquiry' : 'Select enquiry'}\r\n          onClick={(e) => { e.stopPropagation(); onToggleSelect(enquiry); }}\r\n          style={{ position: 'absolute', top: 10, left: 10, width: 18, height: 18, borderRadius: 4, border: `1.5px solid ${selected ? colours.blue : (isDarkMode ? 'rgba(255,255,255,0.25)' : '#c3c9d4')}`, background: selected ? colours.blue : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}\r\n        >\r\n          {selected && <Icon iconName=\"CheckMark\" styles={{ root: { fontSize: 12, color: '#fff' } }} />}\r\n        </button>\r\n      )}\r\n\r\n      {/* Left accent bar */}\r\n      <span style={{ position: 'absolute', top: 0, left: 0, bottom: 0, width: 2, background: areaColor, opacity: .95, pointerEvents: 'none' }} />\r\n\r\n      {/* Area badge - redesigned for cleaner integration */}\r\n      <div style={{\r\n        position: 'absolute',\r\n        top: 12,\r\n        right: 12,\r\n        zIndex: 2\r\n      }}>\r\n        <EnquiryBadge \r\n          enquiry={enquiry}\r\n          onAreaChange={onAreaChange ? (enquiryId, newArea) => onAreaChange(enquiryId, newArea) : undefined}\r\n        />\r\n      </div>\r\n\r\n      {/* Name + ID inline */}\r\n      <div style={{ \r\n        display: 'flex', \r\n        alignItems: 'center', \r\n        gap: 10, \r\n        marginTop: 8, \r\n        paddingLeft: onToggleSelect ? 26 : 0,\r\n        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n        opacity: isExitingEdit ? 0.7 : 1,\r\n        transform: isEnteringEdit ? 'translateY(-2px)' : 'translateY(0)'\r\n      }}>\r\n        {(isEditing && !isExitingEdit) ? (\r\n          <div style={{ \r\n            display: 'flex', \r\n            gap: 8, \r\n            flex: 1,\r\n            opacity: isEnteringEdit ? 0 : 1,\r\n            transform: isEnteringEdit ? 'translateY(4px)' : 'translateY(0)',\r\n            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.15s'\r\n          }}>\r\n            <TextField\r\n              value={editData.First_Name}\r\n              onChange={(_, value) => handleFieldChange('First_Name', value || '')}\r\n              placeholder=\"First name\"\r\n              disabled={isSaving}\r\n              styles={{\r\n                root: { \r\n                  flex: 1,\r\n                  transition: 'all 0.2s ease-in-out'\r\n                },\r\n                fieldGroup: {\r\n                  border: 'none',\r\n                  background: 'transparent',\r\n                  fontSize: 14,\r\n                  fontWeight: 600,\r\n                  padding: 0,\r\n                  height: 'auto',\r\n                  minHeight: 'auto',\r\n                  borderRadius: 6,\r\n                  transition: 'all 0.2s ease-in-out'\r\n                },\r\n                field: {\r\n                  padding: '8px 12px',\r\n                  color: isDarkMode ? '#fff' : '#0d2538',\r\n                  fontSize: 14,\r\n                  fontWeight: 600,\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'}`,\r\n                  borderRadius: 6,\r\n                  background: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.03)',\r\n                  transition: 'all 0.2s ease-in-out',\r\n                  selectors: {\r\n                    ':focus': {\r\n                      borderColor: colours.blue,\r\n                      boxShadow: `0 0 0 2px ${colours.blue}20`,\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    },\r\n                    ':hover': {\r\n                      borderColor: isDarkMode ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.2)',\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    }\r\n                  }\r\n                }\r\n              }}\r\n            />\r\n            <TextField\r\n              value={editData.Last_Name}\r\n              onChange={(_, value) => handleFieldChange('Last_Name', value || '')}\r\n              placeholder=\"Last name\"\r\n              disabled={isSaving}\r\n              styles={{\r\n                root: { \r\n                  flex: 1,\r\n                  transition: 'all 0.2s ease-in-out'\r\n                },\r\n                fieldGroup: {\r\n                  border: 'none',\r\n                  background: 'transparent',\r\n                  fontSize: 14,\r\n                  fontWeight: 600,\r\n                  padding: 0,\r\n                  height: 'auto',\r\n                  minHeight: 'auto',\r\n                  borderRadius: 6,\r\n                  transition: 'all 0.2s ease-in-out'\r\n                },\r\n                field: {\r\n                  padding: '8px 12px',\r\n                  color: isDarkMode ? '#fff' : '#0d2538',\r\n                  fontSize: 14,\r\n                  fontWeight: 600,\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'}`,\r\n                  borderRadius: 6,\r\n                  background: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.03)',\r\n                  transition: 'all 0.2s ease-in-out',\r\n                  selectors: {\r\n                    ':focus': {\r\n                      borderColor: colours.blue,\r\n                      boxShadow: `0 0 0 2px ${colours.blue}20`,\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    },\r\n                    ':hover': {\r\n                      borderColor: isDarkMode ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.2)',\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    }\r\n                  }\r\n                }\r\n              }}\r\n            />\r\n          </div>\r\n        ) : (\r\n          <Text variant=\"medium\" styles={{ \r\n            root: { \r\n              fontWeight: 600, \r\n              color: isDarkMode ? '#fff' : '#0d2538', \r\n              lineHeight: 1.2,\r\n              transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n              opacity: isEnteringEdit ? 0.7 : 1\r\n            } \r\n          }}>\r\n            {(enquiry.First_Name || '') + ' ' + (enquiry.Last_Name || '')}\r\n          </Text>\r\n        )}\r\n        {enquiry.ID && (\r\n          <span style={{ \r\n            fontSize: 11, \r\n            color: isDarkMode ? 'rgba(255,255,255,0.45)' : '#b0b8c9', \r\n            fontWeight: 500, \r\n            letterSpacing: 0.5, \r\n            userSelect: 'all', \r\n            fontFamily: 'Consolas, Monaco, monospace', \r\n            padding: '1px 6px',\r\n            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n            opacity: isEnteringEdit ? 0.7 : 1\r\n          }}>ID {enquiry.ID}</span>\r\n        )}\r\n        {promotionStatus && (\r\n          <span style={{\r\n            fontSize: 10,\r\n            fontWeight: 500,\r\n            padding: '2px 6px',\r\n            borderRadius: 4,\r\n            backgroundColor: promotionStatus === 'instruction' ? (isDarkMode ? 'rgba(76, 175, 80, 0.15)' : 'rgba(232, 245, 232, 0.6)') : (isDarkMode ? 'rgba(33, 150, 243, 0.15)' : 'rgba(227, 242, 253, 0.6)'),\r\n            color: promotionStatus === 'instruction' ? (isDarkMode ? 'rgba(76, 175, 80, 0.8)' : 'rgba(46, 125, 50, 0.7)') : (isDarkMode ? 'rgba(33, 150, 243, 0.8)' : 'rgba(21, 101, 192, 0.7)'),\r\n            textTransform: 'uppercase',\r\n            letterSpacing: 0.5,\r\n            opacity: 0.85\r\n          }}>\r\n            {promotionStatus === 'instruction' ? 'Instructed' : 'Pitched'}\r\n          </span>\r\n        )}\r\n      </div>\r\n\r\n      {/* Value & Company */}\r\n      <div style={{ \r\n        display: 'flex', \r\n        flexWrap: 'wrap', \r\n        gap: 12, \r\n        fontSize: 11, \r\n        color: isDarkMode ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.65)', \r\n        fontWeight: 500, \r\n        marginTop: 6, \r\n        marginLeft: onToggleSelect ? 26 : 2,\r\n        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n        opacity: isExitingEdit ? 0.7 : 1,\r\n        transform: isEnteringEdit ? 'translateY(-2px)' : 'translateY(0)'\r\n      }}>\r\n        {(isEditing && !isExitingEdit) ? (\r\n          <div style={{ \r\n            display: 'flex', \r\n            gap: 8, \r\n            flex: 1, \r\n            flexWrap: 'wrap',\r\n            opacity: isEnteringEdit ? 0 : 1,\r\n            transform: isEnteringEdit ? 'translateY(4px)' : 'translateY(0)',\r\n            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.2s'\r\n          }}>\r\n            <TextField\r\n              value={editData.Value}\r\n              onChange={(_, value) => handleFieldChange('Value', value || '')}\r\n              placeholder=\"Value (e.g. £10,000)\"\r\n              disabled={isSaving}\r\n              styles={{\r\n                root: { \r\n                  minWidth: 120,\r\n                  transition: 'all 0.2s ease-in-out'\r\n                },\r\n                fieldGroup: {\r\n                  border: 'none',\r\n                  background: 'transparent',\r\n                  padding: 0,\r\n                  height: 'auto',\r\n                  minHeight: 'auto',\r\n                  borderRadius: 6\r\n                },\r\n                field: {\r\n                  padding: '6px 10px',\r\n                  fontSize: 11,\r\n                  fontWeight: 600,\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'}`,\r\n                  borderRadius: 6,\r\n                  background: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.03)',\r\n                  color: isDarkMode ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.9)',\r\n                  transition: 'all 0.2s ease-in-out',\r\n                  selectors: {\r\n                    ':focus': {\r\n                      borderColor: colours.blue,\r\n                      boxShadow: `0 0 0 2px ${colours.blue}20`,\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    },\r\n                    ':hover': {\r\n                      borderColor: isDarkMode ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.2)',\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    }\r\n                  }\r\n                }\r\n              }}\r\n            />\r\n            <TextField\r\n              value={editData.Email}\r\n              onChange={(_, value) => handleFieldChange('Email', value || '')}\r\n              placeholder=\"Email address\"\r\n              disabled={isSaving}\r\n              type=\"email\"\r\n              styles={{\r\n                root: { \r\n                  minWidth: 180,\r\n                  flex: 1,\r\n                  transition: 'all 0.2s ease-in-out'\r\n                },\r\n                fieldGroup: {\r\n                  border: 'none',\r\n                  background: 'transparent',\r\n                  padding: 0,\r\n                  height: 'auto',\r\n                  minHeight: 'auto',\r\n                  borderRadius: 6\r\n                },\r\n                field: {\r\n                  padding: '6px 10px',\r\n                  fontSize: 11,\r\n                  fontWeight: 500,\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'}`,\r\n                  borderRadius: 6,\r\n                  background: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.03)',\r\n                  color: isDarkMode ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.9)',\r\n                  transition: 'all 0.2s ease-in-out',\r\n                  selectors: {\r\n                    ':focus': {\r\n                      borderColor: colours.blue,\r\n                      boxShadow: `0 0 0 2px ${colours.blue}20`,\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    },\r\n                    ':hover': {\r\n                      borderColor: isDarkMode ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.2)',\r\n                      background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                    }\r\n                  }\r\n                }\r\n              }}\r\n            />\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {enquiry.Value && <span style={{ fontWeight: 600, transition: 'all 0.3s ease' }}>{enquiry.Value}</span>}\r\n            {enquiry.Company && <span style={{ transition: 'all 0.3s ease' }}>{enquiry.Company}</span>}\r\n            {enquiry.Email && <span style={{ cursor: 'copy', transition: 'all 0.3s ease' }} onClick={e => { e.stopPropagation(); navigator?.clipboard?.writeText(enquiry.Email); }}>{enquiry.Email}</span>}\r\n          </>\r\n        )}\r\n        {enquiry.Phone_Number && <span style={{ cursor: 'copy', transition: 'all 0.3s ease' }} onClick={e => { e.stopPropagation(); navigator?.clipboard?.writeText(enquiry.Phone_Number!); }}>{enquiry.Phone_Number}</span>}\r\n      </div>\r\n\r\n      {/* Notes clamp */}\r\n      {(hasNotes || isEditing) && (\r\n        <div style={{ \r\n          marginTop: 6, \r\n          marginBottom: 4, \r\n          paddingLeft: onToggleSelect ? 26 : 0,\r\n          transition: 'all 0.3s ease',\r\n          opacity: isExitingEdit ? 0.7 : 1\r\n        }}>\r\n          {(isEditing && !isExitingEdit) ? (\r\n            <div style={{\r\n              opacity: isEnteringEdit ? 0 : 1,\r\n              transition: 'opacity 0.4s ease 0.2s'\r\n            }}>\r\n              <TextField\r\n                value={editData.Initial_first_call_notes}\r\n                onChange={(_, value) => handleFieldChange('Initial_first_call_notes', value || '')}\r\n                placeholder=\"Initial call notes...\"\r\n                disabled={isSaving}\r\n                multiline\r\n                rows={4}\r\n                autoAdjustHeight\r\n                styles={{\r\n                  root: { \r\n                    width: '100%',\r\n                    transition: 'all 0.2s ease-in-out'\r\n                  },\r\n                  fieldGroup: {\r\n                    border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'}`,\r\n                    borderRadius: 8,\r\n                    background: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.03)',\r\n                    padding: 8,\r\n                    transition: 'all 0.2s ease-in-out',\r\n                    selectors: {\r\n                      ':focus-within': {\r\n                        borderColor: colours.blue,\r\n                        boxShadow: `0 0 0 2px ${colours.blue}20`,\r\n                        background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                      },\r\n                      ':hover': {\r\n                        borderColor: isDarkMode ? 'rgba(255,255,255,0.25)' : 'rgba(0,0,0,0.2)',\r\n                        background: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)'\r\n                      }\r\n                    }\r\n                  },\r\n                  field: {\r\n                    fontSize: 11,\r\n                    lineHeight: '1.5',\r\n                    color: isDarkMode ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.9)',\r\n                    background: 'transparent',\r\n                    border: 'none',\r\n                    padding: 0,\r\n                    minHeight: 60,\r\n                    resize: 'vertical' as const,\r\n                    fontFamily: 'inherit',\r\n                    transition: 'all 0.2s ease-in-out'\r\n                  }\r\n                }}\r\n              />\r\n            </div>\r\n          ) : expandedNotes ? (\r\n            <div \r\n              ref={clampRef} \r\n              style={{ \r\n                transition: 'all 0.3s ease', \r\n                maxHeight: 1000, \r\n                overflow: 'visible', \r\n                fontSize: 11, \r\n                lineHeight: '1.5', \r\n                color: isDarkMode ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.75)',\r\n                whiteSpace: 'pre-wrap', // Preserves line breaks and wrapping\r\n                wordWrap: 'break-word', // Prevents long words from overflowing\r\n                fontFamily: 'inherit'\r\n              }}\r\n            >\r\n              {normalizeNotes(enquiry.Initial_first_call_notes || '')}\r\n            </div>\r\n          ) : (\r\n            <div style={{ position: 'relative' }}>\r\n              <div \r\n                ref={clampRef} \r\n                style={{ \r\n                  display: '-webkit-box', \r\n                  WebkitLineClamp: 3, \r\n                  WebkitBoxOrient: 'vertical', \r\n                  overflow: 'hidden', \r\n                  textOverflow: 'ellipsis', \r\n                  whiteSpace: 'pre-wrap', // Preserves line breaks\r\n                  wordWrap: 'break-word', // Prevents overflow\r\n                  transition: 'all 0.3s ease', \r\n                  maxHeight: 57, \r\n                  fontSize: 11, \r\n                  lineHeight: '1.5', \r\n                  color: isDarkMode ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.75)',\r\n                  fontFamily: 'inherit'\r\n                }}\r\n              >\r\n                {normalizeNotes(enquiry.Initial_first_call_notes || '')}\r\n              </div>\r\n              {isOverflowing && (\r\n                <div style={{ \r\n                  position: 'absolute', \r\n                  bottom: 0, \r\n                  left: 0, \r\n                  right: 0, \r\n                  height: 18, \r\n                  background: isDarkMode \r\n                    ? 'linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.06))' \r\n                    : 'linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.95))', \r\n                  pointerEvents: 'none',\r\n                  transition: 'opacity 0.3s ease'\r\n                }} />\r\n              )}\r\n            </div>\r\n          )}\r\n          {(isOverflowing || (expandedNotes && isOverflowing)) && !isEditing && (\r\n            <button\r\n              type=\"button\"\r\n              onClick={(e) => { e.stopPropagation(); setExpandedNotes(v => !v); }}\r\n              aria-expanded={expandedNotes}\r\n              aria-label={expandedNotes ? 'Collapse notes' : 'Expand notes'}\r\n              style={{ \r\n                display: 'inline-flex', \r\n                alignItems: 'center', \r\n                cursor: 'pointer', \r\n                color: '#7a869a', \r\n                fontSize: 15, \r\n                marginLeft: 2, \r\n                marginTop: 4, \r\n                background: 'transparent', \r\n                border: 'none', \r\n                padding: 4,\r\n                borderRadius: 4,\r\n                transition: 'all 0.2s ease-in-out'\r\n              }}\r\n              onMouseEnter={(e) => {\r\n                e.currentTarget.style.color = colours.blue;\r\n                e.currentTarget.style.background = isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';\r\n              }}\r\n              onMouseLeave={(e) => {\r\n                e.currentTarget.style.color = '#7a869a';\r\n                e.currentTarget.style.background = 'transparent';\r\n              }}\r\n            >\r\n              <Icon iconName=\"ChevronDown\" styles={{ \r\n                root: { \r\n                  transition: 'all 0.3s ease', \r\n                  transform: expandedNotes ? 'rotate(-180deg)' : 'rotate(0deg)', \r\n                  fontSize: 15, \r\n                  color: 'inherit'\r\n                } \r\n              }} />\r\n            </button>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {/* Action buttons (cascade) */}\r\n      <div style={{ \r\n        display: 'flex', \r\n        flexDirection: 'column', \r\n        marginTop: 6, \r\n        transition: 'all 0.4s cubic-bezier(.4,0,.2,1)', \r\n        maxHeight: (showActions || selected || clickedForActions || isEditing) ? (isEditing ? 140 : 80) : 0, \r\n        paddingTop: (showActions || selected || clickedForActions || isEditing) ? 8 : 0, \r\n        paddingBottom: (showActions || selected || clickedForActions || isEditing) ? 8 : 0, \r\n        overflow: 'hidden',\r\n        opacity: isExitingEdit ? 0.7 : 1,\r\n        transform: isEnteringEdit ? 'translateY(-2px)' : 'translateY(0)'\r\n      }}>\r\n        \r\n        {(isEditing && !isExitingEdit) ? (\r\n          /* Edit mode buttons */\r\n          <div style={{ \r\n            display: 'flex', \r\n            gap: 8, \r\n            justifyContent: 'flex-end', \r\n            paddingTop: 8,\r\n            opacity: isEnteringEdit ? 0 : 1,\r\n            transform: isEnteringEdit ? 'translateY(6px) scale(0.95)' : 'translateY(0) scale(1)',\r\n            transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.3s'\r\n          }}>\r\n            <DefaultButton\r\n              text=\"Cancel\"\r\n              onClick={(e) => { e.stopPropagation(); handleCancelEdit(); }}\r\n              disabled={isSaving}\r\n              styles={{\r\n                root: {\r\n                  minWidth: 60,\r\n                  height: 28,\r\n                  fontSize: 11,\r\n                  borderRadius: 4,\r\n                  border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)'}`,\r\n                  background: 'transparent',\r\n                  color: isDarkMode ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.8)'\r\n                }\r\n              }}\r\n            />\r\n            <PrimaryButton\r\n              text={isSaving ? 'Saving...' : 'Save'}\r\n              onClick={(e) => { e.stopPropagation(); handleSaveEdit(); }}\r\n              disabled={isSaving}\r\n              styles={{\r\n                root: {\r\n                  minWidth: 60,\r\n                  height: 28,\r\n                  fontSize: 11,\r\n                  borderRadius: 4,\r\n                  background: colours.blue,\r\n                  border: 'none'\r\n                }\r\n              }}\r\n            />\r\n          </div>\r\n        ) : (\r\n          /* Regular action buttons - unified badge-style design */\r\n          <div style={{ \r\n            display: 'flex', \r\n            gap: 6, \r\n            flexWrap: 'wrap',\r\n            opacity: isEnteringEdit ? 0.7 : 1,\r\n            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'\r\n          }}>\r\n            {actionButtons.map((btn, idx) => {\r\n              const delay = (showActions || selected || clickedForActions) ? (!hasAnimatedActions ? 120 + idx * 70 : idx * 70) : (actionButtons.length - 1 - idx) * 65;\r\n              const isRate = btn.key === 'rate';\r\n              const isPitch = btn.key === 'pitch';\r\n              const isEdit = btn.key === 'edit';\r\n              return (\r\n                <button\r\n                  key={btn.key}\r\n                  onClick={(e) => { e.stopPropagation(); btn.onClick(); }}\r\n                  className={mergeStyles({\r\n                    background: isPitch ? colours.highlight : 'transparent',\r\n                    color: isPitch ? '#fff' : colours.greyText,\r\n                    border: `1px solid ${isPitch ? colours.highlight : 'transparent'}`,\r\n                    backdropFilter: 'blur(8px)',\r\n                    padding: '8px 14px',\r\n                    borderRadius: 18,\r\n                    fontSize: 10.5,\r\n                    fontWeight: 600,\r\n                    cursor: 'pointer',\r\n                    minHeight: 34,\r\n                    opacity: showActions || selected ? 1 : 0,\r\n                    transform: showActions || selected ? 'translateY(0) scale(1)' : 'translateY(6px) scale(.96)',\r\n                    transition: 'opacity .4s cubic-bezier(.4,0,.2,1), transform .4s cubic-bezier(.4,0,.2,1), background .25s, color .25s, border .25s, border-radius .35s cubic-bezier(.4,0,.2,1)',\r\n                    transitionDelay: `${delay}ms`,\r\n                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)',\r\n                    display: 'inline-flex',\r\n                    alignItems: 'center',\r\n                    gap: 6,\r\n                    lineHeight: 1,\r\n                    selectors: {\r\n                      ':hover': { \r\n                        background: isPitch ? colours.blue : '#f4f6f8', \r\n                        color: isPitch ? '#fff' : colours.blue, \r\n                        borderRadius: 14,\r\n                        borderColor: isPitch ? colours.blue : 'transparent',\r\n                        transform: 'translateY(-1px)'\r\n                      },\r\n                      ':active': { \r\n                        background: isPitch ? colours.blue : '#e3f1fb', \r\n                        color: isPitch ? '#fff' : colours.blue, \r\n                        borderRadius: 14, \r\n                        transform: 'scale(0.95)' \r\n                      },\r\n                    },\r\n                  })}\r\n                >\r\n                  <Icon iconName={btn.icon} styles={{ root: { fontSize: 12, lineHeight: 1 } }} />\r\n                  {btn.label}\r\n                </button>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n      \r\n  {/* Removed inline pitch builder modal */}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ClaimedEnquiryCard;\r\n","import {\r\n    Text,\r\n    Icon,\r\n} from '@fluentui/react';\r\nimport { mergeStyles, keyframes } from '@fluentui/react/lib/Styling';\r\nimport { Enquiry } from '../../app/functionality/types';\r\nimport { colours } from '../../app/styles/colours';\r\nimport RatingIndicator from './RatingIndicator';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\n\r\nimport React, { useState } from 'react';\r\n\r\n// Animation keyframes for action drop-in\r\nconst dropInAnimation = keyframes({\r\n  '0%': {\r\n    opacity: 0,\r\n    transform: 'translateY(-8px) scale(0.95)',\r\n  },\r\n  '100%': {\r\n    opacity: 1,\r\n    transform: 'translateY(0) scale(1)',\r\n  },\r\n});\r\n\r\nconst dropInCascadeAnimation = keyframes({\r\n  '0%': {\r\n    opacity: 0,\r\n    transform: 'translateY(-6px) scale(0.9)',\r\n  },\r\n  '100%': {\r\n    opacity: 1,\r\n    transform: 'translateY(0) scale(1)',\r\n  },\r\n});\r\n\r\n// Add CSS animation styles to the document head\r\nif (typeof document !== 'undefined') {\r\n  const style = document.createElement('style');\r\n  style.textContent = `\r\n    @keyframes dropIn {\r\n      0% {\r\n        opacity: 0;\r\n        transform: translateY(-8px) scale(0.95);\r\n      }\r\n      100% {\r\n        opacity: 1;\r\n        transform: translateY(0) scale(1);\r\n      }\r\n    }\r\n    \r\n    @keyframes dropInCascade {\r\n      0% {\r\n        opacity: 0;\r\n        transform: translateY(-6px) scale(0.9);\r\n      }\r\n      100% {\r\n        opacity: 1;\r\n        transform: translateY(0) scale(1);\r\n      }\r\n    }\r\n  `;\r\n  document.head.appendChild(style);\r\n}\r\n\r\n// Utility for copying text and showing feedback\r\nfunction useCopyToClipboard(timeout = 1200): [boolean, (text: string) => void] {\r\n  const [copied, setCopied] = useState(false);\r\n  const copy = (text: string) => {\r\n    if (navigator && navigator.clipboard) {\r\n      navigator.clipboard.writeText(text).then(() => {\r\n        setCopied(true);\r\n        setTimeout(() => setCopied(false), timeout);\r\n      });\r\n    }\r\n  };\r\n  return [copied, copy];\r\n}\r\n\r\ninterface CopyableTextProps {\r\n  value: string;\r\n  className?: string;\r\n  label?: string;\r\n}\r\n\r\nconst CopyableText: React.FC<CopyableTextProps> = ({ value, className, label }) => {\r\n  const [copied, copy] = useCopyToClipboard();\r\n  return (\r\n    <span\r\n      className={className}\r\n      title={copied ? `${label || 'Value'} copied!` : `Click to copy ${label || 'value'}`}\r\n      onClick={e => {\r\n        e.stopPropagation();\r\n        copy(value);\r\n      }}\r\n      style={{ display: 'inline-block', position: 'relative' }}\r\n    >\r\n      {value}\r\n      {copied && (\r\n        <span style={{\r\n          position: 'absolute',\r\n          left: '100%',\r\n          top: 0,\r\n          marginLeft: 8,\r\n          fontSize: 12,\r\n          color: '#43a047',\r\n          background: '#fff',\r\n          borderRadius: 3,\r\n          padding: '2px 6px',\r\n          boxShadow: '0 1px 4px rgba(0,0,0,0.08)',\r\n          zIndex: 10,\r\n        }}>\r\n          Copied!\r\n        </span>\r\n      )}\r\n    </span>\r\n  );\r\n};\r\n\r\n\r\ninterface TeamData {\r\n  'Created Date'?: string;\r\n  'Created Time'?: string;\r\n  'Full Name'?: string;\r\n  'Last'?: string;\r\n  'First'?: string;\r\n  'Nickname'?: string;\r\n  'Initials'?: string;\r\n  'Email'?: string;\r\n  'Entra ID'?: string;\r\n  'Clio ID'?: string;\r\n  'Rate'?: number;\r\n  'Role'?: string;\r\n  'AOW'?: string;\r\n}\r\n\r\ninterface EnquiryLineItemProps {\r\n  enquiry: Enquiry;\r\n  onSelect: (enquiry: Enquiry) => void;\r\n  onRate: (enquiryId: string) => void;\r\n  onPitch?: (enquiry: Enquiry) => void;\r\n  teamData?: TeamData[] | null;\r\n  isLast?: boolean;\r\n  userAOW?: string[]; // List of user's areas of work (lowercase)\r\n  /**\r\n   * Flag indicating this enquiry originated from the new direct getEnquiries route (not legacy/space data).\r\n   * Used for transitional UI (e.g., pulsing claim indicator) before full component split.\r\n   */\r\n  isNewSource?: boolean;\r\n  /**\r\n   * Promotion status for this enquiry. When present, render a compact pill showing\r\n   * \"Pitched\" (blue) or \"Instructed\" (green). This replaces any generic claimed label.\r\n   */\r\n  promotionStatus?: 'pitch' | 'instruction' | null;\r\n}\r\n\r\nconst formatCurrency = (value: string): string => {\r\n  const regex = /(?:£)?(\\d{1,3}(?:,\\d{3})*)(?: to £?(\\d{1,3}(?:,\\d{3})*))?/;\r\n  const matches = value.match(regex);\r\n  if (!matches) return value;\r\n\r\n  return matches\r\n    .slice(1)\r\n    .filter(Boolean)\r\n    .map((num) =>\r\n      num.includes('£')\r\n        ? num.replace(/(\\d)(?=(\\d{3})+(?!\\d))/g, '$1,')\r\n        : `£${parseInt(num.replace(/,/g, ''), 10).toLocaleString()}`\r\n    )\r\n    .join(' to ');\r\n};\r\n\r\nconst getAreaColor = (area: string): string => {\r\n  switch (area?.toLowerCase()) {\r\n    case 'commercial':\r\n      return colours.blue;\r\n    case 'construction':\r\n      return colours.orange;\r\n    case 'property':\r\n      return colours.green;\r\n    case 'employment':\r\n      return colours.yellow;\r\n    default:\r\n      return colours.cta;\r\n  }\r\n};\r\n\r\nconst EnquiryLineItem: React.FC<EnquiryLineItemProps> = ({\r\n  enquiry,\r\n  onSelect,\r\n  onRate,\r\n  onPitch,\r\n  teamData,\r\n  isLast,\r\n  userAOW,\r\n  isNewSource = false,\r\n  promotionStatus = null,\r\n}) => {\r\n  const { isDarkMode } = useTheme();\r\n\r\n  // State for global notes reveal (hidden until chevron on far right is clicked)\r\n  const [notesExpanded, setNotesExpanded] = useState(false);\r\n\r\n  // Notes formatting helpers\r\n  const normalizeNotes = (raw: string): string => {\r\n    let s = raw.replace(/\\\\n/g, '\\n').replace(/\\r\\n/g, '\\n');\r\n    s = s.replace(/\\n{3,}/g, '\\n\\n');\r\n    return s.trim();\r\n  };\r\n\r\n  const hasNotes = enquiry.Initial_first_call_notes && enquiry.Initial_first_call_notes.trim().length > 0;\r\n\r\n  // Simple notes renderer (full notes only shown when parent notesExpanded is true)\r\n  const NotesBlock = ({ notes }: { notes: string }) => {\r\n    if (!notes.trim()) return null;\r\n    return (\r\n      <div style={{\r\n        fontSize: '13px',\r\n        lineHeight: '1.45',\r\n        color: isDarkMode ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.75)',\r\n        whiteSpace: 'pre-line',\r\n      }}>\r\n        {normalizeNotes(notes)}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  // Check if claimed\r\n  const lowerPOC = enquiry.Point_of_Contact?.toLowerCase() || '';\r\n  // Unclaimed criteria: ONLY team@helix-law.com (legacy distribution lists removed)\r\n  const isClaimed = lowerPOC !== 'team@helix-law.com' && !!lowerPOC;\r\n\r\n  // Get claimer info\r\n  const claimer = isClaimed\r\n    ? teamData?.find((t) => t.Email?.toLowerCase() === lowerPOC)\r\n    : undefined;\r\n\r\n  const handleClick = () => {\r\n    onSelect(enquiry);\r\n  };\r\n\r\n  const formatDate = (dateStr: string): string => {\r\n    try {\r\n      const d = new Date(dateStr);\r\n      const nowYear = new Date().getFullYear();\r\n      const year = d.getFullYear();\r\n      const opts: Intl.DateTimeFormatOptions = year === nowYear\r\n        ? { day: '2-digit', month: 'short' }\r\n        : { day: '2-digit', month: 'short', year: 'numeric' };\r\n      return d.toLocaleDateString('en-GB', opts);\r\n    } catch {\r\n      return dateStr;\r\n    }\r\n  };\r\n\r\n  // Determine if this enquiry should be greyed out (not in user's AOW)\r\n  let isGreyedOut = false;\r\n  if (userAOW && userAOW.length > 0 && enquiry.Area_of_Work) {\r\n    const area = enquiry.Area_of_Work.toLowerCase();\r\n    const hasFullAccess = userAOW.some(a => a.includes('operations') || a.includes('tech'));\r\n    if (!hasFullAccess) {\r\n      isGreyedOut = !userAOW.some(a => a === area || a.includes(area) || area.includes(a));\r\n    }\r\n  }\r\n\r\n  const lineItemStyle = mergeStyles({\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    padding: '8px 20px',\r\n    borderBottom: 'none', // Border now handled by the container or notes section\r\n    cursor: 'pointer',\r\n    transition: 'all 0.15s ease',\r\n    fontFamily: 'Raleway, sans-serif',\r\n    minHeight: '44px',\r\n    position: 'relative',\r\n    backgroundColor: isGreyedOut ? (isDarkMode ? '#23272e' : '#f3f3f3') : 'transparent',\r\n    opacity: isGreyedOut ? 0.5 : 1,\r\n    filter: isGreyedOut ? 'grayscale(0.7)' : 'none',\r\n    pointerEvents: isGreyedOut ? 'auto' : 'auto',\r\n    selectors: {\r\n      ':hover': {\r\n        backgroundColor: isGreyedOut ? (isDarkMode ? '#23272e' : '#f3f3f3') : 'transparent',\r\n        transform: 'translateX(2px)',\r\n      },\r\n      ':active': {\r\n        transform: 'translateX(1px)',\r\n      },\r\n      '::before': {\r\n        content: '\"\"',\r\n        position: 'absolute',\r\n        left: 0,\r\n        top: 0,\r\n        bottom: 0,\r\n        width: 2,\r\n        background: getAreaColor(enquiry.Area_of_Work),\r\n        zIndex: 2,\r\n        height: '100%',\r\n        opacity: 0.6,\r\n        transition: 'all 0.15s ease',\r\n      },\r\n      ':hover::before': {\r\n        width: 3,\r\n        opacity: 1,\r\n      },\r\n    },\r\n  });\r\n\r\n  // Animation + style for pulsing \"claim me\" indicator (new source, unclaimed only)\r\n  const pulse = keyframes({\r\n    '0%': { transform: 'scale(0.85)', opacity: 0.55 },\r\n    '50%': { transform: 'scale(1.35)', opacity: 1 },\r\n    '100%': { transform: 'scale(0.85)', opacity: 0.55 },\r\n  });\r\n\r\n  const pulseDotInlineStyle = (areaColor: string) => mergeStyles({\r\n    width: 5,\r\n    height: 5,\r\n    borderRadius: '50%',\r\n    backgroundColor: areaColor,\r\n    boxShadow: `0 0 0 3px ${areaColor}30`,\r\n    animationName: pulse,\r\n    animationDuration: '1.8s',\r\n    animationIterationCount: 'infinite',\r\n    animationTimingFunction: 'ease-in-out',\r\n    flexShrink: 0,\r\n  });\r\n\r\n  // Grid columns (left to right):\r\n  // 1. Name & Company\r\n  // 2. Contact (Email / Phone)\r\n  // 3. Area & Value\r\n  // 4. Date & ID\r\n  // 5. Claimed Status\r\n  // 6. Actions\r\n  // mainContentStyle now computed later once isClaimed known\r\n  // ...existing code...\r\n\r\n  const nameStyle = mergeStyles({\r\n    fontWeight: '500',\r\n    fontSize: '14px',\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    marginBottom: '2px',\r\n    userSelect: 'text',\r\n    cursor: 'copy',\r\n    transition: 'color 0.2s',\r\n    ':hover': {\r\n      color: colours.highlight,\r\n    },\r\n  });\r\n\r\n  const companyStyle = mergeStyles({\r\n    fontSize: '12px',\r\n    color: isDarkMode ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)',\r\n    marginBottom: '1px',\r\n    fontWeight: '500',\r\n  });\r\n\r\n  const emailStyle = mergeStyles({\r\n    fontSize: '11px',\r\n    color: isDarkMode ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)',\r\n    userSelect: 'text',\r\n    cursor: 'copy',\r\n    transition: 'color 0.2s',\r\n    fontWeight: '500',\r\n    ':hover': {\r\n      color: colours.highlight,\r\n    },\r\n  });\r\n\r\n  const metaStyle = mergeStyles({\r\n    fontSize: '13px',\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    fontWeight: '500',\r\n  });\r\n\r\n  const valueStyle = mergeStyles({\r\n    fontSize: '12px',\r\n    color: isDarkMode ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)',\r\n    fontWeight: '500',\r\n  });\r\n\r\n  const dateStyle = mergeStyles({\r\n    fontSize: '12px',\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    fontWeight: '500',\r\n  });\r\n\r\n  const actionsStyle = mergeStyles({\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    gap: '8px',\r\n    flexShrink: 0,\r\n  });\r\n\r\n  const claimerBadgeStyle = mergeStyles({\r\n    fontSize: '10px',\r\n    color: isDarkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)',\r\n    fontWeight: '500',\r\n    marginTop: '1px',\r\n  });\r\n\r\n  // Unified pill styles for claimed / unclaimed to match grouped card aesthetic\r\n  const claimStatusPillStyle = (claimed: boolean) => mergeStyles({\r\n    display: 'inline-flex',\r\n    alignItems: 'center',\r\n    gap: '4px',\r\n    padding: '4px 10px',\r\n    borderRadius: 16,\r\n    fontSize: 10,\r\n    fontWeight: 600,\r\n    letterSpacing: '0.3px',\r\n    background: claimed\r\n      ? (isDarkMode ? 'rgba(102,170,232,0.12)' : 'rgba(102,170,232,0.12)')\r\n      : (isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'),\r\n    color: claimed\r\n      ? colours.highlight\r\n      : (isDarkMode ? 'rgba(255,255,255,0.55)' : 'rgba(0,0,0,0.55)'),\r\n    border: claimed\r\n      ? `1px solid ${colours.highlight}50`\r\n      : `1px solid ${isDarkMode ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)'}`,\r\n    minWidth: 68,\r\n    justifyContent: 'center'\r\n  });\r\n\r\n  const actionBadgeStyle = mergeStyles({\r\n    backgroundColor: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)',\r\n    color: isDarkMode ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.65)',\r\n    border: 'none',\r\n    borderRadius: 6,\r\n    padding: '6px 12px',\r\n    fontSize: '10.5px',\r\n    fontWeight: '600',\r\n    fontFamily: 'Raleway, sans-serif',\r\n    cursor: 'pointer',\r\n    transition: 'all 0.15s ease',\r\n    boxShadow: 'none',\r\n    height: '32px',\r\n    minWidth: '40px',\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    gap: '6px',\r\n    whiteSpace: 'nowrap',\r\n    selectors: {\r\n      ':hover': {\r\n        backgroundColor: 'rgba(102, 170, 232, 0.15)',\r\n        color: colours.highlight,\r\n        transform: 'translateY(-0.5px)',\r\n      },\r\n      ':active': {\r\n        transform: 'translateY(0)',\r\n      },\r\n    },\r\n  });\r\n\r\n  const pitchButtonStyle = mergeStyles({\r\n    backgroundColor: colours.highlight,\r\n    color: 'white',\r\n    border: 'none',\r\n    borderRadius: 6,\r\n    padding: '6px 16px',\r\n    fontSize: '10.5px',\r\n    fontWeight: '600',\r\n    fontFamily: 'Raleway, sans-serif',\r\n    cursor: 'pointer',\r\n    transition: 'all 0.15s ease',\r\n    boxShadow: 'none',\r\n    height: '32px',\r\n    minWidth: '54px',\r\n    whiteSpace: 'nowrap',\r\n    display: 'inline-flex',\r\n    alignItems: 'center',\r\n    gap: '6px',\r\n    lineHeight: 1,\r\n    selectors: {\r\n      ':hover:not(:disabled)': {\r\n        backgroundColor: colours.blue,\r\n        transform: 'translateY(-0.5px)',\r\n      },\r\n      ':active:not(:disabled)': {\r\n        transform: 'translateY(0)',\r\n      },\r\n      ':disabled': {\r\n        backgroundColor: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',\r\n        color: isDarkMode ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)',\r\n        cursor: 'not-allowed',\r\n      },\r\n    },\r\n  });\r\n\r\n  const ratingBadgeStyle = (rating?: string) => mergeStyles({\r\n    backgroundColor: rating \r\n      ? (rating === 'Good' ? 'rgba(102, 170, 232, 0.15)' : \r\n         rating === 'Neutral' ? 'rgba(128, 128, 128, 0.15)' : 'rgba(244, 67, 54, 0.15)')\r\n      : (isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)'),\r\n    color: rating \r\n      ? (rating === 'Good' ? colours.blue : \r\n         rating === 'Neutral' ? colours.grey : colours.cta)\r\n      : (isDarkMode ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)'),\r\n  border: 'none',\r\n  borderRadius: 6,\r\n  padding: '6px 12px',\r\n  fontSize: '10.5px',\r\n  fontWeight: '600',\r\n  fontFamily: 'Raleway, sans-serif',\r\n  cursor: 'pointer',\r\n  transition: 'all 0.15s ease',\r\n  boxShadow: 'none',\r\n  height: '32px',\r\n  minWidth: '40px',\r\n  display: 'flex',\r\n  alignItems: 'center',\r\n  justifyContent: 'center',\r\n  gap: '6px',\r\n    whiteSpace: 'nowrap',\r\n    selectors: {\r\n      ':hover': {\r\n        backgroundColor: rating \r\n          ? (rating === 'Good' ? 'rgba(102, 170, 232, 0.25)' : \r\n             rating === 'Neutral' ? 'rgba(128, 128, 128, 0.25)' : 'rgba(244, 67, 54, 0.25)')\r\n          : 'rgba(102, 170, 232, 0.15)',\r\n        color: rating \r\n          ? (rating === 'Good' ? colours.blue : \r\n             rating === 'Neutral' ? colours.grey : colours.cta)\r\n          : colours.highlight,\r\n        transform: 'translateY(-0.5px)',\r\n      },\r\n      ':active': {\r\n        transform: 'translateY(0)',\r\n      },\r\n    },\r\n  });\r\n\r\n  // Standalone pulse indicator removed; pulse now lives inline inside area-of-work pill when unclaimed\r\n  const showPulseClaimIndicator = false;\r\n\r\n  // --- Unclaimed legacy card state (hooks must be top-level) ---\r\n  const [unclaimedSelected, setUnclaimedSelected] = useState(false);\r\n  const [unclaimedShowActions, setUnclaimedShowActions] = useState(false);\r\n  const [unclaimedHasAnimatedActions, setUnclaimedHasAnimatedActions] = useState(false);\r\n  const [unclaimedExpanded, setUnclaimedExpanded] = useState(false);\r\n  const unclaimedClampRef = React.useRef<HTMLDivElement>(null);\r\n  const [unclaimedIsOverflowing, setUnclaimedIsOverflowing] = useState(false);\r\n  React.useEffect(() => {\r\n    if (!isClaimed) {\r\n      if (!unclaimedExpanded && unclaimedClampRef.current) {\r\n        const el = unclaimedClampRef.current;\r\n        const overflowing = el.scrollHeight > el.clientHeight + 1;\r\n        setUnclaimedIsOverflowing(overflowing);\r\n      } else if (unclaimedExpanded) {\r\n        setUnclaimedIsOverflowing(false);\r\n      }\r\n    }\r\n  }, [isClaimed, unclaimedExpanded, enquiry.Initial_first_call_notes]);\r\n\r\n  // --- Unclaimed legacy card rendering ---\r\n  if (!isClaimed) {\r\n    // ...existing cardStyle, pulseDot, formatNotesRich, etc. definitions, but use the top-level state variables...\r\n    const cardStyle = mergeStyles({\r\n      position: 'relative',\r\n      borderRadius: 5,\r\n      padding: '14px 18px 14px 22px',\r\n      background: isDarkMode ? '#1f2732' : '#ffffff',\r\n      border: `1px solid ${unclaimedSelected ? colours.blue : (isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)')}`,\r\n      boxShadow: isDarkMode\r\n        ? '0 4px 16px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.04)'\r\n        : '0 4px 14px rgba(33,56,82,0.10)',\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n      gap: 6,\r\n      fontFamily: 'Raleway, sans-serif',\r\n      cursor: 'pointer',\r\n      transition: 'border-color .2s, transform .15s',\r\n      marginBottom: !isLast ? 4 : 0,\r\n      overflow: 'hidden',\r\n      selectors: {\r\n        ':hover': { transform: 'translateY(-2px)', borderColor: unclaimedSelected ? colours.blue : colours.highlight },\r\n        ':active': { transform: 'translateY(-1px)' },\r\n        '::before': {\r\n          content: '\"\"',\r\n          position: 'absolute',\r\n          left: 0,\r\n          top: 0,\r\n          bottom: 0,\r\n          width: 2,\r\n          background: getAreaColor(enquiry.Area_of_Work),\r\n          zIndex: 2,\r\n          height: '100%',\r\n          opacity: 0.6,\r\n          transition: 'all 0.15s ease',\r\n        },\r\n        ':hover::before': {\r\n          width: 3,\r\n          opacity: 1,\r\n        },\r\n      },\r\n    });\r\n    if (typeof document !== 'undefined' && !document.getElementById('pulseLegacyUnclaimedStyles')) {\r\n      const styleEl = document.createElement('style');\r\n      styleEl.id = 'pulseLegacyUnclaimedStyles';\r\n      styleEl.textContent = '@keyframes pulseLegacyUnclaimed {0%{transform:scale(.85);opacity:.55}50%{transform:scale(1.3);opacity:1}100%{transform:scale(.85);opacity:.55}}';\r\n      document.head.appendChild(styleEl);\r\n    }\r\n    const areaColor = getAreaColor(enquiry.Area_of_Work || '');\r\n    const pulseDot = mergeStyles({\r\n      width: 9,\r\n      height: 9,\r\n      minWidth: 9,\r\n      minHeight: 9,\r\n      borderRadius: '50%',\r\n      background: areaColor,\r\n      boxShadow: `0 0 0 6px ${areaColor}44`,\r\n      animation: 'pulseLegacyUnclaimed 1.8s ease-in-out infinite',\r\n      display: 'inline-block',\r\n      verticalAlign: 'middle',\r\n      marginLeft: 4,\r\n      flexShrink: 0,\r\n    });\r\n    const formatNotesRich = (notes: string): React.ReactNode => {\r\n      const cleaned = normalizeNotes(notes);\r\n      const blocks = cleaned.split(/\\n{2,}/).slice(0, 12);\r\n      return blocks.map((b, idx) => {\r\n        const lines = b.split(/\\n/).map(l => l.trim()).filter(Boolean);\r\n        const bulletPattern = /^(?:[•\\-*]|\\u2022)\\s?/;\r\n        const numberedPattern = /^\\d+[.)]/;\r\n        const bulletLines = lines.filter(l => bulletPattern.test(l));\r\n        const numberedLines = lines.filter(l => numberedPattern.test(l));\r\n        const asList = (bulletLines.length && bulletLines.length >= lines.length / 2) || (numberedLines.length && numberedLines.length >= lines.length / 2);\r\n        if (asList) {\r\n          return (\r\n            <ul key={idx} style={{ margin: '0 0 8px 18px', padding: 0, listStyle: bulletLines.length ? 'disc' : 'decimal' }}>\r\n              {lines.map((l, li) => <li key={li}>{l.replace(bulletPattern, '').replace(numberedPattern, '').trim()}</li>)}\r\n            </ul>\r\n          );\r\n        }\r\n        return <p key={idx} style={{ margin: '0 0 8px 0', whiteSpace: 'pre-line' }}>{lines.join('\\n')}</p>;\r\n      });\r\n    };\r\n    return (\r\n      <div\r\n        className={cardStyle}\r\n        onMouseEnter={() => {\r\n          if (!unclaimedHasAnimatedActions) {\r\n            setUnclaimedShowActions(true);\r\n            setUnclaimedHasAnimatedActions(true);\r\n          } else {\r\n            setUnclaimedShowActions(true);\r\n          }\r\n        }}\r\n        onMouseLeave={() => {\r\n          if (!unclaimedSelected) setUnclaimedShowActions(false);\r\n        }}\r\n        onClick={() => {\r\n          setUnclaimedSelected(true);\r\n          if (!unclaimedHasAnimatedActions) {\r\n            setUnclaimedShowActions(true); setUnclaimedHasAnimatedActions(true);\r\n          }\r\n          onSelect(enquiry);\r\n        }}\r\n        role=\"article\"\r\n        tabIndex={0}\r\n        aria-label=\"Unclaimed enquiry (legacy data)\"\r\n      >\r\n        {/* Top-right badge: area + pulse + static date */}\r\n        {enquiry.Area_of_Work && (\r\n          <span style={{ position: 'absolute', top: 18, right: 14, display: 'flex', alignItems: 'flex-end', zIndex: 2 }}>\r\n            <span style={{\r\n              display: 'flex', alignItems: 'center', gap: 7, fontSize: 10, padding: '2px 10px 2px 8px', borderRadius: 12,\r\n              background: 'rgba(102,170,232,0.15)', color: areaColor, fontWeight: 600, letterSpacing: .3, textTransform: 'uppercase',\r\n              boxShadow: '0 1px 4px 0 rgba(33,56,82,0.07)', position: 'relative'\r\n            }}>\r\n              {enquiry.Area_of_Work?.toLowerCase().includes('other') || enquiry.Area_of_Work?.toLowerCase().includes('unsure') ? 'Other' : enquiry.Area_of_Work}\r\n              <span className={pulseDot} aria-hidden=\"true\" />\r\n              <span style={{ fontSize: 10, color: '#b0b8c9', fontWeight: 600 }}>{formatDate(enquiry.Touchpoint_Date)}</span>\r\n            </span>\r\n          </span>\r\n        )}\r\n        {/* Name + inline ID */}\r\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 8 }}>\r\n          <span className={pulseDotInlineStyle(getAreaColor(enquiry.Area_of_Work))} aria-hidden=\"true\" />\r\n          <Text variant=\"medium\" styles={{ root: { fontWeight: 600, color: isDarkMode ? '#fff' : '#0d2538', lineHeight: 1.2 } }}>\r\n            {(enquiry.First_Name || '') + ' ' + (enquiry.Last_Name || '')}\r\n          </Text>\r\n          {enquiry.ID && (\r\n            <span style={{\r\n              fontSize: 11,\r\n              color: isDarkMode ? 'rgba(255,255,255,0.45)' : '#b0b8c9',\r\n              fontWeight: 500,\r\n              letterSpacing: 0.5,\r\n              userSelect: 'all',\r\n              fontFamily: 'Consolas, Monaco, monospace',\r\n              background: 'none',\r\n              borderRadius: 4,\r\n              padding: '1px 6px',\r\n              display: 'inline-block',\r\n              verticalAlign: 'middle',\r\n              marginLeft: 2\r\n            }}>\r\n              ID {enquiry.ID}\r\n            </span>\r\n          )}\r\n        </div>\r\n  {/* Meta (value & contact) */}\r\n  <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12, fontSize: 11, color: isDarkMode ? 'rgba(255,255,255,0.65)' : 'rgba(0,0,0,0.65)', fontWeight: 500, marginTop: 6, marginLeft: 10 }}>\r\n          {enquiry.Value && <span style={{ fontWeight: 600 }}>{enquiry.Value}</span>}\r\n          {enquiry.Email && <span style={{ cursor: 'copy' }} onClick={e => { e.stopPropagation(); navigator?.clipboard?.writeText(enquiry.Email); }}>{enquiry.Email}</span>}\r\n          {enquiry.Phone_Number && <span style={{ cursor: 'copy' }} onClick={e => { e.stopPropagation(); navigator?.clipboard?.writeText(enquiry.Phone_Number || ''); }}>{enquiry.Phone_Number}</span>}\r\n        </div>\r\n        {/* Notes clamp */}\r\n        {hasNotes && (\r\n          <div style={{ marginTop: 6, marginBottom: 4 }}>\r\n            {unclaimedExpanded ? (\r\n              <div ref={unclaimedClampRef} style={{ transition: 'max-height 0.32s cubic-bezier(.4,0,.2,1)', maxHeight: 1000, overflow: 'visible', fontSize: 11, lineHeight: 1.4, color: isDarkMode ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.75)' }}>\r\n                {formatNotesRich(enquiry.Initial_first_call_notes || '')}\r\n              </div>\r\n            ) : (\r\n              <div style={{ position: 'relative' }}>\r\n                <div ref={unclaimedClampRef} style={{ display: '-webkit-box', WebkitLineClamp: 3, WebkitBoxOrient: 'vertical', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'pre-line', transition: 'max-height 0.32s cubic-bezier(.4,0,.2,1)', maxHeight: 57, fontSize: 11, lineHeight: 1.4, color: isDarkMode ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.75)' }}>\r\n                  {normalizeNotes(enquiry.Initial_first_call_notes || '')}\r\n                </div>\r\n                {unclaimedIsOverflowing && (\r\n                  <div style={{ position: 'absolute', bottom: 0, left: 0, right: 0, height: 18, background: isDarkMode ? 'linear-gradient(to bottom, rgba(31,39,50,0), rgba(31,39,50,0.9))' : 'linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.95))', pointerEvents: 'none' }} />\r\n                )}\r\n              </div>\r\n            )}\r\n            {/* Clamp toggle */}\r\n            {unclaimedIsOverflowing || unclaimedExpanded ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={e => { e.stopPropagation(); setUnclaimedExpanded(v => !v); }}\r\n                aria-expanded={unclaimedExpanded}\r\n                aria-label={unclaimedExpanded ? 'Collapse notes' : 'Expand notes'}\r\n                style={{ display: 'inline-flex', alignItems: 'center', cursor: 'pointer', color: '#7a869a', fontSize: 15, marginLeft: 2, marginTop: 2, background: 'transparent', border: 'none', padding: 2 }}\r\n              >\r\n                <Icon iconName=\"ChevronDown\" styles={{ root: { transition: 'transform 0.32s cubic-bezier(.4,0,.2,1)', transform: unclaimedExpanded ? 'rotate(-180deg)' : 'rotate(0deg)', fontSize: 15, color: '#7a869a' } }} />\r\n              </button>\r\n            ) : null}\r\n          </div>\r\n        )}\r\n  {/* (ID badge bottom-right removed; now inline after name) */}\r\n        {/* Action buttons (cascade) */}\r\n        <div style={{ display: 'flex', flexDirection: 'column', marginTop: 6, transition: 'max-height 0.35s cubic-bezier(.4,0,.2,1), padding 0.35s cubic-bezier(.4,0,.2,1)', maxHeight: unclaimedShowActions || unclaimedSelected ? 60 : 0, paddingTop: unclaimedShowActions || unclaimedSelected ? 4 : 0, paddingBottom: unclaimedShowActions || unclaimedSelected ? 8 : 0, overflow: 'hidden' }}>\r\n          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>\r\n            {(() => {\r\n              const buttons = [\r\n                { key: 'claim', label: 'Claim', colourType: 'primary', onClick: (e: React.MouseEvent) => { e.stopPropagation(); setUnclaimedSelected(true); onSelect(enquiry); } },\r\n                { key: 'delegate', label: 'Delegate', colourType: 'blue', onClick: (e: React.MouseEvent) => { e.stopPropagation(); alert('Delegate action coming soon!'); } },\r\n                { key: 'triage', label: 'Triage', colourType: 'blue', onClick: (e: React.MouseEvent) => { e.stopPropagation(); alert('Triage action coming soon!'); } },\r\n                { key: 'redirect', label: 'Redirect', colourType: 'yellow', onClick: (e: React.MouseEvent) => { e.stopPropagation(); alert('Redirect action coming soon!'); } },\r\n                { key: 'cant', label: \"Can't Assist\", colourType: 'red', onClick: (e: React.MouseEvent) => { e.stopPropagation(); alert(\"Can't Assist action coming soon!\"); } },\r\n              ];\r\n              const visible = unclaimedShowActions || unclaimedSelected;\r\n              const CONTAINER_DELAY = 120;\r\n              const BUTTON_DELAY = 70;\r\n              return buttons.map((btn, idx) => {\r\n                const baseColour = btn.key === 'claim' ? colours.blue : btn.colourType === 'yellow' ? '#FFD600' : btn.colourType === 'red' ? colours.cta : colours.blue;\r\n                const isClaimBtn = btn.key === 'claim';\r\n                const delay = visible ? (!unclaimedHasAnimatedActions ? `${CONTAINER_DELAY + idx * BUTTON_DELAY}ms` : `${idx * BUTTON_DELAY}ms`) : `${(buttons.length - 1 - idx) * 65}ms`;\r\n                return (\r\n                  <button\r\n                    key={btn.key}\r\n                    onClick={btn.onClick}\r\n                    className={mergeStyles({\r\n                      background: isClaimBtn && unclaimedSelected ? baseColour : 'transparent',\r\n                      color: isClaimBtn ? (unclaimedSelected ? '#fff' : baseColour) : colours.greyText,\r\n                      border: `1.5px solid ${isClaimBtn ? baseColour : 'transparent'}`,\r\n                      padding: '6px 14px',\r\n                      borderRadius: 20,\r\n                      fontSize: 11,\r\n                      fontWeight: 600,\r\n                      cursor: 'pointer',\r\n                      boxShadow: 'none',\r\n                      opacity: visible ? 1 : 0,\r\n                      transform: visible ? 'translateY(0) scale(1)' : 'translateY(6px) scale(.96)',\r\n                      transition: 'opacity .4s cubic-bezier(.4,0,.2,1), transform .4s cubic-bezier(.4,0,.2,1), background .25s, color .25s, border .25s, border-radius .35s cubic-bezier(.4,0,.2,1)',\r\n                      transitionDelay: delay,\r\n                      selectors: {\r\n                        ':hover': isClaimBtn ? { background: unclaimedSelected ? baseColour : '#e3f1fb', color: unclaimedSelected ? '#fff' : baseColour, borderRadius: 6 } : { background: '#f4f6f8', color: baseColour, borderRadius: 6 },\r\n                        ':active': isClaimBtn ? { background: baseColour, color: '#fff', borderRadius: 6, transform: 'scale(0.95)' } : { background: '#e3f1fb', color: baseColour, borderRadius: 6, transform: 'scale(0.95)' },\r\n                      },\r\n                    })}\r\n                  >\r\n                    {btn.label}\r\n                  </button>\r\n                );\r\n              });\r\n            })()}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n  // --- End unclaimed legacy card ---\r\n\r\n  // Dynamic grid layout (claimed only)\r\n  const mainContentStyle = mergeStyles({\r\n    flex: 1,\r\n    display: 'grid',\r\n    gridTemplateColumns: '2.9fr 1.9fr 1.2fr 90px auto',\r\n    alignItems: 'center',\r\n    gap: '20px',\r\n    width: '100%',\r\n  });\r\n\r\n  return (\r\n    <div style={{ \r\n      display: 'flex', \r\n      flexDirection: 'column',\r\n      borderBottom: !isLast ? `1px solid ${isDarkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)'}` : 'none',\r\n    }}>\r\n      {/* Main line item */}\r\n      <div className={lineItemStyle} onClick={handleClick}>\r\n        {/* Standalone pulse removed: integrated into AoW pill for unclaimed */}\r\n        {/* Main content grid */}\r\n        <div className={mainContentStyle}>\r\n        {/* Name, Company (+ Contact for unclaimed) */}\r\n        <div style={{ minWidth: 0, display: 'flex', flexDirection: 'column', gap: '4px' }}>\r\n          <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>\r\n            <CopyableText \r\n              value={`${enquiry.First_Name} ${enquiry.Last_Name}`} \r\n              className={nameStyle} \r\n              label=\"Name\" \r\n            />\r\n            <span style={{\r\n              fontSize: '10px',\r\n              color: isDarkMode ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.5)',\r\n              fontWeight: '500',\r\n              lineHeight: 1\r\n            }}>\r\n              ID {enquiry.ID}\r\n            </span>\r\n            {promotionStatus && (\r\n              <span style={{\r\n                fontSize: 10,\r\n                fontWeight: 600,\r\n                padding: '2px 6px',\r\n                borderRadius: 4,\r\n                backgroundColor: promotionStatus === 'instruction'\r\n                  ? (isDarkMode ? 'rgba(76, 175, 80, 0.15)' : 'rgba(232, 245, 232, 0.6)')\r\n                  : (isDarkMode ? 'rgba(33, 150, 243, 0.15)' : 'rgba(227, 242, 253, 0.6)'),\r\n                color: promotionStatus === 'instruction'\r\n                  ? (isDarkMode ? 'rgba(76, 175, 80, 0.85)' : 'rgba(46, 125, 50, 0.8)')\r\n                  : (isDarkMode ? 'rgba(33, 150, 243, 0.85)' : 'rgba(21, 101, 192, 0.85)'),\r\n                textTransform: 'uppercase' as const,\r\n                letterSpacing: 0.5,\r\n                opacity: 0.9\r\n              }}>\r\n                {promotionStatus === 'instruction' ? 'Instructed' : 'Pitched'}\r\n              </span>\r\n            )}\r\n          </div>\r\n          {enquiry.Company && (\r\n            <div className={companyStyle} style={{ \r\n              whiteSpace: 'nowrap', \r\n              overflow: 'hidden', \r\n              textOverflow: 'ellipsis' \r\n            }}>\r\n              {enquiry.Company}\r\n            </div>\r\n          )}\r\n          {/* Inline contact details for unclaimed */}\r\n          {!isClaimed && (\r\n            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px', minWidth: 0 }}>\r\n              {enquiry.Email ? (\r\n                <CopyableText \r\n                  value={enquiry.Email} \r\n                  className={emailStyle} \r\n                  label=\"Email\" \r\n                />\r\n              ) : (\r\n                <span style={{ fontSize: 11, color: 'rgba(0,0,0,0.35)', fontStyle: 'italic' }}>\r\n                  {isDarkMode ? '—' : '—'}\r\n                </span>\r\n              )}\r\n              {enquiry.Phone_Number ? (\r\n                <CopyableText \r\n                  value={enquiry.Phone_Number} \r\n                  className={emailStyle} \r\n                  label=\"Phone\" \r\n                />\r\n              ) : (\r\n                <span style={{ fontSize: 11, color: 'rgba(0,0,0,0.35)', fontStyle: 'italic' }}>\r\n                  {isDarkMode ? '—' : '—'}\r\n                </span>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Area & Value - Combined (dot + area text for unclaimed, dot only for claimed) */}\r\n        <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>\r\n          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', minWidth: 0 }}>\r\n            {/* Area pill - show full pill for unclaimed, just dot for claimed */}\r\n            {!isClaimed ? (\r\n              <div style={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: '6px',\r\n                background: isDarkMode ? 'rgba(255,255,255,0.07)' : '#e9ecef',\r\n                color: getAreaColor(enquiry.Area_of_Work),\r\n                padding: '4px 12px',\r\n                borderRadius: 16,\r\n                fontSize: 10,\r\n                fontWeight: 600,\r\n                border: isDarkMode ? '1px solid rgba(255,255,255,0.12)' : '1px solid #d5d9dd',\r\n                lineHeight: 1.1,\r\n                whiteSpace: 'nowrap'\r\n              }}>\r\n                <span>{enquiry.Area_of_Work?.toLowerCase().includes('other') || enquiry.Area_of_Work?.toLowerCase().includes('unsure') ? 'Other' : enquiry.Area_of_Work}</span>\r\n              </div>\r\n            ) : (\r\n              <span \r\n                style={{ \r\n                  width: 8, \r\n                  height: 8, \r\n                  borderRadius: '50%', \r\n                  background: getAreaColor(enquiry.Area_of_Work), \r\n                  flexShrink: 0 \r\n                }}\r\n                title={enquiry.Area_of_Work?.toLowerCase().includes('other') || enquiry.Area_of_Work?.toLowerCase().includes('unsure') ? 'Other' : enquiry.Area_of_Work}\r\n              />\r\n            )}\r\n            <div style={{\r\n              fontSize: 12,\r\n              fontWeight: 600,\r\n              color: isDarkMode ? colours.dark.text : colours.light.text\r\n            }}>\r\n              {enquiry.Value ? formatCurrency(enquiry.Value) : 'Not specified'}\r\n            </div>\r\n          </div>\r\n          {enquiry.Type_of_Work && (\r\n            <div style={{\r\n              fontSize: 11,\r\n              color: isDarkMode ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)',\r\n              fontWeight: 500,\r\n              whiteSpace: 'nowrap',\r\n              overflow: 'hidden',\r\n              textOverflow: 'ellipsis'\r\n            }}>\r\n              {enquiry.Type_of_Work}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Date only - ID moved to name section */}\r\n        <div style={{ textAlign: 'right' }}>\r\n          <div style={{\r\n            fontSize: '12px',\r\n            fontWeight: '500',\r\n            color: isDarkMode ? colours.dark.text : colours.light.text\r\n          }}>\r\n            {formatDate(enquiry.Touchpoint_Date)}\r\n          </div>\r\n        </div>\r\n        {isClaimed && (\r\n          <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: 24 }}>\r\n            {claimer && (\r\n              <div style={{\r\n                width: 24,\r\n                height: 24,\r\n                borderRadius: '50%',\r\n                background: isDarkMode ? 'rgba(102,170,232,0.12)' : 'rgba(102,170,232,0.12)',\r\n                color: colours.highlight,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                fontWeight: 700,\r\n                fontSize: 12,\r\n                border: `1px solid ${colours.highlight}50`,\r\n                letterSpacing: '0.2px',\r\n                userSelect: 'none',\r\n              }}>\r\n                {claimer.Initials || (claimer.Email?.split('@')[0]?.slice(0, 2).toUpperCase())}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Actions & global notes chevron (far right) */}\r\n  <div style={{ display: 'flex', alignItems: 'center', gap: '6px', justifyContent: 'flex-end', minWidth: 0 }}>\r\n          {isClaimed && (\r\n            <>\r\n              <button\r\n                className={pitchButtonStyle}\r\n                onClick={(e) => { e.stopPropagation(); onPitch && onPitch(enquiry); }}\r\n                title='Pitch this enquiry'\r\n                style={{ lineHeight: 1 }}\r\n              >\r\n                <Icon iconName=\"Send\" style={{ fontSize: '11px', lineHeight: 1 }} />\r\n                Pitch\r\n              </button>\r\n\r\n              <button\r\n                className={actionBadgeStyle}\r\n                onClick={(e) => { e.stopPropagation(); enquiry.Phone_Number && (window.location.href = `tel:${enquiry.Phone_Number}`); }}\r\n                title=\"Call\"\r\n                style={{ padding: '6px 12px' }}\r\n              >\r\n                <Icon iconName=\"Phone\" style={{ fontSize: '12px' }} />\r\n                <span style={{ fontSize: 11, fontWeight: 600 }}>Call</span>\r\n              </button>\r\n\r\n              <button\r\n                className={actionBadgeStyle}\r\n                onClick={(e) => { e.stopPropagation(); enquiry.Email && (window.location.href = `mailto:${enquiry.Email}?subject=Your%20Enquiry&bcc=1day@followupthen.com`); }}\r\n                title=\"Email\"\r\n                style={{ padding: '6px 12px' }}\r\n              >\r\n                <Icon iconName=\"Mail\" style={{ fontSize: '12px' }} />\r\n                <span style={{ fontSize: 11, fontWeight: 600 }}>Email</span>\r\n              </button>\r\n\r\n              <button\r\n                className={ratingBadgeStyle(enquiry.Rating)}\r\n                onClick={(e) => { e.stopPropagation(); onRate(enquiry.ID); }}\r\n                title={enquiry.Rating ? `Rating: ${enquiry.Rating}` : 'Rate Enquiry'}\r\n                style={{ padding: '6px 12px' }}\r\n              >\r\n                <Icon \r\n                  iconName={enquiry.Rating \r\n                    ? (enquiry.Rating === 'Poor' ? 'DislikeSolid' : enquiry.Rating === 'Neutral' ? 'Like' : 'LikeSolid')\r\n                    : 'Like'\r\n                  }\r\n                  style={{ fontSize: '12px' }}\r\n                />\r\n                <span style={{ fontSize: 11, fontWeight: 600, minWidth: 24, textAlign: 'center' }}>{enquiry.Rating || 'Rate'}</span>\r\n              </button>\r\n            </>\r\n          )}\r\n          {hasNotes && (\r\n            <button\r\n              onClick={(e) => { e.stopPropagation(); setNotesExpanded(!notesExpanded); }}\r\n              title={notesExpanded ? 'Hide notes' : 'Show notes'}\r\n              style={{\r\n                background: 'none',\r\n                border: 'none',\r\n                cursor: 'pointer',\r\n                padding: '4px 4px',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                color: isDarkMode ? 'rgba(255,255,255,0.55)' : 'rgba(0,0,0,0.55)',\r\n                transition: 'color 0.2s, transform 0.25s cubic-bezier(0.4,0,0.2,1)',\r\n                borderRadius: 6,\r\n              }}\r\n              onMouseEnter={(e) => { e.currentTarget.style.color = isDarkMode ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.85)'; }}\r\n              onMouseLeave={(e) => { e.currentTarget.style.color = isDarkMode ? 'rgba(255,255,255,0.55)' : 'rgba(0,0,0,0.55)'; }}\r\n            >\r\n              <Icon iconName={notesExpanded ? 'ChevronUp' : 'ChevronDown'} style={{ fontSize: 14 }} />\r\n            </button>\r\n          )}\r\n        </div>\r\n      </div>\r\n      \r\n      {/* Close main content grid */}\r\n      </div>\r\n      \r\n      {/* Notes Section - only rendered after chevron click */}\r\n      {hasNotes && notesExpanded && (\r\n        <div style={{ \r\n          padding: '10px 20px 16px', \r\n          borderTop: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'}`,\r\n          background: isDarkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)',\r\n          animation: 'dropIn 0.32s cubic-bezier(0.16,1,0.3,1)'\r\n        }}>\r\n          <NotesBlock notes={enquiry.Initial_first_call_notes || ''} />\r\n          {isClaimed && (\r\n            <div style={{\r\n              display: 'flex',\r\n              flexWrap: 'wrap',\r\n              gap: '10px',\r\n              marginTop: '14px'\r\n            }}>\r\n              {/* Inline duplicate of actions for contextual flow if desired - keep just pitch for now? Could remove duplicates if not needed. */}\r\n              {/* Keeping minimal (no duplicates) to avoid clutter. */}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default EnquiryLineItem;\r\n","import React, { useState } from 'react';\r\nimport { Text, Icon, IconButton, TooltipHost, IButtonStyles, Stack } from '@fluentui/react';\r\nimport { mergeStyles } from '@fluentui/react/lib/Styling';\r\nimport { Enquiry } from '../../app/functionality/types';\r\nimport { colours } from '../../app/styles/colours';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport EnquiryLineItem from './EnquiryLineItem';\r\nimport { GroupedEnquiry } from './enquiryGrouping';\r\n\r\ninterface TeamData {\r\n  'Created Date'?: string;\r\n  'Created Time'?: string;\r\n  'Full Name'?: string;\r\n  'Last'?: string;\r\n  'First'?: string;\r\n  'Nickname'?: string;\r\n  'Initials'?: string;\r\n  'Email'?: string;\r\n  'Entra ID'?: string;\r\n  'Clio ID'?: string;\r\n  'Rate'?: number;\r\n  'Role'?: string;\r\n  'AOW'?: string;\r\n}\r\n\r\ninterface GroupedEnquiryCardProps {\r\n  groupedEnquiry: GroupedEnquiry;\r\n  onSelect: (enquiry: Enquiry) => void;\r\n  onRate: (enquiryId: string) => void;\r\n  onPitch?: (enquiry: Enquiry) => void;\r\n  teamData?: TeamData[] | null;\r\n  isLast?: boolean;\r\n  userAOW?: string[]; // List of user's areas of work (lowercase)\r\n  getPromotionStatus?: (enquiry: Enquiry) => 'pitch' | 'instruction' | null;\r\n}\r\n\r\nconst formatCurrency = (value: string): string => {\r\n  const regex = /(?:£)?(\\d{1,3}(?:,\\d{3})*)(?: to £?(\\d{1,3}(?:,\\d{3})*))?/;\r\n  const matches = value.match(regex);\r\n  if (!matches) return value;\r\n\r\n  return matches\r\n    .slice(1)\r\n    .filter(Boolean)\r\n    .map((num) =>\r\n      num.includes('£')\r\n        ? num.replace(/(\\d)(?=(\\d{3})+(?!\\d))/g, '$1,')\r\n        : `£${parseInt(num.replace(/,/g, ''), 10).toLocaleString()}`\r\n    )\r\n    .join(' to ');\r\n};\r\n\r\nconst getAreaColor = (area: string): string => {\r\n  switch (area?.toLowerCase()) {\r\n    case 'commercial':\r\n      return colours.blue;\r\n    case 'construction':\r\n      return colours.orange;\r\n    case 'property':\r\n      return colours.green;\r\n    case 'employment':\r\n      return colours.yellow;\r\n    default:\r\n      return colours.cta;\r\n  }\r\n};\r\n\r\nconst iconButtonStyles = (iconColor: string): IButtonStyles => ({\r\n  root: {\r\n    color: iconColor,\r\n    backgroundColor: 'transparent',\r\n    border: 'none',\r\n    selectors: {\r\n      ':hover': {\r\n        backgroundColor: colours.highlight,\r\n        color: '#ffffff',\r\n      },\r\n      ':focus': {\r\n        backgroundColor: colours.highlight,\r\n        color: '#ffffff',\r\n      },\r\n    },\r\n    height: '32px',\r\n    width: '32px',\r\n    padding: '0px',\r\n    boxShadow: 'none',\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n  },\r\n  icon: {\r\n    fontSize: '16px',\r\n    lineHeight: '1',\r\n    color: iconColor,\r\n  },\r\n});\r\n\r\nconst GroupedEnquiryCard: React.FC<GroupedEnquiryCardProps> = ({ groupedEnquiry, onSelect, onRate, onPitch, teamData, isLast, userAOW, getPromotionStatus }) => {\r\n  const { isDarkMode } = useTheme();\r\n  const [isExpanded, setIsExpanded] = useState(false);\r\n  const { clientName, clientEmail, enquiries, latestDate, areas } = groupedEnquiry;\r\n  const enquiryCount = enquiries.length;\r\n  const latestEnquiry = enquiries[0];\r\n\r\n  const formatDate = (dateStr: string): string => {\r\n    try {\r\n      return new Date(dateStr).toLocaleDateString('en-GB', {\r\n        day: '2-digit',\r\n        month: 'short',\r\n        year: 'numeric',\r\n      });\r\n    } catch {\r\n      return dateStr;\r\n    }\r\n  };\r\n\r\n  const calculateTotalValue = (): string => {\r\n    const values = enquiries\r\n      .map(e => e.Value)\r\n      .filter(v => v && v !== 'Not specified')\r\n      .map(v => {\r\n        const match = v?.match(/£?(\\d{1,3}(?:,\\d{3})*)/);\r\n        return match ? parseInt(match[1].replace(/,/g, ''), 10) : 0;\r\n      });\r\n    \r\n    if (values.length === 0) return 'Not specified';\r\n    \r\n    const total = values.reduce((sum, val) => sum + val, 0);\r\n    return `£${total.toLocaleString()}`;\r\n  };\r\n\r\n  const svgMark = encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 57.56 100\" preserveAspectRatio=\"xMidYMid meet\"><g fill=\"currentColor\" opacity=\"0.22\"><path d=\"M57.56,13.1c0,7.27-7.6,10.19-11.59,11.64-4,1.46-29.98,11.15-34.78,13.1C6.4,39.77,0,41.23,0,48.5v-13.1C0,28.13,6.4,26.68,11.19,24.74c4.8-1.94,30.78-11.64,34.78-13.1,4-1.45,11.59-4.37,11.59-11.64v13.09h0Z\"/><path d=\"M57.56,38.84c0,7.27-7.6,10.19-11.59,11.64s-29.98,11.16-34.78,13.1c-4.8,1.94-11.19,3.4-11.19,10.67v-13.1c0-7.27,6.4-8.73,11.19-10.67,4.8-1.94,30.78-11.64,34.78-13.1,4-1.46,11.59-4.37,11.59-11.64v13.09h0Z\"/><path d=\"M57.56,64.59c0,7.27-7.6,10.19-11.59,11.64-4,1.46-29.98,11.15-34.78,13.1-4.8,1.94-11.19,3.39-11.19,10.67v-13.1c0-7.27,6.4-8.73,11.19-10.67,4.8-1.94,30.78-11.64,34.78-13.1,4-1.45,11.59-4.37,11.59-11.64v13.1h0Z\"/></g></svg>');\r\n  const cardStyle = mergeStyles({\r\n    position: 'relative',\r\n    borderRadius: 6,\r\n    background: isDarkMode ? '#1f2732' : '#ffffff',\r\n    border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)'}`,\r\n    boxShadow: isDarkMode ? '0 4px 16px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.04)' : '0 4px 14px rgba(33,56,82,0.10)',\r\n    padding: '14px 18px 14px 22px',\r\n    marginBottom: isLast ? 0 : 8,\r\n    cursor: 'pointer',\r\n    fontFamily: 'Raleway, sans-serif',\r\n    overflow: 'hidden',\r\n    transition: 'border-color .2s, transform .15s',\r\n    '::after': {\r\n      content: '\"\"',\r\n      position: 'absolute',\r\n      top: 10,\r\n      bottom: 10,\r\n  right: 12,\r\n  width: 168, // bumped width (maintain ratio via contain)\r\n  background: isDarkMode ? 'rgba(255,255,255,0.075)' : 'rgba(6,23,51,0.12)',\r\n      maskImage: `url(\"data:image/svg+xml,${svgMark}\")`,\r\n      WebkitMaskImage: `url(\"data:image/svg+xml,${svgMark}\")`,\r\n      maskRepeat: 'no-repeat',\r\n      WebkitMaskRepeat: 'no-repeat',\r\n      maskPosition: 'center',\r\n      WebkitMaskPosition: 'center',\r\n      maskSize: 'contain',\r\n      WebkitMaskSize: 'contain',\r\n      pointerEvents: 'none',\r\n      mixBlendMode: isDarkMode ? 'screen' : 'multiply',\r\n      filter: 'blur(.2px)',\r\n      zIndex: 0,\r\n    },\r\n    opacity: getPromotionStatus && groupedEnquiry.enquiries.some(eq => getPromotionStatus(eq)) ? 0.6 : 1,\r\n    selectors: {\r\n      ':hover': { transform: 'translateY(-2px)', borderColor: colours.highlight },\r\n      ':active': { transform: 'translateY(-1px)' },\r\n    },\r\n  });\r\n\r\n  const topRow = mergeStyles({ display: 'flex', alignItems: 'flex-start', gap: 16, flexWrap: 'wrap', position: 'relative' });\r\n\r\n  const nameStyle = mergeStyles({\r\n    fontWeight: 600,\r\n    fontSize: 15,\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    marginBottom: 2,\r\n  });\r\n\r\n  const emailStyle = mergeStyles({\r\n    fontSize: 12,\r\n    color: isDarkMode ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)',\r\n    fontWeight: 500,\r\n  });\r\n\r\n  const countBadgeStyle = mergeStyles({\r\n    display: 'inline-flex',\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    backgroundColor: 'rgba(102,170,232,0.15)',\r\n    color: colours.highlight,\r\n    borderRadius: 14,\r\n    padding: '2px 8px',\r\n    fontSize: 11,\r\n    fontWeight: 600,\r\n    marginLeft: 6,\r\n    minWidth: 24,\r\n    height: 22,\r\n  });\r\n\r\n  const metaStyle = mergeStyles({\r\n    fontSize: 13,\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    fontWeight: 600,\r\n  });\r\n\r\n  const valueStyle = mergeStyles({\r\n    fontSize: 13,\r\n    color: colours.highlight,\r\n    fontWeight: 700,\r\n  });\r\n\r\n  const dateStyle = mergeStyles({\r\n    fontSize: 12,\r\n    color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n    fontWeight: 500,\r\n  });\r\n\r\n  const actionsStyle = mergeStyles({ display: 'flex', alignItems: 'center', gap: 6, marginLeft: 'auto' });\r\n\r\n  const expandedContentStyle = mergeStyles({\r\n    padding: '0 16px 10px 16px',\r\n    backgroundColor: isDarkMode ? '#1b2026' : '#f6f8f9',\r\n  });\r\n\r\n  const areaTagsStyle = mergeStyles({\r\n    display: 'flex',\r\n    gap: 4,\r\n    flexWrap: 'wrap',\r\n    marginTop: 4,\r\n  });\r\n\r\n  const areaTagStyle = (area: string) => mergeStyles({\r\n    display: 'inline-block',\r\n    backgroundColor: `${getAreaColor(area)}15`,\r\n    color: getAreaColor(area),\r\n    fontSize: 9,\r\n    fontWeight: 600,\r\n    padding: '3px 6px',\r\n    borderRadius: 10,\r\n    textTransform: 'none',\r\n    letterSpacing: '0.3px',\r\n    border: `1px solid ${getAreaColor(area)}30`\r\n  });\r\n\r\n  const toggleExpanded = (e: React.MouseEvent<any>) => {\r\n    e.stopPropagation();\r\n    setIsExpanded(!isExpanded);\r\n  };\r\n\r\n  const handleMainClick = () => {\r\n    if (enquiryCount === 1) {\r\n      onSelect(latestEnquiry);\r\n    } else {\r\n      setIsExpanded(!isExpanded);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className={cardStyle} onClick={handleMainClick}>\r\n      {/* Left accent bar */}\r\n      <span style={{ position: 'absolute', top: 0, left: 0, bottom: 0, width: 2, background: colours.highlight, opacity: .95 }} />\r\n      <div className={topRow}>\r\n        <div style={{ minWidth: 160 }}>\r\n          <div className={nameStyle}>\r\n            {clientName}\r\n            <span className={countBadgeStyle}>{enquiryCount}</span>\r\n            {getPromotionStatus && (() => {\r\n              // Check if any enquiry in the group has been promoted\r\n              const promotedEnquiry = groupedEnquiry.enquiries.find(eq => getPromotionStatus(eq));\r\n              const status = promotedEnquiry ? getPromotionStatus(promotedEnquiry) : null;\r\n              return status && (\r\n                <span style={{\r\n                  fontSize: 9,\r\n                  fontWeight: 500,\r\n                  padding: '2px 5px',\r\n                  borderRadius: 3,\r\n                  backgroundColor: status === 'instruction' ? (isDarkMode ? 'rgba(76, 175, 80, 0.15)' : 'rgba(232, 245, 232, 0.6)') : (isDarkMode ? 'rgba(33, 150, 243, 0.15)' : 'rgba(227, 242, 253, 0.6)'),\r\n                  color: status === 'instruction' ? (isDarkMode ? 'rgba(76, 175, 80, 0.8)' : 'rgba(46, 125, 50, 0.7)') : (isDarkMode ? 'rgba(33, 150, 243, 0.8)' : 'rgba(21, 101, 192, 0.7)'),\r\n                  textTransform: 'uppercase',\r\n                  letterSpacing: 0.5,\r\n                  marginLeft: 6,\r\n                  opacity: 0.85\r\n                }}>\r\n                  {status === 'instruction' ? 'Instructed' : 'Pitched'}\r\n                </span>\r\n              );\r\n            })()}\r\n          </div>\r\n          <div className={emailStyle}>{clientEmail}</div>\r\n          <div className={areaTagsStyle}>\r\n            {areas.map((area, idx) => (\r\n              <span key={idx} className={areaTagStyle(area)}>{area}</span>\r\n            ))}\r\n          </div>\r\n        </div>\r\n        <div>\r\n          <div className={metaStyle}>{latestEnquiry.Area_of_Work?.toLowerCase().includes('other') || latestEnquiry.Area_of_Work?.toLowerCase().includes('unsure') ? 'Other' : latestEnquiry.Area_of_Work}</div>\r\n          {latestEnquiry.Type_of_Work && (\r\n            <Text variant=\"small\" styles={{ root: { color: isDarkMode ? colours.dark.text : colours.light.text, fontSize: 13, opacity: .7 } }}>{latestEnquiry.Type_of_Work}</Text>\r\n          )}\r\n        </div>\r\n        <div>\r\n          <div className={valueStyle}>{calculateTotalValue()}</div>\r\n          <Text variant=\"small\" styles={{ root: { color: isDarkMode ? colours.dark.subText : colours.light.subText, fontSize: 12 } }}>Combined value</Text>\r\n        </div>\r\n        <div>\r\n          <div className={dateStyle}>{formatDate(latestDate)}</div>\r\n          <Text variant=\"small\" styles={{ root: { color: isDarkMode ? colours.dark.subText : colours.light.subText, fontSize: 12 } }}>Latest enquiry</Text>\r\n        </div>\r\n        <div className={actionsStyle} onClick={e => e.stopPropagation()}>\r\n          <TooltipHost content=\"Call\">\r\n            <IconButton iconProps={{ iconName: 'Phone' }} onClick={() => latestEnquiry.Phone_Number && (window.location.href = `tel:${latestEnquiry.Phone_Number}`)} styles={iconButtonStyles(isDarkMode ? colours.dark.text : colours.light.text)} />\r\n          </TooltipHost>\r\n          <TooltipHost content=\"Email\">\r\n            <IconButton iconProps={{ iconName: 'Mail' }} onClick={() => clientEmail && (window.location.href = `mailto:${clientEmail}?subject=Your%20Enquiry&bcc=1day@followupthen.com`)} styles={iconButtonStyles(isDarkMode ? colours.dark.text : colours.light.text)} />\r\n          </TooltipHost>\r\n          <TooltipHost content={enquiryCount > 1 ? (isExpanded ? 'Collapse' : 'Expand') : 'View Details'}>\r\n            <IconButton iconProps={{ iconName: enquiryCount > 1 ? (isExpanded ? 'ChevronUp' : 'ChevronDown') : 'View' }} onClick={toggleExpanded} styles={iconButtonStyles(isDarkMode ? colours.dark.text : colours.light.text)} />\r\n          </TooltipHost>\r\n        </div>\r\n      </div>\r\n      {isExpanded && enquiryCount > 1 && (\r\n        <div className={expandedContentStyle} style={{ marginTop: 12 }}>\r\n          <Stack tokens={{ childrenGap: 8 }}>\r\n            <Text variant=\"medium\" styles={{ root: { fontWeight: 600, color: isDarkMode ? colours.dark.text : colours.light.text, marginBottom: 8 } }}>All Enquiries ({enquiryCount})</Text>\r\n            {enquiries.map((enquiry, idx) => (\r\n              <div key={enquiry.ID} style={{ borderRadius: 4, overflow: 'hidden' }}>\r\n                <EnquiryLineItem \r\n                  enquiry={enquiry} \r\n                  onSelect={onSelect} \r\n                  onRate={onRate} \r\n                  onPitch={onPitch} \r\n                  teamData={teamData} \r\n                  isLast={idx === enquiries.length - 1} \r\n                  userAOW={undefined}\r\n                  promotionStatus={getPromotionStatus ? getPromotionStatus(enquiry) : null}\r\n                />\r\n              </div>\r\n            ))}\r\n          </Stack>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GroupedEnquiryCard;\r\n","import { Enquiry } from '../../app/functionality/types';\r\n\r\nexport interface GroupedEnquiry {\r\n  clientKey: string;\r\n  clientName: string;\r\n  clientEmail: string;\r\n  enquiries: Enquiry[];\r\n  latestDate: string;\r\n  totalValue: number;\r\n  areas: string[];\r\n}\r\n\r\n/**\r\n * Groups enquiries by client based on email address and name\r\n * @param enquiries Array of enquiries to group\r\n * @returns Array of grouped enquiries with repeated clients combined\r\n */\r\nexport function groupEnquiriesByClient(enquiries: Enquiry[]): GroupedEnquiry[] {\r\n  const groupMap = new Map<string, GroupedEnquiry>();\r\n\r\n  enquiries.forEach((enquiry) => {\r\n    // Create a unique key based on email and normalized name\r\n    const normalizedEmail = enquiry.Email?.toLowerCase().trim() || '';\r\n    const normalizedName = `${enquiry.First_Name?.toLowerCase().trim()} ${enquiry.Last_Name?.toLowerCase().trim()}`.trim();\r\n    \r\n    // Use email as primary key, fall back to name if email is missing\r\n    const clientKey = normalizedEmail || normalizedName;\r\n    \r\n    if (!clientKey) return; // Skip enquiries without identifiable client info\r\n\r\n    const clientName = `${enquiry.First_Name || ''} ${enquiry.Last_Name || ''}`.trim();\r\n    const clientEmail = enquiry.Email || '';\r\n\r\n    if (groupMap.has(clientKey)) {\r\n      // Add to existing group\r\n      const existingGroup = groupMap.get(clientKey)!;\r\n      existingGroup.enquiries.push(enquiry);\r\n      \r\n      // Update latest date if this enquiry is more recent\r\n      if (enquiry.Touchpoint_Date > existingGroup.latestDate) {\r\n        existingGroup.latestDate = enquiry.Touchpoint_Date;\r\n      }\r\n      \r\n      // Add area if not already present\r\n      if (enquiry.Area_of_Work && !existingGroup.areas.includes(enquiry.Area_of_Work)) {\r\n        existingGroup.areas.push(enquiry.Area_of_Work);\r\n      }\r\n    } else {\r\n      // Create new group\r\n      groupMap.set(clientKey, {\r\n        clientKey,\r\n        clientName,\r\n        clientEmail,\r\n        enquiries: [enquiry],\r\n        latestDate: enquiry.Touchpoint_Date || '',\r\n        totalValue: 0, // Will be calculated later if needed\r\n        areas: enquiry.Area_of_Work ? [enquiry.Area_of_Work] : [],\r\n      });\r\n    }\r\n  });\r\n\r\n  // Convert map to array and sort by latest date (most recent first)\r\n  const groupedEnquiries = Array.from(groupMap.values());\r\n  \r\n  // Sort enquiries within each group by date (most recent first)\r\n  groupedEnquiries.forEach(group => {\r\n    group.enquiries.sort((a, b) => {\r\n      const dateA = new Date(a.Touchpoint_Date || '').getTime();\r\n      const dateB = new Date(b.Touchpoint_Date || '').getTime();\r\n      return dateB - dateA; // Most recent first\r\n    });\r\n  });\r\n\r\n  // Sort groups by latest enquiry date (most recent first)\r\n  groupedEnquiries.sort((a, b) => {\r\n    const dateA = new Date(a.latestDate).getTime();\r\n    const dateB = new Date(b.latestDate).getTime();\r\n    return dateB - dateA;\r\n  });\r\n\r\n  return groupedEnquiries;\r\n}\r\n\r\n/**\r\n * Separates single enquiries from grouped enquiries\r\n * @param groupedEnquiries Array of grouped enquiries\r\n * @returns Object with single enquiries and repeated enquiries separated\r\n */\r\nexport function separateRepeatedEnquiries(groupedEnquiries: GroupedEnquiry[]): {\r\n  singleEnquiries: Enquiry[];\r\n  repeatedEnquiries: GroupedEnquiry[];\r\n} {\r\n  const singleEnquiries: Enquiry[] = [];\r\n  const repeatedEnquiries: GroupedEnquiry[] = [];\r\n\r\n  groupedEnquiries.forEach(group => {\r\n    if (group.enquiries.length === 1) {\r\n      singleEnquiries.push(group.enquiries[0]);\r\n    } else {\r\n      repeatedEnquiries.push(group);\r\n    }\r\n  });\r\n\r\n  return { singleEnquiries, repeatedEnquiries };\r\n}\r\n\r\n/**\r\n * Gets a mixed array of single and grouped enquiries for display\r\n * @param enquiries Array of enquiries to process\r\n * @returns Array containing both single enquiries and grouped enquiries\r\n */\r\nexport function getMixedEnquiryDisplay(enquiries: Enquiry[]): (Enquiry | GroupedEnquiry)[] {\r\n  const grouped = groupEnquiriesByClient(enquiries);\r\n  const result: (Enquiry | GroupedEnquiry)[] = [];\r\n\r\n  grouped.forEach(group => {\r\n    if (group.enquiries.length === 1) {\r\n      // Single enquiry - add the enquiry itself\r\n      result.push(group.enquiries[0]);\r\n    } else {\r\n      // Multiple enquiries - add the grouped enquiry\r\n      result.push(group);\r\n    }\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Type guard to check if an item is a GroupedEnquiry\r\n * @param item Item to check\r\n * @returns True if the item is a GroupedEnquiry\r\n */\r\nexport function isGroupedEnquiry(item: Enquiry | GroupedEnquiry): item is GroupedEnquiry {\r\n  return 'enquiries' in item && Array.isArray((item as GroupedEnquiry).enquiries);\r\n}\r\n","// src/app/customisation/PracticeAreaPitch.ts\r\n// invisible change 2\r\n\r\nexport interface Template {\r\n  subject: string;\r\n  intro: string;\r\n}\r\n\r\nexport interface PracticeAreaCategory {\r\n  [templateName: string]: Template;\r\n}\r\n\r\nexport interface PracticeAreaPitchType {\r\n  Commercial: PracticeAreaCategory;\r\n  Construction: PracticeAreaCategory;\r\n  Property: PracticeAreaCategory;\r\n  Employment: PracticeAreaCategory;\r\n}\r\n\r\nconst PracticeAreaPitch: PracticeAreaPitchType = {\r\n  Commercial: {\r\n    \"Director Rights & Dispute Advice\": {\r\n      subject: \"Director Rights & Dispute Advice\",\r\n      intro: `Thank you for reaching out regarding director rights and dispute advice. We're well-placed to assist you.\r\n      \r\nDirector disputes are often complex and require expert guidance to resolve effectively.`,\r\n    },\r\n    \"Shareholder Rights & Dispute Advice\": {\r\n      subject: \"Shareholder Rights & Dispute Advice\",\r\n      intro: `Thank you for reaching out regarding shareholder rights and dispute advice. We're well-placed to assist you.\r\n      \r\nShareholder disputes can disrupt businesses significantly and benefit from a structured resolution approach.`,\r\n    },\r\n    \"Civil/Commercial Fraud Advice\": {\r\n      subject: \"Commercial Fraud Advice\",\r\n      intro: `Thank you for reaching out regarding commercial fraud advice. We're well-placed to assist you.\r\n      \r\nCommercial fraud cases often require swift and precise action to mitigate losses.`,\r\n    },\r\n    \"Partnership Advice\": {\r\n      subject: \"Partnership Advice\",\r\n      intro: `Thank you for reaching out regarding partnership advice. We're well-placed to assist you.\r\n      \r\nPartnership matters often involve intricate legal considerations that we can help navigate effectively.`,\r\n    },\r\n    \"Business Contract Dispute\": {\r\n      subject: \"Business Contract Dispute\",\r\n      intro: `Thank you for reaching out regarding your business contract dispute. We're well-placed to assist you.\r\n      \r\nBusiness contract disputes require clear and decisive action to protect your interests.`,\r\n    },\r\n    \"Unpaid Loan Recovery\": {\r\n      subject: \"Unpaid Loan Recovery\",\r\n      intro: `Thank you for reaching out regarding unpaid loan recovery. We're well-placed to assist you.\r\n      \r\nRecovering unpaid loans efficiently is crucial for maintaining your business's financial health.`,\r\n    },\r\n    \"Contentious Probate\": {\r\n      subject: \"Contentious Probate\",\r\n      intro: `Thank you for reaching out regarding contentious probate. We're well-placed to assist you.\r\n      \r\nContentious probate matters require sensitive and expert handling to ensure fair outcomes.`,\r\n    },\r\n    \"Statutory Demand - Drafting\": {\r\n      subject: \"Statutory Demand - Drafting\",\r\n      intro: `Thank you for reaching out regarding statutory demand drafting. We're well-placed to assist you.\r\n      \r\nDrafting statutory demands accurately is essential for effective debt recovery.`,\r\n    },\r\n    \"Statutory Demand - Advising\": {\r\n      subject: \"Statutory Demand - Advising\",\r\n      intro: `Thank you for reaching out regarding statutory demand advising. We're well-placed to assist you.\r\n      \r\nAdvising on statutory demands ensures you understand your rights and obligations fully.`,\r\n    },\r\n    \"Winding Up Petition Advice\": {\r\n      subject: \"Winding Up Petition Advice\",\r\n      intro: `Thank you for reaching out regarding winding up petition advice. We're well-placed to assist you.\r\n      \r\nWinding up petitions require strategic advice to navigate the complexities involved.`,\r\n    },\r\n    \"Bankruptcy Petition Advice\": {\r\n      subject: \"Bankruptcy Petition Advice\",\r\n      intro: `Thank you for reaching out regarding bankruptcy petition advice. We're well-placed to assist you.\r\n      \r\nBankruptcy petitions necessitate careful planning and informed decision-making.`,\r\n    },\r\n    \"Injunction Advice\": {\r\n      subject: \"Injunction Advice\",\r\n      intro: `Thank you for reaching out regarding injunction advice. We're well-placed to assist you.\r\n      \r\nInjunctions are powerful legal tools that require precise application to be effective.`,\r\n    },\r\n    \"Intellectual Property\": {\r\n      subject: \"Intellectual Property Assistance\",\r\n      intro: `Thank you for reaching out regarding intellectual property matters. We're well-placed to assist you.\r\n      \r\nProtecting your intellectual property is vital for maintaining your competitive edge.`,\r\n    },\r\n    \"Professional Negligence\": {\r\n      subject: \"Professional Negligence Assistance\",\r\n      intro: `Thank you for reaching out regarding professional negligence. We're well-placed to assist you.\r\n      \r\nAddressing professional negligence requires thorough investigation and expert legal action.`,\r\n    },\r\n    \"Unpaid Invoice/Debt Dispute\": {\r\n      subject: \"Unpaid Invoice or Debt Dispute\",\r\n      intro: `Thank you for reaching out regarding unpaid invoices or debt disputes. We're well-placed to assist you.\r\n      \r\nResolving unpaid invoices swiftly is essential for maintaining your business's cash flow.`,\r\n    },\r\n    \"Commercial Contract - Drafting\": {\r\n      subject: \"Commercial Contract - Drafting\",\r\n      intro: `Thank you for reaching out regarding commercial contract drafting. We're well-placed to assist you.\r\n      \r\nDrafting robust commercial contracts is key to safeguarding your business interests.`,\r\n    },\r\n    \"Company Restoration\": {\r\n      subject: \"Company Restoration Assistance\",\r\n      intro: `Thank you for reaching out regarding company restoration. We're well-placed to assist you.\r\n      \r\nRestoring your company requires a strategic approach to navigate legal and financial challenges.`,\r\n    },\r\n    \"Small Claim Advice\": {\r\n      subject: \"Small Claim Advice\",\r\n      intro: `Thank you for reaching out regarding small claim advice. We're well-placed to assist you.\r\n      \r\nHandling small claims effectively ensures timely and cost-efficient resolutions.`,\r\n    },\r\n    \"Trust Advice\": {\r\n      subject: \"Trust Advice\",\r\n      intro: `Thank you for reaching out regarding trust advice. We're well-placed to assist you.\r\n      \r\nManaging trusts requires meticulous legal oversight to ensure compliance and efficacy.`,\r\n    },\r\n    \"Terms and Conditions - Drafting\": {\r\n      subject: \"Terms and Conditions - Drafting\",\r\n      intro: `Thank you for reaching out regarding drafting terms and conditions. We're well-placed to assist you.\r\n      \r\nWell-drafted terms and conditions protect your business and set clear expectations.`,\r\n    },\r\n    \"Miscellaneous (None of the above)\": {\r\n      subject: \"Assistance with Your Enquiry\",\r\n      intro: `Thank you for reaching out regarding your enquiry. We're well-placed to assist you.`,\r\n    },\r\n  },\r\n\r\n  Construction: {\r\n    \"Final Account Recovery\": {\r\n      subject: \"Final Account Recovery\",\r\n      intro: `Thank you for reaching out regarding final account recovery. We're well-placed to assist you.\r\n      \r\nRecovering final accounts promptly ensures financial stability for ongoing projects.`,\r\n    },\r\n    \"Retention Recovery Advice\": {\r\n      subject: \"Retention Recovery Advice\",\r\n      intro: `Thank you for reaching out regarding retention recovery advice. We're well-placed to assist you.\r\n      \r\nRetention recovery disputes often require clear contractual understanding to resolve effectively.`,\r\n    },\r\n    \"Adjudication Advice & Dispute\": {\r\n      subject: \"Adjudication Advice & Dispute\",\r\n      intro: `Thank you for reaching out regarding adjudication advice and dispute. We're well-placed to assist you.\r\n      \r\nAdjudication disputes require timely and informed legal intervention to ensure fair outcomes.`,\r\n    },\r\n    \"Construction Contract Advice\": {\r\n      subject: \"Construction Contract Advice\",\r\n      intro: `Thank you for reaching out regarding construction contract advice. We're well-placed to assist you.\r\n      \r\nProviding sound construction contract advice is essential for the success and compliance of your projects.`,\r\n    },\r\n    \"Interim Payment Recovery\": {\r\n      subject: \"Interim Payment Recovery\",\r\n      intro: `Thank you for reaching out regarding interim payment recovery. We're well-placed to assist you.\r\n      \r\nRecovering interim payments ensures the smooth financial flow of your construction projects.`,\r\n    },\r\n    \"Contract Dispute\": {\r\n      subject: \"Contract Dispute Assistance\",\r\n      intro: `Thank you for reaching out regarding a contract dispute. We're well-placed to assist you.\r\n      \r\nResolving contract disputes promptly is crucial to maintaining project timelines and relationships.`,\r\n    },\r\n    \"Miscellaneous (None of the above)\": {\r\n      subject: \"Assistance with Your Enquiry\",\r\n      intro: `Thank you for reaching out regarding your enquiry. We're well-placed to assist you.`,\r\n    },\r\n  },\r\n\r\n  Property: {\r\n    \"Landlord & Tenant - Commercial Dispute\": {\r\n      subject: \"Landlord & Tenant - Commercial Dispute\",\r\n      intro: `Thank you for reaching out regarding your landlord & tenant - commercial dispute. We're well-placed to assist you.\r\n      \r\nLandlord and tenant disputes require a balanced approach to protect interests effectively.`,\r\n    },\r\n    \"Landlord & Tenant - Residential Dispute\": {\r\n      subject: \"Landlord & Tenant - Residential Dispute\",\r\n      intro: `Thank you for reaching out regarding your landlord & tenant - residential dispute. We're well-placed to assist you.\r\n      \r\nResidential disputes can escalate quickly and benefit from timely, informed action.`,\r\n    },\r\n    \"Boundary and Nuisance Advice\": {\r\n      subject: \"Boundary and Nuisance Advice\",\r\n      intro: `Thank you for reaching out regarding boundary and nuisance advice. We're well-placed to assist you.\r\n      \r\nBoundary and nuisance matters require clear legal guidance to resolve effectively.`,\r\n    },\r\n    \"Trust of Land (TOLATA) Advice\": {\r\n      subject: \"Trust of Land (TOLATA) Advice\",\r\n      intro: `Thank you for reaching out regarding Trust of Land (TOLATA) advice. We're well-placed to assist you.\r\n      \r\nTOLATA matters involve specific legal frameworks that we can navigate on your behalf.`,\r\n    },\r\n    \"Service Charge Recovery & Dispute Advice\": {\r\n      subject: \"Service Charge Recovery & Dispute Advice\",\r\n      intro: `Thank you for reaching out regarding service charge recovery and dispute advice. We're well-placed to assist you.\r\n      \r\nEffective management of service charge disputes is essential for maintaining property relationships.`,\r\n    },\r\n    \"Breach of Lease Advice\": {\r\n      subject: \"Breach of Lease Advice\",\r\n      intro: `Thank you for reaching out regarding breach of lease advice. We're well-placed to assist you.\r\n      \r\nAddressing breaches of lease agreements requires precise legal intervention to protect your interests.`,\r\n    },\r\n    \"Terminal Dilapidations Advice\": {\r\n      subject: \"Terminal Dilapidations Advice\",\r\n      intro: `Thank you for reaching out regarding terminal dilapidations advice. We're well-placed to assist you.\r\n      \r\nManaging terminal dilapidations effectively ensures compliance and mitigates potential disputes.`,\r\n    },\r\n    \"Investment Sale and Ownership - Advice\": {\r\n      subject: \"Investment Sale and Ownership Advice\",\r\n      intro: `Thank you for reaching out regarding investment sale and ownership advice. We're well-placed to assist you.\r\n      \r\nStrategic advice on investment sales and ownership structures can significantly benefit your business operations.`,\r\n    },\r\n    \"Trespass\": {\r\n      subject: \"Trespass Assistance\",\r\n      intro: `Thank you for reaching out regarding trespass matters. We're well-placed to assist you.\r\n      \r\nAddressing trespass issues promptly is essential to protect your property rights.`,\r\n    },\r\n    \"Right of Way\": {\r\n      subject: \"Right of Way Assistance\",\r\n      intro: `Thank you for reaching out regarding right of way matters. We're well-placed to assist you.\r\n      \r\nEnsuring clear and enforceable rights of way is crucial for property management and usage.`,\r\n    },\r\n    \"Miscellaneous (None of the above)\": {\r\n      subject: \"Assistance with Your Enquiry\",\r\n      intro: `Thank you for reaching out regarding your enquiry. We're well-placed to assist you.`,\r\n    },\r\n  },\r\n\r\n  Employment: {\r\n    \"Employment Contract - Drafting\": {\r\n      subject: \"Employment Contract - Drafting\",\r\n      intro: `Thank you for reaching out regarding employment contract drafting. We're well-placed to assist you.\r\n      \r\nDrafting employment contracts correctly is crucial to ensuring compliance and avoiding future disputes.`,\r\n    },\r\n    \"Employment Retainer Instruction\": {\r\n      subject: \"Employment Retainer Instruction\",\r\n      intro: `Thank you for reaching out regarding employment retainer instruction. We're well-placed to assist you.\r\n      \r\nEstablishing a retainer agreement ensures ongoing support for your employment law needs.`,\r\n    },\r\n    \"Settlement Agreement - Drafting\": {\r\n      subject: \"Settlement Agreement - Drafting\",\r\n      intro: `Thank you for reaching out regarding settlement agreement drafting. We're well-placed to assist you.\r\n      \r\nDrafting settlement agreements accurately is essential for fair and enforceable resolutions.`,\r\n    },\r\n    \"Settlement Agreement - Advising\": {\r\n      subject: \"Settlement Agreement - Advising\",\r\n      intro: `Thank you for reaching out regarding settlement agreement advising. We're well-placed to assist you.\r\n      \r\nProviding expert advice on settlement agreements ensures clear and mutually beneficial terms.`,\r\n    },\r\n    \"Handbook - Drafting\": {\r\n      subject: \"Handbook - Drafting\",\r\n      intro: `Thank you for reaching out regarding handbook drafting. We're well-placed to assist you.\r\n      \r\nCreating comprehensive employee handbooks is vital for clear workplace policies and compliance.`,\r\n    },\r\n    \"Policy - Drafting\": {\r\n      subject: \"Policy - Drafting\",\r\n      intro: `Thank you for reaching out regarding policy drafting. We're well-placed to assist you.\r\n      \r\nDrafting effective workplace policies is essential for maintaining a compliant and harmonious work environment.`,\r\n    },\r\n    \"Redundancy - Advising\": {\r\n      subject: \"Redundancy - Advising\",\r\n      intro: `Thank you for reaching out regarding redundancy advising. We're well-placed to assist you.\r\n      \r\nProviding clear and compassionate advice on redundancies helps manage the process smoothly and fairly.`,\r\n    },\r\n    \"Sick Leave - Advising\": {\r\n      subject: \"Sick Leave - Advising\",\r\n      intro: `Thank you for reaching out regarding sick leave advising. We're well-placed to assist you.\r\n      \r\nOffering guidance on sick leave policies ensures compliance and supports employee well-being.`,\r\n    },\r\n    \"Disciplinary - Advising\": {\r\n      subject: \"Disciplinary - Advising\",\r\n      intro: `Thank you for reaching out regarding disciplinary advising. We're well-placed to assist you.\r\n      \r\nNavigating disciplinary actions requires careful legal consideration to ensure fairness and compliance.`,\r\n    },\r\n    \"Restrictive Covenant Advice\": {\r\n      subject: \"Restrictive Covenant Advice\",\r\n      intro: `Thank you for reaching out regarding restrictive covenant advice. We're well-placed to assist you.\r\n      \r\nEnsuring your restrictive covenants are enforceable protects your business interests effectively.`,\r\n    },\r\n    \"Post Termination Dispute\": {\r\n      subject: \"Post Termination Dispute Assistance\",\r\n      intro: `Thank you for reaching out regarding post termination disputes. We're well-placed to assist you.\r\n      \r\nResolving post termination disputes promptly helps maintain professional relationships and legal compliance.`,\r\n    },\r\n    \"Employment Tribunal Claim - Advising\": {\r\n      subject: \"Employment Tribunal Claim - Advising\",\r\n      intro: `Thank you for reaching out regarding employment tribunal claim advising. We're well-placed to assist you.\r\n      \r\nProviding expert advice for tribunal claims ensures your case is presented effectively and professionally.`,\r\n    },\r\n    \"Miscellaneous (None of the above)\": {\r\n      subject: \"Assistance with Your Enquiry\",\r\n      intro: `Thank you for reaching out regarding your enquiry. We're well-placed to assist you.`,\r\n    },\r\n  },\r\n};\r\n\r\nexport default PracticeAreaPitch;\r\n","\r\nimport { TemplateBlock } from './ProductionTemplateBlocks';\r\n// invisible change 3\r\n\r\nconst reviewText = `In the above context I need to review your situation and the background and current position in more detail, including documents that are relevant to your situation. This will enable me to provide you with initial advice on your current position and your best next steps.`;\r\n\r\nconst costText = `We charge on a time recorded basis and record all time in 6 minute units. This includes for emails in and out and telephone attendances, and all steps on your behalf. I am a [Position] and my hourly rate is [Rate]. We work as a team and a number of colleagues may assist in relation to various steps in relation to your matter, at different times. Their time will be recorded and charged on the basis of their hourly rates as applicable from time to time – these are all lower than £395+VAT. For the initial work and review above you will need to budget in the region of approximately [Amount] + VAT. This is an estimate and not a fixed fee; the cost will ultimately depend on the time spent including the scale of documents and enquiries received from you.`;\r\n\r\nexport const templateBlocks: TemplateBlock[] = [\r\n  {\r\n    title: 'Introduction',\r\n    description: 'Acknowledge the enquiry.',\r\n    placeholder: '[FE Introduction Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Standard Acknowledgment',\r\n        previewText: `Thank you for your enquiry to Helix Law. We\\u2019re a specialist firm of solicitors only dealing with litigation of disputes and we act nationally. We often deal with disputes such as yours and I am confident we are well-placed to assist in relation to your matter.`,\r\n      },\r\n      {\r\n        label: 'Follow-Up After Call',\r\n        previewText: `Thank you for your enquiry and for your time on the phone earlier. It was good speaking with you.\\n\\nThe purpose of this email is to briefly follow up on our conversation.`,\r\n      },\r\n      {\r\n        label: 'Missed Call Acknowledgment',\r\n        previewText: `Thank you for your enquiry to Helix Law. I have tried to call you to discuss your matter but was unable to reach you.\\n\\nAs a starting point, if you prefer, please email me a brief summary of the background and current position. I will briefly review the content and will come back to you and we can take it from there.`,\r\n      },\r\n      {\r\n        label: 'Apology for Delay',\r\n        previewText: `Thank you for your enquiry to Helix Law. Please accept my apology for the slight delay in my contacting you.\\n\\nI have only limited information regarding your dispute. As a starting point please can you email me a brief summary of the background and current position. I will briefly review the content and will come back to you and we can take it from there.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Issue Summary',\r\n    description: 'Summarise the dispute and possible remedies.',\r\n    placeholder: '[Issue Summary Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      { label: 'The Dispute', previewText: 'The Dispute\\n\\nYou have provided an initial outline of the position that [INSERT]' },\r\n      {\r\n        label: 'Current Position and Problems',\r\n        previewText: `We have discussed that you are [INSERT]. You have a dispute with [INSERT] because [INSERT] and have confirmed that [INSERT].\\n\\nThe dispute with [INSERT] situation creates difficulty for you for obvious reasons, including because [INSERT].\\n\\nIn addition to the above, additional problems arise and need to be addressed, such as [INSERT].`,\r\n      },\r\n      {\r\n        label: 'Potential Causes of Action and Remedies',\r\n        previewText: `Potential Causes of Action and Remedies\\n\\nAssuming that you can evidence the position above, then there are likely to be the following causes of action.\\n\\nIt is vital that we work together to strategically position you around the following key areas:\\n\\nX\\nY\\nZ\\n\\nI am experienced in dealing with this type of issue and am happy to assist you and the key is from this point on to carefully position you so that you are in a sufficiently strong position that you can force the Defendants to reach a sensible commercial settlement or if they will not do so proceed to court and obtain the same or a better result, while of course putting you in the best possible position to recover the costs you incur in the litigation from them.\\n\\nIn the context of a dispute worth in the high hundreds of thousands or millions, from a cost v benefit analysis, my initial view is it stacks up for you to incur the costs for the initial review below.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Scope & Cost',\r\n    description: 'Outline our proposed work and costs.',\r\n    placeholder: '[Scope & Cost Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Initial Review & Advice',\r\n        previewText: `Initial Steps- Review and Advice\\n\\nI am experienced in dealing with this type of issue and am happy to assist you. At this initial stage it is necessary and incredibly important to review the background and current position so that we can then advise on your best next steps.\\n\\nThis will require an initial review of core documents such as [INSERT the contracts, notices, demands, accounts, relevant correspondence set out below] so that we can be as clear as possible on the factual position with companies house and land registry. I then anticipate being able to provide initial advice on your current position and best next steps.`,\r\n      },\r\n      {\r\n        label: 'Shareholder or Statutory Demand',\r\n        previewText: `${reviewText}\\n\\nTo assist me in completing the review please provide the relevant documents and a brief summary. On receipt I will confirm our time and cost estimate for our review and advice.`,\r\n      },\r\n      { label: 'Cost Estimate', previewText: costText },\r\n      {\r\n        label: 'CFA',\r\n        previewText: `I am aware that you are seeking alternative funding regarding your matter commonly known as a Conditional Fee Agreement, or 'no win, no fee' agreement. We are not obliged to offer this form of funding but I am happy to consider doing so. This is subject to us entering into a separate funding agreement between us (a contract). Transparently we only offer no win, no fee funding where it stacks up for you and for us and we need to be sufficiently confident in your prospects of success. At this initial stage please therefore provide the initial documents and information I have requested to enable me to initially briefly review whether this will be appropriate.`,\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Next Steps',\r\n    description: 'Required documents and how to instruct us.',\r\n    placeholder: '[Next Steps Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      { label: 'Required Documents', previewText: 'The contract; Any relevant correspondence; Settlement Agreement; Shareholders\\' Agreement; Financial Statements; Invoices or Asset Information' },\r\n      {\r\n        label: 'Instruct Helix Law - Pitch',\r\n        previewText: `Please confirm your instructions by clicking <a href=\"[InstructLink]\" target=\"_blank\" class=\"insert-placeholder\" data-insert>INSTRUCT HELIX LAW</a>. This single link will verify your identity, request the key documents and take funds on account in a quick and transparent checkout process: [CheckoutLink]. Once complete we'll open a file immediately and send you our Client Care Letter setting out the terms of our retainer. If you have any queries I'm very happy to discuss them without charge.`,\r\n      },\r\n      { label: 'Meeting Link', previewText: `You are welcome to schedule a meeting using the link below:\\n\\nhttps://calendly.com/helixlaw-fe` },\r\n    ],\r\n  },\r\n  {\r\n    title: 'Closing',\r\n    description: 'Final notes and optional review request.',\r\n    placeholder: '[Closing Placeholder]',\r\n    isMultiSelect: true,\r\n    options: [\r\n      {\r\n        label: 'Closing',\r\n        previewText: `I hope the above helps and look forward to helping resolve your matter.\\n\\nThere is obviously some degree of complexity factually and legally in relation to your matter. We\\u2019re a specialist team and I hope to assist you navigate the process effectively to achieve a positive outcome.\\n\\nTo be clear, when you have completed the above steps we will review the position and at our discretion will open a file. We will then set out the terms of our retainer and file with you and will ask you to confirm that those terms are accepted. Only at that stage will a retainer be confirmed between us. Although unusual, we may decline to act for you for any reason in which case any monies paid by you will be returned without charge. I hope the above makes sense and is clear but don't hesitate to contact me if you have any queries and I will be happy to help.`,\r\n      },\r\n      {\r\n        label: 'Request for Review',\r\n        previewText: `I hope the above [and our call] is useful and of course come back to me if I can help you further.\\n\\nIn the meantime, I\\u2019m wondering if you can help me by providing a brief positive Google review of me and Helix Law. We\\u2019re a small but specialist team, and this would make a huge difference to us.\\n\\nIf you don\\u2019t mind, please can you give us a brief 5* positive review at the following link:\\n\\nhttp://bit.ly/2gGwyNJ\\n\\nYou will need to be signed into Google.\\n\\nMany thanks in advance.`,\r\n      },\r\n    ],\r\n  },\r\n];\r\n\r\nexport default templateBlocks;\r\n","import {\r\n// invisible change 2\r\n  templateBlocks as productionTemplateBlocks,\r\n  TemplateBlock,\r\n  TemplateOption,\r\n} from './ProductionTemplateBlocks';\r\nimport simplifiedTemplateBlocks from './SimplifiedTemplateBlocks';\r\nimport databaseBlocksJson from '../../localData/localV3Blocks.json';\r\n\r\nexport type TemplateSet = 'Production' | 'Simplified' | 'Database';\r\n\r\nexport interface DatabaseBlocksData {\r\n  blocks: TemplateBlock[];\r\n  savedSnippets: Record<string, string>;\r\n}\r\n\r\nconst databaseTemplateBlocks: TemplateBlock[] =\r\n  (databaseBlocksJson as { blocks: TemplateBlock[] }).blocks;\r\n\r\nconst databaseBlocksData: DatabaseBlocksData = databaseBlocksJson as DatabaseBlocksData;\r\n\r\n// Blocks retrieved from the snippet database (v3) with a local fallback dataset\r\nexport const templateBlockSets: Record<Exclude<TemplateSet, 'Database'>, TemplateBlock[]> = {\r\n  Production: productionTemplateBlocks,\r\n  Simplified: simplifiedTemplateBlocks,\r\n};\r\n\r\nexport const templateSetOptions = [\r\n  { key: 'Database', text: 'Production' },\r\n  { key: 'Production', text: 'Original' },\r\n  { key: 'Simplified', text: 'Simplified' },\r\n];\r\n\r\nexport function getTemplateSetLabel(set: TemplateSet): string {\r\n  if (set === 'Database') return 'Production';\r\n  return set === 'Simplified' ? 'Simplified' : 'Original';\r\n}\r\n\r\nexport function getTemplateBlocks(set: TemplateSet = 'Simplified'): TemplateBlock[] {\r\n  if (set === 'Database') return databaseTemplateBlocks;\r\n  return templateBlockSets[set];\r\n}\r\n\r\nexport function getDatabaseBlocksData(): DatabaseBlocksData {\r\n  return databaseBlocksData;\r\n}\r\n\r\nexport interface RawSnippet {\r\n  SnippetId?: number;\r\n  snippetId?: number;\r\n  Label?: string;\r\n  label?: string;\r\n  Content?: string;\r\n  content?: string;\r\n  SortOrder?: number;\r\n  sortOrder?: number;\r\n}\r\n\r\nexport interface RawBlock {\r\n  BlockId?: number;\r\n  blockId?: number;\r\n  Title?: string;\r\n  title?: string;\r\n  Description?: string;\r\n  description?: string;\r\n  Placeholder?: string;\r\n  placeholder?: string;\r\n  snippets?: RawSnippet[];\r\n  options?: RawSnippet[];\r\n}\r\n\r\nexport function compileBlocks(raw: RawBlock[] | { blocks: RawBlock[] }): TemplateBlock[] {\r\n  const blocksArray: RawBlock[] = Array.isArray(raw)\r\n    ? raw\r\n    : (raw as any).blocks || [];\r\n  return blocksArray.map((b) => ({\r\n    title: b.Title || b.title || '',\r\n    description: b.Description || b.description || '',\r\n    placeholder: b.Placeholder || b.placeholder || '',\r\n    blockId: b.BlockId ?? b.blockId,\r\n    isMultiSelect: true,\r\n    options: (b.snippets || b.options || []).map((s) => ({\r\n      label: s.Label || s.label || '',\r\n      previewText: s.Content || s.content || '',\r\n      snippetId: s.SnippetId ?? s.snippetId,\r\n    })),\r\n  }));\r\n}\r\n\r\nexport type { TemplateBlock, TemplateOption };\r\n","// src/app/customisation/Attachments.ts\r\n// invisible change 2\r\n\r\nexport interface AttachmentOption {\r\n  key: string;\r\n  text: string;\r\n  applicableTo?: string[]; // Optional: Define the practice areas this attachment is relevant to\r\n  status: 'production' | 'draft'; // New: Status of the attachment\r\n  link: string; // New: URL link for the attachment\r\n}\r\n\r\n\r\nexport const availableAttachments: AttachmentOption[] = [\r\n  // Universal Attachments\r\n  {\r\n    key: 'client-welcome-pack',\r\n    text: 'Client Welcome Pack',\r\n    status: 'draft',\r\n    link: '#', // Placeholder link for draft\r\n  },\r\n  {\r\n    key: 'guide-to-litigation',\r\n    text: 'Guide to Litigation',\r\n    status: 'draft',\r\n    link: 'https://helixlaw-my.sharepoint.com/:b:/g/personal/automations_helix-law_com/ESgqdEAOBx9FrF2pgI45XJEBbFPIS6Do6whaJpV8dLtszg?e=zH1cCI',\r\n  },\r\n  {\r\n    key: 'terms-of-business',\r\n    text: 'Terms of Business',\r\n    status: 'production',\r\n    link: 'https://helix-law.co.uk/terms-and-conditions/',\r\n  },\r\n  {\r\n    key: 'faqs',\r\n    text: 'FAQs',\r\n    status: 'draft',\r\n    link: '#', // Placeholder link for draft\r\n  },\r\n\r\n  // Practice Area-Specific Attachments\r\n  {\r\n    key: 'services-for-investors',\r\n    text: 'Services for Investors',\r\n    applicableTo: ['Commercial'],\r\n    status: 'production',\r\n    link: 'https://helixlaw-my.sharepoint.com/:b:/g/personal/automations_helix-law_com/EXkqf5Ye17REkQi2cynH85wB0WHRbQCuArZaLuH_NPve2A?e=IQw5n2',\r\n  },\r\n  {\r\n    key: 'services-for-the-construction-industry',\r\n    text: 'Services for the Construction Industry',\r\n    applicableTo: ['Construction'],\r\n    status: 'production',\r\n    link: 'https://helixlaw-my.sharepoint.com/:b:/g/personal/automations_helix-law_com/EZINHVau6dVHspG9yAwCV08BxsMOPYIWdKff8hApzP1CZg?e=qfamTm',\r\n  },\r\n  {\r\n    key: 'resolving-a-building-dispute', // Updated key to use kebab-case for consistency\r\n    text: 'Resolving a Building Dispute',\r\n    applicableTo: ['Construction'],\r\n    status: 'production',\r\n    link: 'https://helixlaw-my.sharepoint.com/:b:/g/personal/automations_helix-law_com/ESoiCNUf6HBHqYUjUrxu82YBlfYsPjqO7ils4NEg9_BlAA?e=zNv9Eo',\r\n  },\r\n  {\r\n    key: 'services-for-employers',\r\n    text: 'Services for Employers',\r\n    applicableTo: ['Employment'],\r\n    status: 'draft',\r\n    link: '#', // Placeholder link for draft\r\n  },\r\n  {\r\n    key: 'services-for-landlords',\r\n    text: 'Services for Landlords',\r\n    applicableTo: ['Property'],\r\n    status: 'draft',\r\n    link: '#', // Placeholder link for draft\r\n  },\r\n  {\r\n    key: 'services-for-agents',\r\n    text: 'Services for Agents',\r\n    applicableTo: ['Property'],\r\n    status: 'draft',\r\n    link: '#', // Placeholder link for draft\r\n  },\r\n  {\r\n    key: 'guide-to-a-successful-tenancy',\r\n    text: 'Guide to a Successful Tenancy',\r\n    applicableTo: ['Property'],\r\n    status: 'draft',\r\n    link: '#', // Placeholder link for draft\r\n  },\r\n];\r\n\r\nexport default availableAttachments;\r\n","import React from 'react';\r\nimport { ApiCallLog } from './useLocalFetchLogger';\r\n\r\ninterface Props {\r\n  calls: ApiCallLog[];\r\n  onClear(): void;\r\n  collapsed: boolean;\r\n  onToggle(): void;\r\n}\r\n\r\nexport const PitchDebugPanel: React.FC<Props> = ({ calls, onClear, collapsed, onToggle }) => {\r\n  return (\r\n    <div style={{ position: 'fixed', bottom: 8, right: 8, zIndex: 9999, fontFamily: 'monospace', fontSize: 11 }}>\r\n      <div style={{ background: '#222', color: '#fff', padding: '4px 8px', borderRadius: 4, boxShadow: '0 2px 6px rgba(0,0,0,0.4)', minWidth: 260 }}>\r\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\r\n          <strong>Fetch Log ({calls.length})</strong>\r\n          <button onClick={onToggle} style={btnStyle}>{collapsed ? 'Expand' : 'Collapse'}</button>\r\n          <button onClick={onClear} style={btnStyle}>Clear</button>\r\n        </div>\r\n        {!collapsed && (\r\n          <div style={{ maxHeight: 220, overflow: 'auto', marginTop: 6, background: '#111', padding: 4 }}>\r\n            {calls.slice().reverse().map(c => (\r\n              <div key={c.id} style={{ borderBottom: '1px solid #333', padding: '4px 0' }}>\r\n                <div>\r\n                  <span style={{ color: '#0af' }}>{c.method}</span> {c.status !== undefined && c.status !== -1 ? c.status : 'ERR'} {c.url}\r\n                </div>\r\n                <div style={{ opacity: 0.7 }}>{c.durationMs.toFixed(0)}ms {c.error && <span style={{ color: 'tomato' }}>{c.error}</span>}</div>\r\n                {c.data && (\r\n                  <pre style={preStyle}>{c.data}</pre>\r\n                )}\r\n              </div>\r\n            ))}\r\n            {calls.length === 0 && <div style={{ opacity: 0.6 }}>No calls yet.</div>}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst btnStyle: React.CSSProperties = {\r\n  background: '#444',\r\n  color: '#fff',\r\n  border: 'none',\r\n  cursor: 'pointer',\r\n  padding: '2px 6px',\r\n  borderRadius: 3,\r\n  fontSize: 11\r\n};\r\n\r\nconst preStyle: React.CSSProperties = {\r\n  margin: '4px 0 0',\r\n  maxHeight: 120,\r\n  overflow: 'auto',\r\n  whiteSpace: 'pre-wrap',\r\n  background: '#000',\r\n  padding: 4,\r\n  borderRadius: 3\r\n};\r\n\r\nexport default PitchDebugPanel;\r\n","import React from 'react';\r\nimport { Enquiry, UserData } from '../../../app/functionality/types';\r\nimport { colours } from '../../../app/styles/colours';\r\n\r\n/**\r\n * A compact, theme-aware summary of the effective details used for substitutions in Pitch Builder.\r\n * Shows fee earner info (name, initials, role, rate), enquiry id, amount, passcode, and instruction link,\r\n * plus a small indicator of the data source (server route vs default).\r\n */\r\nexport interface VerificationSummaryProps {\r\n  isDarkMode: boolean;\r\n  /** Effective user data array (first element used). */\r\n  userData: UserData[] | null | undefined;\r\n  enquiry: Enquiry;\r\n  /** Amount as string or number, formatted to £ on render. */\r\n  amount?: string | number;\r\n  passcode?: string;\r\n  /** True if the /api/pitch-team route supplied data; false if using default userData. */\r\n  usedPitchRoute: boolean;\r\n  /** Trigger a client preview panel/drawer in parent with computed link */\r\n  onPreview?: (link: string) => void;\r\n}\r\n\r\nfunction formatPounds(value: string | number | undefined): string {\r\n  if (value === undefined || value === null || value === '') return '—';\r\n  const num = Number(value);\r\n  if (Number.isNaN(num)) return '—';\r\n  const withDecimals = num.toLocaleString('en-GB', {\r\n    minimumFractionDigits: 2,\r\n    maximumFractionDigits: 2,\r\n  });\r\n  return `£${withDecimals.replace(/\\.00$/, '')}`;\r\n}\r\n\r\nfunction buildInstructionLink(passcode?: string): string {\r\n  // Match emailUtils: prefer build-time injected env, fall back to production URL\r\n  const baseUrl = process.env.REACT_APP_INSTRUCTIONS_URL || 'https://instruct.helix-law.com';\r\n  return passcode ? `${baseUrl}/pitch/${passcode}` : `${baseUrl}/pitch`;\r\n}\r\n\r\nexport const VerificationSummary: React.FC<VerificationSummaryProps> = ({\r\n  isDarkMode,\r\n  userData,\r\n  enquiry,\r\n  amount,\r\n  passcode,\r\n  usedPitchRoute,\r\n  onPreview,\r\n}) => {\r\n  // Inject enhanced styles for modern design patterns\r\n  if (typeof window !== 'undefined' && !document.getElementById('verification-summary-style')) {\r\n    const style = document.createElement('style');\r\n    style.id = 'verification-summary-style';\r\n    style.innerHTML = `\r\n      @keyframes vs-flip-in { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }\r\n      @keyframes vs-pulse { 0% { box-shadow: 0 0 0 0 rgba(22,163,74,0.35); } 70% { box-shadow: 0 0 0 8px rgba(22,163,74,0); } 100% { box-shadow: 0 0 0 0 rgba(22,163,74,0); } }\r\n      @keyframes cascadeIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }\r\n      @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 0 0 rgba(125, 211, 252, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(125, 211, 252, 0); } }\r\n      .vs-flip { animation: vs-flip-in 420ms ease both; transform-style: preserve-3d; }\r\n      .vs-pulse { animation: vs-pulse 900ms ease-out 1; }\r\n      .vs-cascade { animation: cascadeIn 0.6s ease-out; }\r\n      .vs-main-container {\r\n        background: linear-gradient(135deg, rgba(5, 12, 26, 0.98) 0%, rgba(9, 22, 44, 0.94) 52%, rgba(13, 35, 63, 0.9) 100%);\r\n        border: 1px solid rgba(125, 211, 252, 0.28);\r\n        border-radius: 16px;\r\n        padding: 20px;\r\n        box-shadow: 0 20px 44px rgba(2, 6, 17, 0.72);\r\n        backdrop-filter: blur(12px);\r\n        border-left: 3px solid rgba(125, 211, 252, 0.7);\r\n        margin-bottom: 16px;\r\n      }\r\n      .vs-main-container.light {\r\n        background: linear-gradient(135deg, rgba(248, 250, 252, 0.96) 0%, rgba(255, 255, 255, 0.94) 100%);\r\n        border: 1px solid rgba(148, 163, 184, 0.25);\r\n        box-shadow: 0 8px 24px rgba(13, 47, 96, 0.16);\r\n        border-left: 3px solid rgba(59, 130, 246, 0.6);\r\n      }\r\n      .vs-section-card {\r\n        background: linear-gradient(135deg, rgba(7, 16, 32, 0.94) 0%, rgba(11, 30, 55, 0.86) 100%);\r\n        border: 1px solid rgba(125, 211, 252, 0.24);\r\n        border-radius: 12px;\r\n        padding: 16px;\r\n        box-shadow: 0 8px 16px rgba(2, 6, 17, 0.4);\r\n        backdrop-filter: blur(8px);\r\n        transition: all 0.25s ease;\r\n      }\r\n      .vs-section-card.light {\r\n        background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);\r\n        border: 1px solid rgba(148, 163, 184, 0.22);\r\n        box-shadow: 0 4px 12px rgba(13, 47, 96, 0.08);\r\n      }\r\n      .vs-section-card:hover {\r\n        transform: translateY(-2px);\r\n      }\r\n      .vs-section-card.dark:hover {\r\n        box-shadow: 0 12px 20px rgba(2, 6, 17, 0.6);\r\n      }\r\n      .vs-section-card.light:hover {\r\n        box-shadow: 0 8px 16px rgba(13, 47, 96, 0.12);\r\n      }\r\n      .vs-grid { \r\n        display: grid; \r\n        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); \r\n        gap: 16px; \r\n        padding: 4px;\r\n      }\r\n      @media (max-width: 680px) { \r\n        .vs-grid { \r\n          grid-template-columns: 1fr; \r\n          gap: 12px; \r\n        } \r\n      }\r\n      .vs-columns { \r\n        display: grid; \r\n        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); \r\n        gap: 24px; \r\n        align-items: start; \r\n      }\r\n      @media (max-width: 880px) { \r\n        .vs-columns { \r\n          grid-template-columns: 1fr; \r\n          gap: 20px; \r\n        } \r\n      }\r\n      .vs-prospect-grid { \r\n        display: grid; \r\n        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); \r\n        gap: 16px; \r\n        padding: 4px;\r\n      }\r\n      @media (max-width: 680px) { \r\n        .vs-prospect-grid { \r\n          grid-template-columns: 1fr; \r\n          gap: 12px; \r\n        } \r\n      }\r\n    `;\r\n    document.head.appendChild(style);\r\n  }\r\n\r\n  // Detect transition to live and trigger flip\r\n  const prevUsedRef = React.useRef<boolean>(usedPitchRoute);\r\n  const [flipNow, setFlipNow] = React.useState<boolean>(false);\r\n  React.useEffect(() => {\r\n    if (!prevUsedRef.current && usedPitchRoute) {\r\n      setFlipNow(true);\r\n      const t = setTimeout(() => setFlipNow(false), 700);\r\n      return () => clearTimeout(t);\r\n    }\r\n    prevUsedRef.current = usedPitchRoute;\r\n  }, [usedPitchRoute]);\r\n\r\n  const u = userData?.[0];\r\n  const initials = (u?.Initials ?? '').toUpperCase();\r\n  // Support both camelCase FullName and legacy 'Full Name'\r\n  const legacyFullName = u ? ((u as unknown as Record<string, unknown>)['Full Name'] as string | undefined) : undefined;\r\n  const fullName = (u?.FullName || legacyFullName || `${u?.First ?? ''} ${u?.Last ?? ''}`.trim());\r\n  const role = u?.Role ?? '';\r\n  const rateRaw = u?.Rate as unknown;\r\n  let rateVal: string | number | undefined;\r\n  if (typeof rateRaw === 'number') rateVal = rateRaw;\r\n  else if (typeof rateRaw === 'string' && rateRaw.trim() !== '') rateVal = rateRaw;\r\n  else rateVal = undefined;\r\n  const rateFmt = rateVal !== undefined\r\n    ? `${formatPounds(rateVal)} + VAT`\r\n    : '—';\r\n  const amountFmt = formatPounds(amount);\r\n  const enquiryId = String(enquiry?.ID ?? '—');\r\n  const hasPasscode = !!(passcode && String(passcode).trim());\r\n  const link = buildInstructionLink(passcode);\r\n\r\n  // Modern theming with enhanced colors and effects\r\n  const modernText = isDarkMode ? '#F8FAFC' : '#1E293B';\r\n  const modernSubtle = isDarkMode ? '#94A3B8' : '#64748B';\r\n  const modernAccent = isDarkMode ? '#7DD3FC' : colours.light.highlight;\r\n  const modernSuccess = '#10B981';\r\n  const modernBorder = isDarkMode \r\n    ? 'rgba(125, 211, 252, 0.24)' \r\n    : 'rgba(148, 163, 184, 0.22)';\r\n\r\n  const clientName = `${enquiry?.First_Name || ''} ${enquiry?.Last_Name || ''}`.trim() || 'Client';\r\n  const clientEmail = enquiry?.Email || '';\r\n  const clientPhone = enquiry?.Phone_Number || '';\r\n\r\n  return (\r\n    <div \r\n      aria-label=\"Prefill data\" \r\n      className={`vs-main-container vs-cascade ${isDarkMode ? '' : 'light'}`}\r\n    >\r\n      {/* Two-column content: left Prospect, right Prefill */}\r\n      <div className=\"vs-columns\">\r\n        {/* Left: Prospect details */}\r\n        <div className={`vs-section-card ${isDarkMode ? 'dark' : 'light'}`}>\r\n          <div style={{ padding: '4px 0 8px 0' }}>\r\n            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>\r\n              <div style={{ \r\n                color: isDarkMode ? '#7DD3FC' : colours.light.highlight, \r\n                fontSize: '14px', \r\n                fontWeight: '600',\r\n                display: 'flex', \r\n                alignItems: 'center', \r\n                gap: '8px' \r\n              }}>\r\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <circle cx=\"12\" cy=\"8\" r=\"4\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                  <rect x=\"4\" y=\"15\" width=\"16\" height=\"6\" rx=\"3\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                </svg>\r\n                Prospect Details\r\n              </div>\r\n            </div>\r\n            <div style={{ \r\n              height: '2px', \r\n              background: isDarkMode \r\n                ? 'linear-gradient(90deg, rgba(125, 211, 252, 0.4) 0%, rgba(125, 211, 252, 0.1) 100%)' \r\n                : 'linear-gradient(90deg, rgba(54, 144, 206, 0.4) 0%, rgba(54, 144, 206, 0.1) 100%)', \r\n              margin: '0 0 16px 0',\r\n              borderRadius: '1px'\r\n            }} />\r\n            <div className=\"vs-prospect-grid\">\r\n              <KV label=\"Client name\" value={clientName} text={modernText} subtle={modernSubtle} copyable />\r\n              <KV label=\"Enquiry ID\" value={enquiryId} text={modernText} subtle={modernSubtle} copyable />\r\n            </div>\r\n            {/* Contact Information - Enhanced Display */}\r\n            {(clientEmail || clientPhone) && (\r\n              <div style={{ marginTop: '16px' }}>\r\n                <div style={{ \r\n                  color: modernSubtle, \r\n                  fontSize: '12px', \r\n                  fontWeight: '500',\r\n                  textTransform: 'uppercase',\r\n                  letterSpacing: '0.5px',\r\n                  marginBottom: '8px'\r\n                }}>\r\n                  Contact Information\r\n                </div>\r\n                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>\r\n                  {clientEmail && <ContactChip label={clientEmail} kind=\"mail\" subtle={modernSubtle} isDarkMode={isDarkMode} accent={modernAccent} />}\r\n                  {clientPhone && <ContactChip label={clientPhone} kind=\"phone\" subtle={modernSubtle} isDarkMode={isDarkMode} accent={modernAccent} />}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Right: Prefill data used in placeholders */}\r\n        <div className={`vs-section-card ${isDarkMode ? 'dark' : 'light'}`}>\r\n          <div style={{ padding: '4px 0 8px 0' }}>\r\n            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>\r\n              <div style={{ \r\n                color: isDarkMode ? '#7DD3FC' : colours.light.highlight, \r\n                fontSize: '14px', \r\n                fontWeight: '600',\r\n                display: 'flex', \r\n                alignItems: 'center', \r\n                gap: '8px' \r\n              }}>\r\n                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"2\" />\r\n                  <path d=\"M12 7v10M7 12h10\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                </svg>\r\n                Prefill Data\r\n              </div>\r\n            </div>\r\n            <div style={{ \r\n              height: '2px', \r\n              background: isDarkMode \r\n                ? 'linear-gradient(90deg, rgba(125, 211, 252, 0.4) 0%, rgba(125, 211, 252, 0.1) 100%)' \r\n                : 'linear-gradient(90deg, rgba(54, 144, 206, 0.4) 0%, rgba(54, 144, 206, 0.1) 100%)', \r\n              margin: '0 0 16px 0',\r\n              borderRadius: '1px'\r\n            }} />\r\n            <div className=\"vs-grid\">\r\n              <KV label=\"Fee earner\" value={fullName || '—'} text={modernText} subtle={modernSubtle} copyable />\r\n              <KV label=\"Initials\" value={initials || '—'} text={modernText} subtle={modernSubtle} copyable />\r\n              <KV label=\"Role\" value={role || '—'} text={modernText} subtle={modernSubtle} copyable />\r\n              <KV label=\"Rate\" value={rateFmt} text={modernText} subtle={modernSubtle} copyable />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst ContactChip: React.FC<{\r\n  label: string;\r\n  kind: 'mail' | 'phone';\r\n  subtle: string;\r\n  isDarkMode: boolean;\r\n  accent: string;\r\n}> = ({ label, kind, subtle, isDarkMode, accent }) => {\r\n  const [copied, setCopied] = React.useState(false);\r\n  const [isHovered, setIsHovered] = React.useState(false);\r\n  \r\n  const copy = () => {\r\n    navigator.clipboard.writeText(label);\r\n    setCopied(true);\r\n    setTimeout(() => setCopied(false), 1200);\r\n  };\r\n  \r\n  const bg = isDarkMode \r\n    ? (isHovered ? 'rgba(125, 211, 252, 0.15)' : 'rgba(255,255,255,0.08)') \r\n    : (isHovered ? 'rgba(54, 144, 206, 0.1)' : '#f1f5f9');\r\n  const border = isDarkMode \r\n    ? (isHovered ? 'rgba(125, 211, 252, 0.4)' : 'rgba(125, 211, 252, 0.2)') \r\n    : (isHovered ? 'rgba(54, 144, 206, 0.3)' : '#e2e8f0');\r\n    \r\n  const icon = kind === 'mail' ? (\r\n    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n      <path d=\"M4 6h16v12H4z\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n      <path d=\"M4 6l8 6 8-6\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n    </svg>\r\n  ) : (\r\n    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n      <path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.1 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.66 12.66 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.66 12.66 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n    </svg>\r\n  );\r\n  \r\n  return (\r\n    <span\r\n      style={{\r\n        display: 'inline-flex', \r\n        alignItems: 'center', \r\n        gap: '8px',\r\n        padding: '8px 12px', \r\n        borderRadius: '10px', \r\n        background: bg,\r\n        border: `1px solid ${border}`, \r\n        fontSize: '13px',\r\n        fontWeight: '500',\r\n        color: isDarkMode ? '#F1F5F9' : '#1E293B',\r\n        cursor: 'pointer',\r\n        transition: 'all 0.2s ease',\r\n        transform: isHovered ? 'translateY(-1px)' : 'translateY(0)',\r\n        boxShadow: isHovered \r\n          ? (isDarkMode ? '0 4px 12px rgba(2, 6, 17, 0.4)' : '0 4px 12px rgba(13, 47, 96, 0.1)')\r\n          : 'none'\r\n      }}\r\n      title={label}\r\n      onClick={copy}\r\n      onMouseEnter={() => setIsHovered(true)}\r\n      onMouseLeave={() => setIsHovered(false)}\r\n    >\r\n      <div style={{ color: accent }}>\r\n        {icon}\r\n      </div>\r\n      <span style={{ \r\n        maxWidth: '260px', \r\n        overflow: 'hidden', \r\n        textOverflow: 'ellipsis', \r\n        whiteSpace: 'nowrap' \r\n      }}>\r\n        {label}\r\n      </span>\r\n      <div\r\n        style={{ \r\n          color: copied ? '#10B981' : accent,\r\n          transition: 'color 0.2s ease'\r\n        }}\r\n      >\r\n        {copied ? (\r\n          <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n            <path d=\"M20 6L9 17l-5-5\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n          </svg>\r\n        ) : (\r\n          <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n            <rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n            <rect x=\"2\" y=\"2\" width=\"13\" height=\"13\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n          </svg>\r\n        )}\r\n      </div>\r\n    </span>\r\n  );\r\n};\r\n\r\nconst KV: React.FC<{\r\n  label: string;\r\n  value: string;\r\n  text: string;\r\n  subtle: string;\r\n  copyable?: boolean;\r\n  mono?: boolean;\r\n}> = ({ label, value, text, subtle, copyable, mono }) => {\r\n  const [copied, setCopied] = React.useState(false);\r\n  const [isHovered, setIsHovered] = React.useState(false);\r\n  \r\n  const handleCopy = () => {\r\n    if (!copyable || !value || value === '—') return;\r\n    navigator.clipboard.writeText(value);\r\n    setCopied(true);\r\n    setTimeout(() => setCopied(false), 1200);\r\n  };\r\n  \r\n  const isDarkMode = text === '#F8FAFC'; // Determine theme from text color\r\n  \r\n  return (\r\n    <div \r\n      style={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: '8px',\r\n        padding: '16px 18px',\r\n        borderRadius: '12px',\r\n        background: isHovered \r\n          ? (isDarkMode ? 'rgba(125, 211, 252, 0.12)' : 'rgba(54, 144, 206, 0.08)')\r\n          : (isDarkMode ? 'rgba(7, 16, 32, 0.6)' : 'rgba(248, 250, 252, 0.8)'),\r\n        border: `1px solid ${isDarkMode \r\n          ? (isHovered ? 'rgba(125, 211, 252, 0.3)' : 'rgba(125, 211, 252, 0.15)') \r\n          : (isHovered ? 'rgba(54, 144, 206, 0.25)' : 'rgba(148, 163, 184, 0.2)')}`,\r\n        transition: 'all 0.25s ease',\r\n        cursor: copyable && value !== '—' ? 'pointer' : 'default',\r\n        transform: isHovered ? 'translateY(-1px)' : 'translateY(0)',\r\n        boxShadow: isHovered \r\n          ? (isDarkMode ? '0 8px 16px rgba(2, 6, 17, 0.4)' : '0 4px 12px rgba(13, 47, 96, 0.1)')\r\n          : (isDarkMode ? '0 4px 8px rgba(2, 6, 17, 0.2)' : '0 2px 6px rgba(13, 47, 96, 0.05)')\r\n      }}\r\n      onMouseEnter={() => setIsHovered(true)}\r\n      onMouseLeave={() => setIsHovered(false)}\r\n      onClick={copyable && value !== '—' ? handleCopy : undefined}\r\n    >\r\n      <div style={{ \r\n        color: subtle, \r\n        fontSize: '12px', \r\n        fontWeight: '600',\r\n        textTransform: 'uppercase',\r\n        letterSpacing: '0.8px',\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        gap: '6px'\r\n      }}>\r\n        <div style={{\r\n          width: '3px',\r\n          height: '3px',\r\n          borderRadius: '50%',\r\n          background: isDarkMode ? '#7DD3FC' : colours.light.highlight\r\n        }} />\r\n        {label}\r\n      </div>\r\n      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>\r\n        <span style={{ \r\n          color: text, \r\n          fontSize: '15px',\r\n          fontWeight: '700', \r\n          fontFamily: mono \r\n            ? 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace' \r\n            : undefined,\r\n          lineHeight: '1.4'\r\n        }}>\r\n          {value}\r\n        </span>\r\n        {copyable && value !== '—' && (\r\n          <div\r\n            style={{ \r\n              opacity: isHovered ? 1 : 0.5,\r\n              transition: 'all 0.25s ease',\r\n              color: copied ? '#10B981' : (isDarkMode ? '#7DD3FC' : colours.light.highlight),\r\n              transform: copied ? 'scale(1.1)' : 'scale(1)'\r\n            }}\r\n          >\r\n            {copied ? (\r\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"currentColor\" opacity=\"0.2\"/>\r\n                <path d=\"M20 6L9 17l-5-5\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n              </svg>\r\n            ) : (\r\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n                <rect x=\"2\" y=\"2\" width=\"13\" height=\"13\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"2\"/>\r\n              </svg>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default VerificationSummary;\r\n","import React, { useEffect, useRef, useState } from 'react';\r\n// invisible change 2\r\nimport ReactDOM from 'react-dom';\r\nimport { FaTimes } from 'react-icons/fa';\r\nimport '../app/styles/InfoPopover.css';\r\n\r\ninterface PopoverContainerProps {\r\n    target: HTMLElement;\r\n    onDismiss: () => void;\r\n    width?: number;\r\n    className?: string;\r\n    children: React.ReactNode;\r\n}\r\n\r\nconst PopoverContainer: React.FC<PopoverContainerProps> = ({\r\n    target,\r\n    onDismiss,\r\n    width,\r\n    className,\r\n    children,\r\n}) => {\r\n    const modalRef = useRef<HTMLDivElement | null>(null);\r\n    const [modalPos, setModalPos] = useState({ top: 0, left: 0 });\r\n\r\n    useEffect(() => {\r\n        function updatePosition() {\r\n            if (target && modalRef.current) {\r\n                const iconRect = target.getBoundingClientRect();\r\n                const modalRect = modalRef.current.getBoundingClientRect();\r\n\r\n                let left = iconRect.left;\r\n                if (left + modalRect.width > window.innerWidth - 8) {\r\n                    left = window.innerWidth - modalRect.width - 8;\r\n                }\r\n                if (left < 8) left = 8;\r\n\r\n                let top = iconRect.bottom + 8;\r\n                if (top + modalRect.height > window.innerHeight - 8) {\r\n                    top = iconRect.top - modalRect.height - 8;\r\n                }\r\n                if (top < 8) top = 8;\r\n\r\n                setModalPos({ top, left });\r\n            }\r\n        }\r\n\r\n        updatePosition();\r\n        window.addEventListener('resize', updatePosition);\r\n        window.addEventListener('scroll', updatePosition);\r\n        return () => {\r\n            window.removeEventListener('resize', updatePosition);\r\n            window.removeEventListener('scroll', updatePosition);\r\n        };\r\n    }, [target]);\r\n\r\n    useEffect(() => {\r\n        const handleKey = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') onDismiss();\r\n        };\r\n        document.addEventListener('keydown', handleKey);\r\n        return () => document.removeEventListener('keydown', handleKey);\r\n    }, [onDismiss]);\r\n\r\n    return ReactDOM.createPortal(\r\n        <div className=\"info-overlay\" onClick={onDismiss}>\r\n            <div\r\n                ref={modalRef}\r\n                className={`info-modal${className ? ` ${className}` : ''}`}\r\n                style={{\r\n                    top: modalPos.top,\r\n                    left: modalPos.left,\r\n                    width: width ? width : undefined,\r\n                    maxWidth: width ? width : undefined,\r\n                }}\r\n                onClick={(e) => e.stopPropagation()}\r\n            >\r\n                <span className=\"info-close\" onClick={onDismiss} aria-label=\"Close popover\">\r\n                    <FaTimes aria-hidden=\"true\" />\r\n                </span>\r\n                <div className=\"info-content\">{children}</div>\r\n            </div>\r\n        </div>,\r\n        document.body\r\n    );\r\n};\r\n\r\nexport default PopoverContainer;\r\n","import React, { useState, useEffect } from 'react';\r\nimport { TextField, PrimaryButton, DefaultButton, Stack } from '@fluentui/react';\r\nimport PopoverContainer from '../../../components/PopoverContainer';\r\nimport '../../../app/styles/PlaceholderEditorPopover.css';\r\n\r\ntype PlaceholderEditorPopoverProps = {\r\n    target: HTMLElement;\r\n    initialText: string;\r\n    before: string;\r\n    after: string;\r\n    /** Callback when the user wants to save this text as an option */\r\n    onAddOption: (text: string) => void;\r\n    onSave: (text: string) => void;\r\n    onDismiss: () => void;\r\n};\r\n\r\nconst PlaceholderEditorPopover: React.FC<PlaceholderEditorPopoverProps> = ({\r\n    target,\r\n    initialText,\r\n    before,\r\n// invisible change\r\n    after,\r\n    onAddOption,\r\n    onSave,\r\n    onDismiss,\r\n}) => {\r\n    const [value, setValue] = useState(initialText);\r\n\r\n    useEffect(() => {\r\n        const handleKey = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') onDismiss();\r\n        };\r\n        document.addEventListener('keydown', handleKey);\r\n        return () => document.removeEventListener('keydown', handleKey);\r\n    }, [onDismiss]);\r\n\r\n    const content = (\r\n        <Stack tokens={{ childrenGap: 12 }} styles={{ root: { padding: '16px 20px' } }}>\r\n            <span className=\"placeholder-context\">{before}</span>\r\n            <TextField\r\n                value={value}\r\n                onChange={(_, v) => setValue(v || '')}\r\n                autoFocus\r\n                multiline\r\n                autoAdjustHeight\r\n                styles={{\r\n                    fieldGroup: {\r\n                        border: '1px solid #ccc',\r\n                        borderRadius: 0,\r\n                        backgroundColor: '#ffffff',\r\n                    },\r\n                    field: {\r\n                        fontSize: 16,\r\n                        padding: '12px 16px',\r\n                        fontWeight: 400,\r\n                        borderRadius: 0,\r\n                        boxShadow: 'none',\r\n                    },\r\n                }}\r\n            />\r\n            <span className=\"placeholder-context\">{after}</span>\r\n            <Stack horizontal horizontalAlign=\"space-between\">\r\n                <DefaultButton\r\n                    text=\"Add Option\"\r\n                    onClick={() => onAddOption(value)}\r\n                />\r\n                <PrimaryButton\r\n                    text=\"Save\"\r\n                    styles={{\r\n                        root: {\r\n                            padding: '12px 28px',\r\n                            fontSize: 14,\r\n                            fontWeight: 600,\r\n                            borderRadius: 0,\r\n                        },\r\n                        label: { textTransform: 'none' },\r\n                    }}\r\n                    onClick={() => onSave(value)}\r\n                />\r\n            </Stack>\r\n        </Stack>\r\n    );\r\n\r\n    return (\r\n        <PopoverContainer target={target} onDismiss={onDismiss} width={700} className=\"placeholder-editor-modal\">\r\n            {content}\r\n        </PopoverContainer>\r\n    );\r\n};\r\n\r\nexport default PlaceholderEditorPopover;\r\n","import React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n    TextField,\r\n    ITextFieldStyles,\r\n    PrimaryButton,\r\n    DefaultButton,\r\n    Stack,\r\n    Text,\r\n    Icon,\r\n    Callout,\r\n    DirectionalHint,\r\n    ChoiceGroup,\r\n    IChoiceGroupOption,\r\n} from '@fluentui/react';\r\n\r\ntype SnippetEditPopoverProps = {\r\n    target: HTMLElement;\r\n    onSave: (data: { label: string; sortOrder: number; isNew: boolean }) => void;\r\n    onDismiss: () => void;\r\n    originalText: string;\r\n    editedText: string;\r\n};\r\n\r\nconst SnippetEditPopover: React.FC<SnippetEditPopoverProps> = ({ target, onSave, onDismiss, originalText, editedText }) => {\r\n    const [label, setLabel] = useState('');\r\n    const [sortOrder, setSortOrder] = useState<number>(0);\r\n    const [mode, setMode] = useState<'edit' | 'create'>('edit');\r\n\r\n    // Check if content has been modified\r\n    const hasChanges = useMemo(() => {\r\n        const cleanOriginal = (originalText || '').trim().replace(/\\s+/g, ' ');\r\n        const cleanEdited = (editedText || '').trim().replace(/\\s+/g, ' ');\r\n        return cleanOriginal !== cleanEdited && cleanEdited.length > 0;\r\n    }, [originalText, editedText]);\r\n\r\n    // Animation state for save button\r\n    const [saveButtonAnimated, setSaveButtonAnimated] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (hasChanges && !saveButtonAnimated) {\r\n            setSaveButtonAnimated(true);\r\n        }\r\n    }, [hasChanges, saveButtonAnimated]);\r\n\r\n    useEffect(() => {\r\n        const handleKey = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') onDismiss();\r\n        };\r\n        document.addEventListener('keydown', handleKey);\r\n        return () => document.removeEventListener('keydown', handleKey);\r\n    }, [onDismiss]);\r\n\r\n    // Function to highlight differences\r\n    const renderContentWithHighlights = (content: string, isOriginal: boolean) => {\r\n        if (!hasChanges) {\r\n            return <span>{content}</span>;\r\n        }\r\n\r\n        const originalWords = (originalText || '').split(/(\\s+)/);\r\n        const editedWords = (editedText || '').split(/(\\s+)/);\r\n        const wordsToRender = isOriginal ? originalWords : editedWords;\r\n        const compareWords = isOriginal ? editedWords : originalWords;\r\n        \r\n        return (\r\n            <span>\r\n                {wordsToRender.map((word, index) => {\r\n                    const isWhitespace = /^\\s+$/.test(word);\r\n                    if (isWhitespace) return word;\r\n                    \r\n                    const wordInCompare = compareWords.includes(word);\r\n                    const isDifferent = !wordInCompare;\r\n                    \r\n                    if (isDifferent) {\r\n                        return (\r\n                            <span\r\n                                key={index}\r\n                                style={{\r\n                                    backgroundColor: isOriginal ? '#ffebee' : '#e8f5e8',\r\n                                    color: isOriginal ? '#c62828' : '#2e7d32',\r\n                                    padding: '2px 4px',\r\n                                    borderRadius: '3px',\r\n                                    border: isOriginal ? '1px solid #ffcdd2' : '1px solid #c8e6c9',\r\n                                    fontWeight: '500'\r\n                                }}\r\n                            >\r\n                                {word}\r\n                            </span>\r\n                        );\r\n                    }\r\n                    return word;\r\n                })}\r\n            </span>\r\n        );\r\n    };\r\n\r\n    const modeOptions: IChoiceGroupOption[] = [\r\n        {\r\n            key: 'edit',\r\n            text: 'Update Existing Snippet',\r\n            iconProps: { iconName: 'Edit' },\r\n        },\r\n        {\r\n            key: 'create', \r\n            text: 'Create New Snippet',\r\n            iconProps: { iconName: 'Add' },\r\n        },\r\n    ];\r\n\r\n    const textFieldStyles: Partial<ITextFieldStyles> = {\r\n        fieldGroup: {\r\n            border: '1px solid #e1e5e9',\r\n            borderRadius: '6px',\r\n            backgroundColor: '#ffffff',\r\n            minHeight: '40px',\r\n            ':hover': {\r\n                borderColor: '#0078d4',\r\n            },\r\n            ':focus-within': {\r\n                borderColor: '#0078d4',\r\n                boxShadow: '0 0 0 2px rgba(0, 120, 212, 0.2)',\r\n            },\r\n        },\r\n        field: {\r\n            fontSize: '14px',\r\n            padding: '10px 14px',\r\n            fontFamily: 'Raleway, sans-serif',\r\n            lineHeight: '1.4',\r\n        },\r\n        root: {\r\n            marginBottom: '20px',\r\n        },\r\n    };\r\n\r\n    const getSortOrderPreview = (order: number): string => {\r\n        if (order === 0) return \"Default position\";\r\n        if (order < 0) return \"Appears before default options\";\r\n        if (order > 0 && order <= 5) return \"High priority (appears first)\";\r\n        if (order > 5 && order <= 10) return \"Normal priority\";\r\n        return \"Low priority (appears last)\";\r\n    };\r\n\r\n    return (\r\n        <>\r\n            <style>\r\n                {`\r\n                    @keyframes fadeInSlide {\r\n                        0% {\r\n                            opacity: 0;\r\n                            transform: translateX(-10px);\r\n                        }\r\n                        100% {\r\n                            opacity: 1;\r\n                            transform: translateX(0);\r\n                        }\r\n                    }\r\n                    \r\n                    @keyframes pulseGlow {\r\n                        0%, 100% {\r\n                            box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.4);\r\n                        }\r\n                        50% {\r\n                            box-shadow: 0 0 0 8px rgba(0, 120, 212, 0);\r\n                        }\r\n                    }\r\n                `}\r\n            </style>\r\n            <Callout\r\n            target={target}\r\n            onDismiss={onDismiss}\r\n            directionalHint={DirectionalHint.bottomLeftEdge}\r\n            isBeakVisible={false}\r\n            styles={{\r\n                root: {\r\n                    padding: '0',\r\n                    borderRadius: '12px',\r\n                    boxShadow: '0 16px 64px rgba(0, 0, 0, 0.15)',\r\n                    border: '1px solid #e1e5e9',\r\n                    backgroundColor: '#ffffff',\r\n                    fontFamily: 'Raleway, sans-serif',\r\n                    width: '70vw',\r\n                    maxWidth: '1000px',\r\n                    minWidth: '600px',\r\n                    maxHeight: '80vh',\r\n                    overflowY: 'auto',\r\n                },\r\n            }}\r\n        >\r\n            <div style={{ padding: '32px' }}>\r\n                {/* Header */}\r\n                <div style={{ \r\n                    display: 'flex', \r\n                    alignItems: 'center', \r\n                    justifyContent: 'space-between',\r\n                    marginBottom: '24px',\r\n                    paddingBottom: '16px',\r\n                    borderBottom: '2px solid #f3f2f1'\r\n                }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>\r\n                        <div style={{\r\n                            width: '48px',\r\n                            height: '48px',\r\n                            borderRadius: '12px',\r\n                            backgroundColor: '#e6f3ff',\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            justifyContent: 'center'\r\n                        }}>\r\n                            <Icon \r\n                                iconName=\"Save\" \r\n                                styles={{ \r\n                                    root: { \r\n                                        fontSize: '20px', \r\n                                        color: '#0078d4',\r\n                                    } \r\n                                }} \r\n                            />\r\n                        </div>\r\n                        <div>\r\n                            <Text styles={{ \r\n                                root: { \r\n                                    fontSize: '24px', \r\n                                    fontWeight: '700',\r\n                                    color: '#323130',\r\n                                    margin: '0',\r\n                                    lineHeight: '1.2'\r\n                                } \r\n                            }}>\r\n                                Save Custom Snippet\r\n                            </Text>\r\n                            <Text styles={{ \r\n                                root: { \r\n                                    fontSize: '14px', \r\n                                    color: '#666',\r\n                                    margin: '0',\r\n                                    lineHeight: '1.2'\r\n                                } \r\n                            }}>\r\n                                Choose how to save your customized snippet for future use\r\n                            </Text>\r\n                        </div>\r\n                    </div>\r\n                    <Icon \r\n                        iconName=\"Cancel\" \r\n                        onClick={onDismiss}\r\n                        styles={{ \r\n                            root: { \r\n                                fontSize: '16px', \r\n                                color: '#666',\r\n                                cursor: 'pointer',\r\n                                padding: '12px',\r\n                                borderRadius: '8px',\r\n                                ':hover': {\r\n                                    backgroundColor: '#f3f2f1',\r\n                                    color: '#d83b01',\r\n                                }\r\n                            } \r\n                        }} \r\n                    />\r\n                </div>\r\n\r\n                {/* Mode Selection */}\r\n                <div style={{ marginBottom: '32px' }}>\r\n                    <Text styles={{\r\n                        root: {\r\n                            fontSize: '16px',\r\n                            fontWeight: '600',\r\n                            color: '#323130',\r\n                            marginBottom: '12px',\r\n                            display: 'block',\r\n                        }\r\n                    }}>\r\n                        What would you like to do?\r\n                    </Text>\r\n                    <ChoiceGroup\r\n                        options={modeOptions}\r\n                        selectedKey={mode}\r\n                        onChange={(_, option) => setMode(option?.key as 'edit' | 'create')}\r\n                        styles={{\r\n                            flexContainer: {\r\n                                display: 'flex',\r\n                                gap: '16px',\r\n                            },\r\n                            root: {\r\n                                marginBottom: '0',\r\n                            }\r\n                        }}\r\n                    />\r\n                </div>\r\n\r\n                {/* Content Comparison */}\r\n                <div style={{ marginBottom: '32px' }}>\r\n                    <Text styles={{\r\n                        root: {\r\n                            fontSize: '16px',\r\n                            fontWeight: '600',\r\n                            color: '#323130',\r\n                            marginBottom: '16px',\r\n                            display: 'block',\r\n                        }\r\n                    }}>\r\n                        Content Preview\r\n                        {!hasChanges && (\r\n                            <span style={{\r\n                                fontSize: '14px',\r\n                                fontWeight: '400',\r\n                                color: '#d83b01',\r\n                                marginLeft: '12px',\r\n                                padding: '4px 8px',\r\n                                backgroundColor: '#fdf3e7',\r\n                                borderRadius: '4px',\r\n                                border: '1px solid #f9e2af'\r\n                            }}>\r\n                                No changes detected\r\n                            </span>\r\n                        )}\r\n                        {hasChanges && (\r\n                            <span style={{\r\n                                fontSize: '14px',\r\n                                fontWeight: '400',\r\n                                color: '#2e7d32',\r\n                                marginLeft: '12px',\r\n                                padding: '4px 8px',\r\n                                backgroundColor: '#e8f5e8',\r\n                                borderRadius: '4px',\r\n                                border: '1px solid #c8e6c9',\r\n                                animation: 'fadeInSlide 0.3s ease-out'\r\n                            }}>\r\n                                ✓ Changes detected\r\n                            </span>\r\n                        )}\r\n                    </Text>\r\n                    <div style={{ display: 'flex', gap: '20px' }}>\r\n                        <div style={{ flex: 1 }}>\r\n                            <div style={{ \r\n                                display: 'flex', \r\n                                alignItems: 'center', \r\n                                gap: '8px', \r\n                                marginBottom: '8px' \r\n                            }}>\r\n                                <Icon iconName=\"FileTemplate\" styles={{ root: { fontSize: '14px', color: '#666' } }} />\r\n                                <Text styles={{\r\n                                    root: {\r\n                                        fontSize: '14px',\r\n                                        fontWeight: '600',\r\n                                        color: '#666',\r\n                                    }\r\n                                }}>\r\n                                    Original Template\r\n                                </Text>\r\n                            </div>\r\n                            <div style={{\r\n                                fontSize: '13px',\r\n                                color: '#666',\r\n                                lineHeight: '1.5',\r\n                                padding: '16px',\r\n                                backgroundColor: '#f8f9fa',\r\n                                borderRadius: '8px',\r\n                                border: '1px solid #e1e5e9',\r\n                                whiteSpace: 'pre-wrap',\r\n                                maxHeight: '150px',\r\n                                overflowY: 'auto',\r\n                                fontFamily: 'Raleway, sans-serif',\r\n                            }}>\r\n                                {originalText ? renderContentWithHighlights(originalText, true) : 'No original content available'}\r\n                            </div>\r\n                        </div>\r\n                        <div style={{ flex: 1 }}>\r\n                            <div style={{ \r\n                                display: 'flex', \r\n                                alignItems: 'center', \r\n                                gap: '8px', \r\n                                marginBottom: '8px' \r\n                            }}>\r\n                                <Icon iconName=\"EditNote\" styles={{ root: { fontSize: '14px', color: '#0078d4' } }} />\r\n                                <Text styles={{\r\n                                    root: {\r\n                                        fontSize: '14px',\r\n                                        fontWeight: '600',\r\n                                        color: '#0078d4',\r\n                                    }\r\n                                }}>\r\n                                    Your Customized Version\r\n                                </Text>\r\n                            </div>\r\n                            <div style={{\r\n                                fontSize: '13px',\r\n                                color: '#333',\r\n                                lineHeight: '1.5',\r\n                                padding: '16px',\r\n                                backgroundColor: hasChanges ? '#f0f8ff' : '#f8f9fa',\r\n                                borderRadius: '8px',\r\n                                border: hasChanges ? '1px solid #b3d9ff' : '1px solid #e1e5e9',\r\n                                whiteSpace: 'pre-wrap',\r\n                                maxHeight: '150px',\r\n                                overflowY: 'auto',\r\n                                fontFamily: 'Raleway, sans-serif',\r\n                                transition: 'all 0.3s ease-out'\r\n                            }}>\r\n                                {editedText ? renderContentWithHighlights(editedText, false) : 'No customized content available'}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Form Fields */}\r\n                <Stack tokens={{ childrenGap: 0 }}>\r\n                    <div>\r\n                        <Text styles={{ \r\n                            root: { \r\n                                fontSize: '16px', \r\n                                fontWeight: '600',\r\n                                color: '#323130',\r\n                                marginBottom: '8px',\r\n                                display: 'block',\r\n                            } \r\n                        }}>\r\n                            Snippet Label *\r\n                        </Text>\r\n                        <Text styles={{ \r\n                            root: { \r\n                                fontSize: '13px', \r\n                                color: '#666',\r\n                                marginBottom: '12px',\r\n                                display: 'block',\r\n                            } \r\n                        }}>\r\n                            {mode === 'edit' ? 'Update the label for this existing snippet' : 'Enter a descriptive name for your new snippet'}\r\n                        </Text>\r\n                        <TextField\r\n                            placeholder={mode === 'edit' ? 'Updated snippet name' : 'My custom snippet'}\r\n                            value={label}\r\n                            onChange={(_, v) => setLabel(v || '')}\r\n                            styles={textFieldStyles}\r\n                        />\r\n                    </div>\r\n\r\n                    <div>\r\n                        <Text styles={{ \r\n                            root: { \r\n                                fontSize: '16px', \r\n                                fontWeight: '600',\r\n                                color: '#323130',\r\n                                marginBottom: '8px',\r\n                                display: 'block',\r\n                            } \r\n                        }}>\r\n                            Display Order\r\n                        </Text>\r\n                        <Text styles={{ \r\n                            root: { \r\n                                fontSize: '13px', \r\n                                color: '#666',\r\n                                marginBottom: '12px',\r\n                                display: 'block',\r\n                            } \r\n                        }}>\r\n                            Controls where this snippet appears in the list. Preview: <strong>{getSortOrderPreview(sortOrder)}</strong>\r\n                        </Text>\r\n                        <TextField\r\n                            type=\"number\"\r\n                            placeholder=\"0\"\r\n                            value={String(sortOrder)}\r\n                            onChange={(_, v) => setSortOrder(Number(v) || 0)}\r\n                            styles={textFieldStyles}\r\n                        />\r\n                        <div style={{ \r\n                            fontSize: '12px', \r\n                            color: '#666', \r\n                            marginTop: '8px',\r\n                            padding: '8px 12px',\r\n                            backgroundColor: '#f8f9fa',\r\n                            borderRadius: '4px',\r\n                            border: '1px solid #e1e5e9'\r\n                        }}>\r\n                            <strong>Tip:</strong> Use 1-5 for high priority, 6-10 for normal priority, higher numbers for lower priority\r\n                        </div>\r\n                    </div>\r\n                </Stack>\r\n\r\n                <div style={{\r\n                    padding: '16px',\r\n                    backgroundColor: hasChanges ? '#fff8e1' : '#f8f9fa',\r\n                    borderRadius: '8px',\r\n                    border: hasChanges ? '1px solid #ffcc02' : '1px solid #e1e5e9',\r\n                    marginBottom: '24px',\r\n                    transition: 'all 0.3s ease-out'\r\n                }}>\r\n                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>\r\n                        <Icon iconName={hasChanges ? \"Info\" : \"Warning\"} styles={{ \r\n                            root: { \r\n                                fontSize: '16px', \r\n                                color: hasChanges ? '#ff8c00' : '#666', \r\n                                marginTop: '2px' \r\n                            } \r\n                        }} />\r\n                        <div>\r\n                            <Text styles={{\r\n                                root: {\r\n                                    fontSize: '14px',\r\n                                    fontWeight: '600',\r\n                                    color: hasChanges ? '#ff8c00' : '#666',\r\n                                    marginBottom: '4px',\r\n                                    display: 'block',\r\n                                }\r\n                            }}>\r\n                                {hasChanges ? 'Approval Required' : 'No Changes to Save'}\r\n                            </Text>\r\n                            <Text styles={{\r\n                                root: {\r\n                                    fontSize: '13px',\r\n                                    color: '#666',\r\n                                    lineHeight: '1.4'\r\n                                }\r\n                            }}>\r\n                                {hasChanges \r\n                                    ? (mode === 'edit' \r\n                                        ? 'Your changes will be submitted for review before being applied to the existing snippet.'\r\n                                        : 'Your new snippet will be reviewed and approved before being added to the template library.')\r\n                                    : 'Make changes to the content before saving. Your edits will be highlighted for review.'\r\n                                }\r\n                            </Text>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Actions */}\r\n                <div style={{\r\n                    display: 'flex',\r\n                    justifyContent: 'space-between',\r\n                    alignItems: 'center',\r\n                    gap: '16px',\r\n                    paddingTop: '16px',\r\n                    borderTop: '1px solid #e1e5e9'\r\n                }}>\r\n                    <Text styles={{\r\n                        root: {\r\n                            fontSize: '12px',\r\n                            color: '#666',\r\n                        }\r\n                    }}>\r\n                        * Required fields\r\n                    </Text>\r\n                    <div style={{ display: 'flex', gap: '12px' }}>\r\n                        <DefaultButton\r\n                            text=\"Cancel\"\r\n                            styles={{\r\n                                root: {\r\n                                    backgroundColor: '#ffffff',\r\n                                    border: '1px solid #e1e5e9',\r\n                                    borderRadius: '6px',\r\n                                    fontWeight: '500',\r\n                                    fontSize: '14px',\r\n                                    padding: '10px 24px',\r\n                                    fontFamily: 'Raleway, sans-serif',\r\n                                    color: '#666',\r\n                                    minWidth: '100px',\r\n                                    height: '40px'\r\n                                },\r\n                                rootHovered: {\r\n                                    backgroundColor: '#f8f9fa',\r\n                                    borderColor: '#0078d4',\r\n                                    color: '#0078d4',\r\n                                },\r\n                            }}\r\n                            onClick={onDismiss}\r\n                        />\r\n                        <PrimaryButton\r\n                            text={mode === 'edit' ? 'Submit Changes' : 'Submit New Snippet'}\r\n                            styles={{\r\n                                root: {\r\n                                    backgroundColor: hasChanges ? '#0078d4' : '#d1d1d1',\r\n                                    border: 'none',\r\n                                    borderRadius: '6px',\r\n                                    fontWeight: '600',\r\n                                    fontSize: '14px',\r\n                                    padding: '10px 24px',\r\n                                    fontFamily: 'Raleway, sans-serif',\r\n                                    minWidth: '160px',\r\n                                    height: '40px',\r\n                                    transform: saveButtonAnimated && hasChanges ? 'scale(1.05)' : 'scale(1)',\r\n                                    transition: 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',\r\n                                    cursor: hasChanges ? 'pointer' : 'not-allowed',\r\n                                    opacity: hasChanges ? 1 : 0.6,\r\n                                },\r\n                                rootHovered: hasChanges ? {\r\n                                    backgroundColor: '#106ebe',\r\n                                    transform: 'scale(1.02)',\r\n                                } : {\r\n                                    backgroundColor: '#d1d1d1',\r\n                                    transform: 'scale(1)',\r\n                                },\r\n                                rootPressed: hasChanges ? {\r\n                                    backgroundColor: '#005a9e',\r\n                                    transform: 'scale(0.98)',\r\n                                } : {\r\n                                    backgroundColor: '#d1d1d1',\r\n                                    transform: 'scale(1)',\r\n                                },\r\n                            }}\r\n                            onClick={() => hasChanges && onSave({ label, sortOrder, isNew: mode === 'create' })}\r\n                            disabled={!label.trim() || !hasChanges}\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </Callout>\r\n        </>\r\n    );\r\n};\r\n\r\nexport default SnippetEditPopover;\r\n","// src/constants/deals.ts\r\n// invisible change\r\n\r\nexport const ADDITIONAL_CLIENT_PLACEHOLDER_ID = -1;","import { colours } from '../../../app/styles/colours';\r\n\r\nconst FONT_FAMILY = 'Raleway,Arial,sans-serif';\r\nconst BASE_PARAGRAPH_STYLE = `margin:0 0 8px 0;line-height:1.6;font-family:${FONT_FAMILY};`;\r\nconst LIST_MARGIN = '0 0 8px 20px';\r\nconst LIST_ITEM_STYLE = `margin:0 0 4px 0;line-height:1.6;font-family:${FONT_FAMILY};`;\r\n\r\nexport const EMAIL_V2_CONFIG = {\r\n  enabled: process.env.REACT_APP_EMAIL_V2_ENABLED === 'true',\r\n  fallbackToV1: process.env.REACT_APP_EMAIL_V2_FALLBACK !== 'false',\r\n  logOperations: process.env.REACT_APP_EMAIL_V2_LOGGING === 'true',\r\n  testMode: process.env.REACT_APP_EMAIL_V2_TEST_MODE === 'true'\r\n};\r\n\r\nconst HEADING_STYLES: Record<'h1' | 'h2' | 'h3', string> = {\r\n  h1: `font-size:24px;font-weight:700;margin:4px 0 8px 0;font-family:${FONT_FAMILY};line-height:1.3;`,\r\n  h2: `font-size:20px;font-weight:700;margin:4px 0 8px 0;font-family:${FONT_FAMILY};line-height:1.3;`,\r\n  h3: `font-size:18px;font-weight:700;margin:4px 0 8px 0;font-family:${FONT_FAMILY};line-height:1.3;`\r\n};\r\n\r\nconst REDUNDANT_SPAN_STYLES = new Set([\r\n  'font-family',\r\n  'font-size',\r\n  'font-style',\r\n  'font-weight',\r\n  'font-variant',\r\n  'font-variant-ligatures',\r\n  'font-variant-caps',\r\n  'background-color',\r\n  'color',\r\n  'line-height',\r\n  'letter-spacing'\r\n]);\r\n\r\nconst REDUNDANT_STYLE_VALUES = new Set(['inherit', 'initial', 'unset', 'transparent', '', '#000', '#000000']);\r\n\r\nfunction mergeInlineStyles(...styleFragments: Array<string | undefined>): string {\r\n  const declarations = new Map<string, string>();\r\n\r\n  for (const fragment of styleFragments) {\r\n    if (!fragment) continue;\r\n\r\n    fragment\r\n      .split(';')\r\n      .map((rule) => rule.trim())\r\n      .filter(Boolean)\r\n      .forEach((rule) => {\r\n        const [propertyRaw, ...valueParts] = rule.split(':');\r\n        if (!propertyRaw || valueParts.length === 0) {\r\n          return;\r\n        }\r\n        const property = propertyRaw.trim().toLowerCase();\r\n        const value = valueParts.join(':').trim();\r\n        if (property && value) {\r\n          declarations.set(property, value);\r\n        }\r\n      });\r\n  }\r\n\r\n  if (declarations.size === 0) {\r\n    return '';\r\n  }\r\n\r\n  return Array.from(declarations.entries())\r\n    .map(([property, value]) => `${property}:${value}`)\r\n    .join(';')\r\n    .concat(';');\r\n}\r\n\r\nfunction stripProperties(style: string, properties: string[]): string {\r\n  if (!style) {\r\n    return '';\r\n  }\r\n\r\n  const propertiesSet = new Set(properties.map((prop) => prop.toLowerCase()));\r\n\r\n  const remaining = style\r\n    .split(';')\r\n    .map((rule) => rule.trim())\r\n    .filter(Boolean)\r\n    .filter((rule) => {\r\n      const [propertyRaw] = rule.split(':');\r\n      if (!propertyRaw) {\r\n        return false;\r\n      }\r\n      const property = propertyRaw.trim().toLowerCase();\r\n      return !propertiesSet.has(property);\r\n    });\r\n\r\n  return remaining.join(';');\r\n}\r\n\r\nfunction sanitiseParagraphStyle(style: string | undefined): string {\r\n  if (!style) {\r\n    return '';\r\n  }\r\n\r\n  const cleaned = stripProperties(style, ['margin', 'padding']);\r\n  return cleaned ? cleaned.concat(cleaned.endsWith(';') ? '' : ';') : '';\r\n}\r\n\r\nfunction shouldPreserveSpan(attributes: string): boolean {\r\n  if (!attributes || !attributes.trim()) {\r\n    return false;\r\n  }\r\n\r\n  if (/(class|id|data-|aria-)/i.test(attributes)) {\r\n    return true;\r\n  }\r\n\r\n  const styleMatch = attributes.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n  if (!styleMatch) {\r\n    return false;\r\n  }\r\n\r\n  const styleValue = styleMatch[1];\r\n  const hasMeaningfulRule = styleValue\r\n    .split(';')\r\n    .map((rule) => rule.trim())\r\n    .filter(Boolean)\r\n    .some((rule) => {\r\n      const [propertyRaw, ...valueParts] = rule.split(':');\r\n      if (!propertyRaw || valueParts.length === 0) {\r\n        return false;\r\n      }\r\n      const property = propertyRaw.trim().toLowerCase();\r\n      const value = valueParts.join(':').trim().toLowerCase();\r\n\r\n      if (!REDUNDANT_SPAN_STYLES.has(property)) {\r\n        return true;\r\n      }\r\n\r\n      return !REDUNDANT_STYLE_VALUES.has(value);\r\n    });\r\n\r\n  return hasMeaningfulRule;\r\n}\r\n\r\n/**\r\n * Enhanced line break preservation for Outlook compatibility\r\n */\r\nexport function preserveLineBreaksV2(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html.replace(/\\r\\n/g, '\\n');\r\n\r\n  processed = processed.replace(/<div[^>]*>\\s*<br[^>]*>\\s*<\\/div>/gi, '<br>');\r\n  processed = processed.replace(/<div[^>]*>\\s*<\\/div>/gi, '');\r\n\r\n  processed = processed.replace(/\\n{3,}/g, '\\n\\n');\r\n  processed = processed.replace(/\\n\\s*\\n/g, `</p><p style=\"${BASE_PARAGRAPH_STYLE}\">`);\r\n  processed = processed.replace(/\\n/g, '<br>');\r\n\r\n  processed = processed.replace(/(<br[^>]*>\\s*){3,}/gi, `<br><br>`);\r\n  processed = processed.replace(/(<br[^>]*>\\s*){2}/gi, `</p><p style=\"${BASE_PARAGRAPH_STYLE}\">`);\r\n\r\n  const trimmed = processed.trim();\r\n  if (!trimmed) {\r\n    return '';\r\n  }\r\n\r\n  let wrapped = trimmed;\r\n  if (!/^<p\\b/i.test(trimmed)) {\r\n    wrapped = `<p style=\"${BASE_PARAGRAPH_STYLE}\">${wrapped}`;\r\n  }\r\n  if (!/<\\/p>\\s*$/i.test(wrapped)) {\r\n    wrapped = `${wrapped}</p>`;\r\n  }\r\n\r\n  return wrapped;\r\n}\r\n\r\n/**\r\n * Normalise inconsistent div/span structures that cause selection gaps\r\n */\r\nexport function normalizeHtmlStructure(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html;\r\n\r\n  processed = processed.replace(/<div[^>]*>\\s*<\\/div>/gi, '');\r\n  processed = processed.replace(/<span[^>]*>\\s*<\\/span>/gi, '');\r\n\r\n  processed = processed.replace(\r\n    /<span([^>]*)>([\\s\\S]*?)<\\/span>/gi,\r\n    (match, attributes = '', content = '') => {\r\n      if (!content.trim()) {\r\n        return '';\r\n      }\r\n\r\n      if (shouldPreserveSpan(attributes)) {\r\n        return `<span${attributes}>${content}</span>`;\r\n      }\r\n\r\n      return content;\r\n    }\r\n  );\r\n\r\n  processed = processed.replace(/<span[^>]*>\\s*(<br[^>]*>)\\s*<\\/span>/gi, '$1');\r\n  processed = processed.replace(/<span[^>]*>\\s*(?:&nbsp;|&#160;|\\u00a0)\\s*<\\/span>/gi, '&nbsp;');\r\n\r\n  return processed;\r\n}\r\n\r\n/**\r\n * Convert inline content-focused divs into paragraphs so downstream formatting stays consistent\r\n */\r\nexport function convertContentDivsToParagraphs(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  return html.replace(\r\n    /<div([^>]*)>([\\s\\S]*?)<\\/div>/gi,\r\n    (match, rawAttributes = '', rawContent = '') => {\r\n      const content = rawContent.trim();\r\n      if (!content) {\r\n        return '';\r\n      }\r\n\r\n      if (/(<\\s*(div|table|thead|tbody|tfoot|tr|td|th|ul|ol|li|section|article|header|footer|main|aside|form|figure|blockquote)[^>]*>)/i.test(content)) {\r\n        return match;\r\n      }\r\n\r\n      const classMatch = rawAttributes.match(/class\\s*=\\s*\"([^\"]*)\"/i);\r\n      const idMatch = rawAttributes.match(/id\\s*=\\s*\"([^\"]*)\"/i);\r\n      const dataAttributes = rawAttributes\r\n        .split(/\\s+/)\r\n        .filter(Boolean)\r\n        .filter((attr: string) => /^(data-|aria-)/i.test(attr));\r\n\r\n      const styleMatch = rawAttributes.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const cleanedStyle = sanitiseParagraphStyle(styleMatch?.[1]);\r\n      const mergedStyle = mergeInlineStyles(BASE_PARAGRAPH_STYLE, cleanedStyle);\r\n\r\n      const classFragment = classMatch ? ` class=\"${classMatch[1]}\"` : '';\r\n      const idFragment = idMatch ? ` id=\"${idMatch[1]}\"` : '';\r\n      const dataFragment = dataAttributes.length ? ` ${dataAttributes.join(' ')}` : '';\r\n\r\n      return `<p${classFragment}${idFragment}${dataFragment} style=\"${mergedStyle}\">${content}</p>`;\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * Remove redundant leading/trailing <br> tags inside paragraphs and collapse empty paragraphs\r\n */\r\nexport function tidyParagraphBreaks(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html.replace(\r\n    /<p([^>]*)>([\\s\\S]*?)<\\/p>/gi,\r\n    (match, attrs = '', content = '') => {\r\n      const trimmedContent = content\r\n        .replace(/^(?:\\s*<br[^>]*>\\s*)+/gi, '')\r\n        .replace(/(?:\\s*<br[^>]*>\\s*)+$/gi, '')\r\n        .trim();\r\n\r\n      const withoutNbsp = trimmedContent.replace(/(?:&nbsp;|&#160;|\\u00a0)/gi, '').trim();\r\n\r\n      if (!withoutNbsp) {\r\n        return '';\r\n      }\r\n\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const cleanedStyle = sanitiseParagraphStyle(styleMatch?.[1]);\r\n      const mergedStyle = mergeInlineStyles(BASE_PARAGRAPH_STYLE, cleanedStyle);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n\r\n      return `<p${attrFragment} style=\"${mergedStyle}\">${trimmedContent}</p>`;\r\n    }\r\n  );\r\n\r\n  processed = processed.replace(/(?:<p[^>]*>\\s*<\\/p>\\s*)+/gi, '');\r\n\r\n  return processed;\r\n}\r\n\r\nexport function splitParagraphsOnDoubleBreaks(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  return html.replace(\r\n    /<p([^>]*)>([\\s\\S]*?)<\\/p>/gi,\r\n    (match, attrs = '', content = '') => {\r\n      const segments = content\r\n        .split(/(?:<br[^>]*>\\s*){2,}/gi)\r\n        .map((segment: string) => segment.trim())\r\n        .filter(Boolean);\r\n\r\n      if (segments.length <= 1) {\r\n        return `<p${attrs}>${content}</p>`;\r\n      }\r\n\r\n      return segments\r\n        .map((segment: string) => `<p${attrs}>${segment}</p>`)\r\n        .join('');\r\n    }\r\n  );\r\n}\r\n\r\nexport function protectNumbersFromOutlook(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html;\r\n\r\n  processed = processed.replace(\r\n    /£[\\d,]+(?:\\.[\\d]{1,2})?(?:\\s*\\+\\s*VAT)?/gi,\r\n    (match) => `<span style=\"font-weight:normal!important;text-decoration:none!important;\">${match}</span>`\r\n  );\r\n\r\n  processed = processed.replace(\r\n    /\\b\\d{1,3}(?:,\\d{3})*(?:\\.\\d{1,2})?\\b/g,\r\n    (match) => {\r\n      const numericValue = parseFloat(match.replace(/,/g, ''));\r\n      return numericValue >= 100\r\n        ? `<span style=\"font-weight:normal!important;\">${match}</span>`\r\n        : match;\r\n    }\r\n  );\r\n\r\n  processed = processed.replace(\r\n    /\\b\\d+(?:\\.\\d+)?%/g,\r\n    (match) => `<span style=\"font-weight:normal!important;\">${match}</span>`\r\n  );\r\n\r\n  return processed;\r\n}\r\n\r\nexport function wrapWithEmailContainer(html: string): string {\r\n  return html || '';\r\n}\r\n\r\nfunction adjustParagraphMargin(paragraph: RegExpMatchArray, margin: string): string {\r\n  const [fullMatch, attrs = '', content = ''] = paragraph;\r\n  const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n  const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n  const cleanedStyle = sanitiseParagraphStyle(styleMatch?.[1]);\r\n  const mergedStyle = mergeInlineStyles(margin, cleanedStyle);\r\n  const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n  return `<p${attrFragment} style=\"${mergedStyle}\">${content}</p>`;\r\n}\r\n\r\nfunction tightenEdgeParagraphSpacing(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  const paragraphMatches = Array.from(html.matchAll(/<p([^>]*)>([\\s\\S]*?)<\\/p>/gi));\r\n  if (paragraphMatches.length === 0) {\r\n    return html;\r\n  }\r\n\r\n  let result = html;\r\n\r\n  const first = paragraphMatches[0];\r\n  const last = paragraphMatches[paragraphMatches.length - 1];\r\n\r\n  const isSingle = paragraphMatches.length === 1;\r\n\r\n  const firstReplacement = adjustParagraphMargin(first, BASE_PARAGRAPH_STYLE);\r\n  result = result.replace(first[0], firstReplacement);\r\n\r\n  const lastMargin = isSingle ? 'margin:0 0 0 0;' : 'margin:0 0 0 0;';\r\n  const lastReplacement = adjustParagraphMargin(last, lastMargin);\r\n  result = result.replace(last[0], lastReplacement);\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Enhanced heading formatting for better email client compatibility\r\n */\r\nexport function enhanceHeadingFormatting(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html;\r\n\r\n  (Object.keys(HEADING_STYLES) as Array<keyof typeof HEADING_STYLES>).forEach((tag) => {\r\n    const baseStyle = HEADING_STYLES[tag];\r\n    const regex = new RegExp(`<${tag}([^>]*)>`, 'gi');\r\n\r\n    processed = processed.replace(regex, (match, attrs = '') => {\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const mergedStyle = mergeInlineStyles(baseStyle, styleMatch?.[1]);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n\r\n      return `<${tag}${attrFragment} style=\"${mergedStyle}\">`;\r\n    });\r\n  });\r\n\r\n  return processed;\r\n}\r\n\r\n/**\r\n * Enhanced list formatting with better Outlook compatibility\r\n */\r\nexport function enhanceListFormattingV2(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html;\r\n\r\n  processed = processed.replace(\r\n    /<ul([^>]*)>/gi,\r\n    (match, attrs = '') => {\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const mergedStyle = mergeInlineStyles(`margin:${LIST_MARGIN};padding:0;list-style-type:disc;font-family:${FONT_FAMILY};`, styleMatch?.[1]);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n      return `<ul${attrFragment} style=\"${mergedStyle}\">`;\r\n    }\r\n  );\r\n\r\n  processed = processed.replace(\r\n    /<ol([^>]*)>/gi,\r\n    (match, attrs = '') => {\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const mergedStyle = mergeInlineStyles(`margin:${LIST_MARGIN};padding:0;list-style-type:decimal;font-family:${FONT_FAMILY};`, styleMatch?.[1]);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n      return `<ol${attrFragment} style=\"${mergedStyle}\">`;\r\n    }\r\n  );\r\n\r\n  processed = processed.replace(\r\n    /<li([^>]*)>/gi,\r\n    (match, attrs = '') => {\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const mergedStyle = mergeInlineStyles(LIST_ITEM_STYLE, styleMatch?.[1]);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n      return `<li${attrFragment} style=\"${mergedStyle}\">`;\r\n    }\r\n  );\r\n\r\n  return processed;\r\n}\r\n\r\n/**\r\n * Enhanced link formatting for better email client support\r\n */\r\nexport function enhanceLinkFormatting(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  return html.replace(\r\n    /<a([^>]*?)>/gi,\r\n    (match, attrs = '') => {\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const mergedStyle = mergeInlineStyles(`color:${colours.blue}!important;text-decoration:underline!important;font-family:${FONT_FAMILY};`, styleMatch?.[1]);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n      return `<a${attrFragment} style=\"${mergedStyle}\">`;\r\n    }\r\n  );\r\n}\r\n\r\n/**\r\n * Enhanced paragraph formatting for consistent spacing\r\n */\r\nexport function enhanceParagraphFormatting(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  let processed = html;\r\n\r\n  processed = processed.replace(\r\n    /<div([^>]*)>([\\s\\S]*?)<\\/div>/gi,\r\n    (match, rawAttributes = '', rawContent = '') => {\r\n      const content = rawContent.trim();\r\n      if (!content) {\r\n        return '';\r\n      }\r\n\r\n      if (/(<\\s*(div|table|thead|tbody|tfoot|tr|td|th|ul|ol|li|section|article|header|footer|main|aside|form|figure|blockquote)[^>]*>)/i.test(content)) {\r\n        return match;\r\n      }\r\n\r\n      const classMatch = rawAttributes.match(/class\\s*=\\s*\"([^\"]*)\"/i);\r\n      const idMatch = rawAttributes.match(/id\\s*=\\s*\"([^\"]*)\"/i);\r\n      const dataAttributes = rawAttributes\r\n        .split(/\\s+/)\r\n        .filter(Boolean)\r\n        .filter((attr: string) => /^(data-|aria-)/i.test(attr));\r\n\r\n      const styleMatch = rawAttributes.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const cleanedStyle = sanitiseParagraphStyle(styleMatch?.[1]);\r\n      const mergedStyle = mergeInlineStyles(BASE_PARAGRAPH_STYLE, cleanedStyle);\r\n\r\n      const classFragment = classMatch ? ` class=\"${classMatch[1]}\"` : '';\r\n      const idFragment = idMatch ? ` id=\"${idMatch[1]}\"` : '';\r\n      const dataFragment = dataAttributes.length ? ` ${dataAttributes.join(' ')}` : '';\r\n\r\n      return `<p${classFragment}${idFragment}${dataFragment} style=\"${mergedStyle}\">${content}</p>`;\r\n    }\r\n  );\r\n\r\n  processed = processed.replace(\r\n    /<p([^>]*)>/gi,\r\n    (match, attrs = '') => {\r\n      const styleMatch = attrs.match(/style\\s*=\\s*\"([^\"]*)\"/i);\r\n      const otherAttrs = styleMatch ? attrs.replace(styleMatch[0], '').trim() : attrs.trim();\r\n      const cleanedStyle = sanitiseParagraphStyle(styleMatch?.[1]);\r\n      const mergedStyle = mergeInlineStyles(BASE_PARAGRAPH_STYLE, cleanedStyle);\r\n      const attrFragment = otherAttrs ? ` ${otherAttrs}` : '';\r\n      return `<p${attrFragment} style=\"${mergedStyle}\">`;\r\n    }\r\n  );\r\n\r\n  return processed;\r\n}\r\n\r\n/**\r\n * Main V2 email processing function\r\n */\r\nexport function processEmailContentV2(html: string): string {\r\n  if (!html) {\r\n    return '';\r\n  }\r\n\r\n  EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Starting V2 processing');\r\n\r\n  try {\r\n    let processed = html;\r\n\r\n    processed = normalizeHtmlStructure(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] HTML structure normalised');\r\n\r\n    processed = convertContentDivsToParagraphs(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Content divs converted');\r\n\r\n    processed = preserveLineBreaksV2(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Line breaks preserved');\r\n\r\n    processed = protectNumbersFromOutlook(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Numbers protected');\r\n\r\n    processed = enhanceParagraphFormatting(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Paragraphs enhanced');\r\n\r\n    processed = splitParagraphsOnDoubleBreaks(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Paragraphs split');\r\n\r\n    processed = tidyParagraphBreaks(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Paragraph breaks tidied');\r\n\r\n    processed = tightenEdgeParagraphSpacing(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Edge paragraph spacing tightened');\r\n\r\n    processed = enhanceHeadingFormatting(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Headings enhanced');\r\n\r\n    processed = enhanceListFormattingV2(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Lists enhanced');\r\n\r\n    processed = enhanceLinkFormatting(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Links enhanced');\r\n\r\n    processed = wrapWithEmailContainer(processed);\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Container applied');\r\n\r\n    return processed;\r\n  } catch (error) {\r\n    console.error('[EmailV2] Error in V2 processing:', error);\r\n\r\n    if (EMAIL_V2_CONFIG.fallbackToV1) {\r\n      EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Falling back to V1');\r\n      return html;\r\n    }\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Safe wrapper that chooses between V1 and V2 processing\r\n */\r\nexport function processEmailWithFallback(html: string, v1Processor: (value: string) => string): string {\r\n  if (!EMAIL_V2_CONFIG.enabled) {\r\n    EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] V2 disabled, using V1');\r\n    return v1Processor(html);\r\n  }\r\n\r\n  try {\r\n    const v2Result = processEmailContentV2(html);\r\n\r\n    if (EMAIL_V2_CONFIG.testMode) {\r\n      const v1Result = v1Processor(html);\r\n      console.log('[EmailV2] Test mode - V1 length:', v1Result.length);\r\n      console.log('[EmailV2] Test mode - V2 length:', v2Result.length);\r\n      return v1Result;\r\n    }\r\n\r\n    return v2Result;\r\n  } catch (error) {\r\n    console.error('[EmailV2] V2 processing failed:', error);\r\n\r\n    if (EMAIL_V2_CONFIG.fallbackToV1) {\r\n      EMAIL_V2_CONFIG.logOperations && console.log('[EmailV2] Falling back to V1');\r\n      return v1Processor(html);\r\n    }\r\n\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Environment variable configuration helper\r\n */\r\nexport function getEmailV2Config() {\r\n  return {\r\n    ...EMAIL_V2_CONFIG,\r\n    environment: process.env.NODE_ENV,\r\n    timestamp: new Date().toISOString()\r\n  };\r\n}\r\n\r\n/**\r\n * Testing helper to compare V1 vs V2 output\r\n */\r\nexport function compareFormattingSystems(\r\n  html: string,\r\n  v1Processor: (value: string) => string\r\n): { v1: string; v2: string; differences: string[] } {\r\n  const v1Result = v1Processor(html);\r\n  const v2Result = processEmailContentV2(html);\r\n\r\n  const differences: string[] = [];\r\n\r\n  if (v1Result.length !== v2Result.length) {\r\n    differences.push(`Length difference: V1=${v1Result.length}, V2=${v2Result.length}`);\r\n  }\r\n\r\n  return {\r\n    v1: v1Result,\r\n    v2: v2Result,\r\n    differences\r\n  };\r\n}\r\n\r\nexport default processEmailContentV2;","/**\r\n * Email Processing Factory - Safe Integration Point\r\n * \r\n * This module provides a safe way to switch between V1 (production) and V2 (enhanced)\r\n * email processing systems without affecting existing functionality.\r\n */\r\n\r\nimport { \r\n  processEmailContentV2, \r\n  processEmailWithFallback, \r\n  EMAIL_V2_CONFIG,\r\n  compareFormattingSystems\r\n} from './emailFormattingV2';\r\n\r\n// Import V1 functions (existing production system)\r\nimport { \r\n  processEditorContentForEmail as processV1,\r\n  convertDoubleBreaksToParagraphs,\r\n  removeHighlightSpans,\r\n  applyDynamicSubstitutions\r\n} from './emailUtils';\r\n\r\n/**\r\n * Main email processing factory\r\n * This is the single entry point for all email processing\r\n */\r\nexport class EmailProcessor {\r\n  private static logOperation(message: string, data?: any) {\r\n    if (EMAIL_V2_CONFIG.logOperations) {\r\n      console.log(`[EmailProcessor] ${message}`, data || '');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process email content using the configured system (V1 or V2)\r\n   */\r\n  static processEmailContent(\r\n    content: string,\r\n    options: {\r\n      editorElement?: HTMLElement | null;\r\n      fallbackHtml?: string;\r\n      preserveHighlights?: boolean;\r\n      forceV2?: boolean; // Allow explicit V2 usage for development testing\r\n    } = {}\r\n  ): string {\r\n    this.logOperation('Starting email processing', {\r\n      useV2: EMAIL_V2_CONFIG.enabled || options.forceV2,\r\n      contentLength: content.length,\r\n      hasEditor: !!options.editorElement,\r\n      forceV2: options.forceV2\r\n    });\r\n\r\n    // V1 processor function (existing production logic)\r\n    const processWithV1 = (html: string): string => {\r\n      this.logOperation('Using V1 processing');\r\n      \r\n      let processed = html;\r\n      \r\n      // Apply existing V1 processing steps\r\n      if (!options.preserveHighlights) {\r\n        processed = removeHighlightSpans(processed);\r\n      }\r\n      \r\n      processed = convertDoubleBreaksToParagraphs(processed);\r\n      \r\n      return processed;\r\n    };\r\n\r\n    // Check if we should force V2 for development testing\r\n    if (options.forceV2) {\r\n      this.logOperation('Force V2 processing for development testing');\r\n      try {\r\n        const processed = processEmailContentV2(content);\r\n        this.logOperation('Force V2 processing completed successfully');\r\n        return processed;\r\n      } catch (error) {\r\n        console.error('[EmailProcessor] Force V2 failed, falling back to V1:', error);\r\n        return processWithV1(content);\r\n      }\r\n    }\r\n\r\n    // Use the safe wrapper that handles V1/V2 switching and fallback\r\n    const result = processEmailWithFallback(content, processWithV1);\r\n\r\n    this.logOperation('Email processing completed', {\r\n      resultLength: result.length,\r\n      system: EMAIL_V2_CONFIG.enabled ? 'V2' : 'V1'\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Process editor content specifically (for rich text editor)\r\n   */\r\n  static processEditorContent(\r\n    editorElement: HTMLElement | null,\r\n    fallbackHtml?: string,\r\n    forceV2?: boolean\r\n  ): string {\r\n    if (!editorElement && !fallbackHtml) {\r\n      return '';\r\n    }\r\n\r\n    const content = editorElement ? editorElement.innerHTML : (fallbackHtml || '');\r\n    \r\n    return this.processEmailContent(content, {\r\n      editorElement,\r\n      fallbackHtml,\r\n      preserveHighlights: false,\r\n      forceV2\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Apply dynamic substitutions (used by both V1 and V2)\r\n   */\r\n  static applySubstitutions(\r\n    html: string,\r\n    userData: any,\r\n    enquiry: any,\r\n    amount?: number | string,\r\n    passcode?: string,\r\n    instructionsLink?: string\r\n  ): string {\r\n    this.logOperation('Applying dynamic substitutions');\r\n    \r\n    return applyDynamicSubstitutions(\r\n      html,\r\n      userData,\r\n      enquiry,\r\n      amount,\r\n      passcode,\r\n      instructionsLink\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Complete email processing pipeline\r\n   * This processes content and applies all substitutions\r\n   */\r\n  static processCompleteEmail(\r\n    content: string,\r\n    context: {\r\n      editorElement?: HTMLElement | null;\r\n      userData?: any;\r\n      enquiry?: any;\r\n      amount?: number | string;\r\n      passcode?: string;\r\n      instructionsLink?: string;\r\n      forceV2?: boolean; // Allow explicit V2 usage for development testing\r\n    }\r\n  ): string {\r\n    this.logOperation('Starting complete email processing pipeline');\r\n\r\n    // Step 1: Process the content (V1 or V2)\r\n    let processed = this.processEmailContent(content, {\r\n      editorElement: context.editorElement,\r\n      forceV2: context.forceV2\r\n    });\r\n\r\n    // Step 2: Apply dynamic substitutions (same for both V1 and V2)\r\n    if (context.userData || context.enquiry) {\r\n      processed = this.applySubstitutions(\r\n        processed,\r\n        context.userData,\r\n        context.enquiry,\r\n        context.amount,\r\n        context.passcode,\r\n        context.instructionsLink\r\n      );\r\n    }\r\n\r\n    this.logOperation('Complete email processing finished');\r\n    return processed;\r\n  }\r\n\r\n  /**\r\n   * Testing and comparison utilities\r\n   */\r\n  static compareSystemOutputs(content: string): {\r\n    v1: string;\r\n    v2: string;\r\n    differences: string[];\r\n    recommendation: string;\r\n  } {\r\n    const v1Processor = (html: string) => {\r\n      let processed = removeHighlightSpans(html);\r\n      processed = convertDoubleBreaksToParagraphs(processed);\r\n      return processed;\r\n    };\r\n\r\n    const comparison = compareFormattingSystems(content, v1Processor);\r\n    \r\n    // Analyze differences and provide recommendation\r\n    const recommendation = comparison.differences.length === 0 \r\n      ? 'Both systems produce identical output'\r\n      : comparison.differences.length < 3\r\n        ? 'Minor differences - V2 safe to use'\r\n        : 'Significant differences - review before using V2';\r\n\r\n    return {\r\n      ...comparison,\r\n      recommendation\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration and status\r\n   */\r\n  static getStatus() {\r\n    return {\r\n      currentSystem: EMAIL_V2_CONFIG.enabled ? 'V2 (Enhanced)' : 'V1 (Production)',\r\n      config: EMAIL_V2_CONFIG,\r\n      environment: process.env.NODE_ENV,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Emergency fallback to V1 only\r\n   * Can be called if V2 system encounters issues\r\n   */\r\n  static forceV1Mode() {\r\n    console.warn('[EmailProcessor] Forcing V1 mode due to emergency fallback');\r\n    \r\n    // Override the config (this only affects current session)\r\n    (EMAIL_V2_CONFIG as any).enabled = false;\r\n    (EMAIL_V2_CONFIG as any).fallbackToV1 = true;\r\n    \r\n    this.logOperation('Forced fallback to V1 mode activated');\r\n  }\r\n}\r\n\r\n/**\r\n * Convenience function for backward compatibility\r\n * This maintains the same interface as the original processEditorContentForEmail\r\n */\r\nexport function processEditorContentForEmail(\r\n  editorElement: HTMLElement | null,\r\n  fallbackHtml?: string,\r\n  forceV2?: boolean\r\n): string {\r\n  return EmailProcessor.processEditorContent(editorElement, fallbackHtml, forceV2);\r\n}\r\n\r\n/**\r\n * Enhanced replacement for existing email processing calls\r\n * This can be used as a drop-in replacement for existing calls\r\n */\r\nexport function enhancedProcessEmailContent(\r\n  content: string,\r\n  context: {\r\n    userData?: any;\r\n    enquiry?: any;\r\n    amount?: number | string;\r\n    passcode?: string;\r\n    editorElement?: HTMLElement | null;\r\n    forceV2?: boolean;\r\n  } = {}\r\n): string {\r\n  return EmailProcessor.processCompleteEmail(content, context);\r\n}\r\n\r\nexport default EmailProcessor;","import React, { useState, useEffect, useRef } from 'react';\r\nimport {\r\n  Stack,\r\n  IDropdownOption,\r\n  PrimaryButton,\r\n  DefaultButton,\r\n  mergeStyles,\r\n  Label,\r\n  Icon,\r\n  Callout,\r\n  IconButton,\r\n  Dropdown,\r\n  FocusZone,\r\n  FocusZoneDirection,\r\n  DirectionalHint,\r\n  Separator,\r\n  Checkbox,\r\n  ChoiceGroup,\r\n  IChoiceGroupOption,\r\n  IPoint,\r\n  Text,\r\n  TooltipHost,\r\n} from '@fluentui/react';\r\nimport { Enquiry, UserData } from '../../app/functionality/types';\r\nimport { colours } from '../../app/styles/colours';\r\nimport { isAdminUser } from '../../app/admin';\r\nimport BubbleTextField from '../../app/styles/BubbleTextField';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport { useNavigatorActions } from '../../app/functionality/NavigatorContext';\r\nimport PracticeAreaPitch, { PracticeAreaPitchType } from '../../app/customisation/PracticeAreaPitch';\r\nimport { TemplateBlock, TemplateOption } from '../../app/customisation/ProductionTemplateBlocks';\r\nimport {\r\n  getTemplateBlocks,\r\n  TemplateSet,\r\n  getTemplateSetLabel,\r\n  getDatabaseBlocksData,\r\n  compileBlocks,\r\n} from '../../app/customisation/TemplateBlockSets';\r\nimport { availableAttachments, AttachmentOption } from '../../app/customisation/Attachments';\r\nimport {\r\n  sharedPrimaryButtonStyles,\r\n  sharedDefaultButtonStyles,\r\n  sharedDraftConfirmedButtonStyles,\r\n  inlineOptionButtonStyles,\r\n} from '../../app/styles/ButtonStyles';\r\nimport {\r\n  sharedEditorStyle,\r\n  sharedOptionsDropdownStyles,\r\n} from '../../app/styles/FilterStyles';\r\nimport { PitchDebugPanel, useLocalFetchLogger } from './pitch-builder';\r\nimport EmailSignature from './EmailSignature';\r\nimport EditorAndTemplateBlocks from './pitch-builder/EditorAndTemplateBlocks';\r\nimport VerificationSummary from './pitch-builder/VerificationSummary';\r\nimport OperationStatusToast from './pitch-builder/OperationStatusToast';\r\nimport { addDays } from 'date-fns';\r\nimport PlaceholderEditorPopover from './pitch-builder/PlaceholderEditorPopover';\r\nimport SnippetEditPopover from './pitch-builder/SnippetEditPopover';\r\n\r\nimport ReactDOMServer from 'react-dom/server';\r\nimport { placeholderSuggestions } from '../../app/customisation/InsertSuggestions';\r\nimport { getProxyBaseUrl } from '../../utils/getProxyBaseUrl';\r\nimport { isInTeams } from '../../app/functionality/isInTeams';\r\nimport {\r\n  convertDoubleBreaksToParagraphs,\r\n  removeUnfilledPlaceholders,\r\n  removeHighlightSpans,\r\n  cleanTemplateString,\r\n  isStringArray,\r\n  replacePlaceholders,\r\n  applyDynamicSubstitutions,\r\n  wrapInsertPlaceholders,\r\n} from './pitch-builder/emailUtils';\r\nimport { inputFieldStyle } from '../../CustomForms/BespokeForms';\r\nimport { ADDITIONAL_CLIENT_PLACEHOLDER_ID } from '../../constants/deals';\r\nimport EmailProcessor from './pitch-builder/EmailProcessor';\r\n\r\n// PROOF_OF_ID_URL constant removed - now constructed dynamically with passcode in applyDynamicSubstitutions\r\n\r\n// Dynamic import + HMR for ProductionTemplateBlocks\r\nfunction useDynamicTemplateBlocks(templateSet: TemplateSet) {\r\n  const [blocks, setBlocks] = useState<TemplateBlock[]>(() => getTemplateBlocks(templateSet));\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    async function loadBlocks() {\r\n      const mod = await import('../../app/customisation/ProductionTemplateBlocks');\r\n      if (!cancelled) {\r\n        // If you export named blocks, adjust as needed\r\n        setBlocks(getTemplateBlocks(templateSet));\r\n      }\r\n    }\r\n    loadBlocks();\r\n    // HMR support\r\n    // @ts-expect-error: HMR property only exists in dev\r\n    if (import.meta && import.meta.hot) {\r\n      // @ts-expect-error: HMR property only exists in dev\r\n      import.meta.hot.accept('../../app/customisation/ProductionTemplateBlocks', (mod: any) => {\r\n        loadBlocks();\r\n      });\r\n      // @ts-expect-error: HMR property only exists in dev\r\n    } else if (typeof module !== 'undefined' && module.hot) {\r\n      // @ts-expect-error: HMR property only exists in dev\r\n      module.hot.accept('../../app/customisation/ProductionTemplateBlocks', () => {\r\n        loadBlocks();\r\n      });\r\n    }\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [templateSet]);\r\n  return blocks;\r\n}\r\n\r\ninterface PitchBuilderProps {\r\n  enquiry: Enquiry;\r\n  userData: UserData[] | null;\r\n  showDealCapture?: boolean;\r\n}\r\n\r\n// Small typed fetch helper with discriminated result for safer error handling\r\nasync function safeFetchJson<T>(input: RequestInfo, init?: RequestInit): Promise<{ ok: true; value: T } | { ok: false; error: string; status?: number }> {\r\n  try {\r\n    const res = await fetch(input as any, init);\r\n    if (!res.ok) {\r\n      const text = await res.text().catch(() => '');\r\n      return { ok: false, error: text || `HTTP ${res.status}`, status: res.status };\r\n    }\r\n    const json = (await res.json()) as T;\r\n    return { ok: true, value: json };\r\n  } catch (err: unknown) {\r\n    return { ok: false, error: (err instanceof Error ? err.message : 'Network error') };\r\n  }\r\n}\r\n\r\ninterface ApiCallLog {\r\n  id: string;\r\n  ts: Date;\r\n  url: string;\r\n  method: string;\r\n  status?: number;\r\n  durationMs: number;\r\n  snippet?: string;\r\n  error?: string;\r\n}\r\n\r\ninterface ClientInfo {\r\n  firstName: string;\r\n  lastName: string;\r\n  email: string;\r\n}\r\n\r\n// Escape attribute values for use within querySelector\r\nfunction escapeForSelector(value: string): string {\r\n  if (typeof (window as any).CSS !== 'undefined' && (CSS as any).escape) {\r\n    return (CSS as any).escape(value);\r\n  }\r\n  return value.replace(/([\"'\\\\\\[\\]\\.#:>+~*^$|?{}()])/g, '\\\\$1');\r\n}\r\n\r\n// Inject styles for inline block labels and option callout\r\nif (typeof window !== 'undefined' && !document.getElementById('block-label-style')) {\r\n  const style = document.createElement('style');\r\n  style.id = 'block-label-style';\r\n  style.innerHTML = `\r\n    .block-controls {\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: space-between;\r\n      font-size: 10px;\r\n      color: ${colours.greyText};\r\n      margin-top: 8px;\r\n    }\r\n    .block-controls .actions {\r\n      display: flex;\r\n      align-items: center;\r\n      gap: 4px;\r\n    }\r\n    .block-controls .icon-btn {\r\n      width: 24px;\r\n      height: 24px;\r\n      display: inline-flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      border-radius: 4px;\r\n      background: ${colours.grey};\r\n      color: ${colours.greyText};\r\n      cursor: pointer;\r\n      font-size: 14px;\r\n      user-select: none;\r\n      transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;\r\n    }\r\n    .block-controls .icon-btn:hover {\r\n      background: ${colours.blue};\r\n      color: #ffffff;\r\n      transform: scale(1.05);\r\n      }\r\n    .block-label {\r\n      flex-grow: 1;\r\n      position: relative;\r\n      cursor: pointer;\r\n      display: block;\r\n      font-weight: 600;\r\n      margin-bottom: 4px;\r\n    }\r\n    .block-label:hover {\r\n      text-decoration: underline;\r\n      color: ${colours.highlight};\r\n    }\r\n    .block-label:hover::after {\r\n      content: attr(data-selected);\r\n      position: absolute;\r\n      left: 0;\r\n      top: 100%;\r\n      background: ${colours.grey};\r\n      color: ${colours.greyText};\r\n      padding: 2px 6px;\r\n      border-radius: 0;\r\n      white-space: nowrap;\r\n      box-shadow: 0 2px 4px rgba(0,0,0,0.2);\r\n      transform: translateY(4px);\r\n      opacity: 0;\r\n      animation: fadeInBlockLabel 0.2s forwards;\r\n      pointer-events: none;\r\n      z-index: 10;\r\n    }\r\n    .block-label-display {\r\n      display: block;\r\n      margin-top: 4px;\r\n      font-size: 10px;\r\n      color: ${colours.greyText};\r\n      opacity: 0.7;\r\n      pointer-events: none;\r\n      user-select: none;\r\n    }\r\n    .option-bubble {\r\n      display: block;\r\n      background: ${colours.highlightNeutral};\r\n      color: ${colours.darkBlue};\r\n      padding: 4px 6px;\r\n      border-radius: 0;\r\n      cursor: pointer;\r\n      font-size: 11px;\r\n      transition: background-color 0.2s;\r\n      margin-bottom: 4px;\r\n    }\r\n    .option-bubble:hover {\r\n      transform: scale(1.05);\r\n      background: ${colours.blue};\r\n    }\r\n    .block-option-list {\r\n      display: inline-block;\r\n      background: ${colours.grey};\r\n      padding: 6px;\r\n      border-radius: 0;\r\n      vertical-align: baseline;\r\n      margin: 0 2px;\r\n    }\r\n    .block-option-list .block-label {\r\n      display: block;\r\n      font-size: 11px;\r\n      margin-bottom: 4px;\r\n      color: ${colours.greyText};\r\n    }\r\n    .option-choice {\r\n      background: ${colours.highlightNeutral};\r\n      color: ${colours.darkBlue};\r\n      padding: 2px 6px;\r\n      border-radius: 0;\r\n      cursor: pointer;\r\n      font-size: 11px;\r\n      transition: background-color 0.2s;\r\n    }\r\n    .option-choice:hover {\r\n      background: ${colours.blue};\r\n    }\r\n    .inline-options-callout {\r\n      border-radius: 0;\r\n      box-shadow: 0 4px 16px rgba(0,0,0,0.2);\r\n      animation: fadeInScale 0.2s ease forwards;\r\n      max-width: 280px;\r\n    }\r\n    .option-preview {\r\n      font-size: 11px;\r\n      padding: 0 4px;\r\n      margin-top: 2px;\r\n      display: block;\r\n      text-align: left;\r\n    }\r\n    .selected-block {\r\n      outline: 2px solid ${colours.cta};\r\n      outline-offset: -2px;\r\n    }\r\n    .block-container {\r\n      position: relative;\r\n      display: inline-block;\r\n      width: 100%;\r\n      overflow: hidden;\r\n    }\r\n    .block-main {\r\n      position: relative;\r\n      padding-right: 16px;\r\n    }\r\n    .block-sidebar {\r\n      position: absolute;\r\n      top: 0;\r\n      right: 0;\r\n      width: 260px;\r\n      height: 100%;\r\n      border: 1px solid ${colours.grey};\r\n      padding: 4px 4px 4px 20px;\r\n      border-radius: 0;\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 4px;\r\n      background: rgba(255,255,255,0.95);\r\n      transform: translateX(calc(100% - 11px));\r\n      transition: transform 0.2s ease;\r\n      pointer-events: none;\r\n      overflow: hidden;\r\n    }\r\n    .block-sidebar .sidebar-handle {\r\n      position: absolute;\r\n      top: 0;\r\n      left: -1px;\r\n      width: 12px;\r\n      height: 100%;\r\n      background: ${colours.grey};\r\n      color: #ffffff;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      cursor: pointer;\r\n      box-shadow: -2px 0 4px rgba(0,0,0,0.2);\r\n      border-radius: 4px 0 0 4px;\r\n      pointer-events: auto;\r\n    }\r\n    .block-container:hover .block-sidebar {\r\n      transform: translateX(0);\r\n      pointer-events: auto;\r\n    }\r\n    .block-container:hover,\r\n    .block-container.pinned {\r\n      overflow: visible;\r\n    }\r\n    .block-sidebar.pinned {\r\n      transform: translateX(0);\r\n      pointer-events: auto;\r\n    }\r\n    .block-sidebar .actions {\r\n      display: flex;\r\n      align-items: center;\r\n      gap: 6px;\r\n      margin-bottom: 4px;\r\n    }\r\n    .block-sidebar .icon-btn {\r\n      width: 28px;\r\n      height: 28px;\r\n      display: inline-flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      border-radius: 4px;\r\n      background: ${colours.grey};\r\n      color: ${colours.greyText};\r\n      cursor: pointer;\r\n      font-size: 16px;\r\n      user-select: none;\r\n      transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;\r\n    }\r\n    .block-sidebar .icon-btn:hover {\r\n      background: ${colours.blue};\r\n      color: #ffffff;\r\n      transform: scale(1.05);\r\n    }\r\n    .block-sidebar .icon-btn:active {\r\n      background: ${colours.darkBlue};\r\n      color: #ffffff;\r\n      transform: scale(0.95);\r\n    }\r\n    .block-sidebar .pin-toggle i {\r\n      transition: transform 0.2s ease;\r\n    }\r\n    .block-sidebar .pin-toggle.pinned i {\r\n      transform: rotate(45deg);\r\n    }\r\n    .block-sidebar .overlay-toggle.active {\r\n      background: ${colours.blue};\r\n      color: #ffffff;\r\n    }\r\n    .block-sidebar .option-choices {\r\n      display: flex;\r\n      flex-direction: column;\r\n      gap: 4px;\r\n    }\r\n    .block-container:hover .block-main,\r\n    .block-container.pinned .block-main {\r\n      margin-right: 260px;\r\n    }\r\n    body.sidebar-overlay .block-container:hover .block-main,\r\n    body.sidebar-overlay .block-container.pinned .block-main {\r\n      margin-right: 0;\r\n    }\r\n    body.sidebar-overlay .block-sidebar {\r\n      z-index: 1000;\r\n    }\r\n    .option-choice.selected {\r\n      background: ${colours.blue};\r\n      color: #ffffff;\r\n    }\r\n    .precise-edit {\r\n      background-color: ${colours.highlightBlue} !important;\r\n      color: ${colours.darkBlue} !important;\r\n      padding: 1px 2px;\r\n      border-radius: 2px;\r\n      font-weight: normal;\r\n    }\r\n    .has-edits {\r\n      background: linear-gradient(45deg, ${colours.highlightBlue}22 25%, transparent 25%), \r\n                  linear-gradient(-45deg, ${colours.highlightBlue}22 25%, transparent 25%), \r\n                  linear-gradient(45deg, transparent 75%, ${colours.highlightBlue}22 75%), \r\n                  linear-gradient(-45deg, transparent 75%, ${colours.highlightBlue}22 75%);\r\n      background-size: 4px 4px;\r\n      background-position: 0 0, 0 2px, 2px -2px, -2px 0px;\r\n    }\r\n    .block-edited {\r\n      background-color: ${colours.highlightNeutral} !important;\r\n      border-left: 3px solid ${colours.highlightBlue};\r\n    }\r\n    [data-sentence] {\r\n      display: inline;\r\n      margin: 0;\r\n    }\r\n    .sentence-controls {\r\n      display: inline-flex;\r\n      align-items: center;\r\n      gap: 2px;\r\n      margin-right: 4px;\r\n      vertical-align: middle;\r\n    }\r\n    .sentence-content {\r\n      display: inline;\r\n      margin: 0;\r\n    }\r\n  .insert-placeholder {\r\n    background: ${colours.highlightBlue}20;\r\n    color: ${colours.darkBlue};\r\n    padding: 1px 3px;\r\n    border-radius: 3px;\r\n    border: 1px dotted ${colours.darkBlue}60;\r\n    font-style: italic;\r\n    cursor: pointer;\r\n    transition: all 0.15s ease;\r\n    display: inline-block;\r\n    max-width: 100%;\r\n    word-wrap: break-word;\r\n    white-space: normal;\r\n    font-size: 0.9em;\r\n    opacity: 0.8;\r\n  }\r\n    .insert-placeholder:hover,\r\n    .insert-placeholder:focus {\r\n      background: ${colours.blue}40;\r\n      color: ${colours.darkBlue};\r\n      border-color: ${colours.blue};\r\n      box-shadow: 0 0 0 2px ${colours.blue}30;\r\n      transform: translateY(-1px);\r\n      outline: none;\r\n      opacity: 1;\r\n    }\r\n    [data-sentence] {\r\n      display: inline;\r\n      margin: 0;\r\n    }\r\n    .snippet-wrapper {\r\n      display: inline;\r\n      margin: 0;\r\n    }\r\n    .sentence-delete {\r\n      margin-right: 4px;\r\n      cursor: pointer;\r\n      user-select: none;\r\n      color: ${colours.red};\r\n      display: inline-flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      box-sizing: border-box;\r\n      background: rgba(255, 255, 255, 0.25);\r\n      border: 1px solid rgba(255, 255, 255, 0.3);\r\n      backdrop-filter: blur(4px);\r\n      border-radius: 0;\r\n      font-size: 12px;\r\n      line-height: 0;\r\n      padding: 0;\r\n      width: 20px;\r\n      min-width: 20px;\r\n      height: 20px;\r\n      min-height: 20px;\r\n      flex-shrink: 0;\r\n      transition: background-color 0.2s ease, color 0.2s ease;\r\n    }\r\n    .sentence-delete:hover {\r\n      background: rgba(255, 255, 255, 0.35);\r\n    }\r\n    .sentence-delete:active {\r\n      background: rgba(255, 255, 255, 0.45);\r\n      color: #ffffff;\r\n    }\r\n    .sentence-handle {\r\n      cursor: grab;\r\n      margin-right: 4px;\r\n      user-select: none;\r\n      color: ${colours.greyText};\r\n      display: inline-flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      box-sizing: border-box;\r\n      background: rgba(255, 255, 255, 0.25);\r\n      border: 1px solid rgba(255, 255, 255, 0.3);\r\n      backdrop-filter: blur(4px);\r\n      border-radius: 0;\r\n      font-size: 12px;\r\n      line-height: 0;\r\n      padding: 0;\r\n      width: 20px;\r\n      min-width: 20px;\r\n      height: 20px;\r\n      min-height: 20px;\r\n      flex-shrink: 0;\r\n      transition: background-color 0.2s ease, color 0.2s ease;\r\n    }\r\n    .sentence-handle:hover {\r\n      background: rgba(255, 255, 255, 0.35);\r\n    }\r\n    .sentence-handle:active {\r\n      cursor: grabbing;\r\n      background: rgba(255, 255, 255, 0.45);\r\n      color: #ffffff;\r\n    }\r\n    .sentence-handle i,\r\n    .sentence-delete i {\r\n      pointer-events: none;\r\n      transition: transform 0.1s ease;\r\n    }\r\n    .sentence-handle:hover i,\r\n    .sentence-delete:hover i {\r\n      transform: scale(1.1);\r\n    }\r\n    .drag-over {\r\n      outline: 2px dashed ${colours.blue};\r\n      background: ${colours.highlightBlue};\r\n      border-radius: 0;\r\n    }\r\n    @keyframes fadeInScale {\r\n      from { opacity: 0; transform: scale(0.95); }\r\n      to { opacity: 1; transform: scale(1); }\r\n    }\r\n    @keyframes fadeInBlockLabel {\r\n      from { opacity: 0; }\r\n      to { opacity: 1; }\r\n    }\r\n  `;\r\n  document.head.appendChild(style);\r\n}\r\n\r\nconst PitchBuilder: React.FC<PitchBuilderProps> = ({ enquiry, userData, showDealCapture = true }) => {\r\n  /**\r\n   * Ensure any raw passcode (api or fallback) is converted to a 5‑digit numeric string.\r\n   * Rules:\r\n   * 1. If already exactly 5 digits, keep.\r\n   * 2. Else if it contains >=5 digits anywhere, take first 5 digits.\r\n   * 3. Else derive deterministic 5‑digit from FNV-1a hash of (raw+seed).\r\n   */\r\n  function normalizePasscode(raw: string | undefined | null, seed?: string | number): string | null {\r\n    if (!raw) return null;\r\n    if (/^\\d{5}$/.test(raw)) return raw;\r\n    const digits = raw.replace(/\\D/g, '');\r\n    if (digits.length >= 5) return digits.slice(0, 5);\r\n    const source = `${raw}|${seed ?? ''}`;\r\n    let h = 2166136261 >>> 0; // FNV-1a 32-bit\r\n    for (let i = 0; i < source.length; i++) {\r\n      h = Math.imul(h ^ source.charCodeAt(i), 16777619) >>> 0;\r\n    }\r\n    const five = (h % 90000) + 10000; // 10000-99999\r\n    return String(five);\r\n  }\r\n  // Local helper: reveals value + copy on hover; shows only icon by default\r\n  const RevealCopyField: React.FC<{ iconName: string; value: string; color: string; label: string }> = ({ iconName, value, color, label }) => {\r\n    const [copied, setCopied] = useState(false);\r\n    const handleCopy = () => {\r\n      navigator.clipboard.writeText(value);\r\n      setCopied(true);\r\n      setTimeout(() => setCopied(false), 1200);\r\n    };\r\n    // Subtle tinted background for the icon square\r\n    const iconTint = color === '#3690CE' ? 'rgba(54,144,206,0.15)' : 'rgba(102,102,102,0.15)';\r\n    return (\r\n      <span aria-label={label} title={label} style={{ display: 'inline-flex', alignItems: 'center', marginRight: 8 }}>\r\n        {/* Icon square (left) */}\r\n        <span\r\n          style={{\r\n            width: 28,\r\n            height: 28,\r\n            minWidth: 28,\r\n            display: 'inline-flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            background: isDarkMode ? 'rgba(255,255,255,0.06)' : iconTint,\r\n            border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e4e8'}`,\r\n            borderRight: 'none', // join with tray\r\n            borderRadius: '6px 0 0 6px',\r\n          }}\r\n        >\r\n          <Icon iconName={iconName} styles={{ root: { color, fontSize: 14 } }} />\r\n        </span>\r\n        {/* Value tray (right) */}\r\n        <span\r\n          style={{\r\n            display: 'inline-flex',\r\n            alignItems: 'center',\r\n            gap: 6,\r\n            color: isDarkMode ? colours.dark.text : '#24292f',\r\n            background: isDarkMode ? colours.dark.inputBackground : '#f6f8fa',\r\n            border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e4e8'}`,\r\n            borderLeft: 'none', // join with icon square\r\n            borderRadius: '0 6px 6px 0',\r\n            height: 28,\r\n            padding: '0 8px',\r\n            fontSize: 13,\r\n            lineHeight: 1,\r\n            boxShadow: isDarkMode ? 'none' : '0 1px 3px rgba(0,0,0,0.04)',\r\n            userSelect: 'text',\r\n          }}\r\n        >\r\n          <span style={{ fontWeight: 500 }}>{value}</span>\r\n          <IconButton\r\n            iconProps={{ iconName: copied ? 'CheckMark' : 'Copy' }}\r\n            title={copied ? 'Copied!' : 'Copy'}\r\n            ariaLabel={copied ? 'Copied!' : 'Copy'}\r\n            onClick={handleCopy}\r\n            styles={{\r\n              root: {\r\n                borderRadius: 6,\r\n                height: 22,\r\n                width: 22,\r\n                minWidth: 22,\r\n                padding: 0,\r\n                background: 'transparent',\r\n              },\r\n              rootHovered: { background: isDarkMode ? 'rgba(255,255,255,0.06)' : '#e6f0fa' },\r\n              icon: { fontSize: 12, color: isDarkMode ? colours.dark.text : '#57606a' },\r\n            }}\r\n          />\r\n        </span>\r\n      </span>\r\n    );\r\n  };\r\n  // Admin/debug controls state\r\n  const [useNewData, setUseNewData] = useState<boolean>(false);\r\n  const [showDataInspector, setShowDataInspector] = useState(false);\r\n  const userRec: any = (userData && userData[0]) ? userData[0] : {};\r\n  const userRole: string = (userRec.Role || userRec.role || '').toString();\r\n  const userFullName: string = (\r\n    userRec.FullName ||\r\n    userRec['Full Name'] ||\r\n    [userRec.First, userRec.Last].filter(Boolean).join(' ')\r\n  )?.toString() || '';\r\n  const isAdmin = isAdminUser(userData?.[0] || null);\r\n  const isLocalhost = (typeof window !== 'undefined') && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');\r\n  // Initial Notes state\r\n  const [initialNotes, setInitialNotes] = useState<string>('');\r\n  const { isDarkMode } = useTheme();\r\n  const { setContent } = useNavigatorActions();\r\n  const userInitials = userData?.[0]?.Initials?.toUpperCase() || '';\r\n  // Prefer explicit email fields if present; fall back to constructed email from initials\r\n  const userEmailCandidate = (userData && userData[0]) || {} as any;\r\n  const userEmailAddress =\r\n    (userEmailCandidate.Email && String(userEmailCandidate.Email).trim()) ||\r\n    (userEmailCandidate.WorkEmail && String(userEmailCandidate.WorkEmail).trim()) ||\r\n    (userEmailCandidate.Mail && String(userEmailCandidate.Mail).trim()) ||\r\n    (userEmailCandidate.UserPrincipalName && String(userEmailCandidate.UserPrincipalName).trim()) ||\r\n    (userEmailCandidate['Email Address'] && String(userEmailCandidate['Email Address']).trim()) ||\r\n    (userInitials ? `${userInitials.toLowerCase()}@helix-law.com` : '');\r\n\r\n  // Pitch Builder-specific: fetch team data via new server route and derive effective user data\r\n  const [pitchUserData, setPitchUserData] = useState<UserData[] | null>(null);\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    const controller = new AbortController();\r\n    const init = async () => {\r\n      try {\r\n        const result = await safeFetchJson<UserData[]>(\r\n          '/api/pitch-team',\r\n          { signal: controller.signal }\r\n        );\r\n        if (!result.ok) return;\r\n        const all = Array.isArray(result.value) ? result.value : [];\r\n        if (!Array.isArray(all)) return;\r\n        const initials = (userData?.[0]?.Initials || '').toString().trim().toUpperCase();\r\n        const email = (typeof userEmailAddress === 'string' ? userEmailAddress : '').trim().toLowerCase();\r\n        const getFullName = (u: any) => (u?.FullName\r\n          || u?.['Full Name']\r\n          || [u?.First, u?.Last].filter(Boolean).join(' '))?.toString().trim();\r\n        const fullNameLocal = getFullName(userData?.[0] || {})\r\n          ?.toLowerCase().replace(/\\s+/g, ' ') || '';\r\n\r\n        // Try to find a matching record by Initials, then Email, then Full Name\r\n        const rec = all.find((r: any) => {\r\n          const rInitials = (r?.Initials || r?.initials || '').toString().trim().toUpperCase();\r\n          const rEmail = (r?.Email || r?.email || '').toString().trim().toLowerCase();\r\n          const rFullName = getFullName(r)?.toLowerCase().replace(/\\s+/g, ' ') || '';\r\n          return (\r\n            (!!initials && rInitials === initials) ||\r\n            (!!email && rEmail && rEmail === email) ||\r\n            (!!fullNameLocal && rFullName && rFullName === fullNameLocal)\r\n          );\r\n        });\r\n        if (!rec) {\r\n          // No direct match: still provide the server dataset so previews can use it (e.g., first item)\r\n          if (!cancelled) setPitchUserData(all);\r\n          return;\r\n        }\r\n        const current = (userData && userData[0]) || {};\r\n        const merged: Partial<UserData> & any = {\r\n          ...current,\r\n          Role: rec.Role ?? current.Role,\r\n          Rate: rec.Rate ?? current.Rate,\r\n          Initials: initials,\r\n          Email: rec.Email ?? current.Email,\r\n          First: current.First ?? rec.First,\r\n          Last: current.Last ?? rec.Last,\r\n          FullName: current.FullName ?? rec.FullName ?? `${rec.First ?? ''} ${rec.Last ?? ''}`.trim(),\r\n        };\r\n        if (!cancelled) setPitchUserData([merged as UserData]);\r\n      } catch (_) {\r\n        // Silent fallback to existing userData\r\n      }\r\n    };\r\n    init();\r\n    return () => {\r\n      cancelled = true;\r\n      controller.abort();\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [userInitials]);\r\n\r\n  const effectiveUserData = React.useMemo(() => {\r\n    if (pitchUserData && pitchUserData.length) {\r\n      // If merged single record provided, use it; otherwise prefer first server record\r\n      if (pitchUserData.length === 1) return pitchUserData;\r\n      return [pitchUserData[0]];\r\n    }\r\n    return userData;\r\n  }, [pitchUserData, userData]);\r\n  const usedPitchRoute = !!(pitchUserData && pitchUserData.length);\r\n\r\n  // Local fetch logging\r\n  const { apiCalls, clear: clearApiCalls } = useLocalFetchLogger(isLocalhost);\r\n  const [debugCollapsed, setDebugCollapsed] = useState<boolean>(true);\r\n\r\n  // (Fetch interception now handled by useLocalFetchLogger hook)\r\n\r\n  const [templateSet, setTemplateSet] = useState<TemplateSet>('Database');\r\n  const templateBlocks = useDynamicTemplateBlocks(templateSet);\r\n\r\n  // Qualifying question state - determines base template\r\n  const [qualifyingAnswer, setQualifyingAnswer] = useState<string>('');\r\n\r\n  // Ref for the body editor\r\n  const bodyEditorRef = useRef<HTMLDivElement>(null);\r\n  const [dragSentence, setDragSentence] = useState<HTMLElement | null>(null);\r\n  const [hiddenBlocks, setHiddenBlocks] = useState<{ [key: string]: boolean }>({});\r\n\r\n  // Only clear the body on the very first mount, not after scenario injection or async loads\r\n  const bodyHasBeenSeeded = useRef(false);\r\n\r\n  function handleTemplateSetChange(newSet: TemplateSet) {\r\n    setTemplateSet(newSet);\r\n    const loadBlocks = async (): Promise<TemplateBlock[]> => {\r\n      if (newSet === 'Database') {\r\n        const stored = sessionStorage.getItem('prefetchedBlocksData');\r\n        if (stored) {\r\n          try {\r\n            const parsed = JSON.parse(stored);\r\n            const compiled = compileBlocks(parsed);\r\n            setBlocks(compiled);\r\n            setSavedSnippets((parsed as any).savedSnippets || {});\r\n            sessionStorage.removeItem('prefetchedBlocksData');\r\n            return compiled;\r\n          } catch (e) {\r\n            console.error('Failed to parse prefetched blocks', e);\r\n          }\r\n        }\r\n        const fallbackData = getDatabaseBlocksData();\r\n        setBlocks(fallbackData.blocks);\r\n        setSavedSnippets(fallbackData.savedSnippets);\r\n        return fallbackData.blocks;\r\n      } else {\r\n        const result = getTemplateBlocks(newSet);\r\n        setBlocks(result);\r\n        return result;\r\n      }\r\n    };\r\n    setSelectedTemplateOptions({});\r\n    setInsertedBlocks({});\r\n    setAutoInsertedBlocks({});\r\n    setLockedBlocks({});\r\n    setPinnedBlocks({});\r\n    setEditedBlocks({});\r\n    setOriginalBlockContent({});\r\n    loadBlocks().then((newBlocks) => {\r\n      const blocksToUse = (newBlocks || getTemplateBlocks(newSet)).filter(\r\n        b => !hiddenBlocks[b.title]\r\n      );\r\n\r\n      // v1 templates should no longer auto select any blocks\r\n      // autoInsertDefaultBlocks(blocksToUse, newSet);\r\n    });\r\n  }\r\n\r\n  // Initial Scope options (formerly Service)\r\n  const SERVICE_OPTIONS: IDropdownOption[] = [\r\n    { key: 'Shareholder Dispute', text: 'Shareholder Dispute' },\r\n    { key: 'Debt Recovery', text: 'Debt Recovery' },\r\n    { key: 'Commercial Contract', text: 'Commercial Contract' },\r\n    { key: 'Other', text: 'Other (bespoke)' },\r\n  ];\r\n\r\n  const initialOption = SERVICE_OPTIONS.find(opt => opt.text === enquiry.Type_of_Work);\r\n  // Renamed: serviceDescription -> initialScopeDescription for clarity with new brief\r\n  const [initialScopeDescription, setInitialScopeDescription] = useState<string>(initialOption?.text || '');\r\n  const [selectedOption, setSelectedOption] = useState<IDropdownOption | undefined>(initialOption);\r\n  // Default estimated fee now set to 1,500 per request\r\n  const [amount, setAmount] = useState<string>('1500');\r\n  function handleAmountChange(val?: string) {\r\n    setAmount(val ?? '');\r\n  }\r\n  function handleAmountBlur() {\r\n    if (!amount) return;\r\n    const numeric = parseFloat(amount.replace(/[^0-9.]/g, ''));\r\n    if (!isNaN(numeric)) {\r\n      setAmount(numeric.toFixed(2));\r\n    }\r\n  }\r\n\r\n  function highlightBlock(\r\n    blockTitle: string,\r\n    highlight: boolean,\r\n    source?: 'editor' | 'template'\r\n  ) {\r\n    const isLocked = lockedBlocks[blockTitle];\r\n    const headerElement = document.getElementById(\r\n      `template-block-header-${blockTitle.replace(/\\s+/g, '-')}`\r\n    );\r\n    const baseScale = 0.03;\r\n    const hoveredScale = 1 + baseScale * 0.25; // 75% less\r\n    const otherScale = 1 + baseScale * 0.5; // 50% less\r\n    const defaultScale = 1 + baseScale;\r\n    let headerScale = 1;\r\n    let editorScale = 1;\r\n\r\n    if (highlight) {\r\n      if (source === 'editor') {\r\n        headerScale = otherScale;\r\n        editorScale = hoveredScale;\r\n      } else if (source === 'template') {\r\n        headerScale = hoveredScale;\r\n        editorScale = otherScale;\r\n      } else {\r\n        headerScale = defaultScale;\r\n        editorScale = defaultScale;\r\n      }\r\n    }\r\n\r\n    if (headerElement) {\r\n      const lockedBg = isDarkMode ? 'rgba(16,124,16,0.1)' : '#eafaea';\r\n      const blueBg = colours.highlightBlue;\r\n      headerElement.style.transition = 'background-color 0.2s, transform 0.2s, font-weight 0.2s';\r\n      let bg = 'transparent';\r\n\r\n      const isInserted =\r\n        insertedBlocks[blockTitle] ||\r\n        document.querySelector(`span[data-inserted=\"${blockTitle}\"]`);\r\n\r\n      if (highlight || isInserted) {\r\n        if (lockedBlocks[blockTitle]) {\r\n          bg = lockedBg;\r\n        } else if (highlight && !isInserted) {\r\n          bg = blueBg;\r\n        } else if (Object.values(editedSnippets[blockTitle] || {}).some(Boolean)) {\r\n          bg = blueBg;\r\n        } else {\r\n          bg = colours.highlightNeutral;\r\n        }\r\n      }\r\n      headerElement.style.backgroundColor = bg;\r\n      const active = highlight && !isLocked;\r\n      headerElement.style.fontWeight = active ? '600' : 'normal';\r\n      headerElement.style.transform = `scale(${headerScale})`;\r\n    }\r\n\r\n    const insertedSpans = document.querySelectorAll(`span[data-inserted=\"${blockTitle}\"]`);\r\n    insertedSpans.forEach((span) => {\r\n      if (!(span instanceof HTMLElement)) return;\r\n\r\n      // pull lockedBg into scope here\r\n      const lockedBg = isDarkMode ? 'rgba(16,124,16,0.1)' : '#eafaea';\r\n\r\n      span.style.transition = 'background-color 0.2s, outline 0.2s, transform 0.2s, font-weight 0.2s';\r\n      span.style.outline = highlight && !isLocked ? `1px dotted ${colours.cta}` : 'none';\r\n      span.style.borderRadius = '0px';\r\n      span.style.fontWeight = 'normal';\r\n      span.style.transform = `scale(${editorScale})`;\r\n\r\n      span.querySelectorAll('[data-snippet]').forEach((snip) => {\r\n        if (!(snip instanceof HTMLElement)) return;\r\n        const label = snip.getAttribute('data-snippet') || '';\r\n        let bg = colours.highlightNeutral;\r\n        if (lockedBlocks[blockTitle]) {\r\n          bg = lockedBg;\r\n        } else if (editedSnippets[blockTitle]?.[label]) {\r\n          bg = colours.highlightBlue;\r\n        }\r\n        snip.style.backgroundColor = bg;\r\n      });\r\n\r\n      // now lockedBg is in scope here\r\n      span.style.backgroundColor = lockedBlocks[blockTitle]\r\n        ? lockedBg\r\n        : colours.highlightNeutral;\r\n    });\r\n\r\n    const block = templateBlocks.find((b) => b.title === blockTitle);\r\n    if (block) {\r\n      const placeholders = document.querySelectorAll(\r\n        `span[data-placeholder=\"${escapeForSelector(block.placeholder)}\"]`\r\n      );\r\n      placeholders.forEach((ph) => {\r\n        if (ph instanceof HTMLElement) {\r\n          ph.style.transition = 'transform 0.2s, font-weight 0.2s';\r\n          ph.style.transform = `scale(${editorScale})`;\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  function toggleBlockLock(blockTitle: string) {\r\n    setLockedBlocks(prev => {\r\n      const locked = !prev[blockTitle];\r\n      const updated = { ...prev, [blockTitle]: locked };\r\n      const spans = bodyEditorRef.current?.querySelectorAll(\r\n        `span[data-inserted=\"${blockTitle}\"]`\r\n      ) as NodeListOf<HTMLElement> | null;\r\n      if (spans) {\r\n        const lockedBg = isDarkMode ? 'rgba(16,124,16,0.1)' : '#eafaea';\r\n        spans.forEach(span => {\r\n          span.setAttribute('contenteditable', (!locked).toString());\r\n          const icon = span.querySelector('.lock-toggle i') as HTMLElement | null;\r\n          if (icon) {\r\n            icon.className = `ms-Icon ms-Icon--${locked ? 'Lock' : 'Unlock'}`;\r\n          }\r\n        });\r\n        highlightBlock(blockTitle, false);\r\n      }\r\n      return updated;\r\n    });\r\n  }\r\n\r\n  function toggleBlockSidebar(blockTitle: string) {\r\n    const spans = bodyEditorRef.current?.querySelectorAll(\r\n      `span[data-inserted=\"${blockTitle}\"]`\r\n    ) as NodeListOf<HTMLElement> | null;\r\n    if (!spans) return;\r\n\r\n    const currentlyPinned = !!pinnedBlocks[blockTitle];\r\n    const newPinned = !currentlyPinned;\r\n\r\n    spans.forEach(span => {\r\n      const container = span as HTMLElement;\r\n      const sidebar = span.querySelector('.block-sidebar') as HTMLElement | null;\r\n      if (!sidebar) return;\r\n\r\n      if (newPinned) {\r\n        sidebar.classList.add('pinned');\r\n        container.classList.add('pinned');\r\n      } else {\r\n        sidebar.classList.remove('pinned');\r\n        container.classList.remove('pinned');\r\n      }\r\n\r\n      const icon = sidebar.querySelector('.pin-toggle i') as HTMLElement | null;\r\n      const pinBtn = sidebar.querySelector('.pin-toggle') as HTMLElement | null;\r\n      const handleIcon = sidebar.querySelector('.sidebar-handle i') as HTMLElement | null;\r\n      if (icon) {\r\n        icon.className = `ms-Icon ms-Icon--${newPinned ? 'Pinned' : 'Pin'}`;\r\n      }\r\n      if (handleIcon) {\r\n        handleIcon.className = `ms-Icon ms-Icon--${newPinned ? 'ChevronRight' : 'ChevronLeft'}`;\r\n      }\r\n      if (pinBtn) {\r\n        if (newPinned) pinBtn.classList.add('pinned');\r\n        else pinBtn.classList.remove('pinned');\r\n      }\r\n    });\r\n\r\n    setPinnedBlocks(prev => {\r\n      const updated = { ...prev, [blockTitle]: newPinned };\r\n      if (!newPinned) delete updated[blockTitle];\r\n      return updated;\r\n    });\r\n\r\n    if (bodyEditorRef.current) {\r\n      // Save current state before making changes (immediate, not debounced)\r\n      const currentContent = bodyEditorRef.current.innerHTML;\r\n      saveToUndoStackImmediate(currentContent);\r\n      setBodyInternal(bodyEditorRef.current.innerHTML);\r\n    }\r\n  }\r\n\r\n  function toggleSidebarOverlayMode() {\r\n    setOverlaySidebars((prev) => {\r\n      const newVal = !prev;\r\n      if (newVal) document.body.classList.add('sidebar-overlay');\r\n      else document.body.classList.remove('sidebar-overlay');\r\n      localStorage.setItem('sidebarOverlay', newVal ? 'true' : 'false');\r\n      const sidebars = bodyEditorRef.current?.querySelectorAll('.block-sidebar') as NodeListOf<HTMLElement> | null;\r\n      if (sidebars) {\r\n        sidebars.forEach((sb) => {\r\n          const toggle = sb.querySelector('.overlay-toggle') as HTMLElement | null;\r\n          const icon = toggle?.querySelector('i') as HTMLElement | null;\r\n          if (icon) {\r\n            icon.className = `ms-Icon ms-Icon--${newVal ? 'DockRight' : 'DockLeft'}`;\r\n          }\r\n          if (toggle) {\r\n            if (newVal) toggle.classList.add('active');\r\n            else toggle.classList.remove('active');\r\n          }\r\n        });\r\n      }\r\n      return newVal;\r\n    });\r\n  }\r\n\r\n  function openSnippetOptions(\r\n    e: MouseEvent,\r\n    blockTitle: string,\r\n    snippetLabel: string\r\n  ) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    if (lockedBlocks[blockTitle]) return;\r\n    const block = templateBlocks.find((b) => b.title === blockTitle);\r\n    if (block) {\r\n      setSnippetOptionsTarget(e.currentTarget as HTMLElement);\r\n      setSnippetOptionsBlock(block);\r\n      setSnippetOptionsLabel(snippetLabel);\r\n    }\r\n  }\r\n\r\n  function openSnippetEdit(e: MouseEvent, blockTitle: string) {\r\n    e.stopPropagation();\r\n    e.preventDefault();\r\n    if (lockedBlocks[blockTitle]) return;\r\n    setSnippetEdit({ blockTitle, target: e.currentTarget as HTMLElement });\r\n  }\r\n\r\n  function saveToUndoStack(content: string) {\r\n    if (isUndoRedoOperation) return;\r\n    if (!content || !content.trim()) return; // Don't save empty content\r\n\r\n    // Don't save duplicate content\r\n    if (undoStack.length > 0 && undoStack[undoStack.length - 1] === content) return;\r\n\r\n    setUndoStack(prev => {\r\n      const newStack = [...prev, content];\r\n      // Keep last 50 states (increased from 20)\r\n      return newStack.slice(-50);\r\n    });\r\n\r\n    // Clear redo stack when new action is performed\r\n    setRedoStack([]);\r\n  }\r\n\r\n  // Immediate save for block operations (not debounced)\r\n  function saveToUndoStackImmediate(content: string) {\r\n    if (isUndoRedoOperation) return;\r\n    if (!content || !content.trim()) return;\r\n\r\n    // Don't save duplicate content\r\n    if (undoStack.length > 0 && undoStack[undoStack.length - 1] === content) return;\r\n\r\n    // Cancel any pending debounced saves from input handler\r\n    if (inputTimeoutRef.current) {\r\n      clearTimeout(inputTimeoutRef.current);\r\n      inputTimeoutRef.current = null;\r\n    }\r\n\r\n    setUndoStack(prev => {\r\n      const newStack = [...prev, content];\r\n      return newStack.slice(-50);\r\n    });\r\n\r\n    setRedoStack([]);\r\n  }\r\n\r\n  function undo() {\r\n    if (undoStack.length <= 1) return; // Need at least 2 items to undo (current + previous)\r\n\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    const previousContent = undoStack[undoStack.length - 1];\r\n\r\n    setIsUndoRedoOperation(true);\r\n\r\n    // Save current state to redo stack\r\n    setRedoStack(prev => [...prev, currentContent]);\r\n\r\n    // Remove the last item from undo stack\r\n    setUndoStack(prev => prev.slice(0, -1));\r\n\r\n    // Update both DOM and React state\r\n    if (bodyEditorRef.current) {\r\n      bodyEditorRef.current.innerHTML = previousContent;\r\n    }\r\n    setBodyState(previousContent);\r\n\r\n    // Sync all related state\r\n    syncStateFromContent(previousContent);\r\n\r\n    // Clear the flag and trigger highlighting update\r\n    setTimeout(() => {\r\n      const { blocks, snippets } = computeSnippetChanges();\r\n      setEditedBlocks(blocks);\r\n      setEditedSnippets(snippets);\r\n      setIsUndoRedoOperation(false);\r\n    }, 50);\r\n  }\r\n\r\n  function redo() {\r\n    if (redoStack.length === 0) return;\r\n\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    const nextContent = redoStack[redoStack.length - 1];\r\n\r\n    setIsUndoRedoOperation(true);\r\n\r\n    // Save current state to undo stack\r\n    setUndoStack(prev => [...prev, currentContent]);\r\n\r\n    // Remove the last item from redo stack\r\n    setRedoStack(prev => prev.slice(0, -1));\r\n\r\n    // Update both DOM and React state\r\n    if (bodyEditorRef.current) {\r\n      bodyEditorRef.current.innerHTML = nextContent;\r\n    }\r\n    setBodyState(nextContent);\r\n\r\n    // Sync all related state\r\n    syncStateFromContent(nextContent);\r\n\r\n    // Clear the flag and trigger highlighting update\r\n    setTimeout(() => {\r\n      const { blocks, snippets } = computeSnippetChanges();\r\n      setEditedBlocks(blocks);\r\n      setEditedSnippets(snippets);\r\n      setIsUndoRedoOperation(false);\r\n    }, 50);\r\n  }\r\n\r\n  // Helper function to sync state from content\r\n  function syncStateFromContent(content: string) {\r\n    // Parse content to determine which blocks are inserted\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(content, 'text/html');\r\n    const insertedBlockElements = doc.querySelectorAll('[data-inserted]');\r\n\r\n    const newInsertedBlocks: { [key: string]: boolean } = {};\r\n    insertedBlockElements.forEach((el) => {\r\n      const blockTitle = el.getAttribute('data-inserted');\r\n      if (blockTitle) {\r\n        newInsertedBlocks[blockTitle] = true;\r\n      }\r\n    });\r\n\r\n    setInsertedBlocks(newInsertedBlocks);\r\n  }\r\n\r\n  function closeSnippetOptions() {\r\n    setSnippetOptionsBlock(null);\r\n    setSnippetOptionsTarget(null);\r\n    setSnippetOptionsLabel('');\r\n  }\r\n\r\n  function insertBlockOption(blockTitle: string, optionLabel: string) {\r\n    const block = templateBlocks.find((b) => b.title === blockTitle);\r\n    if (!block) return;\r\n    if (lockedBlocks[blockTitle]) return;\r\n\r\n    // Save current state before making changes (immediate, not debounced)\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    saveToUndoStackImmediate(currentContent);\r\n\r\n    if (block.isMultiSelect) {\r\n      const current = Array.isArray(selectedTemplateOptions[blockTitle])\r\n        ? ([...(selectedTemplateOptions[blockTitle] as string[])])\r\n        : [];\r\n      if (current.includes(optionLabel)) return;\r\n      const updated = [...current, optionLabel];\r\n      handleMultiSelectChange(blockTitle, updated);\r\n      if (insertedBlocks[blockTitle]) {\r\n        appendSnippetOption(block, optionLabel);\r\n      } else {\r\n        insertTemplateBlock(block, updated, true, false);\r\n      }\r\n      if (autoInsertedBlocks[blockTitle]) {\r\n        setAutoInsertedBlocks((prev) => ({ ...prev, [blockTitle]: false }));\r\n      }\r\n    } else {\r\n      if (selectedTemplateOptions[blockTitle] === optionLabel && insertedBlocks[blockTitle]) {\r\n        return;\r\n      }\r\n      handleSingleSelectChange(blockTitle, optionLabel);\r\n      if (insertedBlocks[blockTitle]) {\r\n        appendSnippetOption(block, optionLabel);\r\n      } else {\r\n        insertTemplateBlock(block, optionLabel, true);\r\n      }\r\n      if (autoInsertedBlocks[blockTitle]) {\r\n        setAutoInsertedBlocks((prev) => ({ ...prev, [blockTitle]: false }));\r\n      }\r\n    }\r\n  }\r\n\r\n  function resetBlockOption(blockTitle: string) {\r\n    const block = templateBlocks.find((b) => b.title === blockTitle);\r\n    if (!block) return;\r\n    if (lockedBlocks[blockTitle]) return;\r\n    const selected = selectedTemplateOptions[blockTitle];\r\n    if (!selected) return;\r\n\r\n    // Save current state before making changes (immediate, not debounced)\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    saveToUndoStackImmediate(currentContent);\r\n\r\n    insertTemplateBlock(block, selected, true, false);\r\n  }\r\n\r\n  useEffect(() => {\r\n    (window as any).toggleBlockLock = toggleBlockLock;\r\n    (window as any).toggleBlockSidebar = toggleBlockSidebar;\r\n    (window as any).highlightBlock = highlightBlock;\r\n    (window as any).openSnippetOptions = openSnippetOptions;\r\n    (window as any).openSnippetEdit = openSnippetEdit;\r\n    (window as any).insertBlockOption = insertBlockOption;\r\n    (window as any).resetBlockOption = resetBlockOption;\r\n    (window as any).saveCustomSnippet = saveCustomSnippet;\r\n    (window as any).toggleSidebarOverlayMode = toggleSidebarOverlayMode;\r\n    (window as any).undo = undo;\r\n    (window as any).redo = redo;\r\n    (window as any).removeBlock = (title: string) => {\r\n      const block = templateBlocks.find((b) => b.title === title);\r\n      if (block) handleClearBlock(block);\r\n    };\r\n\r\n    // Add keyboard shortcuts for undo/redo\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.ctrlKey || e.metaKey) {\r\n        if (e.key === 'z' && !e.shiftKey) {\r\n          e.preventDefault();\r\n          e.stopPropagation();\r\n          undo();\r\n        } else if ((e.key === 'y') || (e.key === 'z' && e.shiftKey)) {\r\n          e.preventDefault();\r\n          e.stopPropagation();\r\n          redo();\r\n        }\r\n      }\r\n    };\r\n\r\n    // Attach to document with capture=true to intercept before other handlers\r\n    document.addEventListener('keydown', handleKeyDown, true);\r\n    return () => {\r\n      document.removeEventListener('keydown', handleKeyDown, true);\r\n    };\r\n  }, [toggleBlockLock, toggleBlockSidebar, highlightBlock, openSnippetOptions, openSnippetEdit, insertBlockOption, resetBlockOption, toggleSidebarOverlayMode, templateBlocks, undo, redo]);\r\n\r\n  // Simple helper to capitalize your \"Area_of_Work\" for the subject line\r\n  function capitalizeWords(str: string): string {\r\n    return str\r\n      .toLowerCase()\r\n      .split(' ')\r\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\r\n      .join(' ');\r\n  }\r\n\r\n  const [blocks, setBlocks] = useState<TemplateBlock[]>([]);\r\n  const [savedSnippets, setSavedSnippets] = useState<{ [key: string]: string }>({});\r\n  const suppressSaveRef = useRef(false);\r\n\r\n  useEffect(() => {\r\n    const saved = localStorage.getItem('pitchBuilderState');\r\n    const shouldResume = localStorage.getItem('resumePitchBuilder') === 'true';\r\n    let initialSet: TemplateSet = 'Database';\r\n    if (saved) {\r\n      try {\r\n        const state = JSON.parse(saved);\r\n        if (state.enquiryId !== enquiry.ID) {\r\n          handleTemplateSetChange(initialSet);\r\n          return;\r\n        }\r\n        if (state.templateSet) {\r\n          setTemplateSet(state.templateSet);\r\n          initialSet = state.templateSet;\r\n        }\r\n        // Backward compatibility: migrate stored serviceDescription -> initialScopeDescription\r\n        if (state.serviceDescription && !state.initialScopeDescription) {\r\n          setInitialScopeDescription(state.serviceDescription);\r\n        }\r\n        if (state.initialScopeDescription) setInitialScopeDescription(state.initialScopeDescription);\r\n        if (state.selectedOption) setSelectedOption(state.selectedOption);\r\n        if (state.amount) setAmount(state.amount);\r\n        if (state.subject) setSubject(state.subject);\r\n        if (state.to) setTo(state.to);\r\n        if (state.cc) setCc(state.cc);\r\n        if (state.bcc) setBcc(state.bcc);\r\n        if (state.attachments) setAttachments(state.attachments);\r\n        if (state.followUp) setFollowUp(state.followUp);\r\n        if (state.activeTab) setActiveTab(state.activeTab);\r\n        if (state.selectedTemplateOptions) setSelectedTemplateOptions(state.selectedTemplateOptions);\r\n        if (state.insertedBlocks) setInsertedBlocks(state.insertedBlocks);\r\n        if (state.autoInsertedBlocks) setAutoInsertedBlocks(state.autoInsertedBlocks);\r\n        if (state.lockedBlocks) setLockedBlocks(state.lockedBlocks);\r\n        if (state.pinnedBlocks) setPinnedBlocks(state.pinnedBlocks);\r\n        if (state.editedBlocks) setEditedBlocks(state.editedBlocks);\r\n        if (state.editedSnippets) setEditedSnippets(state.editedSnippets);\r\n        if (state.originalBlockContent) setOriginalBlockContent(state.originalBlockContent);\r\n        if (state.originalSnippetContent) setOriginalSnippetContent(state.originalSnippetContent);\r\n        if (state.hiddenBlocks) setHiddenBlocks(state.hiddenBlocks);\r\n        if (state.blocks) setBlocks(state.blocks);\r\n        if (state.savedSnippets) setSavedSnippets(state.savedSnippets);\r\n        if (shouldResume && state.body) setBody(state.body);\r\n      } catch (e) {\r\n        console.error('Failed to parse saved pitch builder state', e);\r\n        initialSet = 'Database';\r\n      }\r\n    }\r\n    handleTemplateSetChange(initialSet);\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // Default subject\r\n  const [subject, setSubject] = useState<string>('Your Enquiry');\r\n\r\n  // Default recipient fields\r\n  const [to, setTo] = useState<string>(enquiry.Email || '');\r\n  const [cc, setCc] = useState<string>('');\r\n  const [bcc, setBcc] = useState<string>('');\r\n\r\n  // Extracted blocks (handled as qualifying sections above editor). They won't appear as placeholders inside the editor.\r\n  const EXTRACTED_BLOCKS: string[] = [\r\n    'Current Situation and Problem',\r\n    'Potential Causes of Action and Remedies',\r\n    'Scope of Work',\r\n    'Risk Assessment',\r\n    'Costs and Budget',\r\n    'Required Documents',\r\n    'Next Steps to Instruct Helix Law',\r\n    'Meeting Link',\r\n    'Closing Notes',\r\n    'Google Review'\r\n  ];\r\n\r\n  function generateBaseTemplate(blocks: TemplateBlock[]): string {\r\n    return `Dear [Enquiry.First_Name],\\n\\n${blocks\r\n      .filter(b => !EXTRACTED_BLOCKS.includes(b.title))\r\n      .map((b) => b.placeholder)\r\n      .join('\\n\\n')}\\n\\nKind Regards,<br>\\n\\n[First Name]<br>\\n\\n[Full Name]<br>\\n[Position]`;\r\n  }\r\n\r\n  const BASE_TEMPLATE = React.useMemo(\r\n    () => generateBaseTemplate(blocks),\r\n    [blocks]\r\n  );\r\n\r\n  function generateInitialBody(blocks: TemplateBlock[]): string {\r\n    const replaced = replacePlaceholders(\r\n      generateBaseTemplate(blocks),\r\n      '',\r\n      enquiry,\r\n      effectiveUserData,\r\n      blocks\r\n    );\r\n    const withInserts = wrapInsertPlaceholders(replaced);\r\n    return withInserts\r\n      .split('\\n')\r\n      .map((line) => line.trim())\r\n      .join('\\n');\r\n  }\r\n\r\n  function buildPlaceholder(block: TemplateBlock): string {\r\n    const options = block.options\r\n      .map((o) => {\r\n        const preview = cleanTemplateString(o.previewText).replace(/<p>/g, `<p style=\"margin: 0;\">`);\r\n        return `<div class=\"option-bubble\" data-block-title=\"${block.title}\" data-option-label=\"${o.label}\"><strong>${o.label}</strong><div class=\"option-preview\">${preview}</div></div>`;\r\n      })\r\n      .join('');\r\n    const saved = savedSnippets[block.title] || localStorage.getItem(`customSnippet_${block.title}`);\r\n    const savedHtml = saved\r\n      ? `<div class=\"option-bubble\" data-block-title=\"${block.title}\" data-option-label=\"__saved\"><strong>Saved Snippet</strong><div class=\"option-preview\">${saved}</div></div>`\r\n      : '';\r\n    const removeBtn = `<span class=\"remove-block\" data-block-title=\"${block.title}\" style=\"margin-left:4px;cursor:pointer;\">&times;</span>`;\r\n    return `<span data-placeholder=\"${block.placeholder}\" class=\"block-option-list\"><span class=\"block-label\" data-label-title=\"${block.title}\">${block.title}${removeBtn}</span>${options}${savedHtml}</span>`;\r\n  }\r\n\r\n  // State for extracted block selections and editable content\r\n  const [sectionSelections, setSectionSelections] = useState<Record<string, string[]>>({});\r\n  const [sectionContent, setSectionContent] = useState<Record<string, string>>({});\r\n  const [body, setBodyState] = useState<string>('');\r\n\r\n  function setBody(newBody: string | ((prevBody: string) => string)) {\r\n    const resolvedBody = typeof newBody === 'function' ? newBody(body) : newBody;\r\n    setBodyState(resolvedBody);\r\n\r\n    // Trigger change detection for precise highlighting\r\n    setTimeout(() => {\r\n      const { blocks, snippets } = computeSnippetChanges();\r\n      setEditedBlocks(blocks);\r\n      setEditedSnippets(snippets);\r\n    }, 100);\r\n  }\r\n\r\n  // Internal function for programmatic changes that shouldn't trigger undo saves\r\n  function setBodyInternal(newBody: string | ((prevBody: string) => string)) {\r\n    const resolvedBody = typeof newBody === 'function' ? newBody(body) : newBody;\r\n    setBodyState(resolvedBody);\r\n\r\n    // Trigger change detection for precise highlighting\r\n    setTimeout(() => {\r\n      const { blocks, snippets } = computeSnippetChanges();\r\n      setEditedBlocks(blocks);\r\n      setEditedSnippets(snippets);\r\n    }, 100);\r\n  }\r\n\r\n  // Create a React-compatible setState wrapper\r\n  const setBodyForComponents = (newBody: string | ((prevBody: string) => string)) => {\r\n    setBody(newBody);\r\n  };\r\n\r\n  // Only clear the body on the very first mount, not after scenario injection or async loads\r\n  useEffect(() => {\r\n    if (!bodyHasBeenSeeded.current && (!body || body.trim() === '')) {\r\n      setBody('');\r\n      if (bodyEditorRef.current) {\r\n        bodyEditorRef.current.innerHTML = '';\r\n      }\r\n      bodyHasBeenSeeded.current = true;\r\n    }\r\n  }, [body, setBody]);\r\n\r\n  // Disable automatic insertion of default blocks for v1\r\n  /*\r\n  useEffect(() => {\r\n    if (blocks.length > 0 && Object.keys(insertedBlocks).length === 0) {\r\n      autoInsertDefaultBlocks(blocks.filter(b => !hiddenBlocks[b.title]), templateSet);\r\n    }\r\n  }, [blocks]);\r\n  */\r\n\r\n  // Attachments, followUp, preview, error states, etc...\r\n  const [attachments, setAttachments] = useState<string[]>([]);\r\n  const [followUp, setFollowUp] = useState<string | undefined>(undefined);\r\n  const [isPreviewOpen, setIsPreviewOpen] = useState<boolean>(false);\r\n  const [isSuccessVisible, setIsSuccessVisible] = useState<boolean>(false);\r\n  const [isErrorVisible, setIsErrorVisible] = useState<boolean>(false);\r\n  const [errorMessage, setErrorMessage] = useState<string>('');\r\n\r\n  // **New State: Confirmation State for Draft Email Button**\r\n  const [isDraftConfirmed, setIsDraftConfirmed] = useState<boolean>(false);\r\n\r\n  const [toast, setToast] = useState<{\r\n    message: string;\r\n    type: 'success' | 'error' | 'info' | 'warning';\r\n    loading?: boolean;\r\n    details?: string;\r\n    progress?: number;\r\n    icon?: string;\r\n  } | null>(null);\r\n\r\n  const delay = (ms: number) => new Promise((res) => setTimeout(res, ms));\r\n\r\n  const showToast = (\r\n    msg: string,\r\n    type: 'success' | 'error' | 'info' | 'warning',\r\n    options?: {\r\n      loading?: boolean;\r\n      details?: string;\r\n      progress?: number;\r\n      icon?: string;\r\n      duration?: number;\r\n    }\r\n  ) => {\r\n    setToast({ \r\n      message: msg, \r\n      type, \r\n      loading: options?.loading,\r\n      details: options?.details,\r\n      progress: options?.progress,\r\n      icon: options?.icon\r\n    });\r\n    const duration = options?.duration ?? 3000;\r\n    if (duration > 0) {\r\n      setTimeout(() => setToast(null), duration);\r\n    }\r\n  };\r\n\r\n  // Tab state to switch between email details and deals\r\n  const [activeTab, setActiveTab] = useState<string>('details');\r\n\r\n  // IDs returned after saving a deal\r\n  const [dealId, setDealId] = useState<number | null>(null);\r\n  const [dealPasscode, setDealPasscode] = useState<string>('');\r\n  const [dealStatus, setDealStatus] = useState<'idle' | 'processing' | 'ready' | 'error'>('idle');\r\n  const [dealCreationInProgress, setDealCreationInProgress] = useState<boolean>(false);\r\n  const [clientIds, setClientIds] = useState<number[]>([]);\r\n  const [dealClients, setDealClients] = useState<ClientInfo[]>([]);\r\n  const [isMultiClientFlag, setIsMultiClientFlag] = useState<boolean>(false);\r\n  // Inline email send/draft status for confirmation modal\r\n  const [emailStatus, setEmailStatus] = useState<'idle' | 'processing' | 'sent' | 'error'>('idle');\r\n  const [emailMessage, setEmailMessage] = useState<string>('');\r\n\r\n\r\n  // Tracks selected template options for each block\r\n  const [selectedTemplateOptions, setSelectedTemplateOptions] = useState<{\r\n    [key: string]: string | string[];\r\n  }>({});\r\n\r\n  // Tracks which blocks have been inserted\r\n  const [insertedBlocks, setInsertedBlocks] = useState<{ [key: string]: boolean }>({});\r\n  const [autoInsertedBlocks, setAutoInsertedBlocks] = useState<{ [key: string]: boolean }>({});\r\n\r\n  const [lockedBlocks, setLockedBlocks] = useState<{ [key: string]: boolean }>({});\r\n\r\n  const [pinnedBlocks, setPinnedBlocks] = useState<{ [key: string]: boolean }>({});\r\n\r\n  const [overlaySidebars, setOverlaySidebars] = useState<boolean>(() =>\r\n    localStorage.getItem('sidebarOverlay') === 'true'\r\n  );\r\n\r\n  const [editedBlocks, setEditedBlocks] = useState<{ [key: string]: boolean }>({});\r\n  const [editedSnippets, setEditedSnippets] = useState<{\r\n    [key: string]: { [label: string]: boolean };\r\n  }>({});\r\n  const [originalBlockContent, setOriginalBlockContent] = useState<{ [key: string]: string }>({});\r\n  const [originalSnippetContent, setOriginalSnippetContent] = useState<{\r\n    [key: string]: { [label: string]: string };\r\n  }>({});\r\n  const [hoveredOption, setHoveredOption] = useState<string | null>(null);\r\n\r\n  // Undo/Redo functionality\r\n  const [undoStack, setUndoStack] = useState<string[]>([]);\r\n  const [redoStack, setRedoStack] = useState<string[]>([]);\r\n  const [isUndoRedoOperation, setIsUndoRedoOperation] = useState<boolean>(false);\r\n  const [undoInitialized, setUndoInitialized] = useState<boolean>(false);\r\n\r\n  // Navigator is now owned by Enquiries detail view; remove PitchBuilder-specific Navigator bar to avoid duplication.\r\n\r\n  // Initialize undo stack with initial body content (only once)\r\n  useEffect(() => {\r\n    if (!undoInitialized && body && body.trim()) {\r\n      const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n      setUndoStack([currentContent]);\r\n      setUndoInitialized(true);\r\n    }\r\n  }, [body, undoInitialized]);\r\n\r\n  // Enhanced edit tracking for precise highlighting\r\n  const [editedTextRanges, setEditedTextRanges] = useState<{\r\n    [blockTitle: string]: { [snippetLabel: string]: Array<{ start: number; end: number; text: string }> };\r\n  }>({});\r\n\r\n  useEffect(() => {\r\n    if (overlaySidebars) {\r\n      document.body.classList.add('sidebar-overlay');\r\n    } else {\r\n      document.body.classList.remove('sidebar-overlay');\r\n    }\r\n    const sidebars = bodyEditorRef.current?.querySelectorAll('.block-sidebar') as NodeListOf<HTMLElement> | null;\r\n    if (sidebars) {\r\n      sidebars.forEach((sb) => {\r\n        const toggle = sb.querySelector('.overlay-toggle') as HTMLElement | null;\r\n        const icon = toggle?.querySelector('i') as HTMLElement | null;\r\n        if (icon) {\r\n          icon.className = `ms-Icon ms-Icon--${overlaySidebars ? 'DockRight' : 'DockLeft'}`;\r\n        }\r\n        if (toggle) {\r\n          if (overlaySidebars) toggle.classList.add('active');\r\n          else toggle.classList.remove('active');\r\n        }\r\n      });\r\n    }\r\n  }, [overlaySidebars]);\r\n\r\n  // Placeholder editing popover state\r\n  const [placeholderEdit, setPlaceholderEdit] = useState<{\r\n    span: HTMLElement;\r\n    target: HTMLElement;\r\n    before: string;\r\n    after: string;\r\n    text: string;\r\n    placeholder: string;\r\n    blockTitle?: string;\r\n  } | null>(null);\r\n\r\n  const [snippetEdit, setSnippetEdit] = useState<{\r\n    blockTitle: string;\r\n    target: HTMLElement;\r\n    placeholder?: string;\r\n  } | null>(null);\r\n  const [pendingOptionText, setPendingOptionText] = useState<string>('');\r\n\r\n  function getNeighboringWords(span: HTMLElement, count: number = 3) {\r\n    const gather = (node: Node | null, words: string[], dir: 'prev' | 'next') => {\r\n      while (node && words.length < count) {\r\n        if (node.nodeType === Node.TEXT_NODE) {\r\n          const parts = (node.textContent || '')\r\n            .trim()\r\n            .split(/\\s+/)\r\n            .filter(Boolean);\r\n          if (dir === 'prev') {\r\n            for (let i = parts.length - 1; i >= 0 && words.length < count; i--) {\r\n              words.unshift(parts[i]);\r\n            }\r\n          } else {\r\n            for (let i = 0; i < parts.length && words.length < count; i++) {\r\n              words.push(parts[i]);\r\n            }\r\n          }\r\n        }\r\n        node = dir === 'prev' ? node.previousSibling : node.nextSibling;\r\n      }\r\n    };\r\n\r\n    const before: string[] = [];\r\n    const after: string[] = [];\r\n    gather(span.previousSibling, before, 'prev');\r\n    gather(span.nextSibling, after, 'next');\r\n    return {\r\n      before: before.slice(-count).join(' '),\r\n      after: after.slice(0, count).join(' '),\r\n    };\r\n  }\r\n\r\n  const [snippetOptionsBlock, setSnippetOptionsBlock] = useState<TemplateBlock | null>(null);\r\n  const [snippetOptionsLabel, setSnippetOptionsLabel] = useState<string>('');\r\n  const [snippetOptionsTarget, setSnippetOptionsTarget] = useState<HTMLElement | null>(null);\r\n  const [removeConfirm, setRemoveConfirm] = useState<{\r\n    block: TemplateBlock;\r\n    option?: string;\r\n    target: HTMLElement | null;\r\n    point: IPoint | null;\r\n  } | null>(null);\r\n\r\n  useEffect(() => {\r\n    templateBlocks.forEach((block) => {\r\n      highlightBlock(block.title, false);\r\n    });\r\n  }, [insertedBlocks, lockedBlocks, editedBlocks, isDarkMode, body]);\r\n\r\n  // For the body editor\r\n  const savedSelection = useRef<Range | null>(null);\r\n  const inputTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  useEffect(() => {\r\n    const editor = bodyEditorRef.current;\r\n    if (!editor) return;\r\n    const handleClick = (e: MouseEvent) => {\r\n      const target = e.target as HTMLElement;\r\n\r\n      const remove = (target as HTMLElement).closest('.remove-block');\r\n      if (remove) {\r\n        const blockTitle = remove.getAttribute('data-block-title');\r\n        if (blockTitle && !lockedBlocks[blockTitle]) hideTemplateBlock(blockTitle);\r\n        return;\r\n      }\r\n\r\n      const del = (target as HTMLElement).closest('.sentence-delete');\r\n      if (del) {\r\n        const sentence = del.closest('[data-sentence]');\r\n        const blockSpan = sentence?.closest('[data-inserted]') as HTMLElement | null;\r\n        if (blockSpan && lockedBlocks[blockSpan.getAttribute('data-inserted') || '']) return;\r\n        if (sentence && editor.contains(sentence)) {\r\n          // Save current state before making changes (immediate, not debounced)\r\n          const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n          saveToUndoStackImmediate(currentContent);\r\n\r\n          sentence.remove();\r\n          setBodyInternal(editor.innerHTML);\r\n        }\r\n        return;\r\n      }\r\n\r\n      const bubble = (target as HTMLElement).closest('.option-bubble');\r\n      if (bubble) {\r\n        const blockTitle = bubble.getAttribute('data-block-title');\r\n        const optionLabel = bubble.getAttribute('data-option-label');\r\n        if (blockTitle && optionLabel) {\r\n          if (lockedBlocks[blockTitle]) return;\r\n          const block = templateBlocks.find((b) => b.title === blockTitle);\r\n          if (!block) return;\r\n          const isSelected = block.isMultiSelect\r\n            ? Array.isArray(selectedTemplateOptions[blockTitle]) &&\r\n            (selectedTemplateOptions[blockTitle] as string[]).includes(optionLabel)\r\n            : selectedTemplateOptions[blockTitle] === optionLabel;\r\n          if (isSelected) {\r\n            if (Object.values(editedSnippets[blockTitle] || {}).some(Boolean)) {\r\n              const rect = (bubble as HTMLElement).getBoundingClientRect();\r\n              setRemoveConfirm({\r\n                block,\r\n                option: optionLabel,\r\n                target: bubble as HTMLElement,\r\n                point: { x: rect.left + rect.width / 2, y: rect.bottom },\r\n              });\r\n            } else {\r\n              removeBlockOption(block, optionLabel);\r\n            }\r\n          } else {\r\n            insertBlockOption(blockTitle, optionLabel);\r\n          }\r\n          return;\r\n        }\r\n      }\r\n\r\n      const choice = (target as HTMLElement).closest('.option-choice');\r\n      if (choice) {\r\n        const blockTitle = choice.getAttribute('data-block-title');\r\n        const optionLabel = choice.getAttribute('data-option-label');\r\n        if (blockTitle && optionLabel) {\r\n          if (lockedBlocks[blockTitle]) return;\r\n          if (choice.classList.contains('reset-option')) {\r\n            resetBlockOption(blockTitle);\r\n            return;\r\n          }\r\n          const block = templateBlocks.find((b) => b.title === blockTitle);\r\n          if (!block) return;\r\n          const isSelected = block.isMultiSelect\r\n            ? Array.isArray(selectedTemplateOptions[blockTitle]) &&\r\n            (selectedTemplateOptions[blockTitle] as string[]).includes(optionLabel)\r\n            : selectedTemplateOptions[blockTitle] === optionLabel;\r\n          if (isSelected) {\r\n            if (Object.values(editedSnippets[blockTitle] || {}).some(Boolean)) {\r\n              const rect = (choice as HTMLElement).getBoundingClientRect();\r\n              setRemoveConfirm({\r\n                block,\r\n                option: optionLabel,\r\n                target: choice as HTMLElement,\r\n                point: { x: rect.left + rect.width / 2, y: rect.bottom },\r\n              });\r\n            } else {\r\n              removeBlockOption(block, optionLabel);\r\n            }\r\n          } else {\r\n            insertBlockOption(blockTitle, optionLabel);\r\n          }\r\n          return;\r\n        }\r\n      }\r\n    };\r\n    editor.addEventListener('click', handleClick);\r\n    return () => editor.removeEventListener('click', handleClick);\r\n  }, [insertBlockOption, resetBlockOption, hideTemplateBlock]);\r\n\r\n  useEffect(() => {\r\n    const editor = bodyEditorRef.current;\r\n    if (!editor) return;\r\n\r\n    const handleDragStart = (e: DragEvent) => {\r\n      const handle = (e.target as HTMLElement).closest('.sentence-handle');\r\n      if (!handle) return;\r\n      const blockSpan = handle.closest('[data-inserted]') as HTMLElement | null;\r\n      if (blockSpan && lockedBlocks[blockSpan.getAttribute('data-inserted') || '']) {\r\n        e.preventDefault();\r\n        return;\r\n      }\r\n      const target = handle.parentElement as HTMLElement | null;\r\n      if (target) {\r\n        setDragSentence(target);\r\n        e.dataTransfer?.setData('text/plain', '');\r\n      }\r\n    };\r\n\r\n    const handleDragOver = (e: DragEvent) => {\r\n      const target = (e.target as HTMLElement).closest('[data-sentence]');\r\n      const blockSpan = target?.closest('[data-inserted]') as HTMLElement | null;\r\n      if (blockSpan && lockedBlocks[blockSpan.getAttribute('data-inserted') || '']) {\r\n        return;\r\n      }\r\n      if (target && dragSentence) {\r\n        e.preventDefault();\r\n        target.classList.add('drag-over');\r\n      }\r\n    };\r\n\r\n    const handleDragLeave = (e: DragEvent) => {\r\n      const target = (e.target as HTMLElement).closest('[data-sentence]');\r\n      if (target) {\r\n        target.classList.remove('drag-over');\r\n      }\r\n    };\r\n\r\n    const handleDrop = (e: DragEvent) => {\r\n      const target = (e.target as HTMLElement).closest('[data-sentence]') as HTMLElement | null;\r\n      const blockSpan = target?.closest('[data-inserted]') as HTMLElement | null;\r\n      if (blockSpan && lockedBlocks[blockSpan.getAttribute('data-inserted') || '']) {\r\n        target && target.classList.remove('drag-over');\r\n        setDragSentence(null);\r\n        return;\r\n      }\r\n      if (target && dragSentence && target !== dragSentence) {\r\n        e.preventDefault();\r\n        const parent = target.parentElement;\r\n        if (parent && parent === dragSentence.parentElement) {\r\n          // Save current state before making changes (immediate, not debounced)\r\n          const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n          saveToUndoStackImmediate(currentContent);\r\n\r\n          const before = e.clientY < target.getBoundingClientRect().top + target.offsetHeight / 2;\r\n          if (before) {\r\n            parent.insertBefore(dragSentence, target);\r\n          } else {\r\n            parent.insertBefore(dragSentence, target.nextSibling);\r\n          }\r\n          dragSentence.classList.add('drop-in');\r\n          setTimeout(() => dragSentence.classList.remove('drop-in'), 300);\r\n          setBodyInternal(editor.innerHTML);\r\n        }\r\n      }\r\n      target && target.classList.remove('drag-over');\r\n      setDragSentence(null);\r\n    };\r\n\r\n    editor.addEventListener('dragstart', handleDragStart);\r\n    editor.addEventListener('dragover', handleDragOver);\r\n    editor.addEventListener('dragleave', handleDragLeave);\r\n    editor.addEventListener('drop', handleDrop);\r\n    return () => {\r\n      editor.removeEventListener('dragstart', handleDragStart);\r\n      editor.removeEventListener('dragover', handleDragOver);\r\n      editor.removeEventListener('dragleave', handleDragLeave);\r\n      editor.removeEventListener('drop', handleDrop);\r\n    };\r\n  }, [dragSentence]);\r\n\r\n  useEffect(() => {\r\n    const editor = bodyEditorRef.current;\r\n    if (!editor) return;\r\n\r\n    const openPlaceholderEditor = (ph: HTMLElement) => {\r\n      const { before, after } = getNeighboringWords(ph);\r\n      const blockEl = ph.closest('[data-block-title]') as HTMLElement | null;\r\n      const blockTitle = blockEl?.getAttribute('data-block-title') || undefined;\r\n      const placeholderText = ph.textContent || '';\r\n      const placeholderAttr = ph.getAttribute('data-placeholder') || '';\r\n      setPlaceholderEdit({\r\n        span: ph,\r\n        target: ph,\r\n        before,\r\n        after,\r\n        text: placeholderText,\r\n        placeholder: placeholderAttr,\r\n        blockTitle,\r\n      });\r\n    };\r\n\r\n    const handleInput = (e: Event) => {\r\n      // Capture the current DOM content and save it to undo stack BEFORE React state updates\r\n      const currentDOMContent = editor.innerHTML;\r\n\r\n      // Save to undo stack (debounced) - this captures the state BEFORE the input change\r\n      if (!isUndoRedoOperation && body && body.trim() && currentDOMContent !== body) {\r\n        if (inputTimeoutRef.current) {\r\n          clearTimeout(inputTimeoutRef.current);\r\n        }\r\n\r\n        inputTimeoutRef.current = setTimeout(() => {\r\n          saveToUndoStack(body); // Save the React state (which is the previous state)\r\n        }, 300); // Shorter debounce for better responsiveness\r\n      }\r\n\r\n      // Update body state immediately to reflect the change\r\n      setBodyState(currentDOMContent);\r\n\r\n      // Trigger precise highlighting detection (debounced)\r\n      setTimeout(() => {\r\n        const { blocks, snippets } = computeSnippetChanges();\r\n        setEditedBlocks(blocks);\r\n        setEditedSnippets(snippets);\r\n      }, 100);\r\n    };\r\n\r\n    const handleDblClick = (e: MouseEvent) => {\r\n      const ph = (e.target as HTMLElement).closest('.insert-placeholder') as HTMLElement | null;\r\n      if (ph) {\r\n        e.preventDefault();\r\n        openPlaceholderEditor(ph);\r\n      }\r\n    };\r\n\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === 'Enter') {\r\n        const ph = (e.target as HTMLElement).closest('.insert-placeholder') as HTMLElement | null;\r\n        if (ph) {\r\n          e.preventDefault();\r\n          openPlaceholderEditor(ph);\r\n        }\r\n      }\r\n    };\r\n\r\n    editor.addEventListener('input', handleInput);\r\n    editor.addEventListener('dblclick', handleDblClick);\r\n    editor.addEventListener('keydown', handleKeyDown, true);\r\n    return () => {\r\n      editor.removeEventListener('input', handleInput);\r\n      editor.removeEventListener('dblclick', handleDblClick);\r\n      editor.removeEventListener('keydown', handleKeyDown, true);\r\n    };\r\n  }, [body, isUndoRedoOperation]);\r\n\r\n  /**\r\n   * Save the user's cursor selection in the contentEditable, so we can insert text at that exact spot.\r\n   */\r\n  function saveSelection() {\r\n    const sel = window.getSelection();\r\n    if (sel && sel.rangeCount > 0) {\r\n      savedSelection.current = sel.getRangeAt(0).cloneRange();\r\n    }\r\n  }\r\n\r\n  function restoreSelection() {\r\n    const sel = window.getSelection();\r\n    if (sel && savedSelection.current) {\r\n      sel.removeAllRanges();\r\n      sel.addRange(savedSelection.current);\r\n    }\r\n  }\r\n\r\n  function isSelectionInsideEditor(): boolean {\r\n    const sel = window.getSelection();\r\n    if (!sel || sel.rangeCount === 0) return false;\r\n    let node = sel.getRangeAt(0).commonAncestorContainer;\r\n    if (node.nodeType === Node.TEXT_NODE) {\r\n      node = node.parentNode!;\r\n    }\r\n    return bodyEditorRef.current?.contains(node) || false;\r\n  }\r\n\r\n  function normalizeHtml(html: string): string {\r\n    const div = document.createElement('div');\r\n    div.innerHTML = html;\r\n    return (div.textContent || '').replace(/\\s+/g, ' ').trim();\r\n  }\r\n\r\n  function isContentChanged(current: string, original: string): boolean {\r\n    const clean = (html: string) =>\r\n      html.replace(/<span class=\"lock-toggle\"[^>]*>.*?<\\/span>/, '');\r\n    return normalizeHtml(clean(current)) !== normalizeHtml(clean(original));\r\n  }\r\n\r\n  function detectTextEdits(blockTitle: string, snippetLabel: string, currentText: string, originalText: string) {\r\n    if (currentText === originalText) return [];\r\n\r\n    const edits: Array<{ start: number; end: number; text: string }> = [];\r\n\r\n    // Simple diff algorithm to find edited portions\r\n    const currentWords = currentText.split(/\\s+/);\r\n    const originalWords = originalText.split(/\\s+/);\r\n\r\n    let currentIndex = 0;\r\n    let originalIndex = 0;\r\n\r\n    while (currentIndex < currentWords.length || originalIndex < originalWords.length) {\r\n      if (currentIndex < currentWords.length && originalIndex < originalWords.length) {\r\n        if (currentWords[currentIndex] === originalWords[originalIndex]) {\r\n          currentIndex++;\r\n          originalIndex++;\r\n        } else {\r\n          // Found a difference - track the edit\r\n          const startIdx = currentIndex;\r\n          while (currentIndex < currentWords.length && originalIndex < originalWords.length &&\r\n            currentWords[currentIndex] !== originalWords[originalIndex]) {\r\n            currentIndex++;\r\n            originalIndex++;\r\n          }\r\n\r\n          const editedText = currentWords.slice(startIdx, currentIndex).join(' ');\r\n          edits.push({\r\n            start: startIdx,\r\n            end: currentIndex,\r\n            text: editedText\r\n          });\r\n        }\r\n      } else if (currentIndex < currentWords.length) {\r\n        // Addition\r\n        const editedText = currentWords.slice(currentIndex).join(' ');\r\n        edits.push({\r\n          start: currentIndex,\r\n          end: currentWords.length,\r\n          text: editedText\r\n        });\r\n        break;\r\n      } else {\r\n        // Deletion - handled by the original being longer\r\n        break;\r\n      }\r\n    }\r\n\r\n    return edits;\r\n  }\r\n\r\n  function highlightEditedText(element: HTMLElement, edits: Array<{ start: number; end: number; text: string }>) {\r\n    // Don't modify the HTML to avoid cursor jumping - just mark as edited\r\n    if (edits.length === 0) return;\r\n    element.classList.add('has-edits');\r\n  }\r\n\r\n  function computeSnippetChanges() {\r\n    if (!bodyEditorRef.current) return { blocks: {}, snippets: {} };\r\n    const updatedBlocks: { [key: string]: boolean } = {};\r\n    const updatedSnippets: { [key: string]: { [label: string]: boolean } } = {};\r\n    const updatedEditRanges: { [blockTitle: string]: { [snippetLabel: string]: Array<{ start: number; end: number; text: string }> } } = {};\r\n\r\n    const lockedBg = isDarkMode ? 'rgba(16,124,16,0.1)' : '#eafaea';\r\n    const editedBlockBg = isDarkMode ? 'rgba(70,130,180,0.15)' : '#e8f4fd'; // New color for edited blocks\r\n\r\n    Object.keys(insertedBlocks).forEach((title) => {\r\n      if (!insertedBlocks[title]) return;\r\n      const span = bodyEditorRef.current!.querySelector(\r\n        `span[data-inserted=\"${title}\"]`\r\n      ) as HTMLElement | null;\r\n      if (!span) return;\r\n\r\n      const snippetEls = Array.from(\r\n        span.querySelectorAll('[data-snippet]')\r\n      ) as HTMLElement[];\r\n\r\n      let blockHasEdits = false;\r\n\r\n      snippetEls.forEach((el) => {\r\n        const label = el.getAttribute('data-snippet') || '';\r\n        const original = originalSnippetContent[title]?.[label];\r\n        if (original === undefined) return;\r\n\r\n        const currentText = el.textContent || '';\r\n        const originalText = new DOMParser().parseFromString(original, 'text/html').body.textContent || '';\r\n        const changed = currentText !== originalText;\r\n\r\n        if (!updatedSnippets[title]) updatedSnippets[title] = {};\r\n        updatedSnippets[title][label] = changed;\r\n\r\n        if (changed) {\r\n          blockHasEdits = true;\r\n          updatedBlocks[title] = true;\r\n\r\n          // Detect precise edits\r\n          const edits = detectTextEdits(title, label, currentText, originalText);\r\n          if (!updatedEditRanges[title]) updatedEditRanges[title] = {};\r\n          updatedEditRanges[title][label] = edits;\r\n\r\n          // Apply precise highlighting\r\n          highlightEditedText(el, edits);\r\n        }\r\n\r\n        // Update snippet background - different colors for different states\r\n        let snippetBg = colours.highlightNeutral; // Default unedited block\r\n        if (lockedBlocks[title]) {\r\n          snippetBg = lockedBg;\r\n        } else if (changed) {\r\n          snippetBg = editedBlockBg; // Edited block background\r\n          el.classList.add('has-edits');\r\n        } else if (autoInsertedBlocks[title]) {\r\n          snippetBg = colours.highlightNeutral;\r\n          el.classList.remove('has-edits');\r\n        } else {\r\n          el.classList.remove('has-edits');\r\n        }\r\n\r\n        el.style.backgroundColor = snippetBg;\r\n      });\r\n\r\n      // Update header with new edited state color\r\n      const headerElement = document.getElementById(\r\n        `template-block-header-${title.replace(/\\s+/g, '-')}`\r\n      );\r\n      if (headerElement) {\r\n        let bg = 'transparent';\r\n        if (lockedBlocks[title]) {\r\n          bg = lockedBg;\r\n        } else if (blockHasEdits) {\r\n          bg = editedBlockBg; // New edited state color\r\n        } else if (insertedBlocks[title]) {\r\n          bg = colours.highlightNeutral;\r\n        }\r\n        headerElement.style.backgroundColor = bg;\r\n      }\r\n\r\n      // Update block container background\r\n      span.style.backgroundColor = lockedBlocks[title]\r\n        ? lockedBg\r\n        : blockHasEdits\r\n          ? editedBlockBg\r\n          : colours.highlightNeutral;\r\n\r\n      const optionDiv = span.querySelector('div.option-choices') as HTMLElement | null;\r\n      if (optionDiv) {\r\n        if (blockHasEdits) {\r\n          optionDiv.style.pointerEvents = 'none';\r\n          optionDiv.style.opacity = '0.5';\r\n        } else {\r\n          optionDiv.style.pointerEvents = '';\r\n          optionDiv.style.opacity = '';\r\n        }\r\n      }\r\n\r\n      if (!updatedBlocks[title]) updatedBlocks[title] = false;\r\n    });\r\n\r\n    // Update the edit ranges state\r\n    setEditedTextRanges(updatedEditRanges);\r\n\r\n    return { blocks: updatedBlocks, snippets: updatedSnippets };\r\n  }\r\n\r\n  /**\r\n   * Insert some HTML at the cursor. If there's no selection, we append at the end.\r\n   */\r\n  function insertAtCursor(html: string) {\r\n    // Save current state before making changes (immediate, not debounced)\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    saveToUndoStackImmediate(currentContent);\r\n\r\n    if (!isSelectionInsideEditor()) {\r\n      setBodyInternal(body + `\\n\\n${html}`);\r\n      return;\r\n    }\r\n\r\n    restoreSelection();\r\n    const sel = window.getSelection();\r\n    if (sel && sel.rangeCount > 0) {\r\n      const range = sel.getRangeAt(0);\r\n      range.deleteContents();\r\n\r\n      const tempDiv = document.createElement('div');\r\n      tempDiv.innerHTML = html;\r\n      const fragment = document.createDocumentFragment();\r\n      let node: ChildNode | null;\r\n      while ((node = tempDiv.firstChild)) {\r\n        fragment.appendChild(node);\r\n      }\r\n      range.insertNode(fragment);\r\n\r\n      range.collapse(false);\r\n      sel.removeAllRanges();\r\n      sel.addRange(range);\r\n\r\n      saveSelection();\r\n\r\n      if (bodyEditorRef.current) {\r\n        setBodyInternal(bodyEditorRef.current.innerHTML);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Insert a single template option's preview text at the current cursor\r\n   * position, without wrapping it in block controls.\r\n   */\r\n  function insertOptionAtCursor(block: TemplateBlock, optionLabel: string) {\r\n    const option = block.options.find((o) => o.label === optionLabel);\r\n    if (!option) return;\r\n    let html = option.previewText.trim().replace(/\\n/g, '<br />');\r\n    html = applyDynamicSubstitutions(\r\n      html,\r\n      effectiveUserData,\r\n      enquiry,\r\n      amount,\r\n      dealPasscode,\r\n      undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n    );\r\n    insertAtCursor(html);\r\n  }\r\n\r\n  /**\r\n   * Insert a template block's text (either single or multiSelect) at the corresponding placeholder <span>.\r\n   */\r\n  function insertTemplateBlock(\r\n    block: TemplateBlock,\r\n    selectedOption: string | string[],\r\n    shouldFocus: boolean = true,\r\n    append: boolean = false\r\n  ) {\r\n    const snippetHtml: string[] = [];\r\n    const snippetMap: { [label: string]: string } = {};\r\n    if (block.isMultiSelect && isStringArray(selectedOption)) {\r\n      selectedOption.forEach((opt) => {\r\n        let text: string | null = null;\r\n        let optObj: TemplateOption | undefined;\r\n        if (opt === '__saved') {\r\n          text = savedSnippets[block.title] || localStorage.getItem(`customSnippet_${block.title}`);\r\n        } else {\r\n          optObj = block.options.find((o) => o.label === opt);\r\n          if (!optObj) return;\r\n          text = optObj.previewText.trim().replace(/\\n/g, '<br />');\r\n        }\r\n        if (text === null) return;\r\n        text = applyDynamicSubstitutions(\r\n          text,\r\n          effectiveUserData,\r\n          enquiry,\r\n          amount,\r\n          dealPasscode,\r\n          undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n        );\r\n        text = cleanTemplateString(text).replace(/<p>/g, `<p style=\"margin: 0;\">`);\r\n        text = wrapInsertPlaceholders(text);\r\n        const escLabel = opt.replace(/'/g, \"&#39;\");\r\n        // grab the ID if there is one\r\n        const idAttr = optObj?.snippetId ? ` data-snippet-id=\"${optObj.snippetId}\"` : '';\r\n        const sentences = text\r\n          .split(/(?<=[.!?])\\s+/)\r\n          .filter((s) => s.trim().length > 0)\r\n          .map(s => {\r\n            const trimmed = s.trim();\r\n            return `<span data-sentence contenteditable=\"true\"><span class=\"sentence-controls\"><span class=\"sentence-handle\" draggable=\"true\" contenteditable=\"false\"><i class=\"ms-Icon ms-Icon--GripperDotsVertical\" aria-hidden=\"true\"></i></span><span class=\"sentence-delete\" contenteditable=\"false\"><i class=\"ms-Icon ms-Icon--Cancel\" aria-hidden=\"true\"></i></span></span><span class=\"sentence-content\">${trimmed}</span></span>`;\r\n          })\r\n          .join(' ');\r\n        // inject it into your wrapper DIV\r\n        const html = `<span class=\"snippet-wrapper\" data-snippet=\"${escLabel}\"${idAttr}>${sentences}</span>`;\r\n\r\n        snippetHtml.push(html);\r\n        snippetMap[opt] = html;\r\n      });\r\n    } else if (typeof selectedOption === 'string') {\r\n\r\n      let text: string | null = null;\r\n      let optObj: TemplateOption | undefined;\r\n      if (selectedOption === '__saved') {\r\n        text = savedSnippets[block.title] || localStorage.getItem(`customSnippet_${block.title}`);\r\n      } else {\r\n        optObj = block.options.find((o) => o.label === selectedOption);\r\n        if (optObj) {\r\n          text = optObj.previewText.trim().replace(/\\n/g, '<br />');\r\n        }\r\n      }\r\n      if (text !== null) {\r\n        text = applyDynamicSubstitutions(\r\n          text,\r\n          effectiveUserData,\r\n          enquiry,\r\n          amount,\r\n          dealPasscode,\r\n          undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n        );\r\n        text = cleanTemplateString(text).replace(/<p>/g, `<p style=\"margin: 0;\">`);\r\n        text = wrapInsertPlaceholders(text);\r\n        const escLabel = selectedOption.replace(/'/g, \"&#39;\");\r\n        const sentences = text\r\n          .split(/(?<=[.!?])\\s+/)\r\n          .filter((s) => s.trim().length > 0)\r\n          .map(\r\n            (s) =>\r\n              `<span data-sentence contenteditable=\"true\"><span class=\"sentence-controls\"><span class=\"sentence-handle\" draggable=\"true\" contenteditable=\"false\"><i class=\"ms-Icon ms-Icon--GripperDotsVertical\" aria-hidden=\"true\"></i></span><span class=\"sentence-delete\" contenteditable=\"false\"><i class=\"ms-Icon ms-Icon--Cancel\" aria-hidden=\"true\"></i></span></span><span class=\"sentence-content\">${s.trim()}</span></span>`\r\n          )\r\n          .join(' ');\r\n        const idAttr = optObj?.snippetId ? ` data-snippet-id=\"${optObj.snippetId}\"` : '';\r\n        const html = `<span class=\"snippet-wrapper\" data-snippet=\"${escLabel}\"${idAttr}>${sentences}</span>`;\r\n        snippetHtml.push(html);\r\n        snippetMap[selectedOption] = html;\r\n      }\r\n\r\n    }\r\n\r\n    const replacementText = snippetHtml.join('');\r\n    let selectedLabel = '';\r\n    if (block.isMultiSelect && isStringArray(selectedOption)) {\r\n      selectedLabel = selectedOption.join(', ');\r\n    } else if (typeof selectedOption === 'string') {\r\n      selectedLabel = selectedOption;\r\n    }\r\n    const containerTag = 'span';\r\n    const style = `background-color: ${colours.highlightNeutral}; padding: 7px; position: relative; border-radius: 0px; font-weight: normal;`;\r\n    const innerHTML = cleanTemplateString(replacementText);\r\n    const styledInnerHTML = innerHTML.replace(\r\n      /<p>/g,\r\n      `<p style=\"margin: 0;\">`\r\n    );\r\n    const optionsHtml = block.options\r\n      .map(o => {\r\n        const isSel = block.isMultiSelect && Array.isArray(selectedOption)\r\n          ? (selectedOption as string[]).includes(o.label)\r\n          : selectedOption === o.label;\r\n        return `<div class=\"option-choice${isSel ? ' selected' : ''}\" data-block-title=\"${block.title}\" data-option-label=\"${o.label}\">${o.label}</div>`;\r\n      })\r\n      .join('');\r\n    const savedSnippet = savedSnippets[block.title] || localStorage.getItem(`customSnippet_${block.title}`);\r\n    const savedChoice = savedSnippet\r\n      ? `<div class=\"option-choice${selectedOption === '__saved' ? ' selected' : ''}\" data-block-title=\"${block.title}\" data-option-label=\"__saved\">Saved Snippet</div>`\r\n      : '';\r\n    const optionsHtmlCombined = optionsHtml + savedChoice;\r\n    const labelText = `${block.title} (${getTemplateSetLabel(templateSet)}: ${selectedLabel})`;\r\n    const labelHTML = `<div class=\"block-label-display\" contenteditable=\"false\">${labelText}</div>`;\r\n    const pinnedClass = pinnedBlocks[block.title] ? ' pinned' : '';\r\n    const overlayIcon = overlaySidebars ? 'DockRight' : 'DockLeft';\r\n    const overlayActive = overlaySidebars ? ' active' : '';\r\n    const controlsHTML = `<div class=\"block-sidebar${pinnedClass}\" data-block-title=\"${block.title}\" data-label=\"${labelText}\"><div class=\"sidebar-handle\" onclick=\"window.toggleBlockSidebar('${block.title}')\"><i class=\"ms-Icon ms-Icon--${pinnedBlocks[block.title] ? 'ChevronRight' : 'ChevronLeft'}\"></i></div><div class=\"actions\"><span class=\"icon-btn pin-toggle${pinnedBlocks[block.title] ? ' pinned' : ''}\" onclick=\"window.toggleBlockSidebar('${block.title}')\"><i class=\"ms-Icon ms-Icon--${pinnedBlocks[block.title] ? 'Pinned' : 'Pin'}\"></i></span><span class=\"icon-btn overlay-toggle${overlayActive}\" onclick=\"window.toggleSidebarOverlayMode()\"><i class=\"ms-Icon ms-Icon--${overlayIcon}\"></i></span><span class=\"icon-btn\" onclick=\"window.openSnippetEdit(event,'${block.title}')\"><i class='ms-Icon ms-Icon--Save'></i></span><span class=\"icon-btn lock-toggle\" onclick=\"window.toggleBlockLock('${block.title}')\"><i class=\"ms-Icon ms-Icon--Unlock\"></i></span><span class=\"icon-btn\" onclick=\"window.removeBlock('${block.title}')\"><i class=\"ms-Icon ms-Icon--Delete\"></i></span></div><div class=\"option-choices\">${optionsHtmlCombined}</div></div>`;\r\n    const highlightedReplacement = `<${containerTag} class=\"block-container${pinnedClass}\" style=\"${style}\" data-inserted=\"${block.title}\" data-placeholder=\"${block.placeholder}\" contenteditable=\"true\"><div class=\"block-main\">${styledInnerHTML}${labelHTML}</div>${controlsHTML}</${containerTag}>`;\r\n\r\n\r\n    // Simplified hover handlers to directly call highlightBlock\r\n    const wrappedHTML = `<!--START_BLOCK:${block.title}--><span data-block-title=\"${block.title}\" onmouseover=\"window.highlightBlock('${block.title}', true, 'editor')\" onmouseout=\"window.highlightBlock('${block.title}', false, 'editor')\">${highlightedReplacement}</span><!--END_BLOCK:${block.title}-->`;\r\n\r\n    // Process the body replacement\r\n    let newBody = body;\r\n    const existingBlockRegex = new RegExp(\r\n      `<!--START_BLOCK:${block.title}-->[\\\\s\\\\S]*?<!--END_BLOCK:${block.title}-->`,\r\n      'g'\r\n    );\r\n\r\n    if (existingBlockRegex.test(newBody)) {\r\n      if (append) {\r\n        newBody = newBody.replace(existingBlockRegex, (match) =>\r\n          match.replace(\r\n            `<!--END_BLOCK:${block.title}-->`,\r\n            `${highlightedReplacement}<!--END_BLOCK:${block.title}-->`\r\n          )\r\n        );\r\n      } else {\r\n        newBody = newBody.replace(existingBlockRegex, wrappedHTML);\r\n      }\r\n    } else {\r\n      const tempDiv = document.createElement('div');\r\n      tempDiv.innerHTML = newBody;\r\n      const target = tempDiv.querySelector(\r\n        `span[data-placeholder=\"${escapeForSelector(block.placeholder)}\"]`\r\n      );\r\n      if (target) {\r\n        (target as HTMLElement).innerHTML = wrappedHTML;\r\n        newBody = tempDiv.innerHTML;\r\n        bodyEditorRef.current &&\r\n          (bodyEditorRef.current.innerHTML = newBody);\r\n      } else {\r\n        const placeholderEsc = block.placeholder.replace(\r\n          /[-[\\]{}()*+?.,\\\\^$|#\\s]/g,\r\n          '\\\\$&'\r\n        );\r\n        const placeholderEscEncoded = block.placeholder\r\n          .replace(/&/g, '&amp;')\r\n          .replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&');\r\n        const placeholderRegex = new RegExp(\r\n          `(<span[^>]*data-placeholder=\"(?:${placeholderEsc}|${placeholderEscEncoded})\"[^>]*>)([\\\\s\\\\S]*?)(</span>)`,\r\n          'g'\r\n        );\r\n        newBody = newBody.replace(placeholderRegex, `$1${wrappedHTML}$3`);\r\n        bodyEditorRef.current &&\r\n          (bodyEditorRef.current.innerHTML = newBody);\r\n      }\r\n    }\r\n\r\n    setBodyInternal(newBody);\r\n\r\n    // Remove grey placeholder styling once the block is inserted\r\n    setTimeout(() => {\r\n      const phSpan = bodyEditorRef.current?.querySelector(\r\n        `span[data-placeholder=\"${block.placeholder}\"]`\r\n      ) as HTMLElement | null;\r\n      if (phSpan) {\r\n        phSpan.style.backgroundColor = 'transparent';\r\n        phSpan.style.padding = '0';\r\n        phSpan.style.display = 'contents';\r\n      }\r\n    }, 0);\r\n\r\n    setInsertedBlocks((prev) => ({ ...prev, [block.title]: true }));\r\n    setLockedBlocks((prev) => ({ ...prev, [block.title]: false }));\r\n\r\n    setOriginalBlockContent((prev) => ({\r\n      ...prev,\r\n      [block.title]: append\r\n        ? (prev[block.title] || '') + `${styledInnerHTML}${controlsHTML}`\r\n        : `${styledInnerHTML}${controlsHTML}`,\r\n    }));\r\n    setOriginalSnippetContent((prev) => ({\r\n      ...prev,\r\n      [block.title]: { ...(prev[block.title] || {}), ...snippetMap },\r\n    }));\r\n    setEditedSnippets((prev) => ({\r\n      ...prev,\r\n      [block.title]: {\r\n        ...(prev[block.title] || {}),\r\n        ...Object.fromEntries(Object.keys(snippetMap).map((k) => [k, false])),\r\n      },\r\n    }));\r\n    setEditedBlocks((prev) => ({ ...prev, [block.title]: false }));\r\n\r\n    if (shouldFocus) {\r\n      setTimeout(() => {\r\n        if (bodyEditorRef.current) {\r\n          const insertedSpan = bodyEditorRef.current.querySelector(\r\n            `span[data-inserted=\"${block.title}\"]`\r\n          );\r\n          if (insertedSpan) {\r\n            const range = document.createRange();\r\n            const sel = window.getSelection();\r\n            range.setStartAfter(insertedSpan);\r\n            range.collapse(true);\r\n            if (sel) {\r\n              sel.removeAllRanges();\r\n              sel.addRange(range);\r\n              saveSelection();\r\n            }\r\n          }\r\n\r\n          // Attach helper functions to window for inline handlers\r\n          (window as any).highlightBlock = highlightBlock;\r\n          (window as any).toggleBlockLock = toggleBlockLock;\r\n          (window as any).insertBlockOption = insertBlockOption;\r\n        }\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  function replaceSnippetOption(\r\n    block: TemplateBlock,\r\n    previous: string,\r\n    replacement: string\r\n  ) {\r\n    if (!bodyEditorRef.current) return;\r\n    const span = bodyEditorRef.current.querySelector(\r\n      `span[data-inserted=\"${block.title}\"]`\r\n    ) as HTMLElement | null;\r\n    if (!span) return;\r\n    const snippetEls = Array.from(\r\n      span.querySelectorAll('[data-snippet]')\r\n    ) as HTMLElement[];\r\n    const targetEl = snippetEls.find(\r\n      (el) => el.getAttribute('data-snippet') === previous\r\n    );\r\n    if (!targetEl) return;\r\n\r\n    const option = block.options.find((o) => o.label === replacement);\r\n    if (!option) return;\r\n    let text = option.previewText.trim().replace(/\\n/g, '<br />');\r\n    text = applyDynamicSubstitutions(\r\n      text,\r\n    effectiveUserData,\r\n      enquiry,\r\n      amount,\r\n      dealPasscode,\r\n      undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n    );\r\n    text = cleanTemplateString(text).replace(/<p>/g, `<p style=\"margin: 0;\">`);\r\n    text = wrapInsertPlaceholders(text);\r\n    targetEl.setAttribute('data-snippet', replacement);\r\n    if (option.snippetId) {\r\n      targetEl.setAttribute('data-snippet-id', String(option.snippetId));\r\n    } else {\r\n      targetEl.removeAttribute('data-snippet-id');\r\n    }\r\n    targetEl.innerHTML = `${text}`;\r\n\r\n    setOriginalSnippetContent((prev) => {\r\n      const blockMap = { ...(prev[block.title] || {}) };\r\n      // remove the old entry\r\n      delete blockMap[previous];\r\n\r\n      // build the new HTML, including data-snippet-id if present\r\n      if (option.snippetId) {\r\n        blockMap[replacement] = `\r\n          <span\r\n            class=\"snippet-wrapper\"\r\n            data-snippet=\"${replacement.replace(/'/g, \"&#39;\")}\"\r\n            data-snippet-id=\"${option.snippetId}\"\r\n          >\r\n            ${text}\r\n          </span>\r\n        `;\r\n      } else {\r\n        blockMap[replacement] = `\r\n          <span\r\n            class=\"snippet-wrapper\"\r\n            data-snippet=\"${replacement.replace(/'/g, \"&#39;\")}\"\r\n          >\r\n            ${text}\r\n          </span>\r\n        `;\r\n      }\r\n\r\n      return { ...prev, [block.title]: blockMap };\r\n    });\r\n    setEditedSnippets((prev) => {\r\n      const blockMap = { ...(prev[block.title] || {}) } as { [label: string]: boolean };\r\n      delete blockMap[previous];\r\n      blockMap[replacement] = false;\r\n      return { ...prev, [block.title]: blockMap };\r\n    });\r\n\r\n    const optionDiv = span.querySelector('div.option-choices');\r\n    if (optionDiv) {\r\n      const currentSelected = block.isMultiSelect\r\n        ? (selectedTemplateOptions[block.title] as string[])\r\n        : selectedTemplateOptions[block.title];\r\n      const newSelected = block.isMultiSelect\r\n        ? (currentSelected as string[]).map((opt) =>\r\n          opt === previous ? replacement : opt\r\n        )\r\n        : replacement;\r\n      const optionsHtml = block.options\r\n        .filter((o) =>\r\n          block.isMultiSelect && Array.isArray(newSelected)\r\n            ? !(newSelected as string[]).includes(o.label)\r\n            : newSelected !== o.label\r\n        )\r\n        .map((o) => {\r\n          const safe = o.label.replace(/'/g, \"&#39;\");\r\n          return `<span class=\"option-choice\" data-block-title=\"${block.title}\" data-option-label=\"${safe}\">${o.label}</span>`;\r\n        })\r\n        .join(' ');\r\n      const savedSnippet = savedSnippets[block.title] || localStorage.getItem(`customSnippet_${block.title}`);\r\n      const savedChoice = savedSnippet ? `<span class=\"option-choice\" data-block-title=\"${block.title}\" data-option-label=\"__saved\">Saved Snippet</span>` : '';\r\n      const optionListContent = [optionsHtml, savedChoice]\r\n        .filter(Boolean)\r\n        .join(' ');\r\n      optionDiv.innerHTML = optionListContent;\r\n    }\r\n\r\n    const updatedHtml = span.innerHTML;\r\n    setOriginalBlockContent((prev) => ({ ...prev, [block.title]: updatedHtml }));\r\n    setBody(bodyEditorRef.current.innerHTML);\r\n    setBody(bodyEditorRef.current.innerHTML);\r\n\r\n    if (block.isMultiSelect) {\r\n      setSelectedTemplateOptions((prev) => {\r\n        const arr = Array.isArray(prev[block.title])\r\n          ? ([...prev[block.title]] as string[])\r\n          : [];\r\n        const idx = arr.indexOf(previous);\r\n        if (idx !== -1) arr[idx] = replacement;\r\n        return { ...prev, [block.title]: arr };\r\n      });\r\n    } else {\r\n      setSelectedTemplateOptions((prev) => ({\r\n        ...prev,\r\n        [block.title]: replacement,\r\n      }));\r\n    }\r\n  }\r\n  function appendSnippetOption(block: TemplateBlock, optionLabel: string) {\r\n    if (lockedBlocks[block.title]) return;\r\n    if (!bodyEditorRef.current) return;\r\n    const span = bodyEditorRef.current.querySelector(\r\n      `span[data-inserted=\"${block.title}\"]`\r\n    ) as HTMLElement | null;\r\n    if (!span) return;\r\n    const main = span.querySelector('.block-main') as HTMLElement | null;\r\n    if (!main) return;\r\n\r\n    const option = block.options.find((o) => o.label === optionLabel);\r\n    if (!option) return;\r\n\r\n    let text = option.previewText.trim().replace(/\\n/g, '<br />');\r\n    text = applyDynamicSubstitutions(\r\n      text,\r\n      effectiveUserData,\r\n      enquiry,\r\n      amount,\r\n      dealPasscode,\r\n      undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n    );\r\n    text = cleanTemplateString(text).replace(/<p>/g, `<p style=\"margin: 0;\">`);\r\n    text = wrapInsertPlaceholders(text);\r\n    const escLabel = optionLabel.replace(/'/g, \"&#39;\");\r\n    const sentences = text\r\n      .split(/(?<=[.!?])\\s+/)\r\n      .filter((s) => s.trim().length > 0)\r\n      .map(\r\n        (s) =>\r\n          `<span data-sentence contenteditable=\"true\"><span class=\"sentence-handle\" draggable=\"true\" contenteditable=\"false\"><i class=\"ms-Icon ms-Icon--GripperDotsVertical\" aria-hidden=\"true\"></i></span><span class=\"sentence-delete\" contenteditable=\"false\"><i class=\"ms-Icon ms-Icon--Cancel\" aria-hidden=\"true\"></i></span>${s.trim()}</span>`\r\n      )\r\n      .join(' ');\r\n    const snippetHtml = `<span class=\"snippet-wrapper\" data-snippet=\"${escLabel}\">${sentences}</span>`;\r\n\r\n    main.insertAdjacentHTML('beforeend', snippetHtml);\r\n\r\n    setOriginalSnippetContent((prev) => ({\r\n      ...prev,\r\n      [block.title]: {\r\n        ...(prev[block.title] || {}),\r\n        [optionLabel]: snippetHtml,\r\n      },\r\n    }));\r\n    setEditedSnippets((prev) => ({\r\n      ...prev,\r\n      [block.title]: { ...(prev[block.title] || {}), [optionLabel]: false },\r\n    }));\r\n\r\n    const optionDiv = span.querySelector('div.option-choices');\r\n    if (optionDiv) {\r\n      const currentSelected = block.isMultiSelect\r\n        ? (selectedTemplateOptions[block.title] as string[])\r\n        : selectedTemplateOptions[block.title];\r\n      const newSelected = block.isMultiSelect\r\n        ? [\r\n          ...((Array.isArray(currentSelected)\r\n            ? currentSelected\r\n            : []) as string[]),\r\n          optionLabel,\r\n        ]\r\n        : optionLabel;\r\n      const optionsHtml = block.options\r\n        .map((o) => {\r\n          const isSel = block.isMultiSelect && Array.isArray(newSelected)\r\n            ? (newSelected as string[]).includes(o.label)\r\n            : newSelected === o.label;\r\n          return `<div class=\"option-choice${isSel ? ' selected' : ''}\" data-block-title=\"${block.title}\" data-option-label=\"${o.label}\">${o.label}</div>`;\r\n        })\r\n        .join('');\r\n      const savedSnippet = savedSnippets[block.title] || localStorage.getItem(`customSnippet_${block.title}`);\r\n      const savedChoice = savedSnippet ? `<div class=\"option-choice\" data-block-title=\"${block.title}\" data-option-label=\"__saved\">Saved Snippet</div>` : '';\r\n      optionDiv.innerHTML = optionsHtml + savedChoice;\r\n    }\r\n\r\n    const updatedHtml = span.innerHTML;\r\n    setOriginalBlockContent((prev) => ({ ...prev, [block.title]: updatedHtml }));\r\n    setBodyInternal(bodyEditorRef.current.innerHTML);\r\n  }\r\n\r\n  async function saveCustomSnippet(blockTitle: string, label?: string, sortOrder?: number, isNew?: boolean) {\r\n    if (!bodyEditorRef.current) return;\r\n    const span = bodyEditorRef.current.querySelector(\r\n      `span[data-inserted=\"${blockTitle}\"]`\r\n    ) as HTMLElement | null;\r\n    if (!span) return;\r\n    const main = span.querySelector('.block-main') as HTMLElement | null;\r\n    if (!main) return;\r\n    const snippetHtml = main.innerHTML;\r\n    const firstSnippet = main.querySelector('[data-snippet-id]') as HTMLElement | null;\r\n    const snippetId = firstSnippet ? parseInt(firstSnippet.getAttribute('data-snippet-id') || '0', 10) : undefined;\r\n    const block = blocks.find(b => b.title === blockTitle);\r\n    const blockId = block?.blockId;\r\n    try {\r\n      const url = `${getProxyBaseUrl()}/${process.env.REACT_APP_SUBMIT_SNIPPET_EDIT_PATH}?code=${process.env.REACT_APP_SUBMIT_SNIPPET_EDIT_CODE}`;\r\n      await fetch(url, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          snippetId,\r\n          proposedContent: snippetHtml,\r\n          proposedLabel: label,\r\n          proposedSortOrder: sortOrder,\r\n          proposedBlockId: blockId,\r\n          isNew,\r\n          proposedBy: userInitials\r\n        })\r\n      });\r\n      setSavedSnippets(prev => ({ ...prev, [blockTitle]: snippetHtml }));\r\n      showToast('Snippet submitted for approval', 'success');\r\n    } catch (err) {\r\n      console.error('Failed to save snippet', err);\r\n      showToast('Submission failed', 'error');\r\n    }\r\n  }\r\n\r\n  async function submitPlaceholderOption(\r\n    blockTitle: string,\r\n    text: string,\r\n    placeholder?: string,\r\n    label?: string,\r\n    sortOrder?: number,\r\n    isNew?: boolean,\r\n  ) {\r\n    try {\r\n      const url = `${getProxyBaseUrl()}/${process.env.REACT_APP_SUBMIT_SNIPPET_EDIT_PATH}?code=${process.env.REACT_APP_SUBMIT_SNIPPET_EDIT_CODE}`;\r\n      const block = blocks.find(b => b.title === blockTitle);\r\n      const blockId = block?.blockId;\r\n      await fetch(url, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          proposedContent: text,\r\n          proposedLabel: label,\r\n          proposedSortOrder: sortOrder,\r\n          proposedBlockId: blockId,\r\n          placeholder,\r\n          isNew,\r\n          proposedBy: userInitials,\r\n        }),\r\n      });\r\n      showToast('Option submitted', 'success');\r\n    } catch (err) {\r\n      console.error('Failed to submit option', err);\r\n      showToast('Save failed', 'error');\r\n    }\r\n  }\r\n\r\n  function removeSnippetOption(block: TemplateBlock, optionLabel: string) {\r\n    if (lockedBlocks[block.title]) return;\r\n    if (!bodyEditorRef.current) return;\r\n    const span = bodyEditorRef.current.querySelector(\r\n      `span[data-inserted=\"${block.title}\"]`\r\n    ) as HTMLElement | null;\r\n    if (!span) return;\r\n    const snippets = Array.from(\r\n      span.querySelectorAll('[data-snippet]')\r\n    ) as HTMLElement[];\r\n    const target = snippets.find(\r\n      (el) => el.getAttribute('data-snippet') === optionLabel\r\n    );\r\n    if (target) target.remove();\r\n    setOriginalSnippetContent((prev) => {\r\n      const blockMap = { ...(prev[block.title] || {}) };\r\n      delete blockMap[optionLabel];\r\n      return { ...prev, [block.title]: blockMap };\r\n    });\r\n    setEditedSnippets((prev) => {\r\n      const blockMap = { ...(prev[block.title] || {}) };\r\n      delete blockMap[optionLabel];\r\n      return { ...prev, [block.title]: blockMap };\r\n    });\r\n\r\n    const optionDiv = span.querySelector('div.option-choices');\r\n    if (optionDiv) {\r\n      const currentSelected = block.isMultiSelect\r\n        ? (selectedTemplateOptions[block.title] as string[])\r\n        : selectedTemplateOptions[block.title];\r\n      const newSelected = block.isMultiSelect\r\n        ? (currentSelected as string[]).filter((o) => o !== optionLabel)\r\n        : '';\r\n      const optionsHtml = block.options\r\n        .map((o) => {\r\n          const isSel = block.isMultiSelect && Array.isArray(newSelected)\r\n            ? (newSelected as string[]).includes(o.label)\r\n            : newSelected === o.label;\r\n          return `<div class=\"option-choice${isSel ? ' selected' : ''}\" data-block-title=\"${block.title}\" data-option-label=\"${o.label}\">${o.label}</div>`;\r\n        })\r\n        .join('');\r\n      optionDiv.innerHTML = optionsHtml;\r\n    }\r\n\r\n    const updatedHtml = span.innerHTML;\r\n    setOriginalBlockContent((prev) => ({ ...prev, [block.title]: updatedHtml }));\r\n    setBody(bodyEditorRef.current.innerHTML);\r\n  }\r\n\r\n  function removeBlockOption(block: TemplateBlock, optionLabel: string) {\r\n    if (lockedBlocks[block.title]) return;\r\n\r\n    // Save current state before making changes (immediate, not debounced)\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    saveToUndoStackImmediate(currentContent);\r\n\r\n    if (block.isMultiSelect) {\r\n      const current = Array.isArray(selectedTemplateOptions[block.title])\r\n        ? ([...(selectedTemplateOptions[block.title] as string[])])\r\n        : [];\r\n      if (!current.includes(optionLabel)) return;\r\n      const updated = current.filter((o) => o !== optionLabel);\r\n      if (updated.length === 0) {\r\n        handleClearBlock(block);\r\n      } else {\r\n        handleMultiSelectChange(block.title, updated);\r\n        removeSnippetOption(block, optionLabel);\r\n      }\r\n    } else {\r\n      if (selectedTemplateOptions[block.title] === optionLabel) {\r\n        handleClearBlock(block);\r\n      }\r\n    }\r\n  }\r\n\r\n  function hideTemplateBlock(title: string) {\r\n    const block = templateBlocks.find(b => b.title === title);\r\n    if (!block) return;\r\n    if (lockedBlocks[title]) return;\r\n\r\n    // Save current state before making changes (immediate, not debounced)\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    saveToUndoStackImmediate(currentContent);\r\n\r\n    setHiddenBlocks(prev => ({ ...prev, [title]: true }));\r\n    if (bodyEditorRef.current) {\r\n      const span = bodyEditorRef.current.querySelector(\r\n        `span[data-placeholder=\"${escapeForSelector(block.placeholder)}\"]`\r\n      ) as HTMLElement | null;\r\n      if (span) {\r\n        span.remove();\r\n        setBodyInternal(bodyEditorRef.current.innerHTML);\r\n      }\r\n    }\r\n  }\r\n\r\n  function addTemplateBlock(title: string) {\r\n    const block = templateBlocks.find(b => b.title === title);\r\n    if (!block) return;\r\n    setHiddenBlocks(prev => {\r\n      const copy = { ...prev };\r\n      delete copy[title];\r\n      return copy;\r\n    });\r\n    if (bodyEditorRef.current) {\r\n      const placeholderHTML = buildPlaceholder(block);\r\n      const temp = document.createElement('div');\r\n      temp.innerHTML = placeholderHTML;\r\n      bodyEditorRef.current.appendChild(temp.firstChild as Node);\r\n      setBody(bodyEditorRef.current.innerHTML);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When the user chooses an attachment from the list, we either insert or remove it.\r\n   */\r\n  function toggleAttachment(attachment: AttachmentOption) {\r\n    if (attachment.status === 'draft') {\r\n      return;\r\n    }\r\n    if (attachments.includes(attachment.key)) {\r\n      // remove\r\n      setAttachments((prev) => prev.filter((key) => key !== attachment.key));\r\n      removeAttachmentLink(attachment.key);\r\n    } else {\r\n      setAttachments((prev) => [...prev, attachment.key]);\r\n      saveSelection();\r\n      const linkHTML = `<span style=\"background-color: #ffe6e6; padding: 1px 3px;\" data-link=\"${attachment.key}\"><a href=\"${attachment.link}\" style=\"color: #3690CE; text-decoration: none;\">${attachment.text}</a></span>`;\r\n      insertAtCursor(linkHTML);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes the <span data-link=\"...\"> for an attachment\r\n   */\r\n  function removeAttachmentLink(key: string) {\r\n    if (bodyEditorRef.current) {\r\n      const tempDiv = document.createElement('div');\r\n      tempDiv.innerHTML = bodyEditorRef.current.innerHTML;\r\n      const spans = tempDiv.querySelectorAll(`span[data-link=\"${key}\"]`);\r\n      spans.forEach((span) => {\r\n        const parent = span.parentNode;\r\n        if (parent) {\r\n          parent.removeChild(span);\r\n        }\r\n      });\r\n      const newBody = tempDiv.innerHTML;\r\n      setBody(newBody);\r\n    }\r\n  }\r\n\r\n  function getFilteredAttachments(): AttachmentOption[] {\r\n    // Show only attachments relevant to the selected practice area\r\n    const practiceArea = Object.keys(PracticeAreaPitch).find(\r\n      (k) => PracticeAreaPitch[k as keyof PracticeAreaPitchType]\r\n    ) || '';\r\n    return availableAttachments.filter(\r\n      (attachment) =>\r\n        !attachment.applicableTo ||\r\n        attachment.applicableTo.includes(practiceArea)\r\n    );\r\n  }\r\n\r\n  function togglePreview() {\r\n    if (!isPreviewOpen && bodyEditorRef.current) {\r\n      Object.entries(selectedTemplateOptions).forEach(\r\n        ([blockTitle, selectedOption]) => {\r\n          const block = templateBlocks.find((b) => b.title === blockTitle);\r\n          if (block && !insertedBlocks[block.title] && selectedOption) {\r\n            insertTemplateBlock(block, selectedOption as any, false);\r\n          }\r\n        }\r\n      );\r\n      // Sync the latest editor content into state before showing the preview\r\n      setBody(bodyEditorRef.current.innerHTML);\r\n    }\r\n    setIsPreviewOpen(!isPreviewOpen);\r\n  }\r\n\r\n  /**\r\n   * Reset the entire form\r\n   */\r\n  function resetForm() {\r\n    suppressSaveRef.current = true;\r\n    setSubject('Your Enquiry');\r\n    setTo(enquiry.Email || '');\r\n    setCc('');\r\n    setBcc('2day@followupthen.com');\r\n    // Re-load the base template\r\n    const newBody = generateInitialBody(\r\n      templateBlocks.filter(b => !hiddenBlocks[b.title])\r\n    );\r\n    setBody(newBody);\r\n    if (bodyEditorRef.current) {\r\n      bodyEditorRef.current.innerHTML = newBody;\r\n    }\r\n    setAttachments([]);\r\n    setFollowUp(undefined);\r\n    setIsPreviewOpen(false);\r\n    setIsErrorVisible(false);\r\n    setErrorMessage('');\r\n    setSelectedTemplateOptions({});\r\n    setInsertedBlocks({});\r\n    setAutoInsertedBlocks({});\r\n    setLockedBlocks({});\r\n    setPinnedBlocks({});\r\n    setEditedBlocks({});\r\n    setOriginalBlockContent({});\r\n    setIsDraftConfirmed(false); // **Reset confirmation state**\r\n    setDealId(null);\r\n    setClientIds([]);\r\n    localStorage.removeItem('pitchBuilderState');\r\n\r\n    // Immediately clear any highlight styles from the DOM\r\n    templateBlocks.forEach((block) => {\r\n      highlightBlock(block.title, false);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate mandatory fields\r\n   */\r\n  function validateForm(): boolean {\r\n    if (!to.trim()) {\r\n      setErrorMessage('To field cannot be empty.');\r\n      setIsErrorVisible(true);\r\n      return false;\r\n    }\r\n    if (!subject.trim()) {\r\n      setErrorMessage('Subject cannot be empty.');\r\n      setIsErrorVisible(true);\r\n      return false;\r\n    }\r\n    if (!body.trim()) {\r\n      setErrorMessage('Email body cannot be empty.');\r\n      setIsErrorVisible(true);\r\n      return false;\r\n    }\r\n    // New mandatory deal capture fields\r\n    if (!initialScopeDescription.trim()) {\r\n      setErrorMessage('Service description is required.');\r\n      setIsErrorVisible(true);\r\n      return false;\r\n    }\r\n    const numericAmt = parseFloat(amount.replace(/[^0-9.]/g, ''));\r\n    if (!amount.trim() || isNaN(numericAmt) || numericAmt <= 0) {\r\n      setErrorMessage('Estimated fee is required (enter a positive number).');\r\n      setIsErrorVisible(true);\r\n      return false;\r\n    }\r\n    setIsErrorVisible(false);\r\n    setErrorMessage('');\r\n    return true;\r\n  }\r\n\r\n  async function insertDealIfNeeded(options?: { background?: boolean; bccAdditional?: string }): Promise<string | null> {\r\n    try {\r\n      // Check if deal creation is already in progress or if we already have a passcode\r\n      if (dealCreationInProgress) {\r\n        console.log('⏸️ Deal creation already in progress, skipping duplicate call');\r\n        return null;\r\n      }\r\n\r\n      if (dealPasscode) {\r\n        console.log('✅ Deal passcode already exists:', dealPasscode);\r\n        return dealPasscode;\r\n      }\r\n\r\n      setDealCreationInProgress(true);\r\n\r\n      if (!options?.background) {\r\n        setDealStatus('processing');\r\n      }\r\n\r\n      const numericAmount = options?.background ? 0 : parseFloat(amount.replace(/,/g, '')) || 0;\r\n      const url = `${getProxyBaseUrl()}/${process.env.REACT_APP_INSERT_DEAL_PATH}?code=${process.env.REACT_APP_INSERT_DEAL_CODE}`;\r\n      \r\n      // Show initial loading state (only for foreground operations)\r\n      if (!options?.background) {\r\n        showToast('Preparing deal capture...', 'info', {\r\n          loading: true,\r\n          details: 'Validating enquiry data and formatting request',\r\n          progress: 10,\r\n          duration: 0\r\n        });\r\n      }\r\n      \r\n      // Ensure we always send a non-empty description. If the user hasn't set one,\r\n      // do NOT fall back to the email body. Require an explicit short description instead.\r\n      const fallbackDescription = (() => {\r\n        if (options?.background) return 'Placeholder deal capture (phased out)';\r\n        if (initialScopeDescription && initialScopeDescription.trim()) return initialScopeDescription.trim();\r\n        // Foreground path with no description: block and prompt the user.\r\n        setDealStatus('error');\r\n        showToast('Service description required', 'error', {\r\n          details: 'Add a short scope & quote description before capturing the deal.',\r\n          duration: 5000\r\n        });\r\n        return '';\r\n      })();\r\n\r\n      if (!fallbackDescription) {\r\n        return null;\r\n      }\r\n\r\n      // Resolve a usable numeric prospect id. Accept (in priority order): acid, ID, id.\r\n      // Reject non-digit values and placeholder/zero ids.\r\n      const rawCandidates = [\r\n        // @ts-ignore (runtime objects may have acid/id even if not in primary interface)\r\n        enquiry?.acid,\r\n        enquiry?.ID,\r\n        // @ts-ignore\r\n        enquiry?.id\r\n      ].map(v => (v === undefined || v === null ? '' : String(v).trim()));\r\n      const resolvedProspectId = rawCandidates.find(v => /^\\d+$/.test(v) && v !== '' && v !== '0' && v !== '00000');\r\n\r\n      if (!resolvedProspectId) {\r\n        if (options?.background) {\r\n          console.log('⏳ Skipping background deal insert: no valid numeric prospect id yet', rawCandidates);\r\n          return null;\r\n        }\r\n        // Foreground: allow one short retry window in case acid arrives milliseconds later.\r\n        const retryWindowMs = 1200;\r\n        const start = Date.now();\r\n        let retryId: string | undefined;\r\n        while ((Date.now() - start) < retryWindowMs && !retryId) {\r\n          await new Promise(r => setTimeout(r, 150));\r\n          const lateCandidates = [\r\n            // @ts-ignore\r\n            enquiry?.acid,\r\n            enquiry?.ID,\r\n            // @ts-ignore\r\n            enquiry?.id\r\n          ].map(v => (v === undefined || v === null ? '' : String(v).trim()));\r\n          retryId = lateCandidates.find(v => /^\\d+$/.test(v) && v !== '' && v !== '0' && v !== '00000');\r\n          if (retryId) {\r\n            console.log('✅ Prospect id appeared after brief wait', { retryId, lateCandidates });\r\n          }\r\n        }\r\n        if (!retryId) {\r\n          setDealStatus('error');\r\n          showToast('Missing prospect id', 'error', {\r\n            details: 'Cannot capture deal until enquiry ID/acid is loaded',\r\n            duration: 5000\r\n          });\r\n          return null;\r\n        }\r\n        // Use the newly found id\r\n        console.log('🆔 Using late-resolved prospect id', retryId);\r\n        return await insertDealIfNeeded(options); // restart with id now present\r\n      }\r\n\r\n      const payload = {\r\n        // when background=true, override description to make it obvious these were auto-created\r\n        initialScopeDescription: fallbackDescription,\r\n        amount: numericAmount,\r\n        areaOfWork: enquiry.Area_of_Work,\r\n        prospectId: resolvedProspectId,\r\n        pitchedBy: userInitials,\r\n        isMultiClient: isMultiClientFlag,\r\n        leadClientEmail: enquiry.Email,\r\n        // LeadClientId must mirror prospectId for single-client deals\r\n        leadClientId: resolvedProspectId,\r\n        // Include email recipient details for monitoring notification\r\n        emailRecipients: {\r\n          to: to || enquiry.Point_of_Contact || enquiry.Email,\r\n          cc: cc || '',\r\n          bcc: buildBccList(options?.bccAdditional),\r\n          feeEarnerEmail: userEmailAddress\r\n        },\r\n        // Pitch content fields\r\n        emailSubject: subject || '',\r\n        emailBody: body || '',\r\n        emailBodyHtml: body || '', // Use same content for now, could be enhanced later\r\n        reminders: [], // Could be populated from UI in future\r\n        notes: enquiry.Initial_first_call_notes || '',\r\n        ...(isMultiClientFlag && {\r\n          clients: dealClients.map((c) => ({\r\n            clientEmail: c.email,\r\n            prospectId: ADDITIONAL_CLIENT_PLACEHOLDER_ID,\r\n          })),\r\n        }),\r\n      };\r\n      console.log('🆔 Deal ID resolution', { rawCandidates, resolvedProspectId, sendingPayload: payload });\r\n\r\n      // Update progress\r\n      if (!options?.background) {\r\n        showToast('Saving deal…', 'info', {\r\n          loading: true,\r\n          details: `Capturing details for ${enquiry.Point_of_Contact || 'client'}`,\r\n          progress: 30,\r\n          duration: 0\r\n        });\r\n      }\r\n\r\n      const response = await fetch(url, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      console.log('🔌 Deal creation response:', { \r\n        ok: response.ok, \r\n        status: response.status, \r\n        statusText: response.statusText \r\n      });\r\n\r\n      if (!options?.background) {\r\n        showToast('Finalising deal…', 'info', {\r\n          loading: true,\r\n          details: 'Generating passcode and instruction link',\r\n          progress: 70,\r\n          duration: 0\r\n        });\r\n      }\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        console.log('📦 Deal creation data:', data);\r\n        if (data?.passcode) {\r\n          const norm = normalizePasscode(data.passcode, enquiry?.ID);\r\n          console.log('🎫 Setting deal passcode (normalized):', data.passcode, '->', norm);\r\n          if (norm) setDealPasscode(norm);\r\n          \r\n          if (!options?.background) {\r\n            setDealStatus('ready');\r\n          }\r\n          \r\n          // ✅ Enhanced success feedback\r\n          if (!options?.background) {\r\n            showToast('Deal captured successfully!', 'success', {\r\n              details: `Passcode ${norm} created • Instruction link ready`,\r\n              icon: 'CompletedSolid',\r\n              duration: 4000\r\n            });\r\n          }\r\n          \r\n          // ✅ Trigger same confirmation message as draft/send\r\n          setIsDraftConfirmed(true);\r\n          setTimeout(() => setIsDraftConfirmed(false), 3000);\r\n          return norm || data.passcode; // Return normalized (or raw fallback)\r\n        } else {\r\n          console.warn('⚠️ No passcode in response data');\r\n          if (!options?.background) {\r\n            setDealStatus('error');\r\n            showToast('Deal saved with warning', 'warning', {\r\n              details: 'Deal created but passcode generation failed',\r\n              icon: 'WarningSolid',\r\n              duration: 5000\r\n            });\r\n          }\r\n        }\r\n      } else {\r\n        const errorText = await response.text();\r\n        console.error('❌ Deal creation failed:', errorText);\r\n        if (!options?.background) {\r\n          setDealStatus('error');\r\n          showToast('Deal capture failed', 'error', {\r\n            details: `Server error: ${response.status} ${response.statusText}`,\r\n            icon: 'ErrorBadge',\r\n            duration: 6000\r\n          });\r\n        }\r\n      }\r\n\r\n      return null;\r\n    } catch (e) {\r\n      console.error('Failed to insert deal:', e);\r\n      if (!options?.background) {\r\n        setDealStatus('error');\r\n        showToast('Connection error', 'error', {\r\n          details: 'Unable to reach deal capture service',\r\n          icon: 'PlugDisconnected',\r\n          duration: 5000\r\n        });\r\n      }\r\n      return null;\r\n    } finally {\r\n      setDealCreationInProgress(false);\r\n    }\r\n  }\r\n\r\n  // Auto-create deal/passcode in background when PitchBuilder mounts and no passcode exists.\r\n  // DISABLED: This was creating unwanted placeholder deals. Real deals are created when users send/draft emails.\r\n  useEffect(() => {\r\n    // Background deal creation disabled to prevent duplicate placeholder deals\r\n    console.log('🔍 Background deal creation disabled - real deals created on send/draft');\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [enquiry?.ID]);\r\n\r\n  /**\r\n   * Helper function to get email from team table by initials\r\n   */\r\n  async function getEmailFromTeamTable(initials: string): Promise<string> {\r\n    if (!initials || !initials.trim()) return '';\r\n    \r\n    try {\r\n      // Use the same pattern as other API calls in the app\r\n      const response = await fetch(`${getProxyBaseUrl()}/api/team-lookup?initials=${encodeURIComponent(initials.trim())}`);\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        return data.email || '';\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to lookup team member email:', error);\r\n    }\r\n    \r\n    // Fallback to constructed email if API fails\r\n    return `${initials.toLowerCase().trim()}@helix-law.com`;\r\n  }\r\n\r\n  /**\r\n   * Get the solicitor's email for CC'ing\r\n   */\r\n  async function getSolicitorEmail(): Promise<string> {\r\n    // Try to get solicitor from Call_Taker field or other relevant fields\r\n    const solicitorInitials = enquiry.Call_Taker || enquiry.pocname;\r\n    if (solicitorInitials && solicitorInitials.trim()) {\r\n      // If solicitor is the current user, prefer the initials alias (lz@) over personal mailbox (luke@)\r\n      if ((solicitorInitials || '').trim().toUpperCase() === userInitials.trim().toUpperCase()) {\r\n        return getAliasFromInitials(userInitials);\r\n      }\r\n      return await getEmailFromTeamTable(solicitorInitials);\r\n    }\r\n    return '';\r\n  }\r\n\r\n  /** Build canonical helix-law alias from initials (e.g., 'LZ' -> 'lz@helix-law.com'). */\r\n  function getAliasFromInitials(initials: string | undefined | null): string {\r\n    const v = (initials || '').trim();\r\n    return v ? `${v.toLowerCase()}@helix-law.com` : '';\r\n  }\r\n\r\n  /**\r\n   * Build CC list including solicitor for client emails\r\n   */\r\n  async function buildCcList(includeSolicitor: boolean = true): Promise<string> {\r\n    const ccList: string[] = [];\r\n    \r\n    // Add existing CC if any\r\n    if (cc && cc.trim()) {\r\n      ccList.push(cc.trim());\r\n    }\r\n    \r\n    // Add solicitor for client emails\r\n    if (includeSolicitor) {\r\n      const solicitorEmail = await getSolicitorEmail();\r\n      if (solicitorEmail && solicitorEmail !== userEmailAddress) {\r\n        ccList.push(solicitorEmail);\r\n      }\r\n    }\r\n    \r\n    return ccList.join(', ');\r\n  }\r\n\r\n  /**\r\n   * Build BCC list with safety addresses\r\n   */\r\n  function buildBccList(additionalBcc?: string): string {\r\n    const bccList: string[] = [];\r\n    \r\n    // Add existing BCC\r\n    if (bcc && bcc.trim()) {\r\n      bccList.push(bcc.trim());\r\n    }\r\n    \r\n    // Add additional BCC if provided (exclude lz@helix-law.com)\r\n    if (additionalBcc && additionalBcc.trim() && additionalBcc.trim() !== 'lz@helix-law.com') {\r\n      bccList.push(additionalBcc.trim());\r\n    }\r\n    \r\n    // Add safety net addresses as requested\r\n    bccList.push('cb@helix-law.com');\r\n    \r\n    // Remove duplicates and filter out lz@helix-law.com\r\n    const filtered = Array.from(new Set(bccList)).filter(email => email !== 'lz@helix-law.com');\r\n    return filtered.join(', ');\r\n  }\r\n\r\n  /**\r\n   * Send email directly to client from fee earner's email address\r\n   */\r\n  async function sendEmail() {\r\n    if (!validateForm()) {\r\n      return;\r\n    }\r\n\r\n    if (!body || !enquiry.Point_of_Contact) {\r\n      setErrorMessage('Email contents and recipient email are required.');\r\n      setIsErrorVisible(true);\r\n      return;\r\n    }\r\n\r\n    setEmailStatus('processing');\r\n    setEmailMessage('Preparing to send…');\r\n    showToast('Preparing to send email...', 'info', {\r\n      loading: true,\r\n      details: 'Validating form data and deal information',\r\n      progress: 10,\r\n      duration: 0\r\n    });\r\n\r\n  const senderEmail = userEmailAddress || 'automations@helix-law.com';\r\n  const dealPasscode = await insertDealIfNeeded({ bccAdditional: senderEmail });\r\n    if (!dealPasscode) {\r\n      setEmailStatus('error');\r\n      setEmailMessage('Deal save failed');\r\n      showToast('Failed to save deal', 'error', {\r\n        details: 'Cannot send email without valid deal reference',\r\n        duration: 5000\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Ensure template blocks are inserted before sending\r\n    if (bodyEditorRef.current) {\r\n      Object.entries(selectedTemplateOptions).forEach(\r\n        ([blockTitle, selectedOption]) => {\r\n          const block = templateBlocks.find((b) => b.title === blockTitle);\r\n          if (block && !insertedBlocks[block.title] && selectedOption) {\r\n            insertTemplateBlock(block, selectedOption as any, false);\r\n          }\r\n        }\r\n      );\r\n      setBody(bodyEditorRef.current.innerHTML);\r\n    }\r\n\r\n    // Step 2: Content processing\r\n    setEmailMessage('Processing content…');\r\n    showToast('Processing email content...', 'info', {\r\n      loading: true,\r\n      details: 'Applying substitutions and formatting',\r\n      progress: 40,\r\n      duration: 0\r\n    });\r\n\r\n    await delay(400);\r\n\r\n    // Check if V2 processing was requested from the confirmation dialog\r\n    const useV2Processing = (window as any).__helixEmailProcessingV2__ === true;\r\n    let finalHtml: string;\r\n\r\n    if (useV2Processing) {\r\n      console.log('Using V2 email processing (experimental enhanced formatting)');\r\n      // Use EmailProcessor V2 for enhanced processing\r\n      finalHtml = EmailProcessor.processCompleteEmail(body, {\r\n        userData: effectiveUserData,\r\n        enquiry,\r\n        amount,\r\n        passcode: normalizePasscode(dealPasscode, enquiry?.ID) || dealPasscode,\r\n        editorElement: bodyEditorRef.current,\r\n        forceV2: true\r\n      });\r\n    } else {\r\n      console.log('Using V1 email processing (production method)');\r\n      // Use original V1 processing method\r\n      let rawHtml = removeHighlightSpans(body);\r\n      rawHtml = applyDynamicSubstitutions(\r\n        rawHtml,\r\n        effectiveUserData,\r\n        enquiry,\r\n        amount,\r\n        normalizePasscode(dealPasscode, enquiry?.ID) || dealPasscode,\r\n        undefined\r\n      );\r\n\r\n      // Remove leftover placeholders and format paragraphs\r\n      const noPlaceholders = removeUnfilledPlaceholders(rawHtml, templateBlocks);\r\n      finalHtml = convertDoubleBreaksToParagraphs(noPlaceholders);\r\n    }\r\n\r\n    // Step 3: Email composition with signature\r\n    setEmailMessage('Generating final email…');\r\n    showToast('Generating final email...', 'info', {\r\n      loading: true,\r\n      details: 'Creating formatted email with signature',\r\n      progress: 70,\r\n      duration: 0\r\n    });\r\n\r\n    const fullEmailHtml = ReactDOMServer.renderToStaticMarkup(\r\n  <EmailSignature bodyHtml={finalHtml} userData={effectiveUserData} experimentalLayout={useV2Processing} />\r\n    );\r\n\r\n    // Use fee earner's email as sender, fallback to automations\r\n  // senderEmail defined above for consistency with insertDeal payload\r\n    \r\n  // No CC on send. BCC the sender (self) and safety addresses (LZ/CB).\r\n  const bccList = buildBccList(senderEmail);\r\n    \r\n    const requestBody = {\r\n      email_contents: fullEmailHtml,\r\n      user_email: to, // Client's email as recipient\r\n      subject: subject, // Use 'subject' not 'subject_line' for decoupled function\r\n      from_email: senderEmail, // Send from fee earner's email\r\n      bcc_emails: bccList, // BCC sender + safety addresses\r\n      saveToSentItems: true, // 🎯 Save to fee earner's Sent Items folder\r\n      // Include recipient details for monitoring notification\r\n      recipient_details: {\r\n        to: to,\r\n        cc: cc || '',\r\n        bcc: bccList,\r\n        fee_earner: senderEmail\r\n      }\r\n    };\r\n\r\n    // Guard: ensure we have a valid recipient email\r\n    if (!to || to.trim() === '') {\r\n      setErrorMessage('Cannot send email: recipient email address is not available.');\r\n      setIsErrorVisible(true);\r\n      showToast('Failed to send email', 'error', {\r\n        details: 'Recipient email address not configured',\r\n        duration: 5000\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setErrorMessage('');\r\n      setIsErrorVisible(false);\r\n\r\n      // Step 4: Send email via API\r\n      setEmailMessage(`Sending to ${enquiry.Point_of_Contact || to}…`);\r\n      showToast('Sending email...', 'info', {\r\n        loading: true,\r\n        details: `Delivering to ${enquiry.Point_of_Contact || to}`,\r\n        progress: 90,\r\n        duration: 0\r\n      });\r\n\r\n      const response = await fetch(\r\n        `/api/sendEmail`,\r\n        {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(requestBody),\r\n        }\r\n      );\r\n      \r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(errorText || 'Failed to send email.');\r\n      }\r\n\r\n      // Success feedback\r\n      showToast('Email sent successfully!', 'success', {\r\n        details: `Message delivered to ${enquiry.Point_of_Contact || to}`,\r\n        icon: 'MailSolid',\r\n        duration: 4000\r\n      });\r\n\r\n      setEmailStatus('sent');\r\n      setEmailMessage('Sent');\r\n\r\n      setIsSuccessVisible(true);\r\n      // Don't reset form after sending - users may want to send follow-ups or make edits\r\n      setIsDraftConfirmed(true);\r\n      setTimeout(() => setIsDraftConfirmed(false), 3000);\r\n\r\n    } catch (error: any) {\r\n      const errorMsg = error?.message || 'Failed to send email';\r\n      console.error('Email send error:', error);\r\n      \r\n      setErrorMessage(`Failed to send email: ${errorMsg}`);\r\n      setIsErrorVisible(true);\r\n      setEmailStatus('error');\r\n      setEmailMessage(errorMsg);\r\n      \r\n      showToast('Failed to send email', 'error', {\r\n        details: errorMsg,\r\n        duration: 8000\r\n      });\r\n    }\r\n  }\r\n\r\n  const inTeams = isInTeams();\r\n  const useLocalData =\r\n    process.env.REACT_APP_USE_LOCAL_DATA === 'true' || !inTeams;\r\n\r\n  function initiateDraftEmail() {\r\n    const allowed = ['LZ', 'AC', 'JD'];\r\n    if (useLocalData || allowed.includes(userInitials)) {\r\n      setActiveTab('deals');\r\n    } else {\r\n      handleDraftEmail();\r\n      setActiveTab('details');\r\n      setActiveTab('details');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * handleDraftEmail: keep HTML, remove placeholders & highlights, convert <br><br> to <p>, then pass to EmailSignature.\r\n   */\r\n  async function handleDraftEmail() {\r\n    if (!body || !enquiry.Point_of_Contact) {\r\n      setErrorMessage('Email contents and user email are required.');\r\n      setIsErrorVisible(true);\r\n      return;\r\n    }\r\n    setEmailStatus('processing');\r\n    setEmailMessage('Preparing draft…');\r\n    if (bodyEditorRef.current) {\r\n      Object.entries(selectedTemplateOptions).forEach(\r\n        ([blockTitle, selectedOption]) => {\r\n          const block = templateBlocks.find((b) => b.title === blockTitle);\r\n          if (block && !insertedBlocks[block.title] && selectedOption) {\r\n            insertTemplateBlock(block, selectedOption as any, false);\r\n          }\r\n        }\r\n      );\r\n      setBody(bodyEditorRef.current.innerHTML);\r\n    }\r\n\r\n    // Step 1: Deal capture with enhanced feedback\r\n    showToast('Starting email draft process...', 'info', {\r\n      loading: true,\r\n      details: 'Saving deal and generating passcode',\r\n      progress: 15,\r\n      duration: 0\r\n    });\r\n\r\n    // Ensure description exists prior to drafting\r\n    if (!initialScopeDescription || !initialScopeDescription.trim()) {\r\n      setErrorMessage('Service description is required before drafting.');\r\n      setIsErrorVisible(true);\r\n      showToast('Missing service description', 'error', {\r\n        details: 'Please add a short scope & quote description.',\r\n        duration: 4000\r\n      });\r\n      return;\r\n    }\r\n    const currentPasscode = await insertDealIfNeeded({ bccAdditional: undefined });\r\n    if (!currentPasscode) {\r\n      setEmailStatus('error');\r\n      setEmailMessage('Deal save failed');\r\n      showToast('Failed to save deal', 'error', {\r\n        details: 'Cannot proceed without valid deal reference',\r\n        duration: 5000\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Step 2: Content processing\r\n    setEmailMessage('Processing content…');\r\n    showToast('Processing email content...', 'info', {\r\n      loading: true,\r\n      details: 'Applying substitutions and formatting',\r\n      progress: 40,\r\n      duration: 0\r\n    });\r\n\r\n    await delay(400); // Brief pause to show progress\r\n\r\n    // Check if V2 processing was requested (in case draft follows a send operation)\r\n    const useV2Processing = (window as any).__helixEmailProcessingV2__ === true;\r\n    let finalHtml: string;\r\n\r\n    if (useV2Processing) {\r\n      console.log('Using V2 email processing for draft (experimental enhanced formatting)');\r\n      // Use EmailProcessor V2 for enhanced processing\r\n      finalHtml = EmailProcessor.processCompleteEmail(body, {\r\n        userData: effectiveUserData,\r\n        enquiry,\r\n        amount,\r\n        passcode: normalizePasscode(currentPasscode, enquiry?.ID) || currentPasscode,\r\n        editorElement: bodyEditorRef.current,\r\n        forceV2: true\r\n      });\r\n    } else {\r\n      console.log('Using V1 email processing for draft (production method)');\r\n      // Use original V1 processing method\r\n      let rawHtml = removeHighlightSpans(body);\r\n\r\n      // Apply dynamic substitutions such as amount just before sending\r\n      // Use the fresh passcode from the API call, not the state variable\r\n      rawHtml = applyDynamicSubstitutions(\r\n        rawHtml,\r\n        effectiveUserData,\r\n        enquiry,\r\n        amount,\r\n        normalizePasscode(currentPasscode, enquiry?.ID) || currentPasscode,\r\n        undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n      );\r\n\r\n      // Remove leftover placeholders\r\n      const noPlaceholders = removeUnfilledPlaceholders(rawHtml, templateBlocks);\r\n\r\n      // After removing leftover placeholders/highlights in handleDraftEmail():\r\n      finalHtml = convertDoubleBreaksToParagraphs(noPlaceholders);\r\n    }\r\n\r\n    // Step 3: Email composition\r\n    setEmailMessage('Generating email draft…');\r\n    showToast('Preparing draft…', 'info', {\r\n      loading: true,\r\n      details: 'Formatting content and signature',\r\n      progress: 70,\r\n      duration: 0\r\n    });\r\n\r\n    const fullEmailHtml = ReactDOMServer.renderToStaticMarkup(\r\n  <EmailSignature bodyHtml={finalHtml} userData={effectiveUserData} />\r\n    );\r\n\r\n  // Draft: send to the user themselves; BCC only safety addresses (no CC)\r\n  const bccList = buildBccList(); // LZ/CB only\r\n\r\n    const requestBody = {\r\n      email_contents: fullEmailHtml,\r\n      user_email: userEmailAddress, // Draft to self\r\n      subject: subject, // Use 'subject' for consistency with sendEmail function\r\n      to,\r\n      from_email: userEmailAddress || undefined,\r\n      bcc_emails: bccList, // Safety only\r\n      saveToSentItems: true, // 🎯 Save draft to Sent Items folder\r\n    };\r\n\r\n    // Guard: ensure we have a valid recipient email for the drafted message\r\n    if (!userEmailAddress || userEmailAddress.trim() === '') {\r\n      setErrorMessage('Cannot draft email: sender email address is not available.');\r\n      setIsErrorVisible(true);\r\n      showToast('Failed to draft email', 'error', {\r\n        details: 'Sender email address not configured',\r\n        duration: 5000\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setErrorMessage('');\r\n      setIsErrorVisible(false);\r\n\r\n      // Step 4: Sending to Outlook\r\n      setEmailMessage('Creating draft…');\r\n      showToast('Creating draft…', 'info', {\r\n        loading: true,\r\n        details: 'Saving to Outlook',\r\n        progress: 90,\r\n        duration: 0\r\n      });\r\n      const response = await fetch(\r\n        `/api/sendEmail`,\r\n        {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify(requestBody),\r\n        }\r\n      );\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(errorText || 'Failed to draft email.');\r\n      }\r\n\r\n      // Success feedback with completion details\r\n      showToast('Draft created', 'success', {\r\n        details: `Saved to Outlook for ${enquiry.Point_of_Contact || 'client'}`,\r\n        icon: 'MailSolid',\r\n        duration: 4000\r\n      });\r\n\r\n      setEmailStatus('sent');\r\n      setEmailMessage('Draft created');\r\n\r\n      setIsSuccessVisible(true);\r\n      setIsDraftConfirmed(true); // **Set confirmation state**\r\n      setTimeout(() => {\r\n        setIsDraftConfirmed(false);\r\n      }, 3000);\r\n    } catch (error: any) {\r\n      console.error('Error drafting email:', error);\r\n      setErrorMessage(error.message || 'An unknown error occurred.');\r\n      setIsErrorVisible(true);\r\n      setEmailStatus('error');\r\n      setEmailMessage(error.message || 'Unable to create email draft');\r\n      showToast('Failed to draft email', 'error', {\r\n        details: error.message || 'Unable to create email draft',\r\n        icon: 'MailSolid',\r\n        duration: 5000\r\n      });\r\n    }\r\n  }\r\n\r\n  function handleDealFormSubmit(data: {\r\n    initialScopeDescription: string;\r\n    amount: number;\r\n    isMultiClient: boolean;\r\n    clients: { firstName: string; lastName: string; email: string }[];\r\n  }) {\r\n    setInitialScopeDescription(data.initialScopeDescription);\r\n    setAmount(data.amount.toString());\r\n    setDealClients(data.clients);\r\n    setIsMultiClientFlag(data.isMultiClient);\r\n    setActiveTab('details');\r\n  }\r\n\r\n  /**\r\n   * Hide success message automatically after 3s\r\n   */\r\n  useEffect(() => {\r\n    if (isSuccessVisible) {\r\n      const timer = setTimeout(() => setIsSuccessVisible(false), 3000);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [isSuccessVisible]);\r\n\r\n  /**\r\n   * Hide error after 5s\r\n   */\r\n  useEffect(() => {\r\n    if (isErrorVisible) {\r\n      const timer = setTimeout(() => setIsErrorVisible(false), 5000);\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [isErrorVisible]);\r\n\r\n  /**\r\n   * Keep the editor's HTML in sync with our `body` state\r\n   */\r\n  useEffect(() => {\r\n    if (\r\n      bodyEditorRef.current &&\r\n      bodyEditorRef.current.innerHTML !== body &&\r\n      document.activeElement !== bodyEditorRef.current\r\n    ) {\r\n      bodyEditorRef.current.innerHTML = body;\r\n    }\r\n  }, [body]);\r\n\r\n  /**\r\n   * Update selected template options for multi-select blocks\r\n   */\r\n  function handleMultiSelectChange(blockTitle: string, selectedOptions: string[]) {\r\n    setSelectedTemplateOptions((prev) => ({\r\n      ...prev,\r\n      [blockTitle]: selectedOptions,\r\n    }));\r\n    setAutoInsertedBlocks((prev) => ({ ...prev, [blockTitle]: false }));\r\n  }\r\n\r\n  useEffect(() => {\r\n    Object.entries(selectedTemplateOptions).forEach(([blockTitle, selectedOption]) => {\r\n      const block = templateBlocks.find((b) => b.title === blockTitle);\r\n      if (block && insertedBlocks[block.title]) {\r\n        insertTemplateBlock(block, selectedOption, false);\r\n      }\r\n    });\r\n  }, [amount]);\r\n\r\n  /**\r\n   * Update selected template options for single-select blocks\r\n   */\r\n  function handleSingleSelectChange(blockTitle: string, selectedOption: string) {\r\n    setSelectedTemplateOptions((prev) => ({\r\n      ...prev,\r\n      [blockTitle]: selectedOption,\r\n    }));\r\n    setAutoInsertedBlocks((prev) => ({ ...prev, [blockTitle]: false }));\r\n  }\r\n\r\n  /**\r\n   * For simple formatting commands (bold, italic, etc.)\r\n   */\r\n  function applyFormat(command: string, value?: string) {\r\n    document.execCommand(command, false, value);\r\n    if (bodyEditorRef.current) {\r\n      setBody(bodyEditorRef.current.innerHTML);\r\n    }\r\n  }\r\n\r\n  function handleInput() {\r\n    if (!bodyEditorRef.current) return;\r\n    setBody(bodyEditorRef.current.innerHTML);\r\n\r\n    const { blocks, snippets } = computeSnippetChanges();\r\n    if (Object.keys(blocks).length > 0) {\r\n      setEditedBlocks((prev) => ({ ...prev, ...blocks }));\r\n    }\r\n    if (Object.keys(snippets).length > 0) {\r\n      setEditedSnippets((prev) => {\r\n        const copy = { ...prev } as { [key: string]: { [label: string]: boolean } };\r\n        Object.entries(snippets).forEach(([title, map]) => {\r\n          copy[title] = { ...(copy[title] || {}), ...map };\r\n        });\r\n        return copy;\r\n      });\r\n    }\r\n  }\r\n\r\n  function handleBlur() {\r\n    if (bodyEditorRef.current) {\r\n      setBody(bodyEditorRef.current.innerHTML);\r\n\r\n      const { blocks, snippets } = computeSnippetChanges();\r\n\r\n      if (Object.keys(snippets).length > 0) {\r\n        setEditedSnippets((prev) => {\r\n          const copy = { ...prev } as { [key: string]: { [label: string]: boolean } };\r\n          Object.entries(snippets).forEach(([title, map]) => {\r\n            copy[title] = { ...(copy[title] || {}), ...map };\r\n          });\r\n          return copy;\r\n        });\r\n      }\r\n\r\n      if (Object.keys(blocks).length > 0) {\r\n        setEditedBlocks((prev) => ({ ...prev, ...blocks }));\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When you click \"clear\" on a block, we remove its inserted text,\r\n   * restoring the original placeholder <span>.\r\n   */\r\n  function removeBlockByMarkers(\r\n    container: HTMLElement,\r\n    title: string,\r\n    placeholderHTML: string\r\n  ): boolean {\r\n    const walker = document.createTreeWalker(\r\n      container,\r\n      NodeFilter.SHOW_COMMENT,\r\n      null\r\n    );\r\n    let start: Comment | null = null;\r\n    let end: Comment | null = null;\r\n    while (walker.nextNode()) {\r\n      const comment = walker.currentNode as Comment;\r\n      if (comment.nodeValue === `START_BLOCK:${title}`) {\r\n        start = comment;\r\n      } else if (comment.nodeValue === `END_BLOCK:${title}`) {\r\n        end = comment;\r\n        break;\r\n      }\r\n    }\r\n    if (start && end) {\r\n      const range = document.createRange();\r\n      range.setStartBefore(start);\r\n      range.setEndAfter(end);\r\n      range.deleteContents();\r\n      const temp = document.createElement('div');\r\n      temp.innerHTML = placeholderHTML;\r\n      const node = temp.firstChild as Node;\r\n      range.insertNode(node);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  function handleClearBlock(block: TemplateBlock) {\r\n    // Save current state before making changes (immediate, not debounced)\r\n    const currentContent = bodyEditorRef.current?.innerHTML || body;\r\n    saveToUndoStackImmediate(currentContent);\r\n\r\n    if (bodyEditorRef.current) {\r\n      // Build a regex to capture everything between the markers.\r\n      const safeTitle = block.title.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&');\r\n      const regex = new RegExp(\r\n        `<!--START_BLOCK:${safeTitle}-->[\\\\s\\\\S]*?<!--END_BLOCK:${safeTitle}-->`,\r\n        'g'\r\n      );\r\n      // Build the original placeholder markup.\r\n      const placeholderHTML = buildPlaceholder(block);\r\n      // Replace via regex. If no match is found (comments removed during edit),\r\n      // fall back to querying the inserted span in the DOM.\r\n      let updatedBody = bodyEditorRef.current.innerHTML;\r\n      let removed = false;\r\n      if (regex.test(updatedBody)) {\r\n        updatedBody = updatedBody.replace(regex, placeholderHTML);\r\n        bodyEditorRef.current.innerHTML = updatedBody;\r\n        removed = true;\r\n      } else if (\r\n        removeBlockByMarkers(bodyEditorRef.current, block.title, placeholderHTML)\r\n      ) {\r\n        updatedBody = bodyEditorRef.current.innerHTML;\r\n        removed = true;\r\n      } else {\r\n        let inserted = bodyEditorRef.current.querySelector(\r\n          `[data-inserted=\"${block.title}\"]`\r\n        ) as HTMLElement | null;\r\n        if (!inserted) {\r\n          inserted = bodyEditorRef.current.querySelector(\r\n            `[data-block-title=\"${block.title}\"]`\r\n          ) as HTMLElement | null;\r\n        }\r\n        if (!inserted) {\r\n          try {\r\n            inserted = bodyEditorRef.current.querySelector(\r\n              `.block-container[data-placeholder=\"${escapeForSelector(block.placeholder)}\"]`\r\n            ) as HTMLElement | null;\r\n          } catch {\r\n            inserted = null;\r\n          }\r\n        }\r\n        if (inserted) {\r\n          const temp = document.createElement('div');\r\n          temp.innerHTML = placeholderHTML;\r\n          inserted.replaceWith(temp.firstChild as Node);\r\n          updatedBody = bodyEditorRef.current.innerHTML;\r\n          removed = true;\r\n        }\r\n      }\r\n      if (removed) {\r\n        setBodyInternal(updatedBody);\r\n        // Remove highlight right away so the user sees immediate feedback\r\n        highlightBlock(block.title, false);\r\n\r\n        // Update state for the selected options and inserted block flag.\r\n        setSelectedTemplateOptions((prev) => ({\r\n          ...prev,\r\n          [block.title]: block.isMultiSelect ? [] : '',\r\n        }));\r\n        setInsertedBlocks((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n        setLockedBlocks((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n\r\n        setPinnedBlocks((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n\r\n        setEditedBlocks((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n        setOriginalBlockContent((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n\r\n        setOriginalSnippetContent((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n        setEditedSnippets((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n        setAutoInsertedBlocks((prev) => {\r\n          const copy = { ...prev };\r\n          delete copy[block.title];\r\n          return copy;\r\n        });\r\n      } else {\r\n        console.warn('Failed to clear block:', block.title);\r\n      }\r\n    }\r\n  }\r\n\r\n  function clearAllBlocks() {\r\n    if (bodyEditorRef.current) {\r\n      let newBody = bodyEditorRef.current.innerHTML;\r\n      templateBlocks.forEach((block) => {\r\n        const regex = new RegExp(\r\n          `<!--START_BLOCK:${block.title}-->[\\\\s\\\\S]*?<!--END_BLOCK:${block.title}-->`,\r\n          'g'\r\n        );\r\n        const placeholderHTML = buildPlaceholder(block); newBody = newBody.replace(regex, placeholderHTML);\r\n      });\r\n      bodyEditorRef.current.innerHTML = newBody;\r\n      setBody(newBody);\r\n    }\r\n    setSelectedTemplateOptions({});\r\n    setInsertedBlocks({});\r\n    setAutoInsertedBlocks({});\r\n    setLockedBlocks({});\r\n    setPinnedBlocks({});\r\n    setEditedBlocks({});\r\n    setOriginalBlockContent({});\r\n    setOriginalSnippetContent({});\r\n    setEditedSnippets({});\r\n    templateBlocks.forEach((block) => highlightBlock(block.title, false));\r\n  }\r\n\r\n  function reorderTemplateBlocks(start: number, end: number) {\r\n    setBlocks((prev) => {\r\n      const updated = Array.from(prev);\r\n      const [moved] = updated.splice(start, 1);\r\n      updated.splice(end, 0, moved);\r\n      return updated;\r\n    });\r\n  }\r\n\r\n  function duplicateTemplateBlock(index: number) {\r\n    setBlocks((prev) => {\r\n      const copy = [...prev];\r\n      const block = { ...copy[index] };\r\n      let base = block.title;\r\n      let suffix = 1;\r\n      let newTitle = `${base} Copy`;\r\n      const titles = new Set(copy.map((b) => b.title));\r\n      while (titles.has(newTitle)) {\r\n        suffix += 1;\r\n        newTitle = `${base} Copy ${suffix}`;\r\n      }\r\n      block.title = newTitle;\r\n      copy.splice(index + 1, 0, block);\r\n      return copy;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Renders the \"preview\" text for a selected block in the UI\r\n   */\r\n  function renderPreview(block: TemplateBlock) {\r\n    const selectedOptions = selectedTemplateOptions[block.title];\r\n    const isInserted = insertedBlocks[block.title] || false;\r\n\r\n    const isEdited = Object.values(editedSnippets[block.title] || {}).some(Boolean);\r\n\r\n    if (\r\n      !selectedOptions ||\r\n      (block.isMultiSelect &&\r\n        Array.isArray(selectedOptions) &&\r\n        selectedOptions.length === 0)\r\n    ) {\r\n      if (isInserted) {\r\n        if (lockedBlocks[block.title]) {\r\n          return (\r\n            <div\r\n              className={mergeStyles({\r\n                marginTop: '6px',\r\n                border: `1px solid ${isDarkMode ? 'rgba(16,124,16,0.1)' : '#eafaea'\r\n                  }`,\r\n                padding: '4px 6px',\r\n                borderRadius: 0,\r\n                fontSize: '12px',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n              })}\r\n            >\r\n              <Icon\r\n                iconName=\"CheckMark\"\r\n                styles={{ root: { color: colours.green, marginRight: 4 } }}\r\n              />\r\n              <span>Locked</span>\r\n            </div>\r\n          );\r\n        }\r\n        if (isEdited) {\r\n          return (\r\n            <div\r\n              className={mergeStyles({\r\n                marginTop: '6px',\r\n                border: `1px solid ${colours.highlightBlue}`,\r\n                padding: '6px 10px',\r\n                borderRadius: 0,\r\n                fontSize: '12px',\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n              })}\r\n            >\r\n              <Icon\r\n                iconName=\"Edit\"\r\n                styles={{ root: { color: colours.highlightBlue, marginRight: 4 } }}\r\n              />\r\n              <span>Customised</span>\r\n            </div>\r\n          );\r\n        }\r\n      }\r\n      return null;\r\n    }\r\n\r\n    const formatPreviewText = (text: string) => {\r\n      return text.replace(/\\n/g, '<br />');\r\n    };\r\n\r\n    if (block.isMultiSelect && Array.isArray(selectedOptions)) {\r\n      return (\r\n        <div\r\n          className={mergeStyles({\r\n            marginTop: '6px',\r\n            border: isInserted\r\n              ? `1px solid ${lockedBlocks[block.title]\r\n                ? isDarkMode\r\n                  ? 'rgba(16,124,16,0.1)'\r\n                  : '#eafaea'\r\n                : isEdited\r\n                  ? colours.highlightBlue\r\n                  : colours.highlightNeutral\r\n              }`\r\n              : `1px dashed ${colours.highlightBlue}`,\r\n            padding: isEdited ? '8px 10px' : '6px 8px',\r\n            borderRadius: 0,\r\n            fontSize: '13px',\r\n          })}\r\n        >\r\n          <ul style={{ margin: 0, paddingLeft: '20px' }}>\r\n            {selectedOptions.map((doc: string) => {\r\n              const option = block.options.find((o) => o.label === doc);\r\n              const preview = option ? option.previewText.trim() : doc;\r\n              const dynamicPreview = applyDynamicSubstitutions(\r\n                formatPreviewText(preview),\r\n                effectiveUserData,\r\n                enquiry,\r\n                amount,\r\n                dealPasscode,\r\n                undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n              );\r\n              return (\r\n                <li\r\n                  key={doc}\r\n                  style={{ marginBottom: 4 }}\r\n                  dangerouslySetInnerHTML={{\r\n                    __html: dynamicPreview,\r\n                  }}\r\n                ></li>\r\n              );\r\n            })}\r\n          </ul>\r\n        </div>\r\n      );\r\n    } else if (typeof selectedOptions === 'string') {\r\n      const option = block.options.find((o) => o.label === selectedOptions);\r\n      const preview = option ? option.previewText.trim() : '';\r\n      const dynamicPreviewText = applyDynamicSubstitutions(\r\n        formatPreviewText(preview),\r\n        effectiveUserData,\r\n        enquiry,\r\n        amount,\r\n        dealPasscode,\r\n        undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n      );\r\n      return (\r\n        <div\r\n          className={mergeStyles({\r\n            marginTop: '6px',\r\n            border: isInserted\r\n              ? `1px solid ${lockedBlocks[block.title]\r\n                ? isDarkMode\r\n                  ? 'rgba(16,124,16,0.1)'\r\n                  : '#eafaea'\r\n                : isEdited\r\n                  ? colours.highlightBlue\r\n                  : colours.highlightNeutral\r\n              }`\r\n              : `1px dashed ${colours.highlightBlue}`,\r\n            padding: isEdited ? '8px 10px' : '6px 8px',\r\n            borderRadius: 0,\r\n            fontSize: '13px',\r\n          })}\r\n        >\r\n          <span\r\n            dangerouslySetInnerHTML={{\r\n              __html: dynamicPreviewText,\r\n            }}\r\n          />\r\n        </div>\r\n      );\r\n    }\r\n    return null;\r\n  }\r\n\r\n  const DEFAULT_SINGLE_OPTION_BLOCKS = [\r\n    'Risk Assessment',\r\n    'Next Steps to Instruct Helix Law',\r\n    'Closing Notes',\r\n    'Closing',\r\n  ];\r\n\r\n  function autoInsertDefaultBlocks(\r\n    blocksToUse: TemplateBlock[] = templateBlocks,\r\n    currentSet: TemplateSet = templateSet,\r\n  ) {\r\n    if (currentSet !== 'Production') return;\r\n\r\n    blocksToUse.forEach((block) => {\r\n      if (EXTRACTED_BLOCKS.includes(block.title)) return; // handled separately now\r\n      if (\r\n        DEFAULT_SINGLE_OPTION_BLOCKS.includes(block.title) &&\r\n        block.options.length === 1\r\n      ) {\r\n        const autoOption = block.options[0].label;\r\n        setSelectedTemplateOptions((prev) => ({\r\n          ...prev,\r\n          [block.title]: block.isMultiSelect ? [autoOption] : autoOption,\r\n        }));\r\n        insertTemplateBlock(\r\n          block,\r\n          block.isMultiSelect ? [autoOption] : autoOption\r\n        );\r\n        setAutoInsertedBlocks(prev => ({ ...prev, [block.title]: true }));\r\n      }\r\n\r\n      if (\r\n        enquiry.Area_of_Work &&\r\n        (enquiry.Area_of_Work.toLowerCase() === 'commercial' ||\r\n          enquiry.Area_of_Work.toLowerCase() === 'property')\r\n      ) {\r\n        const autoMap: Record<string, string> = {\r\n          'Current Situation and Problem': 'The Dispute',\r\n          'Issue Summary': 'The Dispute',\r\n          'Scope of Work': 'Initial Review and Costs',\r\n          'Scope & Cost': 'Initial Review & Advice',\r\n          'Next Steps to Instruct Helix Law': 'Instruct Helix Law - Pitch',\r\n          'Next Steps': 'Instruct Helix Law - Pitch',\r\n          Closing: 'Closing',\r\n        };\r\n\r\n        const autoOptionLabel = autoMap[block.title];\r\n        const optionExists = autoOptionLabel\r\n          ? block.options.find((o) => o.label === autoOptionLabel)\r\n          : undefined;\r\n\r\n        if (optionExists) {\r\n          setSelectedTemplateOptions((prev) => ({\r\n            ...prev,\r\n            [block.title]: block.isMultiSelect ? [autoOptionLabel] : autoOptionLabel,\r\n          }));\r\n          insertTemplateBlock(\r\n            block,\r\n            block.isMultiSelect ? [autoOptionLabel] : autoOptionLabel\r\n          );\r\n          setAutoInsertedBlocks(prev => ({ ...prev, [block.title]: true }));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // Some styling\r\n  const containerStyle = mergeStyles({\r\n    padding: 0,\r\n    backgroundColor: 'transparent',\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    borderRadius: 0,\r\n    boxShadow: isDarkMode\r\n      ? '0 4px 12px rgba(255, 255, 255, 0.1)'\r\n      : '0 4px 12px rgba(0, 0, 0, 0.1)',\r\n    maxWidth: 1350,\r\n    width: '100%',\r\n    margin: '0 auto',\r\n    fontFamily: 'Raleway, sans-serif',\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n    gap: 0,\r\n    boxSizing: 'border-box',\r\n    flex: 1,\r\n    minHeight: 0,\r\n  });\r\n\r\n  const headerWrapperStyle = mergeStyles({\r\n    backgroundColor: 'transparent',\r\n    padding: 8,\r\n    borderBottom: `1px solid ${isDarkMode ? colours.dark.border : '#ddd'}`,\r\n  });\r\n\r\n  const bodyWrapperStyle = mergeStyles({\r\n    padding: 16,\r\n    backgroundColor: isDarkMode ? colours.dark.sectionBackground : colours.light.sectionBackground,\r\n    borderBottomLeftRadius: 0,\r\n    borderBottomRightRadius: 0,\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n    position: 'relative',\r\n  });\r\n\r\n  const formContainerStyle = mergeStyles({\r\n    flex: '1 1 0',\r\n    minWidth: '300px',\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n  });\r\n\r\n  const templatesContainerStyle = mergeStyles({\r\n    flex: '1 1 0',\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n    gap: '20px',\r\n    maxHeight: '100%',\r\n    overflowY: 'auto',\r\n  });\r\n\r\n  const templatesGridStyle = mergeStyles({\r\n    flex: 1,\r\n    overflowY: 'auto',\r\n    display: 'flex',\r\n    flexDirection: 'column',\r\n    gap: '20px',\r\n    maxHeight: '100%',\r\n  });\r\n\r\n  const buttonGroupStyle = mergeStyles({\r\n    gap: '15px',\r\n    marginTop: '20px',\r\n    width: '100%',\r\n  });\r\n\r\n  const enquiryDetailsStyle = mergeStyles({\r\n    background: isDarkMode ? colours.dark.sectionBackground : colours.light.sectionBackground,\r\n    borderRadius: 0,\r\n    padding: 16,\r\n    boxShadow: isDarkMode\r\n      ? `0 0 0 1px ${colours.dark.border}`\r\n      : `0 0 0 1px ${colours.light.border}`,\r\n  });\r\n\r\n\r\n  const toolbarStyle = mergeStyles({\r\n    display: 'flex',\r\n    gap: '10px',\r\n    marginBottom: '0',\r\n    backgroundColor: colours.darkBlue,\r\n    padding: '8px',\r\n    borderTopLeftRadius: '0',\r\n    borderTopRightRadius: '0',\r\n    border: `1px solid ${isDarkMode ? colours.dark.cardHover : colours.light.cardHover}`,\r\n    borderBottom: 'none',\r\n  });\r\n\r\n  const bubblesContainerStyle = mergeStyles({\r\n    display: 'flex',\r\n    flexWrap: 'wrap', // Allow bubbles to wrap to the next line\r\n    padding: '10px 0',\r\n    gap: '10px',\r\n  });\r\n\r\n  const bubbleStyle = mergeStyles({\r\n    padding: '8px 12px',\r\n    borderRadius: 0,\r\n    backgroundColor: isDarkMode ? colours.dark.cardBackground : colours.light.cardBackground,\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    cursor: 'pointer',\r\n    textAlign: 'center',\r\n    whiteSpace: 'nowrap',\r\n    userSelect: 'none',\r\n    flexShrink: 0,\r\n    width: 'auto',\r\n    ':hover': {\r\n      backgroundColor: isDarkMode ? colours.dark.cardHover : colours.light.cardHover,\r\n    },\r\n  });\r\n\r\n  const labelStyle = mergeStyles({\r\n    fontWeight: '600',\r\n    color: isDarkMode ? colours.dark.text : colours.light.text,\r\n    paddingTop: '20px',\r\n    paddingBottom: '5px',\r\n  });\r\n\r\n  // New style for greyed-out attachment bubbles\r\n  const attachmentBubbleStyle = mergeStyles({\r\n    padding: '8px 12px',\r\n    borderRadius: 0,\r\n    backgroundColor: isDarkMode\r\n      ? colours.dark.disabledBackground\r\n      : colours.light.disabledBackground,\r\n    color: colours.greyText,\r\n    cursor: 'default',\r\n    textAlign: 'center',\r\n    whiteSpace: 'nowrap',\r\n    userSelect: 'none',\r\n    flexShrink: 0,\r\n    width: 'auto',\r\n    border: `1px solid ${isDarkMode ? colours.dark.borderColor : colours.light.borderColor\r\n      }`,\r\n    ':hover': {\r\n      backgroundColor: isDarkMode\r\n        ? colours.dark.disabledBackground\r\n        : colours.light.disabledBackground,\r\n    },\r\n  });\r\n\r\n  const fullName = `${enquiry.First_Name || ''} ${enquiry.Last_Name || ''}`.trim();\r\n\r\n  function handleScrollToBlock(blockTitle: string) {\r\n    const headerElement = document.getElementById(\r\n      `template-block-header-${blockTitle.replace(/\\s+/g, '-')}`\r\n    ) as HTMLElement | null;\r\n    if (headerElement) {\r\n      headerElement.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n      const lockedBg = isDarkMode ? 'rgba(16,124,16,0.1)' : '#eafaea';\r\n      const startColor = lockedBlocks[blockTitle]\r\n        ? lockedBg\r\n        : Object.values(editedSnippets[blockTitle] || {}).some(Boolean)\r\n          ? colours.highlightBlue\r\n          : colours.highlightNeutral;\r\n      headerElement.style.transition = 'background-color 0.5s';\r\n      headerElement.style.backgroundColor = startColor;\r\n      setTimeout(() => {\r\n        headerElement.style.backgroundColor = 'transparent';\r\n      }, 1000);\r\n    }\r\n  }\r\n\r\n  const filteredAttachments = getFilteredAttachments();\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (suppressSaveRef.current) {\r\n        suppressSaveRef.current = false;\r\n        return;\r\n      }\r\n      const state = {\r\n        templateSet,\r\n        initialScopeDescription,\r\n        selectedOption,\r\n        amount,\r\n        subject,\r\n        to,\r\n        cc,\r\n        bcc,\r\n        body,\r\n        attachments,\r\n        followUp,\r\n        activeTab,\r\n        selectedTemplateOptions,\r\n        insertedBlocks,\r\n        autoInsertedBlocks,\r\n        lockedBlocks,\r\n        pinnedBlocks,\r\n        editedBlocks,\r\n        editedSnippets,\r\n        originalBlockContent,\r\n        originalSnippetContent,\r\n        hiddenBlocks,\r\n        blocks,\r\n        savedSnippets,\r\n        enquiryId: enquiry.ID,\r\n      };\r\n      const sections = Object.keys(insertedBlocks)\r\n        .filter((title) => insertedBlocks[title])\r\n        .map((title) => ({\r\n          block: title,\r\n          option: selectedTemplateOptions[title] || '',\r\n          content: savedSnippets[title] || '',\r\n        }));\r\n      if (sections.length > 0) {\r\n        fetch('/api/pitches', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            enquiryId: enquiry.ID,\r\n            sections,\r\n            user: userInitials,\r\n          }),\r\n        }).catch((err) => console.error('Failed to save pitch sections', err));\r\n      }\r\n      try {\r\n        localStorage.setItem('pitchBuilderState', JSON.stringify(state));\r\n      } catch (e) {\r\n        if (e instanceof DOMException && e.name === 'QuotaExceededError') {\r\n          // Try to trim large fields and retry\r\n          const trimmed = { ...state };\r\n          if (trimmed.attachments && Array.isArray(trimmed.attachments)) {\r\n            trimmed.attachments = [];\r\n          }\r\n          if (trimmed.body && typeof trimmed.body === 'string' && trimmed.body.length > 2000) {\r\n            trimmed.body = trimmed.body.slice(0, 2000) + '…';\r\n          }\r\n          try {\r\n            localStorage.setItem('pitchBuilderState', JSON.stringify(trimmed));\r\n          } catch (e2) {\r\n            // If still fails, clear the key and log error\r\n            localStorage.removeItem('pitchBuilderState');\r\n            // Optionally, surface a user notification here\r\n            console.error('PitchBuilder: Could not save state, storage quota exceeded and fallback failed.', e2);\r\n          }\r\n        } else {\r\n          throw e;\r\n        }\r\n      }\r\n    };\r\n  }, [\r\n    templateSet,\r\n    initialScopeDescription,\r\n    selectedOption,\r\n    amount,\r\n    subject,\r\n    to,\r\n    cc,\r\n    bcc,\r\n    body,\r\n    attachments,\r\n    followUp,\r\n    activeTab,\r\n    selectedTemplateOptions,\r\n    insertedBlocks,\r\n    autoInsertedBlocks,\r\n    lockedBlocks,\r\n    pinnedBlocks,\r\n    editedBlocks,\r\n    editedSnippets,\r\n    originalBlockContent,\r\n    originalSnippetContent,\r\n    hiddenBlocks,\r\n    blocks,\r\n    savedSnippets,\r\n  ]);\r\n\r\n  // Build combined HTML for a block's selected options\r\n  function buildSectionHtml(block: TemplateBlock, labels: string[]): string {\r\n    const parts: string[] = [];\r\n    labels.forEach(label => {\r\n      const opt = block.options.find(o => o.label === label);\r\n      if (!opt) return;\r\n      let raw = opt.previewText.trim();\r\n      raw = applyDynamicSubstitutions(\r\n        raw,\r\n        effectiveUserData,\r\n        enquiry,\r\n        amount,\r\n        dealPasscode,\r\n        undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n      );\r\n      raw = cleanTemplateString(raw);\r\n      const formatted = formatSectionContent(raw);\r\n      parts.push(`<div class=\\\"section-snippet\\\" data-label=\\\"${label.replace(/\"/g, '&quot;')}\\\">${formatted}</div>`);\r\n    });\r\n    return parts.join('<br /><br />');\r\n  }\r\n\r\n  // Produce high-quality HTML paragraphs, preserve lists, highlight unresolved placeholders.\r\n  function formatSectionContent(raw: string): string {\r\n    // Normalise line endings\r\n    let text = raw.replace(/\\r\\n?/g, '\\n').trim();\r\n    // Split into paragraphs on double newline\r\n    const paragraphs = text.split(/\\n{2,}/).map(p => p.trim()).filter(Boolean);\r\n    const html = paragraphs.map(p => {\r\n      // Preserve basic markdown-like bullets -> convert to <ul>\r\n      if (/^(?:[-*] |\\d+\\. )/m.test(p)) {\r\n        const lines = p.split(/\\n/).map(l => l.trim()).filter(Boolean);\r\n        if (lines.every(l => /^[-*] /.test(l))) {\r\n          const items = lines.map(l => `<li>${escapeHtml(l.replace(/^[-*] /, ''))}</li>`).join('');\r\n          return `<ul style=\\\"margin:0 0 12px 20px; padding:0;\\\">${items}</ul>`;\r\n        }\r\n        if (lines.every(l => /^\\d+\\. /.test(l))) {\r\n          const items = lines.map(l => `<li>${escapeHtml(l.replace(/^\\d+\\. /, ''))}</li>`).join('');\r\n          return `<ol style=\\\"margin:0 0 12px 20px; padding:0;\\\">${items}</ol>`;\r\n        }\r\n      }\r\n      // Inline line breaks\r\n      const withBreaks = p.split(/\\n/).map(l => escapeHtml(l)).join('<br />');\r\n      return `<p style=\\\"margin:0 0 12px; line-height:1.5;\\\">${withBreaks}</p>`;\r\n    }).join('');\r\n    const wrapped = wrapInsertPlaceholders(html);\r\n    return highlightUnresolvedPlaceholders(wrapped);\r\n  }\r\n\r\n  function escapeHtml(str: string): string {\r\n    return str\r\n      .replace(/&/g, '&amp;')\r\n      .replace(/</g, '&lt;')\r\n      .replace(/>/g, '&gt;')\r\n      .replace(/\"/g, '&quot;')\r\n      .replace(/'/g, '&#39;');\r\n  }\r\n\r\n  // Highlight placeholders that remain (not substituted) with a subtle background\r\n  function highlightUnresolvedPlaceholders(html: string): string {\r\n    return html.replace(/\\[(?:[A-Za-z0-9_. ]+)\\]/g, match => `<span style=\\\"background:#fff3cd;border:1px dotted #e0c46c;padding:0 2px;\\\" data-unresolved-placeholder>${match}</span>`);\r\n  }\r\n\r\n  // Rebuild body injecting extracted block sections (with markers) after greeting\r\n  function rebuildBodyWithSections(base: string, sections: Record<string, string>): string {\r\n    // Strip existing markers first\r\n    let cleaned = base.replace(/<!--BLOCK_START:[^>]+-->([\\s\\S]*?)<!--BLOCK_END:[^>]+-->/g, '').trim();\r\n    const splitIndex = cleaned.indexOf('\\n\\n');\r\n    let greeting = cleaned;\r\n    let rest = '';\r\n    if (splitIndex !== -1) {\r\n      greeting = cleaned.substring(0, splitIndex);\r\n      rest = cleaned.substring(splitIndex + 2);\r\n    }\r\n    const ordered = EXTRACTED_BLOCKS.filter(t => sections[t]);\r\n    const sectionHtml = ordered.map(title => `<!--BLOCK_START:${title}--><div data-extracted-block=\"${title}\">${sections[title]}</div><!--BLOCK_END:${title}-->`).join('\\n\\n');\r\n    return `${greeting}\\n\\n${sectionHtml ? sectionHtml + '\\n\\n' : ''}${rest}`.trim();\r\n  }\r\n\r\n  function handleToggleOption(block: TemplateBlock, optionLabel: string) {\r\n    setSectionSelections(prev => {\r\n      const current = prev[block.title] || [];\r\n      let next: string[];\r\n      if (block.isMultiSelect) {\r\n        next = current.includes(optionLabel)\r\n          ? current.filter(l => l !== optionLabel)\r\n          : [...current, optionLabel];\r\n      } else {\r\n        next = [optionLabel];\r\n      }\r\n      // Build HTML & update content/state + body\r\n      const html = buildSectionHtml(block, next);\r\n      setSectionContent(sc => {\r\n        const updated = { ...sc };\r\n        if (next.length === 0) delete updated[block.title]; else updated[block.title] = html;\r\n        // After updating content, rebuild body\r\n        setBodyInternal(prevBody => rebuildBodyWithSections(prevBody, updated));\r\n        return updated;\r\n      });\r\n      return { ...prev, [block.title]: next };\r\n    });\r\n  }\r\n\r\n  function handleSectionContentEdit(blockTitle: string, html: string) {\r\n    setSectionContent(prev => {\r\n      // Clean editing artifacts (e.g., <div><br></div>) & re-format\r\n      const cleaned = html\r\n        .replace(/<div><br\\s*\\/?><\\/div>/g, '')\r\n        .replace(/<div>([\\s\\S]*?)<\\/div>/g, (m, inner) => inner.includes('<p') || inner.includes('<ul') ? m : inner + '<br />');\r\n      const formatted = highlightUnresolvedPlaceholders(wrapInsertPlaceholders(cleaned));\r\n      const updated = { ...prev, [blockTitle]: formatted };\r\n      setBodyInternal(prevBody => rebuildBodyWithSections(prevBody, updated));\r\n      return updated;\r\n    });\r\n  }\r\n\r\n  return (\r\n    <Stack className={containerStyle}>\r\n      {/* Client Info Header - Navigator Integrated */}\r\n      <div style={{ \r\n        padding: '12px 20px', \r\n        borderBottom: `1px solid ${isDarkMode ? colours.dark.border : '#e1e4e8'}`,\r\n        background: isDarkMode ? colours.dark.sectionBackground : colours.light.sectionBackground\r\n      }}>\r\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap' }}>\r\n          {/* Integrated verification & client header */}\r\n          <div style={{ flex: 1, minWidth: 280 }}>\r\n            <VerificationSummary\r\n              isDarkMode={isDarkMode}\r\n              userData={effectiveUserData}\r\n              enquiry={enquiry}\r\n              amount={amount}\r\n              passcode={dealPasscode}\r\n              usedPitchRoute={usedPitchRoute}\r\n              onPreview={(url) => {\r\n                try {\r\n                  window.open(url, '_blank', 'noopener');\r\n                } catch (_) {\r\n                  // no-op fallback\r\n                }\r\n              }}\r\n            />\r\n          </div>\r\n\r\n        </div>\r\n      </div>\r\n\r\n      <main className={bodyWrapperStyle}>\r\n        {/* Content Sections - Streamlined */}\r\n        {EXTRACTED_BLOCKS.length > 0 && (\r\n          <div>\r\n            {EXTRACTED_BLOCKS.map(title => {\r\n              const block = blocks.find(b => b.title === title);\r\n              if (!block) return null;\r\n              const selections = sectionSelections[title] || [];\r\n              const content = sectionContent[title];\r\n              return (\r\n                <div key={title} style={{\r\n                  marginBottom: 16,\r\n                  background: isDarkMode ? colours.dark.cardBackground : '#ffffff',\r\n                  border: `1px solid ${isDarkMode ? colours.dark.border : '#e1e4e8'}`,\r\n                  borderRadius: 8,\r\n                  padding: 16,\r\n                  boxShadow: '0 1px 3px rgba(0,0,0,0.04)'\r\n                }}>\r\n                  {/* Section header removed as requested */}\r\n                  <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginBottom: 12 }}>\r\n                    {block.options.map(opt => {\r\n                      const selected = selections.includes(opt.label);\r\n                      return (\r\n                        <button\r\n                          key={opt.label}\r\n                          onClick={() => handleToggleOption(block, opt.label)}\r\n                          style={{\r\n                            border: selected ? `2px solid ${colours.blue}` : `1px solid ${isDarkMode ? colours.dark.border : '#d0d7de'}`,\r\n                            background: selected ? colours.highlightBlue : (isDarkMode ? colours.dark.inputBackground : '#f8f9fa'),\r\n                            color: selected ? colours.darkBlue : (isDarkMode ? colours.dark.text : colours.light.text),\r\n                            padding: '8px 12px',\r\n                            borderRadius: 6,\r\n                            cursor: 'pointer',\r\n                            fontSize: 12,\r\n                            fontWeight: selected ? 600 : 400,\r\n                            maxWidth: 240,\r\n                            textAlign: 'left',\r\n                            position: 'relative',\r\n                            transition: 'all 0.2s ease'\r\n                          }}\r\n                          title={opt.previewText.split('\\n').slice(0, 3).join(' ')}\r\n                        >\r\n                          {opt.label}\r\n                          {selected && <span style={{ position: 'absolute', top: 2, right: 4, fontSize: 10, color: colours.blue }}>✓</span>}\r\n                        </button>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                  {selections.length === 0 && (\r\n                    <div style={{ fontSize: 11, color: isDarkMode ? colours.dark.text : '#888' }}>\r\n                      Select option{block.isMultiSelect ? 's' : ''} to include this section.\r\n                    </div>\r\n                  )}\r\n                  {selections.length > 0 && (\r\n                    <div>\r\n                      <div style={{ fontSize: 11, fontWeight: 600, margin: '8px 0 4px 0', color: colours.darkBlue }}>\r\n                        Preview:\r\n                      </div>\r\n                      <div\r\n                        contentEditable\r\n                        suppressContentEditableWarning\r\n                        onBlur={e => handleSectionContentEdit(title, (e.target as HTMLElement).innerHTML)}\r\n                        style={{\r\n                          border: `1px solid ${isDarkMode ? colours.dark.border : '#d0d7de'}`,\r\n                          padding: '10px 12px',\r\n                          fontSize: 13,\r\n                          lineHeight: 1.5,\r\n                          background: isDarkMode ? colours.dark.inputBackground : '#fafbfc',\r\n                          minHeight: 60,\r\n                          cursor: 'text',\r\n                          boxShadow: 'inset 0 1px 2px rgba(0,0,0,0.04)',\r\n                          borderRadius: 6\r\n                        }}\r\n                        dangerouslySetInnerHTML={{ __html: content || buildSectionHtml(block, selections) }}\r\n                      />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        )}\r\n        {/* Summary/Overview Section: Instruction, Deal, and Risk/Compliance Cards */}\r\n\r\n        {/* Row: Combined Email Editor and Template Blocks */}\r\n        <EditorAndTemplateBlocks\r\n          isDarkMode={isDarkMode}\r\n          body={body}\r\n          setBody={setBodyForComponents}\r\n          templateBlocks={blocks.filter(b => !EXTRACTED_BLOCKS.includes(b.title))}\r\n          selectedTemplateOptions={selectedTemplateOptions}\r\n          insertedBlocks={insertedBlocks}\r\n          lockedBlocks={lockedBlocks}\r\n          editedBlocks={editedBlocks}\r\n          handleMultiSelectChange={handleMultiSelectChange}\r\n          handleSingleSelectChange={handleSingleSelectChange}\r\n          insertTemplateBlock={insertTemplateBlock}\r\n          renderPreview={renderPreview}\r\n          applyFormat={applyFormat}\r\n          saveSelection={saveSelection}\r\n          handleInput={handleInput}\r\n          handleBlur={handleBlur}\r\n          handleClearBlock={handleClearBlock}\r\n          bodyEditorRef={bodyEditorRef}\r\n          toolbarStyle={toolbarStyle}\r\n          bubblesContainerStyle={bubblesContainerStyle}\r\n          saveCustomSnippet={saveCustomSnippet}\r\n          markBlockAsEdited={(blockTitle, edited) =>\r\n            setEditedBlocks((prev) => ({ ...prev, [blockTitle]: edited }))\r\n          }\r\n          initialNotes={enquiry.Initial_first_call_notes}\r\n          subject={subject}\r\n          setSubject={setSubject}\r\n          // Deal capture props (always enabled)\r\n          initialScopeDescription={initialScopeDescription}\r\n          onScopeDescriptionChange={setInitialScopeDescription}\r\n          amount={amount}\r\n          onAmountChange={handleAmountChange}\r\n          // Inline preview props\r\n          userData={effectiveUserData}\r\n          enquiry={enquiry}\r\n          passcode={dealPasscode}\r\n          handleDraftEmail={handleDraftEmail}\r\n          sendEmail={sendEmail}\r\n          isDraftConfirmed={isDraftConfirmed}\r\n          // Email recipient props for send confirmation\r\n          to={to}\r\n          cc={cc}\r\n          bcc={bcc}\r\n          feeEarnerEmail={userEmailAddress}\r\n          // Inline status feedback\r\n          dealCreationInProgress={dealCreationInProgress}\r\n          dealStatus={dealStatus}\r\n          emailStatus={emailStatus}\r\n          emailMessage={emailMessage}\r\n        />\r\n\r\n        {snippetOptionsBlock && snippetOptionsTarget && (\r\n          <Callout\r\n            className=\"inline-options-callout\"\r\n            target={snippetOptionsTarget}\r\n            onDismiss={closeSnippetOptions}\r\n            setInitialFocus={false}\r\n            directionalHint={DirectionalHint.bottomLeftEdge}\r\n            directionalHintFixed\r\n            styles={{\r\n              root: {\r\n                padding: 8,\r\n                borderRadius: 0,\r\n                boxShadow: '0 4px 16px rgba(0,0,0,0.2)',\r\n                backgroundColor: isDarkMode ? colours.dark.inputBackground : '#ffffff',\r\n                animation: 'fadeInScale 0.2s ease',\r\n              },\r\n            }}\r\n          >\r\n            <FocusZone direction={FocusZoneDirection.vertical} isCircularNavigation>\r\n              <ChoiceGroup\r\n                selectedKey={snippetOptionsLabel}\r\n                onChange={(_e, opt?: IChoiceGroupOption) => {\r\n                  if (!opt || !snippetOptionsBlock) return;\r\n                  replaceSnippetOption(\r\n                    snippetOptionsBlock,\r\n                    snippetOptionsLabel,\r\n                    opt.key as string\r\n                  );\r\n                  closeSnippetOptions();\r\n                }}\r\n                options={\r\n                  snippetOptionsBlock.options.map((o) => {\r\n                    const renderLabel = (\r\n                      option?: IChoiceGroupOption,\r\n                      defaultRender?: (option?: IChoiceGroupOption) => JSX.Element | null\r\n                    ) => {\r\n                      if (!option) return null;\r\n                      const preview = applyDynamicSubstitutions(\r\n                        snippetOptionsBlock.options.find((opt) => opt.label === option.key)?.previewText.replace(/\\n/g, '<br />') || '',\r\n                        userData,\r\n                        enquiry,\r\n                        amount,\r\n                        dealPasscode,\r\n                        undefined // Let applyDynamicSubstitutions construct URL with passcode\r\n                      );\r\n                      const isSelected = snippetOptionsLabel === option.key;\r\n                      return (\r\n                        <Stack\r\n                          tokens={{ childrenGap: 2 }}\r\n                          onMouseEnter={() => setHoveredOption(option.key as string)}\r\n                          onMouseLeave={() => setHoveredOption(null)}\r\n                        >\r\n                          {defaultRender ? defaultRender(option) : option.text}\r\n                          {(hoveredOption === option.key || isSelected) && (\r\n                            <span className=\"option-preview\" dangerouslySetInnerHTML={{ __html: preview }} />\r\n                          )}\r\n                        </Stack>\r\n                      );\r\n                    };\r\n\r\n                    return {\r\n                      key: o.label,\r\n                      text: o.label,\r\n                      onRenderLabel: renderLabel,\r\n                    } as IChoiceGroupOption;\r\n                  })\r\n                }\r\n                styles={{ flexContainer: { display: 'flex', flexDirection: 'column' } }}\r\n              />\r\n            </FocusZone>\r\n          </Callout>\r\n        )}\r\n\r\n        {removeConfirm && (\r\n          <Callout\r\n            target={removeConfirm.target ?? removeConfirm.point ?? undefined}\r\n            onDismiss={() => setRemoveConfirm(null)}\r\n            setInitialFocus\r\n            directionalHint={DirectionalHint.bottomLeftEdge}\r\n            directionalHintFixed\r\n          >\r\n            <Stack tokens={{ childrenGap: 8 }} styles={{ root: { padding: 12 } }}>\r\n              <Text>Clear this content?</Text>\r\n              <Stack horizontal tokens={{ childrenGap: 8 }} horizontalAlign=\"end\">\r\n                <PrimaryButton\r\n                  text=\"Clear\"\r\n                  styles={sharedPrimaryButtonStyles}\r\n                  onClick={(e) => {\r\n                    e.stopPropagation();\r\n                    if (removeConfirm.option) {\r\n                      removeBlockOption(removeConfirm.block, removeConfirm.option);\r\n                    } else {\r\n                      handleClearBlock(removeConfirm.block);\r\n                    }\r\n                    setRemoveConfirm(null);\r\n                  }}\r\n                />\r\n                <DefaultButton\r\n                  text=\"Cancel\"\r\n                  styles={sharedDefaultButtonStyles}\r\n                  onClick={(e) => {\r\n                    e.stopPropagation();\r\n                    setRemoveConfirm(null);\r\n                  }}\r\n                />\r\n              </Stack>\r\n            </Stack>\r\n          </Callout>\r\n        )}\r\n\r\n        {placeholderEdit && (\r\n          <PlaceholderEditorPopover\r\n            target={placeholderEdit.target}\r\n            initialText={placeholderEdit.text}\r\n            before={placeholderEdit.before}\r\n            after={placeholderEdit.after}\r\n            onAddOption={(text) => {\r\n              setSnippetEdit({\r\n                blockTitle: placeholderEdit.blockTitle || '',\r\n                target: placeholderEdit.target,\r\n                placeholder: placeholderEdit.placeholder,\r\n              });\r\n              setPendingOptionText(text);\r\n            }}\r\n            onDismiss={() => setPlaceholderEdit(null)}\r\n            onSave={(val) => {\r\n              const span = placeholderEdit.span;\r\n              const editor = bodyEditorRef.current;\r\n              \r\n              if (!editor) {\r\n                setPlaceholderEdit(null);\r\n                return;\r\n              }\r\n              \r\n              // Store cursor position relative to the span\r\n              const selection = window.getSelection();\r\n              const range = document.createRange();\r\n              \r\n              // Create a clean text node replacement\r\n              const textNode = document.createTextNode(val);\r\n              \r\n              // Replace the span with the text node\r\n              span.replaceWith(textNode);\r\n              \r\n              // If this was the very last element, ensure it doesn't get re-processed\r\n              const lastChild = editor.lastChild;\r\n              if (lastChild === textNode || \r\n                  (lastChild && lastChild.nodeType === Node.TEXT_NODE && \r\n                   lastChild.textContent === val)) {\r\n                // Add an invisible zero-width space to prevent contentEditable from\r\n                // converting the last text node back to HTML\r\n                const protectiveSpace = document.createTextNode('\\u200B');\r\n                editor.appendChild(protectiveSpace);\r\n              }\r\n              \r\n              // Update the body content\r\n              setBody(editor.innerHTML);\r\n              setPlaceholderEdit(null);\r\n              \r\n              // Restore cursor position after the inserted text\r\n              if (selection) {\r\n                range.setStartAfter(textNode);\r\n                range.setEndAfter(textNode);\r\n                selection.removeAllRanges();\r\n                selection.addRange(range);\r\n              }\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {snippetEdit && (\r\n          <SnippetEditPopover\r\n            target={snippetEdit.target}\r\n            onDismiss={() => {\r\n              setSnippetEdit(null);\r\n              setPendingOptionText('');\r\n            }}\r\n            onSave={({ label, sortOrder, isNew }) => {\r\n              submitPlaceholderOption(\r\n                snippetEdit.blockTitle,\r\n                pendingOptionText,\r\n                snippetEdit.placeholder,\r\n                label,\r\n                sortOrder,\r\n                isNew\r\n              );\r\n              setSnippetEdit(null);\r\n              setPendingOptionText('');\r\n            }} originalText={''} editedText={''} />\r\n        )}\r\n\r\n\r\n\r\n        <OperationStatusToast\r\n          visible={toast !== null}\r\n          message={toast?.message || ''}\r\n          type={toast?.type || 'info'}\r\n          loading={toast?.loading}\r\n          details={toast?.details}\r\n          progress={toast?.progress}\r\n          icon={toast?.icon}\r\n        />\r\n      </main>\r\n\r\n      {showDataInspector && (\r\n        <PitchDebugPanel\r\n          calls={apiCalls}\r\n          onClear={clearApiCalls}\r\n          collapsed={debugCollapsed}\r\n          onToggle={() => setDebugCollapsed((v) => !v)}\r\n        />\r\n      )}\r\n    </Stack>\r\n  );\r\n\r\n};\r\n\r\nexport default PitchBuilder;","import { useEffect, useRef, useState } from 'react';\r\n\r\nexport interface ApiCallLog {\r\n  id: string;\r\n  ts: Date;\r\n  url: string;\r\n  method: string;\r\n  status?: number;\r\n  durationMs: number;\r\n  data?: string;\r\n  snippet?: string;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Intercepts window.fetch locally (localhost only) and records metadata + a small response snippet.\r\n * Restores original fetch when disabled/unmounted.\r\n */\r\nexport function useLocalFetchLogger(enabled: boolean) {\r\n  const [apiCalls, setApiCalls] = useState<ApiCallLog[]>([]);\r\n  const originalFetchRef = useRef<typeof window.fetch | null>(null);\r\n\r\n  const clear = () => setApiCalls([]);\r\n\r\n  useEffect(() => {\r\n    if (!enabled) {\r\n      if (originalFetchRef.current) {\r\n        window.fetch = originalFetchRef.current;\r\n        originalFetchRef.current = null;\r\n      }\r\n      return;\r\n    }\r\n    if (originalFetchRef.current) return; // already patched\r\n\r\n    originalFetchRef.current = window.fetch;\r\n    const makeId = () => Math.random().toString(36).slice(2, 11);\r\n    window.fetch = async (input: RequestInfo | URL, init?: RequestInit) => {\r\n      const start = performance.now();\r\n      const url = typeof input === 'string' ? input : (input as Request).url;\r\n      const method = (init && init.method) || (typeof input !== 'string' && (input as Request).method) || 'GET';\r\n      try {\r\n        const res = await (originalFetchRef.current as any)(input, init);\r\n        const durationMs = performance.now() - start;\r\n        let data = '';\r\n        try {\r\n          const clone = res.clone();\r\n          data = await clone.text();\r\n        } catch {/* ignore */}\r\n        setApiCalls(prev => [...prev, { id: makeId(), ts: new Date(), url, method, status: res.status, durationMs, data }]);\r\n        return res;\r\n      } catch (err) {\r\n        const durationMs = performance.now() - start;\r\n        setApiCalls(prev => [...prev, { id: makeId(), ts: new Date(), url, method, status: -1, durationMs, error: (err as Error).message }]);\r\n        throw err;\r\n      }\r\n    };\r\n\r\n    return () => {\r\n      if (originalFetchRef.current) {\r\n        window.fetch = originalFetchRef.current;\r\n        originalFetchRef.current = null;\r\n      }\r\n    };\r\n  }, [enabled]);\r\n\r\n  return { apiCalls, clear } as const;\r\n}\r\n","import React from 'react';\r\nimport { Enquiry } from '../../app/functionality/types';\r\nimport { Stack, Text, MessageBar, MessageBarType } from '@fluentui/react';\r\nimport { FaPhone, FaInfoCircle } from 'react-icons/fa';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport { colours } from '../../app/styles/colours';\r\n\r\ninterface EnquiryCallsProps {\r\n    enquiry: Enquiry;\r\n}\r\n\r\nconst EnquiryCalls: React.FC<EnquiryCallsProps> = ({ enquiry }) => {\r\n    const { isDarkMode } = useTheme();\r\n    \r\n    return (\r\n        <Stack tokens={{ childrenGap: 20 }} style={{ padding: '20px' }}>\r\n            <Stack horizontal verticalAlign=\"center\" tokens={{ childrenGap: 12 }}>\r\n                <FaPhone style={{ \r\n                    color: isDarkMode ? colours.dark.iconColor : colours.light.iconColor,\r\n                    fontSize: '18px'\r\n                }} />\r\n                <Text variant=\"xLarge\" styles={{\r\n                    root: {\r\n                        fontWeight: '600',\r\n                        color: isDarkMode ? colours.dark.text : colours.light.text\r\n                    }\r\n                }}>\r\n                    Call History\r\n                </Text>\r\n            </Stack>\r\n            \r\n            <MessageBar messageBarType={MessageBarType.info}>\r\n                <Stack horizontal verticalAlign=\"center\" tokens={{ childrenGap: 8 }}>\r\n                    <FaInfoCircle />\r\n                    <Text>Call tracking is enabled in local development. CallRail integration coming soon.</Text>\r\n                </Stack>\r\n            </MessageBar>\r\n            \r\n            <Stack style={{ \r\n                padding: '16px',\r\n                backgroundColor: isDarkMode ? colours.dark.cardBackground : colours.light.cardBackground,\r\n                borderRadius: '8px',\r\n                border: `1px solid ${isDarkMode ? colours.dark.border : colours.light.border}`\r\n            }}>\r\n                <Text variant=\"medium\" styles={{\r\n                    root: {\r\n                        color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n                        fontStyle: 'italic'\r\n                    }\r\n                }}>\r\n                    Enquiry ID: {enquiry.ID}\r\n                </Text>\r\n                <Text variant=\"medium\" styles={{\r\n                    root: {\r\n                        color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n                        marginTop: '8px'\r\n                    }\r\n                }}>\r\n                    This section will display call recordings, notes, and call analytics when CallRail integration is implemented.\r\n                </Text>\r\n            </Stack>\r\n        </Stack>\r\n    );\r\n};\r\n\r\nexport default EnquiryCalls;","import React, { useEffect, useState } from 'react';\r\nimport { Enquiry } from '../../app/functionality/types';\r\nimport { Stack, Text, Spinner, MessageBar, MessageBarType } from '@fluentui/react';\r\nimport { FaEnvelope, FaInfoCircle } from 'react-icons/fa';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport { colours } from '../../app/styles/colours';\r\n\r\ninterface EmailRecord {\r\n    [key: string]: any;\r\n}\r\n\r\ninterface EnquiryEmailsProps {\r\n    enquiry: Enquiry;\r\n}\r\n\r\nconst EnquiryEmails: React.FC<EnquiryEmailsProps> = ({ enquiry }) => {\r\n    const [emails, setEmails] = useState<EmailRecord[]>([]);\r\n    const [loading, setLoading] = useState<boolean>(true);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const { isDarkMode } = useTheme();\r\n\r\n    useEffect(() => {\r\n        const fetchEmails = async () => {\r\n            try {\r\n                const resp = await fetch(`/api/enquiry-emails/${enquiry.ID}`);\r\n                if (!resp.ok) {\r\n                    throw new Error('Failed to fetch emails');\r\n                }\r\n                const data = await resp.json();\r\n                setEmails(data.emails || data);\r\n            } catch (err) {\r\n                console.error('Error loading enquiry emails', err);\r\n                setError('Failed to load emails');\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        };\r\n        fetchEmails();\r\n    }, [enquiry.ID]);\r\n\r\n    if (loading) {\r\n        return (\r\n            <Stack tokens={{ childrenGap: 20 }} style={{ padding: '20px' }}>\r\n                <Stack horizontal verticalAlign=\"center\" tokens={{ childrenGap: 12 }}>\r\n                    <FaEnvelope style={{ \r\n                        color: isDarkMode ? colours.dark.iconColor : colours.light.iconColor,\r\n                        fontSize: '18px'\r\n                    }} />\r\n                    <Text variant=\"xLarge\" styles={{\r\n                        root: {\r\n                            fontWeight: '600',\r\n                            color: isDarkMode ? colours.dark.text : colours.light.text\r\n                        }\r\n                    }}>\r\n                        Email History\r\n                    </Text>\r\n                </Stack>\r\n                <Spinner label=\"Loading emails...\" />\r\n            </Stack>\r\n        );\r\n    }\r\n\r\n    if (error) {\r\n        return (\r\n            <Stack tokens={{ childrenGap: 20 }} style={{ padding: '20px' }}>\r\n                <Stack horizontal verticalAlign=\"center\" tokens={{ childrenGap: 12 }}>\r\n                    <FaEnvelope style={{ \r\n                        color: isDarkMode ? colours.dark.iconColor : colours.light.iconColor,\r\n                        fontSize: '18px'\r\n                    }} />\r\n                    <Text variant=\"xLarge\" styles={{\r\n                        root: {\r\n                            fontWeight: '600',\r\n                            color: isDarkMode ? colours.dark.text : colours.light.text\r\n                        }\r\n                    }}>\r\n                        Email History\r\n                    </Text>\r\n                </Stack>\r\n                <MessageBar messageBarType={MessageBarType.error}>\r\n                    <Text>{error}</Text>\r\n                </MessageBar>\r\n            </Stack>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <Stack tokens={{ childrenGap: 20 }} style={{ padding: '20px' }}>\r\n            <Stack horizontal verticalAlign=\"center\" tokens={{ childrenGap: 12 }}>\r\n                <FaEnvelope style={{ \r\n                    color: isDarkMode ? colours.dark.iconColor : colours.light.iconColor,\r\n                    fontSize: '18px'\r\n                }} />\r\n                <Text variant=\"xLarge\" styles={{\r\n                    root: {\r\n                        fontWeight: '600',\r\n                        color: isDarkMode ? colours.dark.text : colours.light.text\r\n                    }\r\n                }}>\r\n                    Email History\r\n                </Text>\r\n            </Stack>\r\n            \r\n            <MessageBar messageBarType={MessageBarType.info}>\r\n                <Stack horizontal verticalAlign=\"center\" tokens={{ childrenGap: 8 }}>\r\n                    <FaInfoCircle />\r\n                    <Text>Email tracking is enabled in local development. Enhanced email analytics coming soon.</Text>\r\n                </Stack>\r\n            </MessageBar>\r\n            \r\n            {emails.length === 0 ? (\r\n                <Stack style={{ \r\n                    padding: '16px',\r\n                    backgroundColor: isDarkMode ? colours.dark.cardBackground : colours.light.cardBackground,\r\n                    borderRadius: '8px',\r\n                    border: `1px solid ${isDarkMode ? colours.dark.border : colours.light.border}`\r\n                }}>\r\n                    <Text variant=\"medium\" styles={{\r\n                        root: {\r\n                            color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n                            fontStyle: 'italic'\r\n                        }\r\n                    }}>\r\n                        No emails found for enquiry {enquiry.ID}\r\n                    </Text>\r\n                </Stack>\r\n            ) : (\r\n                <Stack tokens={{ childrenGap: 12 }}>\r\n                    {emails.map((email, idx) => (\r\n                        <Stack key={idx} style={{ \r\n                            padding: '16px',\r\n                            backgroundColor: isDarkMode ? colours.dark.cardBackground : colours.light.cardBackground,\r\n                            borderRadius: '8px',\r\n                            border: `1px solid ${isDarkMode ? colours.dark.border : colours.light.border}`\r\n                        }} tokens={{ childrenGap: 8 }}>\r\n                            <Text variant=\"mediumPlus\" styles={{\r\n                                root: {\r\n                                    fontWeight: '600',\r\n                                    color: isDarkMode ? colours.dark.text : colours.light.text\r\n                                }\r\n                            }}>\r\n                                {email.Subject || email.subject || 'No subject'}\r\n                            </Text>\r\n                            {email.Body && (\r\n                                <Text variant=\"medium\" styles={{\r\n                                    root: {\r\n                                        color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n                                        whiteSpace: 'pre-wrap'\r\n                                    }\r\n                                }}>\r\n                                    {email.Body}\r\n                                </Text>\r\n                            )}\r\n                        </Stack>\r\n                    ))}\r\n                </Stack>\r\n            )}\r\n        </Stack>\r\n    );\r\n};\r\n\r\nexport default EnquiryEmails;\r\n","\r\n// Clean admin tools - removed beaker and legacy toggle\r\nimport React, { useState, useMemo, useCallback, useEffect, useRef } from 'react';\r\nimport { getProxyBaseUrl } from '../../utils/getProxyBaseUrl';\r\nimport {\r\n  Stack,\r\n  Text,\r\n  Icon,\r\n  mergeStyles,\r\n  MessageBar,\r\n  MessageBarType,\r\n  Link,\r\n  IconButton,\r\n  PrimaryButton,\r\n  DefaultButton,\r\n  Modal,\r\n  initializeIcons,\r\n} from '@fluentui/react';\r\nimport IconAreaFilter from '../../components/filter/IconAreaFilter';\r\nimport {\r\n  BarChart,\r\n  Bar,\r\n  CartesianGrid,\r\n// invisible change\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  Legend,\r\n  LabelList,\r\n  XAxis,\r\n  YAxis,\r\n} from 'recharts';\r\n// Search UI\r\nimport { SearchBox } from '@fluentui/react';\r\nimport { sharedSearchBoxContainerStyle, sharedSearchBoxStyle } from '../../app/styles/FilterStyles';\r\nimport { parseISO, startOfMonth, format, isValid } from 'date-fns';\r\nimport { Enquiry, POID, UserData, TeamData } from '../../app/functionality/types';\r\nimport EnquiryLineItem from './EnquiryLineItem';\r\nimport NewUnclaimedEnquiryCard from './NewUnclaimedEnquiryCard';\r\nimport ClaimedEnquiryCard from './ClaimedEnquiryCard';\r\nimport GroupedEnquiryCard from './GroupedEnquiryCard';\r\nimport { GroupedEnquiry, getMixedEnquiryDisplay, isGroupedEnquiry } from './enquiryGrouping';\r\nimport PitchBuilder from './PitchBuilder';\r\nimport EnquiryCalls from './EnquiryCalls';\r\nimport EnquiryEmails from './EnquiryEmails';\r\nimport { colours } from '../../app/styles/colours';\r\nimport SegmentedControl from '../../components/filter/SegmentedControl';\r\nimport { isAdminUser, hasInstructionsAccess } from '../../app/admin';\r\nimport { useTheme } from '../../app/functionality/ThemeContext';\r\nimport { useNavigatorActions } from '../../app/functionality/NavigatorContext';\r\nimport UnclaimedEnquiries from './UnclaimedEnquiries';\r\nimport FilterBanner from '../../components/filter/FilterBanner';\r\nimport { Context as TeamsContextType } from '@microsoft/teams-js';\r\nimport AreaCountCard from './AreaCountCard';\r\nimport 'rc-slider/assets/index.css';\r\nimport '../../app/styles/NavigatorPivot.css';\r\nimport Slider from 'rc-slider';\r\nimport { debugLog, debugWarn } from '../../utils/debug';\r\n  // Subtle Helix watermark generator – three rounded ribbons rotated slightly\r\n  const helixWatermarkSvg = (dark: boolean) => {\r\n    const fill = dark ? '%23FFFFFF' : '%23061733';\r\n    const opacity = dark ? '0.06' : '0.035';\r\n    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='900' height='900' viewBox='0 0 900 900'>\r\n      <g transform='rotate(-12 450 450)'>\r\n        <path d='M160 242 C160 226 176 210 200 210 L560 210 Q640 235 560 274 L200 274 C176 274 160 258 160 242 Z' fill='${fill}' fill-opacity='${opacity}'/>\r\n        <path d='M160 362 C160 346 176 330 200 330 L560 330 Q640 355 560 394 L200 394 C176 394 160 378 160 362 Z' fill='${fill}' fill-opacity='${opacity}'/>\r\n        <path d='M160 482 C160 466 176 450 200 450 L560 450 Q640 475 560 514 L200 514 C176 514 160 498 160 482 Z' fill='${fill}' fill-opacity='${opacity}'/>\r\n      </g>\r\n    </svg>`;\r\n    return `url(\"data:image/svg+xml,${svg}\")`;\r\n  };\r\n\r\n// All available areas of work across the organization\r\nconst ALL_AREAS_OF_WORK = [\r\n  'Commercial',\r\n  'Construction',\r\n  'Employment',\r\n  'Property',\r\n  'Other/Unsure'\r\n];\r\n\r\n// Local types\r\ninterface MonthlyCount {\r\n  month: string;\r\n  commercial: number;\r\n  construction: number;\r\n  employment: number;\r\n  property: number;\r\n  otherUnsure: number;\r\n}\r\n\r\ninterface EnquiriesProps {\r\n  context?: TeamsContextType | null;\r\n  enquiries: Enquiry[] | null;\r\n  userData: UserData[] | null;\r\n  poidData: POID[];\r\n  setPoidData: React.Dispatch<React.SetStateAction<POID[]>>;\r\n  teamData?: TeamData[] | null;\r\n  onRefreshEnquiries?: () => Promise<void>;\r\n  instructionData?: any[]; // For detecting promoted enquiries\r\n}\r\n\r\nconst Enquiries: React.FC<EnquiriesProps> = ({\r\n  context,\r\n  enquiries,\r\n  userData,\r\n  poidData,\r\n  setPoidData,\r\n  teamData,\r\n  onRefreshEnquiries,\r\n  instructionData,\r\n}) => {\r\n\r\n  // Function to check if an enquiry has been promoted to pitch/instruction\r\n  const getPromotionStatus = useCallback((enquiry: Enquiry): { promoted: boolean; type: 'pitch' | 'instruction' | null; count: number } => {\r\n    if (!instructionData || !enquiry.ID) {\r\n      return { promoted: false, type: null, count: 0 };\r\n    }\r\n\r\n    let promotedCount = 0;\r\n    let hasInstruction = false;\r\n    let hasPitch = false;\r\n\r\n    // Check if this enquiry ID matches any prospect IDs in instruction data\r\n    instructionData.forEach((item: any) => {\r\n      // Check if the enquiry ID matches prospect ID in deals or instructions\r\n      const matchesProspectId = item.prospectId?.toString() === enquiry.ID?.toString();\r\n      \r\n      if (matchesProspectId) {\r\n        promotedCount++;\r\n        \r\n        // Check if it has actual instructions (not just deals/pitches)\r\n        if (item.instructions && item.instructions.length > 0) {\r\n          hasInstruction = true;\r\n        } else if (item.deals && item.deals.length > 0) {\r\n          hasPitch = true;\r\n        }\r\n      }\r\n      \r\n      // Also check deals array for prospect ID matches\r\n      if (item.deals) {\r\n        item.deals.forEach((deal: any) => {\r\n          if (deal.ProspectId?.toString() === enquiry.ID?.toString() || deal.prospectId?.toString() === enquiry.ID?.toString()) {\r\n            promotedCount++;\r\n            hasPitch = true;\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Check instructions array for prospect ID matches\r\n      if (item.instructions) {\r\n        item.instructions.forEach((instruction: any) => {\r\n          if (instruction.ProspectId?.toString() === enquiry.ID?.toString() || instruction.prospectId?.toString() === enquiry.ID?.toString()) {\r\n            promotedCount++;\r\n            hasInstruction = true;\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    return {\r\n      promoted: promotedCount > 0,\r\n      type: hasInstruction ? 'instruction' : (hasPitch ? 'pitch' : null),\r\n      count: promotedCount\r\n    };\r\n  }, [instructionData]);\r\n\r\n  // Simple version for card components\r\n  const getPromotionStatusSimple = useCallback((enquiry: Enquiry): 'pitch' | 'instruction' | null => {\r\n    const result = getPromotionStatus(enquiry);\r\n    return result.type;\r\n  }, [getPromotionStatus]);\r\n\r\n  // Use only real enquiries data\r\n  // All normalized enquiries (union of legacy + new) retained irrespective of toggle\r\n  const [allEnquiries, setAllEnquiries] = useState<(Enquiry & { __sourceType: 'new' | 'legacy' })[]>([]);\r\n  // Display subset after applying dataset toggle\r\n  const [displayEnquiries, setDisplayEnquiries] = useState<(Enquiry & { __sourceType: 'new' | 'legacy' })[]>([]);\r\n  // Loading state to prevent flickering\r\n  const [isLoadingAllData, setIsLoadingAllData] = useState<boolean>(false);\r\n  // Track if we've already fetched all data to prevent duplicate calls\r\n  const hasFetchedAllData = useRef<boolean>(false);\r\n\r\n  // Debug logging\r\n\r\n  // Navigation state variables  \r\n  // (declaration moved below, only declare once)\r\n\r\n  // Function to fetch all enquiries (unfiltered) for \"All\" mode\r\n  const fetchAllEnquiries = useCallback(async () => {\r\n    if (isLoadingAllData) {\r\n      debugLog('🔄 Already loading all data, skipping fetch');\r\n      return;\r\n    }\r\n    \r\n    debugLog('🔄 Attempting to fetch all enquiries, hasFetched:', hasFetchedAllData.current);\r\n    \r\n    try {\r\n      setIsLoadingAllData(true);\r\n      hasFetchedAllData.current = true;\r\n  const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';\r\n      \r\n  // Call unified server-side route for ALL environments to avoid legacy combined route\r\n  const allDataParams = new URLSearchParams({ fetchAll: 'true', includeTeamInbox: 'true', limit: '1500' });\r\n  const allDataUrl = `/api/enquiries-unified?${allDataParams.toString()}`;\r\n      \r\n      debugLog('🌐 Fetching ALL enquiries (unified) from:', allDataUrl);\r\n      \r\n      const response = await fetch(allDataUrl, {\r\n        method: 'GET',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      \r\n      debugLog('📡 Response status:', response.status, response.statusText);\r\n      debugLog('📡 Response headers:', Object.fromEntries(response.headers.entries()));\r\n      \r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        console.error('❌ Response not OK:', response.status, errorText);\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n      \r\n      const data = await response.json();\r\n      debugLog('🔍 RAW RESPONSE from unified route:', {\r\n        dataType: typeof data,\r\n        isArray: Array.isArray(data),\r\n        hasEnquiries: !!data.enquiries,\r\n        enquiriesLength: data.enquiries?.length,\r\n        dataKeys: Object.keys(data),\r\n        sampleData: JSON.stringify(data).substring(0, 200)\r\n      });\r\n      \r\n      let rawEnquiries: any[] = [];\r\n      if (Array.isArray(data)) {\r\n        rawEnquiries = data;\r\n        debugLog('📦 Using data as direct array');\r\n      } else if (Array.isArray(data.enquiries)) {\r\n        rawEnquiries = data.enquiries;\r\n        debugLog('📦 Using data.enquiries array');\r\n      } else {\r\n        debugWarn('⚠️ Unexpected data structure:', data);\r\n      }\r\n      \r\n      debugLog('✅ Fetched all enquiries:', rawEnquiries.length);\r\n      debugLog('📊 All enquiries POC breakdown:', rawEnquiries.reduce((acc: any, enq) => {\r\n        const poc = enq.Point_of_Contact || enq.poc || 'unknown';\r\n        acc[poc] = (acc[poc] || 0) + 1;\r\n        return acc;\r\n      }, {}));\r\n      \r\n      // PRODUCTION DEBUG: Log sample of claimed enquiries\r\n      const claimedSample = rawEnquiries\r\n        .filter(enq => {\r\n          const poc = (enq.Point_of_Contact || enq.poc || '').toLowerCase();\r\n          return poc !== 'team@helix-law.com' && poc.trim() !== '';\r\n        })\r\n        .slice(0, 10);\r\n      debugLog('🔍 PRODUCTION DEBUG - Sample claimed enquiries:', claimedSample.map(e => ({\r\n        ID: e.ID || e.id,\r\n        POC: e.Point_of_Contact || e.poc,\r\n        Area: e.Area_of_Work || e.aow,\r\n        Date: e.Touchpoint_Date || e.datetime\r\n      })));\r\n      \r\n      // Convert to normalized format\r\n      const normalizedEnquiries = rawEnquiries.map((raw: any) => {\r\n        const sourceType = detectSourceType(raw);\r\n        return {\r\n          ...raw,\r\n          ID: raw.ID || raw.id?.toString(),\r\n          Touchpoint_Date: raw.Touchpoint_Date || raw.datetime,\r\n          Point_of_Contact: raw.Point_of_Contact || raw.poc,\r\n          Area_of_Work: raw.Area_of_Work || raw.aow,\r\n          Type_of_Work: raw.Type_of_Work || raw.tow,\r\n          Method_of_Contact: raw.Method_of_Contact || raw.moc,\r\n          First_Name: raw.First_Name || raw.first,\r\n          Last_Name: raw.Last_Name || raw.last,\r\n          Email: raw.Email || raw.email,\r\n          Phone_Number: raw.Phone_Number || raw.phone,\r\n          Value: raw.Value || raw.value,\r\n          Initial_first_call_notes: raw.Initial_first_call_notes || raw.notes,\r\n          Call_Taker: raw.Call_Taker || raw.rep,\r\n          __sourceType: sourceType\r\n        };\r\n      });\r\n      \r\n      debugLog('🔄 Setting normalized data to state:', normalizedEnquiries.length);\r\n      debugLog('🔍 Sample normalized enquiry:', normalizedEnquiries[0]);\r\n      debugLog('🔍 Normalized enquiries POC distribution:', normalizedEnquiries.reduce((acc: any, enq) => {\r\n        const poc = enq.Point_of_Contact || 'unknown';\r\n        acc[poc] = (acc[poc] || 0) + 1;\r\n        return acc;\r\n      }, {}));\r\n      \r\n      setAllEnquiries(normalizedEnquiries);\r\n      setDisplayEnquiries(normalizedEnquiries);\r\n      \r\n      debugLog('✅ State updated with normalized enquiries');\r\n      \r\n      return normalizedEnquiries;\r\n    } catch (error) {\r\n      console.error('❌ Failed to fetch all enquiries:', error);\r\n      return [];\r\n    } finally {\r\n      setIsLoadingAllData(false);\r\n    }\r\n  }, [isLoadingAllData]);\r\n\r\n  // ...existing code...\r\n\r\n  const { isDarkMode } = useTheme();\r\n  const { setContent } = useNavigatorActions();\r\n  const [selectedEnquiry, setSelectedEnquiry] = useState<Enquiry | null>(null);\r\n  const [twoColumn, setTwoColumn] = useState<boolean>(false);\r\n  // Scope toggle (Mine vs All) for claimed enquiries - admin-only feature, default to Mine\r\n  const [showMineOnly, setShowMineOnly] = useState<boolean>(true); // Default to showing only Mine for admin users\r\n  // Removed pagination states\r\n  // const [currentPage, setCurrentPage] = useState<number>(1);\r\n  // const enquiriesPerPage = 12;\r\n\r\n  const [isRateModalOpen, setIsRateModalOpen] = useState<boolean>(false);\r\n  const [currentRating, setCurrentRating] = useState<string>('');\r\n  const [ratingEnquiryId, setRatingEnquiryId] = useState<string | null>(null);\r\n  const [isSuccessVisible, setIsSuccessVisible] = useState<boolean>(false);\r\n  const [activeSubTab, setActiveSubTab] = useState<string>('Pitch');\r\n  const [showUnclaimedBoard, setShowUnclaimedBoard] = useState<boolean>(false);\r\n  const [selectedArea, setSelectedArea] = useState<string | null>(null);\r\n  const [dateRange, setDateRange] = useState<{ oldest: string; newest: string } | null>(null);\r\n  const [isSearchActive, setSearchActive] = useState<boolean>(false);\r\n  const [showGroupedView, setShowGroupedView] = useState<boolean>(true);\r\n  // Local dataset toggle (legacy vs new direct) analogous to Matters (only in localhost UI for now)\r\n  // Deal Capture is always enabled by default now\r\n  const showDealCapture = true;\r\n  \r\n  // Auto-refresh state\r\n  const [lastRefreshTime, setLastRefreshTime] = useState<Date>(new Date());\r\n  const [isRefreshing, setIsRefreshing] = useState<boolean>(false);\r\n  const [nextRefreshIn, setNextRefreshIn] = useState<number>(30 * 60); // 30 minutes in seconds\r\n  const refreshIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const countdownIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const isLocalhost = (typeof window !== 'undefined') && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');\r\n  // Admin check (match Matters logic) – be robust to spaced keys and fallbacks\r\n  const userRec: any = (userData && userData[0]) ? userData[0] : {};\r\n  const userRole: string = (userRec.Role || userRec.role || '').toString();\r\n  const userFullName: string = (\r\n    userRec.FullName ||\r\n    userRec['Full Name'] ||\r\n    [userRec.First, userRec.Last].filter(Boolean).join(' ')\r\n  )?.toString() || '';\r\n  const isAdmin = isAdminUser(userData?.[0] || null);\r\n  debugLog('🔍 ADMIN STATUS DEBUG:', {\r\n    userEmail: userData?.[0]?.Email,\r\n    userInitials: userData?.[0]?.Initials,\r\n    userName: userData?.[0]?.First,\r\n    isAdmin,\r\n    showMineOnly\r\n  });\r\n  const hasInstructionsAndMoreAccess = hasInstructionsAccess(userData?.[0] || null);\r\n  // Debug storage for raw payloads when inspecting\r\n  const [debugRaw, setDebugRaw] = useState<{ legacy?: unknown; direct?: unknown }>({});\r\n  const [debugLoading, setDebugLoading] = useState(false);\r\n  const [debugError, setDebugError] = useState<string | null>(null);\r\n  \r\n  // Navigation state variables  \r\n  const [activeState, setActiveState] = useState<string>('Claimed');\r\n  const [searchTerm, setSearchTerm] = useState<string>('');\r\n  const [selectedAreas, setSelectedAreas] = useState<string[]>([]);\r\n  const [userManuallyChangedAreas, setUserManuallyChangedAreas] = useState(false);\r\n\r\n  // CRITICAL DEBUG: Log incoming enquiries prop\r\n  React.useEffect(() => {\r\n    debugLog('🚨 ENQUIRIES PROP DEBUG:', {\r\n      hasEnquiries: !!enquiries,\r\n      enquiriesLength: enquiries?.length || 0,\r\n      enquiriesIsArray: Array.isArray(enquiries),\r\n      userEmail: userData?.[0]?.Email,\r\n      sampleEnquiries: enquiries?.slice(0, 3).map((e: any) => ({\r\n        ID: e.ID || e.id,\r\n        POC: e.Point_of_Contact || e.poc,\r\n        CallTaker: e.Call_Taker || e.rep\r\n      }))\r\n    });\r\n  }, [enquiries, userData]);\r\n\r\n  // Detect source type heuristically (keep pure & easily testable)\r\n  const detectSourceType = (enq: Record<string, unknown>): 'new' | 'legacy' => {\r\n    // Heuristics for NEW dataset:\r\n    // 1. Presence of distinctly lower-case schema keys (id + datetime)\r\n    // 2. Presence of pipeline fields 'stage' or 'claim'\r\n    // 3. Absence of ANY spaced legacy keys (e.g. \"Display Number\") combined with at least one expected lower-case key\r\n    const hasLowerCore = 'id' in enq && 'datetime' in enq;\r\n    const hasPipeline = 'stage' in enq || 'claim' in enq;\r\n    if (hasLowerCore || hasPipeline) return 'new';\r\n    const hasSpacedKey = Object.keys(enq).some(k => k.includes(' '));\r\n    const hasAnyLowerCompact = ['aow','poc','notes','rep','email'].some(k => k in enq);\r\n    if (!hasSpacedKey && hasAnyLowerCompact) return 'new';\r\n    return 'legacy';\r\n  };\r\n\r\n  // Normalize all incoming enquiries once (unfiltered by toggle)\r\n  useEffect(() => {\r\n    debugLog('🔄 Prop useEffect triggered:', { \r\n      hasEnquiries: !!enquiries, \r\n      enquiriesLength: enquiries?.length || 0, \r\n      isAdmin, \r\n      showMineOnly,\r\n      currentDisplayCount: displayEnquiries.length\r\n    });\r\n    \r\n    if (!enquiries) {\r\n      setAllEnquiries([]);\r\n      setDisplayEnquiries([]);\r\n      return;\r\n    }\r\n    \r\n    // Don't override fetched data when admin is in \"All\" mode\r\n    if (isAdmin && !showMineOnly) {\r\n      debugLog('👤 Admin in All mode - keeping fetched dataset, not using prop data');\r\n      // If we already have fetched data, don't clear it\r\n      if (displayEnquiries.length > 0) {\r\n        debugLog('👤 Preserving existing fetched data:', displayEnquiries.length, 'enquiries');\r\n        return;\r\n      }\r\n    }\r\n    \r\n    const normalised: (Enquiry & { __sourceType: 'new' | 'legacy'; [k: string]: unknown })[] = enquiries.map((raw: any) => {\r\n      const sourceType = detectSourceType(raw);\r\n      const rec: Enquiry & { __sourceType: 'new' | 'legacy'; [k: string]: unknown } = {\r\n        ...raw,\r\n        ID: raw.ID || raw.id?.toString(),\r\n        Touchpoint_Date: raw.Touchpoint_Date || raw.datetime,\r\n        Point_of_Contact: raw.Point_of_Contact || raw.poc,\r\n        Area_of_Work: raw.Area_of_Work || raw.aow,\r\n        Type_of_Work: raw.Type_of_Work || raw.tow,\r\n        Method_of_Contact: raw.Method_of_Contact || raw.moc,\r\n        First_Name: raw.First_Name || raw.first,\r\n        Last_Name: raw.Last_Name || raw.last,\r\n        Email: raw.Email || raw.email,\r\n        Phone_Number: raw.Phone_Number || raw.phone,\r\n        Value: raw.Value || raw.value,\r\n        Initial_first_call_notes: raw.Initial_first_call_notes || raw.notes,\r\n        Call_Taker: raw.Call_Taker || raw.rep,\r\n        // Map Ultimate_Source to source field for enquiry cards\r\n        source: raw.source || raw.Ultimate_Source || 'originalForward',\r\n        __sourceType: sourceType\r\n      };\r\n      return rec;\r\n    });\r\n    const newCount = normalised.filter(r => r.__sourceType === 'new').length;\r\n    const legacyCount = normalised.length - newCount;\r\n    setAllEnquiries(normalised);\r\n  }, [enquiries, isAdmin, showMineOnly]);\r\n\r\n  // Map for claimer quick lookup\r\n  const claimerMap = useMemo(() => {\r\n    const map: Record<string, any> = {};\r\n    teamData?.forEach(td => { if (td.Email) map[td.Email.toLowerCase()] = td; });\r\n    return map;\r\n  }, [teamData]);\r\n\r\n  // Single select handler (pitch builder path)\r\n\r\n  // Apply dataset toggle to derive display list without losing the other dataset\r\n  useEffect(() => {\r\n    if (!allEnquiries.length) {\r\n      setDisplayEnquiries([]);\r\n      return;\r\n    }\r\n    \r\n    // If admin is in \"All\" mode and we have fetched unified data, show all data\r\n    const userEmail = userData?.[0]?.Email?.toLowerCase() || '';\r\n    if (isAdmin && !showMineOnly && hasFetchedAllData.current && allEnquiries.length > 1000) {\r\n  debugLog('👑 Admin All mode - showing unified data:', allEnquiries.length);\r\n      setDisplayEnquiries(allEnquiries);\r\n      return;\r\n    }\r\n    \r\n    if (isLocalhost) {\r\n      // Show all enquiries (both legacy and new) - no dataset filtering\r\n      let filtered = allEnquiries;\r\n      \r\n      // Debug logging for BR\r\n      if (userEmail.includes('br@') || userEmail.includes('brendan')) {\r\n        debugLog('🗄️ BR DEBUG - Data loading:', {\r\n          totalAllEnquiries: allEnquiries.length,\r\n          filteredCount: filtered.length,\r\n          isLocalhost,\r\n          userEmail,\r\n          samplePOCs: allEnquiries.slice(0, 10).map(e => e.Point_of_Contact || (e as any).poc)\r\n        });\r\n      }\r\n      \r\n      setDisplayEnquiries(filtered);\r\n    } else {\r\n      setDisplayEnquiries(allEnquiries);\r\n    }\r\n  }, [allEnquiries, isLocalhost, userData, showMineOnly]);\r\n\r\n  // Initialize selected areas with user's areas + Other/Unsure\r\n  useEffect(() => {\r\n    console.log('🎯 Enquiries: Area sync useEffect triggered:', {\r\n      hasUserData: !!userData,\r\n      userDataLength: userData?.length || 0,\r\n      userAOW: userData?.[0]?.AOW,\r\n      currentSelectedAreas: selectedAreas,\r\n      userManuallyChangedAreas\r\n    });\r\n    \r\n    // Don't override if user has manually changed areas\r\n    if (userManuallyChangedAreas) {\r\n      console.log('🎯 Enquiries: Skipping auto-sync because user manually changed areas');\r\n      return;\r\n    }\r\n    \r\n    if (userData && userData.length > 0 && userData[0].AOW) {\r\n      const userAOW = userData[0].AOW.split(',').map(a => a.trim());\r\n      console.log('🎯 Enquiries: Processing user AOW:', userAOW);\r\n      \r\n      // Check if this would actually change the selection\r\n      const newSelection = [...userAOW];\r\n      if (!newSelection.includes('Other/Unsure')) {\r\n        newSelection.push('Other/Unsure');\r\n      }\r\n      \r\n      // Only update if the selection would actually change\r\n      const currentSorted = [...selectedAreas].sort();\r\n      const newSorted = [...newSelection].sort();\r\n      const isActuallyDifferent = JSON.stringify(currentSorted) !== JSON.stringify(newSorted);\r\n      \r\n      console.log('🎯 Enquiries: Area comparison:', {\r\n        current: currentSorted,\r\n        new: newSorted,\r\n        isDifferent: isActuallyDifferent\r\n      });\r\n      \r\n      if (isActuallyDifferent) {\r\n        console.log('🎯 Enquiries: Setting selectedAreas to:', newSelection);\r\n        setSelectedAreas(newSelection);\r\n      } else {\r\n        console.log('🎯 Enquiries: No change needed, areas already match');\r\n      }\r\n    }\r\n  }, [userData, userManuallyChangedAreas]); // Added userManuallyChangedAreas to dependencies\r\n\r\n  // Custom handler for manual area changes to prevent useEffect overrides\r\n  const handleManualAreaChange = useCallback((newAreas: string[]) => {\r\n    console.log('🎯 Enquiries: User manually changed areas to:', newAreas);\r\n    setUserManuallyChangedAreas(true);\r\n    setSelectedAreas(newAreas);\r\n  }, []);\r\n\r\n  // Reset manual flag when UserBubble changes userData (allow UserBubble override to work)\r\n  const prevUserDataRef = useRef<typeof userData>();\r\n  useEffect(() => {\r\n    if (prevUserDataRef.current !== userData) {\r\n      if (process.env.REACT_APP_DEBUG_VERBOSE === 'true') {\r\n        // eslint-disable-next-line no-console\r\n        console.log('🎯 Enquiries: userData changed, resetting manual flag to allow UserBubble override');\r\n      }\r\n      setUserManuallyChangedAreas(false);\r\n      prevUserDataRef.current = userData;\r\n    }\r\n  }, [userData]);\r\n\r\n  // Fetch all enquiries when user switches to \"All\" mode and current dataset is too small\r\n  useEffect(() => {\r\n    if (isLoadingAllData) return; // Prevent multiple concurrent fetches\r\n    \r\n    const userEmail = userData?.[0]?.Email?.toLowerCase() || '';\r\n    const isBRUser = userEmail.includes('br@') || userEmail.includes('brendan');\r\n    \r\n  debugLog('🔄 Toggle useEffect triggered:', { isAdmin, showMineOnly, userEmail, hasData: displayEnquiries.length });\r\n    \r\n    // When switching to \"Mine\" mode, ensure displayEnquiries has the full dataset for filtering\r\n    // BUT don't reset fetch flag if we already have all data - this prevents infinite loops\r\n    if (showMineOnly) {\r\n      if (allEnquiries.length > 0) {\r\n        debugLog('🔄 Mine mode - setting displayEnquiries to allEnquiries for filtering:', allEnquiries.length);\r\n        setDisplayEnquiries(allEnquiries);\r\n      }\r\n      // Don't reset hasFetchedAllData.current here - it causes infinite loops\r\n      return;\r\n    }\r\n    \r\n    // Also reset if we previously fetched only new data (29 records) and need unified data\r\n    if (displayEnquiries.length < 100 && allEnquiries.length < 100) {\r\n      debugLog('🔄 Resetting fetch flag - previous fetch may have been incomplete');\r\n      hasFetchedAllData.current = false;\r\n    }\r\n    \r\n    // If admin toggles to \"All\" and we don't have comprehensive data, fetch complete dataset\r\n    if (isAdmin && !showMineOnly && !hasFetchedAllData.current) {\r\n      debugLog('🔄 Admin switched to All mode - fetching complete dataset');\r\n      fetchAllEnquiries();\r\n    } else if (isBRUser && !showMineOnly && displayEnquiries.length <= 1 && !hasFetchedAllData.current) {\r\n      debugLog('🔄 BR switched to All mode but only has 1 enquiry - fetching complete dataset');\r\n      fetchAllEnquiries();\r\n    }\r\n  }, [showMineOnly, userData, fetchAllEnquiries, isAdmin]); // Removed isLoadingAllData from deps\r\n\r\n  const [currentSliderStart, setCurrentSliderStart] = useState<number>(0);\r\n  const [currentSliderEnd, setCurrentSliderEnd] = useState<number>(0);\r\n\r\n  // Added for infinite scroll\r\n  const [itemsToShow, setItemsToShow] = useState<number>(20);\r\n  const loader = useRef<HTMLDivElement | null>(null);\r\n  const previousMainTab = useRef<string>('Claimed');\r\n\r\n  const toggleDashboard = useCallback(() => {\r\n    if (activeState === '') {\r\n      setActiveState(previousMainTab.current || 'Claimed');\r\n    } else {\r\n      previousMainTab.current = activeState;\r\n      setActiveState('');\r\n    }\r\n  }, [activeState]);\r\n\r\n  useEffect(() => {\r\n    const flag = sessionStorage.getItem('openUnclaimedEnquiries');\r\n    if (flag === 'true') {\r\n      setShowUnclaimedBoard(true);\r\n      sessionStorage.removeItem('openUnclaimedEnquiries');\r\n    }\r\n  }, []);\r\n\r\n  const toggleUnclaimedBoard = useCallback(() => {\r\n    setShowUnclaimedBoard((prev) => !prev);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (displayEnquiries.length > 0) {\r\n      const validDates = displayEnquiries\r\n        .map((enq) => enq.Touchpoint_Date)\r\n        .filter((d): d is string => typeof d === 'string' && isValid(parseISO(d)))\r\n        .map((d) => parseISO(d));\r\n      if (validDates.length > 0) {\r\n        const oldestDate = new Date(Math.min(...validDates.map((date) => date.getTime())));\r\n        const newestDate = new Date(Math.max(...validDates.map((date) => date.getTime())));\r\n        setDateRange({\r\n          oldest: format(oldestDate, 'dd MMM yyyy'),\r\n          newest: format(newestDate, 'dd MMM yyyy'),\r\n        });\r\n        setCurrentSliderStart(0);\r\n        setCurrentSliderEnd(validDates.length - 1);\r\n      }\r\n    } else {\r\n      setDateRange(null);\r\n    }\r\n  }, [displayEnquiries]);\r\n\r\n  const sortedEnquiries = useMemo(() => {\r\n    return [...displayEnquiries].sort((a, b) => {\r\n      const dateA = parseISO(a.Touchpoint_Date || '');\r\n      const dateB = parseISO(b.Touchpoint_Date || '');\r\n      return dateA.getTime() - dateB.getTime();\r\n    });\r\n  }, [displayEnquiries]);\r\n\r\n  const unclaimedEmails = useMemo(\r\n    () => ['team@helix-law.com'].map((e) => e.toLowerCase()),\r\n    []\r\n  );\r\n\r\n  const unclaimedEnquiries = useMemo(\r\n    () =>\r\n      displayEnquiries.filter((e) => {\r\n        const poc = (e.Point_of_Contact || (e as any).poc || '').toLowerCase();\r\n        return poc === 'team@helix-law.com';\r\n      }),\r\n    [displayEnquiries]\r\n  );\r\n\r\n  // Count of today's unclaimed enquiries\r\n  const todaysUnclaimedCount = useMemo(() => {\r\n    const today = new Date();\r\n    const todayString = today.toISOString().split('T')[0]; // YYYY-MM-DD format\r\n    \r\n    return unclaimedEnquiries.filter((e) => {\r\n      if (!e.Touchpoint_Date) return false;\r\n      const enquiryDate = e.Touchpoint_Date.split('T')[0]; // Extract date part\r\n      return enquiryDate === todayString;\r\n    }).length;\r\n  }, [unclaimedEnquiries]);\r\n\r\n  const sortedValidEnquiries = useMemo(() => {\r\n    return sortedEnquiries.filter(\r\n      (enq) => enq.Touchpoint_Date && isValid(parseISO(enq.Touchpoint_Date))\r\n    );\r\n  }, [sortedEnquiries]);\r\n\r\n  useEffect(() => {\r\n    if (sortedValidEnquiries.length > 0) {\r\n      setCurrentSliderEnd(sortedValidEnquiries.length - 1);\r\n    }\r\n  }, [sortedValidEnquiries.length]);\r\n\r\n  const enquiriesInSliderRange = useMemo(() => {\r\n    return sortedValidEnquiries.slice(currentSliderStart, currentSliderEnd + 1);\r\n  }, [sortedValidEnquiries, currentSliderStart, currentSliderEnd]);\r\n\r\n  const monthlyEnquiryCounts = useMemo(() => {\r\n    const counts: { [month: string]: MonthlyCount } = {};\r\n    enquiriesInSliderRange.forEach((enq) => {\r\n      if (enq.Touchpoint_Date && enq.Area_of_Work) {\r\n        const date = parseISO(enq.Touchpoint_Date);\r\n        if (!isValid(date)) return;\r\n        const monthStart = startOfMonth(date);\r\n        const monthLabel = format(monthStart, 'MMM yyyy');\r\n        const area = enq.Area_of_Work.toLowerCase();\r\n\r\n        if (!counts[monthLabel]) {\r\n          counts[monthLabel] = {\r\n            month: monthLabel,\r\n            commercial: 0,\r\n            construction: 0,\r\n            employment: 0,\r\n            property: 0,\r\n            otherUnsure: 0,\r\n          };\r\n        }\r\n\r\n        switch (area) {\r\n          case 'commercial':\r\n            counts[monthLabel].commercial += 1;\r\n            break;\r\n          case 'construction':\r\n            counts[monthLabel].construction += 1;\r\n            break;\r\n          case 'employment':\r\n            counts[monthLabel].employment += 1;\r\n            break;\r\n          case 'property':\r\n            counts[monthLabel].property += 1;\r\n            break;\r\n          default:\r\n            counts[monthLabel].otherUnsure += 1;\r\n            break;\r\n        }\r\n      }\r\n    });\r\n\r\n    const sortedMonths = Object.keys(counts).sort(\r\n      (a, b) => new Date(a).getTime() - new Date(b).getTime()\r\n    );\r\n    return sortedMonths.map((m) => counts[m]);\r\n  }, [enquiriesInSliderRange]);\r\n\r\n  const handleSubTabChange = useCallback((key: string) => {\r\n    // Prevent switching to Calls or Emails if Pitch Builder is open\r\n    if (activeSubTab === 'Pitch' && (key === 'Calls' || key === 'Emails')) {\r\n      return;\r\n    }\r\n    // Prevent switching to Calls or Emails in production\r\n    if (!isLocalhost && (key === 'Calls' || key === 'Emails')) {\r\n      return;\r\n    }\r\n    setActiveSubTab(key);\r\n  }, [activeSubTab, isLocalhost]);\r\n\r\n  const handleSelectEnquiry = useCallback((enquiry: Enquiry) => {\r\n    setSelectedEnquiry(enquiry);\r\n    setActiveSubTab('Pitch'); // Go directly to Pitch Builder\r\n  }, []);\r\n\r\n  const handleBackToList = useCallback(() => {\r\n    setSelectedEnquiry(null);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const resume = localStorage.getItem('resumePitchBuilder');\r\n    if (resume) {\r\n      localStorage.removeItem('resumePitchBuilder');\r\n      const saved = localStorage.getItem('pitchBuilderState');\r\n      if (saved) {\r\n        try {\r\n          const state = JSON.parse(saved);\r\n          const enquiryId = state.enquiryId;\r\n          if (enquiryId) {\r\n            const found = displayEnquiries.find(e => e.ID === enquiryId);\r\n            if (found) {\r\n              handleSelectEnquiry(found);\r\n            }\r\n          }\r\n        } catch (e) {\r\n          console.error('Failed to resume pitch builder', e);\r\n        }\r\n      }\r\n    }\r\n  }, [displayEnquiries, handleSelectEnquiry]);\r\n\r\n  // Auto-refresh functionality\r\n  const handleManualRefresh = useCallback(async () => {\r\n  debugLog('🔄 Manual refresh triggered');\r\n  debugLog('isRefreshing:', isRefreshing);\r\n  debugLog('onRefreshEnquiries available:', !!onRefreshEnquiries);\r\n    \r\n    if (isRefreshing) {\r\n      debugLog('❌ Already refreshing, skipping');\r\n      return;\r\n    }\r\n    \r\n    if (!onRefreshEnquiries) {\r\n      debugLog('❌ No onRefreshEnquiries function provided');\r\n      alert('Refresh function not available. Please check the parent component.');\r\n      return;\r\n    }\r\n    \r\n    setIsRefreshing(true);\r\n    debugLog('✅ Starting refresh...');\r\n    \r\n    try {\r\n      await onRefreshEnquiries();\r\n      setLastRefreshTime(new Date());\r\n      setNextRefreshIn(30 * 60); // Reset to 30 minutes\r\n      debugLog('✅ Refresh completed successfully');\r\n    } catch (error) {\r\n      console.error('❌ Failed to refresh enquiries:', error);\r\n      alert(`Refresh failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    } finally {\r\n      setIsRefreshing(false);\r\n      debugLog('🏁 Refresh process finished');\r\n    }\r\n  }, [isRefreshing, onRefreshEnquiries]);\r\n\r\n  // Auto-refresh timer (30 minutes)\r\n  useEffect(() => {\r\n    const startAutoRefresh = () => {\r\n      // Clear existing intervals\r\n      if (refreshIntervalRef.current) clearInterval(refreshIntervalRef.current);\r\n      if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);\r\n\r\n      // Set up 30-minute auto-refresh\r\n      refreshIntervalRef.current = setInterval(() => {\r\n        handleManualRefresh();\r\n      }, 30 * 60 * 1000); // 30 minutes\r\n\r\n      // Set up countdown timer (updates every minute)\r\n      countdownIntervalRef.current = setInterval(() => {\r\n        setNextRefreshIn(prev => {\r\n          const newValue = prev - 60;\r\n          return newValue <= 0 ? 30 * 60 : newValue;\r\n        });\r\n      }, 60 * 1000); // 1 minute\r\n    };\r\n\r\n    startAutoRefresh();\r\n\r\n    return () => {\r\n      if (refreshIntervalRef.current) clearInterval(refreshIntervalRef.current);\r\n      if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);\r\n    };\r\n  }, [handleManualRefresh]);\r\n\r\n  // Format time remaining for display\r\n  const formatTimeRemaining = (seconds: number): string => {\r\n    const minutes = Math.floor(seconds / 60);\r\n    const hours = Math.floor(minutes / 60);\r\n    const remainingMinutes = minutes % 60;\r\n    \r\n    if (hours > 0) {\r\n      return `${hours}h ${remainingMinutes}m`;\r\n    }\r\n    return `${remainingMinutes}m`;\r\n  };\r\n\r\n  const handleRate = useCallback((id: string) => {\r\n    setRatingEnquiryId(id);\r\n    setCurrentRating('');\r\n    setIsRateModalOpen(true);\r\n  }, []);\r\n\r\n  const closeRateModal = useCallback(() => {\r\n    setIsRateModalOpen(false);\r\n    setRatingEnquiryId(null);\r\n    setCurrentRating('');\r\n  }, []);\r\n\r\n  const handleEditEnquiry = useCallback(async (updatedEnquiry: Enquiry) => {\r\n    try {\r\n      // Calculate the updates by comparing with current state\r\n      const originalEnquiry = allEnquiries.find(e => e.ID === updatedEnquiry.ID);\r\n      if (!originalEnquiry) return;\r\n\r\n      const updates: Partial<Enquiry> = {};\r\n      if (updatedEnquiry.First_Name !== originalEnquiry.First_Name) updates.First_Name = updatedEnquiry.First_Name;\r\n      if (updatedEnquiry.Last_Name !== originalEnquiry.Last_Name) updates.Last_Name = updatedEnquiry.Last_Name;\r\n      if (updatedEnquiry.Email !== originalEnquiry.Email) updates.Email = updatedEnquiry.Email;\r\n      if (updatedEnquiry.Value !== originalEnquiry.Value) updates.Value = updatedEnquiry.Value;\r\n      if (updatedEnquiry.Initial_first_call_notes !== originalEnquiry.Initial_first_call_notes) {\r\n        updates.Initial_first_call_notes = updatedEnquiry.Initial_first_call_notes;\r\n      }\r\n\r\n      if (Object.keys(updates).length === 0) return;\r\n\r\n      // Call the save function - using direct API call to avoid dependency issues\r\n      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';\r\n      const updateUrl = isLocalhost \r\n        ? '/api/enquiries-unified/update'\r\n        : `${getProxyBaseUrl()}/${process.env.REACT_APP_UPDATE_ENQUIRY_PATH}?code=${process.env.REACT_APP_UPDATE_ENQUIRY_CODE}`;\r\n      \r\n      const response = await fetch(updateUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ID: updatedEnquiry.ID, ...updates }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(`Failed to update enquiry: ${errorText}`);\r\n      }\r\n\r\n      // Update local state\r\n      const updateEnquiry = (enquiry: Enquiry & { __sourceType: 'new' | 'legacy' }): Enquiry & { __sourceType: 'new' | 'legacy' } => {\r\n        if (enquiry.ID === updatedEnquiry.ID) {\r\n          return { ...enquiry, ...updates };\r\n        }\r\n        return enquiry;\r\n      };\r\n\r\n      setAllEnquiries(prev => prev.map(updateEnquiry));\r\n      setDisplayEnquiries(prev => prev.map(updateEnquiry));\r\n      \r\n  debugLog('✅ Enquiry updated successfully:', updatedEnquiry.ID, updates);\r\n      \r\n    } catch (error) {\r\n      console.error('Failed to edit enquiry:', error);\r\n      throw error; // Re-throw so the card can handle the error\r\n    }\r\n  }, [allEnquiries]);\r\n\r\n  const handleAreaChange = useCallback(async (enquiryId: string, newArea: string) => {\r\n    try {\r\n      // Get the appropriate update endpoint\r\n      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';\r\n      const updateUrl = isLocalhost \r\n        ? '/api/enquiries-unified/update' // Local development route\r\n        : `${getProxyBaseUrl()}/${process.env.REACT_APP_UPDATE_ENQUIRY_PATH}?code=${process.env.REACT_APP_UPDATE_ENQUIRY_CODE}`;\r\n      \r\n      const response = await fetch(updateUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ID: enquiryId, Area_of_Work: newArea }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(`Failed to update enquiry area: ${errorText}`);\r\n      }\r\n\r\n      // Update local state\r\n      const updateEnquiry = (enquiry: Enquiry & { __sourceType: 'new' | 'legacy' }): Enquiry & { __sourceType: 'new' | 'legacy' } => {\r\n        if (enquiry.ID === enquiryId) {\r\n          return { ...enquiry, Area_of_Work: newArea };\r\n        }\r\n        return enquiry;\r\n      };\r\n\r\n      setAllEnquiries(prev => prev.map(updateEnquiry));\r\n      setDisplayEnquiries(prev => prev.map(updateEnquiry));\r\n      \r\n  debugLog('✅ Enquiry area updated successfully:', enquiryId, 'to', newArea);\r\n      \r\n    } catch (error) {\r\n      console.error('Failed to update enquiry area:', error);\r\n      throw error;\r\n    }\r\n  }, []);\r\n\r\n  const handleSaveEnquiry = useCallback(async (enquiryId: string, updates: Partial<Enquiry>) => {\r\n    try {\r\n      // Get the appropriate update endpoint\r\n      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';\r\n      const updateUrl = isLocalhost \r\n        ? '/api/enquiries-unified/update' // Local development route\r\n        : `${getProxyBaseUrl()}/${process.env.REACT_APP_UPDATE_ENQUIRY_PATH}?code=${process.env.REACT_APP_UPDATE_ENQUIRY_CODE}`;\r\n      \r\n      const response = await fetch(updateUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ID: enquiryId, ...updates }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(`Failed to update enquiry: ${errorText}`);\r\n      }\r\n\r\n      // Update the local data\r\n      const updateEnquiry = (enquiry: Enquiry & { __sourceType: 'new' | 'legacy' }): Enquiry & { __sourceType: 'new' | 'legacy' } => {\r\n        if (enquiry.ID === enquiryId) {\r\n          return { ...enquiry, ...updates };\r\n        }\r\n        return enquiry;\r\n      };\r\n\r\n      setAllEnquiries(prev => prev.map(updateEnquiry));\r\n      setDisplayEnquiries(prev => prev.map(updateEnquiry));\r\n      \r\n  debugLog('✅ Enquiry updated successfully:', enquiryId, updates);\r\n    } catch (error) {\r\n      console.error('❌ Failed to update enquiry:', error);\r\n      throw error;\r\n    }\r\n  }, []);\r\n\r\n  const handleEditRating = useCallback(async (id: string, newRating: string) => {\r\n    try {\r\n      const response = await fetch(\r\n        `${getProxyBaseUrl()}/${process.env.REACT_APP_UPDATE_RATING_PATH}?code=${process.env.REACT_APP_UPDATE_RATING_CODE}`,\r\n        {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({ ID: id, Rating: newRating }),\r\n        }\r\n      );\r\n      if (response.ok) {\r\n        // No longer update localEnquiries; only update via API and refresh if needed\r\n        setIsSuccessVisible(true);\r\n      } else {\r\n        const errorText = await response.text();\r\n        console.error('Failed to update rating:', errorText);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating rating:', error);\r\n    }\r\n  }, []);\r\n\r\n  const submitRating = useCallback(async () => {\r\n    if (ratingEnquiryId && currentRating) {\r\n      await handleEditRating(ratingEnquiryId, currentRating);\r\n      setIsSuccessVisible(true);\r\n      closeRateModal();\r\n    }\r\n  }, [ratingEnquiryId, currentRating, handleEditRating, closeRateModal]);\r\n\r\n  const filteredEnquiries = useMemo(() => {\r\n    let filtered = displayEnquiries; // Use full dataset, not slider range\r\n\r\n    const userEmail = userData && userData[0] && userData[0].Email\r\n      ? userData[0].Email.toLowerCase()\r\n      : '';\r\n\r\n    // Always use the actual user's email - no local overrides\r\n    const effectiveUserEmail = userEmail;\r\n\r\n    // Debug logging for BR\r\n    if (userEmail.includes('br@') || userEmail.includes('brendan')) {\r\n      debugLog('🐛 BR DEBUG - Enquiries filtering:', {\r\n        userEmail,\r\n        effectiveUserEmail,\r\n        activeState,\r\n        showMineOnly,\r\n        totalEnquiriesBeforeFilter: displayEnquiries.length\r\n      });\r\n      \r\n      // Show sample of all POCs before filtering\r\n      const allPOCs = displayEnquiries.slice(0, 20).map(e => \r\n        (e.Point_of_Contact || (e as any).poc || '').toLowerCase()\r\n      );\r\n  debugLog('📧 All POCs in dataset (first 20):', allPOCs);\r\n      \r\n      // Count by POC\r\n      const pocCounts: Record<string, number> = {};\r\n      displayEnquiries.forEach(e => {\r\n        const poc = (e.Point_of_Contact || (e as any).poc || '').toLowerCase();\r\n        pocCounts[poc] = (pocCounts[poc] || 0) + 1;\r\n      });\r\n  debugLog('📊 POC counts:', pocCounts);\r\n    }\r\n\r\n    // Add detailed logging for data flow debugging\r\n    debugLog('🔍 Data Flow Debug:', {\r\n      activeState,\r\n      showMineOnly,\r\n      isAdmin,\r\n      allEnquiriesCount: allEnquiries.length,\r\n      displayEnquiriesCount: displayEnquiries.length,\r\n      enquiriesInSliderRangeCount: displayEnquiries.length,\r\n      filteredStartCount: filtered.length,\r\n      effectiveUserEmail,\r\n      userEmail\r\n    });\r\n\r\n    // CRITICAL DEBUG: Log first few POCs to see what we're working with\r\n    if (filtered.length > 0) {\r\n      const pocSamples = filtered.slice(0, 10).map(e => ({\r\n        ID: e.ID,\r\n        POC: e.Point_of_Contact || (e as any).poc,\r\n        isUnclaimed: unclaimedEmails.includes((e.Point_of_Contact || (e as any).poc || '').toLowerCase())\r\n      }));\r\n      debugLog('📋 CRITICAL - POC samples before Claimed filter:', pocSamples);\r\n    } else {\r\n      debugLog('⚠️ CRITICAL - filtered array is EMPTY before Claimed filter!');\r\n    }\r\n\r\n    // Filter by activeState first (supports Claimed, Unclaimed, etc.)\r\n    if (activeState === 'Claimed') {\r\n      if (showMineOnly || !isAdmin) {\r\n  debugLog('🔍 Filtering for Mine Only - looking for:', effectiveUserEmail);\r\n        \r\n        // DEBUG: Show available claimed POCs first\r\n        const claimedEnquiries = filtered.filter(enquiry => {\r\n          const poc = (enquiry.Point_of_Contact || (enquiry as any).poc || '').toLowerCase();\r\n          const isUnclaimed = unclaimedEmails.includes(poc);\r\n          return !isUnclaimed && poc && poc.trim() !== '';\r\n        });\r\n        \r\n        const claimedPOCs = claimedEnquiries.reduce((acc: any, enq) => {\r\n          const poc = (enq.Point_of_Contact || (enq as any).poc || '').toLowerCase();\r\n          acc[poc] = (acc[poc] || 0) + 1;\r\n          return acc;\r\n        }, {});\r\n        \r\n  debugLog('🔍 MINE DEBUG - Available claimed POCs:', claimedPOCs);\r\n  debugLog('🔍 MINE DEBUG - Total claimed enquiries available:', claimedEnquiries.length);\r\n  debugLog('🔍 MINE DEBUG - Looking for exact match:', effectiveUserEmail);\r\n  debugLog('🔍 MINE DEBUG - User has claimed enquiries:', claimedPOCs[effectiveUserEmail] || 0);\r\n        \r\n        filtered = filtered.filter(enquiry => {\r\n          const poc = (enquiry.Point_of_Contact || (enquiry as any).poc || '').toLowerCase();\r\n          const matches = effectiveUserEmail ? poc === effectiveUserEmail : false;\r\n          if (userEmail.includes('br@') || userEmail.includes('lz@')) {\r\n            debugLog('📧 Enquiry POC:', poc, 'matches:', matches);\r\n          }\r\n          return matches;\r\n        });\r\n      } else {\r\n        debugLog('🌍 Filtering for All Claimed enquiries (Admin Mode)');\r\n        debugLog('📊 Total enquiries before filtering:', filtered.length);\r\n        debugLog('📊 Unclaimed emails to exclude:', unclaimedEmails);\r\n        debugLog('🔍 PRODUCTION DEBUG - Current user admin status:', isAdmin);\r\n        debugLog('🔍 PRODUCTION DEBUG - Current showMineOnly setting:', showMineOnly);\r\n        \r\n        // Show sample of data we're working with\r\n        if (filtered.length > 0) {\r\n          const samples = filtered.slice(0, 3).map(e => ({\r\n            ID: e.ID,\r\n            POC: e.Point_of_Contact || (e as any).poc,\r\n            CallTaker: e.Call_Taker || (e as any).rep\r\n          }));\r\n          debugLog('📋 Sample enquiries:', samples);\r\n        }\r\n        \r\n        // For admin \"All\" mode, we want to show enquiries that have been claimed by ANYONE\r\n        // This means any enquiry that doesn't have the default unclaimed POC\r\n        filtered = filtered.filter(enquiry => {\r\n          const poc = (enquiry.Point_of_Contact || (enquiry as any).poc || '').toLowerCase();\r\n          \r\n          // An enquiry is \"claimed\" if it has a POC that's NOT in the unclaimed emails list\r\n          // The unclaimed list contains placeholder emails like 'team@helix-law.com'\r\n          const isUnclaimed = unclaimedEmails.includes(poc);\r\n          const isClaimed = !isUnclaimed && poc && poc.trim() !== '';\r\n          \r\n          return isClaimed;\r\n        });\r\n        \r\n        debugLog('📊 Total claimed enquiries after filtering:', filtered.length);\r\n        debugLog('🔍 PRODUCTION DEBUG - Sample of filtered claimed enquiries:', filtered.slice(0, 5).map(e => ({\r\n          ID: e.ID,\r\n          POC: e.Point_of_Contact || (e as any).poc,\r\n          Area: e.Area_of_Work,\r\n          Date: e.Touchpoint_Date\r\n        })));\r\n      }\r\n    } else if (activeState === 'Claimable') {\r\n      filtered = filtered.filter(enquiry => {\r\n        // Handle both old and new schema\r\n        const poc = (enquiry.Point_of_Contact || (enquiry as any).poc || '').toLowerCase();\r\n        return unclaimedEmails.includes(poc);\r\n      });\r\n    }\r\n\r\n    // Area-based access control - only applies for unclaimed enquiries\r\n    if (activeState === 'Claimable' && userData && userData.length > 0 && userData[0].AOW) {\r\n      const userAOW = userData[0].AOW.split(',').map(a => a.trim().toLowerCase());\r\n\r\n      const hasFullAccess = userAOW.some(\r\n        area => area.includes('operations') || area.includes('tech')\r\n      );\r\n\r\n      if (!hasFullAccess) {\r\n        filtered = filtered.filter(enquiry => {\r\n          const enquiryArea = (enquiry.Area_of_Work || '').toLowerCase().trim();\r\n          \r\n          // Check if this is an unknown/unmatched area\r\n          const isUnknownArea = !enquiryArea || \r\n            (!['commercial', 'construction', 'employment', 'property', 'claim'].some(known => \r\n              enquiryArea === known || enquiryArea.includes(known) || known.includes(enquiryArea)\r\n            ));\r\n\r\n          // Always show \"other/unsure\" enquiries if that filter is selected\r\n          if (isUnknownArea && selectedAreas.some(area => area.toLowerCase() === 'other/unsure')) {\r\n            return true;\r\n          }\r\n\r\n          // For known areas, check if they're in the user's allowed areas\r\n          if (!isUnknownArea) {\r\n            const inAllowed = userAOW.some(\r\n              a => a === enquiryArea || a.includes(enquiryArea) || enquiryArea.includes(a)\r\n            );\r\n            if (!inAllowed) return false;\r\n          }\r\n\r\n          // Filter by selected areas (if any areas are selected, only show those)\r\n          if (selectedAreas.length > 0) {\r\n            return selectedAreas.some(area => \r\n              enquiryArea === area.toLowerCase() || \r\n              enquiryArea.includes(area.toLowerCase()) || \r\n              area.toLowerCase().includes(enquiryArea)\r\n            );\r\n          }\r\n          return true;\r\n        });\r\n      } else if (selectedAreas.length > 0) {\r\n        filtered = filtered.filter(enquiry => {\r\n          const enquiryArea = (enquiry.Area_of_Work || '').toLowerCase().trim();\r\n          \r\n          // Check if this is an unknown/unmatched area\r\n          const isUnknownArea = !enquiryArea || \r\n            (!['commercial', 'construction', 'employment', 'property', 'claim'].some(known => \r\n              enquiryArea === known || enquiryArea.includes(known) || known.includes(enquiryArea)\r\n            ));\r\n          \r\n          // If enquiry has no area or doesn't match known areas, it falls under \"Other/Unsure\"\r\n          if (isUnknownArea && selectedAreas.some(area => area.toLowerCase() === 'other/unsure')) {\r\n            return true;\r\n          }\r\n          \r\n          return selectedAreas.some(area => \r\n            enquiryArea === area.toLowerCase() || \r\n            enquiryArea.includes(area.toLowerCase()) || \r\n            area.toLowerCase().includes(enquiryArea)\r\n          );\r\n        });\r\n      }\r\n    } else if (selectedAreas.length > 0) {\r\n      // Apply area filter to all enquiry states consistently\r\n      filtered = filtered.filter(enquiry => {\r\n        const enquiryArea = (enquiry.Area_of_Work || '').toLowerCase().trim();\r\n        \r\n        // If enquiry has no area or doesn't match known areas, it falls under \"Other/Unsure\"\r\n        const isUnknownArea = !enquiryArea || \r\n          (!['commercial', 'construction', 'employment', 'property', 'claim'].some(known => \r\n            enquiryArea === known || enquiryArea.includes(known) || known.includes(enquiryArea)\r\n          ));\r\n        \r\n        // Check if \"Other/Unsure\" is selected and this is an unknown area\r\n        if (isUnknownArea && selectedAreas.some(area => area.toLowerCase() === 'other/unsure')) {\r\n          return true;\r\n        }\r\n        \r\n        // Otherwise, match against selected areas normally\r\n        return selectedAreas.some(area => \r\n          enquiryArea === area.toLowerCase() || \r\n          enquiryArea.includes(area.toLowerCase()) || \r\n          area.toLowerCase().includes(enquiryArea)\r\n        );\r\n      });\r\n    }\r\n\r\n    \r\n    // Apply search term filter\r\n    if (searchTerm.trim()) {\r\n      const term = searchTerm.toLowerCase();\r\n      filtered = filtered.filter(enquiry => \r\n        enquiry.First_Name?.toLowerCase().includes(term) ||\r\n        enquiry.Last_Name?.toLowerCase().includes(term) ||\r\n        enquiry.Email?.toLowerCase().includes(term) ||\r\n        enquiry.Company?.toLowerCase().includes(term) ||\r\n        enquiry.Type_of_Work?.toLowerCase().includes(term) ||\r\n        enquiry.ID?.toLowerCase().includes(term)\r\n      );\r\n    }\r\n    \r\n    // Final debug logging - ALWAYS show for Claimed view\r\n    debugLog('🎯 FINAL FILTER RESULT:', {\r\n      finalCount: filtered.length,\r\n      activeState,\r\n      showMineOnly,\r\n      searchTerm: searchTerm.trim(),\r\n      selectedAreas,\r\n      selectedAreasCount: selectedAreas.length\r\n    });\r\n    \r\n    if (activeState === 'Claimed') {\r\n      debugLog('� CLAIMED VIEW - Final result:', {\r\n        claimedCount: filtered.length,\r\n        showMineOnly,\r\n        effectiveUserEmail,\r\n        samplePOCs: filtered.slice(0, 5).map(e => e.Point_of_Contact || (e as any).poc)\r\n      });\r\n    }\r\n    \r\n    return filtered;\r\n  }, [\r\n    displayEnquiries, // Use full dataset, not slider range\r\n    userData,\r\n    activeState,\r\n    selectedAreas,\r\n    searchTerm,\r\n    showMineOnly,\r\n    unclaimedEmails,\r\n  ]);\r\n\r\n  // Removed pagination logic\r\n  // const indexOfLastEnquiry = currentPage * enquiriesPerPage;\r\n  // const indexOfFirstEnquiry = indexOfLastEnquiry - enquiriesPerPage;\r\n  // const currentEnquiries = useMemo(\r\n  //   () => filteredEnquiries.slice(indexOfFirstEnquiry, indexOfLastEnquiry),\r\n  //   [filteredEnquiries, indexOfFirstEnquiry, indexOfLastEnquiry]\r\n  // );\r\n  // const totalPages = Math.ceil(filteredEnquiries.length / enquiriesPerPage);\r\n\r\n  // Added for infinite scroll - support both grouped and regular view\r\n  const displayedItems = useMemo(() => {\r\n    if (showGroupedView) {\r\n      // Use grouped display\r\n      const mixedItems = getMixedEnquiryDisplay([...filteredEnquiries].reverse());\r\n      return mixedItems.slice(0, itemsToShow);\r\n    } else {\r\n      // Use regular display\r\n      return [...filteredEnquiries].reverse().slice(0, itemsToShow);\r\n    }\r\n  }, [filteredEnquiries, itemsToShow, showGroupedView]);\r\n\r\n  const handleLoadMore = useCallback(() => {\r\n    setItemsToShow((prev) => Math.min(prev + 20, filteredEnquiries.length));\r\n  }, [filteredEnquiries.length]);\r\n\r\n  useEffect(() => {\r\n    const observer = new IntersectionObserver(\r\n      (entries) => {\r\n        if (entries[0].isIntersecting) {\r\n          setItemsToShow((prev) => Math.min(prev + 20, filteredEnquiries.length));\r\n        }\r\n      },\r\n      {\r\n        root: null,\r\n        rootMargin: '200px', // Increased margin to trigger earlier\r\n        threshold: 0.1, // Trigger as soon as the loader is slightly visible\r\n      }\r\n    );\r\n  \r\n    // Delay observer setup slightly to allow state updates\r\n    const timeoutId = setTimeout(() => {\r\n      if (loader.current) {\r\n        observer.observe(loader.current);\r\n      }\r\n    }, 100); // Small delay ensures `filteredEnquiries` is set before attaching\r\n  \r\n    return () => {\r\n      clearTimeout(timeoutId);\r\n      if (loader.current) {\r\n        observer.unobserve(loader.current);\r\n      }\r\n    };\r\n  }, [filteredEnquiries, itemsToShow]);\r\n  const handleSetActiveState = useCallback(\r\n    (key: string) => {\r\n      if (key !== '') {\r\n        previousMainTab.current = key;\r\n      }\r\n      setActiveState(key);\r\n      setActiveSubTab('Pitch');\r\n      setItemsToShow(20);\r\n      setTimeout(() => {\r\n        setItemsToShow((prev) =>\r\n          Math.min(prev + 40, filteredEnquiries.length)\r\n        );\r\n      }, 200);\r\n    },\r\n    [filteredEnquiries.length]\r\n  );\r\n\r\n  const ACTION_BAR_HEIGHT = 48;\r\n\r\n  const ratingOptions = [\r\n    {\r\n      key: 'Good',\r\n      text: 'Good',\r\n      description:\r\n        'Might instruct us, relevant to our work. Interesting contact and/or matter, likely to lead somewhere short or long term.',\r\n    },\r\n    {\r\n      key: 'Neutral',\r\n      text: 'Neutral',\r\n      description:\r\n        'Ok contact, matter or person/prospect possibly of interest but not an ideal fit. Uncertain will instruct us.',\r\n    },\r\n    {\r\n      key: 'Poor',\r\n      text: 'Poor',\r\n      description:\r\n        'Poor quality. Very unlikely to instruct us. Prospect or matter not a good fit. Time waster or irrelevant issue.',\r\n    },\r\n  ];\r\n\r\n  const renderRatingOptions = useCallback(() => {\r\n    return (\r\n      <Stack tokens={{ childrenGap: 15 }}>\r\n        {ratingOptions.map((option) => (\r\n          <Stack key={option.key} tokens={{ childrenGap: 5 }}>\r\n            <label htmlFor={`radio-${option.key}`} style={{ display: 'flex', alignItems: 'center' }}>\r\n              <input\r\n                type=\"radio\"\r\n                id={`radio-${option.key}`}\r\n                name=\"rating\"\r\n                value={option.key}\r\n                checked={currentRating === option.key}\r\n                onChange={(e) => setCurrentRating(e.target.value)}\r\n                style={{ marginRight: '12px', width: '18px', height: '18px' }}\r\n              />\r\n              <Text\r\n                variant=\"mediumPlus\"\r\n                styles={{\r\n                  root: {\r\n                    fontWeight: 600,\r\n                    color: colours.highlight,\r\n                    fontFamily: 'Raleway, sans-serif',\r\n                  },\r\n                }}\r\n              >\r\n                {option.text}\r\n              </Text>\r\n            </label>\r\n            <Text\r\n              variant=\"small\"\r\n              styles={{\r\n                root: {\r\n                  marginLeft: '30px',\r\n                  color: isDarkMode ? colours.dark.text : colours.light.text,\r\n                  fontFamily: 'Raleway, sans-serif',\r\n                },\r\n              }}\r\n            >\r\n              {option.description}\r\n            </Text>\r\n          </Stack>\r\n        ))}\r\n      </Stack>\r\n    );\r\n  }, [currentRating, isDarkMode, ratingOptions]);\r\n\r\n  const renderDetailView = useCallback(\r\n    (enquiry: Enquiry) => (\r\n      <>\r\n        {activeSubTab === 'Pitch' && (\r\n          <PitchBuilder enquiry={enquiry} userData={userData} />\r\n        )}\r\n        {isLocalhost && activeSubTab === 'Calls' && <EnquiryCalls enquiry={enquiry} />}\r\n        {isLocalhost && activeSubTab === 'Emails' && <EnquiryEmails enquiry={enquiry} />}\r\n      </>\r\n    ),\r\n  [activeSubTab, userData, isLocalhost]\r\n  );\r\n\r\n  const enquiriesCountPerMember = useMemo(() => {\r\n    if (!enquiriesInSliderRange || !teamData) return [];\r\n    const grouped: { [email: string]: number } = {};\r\n    enquiriesInSliderRange.forEach((enq) => {\r\n      // Handle both old and new schema\r\n      const pocEmail = (enq.Point_of_Contact || (enq as any).poc || '').toLowerCase();\r\n      if (pocEmail) {\r\n        grouped[pocEmail] = (grouped[pocEmail] || 0) + 1;\r\n      }\r\n    });\r\n    const counts: { initials: string; count: number }[] = [];\r\n    teamData.forEach((member) => {\r\n      const memberEmail = member.Email?.toLowerCase();\r\n      const memberRole = member.Role?.toLowerCase();\r\n      if (memberEmail && grouped[memberEmail] && memberRole !== 'non-solicitor') {\r\n        counts.push({\r\n          initials: member.Initials || '',\r\n          count: grouped[memberEmail],\r\n        });\r\n      }\r\n    });\r\n    counts.sort((a, b) => b.count - a.count);\r\n    return counts;\r\n  }, [enquiriesInSliderRange, teamData]);\r\n\r\n  const enquiriesCountPerArea = useMemo(() => {\r\n    const c: { [key: string]: number } = {\r\n      Commercial: 0,\r\n      Property: 0,\r\n      Construction: 0,\r\n      Employment: 0,\r\n      'Other/Unsure': 0,\r\n    };\r\n    enquiriesInSliderRange.forEach((enq) => {\r\n      const area = enq.Area_of_Work?.toLowerCase();\r\n      if (area === 'commercial') {\r\n        c.Commercial += 1;\r\n      } else if (area === 'property') {\r\n        c.Property += 1;\r\n      } else if (area === 'construction') {\r\n        c.Construction += 1;\r\n      } else if (area === 'employment') {\r\n        c.Employment += 1;\r\n      } else {\r\n        c['Other/Unsure'] += 1;\r\n      }\r\n    });\r\n    return c;\r\n  }, [enquiriesInSliderRange]);\r\n\r\n  const loggedInUserInitials = useMemo(() => {\r\n    if (userData && userData.length > 0) {\r\n      return userData[0].Initials || '';\r\n    }\r\n    return '';\r\n  }, [userData]);\r\n\r\n  const getMonthlyCountByArea = (monthData: MonthlyCount, area: string): number => {\r\n    switch (area.toLowerCase()) {\r\n      case 'commercial':\r\n        return monthData.commercial;\r\n      case 'property':\r\n        return monthData.property;\r\n      case 'construction':\r\n        return monthData.construction;\r\n      case 'employment':\r\n        return monthData.employment;\r\n      case 'other/unsure':\r\n        return monthData.otherUnsure;\r\n      default:\r\n        return 0;\r\n    }\r\n  };\r\n\r\n  function getAreaIcon(area: string): string {\r\n    switch (area.toLowerCase()) {\r\n      case 'commercial':\r\n        return 'KnowledgeArticle';\r\n      case 'property':\r\n        return 'CityNext';\r\n      case 'construction':\r\n        return 'ConstructionCone';\r\n      case 'employment':\r\n        return 'People';\r\n      case 'other/unsure':\r\n        return 'Help';\r\n      default:\r\n        return 'Question';\r\n    }\r\n  }\r\n\r\n  function getAreaColor(area: string): string {\r\n    switch (area.toLowerCase()) {\r\n      case 'commercial':\r\n        return colours.blue;\r\n      case 'construction':\r\n        return colours.orange;\r\n      case 'property':\r\n        return colours.green;\r\n      case 'employment':\r\n        return colours.yellow;\r\n      case 'other/unsure':\r\n        return '#E53935';\r\n      default:\r\n        return colours.cta;\r\n    }\r\n  }\r\n\r\n  const renderCustomLegend = (props: any) => {\r\n    const { payload } = props;\r\n    return (\r\n      <div style={{ display: 'flex', flexWrap: 'wrap', fontFamily: 'Raleway, sans-serif' }}>\r\n        {payload.map((entry: any, index: number) => (\r\n          <div\r\n            key={`legend-item-${index}`}\r\n            style={{ display: 'flex', alignItems: 'center', marginRight: 20 }}\r\n          >\r\n            <div\r\n              style={{\r\n                width: 12,\r\n                height: 12,\r\n                backgroundColor: getAreaColor(entry.value),\r\n                marginRight: 8,\r\n              }}\r\n            />\r\n            <span\r\n              style={{\r\n                color: isDarkMode ? colours.dark.text : colours.light.text,\r\n                fontWeight: 500,\r\n              }}\r\n            >\r\n              {entry.value.charAt(0).toUpperCase() + entry.value.slice(1)}\r\n            </span>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  function containerStyle(dark: boolean) {\r\n    return mergeStyles({\r\n      background: dark ? colours.darkBlue : '#ffffff',\r\n      minHeight: '100vh',\r\n      boxSizing: 'border-box',\r\n      color: dark ? colours.light.text : colours.dark.text,\r\n      position: 'relative',\r\n      '&::before': {\r\n        content: '\"\"',\r\n        position: 'fixed',\r\n        top: 0,\r\n        left: 0,\r\n        right: 0,\r\n        bottom: 0,\r\n        background: 'none',\r\n        backgroundImage: helixWatermarkSvg(dark),\r\n        backgroundRepeat: 'no-repeat',\r\n        backgroundPosition: dark ? 'right -120px top -80px' : 'right -140px top -100px',\r\n        backgroundSize: 'min(52vmin, 520px)',\r\n        pointerEvents: 'none',\r\n        zIndex: 0\r\n      }\r\n    });\r\n  }\r\n\r\n  // Global Navigator: list vs detail\r\n  useEffect(() => {\r\n    // Add CSS animation for spinning refresh icon\r\n    if (typeof document !== 'undefined' && !document.getElementById('refreshSpinAnimation')) {\r\n      const style = document.createElement('style');\r\n      style.id = 'refreshSpinAnimation';\r\n      style.textContent = `\r\n        @keyframes spin {\r\n          0% { transform: rotate(0deg); }\r\n          100% { transform: rotate(360deg); }\r\n        }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n\r\n    // List mode: filter/search bar in Navigator (like Matters list state)\r\n    if (!selectedEnquiry) {\r\n      debugLog('🔄 Setting new FilterBanner content for Enquiries');\r\n      setContent(\r\n        <FilterBanner\r\n          seamless\r\n          dense\r\n          collapsibleSearch\r\n          sticky={false}\r\n          primaryFilter={{\r\n            value: activeState === 'Claimable' ? 'Unclaimed' : activeState,\r\n            onChange: (k) => handleSetActiveState(k === 'Unclaimed' ? 'Claimable' : k),\r\n            options: ['Claimed','Unclaimed'].map(k => ({ \r\n              key: k, \r\n              label: k === 'Unclaimed' ? `Unclaimed (${todaysUnclaimedCount})` : k \r\n            })),\r\n            ariaLabel: \"Filter enquiries by status\"\r\n          }}\r\n          secondaryFilter={(\r\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap' }}>\r\n              {userData && userData[0]?.AOW && (\r\n                <IconAreaFilter\r\n                  selectedAreas={selectedAreas}\r\n                  availableAreas={ALL_AREAS_OF_WORK}\r\n                  onAreaChange={handleManualAreaChange}\r\n                  ariaLabel=\"Filter enquiries by area of work\"\r\n                />\r\n              )}\r\n              {(isAdmin || isLocalhost) && (\r\n                <SegmentedControl\r\n                  id=\"enquiries-scope-seg\"\r\n                  ariaLabel=\"Scope: toggle between my enquiries and all enquiries\"\r\n                  value={showMineOnly ? 'mine' : 'all'}\r\n                  onChange={(v) => setShowMineOnly(v === 'mine')}\r\n                  options={[\r\n                    { key: 'mine', label: 'Mine' },\r\n                    { key: 'all', label: 'All' }\r\n                  ]}\r\n                />\r\n              )}\r\n              <div \r\n                role=\"group\" \r\n                aria-label=\"Layout: choose 1 or 2 columns\"\r\n                style={{\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: 4,\r\n                  height: 28,\r\n                  padding: '2px 4px',\r\n                  background: isDarkMode ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',\r\n                  borderRadius: 14,\r\n                  fontFamily: 'Raleway, sans-serif',\r\n                }}\r\n              >\r\n                <button\r\n                  type=\"button\"\r\n                  title=\"Single column layout\"\r\n                  aria-label=\"Single column layout\"\r\n                  aria-pressed={!twoColumn}\r\n                  onClick={() => setTwoColumn(false)}\r\n                  style={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    width: 22,\r\n                    height: 22,\r\n                    background: !twoColumn ? '#FFFFFF' : 'transparent',\r\n                    border: 'none',\r\n                    borderRadius: 11,\r\n                    cursor: 'pointer',\r\n                    transition: 'all 200ms ease',\r\n                    opacity: !twoColumn ? 1 : 0.6,\r\n                    boxShadow: !twoColumn \r\n                      ? (isDarkMode\r\n                          ? '0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.24)'\r\n                          : '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08)')\r\n                      : 'none',\r\n                  }}\r\n                >\r\n                  <Icon\r\n                    iconName=\"SingleColumn\"\r\n                    style={{\r\n                      fontSize: 10,\r\n                      color: !twoColumn \r\n                        ? (isDarkMode ? '#1f2937' : '#1f2937')\r\n                        : (isDarkMode ? 'rgba(255,255,255,0.70)' : 'rgba(0,0,0,0.55)'),\r\n                    }}\r\n                  />\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  title=\"Two column layout\"\r\n                  aria-label=\"Two column layout\"\r\n                  aria-pressed={twoColumn}\r\n                  onClick={() => setTwoColumn(true)}\r\n                  style={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    width: 22,\r\n                    height: 22,\r\n                    background: twoColumn ? '#FFFFFF' : 'transparent',\r\n                    border: 'none',\r\n                    borderRadius: 11,\r\n                    cursor: 'pointer',\r\n                    transition: 'all 200ms ease',\r\n                    opacity: twoColumn ? 1 : 0.6,\r\n                    boxShadow: twoColumn \r\n                      ? (isDarkMode\r\n                          ? '0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.24)'\r\n                          : '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08)')\r\n                      : 'none',\r\n                  }}\r\n                >\r\n                  <Icon\r\n                    iconName=\"DoubleColumn\"\r\n                    style={{\r\n                      fontSize: 10,\r\n                      color: twoColumn \r\n                        ? (isDarkMode ? '#1f2937' : '#1f2937')\r\n                        : (isDarkMode ? 'rgba(255,255,255,0.70)' : 'rgba(0,0,0,0.55)'),\r\n                    }}\r\n                  />\r\n                </button>\r\n              </div>\r\n            </div>\r\n          )}\r\n          search={{\r\n            value: searchTerm,\r\n            onChange: setSearchTerm,\r\n            placeholder: \"Search (name, email, company, type, ID)\"\r\n          }}\r\n          refresh={{\r\n            onRefresh: handleManualRefresh,\r\n            isLoading: isRefreshing,\r\n            nextUpdateTime: formatTimeRemaining(nextRefreshIn),\r\n            collapsible: true\r\n          }}\r\n        >\r\n        </FilterBanner>\r\n      );\r\n    } else {\r\n      // Detail mode: reuse FilterBanner space with back button + tabs (same visual position as claimed/unclaimed bar)\r\n      setContent(\r\n        <FilterBanner\r\n          seamless\r\n          dense\r\n          sticky={false}\r\n          primaryFilter={{\r\n            value: activeSubTab,\r\n            onChange: (key) => {\r\n              // Prevent switching to Calls or Emails if Pitch Builder is open\r\n              if (activeSubTab === 'Pitch' && (key === 'Calls' || key === 'Emails')) {\r\n                return;\r\n              }\r\n              // Prevent switching to Calls or Emails in production\r\n              if (!isLocalhost && (key === 'Calls' || key === 'Emails')) {\r\n                return;\r\n              }\r\n              setActiveSubTab(key);\r\n            },\r\n            options: [\r\n              { key: 'Pitch', label: 'Pitch Builder' },\r\n              ...(isLocalhost ? [\r\n                { key: 'Calls', label: 'Calls' },\r\n                { key: 'Emails', label: 'Emails' }\r\n              ] : [])\r\n            ],\r\n            ariaLabel: \"Switch between enquiry detail tabs\"\r\n          }}\r\n        >\r\n          <IconButton\r\n            iconProps={{ iconName: 'ChevronLeft' }}\r\n            onClick={handleBackToList}\r\n            title=\"Back to enquiries list\"\r\n            ariaLabel=\"Back to enquiries list\"\r\n            styles={{\r\n              root: {\r\n                width: 32,\r\n                height: 32,\r\n                marginRight: 8,\r\n                backgroundColor: isDarkMode ? colours.dark.sectionBackground : '#f3f3f3',\r\n                border: '1px solid #e1dfdd',\r\n                borderRadius: 4,\r\n                order: -1, // Ensure it appears first\r\n              },\r\n              rootHovered: {\r\n                backgroundColor: '#e7f1ff',\r\n                borderColor: '#3690CE',\r\n              }\r\n            }}\r\n          />\r\n        </FilterBanner>\r\n      );\r\n    }\r\n    return () => setContent(null);\r\n  }, [\r\n    setContent,\r\n    isDarkMode,\r\n    selectedEnquiry,\r\n    activeState,\r\n    selectedAreas,\r\n    searchTerm,\r\n    userData,\r\n    isAdmin,\r\n    isLocalhost,\r\n    showMineOnly,\r\n    twoColumn,\r\n    activeSubTab,\r\n    showDealCapture,\r\n    handleSubTabChange,\r\n    handleBackToList,\r\n    isRefreshing,\r\n    nextRefreshIn,\r\n    formatTimeRemaining,\r\n    handleManualRefresh,\r\n  ]);\r\n\r\n  return (\r\n    <div className={containerStyle(isDarkMode)}>\r\n\r\n        <Stack\r\n          tokens={{ childrenGap: 20 }}\r\n          styles={{\r\n            root: {\r\n              backgroundColor: 'transparent', // Remove section background - let cards sit on main page background\r\n              // Remove extra chrome when viewing a single enquiry; PitchBuilder renders its own card\r\n              padding: selectedEnquiry ? '0' : '16px',\r\n              borderRadius: 0,\r\n              position: 'relative',\r\n              zIndex: 1,\r\n              boxShadow: 'none', // Remove shadow artifact - content sits directly on page background\r\n              width: '100%',\r\n              fontFamily: 'Raleway, sans-serif',\r\n            },\r\n          }}\r\n        >\r\n\r\n\r\n\r\n      {showUnclaimedBoard ? (\r\n        <UnclaimedEnquiries\r\n          enquiries={unclaimedEnquiries}\r\n          onSelect={handleSelectEnquiry}\r\n          userEmail={userData?.[0]?.Email || ''}\r\n          onAreaChange={() => { /* no-op in unclaimed view for now */ }}\r\n          onClaimSuccess={() => { try { handleManualRefresh(); } catch { /* ignore */ } }}\r\n          getPromotionStatusSimple={getPromotionStatusSimple}\r\n        />\r\n      ) : null}\r\n\r\n      <div\r\n        key={activeState}\r\n        className={mergeStyles({\r\n          flex: 1,\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          gap: '0px', // Remove extra gap between sections\r\n          paddingBottom: 0, // Remove extra space at the bottom\r\n          backgroundColor: 'transparent',\r\n          transition: 'background-color 0.3s',\r\n        })}\r\n      >\r\n        {selectedEnquiry ? (\r\n          renderDetailView(selectedEnquiry)\r\n        ) : (\r\n          <>\r\n                  {filteredEnquiries.length === 0 ? (\r\n                    <div\r\n                      className={mergeStyles({\r\n                        backgroundColor: 'transparent',\r\n                        borderRadius: '12px',\r\n                        padding: '60px 40px',\r\n                        textAlign: 'center',\r\n                        boxShadow: 'none',\r\n                      })}\r\n                    >\r\n                      <Icon\r\n                        iconName=\"Search\"\r\n                        styles={{\r\n                          root: {\r\n                            fontSize: '48px',\r\n                            color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n                            marginBottom: '20px',\r\n                          },\r\n                        }}\r\n                      />\r\n                      <Text\r\n                        variant=\"xLarge\"\r\n                        styles={{\r\n                          root: {\r\n                            color: isDarkMode ? colours.dark.text : colours.light.text,\r\n                            fontFamily: 'Raleway, sans-serif',\r\n                            fontWeight: '600',\r\n                            marginBottom: '8px',\r\n                          },\r\n                        }}\r\n                      >\r\n                        {activeState === 'Claimed' && showMineOnly\r\n                          ? 'No claimed enquiries found'\r\n                          : activeState === 'Claimed'\r\n                          ? 'No claimed enquiries found'\r\n                          : 'No enquiries found'\r\n                        }\r\n                      </Text>\r\n                      <Text\r\n                        variant=\"medium\"\r\n                        styles={{\r\n                          root: {\r\n                            color: isDarkMode ? colours.dark.subText : colours.light.subText,\r\n                            fontFamily: 'Raleway, sans-serif',\r\n                          },\r\n                        }}\r\n                      >\r\n                        {activeState === 'Claimed' && showMineOnly\r\n                          ? 'You have no claimed enquiries yet. Try switching to \"All\" to see claimed enquiries from all team members.'\r\n                          : activeState === 'Claimed'\r\n                          ? 'No enquiries have been claimed yet.'\r\n                          : 'Try adjusting your search criteria or filters'\r\n                        }\r\n                      </Text>\r\n                    </div>\r\n\r\n            ) : (\r\n              <>\r\n                        {/* Connected List Items */}\r\n                        <div\r\n                          className={\r\n                            (() => {\r\n                              const base = mergeStyles({\r\n                                display: twoColumn ? 'grid' : 'flex',\r\n                                flexDirection: twoColumn ? undefined : 'column',\r\n                                gap: '12px',\r\n                                padding: 0,\r\n                                margin: 0,\r\n                                backgroundColor: 'transparent',\r\n                                gridTemplateColumns: twoColumn ? 'repeat(2, minmax(0, 1fr))' : undefined,\r\n                                width: '100%', // allow full width usage\r\n                                transition: 'grid-template-columns .25s ease',\r\n                              });\r\n                              return twoColumn ? `${base} two-col-grid` : base;\r\n                            })()\r\n                          }\r\n                          style={twoColumn ? { position: 'relative' } : undefined}\r\n                        >\r\n                          {twoColumn && (() => {\r\n                            if (typeof document !== 'undefined' && !document.getElementById('enquiriesTwoColStyles')) {\r\n                              const el = document.createElement('style');\r\n                              el.id = 'enquiriesTwoColStyles';\r\n                              el.textContent = '@media (max-width: 860px){.two-col-grid{display:flex!important;flex-direction:column!important;}}';\r\n                              document.head.appendChild(el);\r\n                            }\r\n                            return null;\r\n                          })()}\r\n                          {displayedItems.map((item, idx) => {\r\n                            const isLast = idx === displayedItems.length - 1;\r\n\r\n                            // Extract user's areas of work (AOW) for filtering\r\n                            let userAOW: string[] = [];\r\n                            if (userData && userData.length > 0 && userData[0].AOW) {\r\n                              userAOW = userData[0].AOW.split(',').map((a) => a.trim().toLowerCase());\r\n                            }\r\n\r\n                            // Get user email for claim functionality\r\n                            const currentUserEmail = userData && userData[0] && userData[0].Email\r\n                              ? userData[0].Email.toLowerCase()\r\n                              : '';\r\n\r\n                            if (isGroupedEnquiry(item)) {\r\n                              // Render grouped enquiry card\r\n                              return (\r\n                                <GroupedEnquiryCard\r\n                                  key={item.clientKey}\r\n                                  groupedEnquiry={item}\r\n                                  onSelect={handleSelectEnquiry}\r\n                                  onRate={handleRate}\r\n                                  onPitch={handleSelectEnquiry}\r\n                                  teamData={teamData}\r\n                                  isLast={isLast}\r\n                                  userAOW={userAOW}\r\n                                  getPromotionStatus={getPromotionStatusSimple}\r\n                                />\r\n                              );\r\n                            } else {\r\n                              const pocLower = (item.Point_of_Contact || (item as any).poc || '').toLowerCase();\r\n                              const isUnclaimed = pocLower === 'team@helix-law.com';\r\n                              if (isUnclaimed) {\r\n                                return (\r\n                                  <NewUnclaimedEnquiryCard\r\n                                    key={item.ID}\r\n                                    enquiry={item}\r\n                                    onSelect={() => {}} // Prevent click-through to pitch builder\r\n                                    onRate={handleRate}\r\n                                    onAreaChange={handleAreaChange}\r\n                                    isLast={isLast}\r\n                                    userEmail={currentUserEmail}\r\n                                    onClaimSuccess={onRefreshEnquiries}\r\n                                    promotionStatus={getPromotionStatusSimple(item)}\r\n                                  />\r\n                                );\r\n                              }\r\n                              const claimer = claimerMap[pocLower];\r\n                              return (\r\n                                <ClaimedEnquiryCard\r\n                                  key={item.ID}\r\n                                  enquiry={item}\r\n                                  claimer={claimer}\r\n                                  onSelect={handleSelectEnquiry}\r\n                                  onRate={handleRate}\r\n                                  onEdit={handleEditEnquiry}\r\n                                  onAreaChange={handleAreaChange}\r\n                                  userData={userData}\r\n                                  isLast={isLast}\r\n                                  promotionStatus={getPromotionStatusSimple(item)}\r\n                                />\r\n                              );\r\n                            }\r\n                          })}\r\n                        </div>\r\n                        \r\n                        <div ref={loader} />\r\n              </>\r\n            )}\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {isSuccessVisible && (\r\n        <MessageBar\r\n          messageBarType={MessageBarType.success}\r\n          isMultiline={false}\r\n          onDismiss={() => setIsSuccessVisible(false)}\r\n          dismissButtonAriaLabel=\"Close\"\r\n          styles={{\r\n            root: {\r\n              position: 'fixed',\r\n              bottom: 20,\r\n              right: 20,\r\n              maxWidth: '300px',\r\n              zIndex: 1000,\r\n              borderRadius: '4px',\r\n              fontFamily: 'Raleway, sans-serif',\r\n            },\r\n          }}\r\n        >\r\n          Rating submitted successfully!\r\n        </MessageBar>\r\n      )}\r\n\r\n      <Modal\r\n        isOpen={isRateModalOpen}\r\n        onDismiss={closeRateModal}\r\n        isBlocking={false}\r\n        containerClassName={mergeStyles({\r\n          maxWidth: 600,\r\n          padding: '30px',\r\n          borderRadius: '12px',\r\n          backgroundColor: isDarkMode\r\n            ? colours.dark.sectionBackground\r\n            : colours.light.sectionBackground,\r\n          color: isDarkMode ? colours.dark.text : colours.light.text,\r\n          fontFamily: 'Raleway, sans-serif',\r\n        })}\r\n        styles={{ main: { maxWidth: '600px', margin: 'auto' } }}\r\n        aria-labelledby=\"rate-modal\"\r\n      >\r\n        <Stack tokens={{ childrenGap: 20 }}>\r\n          <Text\r\n            variant=\"xxLarge\"\r\n            styles={{\r\n              root: {\r\n                fontWeight: '700',\r\n                color: isDarkMode ? colours.dark.text : colours.light.text,\r\n                fontFamily: 'Raleway, sans-serif',\r\n              },\r\n            }}\r\n          >\r\n            Rate\r\n          </Text>\r\n          <Text\r\n            variant=\"medium\"\r\n            styles={{\r\n              root: {\r\n                color: isDarkMode ? colours.dark.text : colours.light.text,\r\n                fontFamily: 'Raleway, sans-serif',\r\n              },\r\n            }}\r\n          >\r\n            Please select a rating:\r\n          </Text>\r\n          {renderRatingOptions()}\r\n          <Stack horizontal tokens={{ childrenGap: 15 }} horizontalAlign=\"end\">\r\n            <PrimaryButton\r\n              text=\"Submit\"\r\n              onClick={submitRating}\r\n              disabled={!currentRating}\r\n              styles={{ root: { fontFamily: 'Raleway, sans-serif' } }}\r\n            />\r\n            <DefaultButton\r\n              text=\"Cancel\"\r\n              onClick={closeRateModal}\r\n              styles={{ root: { fontFamily: 'Raleway, sans-serif' } }}\r\n            />\r\n          </Stack>\r\n        </Stack>\r\n      </Modal>\r\n        </Stack>\r\n\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default Enquiries;\r\n"],"names":["processElementForEmail","element","walker","document","createTreeWalker","NodeFilter","SHOW_ELEMENT","elementsToProcess","currentNode","nextNode","push","forEach","el","tagName","toLowerCase","inlineStyles","style","cssText","existingStyles","styleStr","styles","split","rule","property","value","map","s","trim","parseStyleString","mergedStyles","textAlign","color","backgroundColor","fontSize","Object","entries","filter","_ref","_ref2","join","convertElementToInlineStyles","finalizeHTMLForEmail","html","processed","tempDiv","createElement","innerHTML","convertToEmailSafeHTML","querySelectorAll","ul","li","ol","enhanceListFormatting","SHOW_TEXT","textNodesToWrap","_textNode$textContent","textNode","textContent","parentElement","isInlineElement","previousSibling","nextSibling","_textNode$parentNode","p","parentNode","replaceChild","appendChild","ensureParagraphFormatting","htmlEl","remove","normalized","replace","cleanupEmptyTags","nodeType","Node","ELEMENT_NODE","includes","KEYBOARD_SHORTCUTS","escapeRegExp","str","getLeftoverPlaceholders","arguments","length","undefined","templateBlocks","b","placeholder","convertDoubleBreaksToParagraphs","text","lines","result","inList","listItems","i","line","trimmedLine","listItemMatch","match","n","Number","itemContent","content","convertNumberedListsToHTML","paragraph","t","test","removeUnfilledPlaceholders","placeholders","cleaned","regex","RegExp","consolidated","trimmed","removeHighlightSpans","parent","bubbles","Array","from","keep","find","classList","contains","bubble","bubbleEl","bubbleParent","preview","previewParent","firstChild","insertBefore","removeChild","removeAttribute","cleanTemplateString","template","slice","wrapInsertPlaceholders","container","className","setAttribute","textNodes","node","tokenRegex","nodeValue","lastIndex","closest","fragment","createDocumentFragment","offset","createTextNode","span","_match","href","isStringArray","isArray","replacePlaceholders","intro","enquiry","userData","_userData$","_userData$2","_userData$3","_userData$4","blocks","userFirstName","userFullName","userRole","userRate","formattedRate","colours","highlightYellow","First_Name","Point_of_Contact","block","optionBubbles","options","o","previewText","title","label","grey","applyDynamicSubstitutions","amount","passcode","instructionsLink","_userData$5","_userData$6","_userData$7","userInitials","enquiryID","ID","formattedAmount","num","isNaN","toLocaleString","minimumFractionDigits","maximumFractionDigits","baseUrl","process","REACT_APP_INSTRUCTIONS_URL","finalInstructionsLink","instructAnchor","url","cleanUrlRaw","_m","pre","q","_q2","post","description","isMultiSelect","dropdownStyles","callout","maxHeight","overflowY","whiteSpace","overflow","textOverflow","integratedButton","isDarkMode","positive","padding","margin","border","background","borderRadius","cursor","fontWeight","lineHeight","display","alignItems","transition","boxShadow","labelStyle","col","valueStyle","scopeDescription","onScopeChange","onAmountChange","amountError","dark","sectionBackground","light","handleScope","useCallback","ev","v","handleAmount","raw","vatInfo","useMemo","parseFloat","vat","toFixed","total","fmt","x","ex","adjust","delta","next","Math","max","toString","_jsxs","flexDirection","gap","position","backdropFilter","animation","children","_jsx","red","TextField","multiline","autoAdjustHeight","rows","onChange","field","fontFamily","selectors","fieldGroup","borderColor","outline","wrapper","width","marginBottom","minHeight","onMouseEnter","e","currentTarget","onMouseLeave","onFocus","onBlur","paddingLeft","paddingRight","paddingTop","paddingBottom","borderRight","errorMessage","root","flex","borderLeft","type","onClick","marginTop","gridTemplateColumns","gridColumn","height","SCENARIOS","id","name","subject","body","onFormatChange","editorRef","formatState","setFormatState","useState","bold","italic","underline","strikethrough","insertUnorderedList","insertOrderedList","justifyLeft","justifyCenter","justifyRight","showColorPicker","setShowColorPicker","showHighlightPicker","setShowHighlightPicker","setFontSize","colorPickerRef","useRef","highlightPickerRef","updateFormatState","queryCommandState","error","console","warn","executeCommand","command","current","focus","success","execCommand","prompt","useEffect","handleKeyDown","_editorRef$current","target","ctrlKey","metaKey","shiftKey","key","preventDefault","addEventListener","removeEventListener","handleSelectionChange","activeElement","handleClickOutside","event","buttonStyle","highlight","justifyContent","separatorStyle","dropdownStyle","top","left","cardBackground","zIndex","minWidth","flexWrap","FaBold","FaItalic","FaUnderline","FaStrikethrough","FaListUl","FaListOl","FaOutdent","FaIndent","FaAlignLeft","FaAlignCenter","FaAlignRight","inputBackground","ref","FaPalette","FaHighlighter","transform","FaLink","FaUnlink","FaEraser","FaUndo","FaRedo","isOpen","onClose","onConfirm","action","isDevelopment","selected","setSelected","autoConfirmedRef","require","getElementById","head","stripDashDividers","htmlToPlainText","findPlaceholders","results","matches","useAutoInsertRateRole","setBody","setExternalHighlights","lastAppliedKeyRef","lastProcessedBodyRef","roleRaw","rateRaw","roleStr","String","rateNumber","val","isFinite","parseRate","formatRateGBP","TOKEN_LEN","newBody","ranges","m","shift","exec","token","toUpperCase","start","index","end","replacement","InlineEditableArea","edited","externalHighlights","allReplacedRanges","richTextMode","bodyEditorRef","handleFormatCommand","taRef","preRef","wrapperRef","showToolbar","setShowToolbar","undoRedoState","setUndoRedoState","history","currentIndex","internalUpdateRef","previousValueRef","highlightRanges","setHighlightRanges","replacingPlaceholderRef","activeReplacementRangeRef","syncedExternalRanges","setSyncedExternalRanges","syncedPersistentRanges","setSyncedPersistentRanges","wrappedContent","ta","scrollHeight","syncPreStyles","window","getComputedStyle","propsMap","fontStyle","letterSpacing","boxSizing","textRendering","textTransform","keys","cssName","getPropertyValue","wordBreak","err","useLayoutEffect","raf","onResize","cancelAnimationFrame","requestAnimationFrame","fonts","onFontsReady","ready","then","catch","ro","ResizeObserver","observe","disconnect","timeoutRef","addToHistory","newValue","clearTimeout","setTimeout","prev","newHistory","handleUndo","newIndex","handleRedo","right","opacity","disabled","FaEdit","contentEditable","onInput","editorEl","editing","original","getAttribute","replaceWith","link","targetEl","activeEdits","stopPropagation","inner","sel","getSelection","range","createRange","selectNodeContents","removeAllRanges","addRange","onDoubleClick","click","onKeyDown","ctrl","suppressContentEditableWarning","font","resize","spellCheck","_SCENARIOS$find","_userData$8","_userData$9","_userData$0","_userData$1","_userData$10","selectedTemplateOptions","insertedBlocks","lockedBlocks","editedBlocks","handleMultiSelectChange","handleSingleSelectChange","insertTemplateBlock","renderPreview","applyFormat","saveSelection","handleInput","handleBlur","handleClearBlock","toolbarStyle","bubblesContainerStyle","saveCustomSnippet","markBlockAsEdited","initialNotes","setSubject","showDealCapture","initialScopeDescription","onScopeDescriptionChange","handleDraftEmail","sendEmail","isDraftConfirmed","to","cc","bcc","feeEarnerEmail","onRecipientsChange","dealCreationInProgress","dealStatus","emailStatus","emailMessage","removedBlocks","setRemovedBlocks","blockContents","setBlockContents","setScopeDescription","amountValue","setAmountValue","setAmountError","isNotesPinned","setIsNotesPinned","showSubjectHint","setShowSubjectHint","selectedScenarioId","setSelectedScenarioId","isBeforeCallCall","isTemplatesCollapsed","setIsTemplatesCollapsed","showInlinePreview","setShowInlinePreview","showSendConfirmModal","setShowSendConfirmModal","showEmailProcessingDialog","setShowEmailProcessingDialog","selectedEmailMethod","setSelectedEmailMethod","processingDialogAction","setProcessingDialogAction","confirmReady","setConfirmReady","previewRef","copiedToolbar","setCopiedToolbar","copiedFooter","setCopiedFooter","modalError","setModalError","modalSending","setModalSending","hmrTick","setHmrTick","hasSentEmail","setHasSentEmail","showSendValidation","setShowSendValidation","editableTo","setEditableTo","React","resetEditor","setAllBodyReplacedRanges","timer","applyRateRolePlaceholders","_ref3","_ref4","_u$Role","_ref5","_ref6","_u$Rate","u","Role","role","RoleName","roleName","Rate","rate","HourlyRate","hourlyRate","out","effectivePass","substituted","lastScenarioBodyRef","lastPasscodeRef","effective","processedBody","anyModule","module","hot","handler","accept","didSetDefaultSubject","GlobalStickyNotes","createPortal","maxWidth","blue","darkBlue","FaInfoCircle","FaThumbtack","updatedScope","updates","selectedOptions","_block$options$find","base","editableContent","opt","allBodyReplacedRanges","handleAutoInsertHighlights","_bodyEditorRef$curren","cmdKey","shortcutKey","Boolean","handleSendEmailWithProcessing","async","__helixEmailProcessingV2__","log","_Fragment","Stack","tokens","childrenGap","iconSize","defaultIconColor","FaBolt","iconColor","viewBox","fill","stroke","strokeWidth","d","points","cx","cy","r","y","rx","ry","x1","y1","x2","y2","FaChevronDown","FaChevronUp","innerWidth","tabIndex","greetingName","_ref7","_ref8","_ref9","_ref0","_ref1","_e$First_Name","_e$Name","_e$Name$split","_e$Name$split$call","_e$ContactName","_e$ContactName$split","_e$ContactName$split$","first","first_name","FirstName","firstName","Name","call","ContactName","composed","startsWith","projected","firstBlock","placeholderDesc","animationFillMode","bottom","baseColor","flexShrink","borderWidth","FaFileAlt","innerText","navigator","clipboard","writeText","select","plain","FaCheck","FaCopy","FaEye","backgroundImage","markUrl","backgroundRepeat","backgroundPosition","backgroundSize","pointerEvents","borderBottom","FormattingToolbar","marginLeft","borderTop","WebkitUserSelect","userSelect","withoutAutoBlocks","userDataLocal","enquiryLocal","sanitized","unresolvedBody","styledFinalHighlighted","txt","_el$parentNode","tokenRe","_node$parentNode","parts","frag","part","endsWith","highlightPlaceholdersHtml","FaExclamationTriangle","marginRight","_window","isV2Env","REACT_APP_EMAIL_V2_ENABLED","useV2Layout","EmailSignature","bodyHtml","experimentalLayout","strokeLinecap","strokeLinejoin","unresolvedSubject","unresolvedAny","disableDraft","draftVisualConfirmed","missingServiceSummary","requireServiceSummary","disableSend","sendBtnTitle","cta","FaPaperPlane","green","FaEnvelope","onMouseDown","onMouseUp","DealCapture","highlightBlue","EmailProcessingConfirmDialog","useV2","FaUsers","First","Last","Email","WorkEmail","Mail","UserPrincipalName","Initials","substring","FaTimes","numericAmt","FullName","userEmail","baseTextColor","signatureHtml","dangerouslySetInnerHTML","__html","areaConfig","icon","orange","yellow","greyText","selectedAreas","availableAreas","onAreaChange","ariaLabel","useTheme","displayAreas","area","noneSelected","areaKey","isSelected","newSelection","a","toggleArea","Icon","iconName","_userData$$Email","claimer","onSelect","onRate","onPitch","onEdit","isLast","isPrimarySelected","onToggleSelect","promotionStatus","showActions","setShowActions","clickedForActions","setClickedForActions","hasAnimatedActions","setHasAnimatedActions","expandedNotes","setExpandedNotes","isEditing","setIsEditing","isEnteringEdit","setIsEnteringEdit","isExitingEdit","setIsExitingEdit","editData","setEditData","Last_Name","Value","Initial_first_call_notes","isSaving","setIsSaving","clampRef","isOverflowing","setIsOverflowing","hasNotes","overflowing","clientHeight","normalizeNotes","enquiryOwner","canEdit","handleFieldChange","areaColor","_enquiry$Area_of_Work","Area_of_Work","accent","isCardClickable","selectedBg","selectedBorder","selectedShadow","card","mergeStyles","outlineOffset","actionButtons","Phone_Number","location","handleEditClick","EnquiryBadge","enquiryId","newArea","_","Text","variant","Company","_navigator","_navigator$clipboard","_navigator2","_navigator2$clipboard","wordWrap","WebkitLineClamp","WebkitBoxOrient","DefaultButton","PrimaryButton","handleSaveEdit","btn","idx","delay","isPitch","transitionDelay","keyframes","CopyableText","copied","copy","timeout","setCopied","useCopyToClipboard","formatCurrency","parseInt","getAreaColor","_enquiry$Point_of_Con","_enquiry$Area_of_Work3","_enquiry$Area_of_Work4","_enquiry$Area_of_Work5","_enquiry$Area_of_Work6","_claimer$Email","_claimer$Email$split$","teamData","userAOW","isNewSource","notesExpanded","setNotesExpanded","NotesBlock","notes","lowerPOC","isClaimed","_t$Email","formatDate","dateStr","Date","nowYear","getFullYear","opts","day","month","year","toLocaleDateString","isGreyedOut","some","lineItemStyle","pulse","pulseDotInlineStyle","animationName","animationDuration","animationIterationCount","animationTimingFunction","nameStyle","companyStyle","emailStyle","actionBadgeStyle","pitchButtonStyle","unclaimedSelected","setUnclaimedSelected","unclaimedShowActions","setUnclaimedShowActions","unclaimedHasAnimatedActions","setUnclaimedHasAnimatedActions","unclaimedExpanded","setUnclaimedExpanded","unclaimedClampRef","unclaimedIsOverflowing","setUnclaimedIsOverflowing","_enquiry$Area_of_Work2","cardStyle","styleEl","pulseDot","verticalAlign","formatNotesRich","l","bulletPattern","numberedPattern","bulletLines","numberedLines","listStyle","Touchpoint_Date","buttons","colourType","alert","visible","baseColour","isClaimBtn","mainContentStyle","handleClick","Type_of_Work","rating","Rating","iconButtonStyles","_latestEnquiry$Area_o","_latestEnquiry$Area_o2","groupedEnquiry","getPromotionStatus","isExpanded","setIsExpanded","clientName","clientEmail","enquiries","latestDate","areas","enquiryCount","latestEnquiry","svgMark","encodeURIComponent","maskImage","WebkitMaskImage","maskRepeat","WebkitMaskRepeat","maskPosition","WebkitMaskPosition","maskSize","WebkitMaskSize","mixBlendMode","eq","topRow","countBadgeStyle","metaStyle","dateStyle","subText","actionsStyle","expandedContentStyle","areaTagsStyle","areaTagStyle","handleMainClick","promotedEnquiry","status","calculateTotalValue","values","reduce","sum","TooltipHost","IconButton","iconProps","EnquiryLineItem","getMixedEnquiryDisplay","grouped","groupMap","Map","_enquiry$Email","_enquiry$First_Name","_enquiry$Last_Name","normalizedEmail","normalizedName","clientKey","has","existingGroup","get","set","totalValue","groupedEnquiries","group","sort","dateA","getTime","groupEnquiriesByClient","Commercial","Construction","Property","Employment","databaseTemplateBlocks","databaseBlocksJson","databaseBlocksData","templateBlockSets","Production","productionTemplateBlocks","Simplified","simplifiedTemplateBlocks","getTemplateBlocks","availableAttachments","applicableTo","btnStyle","preStyle","calls","onClear","collapsed","onToggle","reverse","c","method","durationMs","data","formatPounds","ContactChip","kind","subtle","isHovered","setIsHovered","bg","xmlns","KV","copyable","mono","handleCopy","_u$Initials","_u$First","_u$Last","_enquiry$ID","usedPitchRoute","onPreview","prevUsedRef","flipNow","setFlipNow","initials","legacyFullName","fullName","rateVal","rateFmt","modernText","buildInstructionLink","modernSubtle","modernAccent","clientPhone","onDismiss","modalRef","modalPos","setModalPos","updatePosition","iconRect","getBoundingClientRect","modalRect","innerHeight","handleKey","ReactDOM","initialText","before","after","onAddOption","onSave","setValue","autoFocus","horizontal","horizontalAlign","PopoverContainer","originalText","editedText","setLabel","sortOrder","setSortOrder","mode","setMode","hasChanges","cleanOriginal","cleanEdited","saveButtonAnimated","setSaveButtonAnimated","renderContentWithHighlights","isOriginal","originalWords","editedWords","wordsToRender","compareWords","word","textFieldStyles","Callout","directionalHint","DirectionalHint","bottomLeftEdge","isBeakVisible","ChoiceGroup","selectedKey","option","flexContainer","order","rootHovered","rootPressed","isNew","FONT_FAMILY","BASE_PARAGRAPH_STYLE","LIST_MARGIN","LIST_ITEM_STYLE","EMAIL_V2_CONFIG","enabled","fallbackToV1","REACT_APP_EMAIL_V2_FALLBACK","logOperations","REACT_APP_EMAIL_V2_LOGGING","testMode","REACT_APP_EMAIL_V2_TEST_MODE","HEADING_STYLES","h1","h2","h3","REDUNDANT_SPAN_STYLES","Set","REDUNDANT_STYLE_VALUES","mergeInlineStyles","declarations","_len","styleFragments","_key","propertyRaw","valueParts","size","concat","sanitiseParagraphStyle","properties","propertiesSet","prop","stripProperties","normalizeHtmlStructure","attributes","styleMatch","shouldPreserveSpan","adjustParagraphMargin","fullMatch","attrs","otherAttrs","processEmailContentV2","rawAttributes","classMatch","idMatch","dataAttributes","attr","cleanedStyle","mergedStyle","convertContentDivsToParagraphs","wrapped","preserveLineBreaksV2","protectNumbersFromOutlook","enhanceParagraphFormatting","segments","segment","splitParagraphsOnDoubleBreaks","trimmedContent","tidyParagraphBreaks","paragraphMatches","matchAll","last","firstReplacement","lastReplacement","tightenEdgeParagraphSpacing","tag","baseStyle","enhanceHeadingFormatting","enhanceListFormattingV2","enhanceLinkFormatting","wrapWithEmailContainer","EmailProcessor","logOperation","message","processEmailContent","this","forceV2","contentLength","hasEditor","editorElement","processWithV1","preserveHighlights","v1Processor","v2Result","v1Result","processEmailWithFallback","resultLength","system","processEditorContent","fallbackHtml","applySubstitutions","processCompleteEmail","context","compareSystemOutputs","comparison","differences","v1","v2","compareFormattingSystems","recommendation","getStatus","currentSystem","config","environment","timestamp","toISOString","forceV1Mode","escapeForSelector","CSS","escape","highlightNeutral","_userData$$Initials","_ref10","_removeConfirm$target","normalizePasscode","seed","digits","source","h","imul","charCodeAt","useNewData","setUseNewData","showDataInspector","setShowDataInspector","userRec","isLocalhost","isAdminUser","hostname","setInitialNotes","setContent","useNavigatorActions","userEmailCandidate","userEmailAddress","pitchUserData","setPitchUserData","cancelled","controller","AbortController","_getFullName","_rec$Role","_rec$Rate","_rec$Email","_current$First","_current$Last","_current$FullName","_rec$First","_rec$Last","input","init","res","fetch","ok","json","Error","safeFetchJson","signal","all","email","getFullName","fullNameLocal","rec","_getFullName2","rInitials","rEmail","rFullName","merged","abort","effectiveUserData","apiCalls","clear","clearApiCalls","setApiCalls","originalFetchRef","makeId","random","performance","now","clone","ts","useLocalFetchLogger","debugCollapsed","setDebugCollapsed","templateSet","setTemplateSet","setBlocks","loadBlocks","useDynamicTemplateBlocks","qualifyingAnswer","setQualifyingAnswer","dragSentence","setDragSentence","hiddenBlocks","setHiddenBlocks","bodyHasBeenSeeded","handleTemplateSetChange","newSet","setSelectedTemplateOptions","setInsertedBlocks","setAutoInsertedBlocks","setLockedBlocks","setPinnedBlocks","setEditedBlocks","setOriginalBlockContent","stored","sessionStorage","getItem","parsed","JSON","parse","compiled","_b$BlockId","Title","Description","Placeholder","blockId","BlockId","snippets","_s$SnippetId","Label","Content","snippetId","SnippetId","setSavedSnippets","savedSnippets","removeItem","fallbackData","newBlocks","initialOption","setInitialScopeDescription","selectedOption","setSelectedOption","setAmount","highlightBlock","blockTitle","isLocked","headerElement","hoveredScale","headerScale","editorScale","lockedBg","blueBg","isInserted","querySelector","editedSnippets","active","HTMLElement","snip","_editedSnippets$block","ph","toggleBlockLock","locked","updated","spans","toggleBlockSidebar","_bodyEditorRef$curren2","newPinned","pinnedBlocks","sidebar","add","pinBtn","handleIcon","saveToUndoStackImmediate","setBodyInternal","toggleSidebarOverlayMode","setOverlaySidebars","_bodyEditorRef$curren3","newVal","localStorage","setItem","sidebars","sb","toggle","openSnippetOptions","snippetLabel","setSnippetOptionsTarget","setSnippetOptionsBlock","setSnippetOptionsLabel","openSnippetEdit","setSnippetEdit","isUndoRedoOperation","undoStack","inputTimeoutRef","setUndoStack","setRedoStack","undo","_bodyEditorRef$curren4","currentContent","previousContent","setIsUndoRedoOperation","setBodyState","syncStateFromContent","computeSnippetChanges","setEditedSnippets","redo","_bodyEditorRef$curren5","redoStack","nextContent","insertedBlockElements","DOMParser","parseFromString","newInsertedBlocks","closeSnippetOptions","insertBlockOption","optionLabel","_bodyEditorRef$curren6","appendSnippetOption","autoInsertedBlocks","resetBlockOption","_bodyEditorRef$curren7","removeBlock","suppressSaveRef","saved","shouldResume","initialSet","state","serviceDescription","setTo","setCc","setBcc","attachments","setAttachments","followUp","setFollowUp","activeTab","setActiveTab","originalBlockContent","originalSnippetContent","setOriginalSnippetContent","EXTRACTED_BLOCKS","generateBaseTemplate","buildPlaceholder","savedHtml","removeBtn","sectionSelections","setSectionSelections","sectionContent","setSectionContent","resolvedBody","isPreviewOpen","setIsPreviewOpen","isSuccessVisible","setIsSuccessVisible","isErrorVisible","setIsErrorVisible","setErrorMessage","setIsDraftConfirmed","toast","setToast","ms","Promise","showToast","msg","_options$duration","loading","details","progress","duration","dealId","setDealId","dealPasscode","setDealPasscode","setDealStatus","setDealCreationInProgress","clientIds","setClientIds","dealClients","setDealClients","isMultiClientFlag","setIsMultiClientFlag","setEmailStatus","setEmailMessage","overlaySidebars","hoveredOption","setHoveredOption","undoInitialized","setUndoInitialized","_bodyEditorRef$curren8","editedTextRanges","setEditedTextRanges","_bodyEditorRef$curren9","placeholderEdit","setPlaceholderEdit","snippetEdit","pendingOptionText","setPendingOptionText","snippetOptionsBlock","snippetOptionsLabel","snippetOptionsTarget","removeConfirm","setRemoveConfirm","savedSelection","rangeCount","getRangeAt","cloneRange","updatedBlocks","updatedSnippets","updatedEditRanges","editedBlockBg","snippetEls","blockHasEdits","_originalSnippetConte","currentText","changed","edits","currentWords","originalIndex","startIdx","detectTextEdits","highlightEditedText","snippetBg","optionDiv","shouldFocus","append","snippetHtml","snippetMap","_optObj","optObj","_optObj2","escLabel","sentences","replacementText","selectedLabel","containerTag","styledInnerHTML","optionsHtmlCombined","labelText","labelHTML","pinnedClass","overlayIcon","overlayActive","controlsHTML","highlightedReplacement","wrappedHTML","existingBlockRegex","placeholderEsc","placeholderEscEncoded","placeholderRegex","_bodyEditorRef$curren12","phSpan","fromEntries","k","insertedSpan","setStartAfter","collapse","main","insertAdjacentHTML","currentSelected","newSelected","optionsHtml","savedChoice","updatedHtml","firstSnippet","getProxyBaseUrl","REACT_APP_SUBMIT_SNIPPET_EDIT_PATH","REACT_APP_SUBMIT_SNIPPET_EDIT_CODE","headers","stringify","proposedContent","proposedLabel","proposedSortOrder","proposedBlockId","proposedBy","removeBlockOption","_bodyEditorRef$curren13","blockMap","removeSnippetOption","hideTemplateBlock","_bodyEditorRef$curren14","insertDealIfNeeded","numericAmount","REACT_APP_INSERT_DEAL_PATH","REACT_APP_INSERT_DEAL_CODE","fallbackDescription","rawCandidates","acid","resolvedProspectId","retryWindowMs","retryId","lateCandidates","payload","areaOfWork","prospectId","pitchedBy","isMultiClient","leadClientEmail","leadClientId","emailRecipients","buildBccList","bccAdditional","emailSubject","emailBody","emailBodyHtml","reminders","clients","sendingPayload","response","statusText","norm","errorText","additionalBcc","bccList","editor","del","sentence","blockSpan","_bodyEditorRef$curren0","rect","point","choice","handleDragStart","handle","_e$dataTransfer","dataTransfer","setData","handleDragOver","handleDragLeave","handleDrop","_bodyEditorRef$curren1","clientY","offsetHeight","openPlaceholderEditor","count","gather","words","dir","TEXT_NODE","unshift","getNeighboringWords","blockEl","placeholderText","placeholderAttr","currentDOMContent","handleDblClick","isInTeams","currentPasscode","finalHtml","rawHtml","noPlaceholders","fullEmailHtml","ReactDOMServer","requestBody","email_contents","user_email","from_email","bcc_emails","saveToSentItems","_bodyEditorRef$curren15","safeTitle","placeholderHTML","updatedBody","removed","SHOW_COMMENT","comment","setStartBefore","setEndAfter","deleteContents","temp","insertNode","removeBlockByMarkers","inserted","containerStyle","bodyWrapperStyle","borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius","cardHover","disabledBackground","practiceArea","PracticeAreaPitch","attachment","getFilteredAttachments","buildSectionHtml","labels","formatted","every","escapeHtml","highlightUnresolvedPlaceholders","formatSectionContent","rebuildBodyWithSections","sections","splitIndex","indexOf","greeting","rest","sectionHtml","user","DOMException","e2","VerificationSummary","open","selections","sc","prevBody","handleToggleOption","handleSectionContentEdit","EditorAndTemplateBlocks","isEdited","formatPreviewText","doc","dynamicPreview","dynamicPreviewText","validateForm","senderEmail","useV2Processing","recipient_details","fee_earner","errorMsg","setInitialFocus","directionalHintFixed","FocusZone","direction","FocusZoneDirection","vertical","isCircularNavigation","_e","previous","optionListContent","safe","arr","replaceSnippetOption","onRenderLabel","renderLabel","defaultRender","_snippetOptionsBlock$","sharedPrimaryButtonStyles","sharedDefaultButtonStyles","PlaceholderEditorPopover","selection","lastChild","protectiveSpace","SnippetEditPopover","_ref11","submitPlaceholderOption","OperationStatusToast","PitchDebugPanel","FaPhone","MessageBar","messageBarType","MessageBarType","info","emails","setEmails","setLoading","setError","resp","fetchEmails","Spinner","Subject","Body","helixWatermarkSvg","ALL_AREAS_OF_WORK","poidData","setPoidData","onRefreshEnquiries","instructionData","promoted","promotedCount","hasInstruction","hasPitch","item","_item$prospectId","instructions","deals","deal","_deal$ProspectId","_enquiry$ID2","_deal$prospectId","_enquiry$ID3","ProspectId","instruction","_instruction$Prospect","_enquiry$ID4","_instruction$prospect","_enquiry$ID5","getPromotionStatusSimple","allEnquiries","setAllEnquiries","displayEnquiries","setDisplayEnquiries","isLoadingAllData","setIsLoadingAllData","hasFetchedAllData","fetchAllEnquiries","debugLog","_data$enquiries","allDataUrl","URLSearchParams","fetchAll","includeTeamInbox","limit","dataType","hasEnquiries","enquiriesLength","dataKeys","sampleData","rawEnquiries","debugWarn","acc","enq","poc","claimedSample","POC","Area","aow","datetime","normalizedEnquiries","_raw$id","sourceType","detectSourceType","tow","Method_of_Contact","moc","phone","Call_Taker","rep","__sourceType","selectedEnquiry","setSelectedEnquiry","twoColumn","setTwoColumn","showMineOnly","setShowMineOnly","isRateModalOpen","setIsRateModalOpen","currentRating","setCurrentRating","ratingEnquiryId","setRatingEnquiryId","activeSubTab","setActiveSubTab","showUnclaimedBoard","setShowUnclaimedBoard","selectedArea","setSelectedArea","dateRange","setDateRange","isSearchActive","setSearchActive","showGroupedView","setShowGroupedView","lastRefreshTime","setLastRefreshTime","isRefreshing","setIsRefreshing","nextRefreshIn","setNextRefreshIn","refreshIntervalRef","countdownIntervalRef","isAdmin","userName","hasInstructionsAccess","debugRaw","setDebugRaw","debugLoading","setDebugLoading","debugError","setDebugError","activeState","setActiveState","searchTerm","setSearchTerm","setSelectedAreas","userManuallyChangedAreas","setUserManuallyChangedAreas","enquiriesIsArray","sampleEnquiries","CallTaker","hasSpacedKey","hasAnyLowerCompact","currentDisplayCount","normalised","_raw$id2","Ultimate_Source","newCount","claimerMap","td","_userData$5$Email","filtered","totalAllEnquiries","filteredCount","samplePOCs","hasUserData","userDataLength","AOW","currentSelectedAreas","currentSorted","newSorted","isActuallyDifferent","new","isDifferent","handleManualAreaChange","newAreas","prevUserDataRef","REACT_APP_DEBUG_VERBOSE","_userData$7$Email","isBRUser","hasData","currentSliderStart","setCurrentSliderStart","currentSliderEnd","setCurrentSliderEnd","itemsToShow","setItemsToShow","loader","previousMainTab","validDates","isValid","parseISO","oldestDate","min","date","newestDate","oldest","format","newest","sortedEnquiries","dateB","unclaimedEmails","unclaimedEnquiries","todaysUnclaimedCount","todayString","sortedValidEnquiries","enquiriesInSliderRange","handleSubTabChange","counts","monthStart","startOfMonth","monthLabel","commercial","construction","employment","otherUnsure","handleSelectEnquiry","handleBackToList","found","handleManualRefresh","clearInterval","setInterval","formatTimeRemaining","seconds","minutes","floor","hours","remainingMinutes","handleRate","closeRateModal","handleEditEnquiry","originalEnquiry","updatedEnquiry","updateUrl","REACT_APP_UPDATE_ENQUIRY_PATH","REACT_APP_UPDATE_ENQUIRY_CODE","updateEnquiry","handleAreaChange","handleEditRating","newRating","REACT_APP_UPDATE_RATING_PATH","REACT_APP_UPDATE_RATING_CODE","submitRating","filteredEnquiries","effectiveUserEmail","totalEnquiriesBeforeFilter","allPOCs","pocCounts","allEnquiriesCount","displayEnquiriesCount","enquiriesInSliderRangeCount","filteredStartCount","pocSamples","isUnclaimed","claimedEnquiries","claimedPOCs","samples","enquiryArea","known","isUnknownArea","term","_enquiry$Company","_enquiry$Type_of_Work","_enquiry$ID6","finalCount","selectedAreasCount","claimedCount","displayedItems","observer","IntersectionObserver","isIntersecting","rootMargin","threshold","timeoutId","unobserve","handleSetActiveState","ratingOptions","renderRatingOptions","htmlFor","checked","renderDetailView","PitchBuilder","EnquiryCalls","EnquiryEmails","pocEmail","member","_member$Email","_member$Role","memberEmail","memberRole","_enq$Area_of_Work","FilterBanner","seamless","dense","sticky","primaryFilter","collapsibleSearch","secondaryFilter","IconAreaFilter","SegmentedControl","search","refresh","onRefresh","isLoading","nextUpdateTime","collapsible","UnclaimedEnquiries","onClaimSuccess","currentUserEmail","isGroupedEnquiry","GroupedEnquiryCard","pocLower","NewUnclaimedEnquiryCard","ClaimedEnquiryCard","isMultiline","dismissButtonAriaLabel","Modal","isBlocking","containerClassName"],"sourceRoot":""}